<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ZxysHexo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-01-02T01:06:30.500Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Zouxxyy</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æˆ‘çš„2019</title>
    <link href="http://yoursite.com/2019/12/31/%E6%88%91%E7%9A%842019/"/>
    <id>http://yoursite.com/2019/12/31/æˆ‘çš„2019/</id>
    <published>2019-12-31T08:59:34.000Z</published>
    <updated>2020-01-02T01:06:30.500Z</updated>
    
    <content type="html"><![CDATA[<p>2019å°ç»“ï¼Œå¤šå›¾æ…ç‚¹</p><a id="more"></a><h1>github</h1><p>ä¸€åº¦æ‰§ç€commitï¼Œä¸€åº¦è§‰å¾—å¤ªæ°´ï¼Œä¸€åº¦åˆæ‰§ç€ï¼Œä¸€åº¦åˆâ€¦ <strong>å¸Œæœ›æ˜å¹´åŠ æ²¹ï¼Œäº‰å–è´¡çŒ®PR</strong></p><p><img src="https://i.loli.net/2019/12/31/UtnVwE4IDSa1cZe.png" alt></p><h1>Hexo</h1><p>2019å¹´ï¼Œåœ¨å°ç ´ç«™å†™(shui)äº†<strong>49ç¯‡æ–‡(shui)ç« (wen)</strong>ã€‚å­¦ä¹ ä¸Šï¼Œæ‰“60åˆ†å§ï¼Œå‹‰å¼ºåŠæ ¼ï¼Œæ˜å¹´è¦æ›´åŠ åŠªåŠ›ï¼</p><p><img src="https://i.loli.net/2019/12/31/ZuN1XwA7nH8ylsf.png" alt></p><h1>è¯»ä¹¦</h1><p>æ¬£èµæ¥è‡ªè±†ç“£çš„èœœæ±é»‘è‰²æ•£ç‚¹å›¾ï¼Œä¸€æ¬¡æ›´æ–°åå˜æˆäº†è¿™æ ·ï¼Œå®åœ¨æ— åŠ›åæ§½</p><p><img src="https://i.loli.net/2019/12/31/PLiUoA8uN4nfsBb.png" alt></p><p>å¾®ä¿¡è¯»ä¹¦çš„2019æˆç»©å•ï¼Œ<strong>å‹‰å¼ºè¶…è¿‡å¹³å‡æ°´å¹³?!</strong> ä»Šå¹´ç›¸æ¯”å»å¹´çƒ­æƒ…é™ä½äº†ä¸å°‘ï¼Œæ„Ÿè§‰å¾ˆéš¾é‡åˆ°è®©äººçœ¼å‰ä¸€äº®çš„ä¹¦äº†ã€‚</p><p>ä»Šå¹´çœ‹è¿‡æœ€å¥½çœ‹çš„3æœ¬æ˜¯ï¼š<strong>ã€Šå¹³å‡¡çš„ä¸–ç•Œã€‹ ã€Šéœä¹±æ—¶æœŸçš„çˆ±æƒ…ã€‹ ã€Šè¿½é£ç­çš„äººã€‹</strong>ã€‚ç»å…¸ä¸æ„§æ˜¯ç»å…¸ï½</p><p>å¤¸å¤¸<strong>è‰¯å¿ƒ</strong>çš„å¾®ä¿¡è¯»ä¹¦ï¼šå¼€å±€ä¸€æ¡ç‹—ï¼Œ<strong>æ— çº¿å¡å…¨é ç™½å«–</strong>ã€‚å€˜è‹¥æ”¶è´¹ï¼Œæˆ‘å¿…å¥‰é™ªã€‚</p><p><img src="https://i.loli.net/2019/12/31/IKZmn3JNlhv8BT7.jpg" alt></p><h1>billbill</h1><p>9æœˆå¼€å§‹ç©çš„ï¼Œç‹è€…æ—¶åˆ»ç”Ÿæˆåå†è‡ªå·±å‰ªä¸€ä¸‹ï¼ŒæŠ•äº†å‡ ç¯‡ï¼Œè‡ªå¨±è‡ªä¹åŠ æœ‹å‹åœˆå½¢æˆå®Œç¾é—­ç¯ã€‚å¥ˆä½•ç”»(A)è´¨(V)ä¸å¿ç›´è§†ï¼ŒçœŸæƒ³æ”¾å¼ƒï¼Œå¸Œæœ›<strong>ç‹è€…çš„è‡ªåŠ¨å‰ªè¾‘ç”»è´¨èƒ½æå‡ç‚¹</strong>ï¼</p><p>ä¹Ÿå¤¸å¤¸Bç«™ï¼Œåœ¨Bç«™ä¸Šå­¦ä¹ äº†å¾ˆå¤šå…è´¹å­¦ä¹ èµ„æºï¼Œè€Œä¸”ç”¨æˆ·ä½“éªŒä¹ŸæŒºä¸é”™çš„ï¼Œæœç„¶ç¨‹(si)åº(fei)å‘˜(zai)æ‡‚äºŒæ¬¡å…ƒï¼Œå¥¥åˆ©ç»™ï¼è‡³äºå¤§ä¼šå‘˜å˜›ï¼Œä¸‹æ¬¡ä¸€å®šï¼Œãƒ¾ï¾‰â‰§âˆ€â‰¦)o</p><p><img src="https://i.loli.net/2019/12/31/EzojgVJNAnXhrCY.jpg" alt></p><h1>éŸ³ä¹</h1><p>2020å¹´ï¼Œä¹Ÿè¦<strong>å°†éä¸»æµè´¯å½»åˆ°åº•</strong>ï¼å¹´åº¦å¬çš„æœ€å¤šç«Ÿç„¶æ˜¯åµ©å“¥çš„ï¼Œæ˜¯ä¸æ˜¯è®¡ç®—é”™äº†ï¼Ÿï¼Ÿ</p><p><img src="https://i.loli.net/2019/12/31/Oq9WUB1KQ3gMj7s.jpg" alt></p><h1>ç‹è€…è£è€€</h1><p>äººè€äº†ååº”è·Ÿä¸ä¸Šäº†ï¼Œæ··æ··ç‹è€…å°±è¡Œï¼Œä»¥åç©çš„æ—¶é—´è¶Šæ¥è¶Šå°‘äº†ã€‚è¯è¯´ï¼Œæˆ‘çš„<strong>æç™½è£è€€å…¸è—åˆè·³ç¥¨äº†</strong>ï¼Œ<strong>éŸ©ä¿¡çš„é¼ å¹´ä¼ è¯´è¢«ä¼½ç½—æŠ¢äº†</strong>ã€‚ğŸ¶ ç­–åˆ’ï¼Œæˆ‘è¦è½¬æˆ˜éš”å£lolæ‰‹æ¸¸ï¼</p><p>è²Œä¼¼æ²¡æ‰¾åˆ°ç‹è€…çš„2019å¹´æŠ¥ï¼Œä¹Ÿå¤ªå·æ‡’äº†å§ï¼Ÿï¼Ÿ</p><h1>2020 åŠ æ²¹ï¼</h1>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2019å°ç»“ï¼Œå¤šå›¾æ…ç‚¹&lt;/p&gt;
    
    </summary>
    
      <category term="éšç¬”" scheme="http://yoursite.com/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ-Git</title>
    <link href="http://yoursite.com/2019/12/31/%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F-Git/"/>
    <id>http://yoursite.com/2019/12/31/åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ-Git/</id>
    <published>2019-12-31T01:10:52.000Z</published>
    <updated>2019-12-31T01:14:45.901Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ä¸»è¦åŒ…æ‹¬Gitçš„ç”¨æ³•åŠ åº•å±‚</p><h1>ä½¿ç”¨</h1><h2 id="åˆå§‹åŒ–ç›¸å…³"><a class="header-anchor" href="#åˆå§‹åŒ–ç›¸å…³">Â¶</a>åˆå§‹åŒ–ç›¸å…³</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --system æ“ä½œç³»ç»Ÿçº§åˆ«ï¼› --global ç”¨æˆ·çº§åˆ«ï¼› ä¸åŠ ï¼š é¡¹ç›®çº§åˆ« </span></span><br><span class="line">$ git config --global user.name <span class="string">"zouxxyy"</span></span><br><span class="line">$ git config --global user.email <span class="string">"xxxxxxxxxxxxxx"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é…ç½®</span></span><br><span class="line">$ git config --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºgitå¯¹è±¡ï¼Œä¼šç”Ÿæˆ .git ç›®å½•</span></span><br><span class="line">$ git init</span><br><span class="line">$ ls</span><br><span class="line">HEAD                 æŒ‡ç¤ºå½“å‰åˆ†æ”¯çš„æ–‡ä»¶</span><br><span class="line">config               é…ç½®æ–‡ä»¶</span><br><span class="line">hooks.  ï¼ˆç›®å½•ï¼‰      å­˜æ”¾é’©å­è„šæœ¬ï¼Œæ¯”å¦‚æäº¤ä»£ç å‰æˆ–è€…åçš„è‡ªåŠ¨æ‰§è¡Œæ“ä½œ</span><br><span class="line">objects ï¼ˆç›®å½•ï¼‰      å­˜æ”¾æ‰€æœ‰å†å²è®°å½•çš„</span><br><span class="line">branches             æŒ‡ç¤ºç›®å‰è¢«æ£€æµ‹å‡ºçš„åˆ†æ”¯</span><br><span class="line">description          ä»“åº“æè¿°æ€§ä¿¡æ¯çš„æ–‡ä»¶</span><br><span class="line">info    ï¼ˆç›®å½•ï¼‰      å­˜æ”¾å…¨å±€æ€§çš„æ’é™¤æ–‡ä»¶ã€‚æ¯”å¦‚ mac è¿›å»æŸ¥çœ‹å°±æœ‰.DS_Store</span><br><span class="line">refs    ï¼ˆç›®å½•ï¼‰      å­˜æ”¾åˆ†æ”¯ä¸tagsçš„æäº¤å¯¹è±¡çš„æŒ‡é’ˆ</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="æ–‡ä»¶ç›¸å…³"><a class="header-anchor" href="#æ–‡ä»¶ç›¸å…³">Â¶</a>æ–‡ä»¶ç›¸å…³</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ æ–°æ–‡ä»¶ï¼ˆç”±æœªè·Ÿè¸ªåˆ°è·Ÿè¸ªçŠ¶æ€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æš‚å­˜çŠ¶æ€ï¼‰æˆ–è€…æ·»åŠ ä¿®æ”¹æ–‡ä»¶ï¼ˆç”±ä¿®æ”¹çŠ¶æ€åˆ°æš‚å­˜çŠ¶æ€ï¼‰ï¼ˆç²—ç•¥è¿™æ ·è¯´ï¼Œå…¶å®åº•å±‚åšäº†æ›´å¤šäº‹ï¼‰</span></span><br><span class="line">$ git add test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æäº¤æ–‡ä»¶ï¼ˆç”±æš‚å­˜çŠ¶æ€åˆ°æäº¤çŠ¶æ€ï¼‰ï¼›å¯åŠ å‚æ•° -a è·³è¿‡ add æ­¥éª¤ï¼ˆæœªè·Ÿè¸ªçš„ä¸èƒ½æäº¤ï¼‰</span></span><br><span class="line">$ git commit -m <span class="string">"commit message"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ–‡ä»¶çš„çŠ¶æ€</span></span><br><span class="line">$ git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœªè¢« add çš„ä¿®æ”¹</span></span><br><span class="line">$ git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·² add ä½†æœªè¢« commit çš„ä¿®æ”¹</span></span><br><span class="line">$ git diff --staged</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ–‡ä»¶ ï¼ˆåŒæ—¶è®©æ–‡ä»¶ç”±è·Ÿè¸ªå˜æˆæœªè·Ÿè¸ªçŠ¶æ€ï¼‰ï¼ˆæ³¨æ„å®ƒ å’Œæ‰‹åŠ¨åˆ é™¤æ–‡ä»¶å†æ‰§è¡Œ git add æ•ˆæœä¸€æ ·ï¼‰</span></span><br><span class="line">$ git rm test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line">$ git mv test.txt new.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ commit logï¼›å¯åŠ  --oneline å‚æ•°ç®€å†™</span></span><br><span class="line">$ git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®Œæ•´ commit logï¼ˆåªè¦æ”¹åŠ¨äº†HEADï¼‰</span></span><br><span class="line">$ git reflog</span><br></pre></td></tr></table></figure><h2 id="åˆ†æ”¯ç›¸å…³"><a class="header-anchor" href="#åˆ†æ”¯ç›¸å…³">Â¶</a>åˆ†æ”¯ç›¸å…³</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåˆ†æ”¯</span></span><br><span class="line">$ git branch branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ†æ”¯ (åˆ‡æ¢å‰ä¿è¯ status å¹²å‡€)</span></span><br><span class="line">$ git checkout branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶åˆ‡æ¢</span></span><br><span class="line">$ git checkout -b branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯ å¯åŠ å‚æ•° -v æŸ¥çœ‹å®ƒä»¬çš„æœ€åä¸€æ¬¡æäº¤</span></span><br><span class="line">$ git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤åˆ†æ”¯ï¼ˆéœ€å…ˆåˆ‡åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ï¼‰å¯åŠ å‚æ•° -D å¼ºåˆ¶åˆ é™¤</span></span><br><span class="line">$ git branch -d branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºåˆ†æ”¯ï¼Œå¹¶æŒ‡å‘æŒ‡å®šçš„æäº¤å¯¹è±¡ (æ—¶å…‰æœº)</span></span><br><span class="line">$ git branch branchname commitHash</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æ”¯åˆå¹¶ ï¼ˆåˆå¹¶å‰åˆ‡å›ä¸»åˆ†æ”¯ï¼Œå†åˆå¹¶éœ€è¦åˆå¹¶çš„åˆ†æ”¯ï¼‰</span></span><br><span class="line"><span class="comment"># åˆå¹¶å¯èƒ½ä¼šäº§ç”Ÿå†²çªï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹å†²çªçš„æ–‡ä»¶ï¼Œå†æäº¤</span></span><br><span class="line">$ git merge otherBranch</span><br></pre></td></tr></table></figure><h2 id="stashç›¸å…³"><a class="header-anchor" href="#stashç›¸å…³">Â¶</a>stashç›¸å…³</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ‰æ—¶æƒ³åˆ‡åˆ†æ”¯ï¼Œä½†åˆä¸æƒ³æäº¤ï¼Œå¯ä»¥ç”¨åˆ° stash åŠŸèƒ½ï¼Œæ˜¯ä¸€ç§æš‚å­˜çš„æ ˆã€‚è¿™ä¸ªæ ˆæ˜¯é’ˆå¯¹åˆ†æ”¯çš„ï½</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰åˆ†æ”¯çš„ stash</span></span><br><span class="line">$ git stash list</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æœªæäº¤çš„æ”¹åŠ¨ å…¥æ ˆï¼ˆæ¥ç€å¯ä»¥å®‰å…¨æ‰§è¡Œåˆ‡åˆ†æ”¯æ“ä½œï¼‰</span></span><br><span class="line">$ git stash</span><br><span class="line"></span><br><span class="line"><span class="comment"># ï¼ˆåˆ‡å›åˆ†æ”¯åï¼‰å¼¹å‡º æ”¹åŠ¨</span></span><br><span class="line">$ git pop</span><br><span class="line"></span><br><span class="line"><span class="comment"># åé¢ä¸¤ä¸ªä¸€èˆ¬ä¸ç”¨ï¼Œæˆ‘ä»¬æ ˆé‡Œåªæ”¾ä¸€ä¸ªå…ƒç´ ï¼Œgit stash å…¥æ ˆï¼Œgit pop å‡ºæ ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åªå–æŒ‡å®šæ”¹åŠ¨ï¼Œä¸åˆ é™¤</span></span><br><span class="line">$ git stash apply stashName</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æŒ‡å®šçš„æ ˆé‡Œçš„ä¸œè¥¿</span></span><br><span class="line">$ git stash drop stashName</span><br></pre></td></tr></table></figure><h2 id="å›é€€ç›¸å…³"><a class="header-anchor" href="#å›é€€ç›¸å…³">Â¶</a>å›é€€ç›¸å…³</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ’¤å›å·¥ä½œç›®å½•çš„ä¿®æ”¹ï¼ˆæœªadd -&gt; æœªä¿®æ”¹ï¼‰</span></span><br><span class="line">$ git checkout -- fileName</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›æš‚å­˜åŒºçš„ä¿®æ”¹ ï¼ˆæœªcommit -&gt; æœªaddï¼‰</span></span><br><span class="line">$ git reset [HEAD] fileName</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨äºä¿®æ”¹åˆšåˆšæäº¤çš„messageï¼ˆç›¸å½“äºåé€€ä¸€æ­¥ï¼Œå†é‡æ–°æäº¤ï¼‰</span></span><br><span class="line">$ git commit --amend</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„ä¸‹é¢3ä¸ªå‘½ä»¤éƒ½å¯ä»¥æ’¤å›åˆ°æŒ‡å®šæäº¤å¯¹è±¡ï¼ˆæŠŠ HEAD~ æ”¹ä¸ºæŒ‡å®šçš„ commitHash å³å¯ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›ä¸Šä¸€æ¬¡æäº¤ ï¼ˆcommit -&gt; æœªcommitï¼‰</span></span><br><span class="line">$ git reset --soft HEAD~</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›ä¸Šä¸€æ¬¡æäº¤åŒæ—¶æ’¤å›æš‚å­˜åŒºçš„ä¿®æ”¹ ï¼ˆcommit -&gt; æœªaddï¼‰</span></span><br><span class="line">$ git reset [--mix] HEAD~</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›ä¸Šä¸€æ¬¡æäº¤åŒæ—¶æ’¤å›æš‚å­˜åŒºçš„ä¿®æ”¹åŒæ—¶æ’¤å›å·¥ä½œç›®å½•çš„ä¿®æ”¹ ï¼ˆcommit -&gt; æœªä¿®æ”¹ï¼Œå±é™©ï¼ï¼‰</span></span><br><span class="line">$ git reset --hard HEAD~</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›å°‘ç”¨ reset --hardï¼Œæœ€å¥½ä½¿ç”¨ branch </span></span><br><span class="line">$ git branch recoverBranchName commitHash</span><br></pre></td></tr></table></figure><h2 id="æ ‡ç­¾ç›¸å…³"><a class="header-anchor" href="#æ ‡ç­¾ç›¸å…³">Â¶</a>æ ‡ç­¾ç›¸å…³</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰tag</span></span><br><span class="line">$ git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“tag</span></span><br><span class="line">$ git tag tagName commitHash</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æŒ‡å®štag</span></span><br><span class="line">$ git tag -d tagName</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡åˆ°æŒ‡å®štagï¼Œç„¶ååˆ›æ–°åˆ†æ”¯ï¼Œé˜²æ­¢å¤´éƒ¨åˆ†ç¦»</span></span><br><span class="line">$ git checkout tagName</span><br><span class="line">$ git checkout -b branchName</span><br></pre></td></tr></table></figure><h2 id="è¿œç¨‹ç›¸å…³"><a class="header-anchor" href="#è¿œç¨‹ç›¸å…³">Â¶</a>è¿œç¨‹ç›¸å…³</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å…¨éƒ¨è¿œç¨‹åˆ†æ”¯</span></span><br><span class="line">$ git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è¿œç¨‹åˆ†æ”¯åˆ«å(æ³¨æ„ï¼šorgin åªä¸ªåˆ«å)</span></span><br><span class="line">$ git remote add orgin https://xxxx.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…‹éš†è¿œç¨‹ä»“åº“åˆ°æœ¬åœ°ï¼ˆæ­¤æ—¶è‡ªåŠ¨åˆ›å»ºå…¨éƒ¨è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼ŒåŒæ—¶ç”Ÿæˆä¸€ä¸ªå…³è”è¿œç¨‹masterçš„æœ¬åœ°åˆ†æ”¯ï¼ˆæ³¨æ„ï¼‰ï¼‰</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://xxxx.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±æœ¬åœ°åˆ†æ”¯åˆ›å»ºè¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼Œå†æ¨åˆ°è¿œç¨‹åˆ†æ”¯ï¼Œä½†å¹¶ä¸å…³è”ï¼ˆæ³¨æ„ï¼‰</span></span><br><span class="line"><span class="comment"># æ¨èä»…å½“åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œå¹¶æƒ³æŠŠå®ƒæ¨åˆ°è¿œç¨‹æ—¶ï¼Œæ‰ä½¿ç”¨å®ƒï¼›å¹¶ä¸”æ¥ç€æ‰§è¡Œå…³è”æ“ä½œï¼Œä¹Ÿå°±ä¸‹ä¸€è¡Œï¼Œä¹‹åä»…ç”¨ git push å³å¯</span></span><br><span class="line">$ git push orgin branchName</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°åˆ†æ”¯ï¼ˆå·²åˆ›å»ºï¼‰å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</span></span><br><span class="line">$ git branch -u orgin/branchName</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–è¿œç¨‹åˆ†æ”¯ï¼ˆå…¨éƒ¨åˆ†æ”¯ï¼‰åˆ°è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ä¸­</span></span><br><span class="line"><span class="comment"># æ¨èä»…å½“è¿œç¨‹æœ‰äº†æ–°åˆ†æ”¯æ—¶ï¼Œæ‰ä½¿ç”¨å®ƒï¼ˆæ³¨æ„ï¼‰</span></span><br><span class="line">$ git fetch orgin</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæœ¬åœ°åˆ†æ”¯ï¼ŒåŒæ—¶å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</span></span><br><span class="line">$ git branch -b branchName orgin/branchName</span><br><span class="line">$ git branch --track orgin/branchName (æ•ˆæœä¸€æ ·ï¼Œå¿«æ·å†™æ³•)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å»è¿œç¨‹åˆ†æ”¯åˆ°è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯å’Œæœ¬åœ°åˆ†æ”¯ï¼ˆæœ¬åœ°åˆ†æ”¯å·²ç»å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼‰ï¼Œç›¸å½“äºæ‰§è¡Œ git fetch + git merge</span></span><br><span class="line">$ git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è¿œç¨‹åˆ†æ”¯</span></span><br><span class="line">$ git push orgin --delete branchName</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ²¡ç”¨è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼Œå¹¶åˆ é™¤</span></span><br><span class="line">$ git remote prune orgin --dry-run</span><br><span class="line">$ git remote orgin</span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä½†åªè¦è®°ä½ä¸€ä¸ªé€»è¾‘é“¾å°±å¥½ï¼Œä¹Ÿå°±æ˜¯æŒ‰ä»¥ä¸‹3æ­¥èµ°ï¼š</p><ol><li><p><strong>å»ºç«‹è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</strong></p><ul><li><code>git clone https://xxxx.git</code></li><li><code>git push orgin branchName</code> æ¨<strong>æ–°åˆ†æ”¯</strong>åˆ°è¿œç¨‹</li><li><code>git fetch orgin</code> æ‹‰è¿œç¨‹çš„<strong>æ–°åˆ†æ”¯</strong></li></ul></li><li><p><strong>æœ¬åœ°åˆ†æ”¯å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</strong></p><ul><li><code>git checkout branchName</code> åˆ›å»ºæœ¬åœ°æ–°åˆ†æ”¯ï¼ˆå’Œè¿œç¨‹åˆ†æ”¯åŒåï¼‰ å¹¶å…³è” (è¿˜æ˜¯å®ƒç®€å•)</li><li><code>git branch -u orgin/branchName</code> å½“å‰åˆ†æ”¯ å…³è”</li><li><code>git branch --track orgin/branchName</code> åˆ›å»ºæœ¬åœ°æ–°åˆ†æ”¯ å…³è”</li></ul></li><li><p><strong>æ„‰å¿«ä½¿ç”¨</strong></p><ul><li><code>git pull</code> æ‹‰åˆ°æœ¬åœ°</li><li><code>git push</code> æ¨åˆ°è¿œç¨‹ï¼ˆå…ˆ pullï¼Œè§£å†³å†²çªå† pushï¼‰</li></ul></li></ol><p>ä¸Šé¢æ˜¯è‡ªå·±å›¢é˜Ÿçš„é¡¹ç›®ï¼ˆ<strong>æœ‰æƒé™</strong>ï¼‰ï¼Œå½“æƒ³ä¸ºå¼€æºé¡¹ç›®åšè´¡çŒ®ï¼ˆ<strong>æ²¡æƒé™</strong>ï¼‰æ—¶ï¼Œä½¿ç”¨ <strong>pull request</strong>ï¼Œ å¤§è‡´æµç¨‹ï¼ˆç”¨åˆ°å†ç ”ç©¶ï¼‰ä¸ºï¼š</p><ol><li><p><strong>folk ä¸€ä»½</strong></p></li><li><p><strong>åœ¨ folk çš„åº“ä¸­ï¼Œä½œå‡ºæ”¹åŠ¨å¹¶æäº¤ï¼Œæ³¨æ„æäº¤å‰å…ˆæ‹‰è¿œç¨‹åº“ï¼Œä¿æŒæœ€æ–°ã€‚</strong></p></li><li><p><strong>è¿›ç½‘ç«™ï¼ˆå¦‚githubï¼‰ï¼Œç‚¹ pullRequest</strong></p></li></ol><h1>åº•å±‚</h1><p>git çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸€ç§åœ¨ <code>object</code> ç›®å½•ä¸­å­˜æ”¾çš„ k-v ç±»å‹çš„æ•°æ®ã€‚key æ˜¯ hashå€¼ (å‰ä¸¤ä½æ˜¯å­æ–‡ä»¶å¤¹åï¼Œåé¢æ˜¯æ–‡ä»¶å)ï¼Œvalue æ˜¯ æ•°æ®å†…å®¹ã€‚</p><p>æ•°æ®å†…å®¹ åˆ†ä¸º <strong>git å¯¹è±¡</strong>ï¼ˆ<code>blob</code>ï¼‰ã€<strong>æ ‘å¯¹è±¡</strong>ï¼ˆ<code>tree</code>ï¼‰ã€<strong>æäº¤å¯¹è±¡</strong>ï¼ˆ<code>commit</code>ï¼‰</p><h2 id="git-å¯¹è±¡"><a class="header-anchor" href="#git-å¯¹è±¡">Â¶</a>git å¯¹è±¡</h2><p><strong>ä»£è¡¨æ–‡ä»¶ï¼Œå®ƒæ˜¯çœŸæ­£å­˜æ•°æ®çš„</strong>ã€‚å®ƒæ˜¯ä¸€å¯¹ä¸€çš„ï¼ˆæ³¨æ„ï¼š<strong>ä¸€ä¸ªæ–‡ä»¶çš„å†å²æ–‡ä»¶éƒ½ç®—ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶</strong>ï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘æ•°æ®åº“ä¸­å†™æ•°æ®ï¼Œå¹¶è¿”å›hashé”®å€¼ã€‚å­˜çš„æ˜¯ä¸€ä¸ªblobå¯¹è±¡</span></span><br><span class="line">$ git <span class="built_in">hash</span>-object -w test.txt</span><br><span class="line">915c628f360b2d8c3edbe1ac65cf575b69029b61</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®æ˜¯ç»è¿‡å‹ç¼©çš„ï¼Œå¯ä»¥ç”¨cat-fileæŸ¥çœ‹è¯¥æ•°æ®</span></span><br><span class="line"><span class="comment"># -p æ˜¾ç¤ºå†…å®¹ï¼› -t æŸ¥çœ‹ç±»å‹</span></span><br><span class="line">$ git cat-file -p 915c628f360b2d8c3edbe1ac65cf575b69029b61</span><br><span class="line">hello git</span><br></pre></td></tr></table></figure><h2 id="æ ‘å¯¹è±¡"><a class="header-anchor" href="#æ ‘å¯¹è±¡">Â¶</a>æ ‘å¯¹è±¡</h2><p><strong>ä»£è¡¨ç‰ˆæœ¬</strong>ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªæ ‘å¯¹è±¡æŒ‡å‘å¤šä¸ª git å¯¹è±¡ï¼Œå½¢æˆä¸€ä¸ªç‰ˆæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æš‚å­˜åŒº å†™å…¥ test.txt çš„é¦–ä¸ªç‰ˆæœ¬ï¼ˆæŒ‡é’ˆä¿¡æ¯ï¼‰</span></span><br><span class="line"><span class="comment"># --add æ–‡ä»¶é¦–æ¬¡æ·»åŠ ï¼›--cacheinfo è¡¨ç¤ºæ·»åŠ çš„æ–‡ä»¶ä½äºgitæ•°æ®åº“ï¼›100644 æ–‡ä»¶ç±»å‹ï¼› test.txt æ–‡ä»¶å</span></span><br><span class="line">$ git update-index --add --cacheinfo 100644 915c628f360b2d8c3edbe1ac65cf575b69029b61 test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æš‚å­˜åŒº</span></span><br><span class="line">$ git ls-files -s</span><br><span class="line">100644 915c628f360b2d8c3edbe1ac65cf575b69029b61 0 test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ ‘å¯¹è±¡ã€‚æš‚å­˜åŒºæœªæ¸…ç©º</span></span><br><span class="line">$ git write-tree</span><br><span class="line">72203871fa4668ad777833634034dcd3426879db</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ ‘å¯¹è±¡å†…å®¹</span></span><br><span class="line">$ git cat-file -p 72203871fa4668ad777833634034dcd3426879db</span><br><span class="line">100644 blob 915c628f360b2d8c3edbe1ac65cf575b69029b61 test.txt</span><br></pre></td></tr></table></figure><h2 id="æäº¤å¯¹è±¡"><a class="header-anchor" href="#æäº¤å¯¹è±¡">Â¶</a>æäº¤å¯¹è±¡</h2><p><strong>ç›¸å½“äºå¯¹ç‰ˆæœ¬æ·»åŠ æè¿°ä¿¡æ¯</strong>ã€‚ä¸€ä¸ªæäº¤å¯¹è±¡å°è£…ä¸€ä¸ªæ ‘å¯¹è±¡ï¼Œè€Œä¸”å®ƒæ˜¯<strong>é“¾å¼</strong>çš„ï¼Œé‡Œé¢æŒ‡å‘ä¸Šä¸€ä¸ªæäº¤å¯¹è±¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆæäº¤å¯¹è±¡ï¼Œåæ¥æ ‘å¯¹è±¡hashå€¼</span></span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯ç¬¬ä¸€æ¬¡æäº¤ã€‚ä»¥åå¯ä»¥åŠ  -p æŒ‡å®šçˆ¶æäº¤å¯¹è±¡</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'first commit'</span> | git commit-tree 72203871fa4668ad777833634034dcd3426879db</span><br><span class="line">5402d3560f35d66f7f1e4e4665dd63bf3d786495</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æäº¤å¯¹è±¡çš„å†…å®¹</span></span><br><span class="line">$ git cat-file -p 5402d3560f35d66f7f1e4e4665dd63bf3d786495</span><br><span class="line">tree 72203871fa4668ad777833634034dcd3426879db</span><br><span class="line">author zouxxyy &lt;xxxxxxxxx@qq.com&gt; 1575450654 +0800</span><br><span class="line">committer zouxxyy &lt;xxxxxxxxx@qq.com&gt; 1575450654 +0800</span><br><span class="line"></span><br><span class="line">first commit</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶ç›¸å…³-v2"><a class="header-anchor" href="#æ–‡ä»¶ç›¸å…³-v2">Â¶</a>æ–‡ä»¶ç›¸å…³</h2><ul><li><p><code>git add test.txt</code> ç›¸å½“äºå…ˆå°†æ–‡ä»¶åšæˆ<code>gitå¯¹è±¡</code>å­˜å…¥<code>object</code> ï¼Œå†å°†å®ƒï¼ˆæŒ‡é’ˆä¿¡æ¯ï¼‰æ”¾å…¥æš‚å­˜åŒºï¼Œç­‰å¾…æäº¤ã€‚è¯¥æ“ä½œæ˜¯<strong>ç»å¯¹å®‰å…¨</strong>çš„ï¼Œå› ä¸ºæ•°æ®å·²ç»å†™å…¥æ–‡ä»¶ä¸­ã€‚æ‰€ä»¥å¯ä»¥ç†è§£ä¸ºå•¥åªæœ‰ <code>git add</code>ï¼Œè€Œæ²¡æœ‰ä»€ä¹ˆ<code>git change</code>ä¹‹ç±»çš„ï¼Œå› ä¸ºä¿®æ”¹ä¹Ÿä¼šåŠ <code>gitå¯¹è±¡</code>ã€‚</p></li><li><p><code>git commit -m &quot;xx&quot;</code> ç”±æš‚å­˜åŒºç”Ÿæˆæ ‘å¯¹è±¡ï¼Œå†ç”Ÿæˆæäº¤å¯¹è±¡ã€‚<strong>æ³¨æ„æš‚å­˜åŒºçš„ä¸œè¥¿ä¸åˆ é™¤</strong></p></li><li><p><code>git rm test.txt</code> <strong>ç›¸å½“äºå°†è¯¥æ–‡ä»¶å¯¹åº”çš„ï¼ˆæŒ‡é’ˆä¿¡æ¯ï¼‰ä»æš‚å­˜åŒºä¸­åˆ é™¤ï¼ŒåŒæ—¶åˆ é™¤å·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶</strong></p></li></ul><h2 id="åˆ†æ”¯ç›¸å…³-v2"><a class="header-anchor" href="#åˆ†æ”¯ç›¸å…³-v2">Â¶</a>åˆ†æ”¯ç›¸å…³</h2><p><strong>åˆ†æ”¯åˆ‡æ¢ä¼šåˆ‡æ¢å·¥ä½œç›®å½•</strong>ï¼Œæ‰€ä»¥åˆ‡æ¢å‰ï¼Œå…ˆæŠŠå½“å‰åˆ†æ”¯è¯¥æäº¤çš„æäº¤äº†ï¼Œ<strong>ä¿è¯å·¥ä½œç›®å½•å¹²å‡€</strong>ã€‚</p><ul><li><p>2ä¸ªé‡è¦çš„ä¸œè¥¿ï¼š</p><ul><li><code>refs</code> å­˜æ”¾å„ä¸ªåˆ†æ”¯ï¼ˆå’Œtagsï¼‰çš„æäº¤å¯¹è±¡çš„æŒ‡é’ˆï¼ˆhashkeyï¼‰</li><li><code>HEAD</code> æŒ‡æ˜å½“å‰åˆ†æ”¯çš„æŒ‡é’ˆä½ç½®</li></ul></li><li><p><code>git branch branchname</code> ç›¸å½“äºåœ¨ <code>refs/heads</code> ç›®å½•ä¸­æ–°å»ºä»¥<strong>åˆ†æ”¯å</strong>å‘½åçš„å½“å‰åˆ†æ”¯çš„æäº¤å¯¹è±¡çš„æŒ‡é’ˆ</p></li><li><p><code>git checkout branchname</code> æ›´æ”¹<code>HEAD</code>æ–‡ä»¶ï¼›<strong>åˆ‡æ¢å·¥ä½œç›®å½•</strong>ï¼›<strong>å½±å“æš‚å­˜åŒº</strong></p></li><li><p><code>git commit -m &quot;commit message&quot;</code> æ›´æ–° <code>refs</code> ä¸­å¯¹åº”åˆ†æ”¯çš„æäº¤å¯¹è±¡</p></li></ul><h2 id="å›é€€ç›¸å…³-v2"><a class="header-anchor" href="#å›é€€ç›¸å…³-v2">Â¶</a>å›é€€ç›¸å…³</h2><p><code>git checkout branchName</code> å’Œ <code>git reset --hard commitHash</code> çš„åŒºåˆ« ï¼š</p><ul><li><p><code>checkout</code> åªæ”¹HEAD ï¼›<code>reset</code> HEAD å’Œ åˆ†æ”¯æŒ‡é’ˆçš„ä¸€èµ·æ”¹</p></li><li><p><code>checkout</code> å¯¹å·¥ä½œç›®å½•æ˜¯å®‰å…¨çš„ï¼›<code>reset --hard</code> ä¼š<strong>å®Œå…¨å¼ºåˆ¶è¦†ç›–å·¥ä½œç›®å½•</strong></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬æ–‡ä¸»è¦åŒ…æ‹¬Gitçš„ç”¨æ³•åŠ åº•å±‚&lt;/p&gt;
&lt;h1&gt;ä½¿ç”¨&lt;/h1&gt;
&lt;h2 id=&quot;åˆå§‹åŒ–ç›¸å…³&quot;&gt;&lt;a class=&quot;header-anchor&quot; href=&quot;#åˆå§‹åŒ–ç›¸å…³&quot;&gt;Â¶&lt;/a&gt;åˆå§‹åŒ–ç›¸å…³&lt;/h2&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# --system æ“ä½œç³»ç»Ÿçº§åˆ«ï¼› --global ç”¨æˆ·çº§åˆ«ï¼› ä¸åŠ ï¼š é¡¹ç›®çº§åˆ« &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ git config --global user.name &lt;span class=&quot;string&quot;&gt;&quot;zouxxyy&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ git config --global user.email &lt;span class=&quot;string&quot;&gt;&quot;xxxxxxxxxxxxxx&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# æŸ¥çœ‹é…ç½®&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ git config --list&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# åˆ›å»ºgitå¯¹è±¡ï¼Œä¼šç”Ÿæˆ .git ç›®å½•&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ git init&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ ls&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;HEAD                 æŒ‡ç¤ºå½“å‰åˆ†æ”¯çš„æ–‡ä»¶&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;config               é…ç½®æ–‡ä»¶&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;hooks.  ï¼ˆç›®å½•ï¼‰      å­˜æ”¾é’©å­è„šæœ¬ï¼Œæ¯”å¦‚æäº¤ä»£ç å‰æˆ–è€…åçš„è‡ªåŠ¨æ‰§è¡Œæ“ä½œ&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;objects ï¼ˆç›®å½•ï¼‰      å­˜æ”¾æ‰€æœ‰å†å²è®°å½•çš„&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;branches             æŒ‡ç¤ºç›®å‰è¢«æ£€æµ‹å‡ºçš„åˆ†æ”¯&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;description          ä»“åº“æè¿°æ€§ä¿¡æ¯çš„æ–‡ä»¶&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;info    ï¼ˆç›®å½•ï¼‰      å­˜æ”¾å…¨å±€æ€§çš„æ’é™¤æ–‡ä»¶ã€‚æ¯”å¦‚ mac è¿›å»æŸ¥çœ‹å°±æœ‰.DS_Store&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;refs    ï¼ˆç›®å½•ï¼‰      å­˜æ”¾åˆ†æ”¯ä¸tagsçš„æäº¤å¯¹è±¡çš„æŒ‡é’ˆ&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
  </entry>
  
  <entry>
    <title>sparkæºç -shuffleä¹‹BlockStoreShuffleReader</title>
    <link href="http://yoursite.com/2019/12/30/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BBlockStoreShuffleReader/"/>
    <id>http://yoursite.com/2019/12/30/sparkæºç -shuffleä¹‹BlockStoreShuffleReader/</id>
    <published>2019-12-30T01:33:22.000Z</published>
    <updated>2019-12-30T01:42:59.921Z</updated>
    
    <content type="html"><![CDATA[<p>sparkçš„å”¯ä¸€ ShuffleReader ï¼šBlockStoreShuffleReader</p><a id="more"></a><p>spark ç‰ˆæœ¬ 2.4.3</p><h1>å¼•å…¥</h1><p><a href="https://zouxxyy.github.io/2019/11/29/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BShuffleManager/" target="_blank" rel="noopener">ä¹‹å‰</a>æè¿‡ï¼Œ<code>getShuffleWrite</code> åªåœ¨ <code>ShuffleMapTask</code> ä¸­å‡ºç°ã€‚</p><p>é‚£ä¹ˆ<code>getShuffleRead</code>å‘¢ï¼Ÿç”±äºä¸ç®¡å“ªä¸ª Task éƒ½éœ€è¦è¯»æ•°æ®ï¼Œäºæ˜¯å°±æŠŠè¯¥æ­¥éª¤å°è£…åœ¨RDDçš„<code>computer</code>æ–¹æ³•ä¸­ã€‚ä»¥ä¸‹æ˜¯<code>ShuffleRDD</code>ä¸­çš„<code>computer</code>æ–¹æ³•ã€‚é€šè¿‡è°ƒç”¨ <code>shuffleManager</code> çš„ <code>getReader</code> å°±è·å–äº†æœ¬æ–‡çš„ä¸»è§’<code>BlockStoreShuffleReader</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compute</span></span>(split: <span class="type">Partition</span>, context: <span class="type">TaskContext</span>): <span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">C</span>)] = &#123;</span><br><span class="line">  <span class="keyword">val</span> dep = dependencies.head.asInstanceOf[<span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>]]</span><br><span class="line">  <span class="comment">// æ˜¯ä¸æ˜¯è§‰å¾— split.index, split.index + 1 å¾ˆæ€ªï¼Œåé¢ä¼šå‘ç°è¿™æ˜¯æ€ä¹ˆå›äº‹</span></span><br><span class="line">  <span class="type">SparkEnv</span>.get.shuffleManager.getReader(dep.shuffleHandle, split.index, split.index + <span class="number">1</span>, context)</span><br><span class="line">    .read()</span><br><span class="line">    .asInstanceOf[<span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">C</span>)]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>å¤§è‡´æµç¨‹</h1><ol><li><p><strong>è·å–åˆå§‹è¿­ä»£å™¨<code>ShuffleBlockFetcherIterator</code></strong>ï¼ˆ<code>Iterator[(BlockId, InputStream)</code>ï¼‰</p></li><li><p><strong>ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ k,v è¿­ä»£å™¨</strong>ï¼ˆ<code>Iterator[(key, value)]</code>ï¼‰</p></li><li><p><strong>æ·»åŠ readMetricsï¼Œå†å°è£…æˆ<code>InterruptibleIterator</code></strong></p></li><li><p><strong>è¿›è¡Œèšåˆæ“ä½œ</strong>ã€‚åˆ†æœ‰æ— èšåˆï¼Œå½“æœ‰èšåˆæ—¶ï¼Œåˆåˆ†æ˜¯å¦æ‰§è¡Œè¿‡mapèšåˆ</p></li><li><p><strong>è¿›è¡Œæ’åºæ“ä½œ</strong>ã€‚åˆ†æœ‰æ— æ’åºã€‚</p></li></ol><p><code>BlockStoreShuffleReader </code> è¦å¹²çš„äº‹å…¶å®å¾ˆå®¹æ˜“ç†è§£ï¼Œå°±æ˜¯æŠŠ<strong>ä¸åŒ block ä¸­åŒä¸€åˆ†åŒºçš„record</strong>ï¼Œæ‹‰åˆ°æŒ‡å®šçš„ reducer ä¸­ï¼Œå†å¯¹å®ƒè¿›è¡Œ<strong>èšåˆå’Œæ’åº</strong>å³å¯ã€‚ä¸€ä¸ª reducer å¤„ç†ä¸€ä¸ªåˆ†åŒºã€‚</p><h1>æºç </h1><h2 id="è·å–åˆå§‹è¿­ä»£å™¨ShuffleBlockFetcherIterator"><a class="header-anchor" href="#è·å–åˆå§‹è¿­ä»£å™¨ShuffleBlockFetcherIterator">Â¶</a>è·å–åˆå§‹è¿­ä»£å™¨<code>ShuffleBlockFetcherIterator</code></h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–åˆå§‹è¿­ä»£å™¨ ShuffleBlockFetcherIterator</span></span><br><span class="line"><span class="keyword">val</span> wrappedStreams = <span class="keyword">new</span> <span class="type">ShuffleBlockFetcherIterator</span>(</span><br><span class="line">  context,</span><br><span class="line">  blockManager.shuffleClient, <span class="comment">// é»˜è®¤æ˜¯ NettyBlockTransferServiceï¼Œå¦‚æœä½¿ç”¨å¤–éƒ¨shuffleç³»ç»Ÿåˆ™ä½¿ç”¨ ExternalShuffleClient</span></span><br><span class="line">  blockManager,</span><br><span class="line">  <span class="comment">// é€šè¿‡å®ƒå¾—åˆ° 2å…ƒtuple : (BlockManagerId, Seq[(BlockId, BlockSize)])</span></span><br><span class="line">  mapOutputTracker.getMapSizesByExecutorId(handle.shuffleId, startPartition, endPartition),</span><br><span class="line">  serializerManager.wrapStream,</span><br><span class="line">  <span class="comment">// Note: we use getSizeAsMb when no suffix is provided for backwards compatibility</span></span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.getSizeAsMb(<span class="string">"spark.reducer.maxSizeInFlight"</span>, <span class="string">"48m"</span>) * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.getInt(<span class="string">"spark.reducer.maxReqsInFlight"</span>, <span class="type">Int</span>.<span class="type">MaxValue</span>),</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.get(config.<span class="type">REDUCER_MAX_BLOCKS_IN_FLIGHT_PER_ADDRESS</span>),</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.get(config.<span class="type">MAX_REMOTE_BLOCK_SIZE_FETCH_TO_MEM</span>),</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.getBoolean(<span class="string">"spark.shuffle.detectCorrupt"</span>, <span class="literal">true</span>))</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ <code>mapOutputTracker.getMapSizesByExecutorId</code> é‡Œçš„å…³é”®æ­¥éª¤</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convertMapStatuses</span></span>(</span><br><span class="line">    shuffleId: <span class="type">Int</span>,</span><br><span class="line">    startPartition: <span class="type">Int</span>,</span><br><span class="line">    endPartition: <span class="type">Int</span>,</span><br><span class="line">    statuses: <span class="type">Array</span>[<span class="type">MapStatus</span>]): <span class="type">Iterator</span>[(<span class="type">BlockManagerId</span>, <span class="type">Seq</span>[(<span class="type">BlockId</span>, <span class="type">Long</span>)])] = &#123;</span><br><span class="line">  assert (statuses != <span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">val</span> splitsByAddress = <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">BlockManagerId</span>, <span class="type">ListBuffer</span>[(<span class="type">BlockId</span>, <span class="type">Long</span>)]]</span><br><span class="line">  <span class="comment">// mapTask çš„ä¸ªæ•°å†³å®šäº† Seq[(BlockId, BlockSize)] å†…å…ƒç´ çš„ä¸ªæ•°ï¼Œå¾ˆå¥½ç†è§£</span></span><br><span class="line">  <span class="keyword">for</span> ((status, mapId) &lt;- statuses.iterator.zipWithIndex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (status == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> errorMessage = <span class="string">s"Missing an output location for shuffle <span class="subst">$shuffleId</span>"</span></span><br><span class="line">      logError(errorMessage)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">MetadataFetchFailedException</span>(shuffleId, startPartition, errorMessage)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å·¦é—­å³å¼€ï¼Œå› æ­¤å‰é¢çš„ ï¼ˆsplit.index, split.index + 1ï¼‰ä¸­çš„ split.index + 1ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆè½¯ç”¨  </span></span><br><span class="line">      <span class="keyword">for</span> (part &lt;- startPartition until endPartition) &#123;</span><br><span class="line">        <span class="keyword">val</span> size = status.getSizeForBlock(part)</span><br><span class="line">        <span class="keyword">if</span> (size != <span class="number">0</span>) &#123;</span><br><span class="line">          splitsByAddress.getOrElseUpdate(status.location, <span class="type">ListBuffer</span>()) +=</span><br><span class="line">              ((<span class="type">ShuffleBlockId</span>(shuffleId, mapId, part), size))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  splitsByAddress.iterator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ShuffleBlockFetcherIterator  </code>è¿™ä¸ªè¿­ä»£å™¨çš„å…·ä½“å®ç°æ¯”è¾ƒå¤æ‚ï¼Œç®€å•ä»‹ç»ä¸‹ï¼š</p><ul><li><p>åˆ†æœ¬åœ°æ•°æ®å— å’Œ è¿œç¨‹æ•°æ®å—</p></li><li><p>æœ¬åœ°æ•°æ®å—ç›´æ¥è°ƒç”¨ <code>BlockManager.getBlockData</code></p></li><li><p>è¿œç¨‹æ•°æ®å—é‡‡ç”¨Nettyé€šè¿‡ç½‘ç»œè·å–</p></li></ul><p>ä¸‹é¢æ˜¯ <code>IndexShuffleBlockResolver</code> ä¸­çš„ <code>getBlockData</code>ã€‚æˆ‘ä»¬çš„ç´¢å¼•æ–‡ä»¶ï¼ˆindexFileï¼‰ç»ˆäºæ´¾ä¸Šç”¨åœº</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getBlockData</span></span>(blockId: <span class="type">ShuffleBlockId</span>): <span class="type">ManagedBuffer</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> indexFile = getIndexFile(blockId.shuffleId, blockId.mapId)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> channel = <span class="type">Files</span>.newByteChannel(indexFile.toPath)</span><br><span class="line">  <span class="comment">// æ ¹æ®reduceIdé€‰æ‹©ç´¢å¼•</span></span><br><span class="line">  channel.position(blockId.reduceId * <span class="number">8</span>L)</span><br><span class="line">  <span class="keyword">val</span> in = <span class="keyword">new</span> <span class="type">DataInputStream</span>(<span class="type">Channels</span>.newInputStream(channel))</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> offset = in.readLong()</span><br><span class="line">    <span class="keyword">val</span> nextOffset = in.readLong()</span><br><span class="line">    <span class="keyword">val</span> actualPosition = channel.position()</span><br><span class="line">    <span class="keyword">val</span> expectedPosition = blockId.reduceId * <span class="number">8</span>L + <span class="number">16</span></span><br><span class="line">    <span class="keyword">if</span> (actualPosition != expectedPosition) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">Exception</span>(<span class="string">s"SPARK-22982: Incorrect channel position after index file reads: "</span> +</span><br><span class="line">        <span class="string">s"expected <span class="subst">$expectedPosition</span> but actual position was <span class="subst">$actualPosition</span>."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">FileSegmentManagedBuffer</span>(</span><br><span class="line">      transportConf,</span><br><span class="line">      getDataFile(blockId.shuffleId, blockId.mapId),</span><br><span class="line">      offset,</span><br><span class="line">      nextOffset - offset)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    in.close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ-k-v-è¿­ä»£å™¨"><a class="header-anchor" href="#ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ-k-v-è¿­ä»£å™¨">Â¶</a>ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ k,v è¿­ä»£å™¨</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> serializerInstance = dep.serializer.newInstance()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a key/value iterator for each stream</span></span><br><span class="line"><span class="keyword">val</span> recordIter = wrappedStreams.flatMap &#123; <span class="keyword">case</span> (blockId, wrappedStream) =&gt;</span><br><span class="line">  serializerInstance.deserializeStream(wrappedStream).asKeyValueIterator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ readMetricsï¼Œå†å°è£…æˆInterruptibleIterator"><a class="header-anchor" href="#æ·»åŠ readMetricsï¼Œå†å°è£…æˆInterruptibleIterator">Â¶</a>æ·»åŠ readMetricsï¼Œå†å°è£…æˆ<code>InterruptibleIterator</code></h2><p>readMetrics é‡Œéƒ½æ˜¯äº›è®°å½•æ•°æ®ï¼Œç”¨äºç›‘æ§å±•ç¤º</p><p><code>InterruptibleIterator</code> å°è£…äº†ä»»åŠ¡ä¸­æ–­åŠŸèƒ½</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update the context task metrics for each record read.</span></span><br><span class="line"><span class="keyword">val</span> readMetrics = context.taskMetrics.createTempShuffleReadMetrics()</span><br><span class="line"><span class="keyword">val</span> metricIter = <span class="type">CompletionIterator</span>[(<span class="type">Any</span>, <span class="type">Any</span>), <span class="type">Iterator</span>[(<span class="type">Any</span>, <span class="type">Any</span>)]](</span><br><span class="line">  recordIter.map &#123; record =&gt;</span><br><span class="line">    readMetrics.incRecordsRead(<span class="number">1</span>) <span class="comment">// sparkUI é‡Œçš„ record æ•°</span></span><br><span class="line">    record</span><br><span class="line">  &#125;,</span><br><span class="line">  context.taskMetrics().mergeShuffleReadMetrics())</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> interruptibleIter = <span class="keyword">new</span> <span class="type">InterruptibleIterator</span>[(<span class="type">Any</span>, <span class="type">Any</span>)](context, metricIter)</span><br></pre></td></tr></table></figure><h2 id="è¿›è¡Œèšåˆæ“ä½œ"><a class="header-anchor" href="#è¿›è¡Œèšåˆæ“ä½œ">Â¶</a>è¿›è¡Œèšåˆæ“ä½œ</h2><p>åˆ†æœ‰æ— èšåˆï¼Œå½“æœ‰èšåˆæ—¶ï¼Œåˆåˆ†æ˜¯å¦åœ¨ mapTask æ—¶æ‰§è¡Œè¿‡mapèšåˆ</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> aggregatedIter: <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] = <span class="keyword">if</span> (dep.aggregator.isDefined) &#123;</span><br><span class="line">  <span class="keyword">if</span> (dep.mapSideCombine) &#123;</span><br><span class="line">    <span class="comment">// We are reading values that are already combined</span></span><br><span class="line">    <span class="comment">// æœ‰ mapSideCombineï¼Œå°±æ˜¯èšåˆ(K, C)</span></span><br><span class="line">    <span class="keyword">val</span> combinedKeyValuesIterator = interruptibleIter.asInstanceOf[<span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">C</span>)]]</span><br><span class="line">    dep.aggregator.get.combineCombinersByKey(combinedKeyValuesIterator, context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ—  mapSideCombineï¼Œå°±æ˜¯èšåˆ(K, V)</span></span><br><span class="line">    <span class="keyword">val</span> keyValuesIterator = interruptibleIter.asInstanceOf[<span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">Nothing</span>)]]</span><br><span class="line">    dep.aggregator.get.combineValuesByKey(keyValuesIterator, context)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ä¸èšåˆ</span></span><br><span class="line">  interruptibleIter.asInstanceOf[<span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿›è¡Œæ’åºæ“ä½œ"><a class="header-anchor" href="#è¿›è¡Œæ’åºæ“ä½œ">Â¶</a>è¿›è¡Œæ’åºæ“ä½œ</h2><p>åˆ†æ˜¯å¦éœ€è¦æ’åºã€‚å¦‚æœéœ€è¦ï¼Œå°±ä½¿ç”¨<code>ExternalSorter</code>åœ¨åˆ†åŒºå†…éƒ¨è¿›è¡Œæ’åº</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> resultIter = dep.keyOrdering <span class="keyword">match</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Some</span>(keyOrd: <span class="type">Ordering</span>[<span class="type">K</span>]) =&gt;</span><br><span class="line">    <span class="comment">// Create an ExternalSorter to sort the data.</span></span><br><span class="line">    <span class="keyword">val</span> sorter =</span><br><span class="line">      <span class="keyword">new</span> <span class="type">ExternalSorter</span>[<span class="type">K</span>, <span class="type">C</span>, <span class="type">C</span>](context, ordering = <span class="type">Some</span>(keyOrd), serializer = dep.serializer)</span><br><span class="line">    sorter.insertAll(aggregatedIter)</span><br><span class="line">    context.taskMetrics().incMemoryBytesSpilled(sorter.memoryBytesSpilled)</span><br><span class="line">    context.taskMetrics().incDiskBytesSpilled(sorter.diskBytesSpilled)</span><br><span class="line">    context.taskMetrics().incPeakExecutionMemory(sorter.peakMemoryUsedBytes)</span><br><span class="line">    <span class="comment">// Use completion callback to stop sorter if task was finished/cancelled.</span></span><br><span class="line">    context.addTaskCompletionListener[<span class="type">Unit</span>](_ =&gt; &#123;</span><br><span class="line">      sorter.stop()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="type">CompletionIterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>], <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]](sorter.iterator, sorter.stop())</span><br><span class="line">  <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">    aggregatedIter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;sparkçš„å”¯ä¸€ ShuffleReader ï¼šBlockStoreShuffleReader&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkæ‚è°ˆ-æŒ‡å®šæ–‡ä»¶åœ¨HDFSä¸­çš„å†™å…¥èŠ‚ç‚¹</title>
    <link href="http://yoursite.com/2019/12/28/spark%E6%9D%82%E8%B0%88-%E6%8C%87%E5%AE%9A%E6%96%87%E4%BB%B6%E5%9C%A8HDFS%E4%B8%AD%E7%9A%84%E5%86%99%E5%85%A5%E8%8A%82%E7%82%B9/"/>
    <id>http://yoursite.com/2019/12/28/sparkæ‚è°ˆ-æŒ‡å®šæ–‡ä»¶åœ¨HDFSä¸­çš„å†™å…¥èŠ‚ç‚¹/</id>
    <published>2019-12-28T06:52:51.000Z</published>
    <updated>2019-12-28T06:56:53.632Z</updated>
    
    <content type="html"><![CDATA[<p>é¡¹ç›®ä¸­éœ€è¦æŒ‡å®šæ–‡ä»¶å†™åˆ°HDFSçš„å…·ä½“å“ªä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡æŸ¥æ‰¾APIï¼Œæ‰¾åˆ°ä¸€ç§è§£å†³åŠæ³•ã€‚ä»¥ <code>TextOutputFormat</code> ä¸ºä¾‹æµ‹è¯•</p><a id="more"></a><h1>write</h1><p>è§‚å¯Ÿ <code>TextOutputFormat</code> é‡Œçš„ <code>write</code> æ–¹æ³•ï¼Œå®ƒä½¿ç”¨äº†<code>out.write</code>å°† record å†™å…¥ HDFSã€‚æ‰¾åˆ° <code>out</code> ï¼Œä¿®æ”¹å®ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(K key, V value)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> nullKey = key == <span class="keyword">null</span> || key <span class="keyword">instanceof</span> NullWritable;</span><br><span class="line">  <span class="keyword">boolean</span> nullValue = value == <span class="keyword">null</span> || value <span class="keyword">instanceof</span> NullWritable;</span><br><span class="line">  <span class="keyword">if</span> (nullKey &amp;&amp; nullValue) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!nullKey) &#123;</span><br><span class="line">    writeObject(key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(nullKey || nullValue)) &#123;</span><br><span class="line">    out.write(keyValueSeparator);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!nullValue) &#123;</span><br><span class="line">    writeObject(value);</span><br><span class="line">  &#125;</span><br><span class="line">  out.write(newline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>getRecordWriter</h1><p><code>out</code> æ˜¯ä¸€ä¸ª<code>DataOutputStream</code>ï¼Œå®ƒé€šè¿‡ <code>getRecordWriter</code>å¾—åˆ°çš„ã€‚</p><p>é»˜è®¤æ˜¯ç”± <code>FSDataOutputStream fileOut = fs.create(file, progress;</code> ç”Ÿæˆï¼Œä½†å®ƒæ— æ³•æŒ‡å®šèŠ‚ç‚¹ã€‚</p><p>ä½œå‡ºä¿®æ”¹ï¼š</p><p><strong>å…³é”®æ˜¯æŠŠå®ƒæ›¿æ¢æˆ <code>DistributedFileSystem</code> é‡Œçš„ <code>create</code> æ–¹æ³•ï¼Œå…¶ä¸­æœ‰ä¸ªå‚æ•°æ˜¯ <code>favoredNodes </code>ï¼Œé¡¾åæ€ä¹‰æ•°æ®å°†ä¼˜å…ˆå­˜åˆ°å®ƒæŒ‡å®šèŠ‚ç‚¹</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getRecordWriter</span></span>(ignored: <span class="type">FileSystem</span>, job: <span class="type">JobConf</span>, name: <span class="type">String</span>, progress: <span class="type">Progressable</span>): <span class="type">RecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>] = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> keyValueSeparator = job.get(<span class="string">"mapreduce.output.textoutputformat.separator"</span>, <span class="string">"\t"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> file = <span class="type">FileOutputFormat</span>.getTaskOutputPath(job, name)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°† OutputStream è½¬æˆ DistributedFileSystem</span></span><br><span class="line">  <span class="keyword">val</span> fs = file.getFileSystem(job).asInstanceOf[<span class="type">DistributedFileSystem</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> favoredNodes = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">InetSocketAddress</span>](<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿™é‡Œè‡ªå·±æŒ‡å®š</span></span><br><span class="line">  favoredNodes(<span class="number">0</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.12"</span>, <span class="number">9866</span>) <span class="comment">// è¿™ä¸ªportæ˜¯è¯¥èŠ‚ç‚¹dataNodeçš„port</span></span><br><span class="line">  favoredNodes(<span class="number">1</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.13"</span>, <span class="number">9866</span>)</span><br><span class="line">  favoredNodes(<span class="number">2</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.17"</span>, <span class="number">9866</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> fileOut: <span class="type">FSDataOutputStream</span> = fs.create(file,</span><br><span class="line">    <span class="type">FsPermission</span>.getFileDefault.applyUMask(<span class="type">FsPermission</span>.getUMask(fs.getConf)),</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    fs.getConf.getInt(<span class="type">IO_FILE_BUFFER_SIZE_KEY</span>, <span class="type">IO_FILE_BUFFER_SIZE_DEFAULT</span>),</span><br><span class="line">    fs.getDefaultReplication(file),</span><br><span class="line">    fs.getDefaultBlockSize(file),</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    favoredNodes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">new</span> <span class="type">TextOutputFormat</span>.<span class="type">LineRecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>](fileOut, keyValueSeparator)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>å®Œæ•´æµ‹è¯•ä»£ç </h1><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.spark.examples.zxyTest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.<span class="type">InetSocketAddress</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.<span class="type">CommonConfigurationKeysPublic</span>.&#123;<span class="type">IO_FILE_BUFFER_SIZE_DEFAULT</span>, <span class="type">IO_FILE_BUFFER_SIZE_KEY</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.permission.<span class="type">FsPermission</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.&#123;<span class="type">FSDataOutputStream</span>, <span class="type">FileSystem</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hdfs.<span class="type">DistributedFileSystem</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.&#123;<span class="type">IntWritable</span>, <span class="type">Text</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapred.&#123;<span class="type">FileOutputFormat</span>, <span class="type">JobConf</span>, <span class="type">RecordWriter</span>, <span class="type">TextOutputFormat</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.<span class="type">Progressable</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SparkSession</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯• æŒ‡å®š HDFS å­˜å‚¨èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FavoredNodesTest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> spark = <span class="type">SparkSession</span></span><br><span class="line">      .builder</span><br><span class="line">      .appName(<span class="string">"FavoredNodesTest"</span>)</span><br><span class="line">      .master(<span class="string">"local[*]"</span>)</span><br><span class="line">      .config(<span class="string">"spark.driver.memory"</span>, <span class="string">"2g"</span>)</span><br><span class="line">      .getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> sc = spark.sparkContext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> rdd = sc.makeRDD(<span class="type">Array</span>((<span class="string">"A"</span>, <span class="number">1</span>), (<span class="string">"B"</span>, <span class="number">2</span>), (<span class="string">"C"</span>, <span class="number">3</span>), (<span class="string">"D"</span>, <span class="number">4</span>)), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    rdd.saveAsHadoopFile(<span class="string">"hdfs://dell-r720/zxyTest/output"</span>,</span><br><span class="line">      classOf[<span class="type">Text</span>],</span><br><span class="line">      classOf[<span class="type">IntWritable</span>],</span><br><span class="line">      classOf[<span class="type">MyTextOutputFormat</span>[<span class="type">Text</span>, <span class="type">IntWritable</span>]])</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"Result has been saved"</span>)</span><br><span class="line">    spark.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTextOutputFormat</span>[<span class="type">K</span>, <span class="type">V</span>] <span class="keyword">extends</span> <span class="title">TextOutputFormat</span>[<span class="type">K</span>, <span class="type">V</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getRecordWriter</span></span>(ignored: <span class="type">FileSystem</span>, job: <span class="type">JobConf</span>, name: <span class="type">String</span>, progress: <span class="type">Progressable</span>): <span class="type">RecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> keyValueSeparator = job.get(<span class="string">"mapreduce.output.textoutputformat.separator"</span>, <span class="string">"\t"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> file = <span class="type">FileOutputFormat</span>.getTaskOutputPath(job, name)</span><br><span class="line">    <span class="keyword">val</span> fs = file.getFileSystem(job).asInstanceOf[<span class="type">DistributedFileSystem</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3 å‰¯æœ¬ä½ç½®</span></span><br><span class="line">    <span class="keyword">val</span> favoredNodes = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">InetSocketAddress</span>](<span class="number">3</span>)</span><br><span class="line">    favoredNodes(<span class="number">0</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.12"</span>, <span class="number">9866</span>) <span class="comment">// 9866æ˜¯è¯¥èŠ‚ç‚¹dataNodeçš„port</span></span><br><span class="line">    favoredNodes(<span class="number">1</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.13"</span>, <span class="number">9866</span>)</span><br><span class="line">    favoredNodes(<span class="number">2</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.17"</span>, <span class="number">9866</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileOut: <span class="type">FSDataOutputStream</span> = fs.create(file,</span><br><span class="line">      <span class="type">FsPermission</span>.getFileDefault.applyUMask(<span class="type">FsPermission</span>.getUMask(fs.getConf)),</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      fs.getConf.getInt(<span class="type">IO_FILE_BUFFER_SIZE_KEY</span>, <span class="type">IO_FILE_BUFFER_SIZE_DEFAULT</span>),</span><br><span class="line">      fs.getDefaultReplication(file),</span><br><span class="line">      fs.getDefaultBlockSize(file),</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      favoredNodes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="type">TextOutputFormat</span>.<span class="type">LineRecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>](fileOut, keyValueSeparator)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¡¹ç›®ä¸­éœ€è¦æŒ‡å®šæ–‡ä»¶å†™åˆ°HDFSçš„å…·ä½“å“ªä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡æŸ¥æ‰¾APIï¼Œæ‰¾åˆ°ä¸€ç§è§£å†³åŠæ³•ã€‚ä»¥ &lt;code&gt;TextOutputFormat&lt;/code&gt; ä¸ºä¾‹æµ‹è¯•&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="HDFS" scheme="http://yoursite.com/tags/HDFS/"/>
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·-Ansible</title>
    <link href="http://yoursite.com/2019/12/24/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7-Ansible/"/>
    <id>http://yoursite.com/2019/12/24/è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·-Ansible/</id>
    <published>2019-12-24T08:11:22.000Z</published>
    <updated>2019-12-24T08:34:27.351Z</updated>
    
    <content type="html"><![CDATA[<p>Ansible æ˜¯ä¸€ä¸ªå¼€æºçš„åŸºäº OpenSSH çš„è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†å·¥å…·ã€‚å¯ä»¥ç”¨å®ƒæ¥é…ç½®ç³»ç»Ÿã€éƒ¨ç½²è½¯ä»¶å’Œç¼–æ’æ›´é«˜çº§çš„ IT ä»»åŠ¡ï¼Œæ¯”å¦‚æŒç»­éƒ¨ç½²æˆ–é›¶åœæœºæ›´æ–°ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ Ansible åœ¨æˆç™¾ä¸Šåƒå°è®¡ç®—æœºä¸ŠåŒæ—¶æ‰§è¡ŒæŒ‡ä»¤(ä»»åŠ¡)ï¼Œè¿™æ˜¯<a href="https://ansible-tran.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><a id="more"></a><h1>é…ç½®ç»„</h1><p>Ansible å¯åŒæ—¶æ“ä½œå±äºä¸€ä¸ªç»„çš„å¤šå°ä¸»æœºï¼Œåœ¨ <code>/etc/ansible/hosts</code> ä¸­é…ç½®ç»„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/ansible/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æ³•ï¼š[ç»„å] + hostnames</span></span><br><span class="line">[spark]</span><br><span class="line">dell-r730-[1:4]</span><br><span class="line"></span><br><span class="line">[hdfs]</span><br><span class="line">dell-r730-[1:4]</span><br><span class="line">dell-r730-7</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶å¯åˆ†ä¸º <strong>ad-hoc</strong> å’Œ <strong>playbook</strong></p><h1>ad-hoc</h1><p>åœ¨å‘½ä»¤è¡Œæ•²å…¥çš„shellå‘½ä»¤ï¼Œå»æ‰§è¡Œäº›ç®€å•çš„ä»»åŠ¡ï¼š</p><p><code>ansible ç»„å -m æ¨¡å—å -a å…·ä½“æ“ä½œ [-u ç”¨æˆ·å] [--sudo] [-f 10]</code></p><ul><li><code>-m</code> æ¨¡å—å</li><li><code>-a</code> å…·ä½“æ“ä½œï¼Œ<strong>ä¸€èˆ¬æ˜¯k vç»“æ„</strong>ã€‚</li><li><code>-u</code> é»˜è®¤ä»¥å½“å‰ç”¨æˆ·çš„èº«ä»½æ‰§è¡Œå‘½ä»¤ï¼Œä¹Ÿå¯æ‰‹åŠ¨æŒ‡å®š</li><li><code>--sudo</code> é€šè¿‡ sudo å»æ‰§è¡Œå‘½ä»¤ï¼ˆ passwordless æ¨¡å¼ ï¼‰</li><li><code>-f</code> å¹¶å‘é‡</li></ul><p>ä¸‹é¢ä»‹ç»äº›å¸¸ç”¨æ¨¡å—</p><h2 id="commond-å’Œ-shell"><a class="header-anchor" href="#commond-å’Œ-shell">Â¶</a>commond å’Œ shell</h2><p><code>commond </code>æ˜¯é»˜è®¤çš„æ¨¡å—</p><p><code>commond</code> å’Œ <code>shell</code> éƒ½æ˜¯ç›´æ¥æ•²å‘½ä»¤çš„ã€‚<code>command</code> æ›´å®‰å…¨ï¼Œä½†<strong>ä¸æ”¯æŒ shell å˜é‡ï¼Œä¹Ÿä¸æ”¯æŒç®¡é“ç­‰ shell ç›¸å…³çš„ä¸œè¥¿</strong></p><p>shellä½¿ç”¨å˜é‡æ—¶ä¹Ÿå­˜åœ¨é™åˆ¶ï¼Œæ‰€ä»¥å°½é‡<strong>ä¸è¦æ•²å¤ªå¤æ‚çš„å‘½ä»¤</strong>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰“å°å½“å‰æ—¶é—´</span></span><br><span class="line">$ ansible zxy -a <span class="string">"date"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®€å•ç®¡é“å‘½ä»¤</span></span><br><span class="line">$ ansible zxy -m shell -a <span class="string">"cat /etc/hosts &gt; test.txt"</span></span><br></pre></td></tr></table></figure><h2 id="file-å’Œ-copy"><a class="header-anchor" href="#file-å’Œ-copy">Â¶</a>file å’Œ copy</h2><p><code>file</code> ç”¨äºåˆ›å»ºï¼ˆåˆ é™¤ï¼‰æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼Œä¹Ÿå¯æ›´æ”¹æ‰€æœ‰è€…æƒé™<br><code>copy</code> ç”¨ä¸å¤åˆ¶æ–‡ä»¶<br>ï¼ˆæˆ‘è§‰å¾—æœ‰ç‚¹éº»çƒ¦ï¼Œæ²¡æœ‰commndæ¥çš„å¿«ç‚¹ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼Œæ›´æ–°æ—¶é—´æˆ³ï¼‰</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testfile state=touch"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testdir state=directory"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testdir state=absent"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ  owner å®šä¹‰æ‰€æœ‰è€…ï¼Œmode å®šä¹‰ æƒé™ï¼Œrecurse å¯¹ç›®å½•é€’å½’ã€‚</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testdir state=directory owner=cluster mode=0777 recurse=true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># force=no ä¸å¼ºåˆ¶è¦†ç›–ï¼Œbackup=no ä¸å¤‡ä»½æ—§æ–‡ä»¶</span></span><br><span class="line">$ ansible zxy -m copy -a <span class="string">"src=/home/cluster/testfile dest=/home/cluster/testfile2 owner=cluster mode=0777"</span></span><br></pre></td></tr></table></figure><h2 id="synchronize"><a class="header-anchor" href="#synchronize">Â¶</a>synchronize</h2><p>æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åŒæ­¥ï¼Œæœ‰ pushï¼ˆé»˜è®¤ï¼‰å’Œ pull æ¨¡å¼ã€‚</p><p>é»˜è®¤å¯ç”¨äº†<code>archive</code>å‚æ•°ï¼Œè¯¥å‚æ•°é»˜è®¤å¼€å¯äº†recursive, links, perms, times, ownerï¼Œgroupå’Œ-Då‚æ•°ã€‚</p><p>å¯åŠ  <code>--exclude=xxx</code> å¿½ç•¥æŒ‡å®šæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible zxy -m synchronize -a <span class="string">"src=/home/cluster/testfile dest=/home/cluster/testfile"</span></span><br></pre></td></tr></table></figure><h2 id="ping"><a class="header-anchor" href="#ping">Â¶</a>ping</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible zxy -m ping</span><br></pre></td></tr></table></figure><h1>playbook</h1><p>å°†ä¸€ç³»åˆ—æœ‰åºä»»åŠ¡ä¿å­˜æˆymlæ–‡ä»¶ï¼Œæ–¹ä¾¿å¤šæ¬¡ä½¿ç”¨å’Œæœ‰åºçš„æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚</p><ul><li>æ‰§è¡Œ</li></ul><p><code>ansible-playbook playbook.yml</code></p><ul><li>æ ¼å¼</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">ç»„å</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line">    <span class="string">å˜é‡å:</span> <span class="string">å€¼</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">æè¿°ä»»åŠ¡ï¼ˆè‡ªå®šä¹‰ï¼‰</span></span><br><span class="line">    <span class="string">æ¨¡å—å:</span> <span class="string">å…·ä½“æ“ä½œ</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">xxxx</span></span><br><span class="line">    <span class="string">æ¨¡å—å:</span> <span class="string">xxxxx</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">é’©å­å(</span> <span class="string">task</span> <span class="string">ç»“æŸä¸”è¯¥</span> <span class="string">task</span> <span class="string">æœ‰æ„ä¹‰ï¼ˆæ”¹å˜äº†ä¸œè¥¿ï¼‰æ—¶è¢«è§¦å‘ï¼Œåªæ‰§è¡Œä¸€æ¬¡)</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">é’©å­å</span></span><br><span class="line">      <span class="string">æ¨¡å—å:</span> <span class="string">å…·ä½“æ“ä½œ</span></span><br></pre></td></tr></table></figure><ul><li>ä¾‹å­</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">pkg=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Ansible æ˜¯ä¸€ä¸ªå¼€æºçš„åŸºäº OpenSSH çš„è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†å·¥å…·ã€‚å¯ä»¥ç”¨å®ƒæ¥é…ç½®ç³»ç»Ÿã€éƒ¨ç½²è½¯ä»¶å’Œç¼–æ’æ›´é«˜çº§çš„ IT ä»»åŠ¡ï¼Œæ¯”å¦‚æŒç»­éƒ¨ç½²æˆ–é›¶åœæœºæ›´æ–°ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ Ansible åœ¨æˆç™¾ä¸Šåƒå°è®¡ç®—æœºä¸ŠåŒæ—¶æ‰§è¡ŒæŒ‡ä»¤(ä»»åŠ¡)ï¼Œè¿™æ˜¯&lt;a href=&quot;https://ansible-tran.readthedocs.io/en/latest/index.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Tools" scheme="http://yoursite.com/categories/Tools/"/>
    
    
      <category term="è¿ç»´" scheme="http://yoursite.com/tags/%E8%BF%90%E7%BB%B4/"/>
    
  </entry>
  
  <entry>
    <title>å¤§æ•°æ®bugè®°å½•</title>
    <link href="http://yoursite.com/2019/12/20/%E5%A4%A7%E6%95%B0%E6%8D%AEbug%E8%AE%B0%E5%BD%95/"/>
    <id>http://yoursite.com/2019/12/20/å¤§æ•°æ®bugè®°å½•/</id>
    <published>2019-12-20T03:26:05.000Z</published>
    <updated>2019-12-20T06:38:10.753Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•é‡åˆ°çš„ç®€å•bug</p><a id="more"></a><h1>201911-201912</h1><h2 id="é›†ç¾¤æ—¶é—´ä¸åŒæ­¥"><a class="header-anchor" href="#é›†ç¾¤æ—¶é—´ä¸åŒæ­¥">Â¶</a>é›†ç¾¤æ—¶é—´ä¸åŒæ­¥</h2><p><strong>é”™è¯¯è¯¦æƒ…</strong></p><p>ä½¿ç”¨ spark æ—¶ï¼Œyarn å¯åŠ¨èŠ‚ç‚¹æ—¶æŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Application application_1576029485466_0001 failed 2 times due to Error launching </span><br><span class="line">appattempt_1576029485466_0001_000002. Got exception: org.apache.hadoop.yarn.exceptions.YarnException: </span><br><span class="line">Unauthorized request to start container.</span><br><span class="line">This token is expired. current time is 1576059076270 found 1576030868681</span><br></pre></td></tr></table></figure><p><strong>è§£å†³åŠæ³•</strong></p><p>è®©æ—¶é—´åŒæ­¥</p><h2 id="unable-to-create-new-native-thread"><a class="header-anchor" href="#unable-to-create-new-native-thread">Â¶</a>unable to create new native thread</h2><p><strong>é”™è¯¯è¯¦æƒ…</strong></p><p>ä½¿ç”¨ spark æ—¶ï¼Œç¨‹åºæŠ¥é”™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">2019-12-11 11:34:58,366 INFO scheduler.DAGScheduler: ResultStage 0 (collect at SparkSharder.java:430) failed in 80.679 s due to Job aborted due to stage failure: Task 5428 in stage 0.0 failed 4 times, most recent failure: Lost task 5428.3 in stage 0.0 (TID 5440, dell-r730-4, executor 3): java.io.IOException: DestHost:destPort dell-r720:8020 , LocalHost:localPort dell-r730-4/10.0.0.14:0. Failed on local exception: java.io.IOException: Couldn&apos;t set up IO streams: java.lang.OutOfMemoryError: unable to create new native thread</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">at org.apache.hadoop.net.NetUtils.wrapWithMessage(NetUtils.java:833)</span><br><span class="line">at org.apache.hadoop.net.NetUtils.wrapException(NetUtils.java:808)</span><br><span class="line">at org.apache.hadoop.ipc.Client.getRpcResponse(Client.java:1549)</span><br><span class="line">at org.apache.hadoop.ipc.Client.call(Client.java:1491)</span><br><span class="line">at org.apache.hadoop.ipc.Client.call(Client.java:1388)</span><br><span class="line">at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:233)</span><br><span class="line">at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:118)</span><br><span class="line">at com.sun.proxy.$Proxy13.getFileInfo(Unknown Source)</span><br><span class="line">at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.getFileInfo(ClientNamenodeProtocolTranslatorPB.java:907)</span><br><span class="line">at sun.reflect.GeneratedMethodAccessor307.invoke(Unknown Source)</span><br></pre></td></tr></table></figure><p><strong>è§£å†³åŠæ³•</strong></p><p>åŸå› æ˜¯è¶…è¿‡äº†<code>unlimt -u</code>è®¾å®šçš„æœ€å¤§çº¿ç¨‹æ•°ï¼ŒæŠŠå®ƒå¢å¤§å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ limits.conf</span></span><br><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line">...</span><br><span class="line">*       soft    nofile  65536      <span class="comment"># æ–‡ä»¶æ‰“å¼€æ•°ï¼ˆä»¥å‰æ”¹çš„ï¼‰</span></span><br><span class="line">*       hard    nofile  65536</span><br><span class="line"></span><br><span class="line">*       hard    nproc     65536    <span class="comment"># çº¿ç¨‹æ•°ï¼ˆåŠ ä¸Šè¿™ä¸¤è¡Œï¼‰</span></span><br><span class="line">*       soft    nproc     65536</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰æ•ˆæœï¼Œåˆ™ç»§ç»­ä¿®æ”¹ 20-nproc.confï¼ˆå®ƒé™åˆ¶äº†çº¿ç¨‹æœ€å¤§å€¼ï¼‰</span></span><br><span class="line">$ vim /etc/security/limits.d/20-nproc.conf</span><br><span class="line"><span class="comment"># *       soft    nproc     65536  # ä¿®æ”¹å®ƒ</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è®°å½•é‡åˆ°çš„ç®€å•bug&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="bug" scheme="http://yoursite.com/tags/bug/"/>
    
  </entry>
  
  <entry>
    <title>sparkè°ƒè¯•-å¸¸ç”¨ä»£ç </title>
    <link href="http://yoursite.com/2019/12/20/spark%E8%B0%83%E8%AF%95-%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81/"/>
    <id>http://yoursite.com/2019/12/20/sparkè°ƒè¯•-å¸¸ç”¨ä»£ç /</id>
    <published>2019-12-20T03:13:34.000Z</published>
    <updated>2019-12-20T03:16:15.473Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€äº›æˆ‘ç”¨åˆ°çš„è°ƒè¯•ä»£ç </p><a id="more"></a><h1>ç»Ÿè®¡æ¯ä¸ªåˆ†åŒºçš„recordä¸ªæ•°</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Tuple2&lt;Integer, Integer&gt;&gt; numOfRecordPerPartition = javaRDD.mapPartitionsWithIndex(</span><br><span class="line">        ((Function2&lt;Integer, Iterator&lt;T&gt;, Iterator&lt;Tuple2&lt;Integer, Integer&gt;&gt;&gt;) (Index, iterator) -&gt; &#123;</span><br><span class="line">            List&lt;Tuple2&lt;Integer, Integer&gt;&gt; numOfRecord = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">int</span> totalElement = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                iterator.next();</span><br><span class="line">                totalElement++;</span><br><span class="line">            &#125;</span><br><span class="line">            numOfRecord.add(<span class="keyword">new</span> Tuple2&lt;&gt;(Index, totalElement));</span><br><span class="line">            <span class="keyword">return</span> numOfRecord.iterator();</span><br><span class="line">        &#125;), <span class="keyword">true</span>).collect();</span><br></pre></td></tr></table></figure><h1>æ”¶é›†æ¯ä¸ªåˆ†åŒºçš„ç¬¬ä¸€ä¸ªrecord</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Tuple2&lt;Integer, T&gt;&gt; firstRecordPerPartition = javaRDD.mapPartitionsWithIndex(</span><br><span class="line">        ((Function2&lt;Integer, Iterator&lt;T&gt;, Iterator&lt;Tuple2&lt;Integer, T&gt;&gt;&gt;) (Index, iterator) -&gt; &#123;</span><br><span class="line">            List&lt;Tuple2&lt;Integer, T&gt;&gt; record = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (iterator.hasNext())</span><br><span class="line">                record.add(<span class="keyword">new</span> Tuple2&lt;&gt;(Index, iterator.next()));</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                record.add(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> record.iterator();</span><br><span class="line">        &#125;), <span class="keyword">true</span>).collect();</span><br></pre></td></tr></table></figure><h1>æŸ¥çœ‹å½“å‰RDDçš„PreferredLocations</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Partition[] partitions = javaRDD.rdd().getPartitions();</span><br><span class="line">List&lt;Seq&lt;String&gt;&gt; preferredLocationsList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Partition partition : partitions) &#123;</span><br><span class="line">    preferredLocationsList.add(javaRDD.rdd().getPreferredLocations(partition));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸€äº›æˆ‘ç”¨åˆ°çš„è°ƒè¯•ä»£ç &lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>linux-å¸¸ç”¨å‘½ä»¤</title>
    <link href="http://yoursite.com/2019/12/20/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>http://yoursite.com/2019/12/20/linuxå¸¸ç”¨å‘½ä»¤/</id>
    <published>2019-12-20T02:16:07.000Z</published>
    <updated>2020-01-02T11:46:26.814Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€äº›ç”¨è¿‡çš„linuxå‘½ä»¤</p><a id="more"></a><h1>æ–‡ä»¶</h1><ol><li><strong>æŸ¥çœ‹ç›®å½•å†…å­ç›®å½•æ‰€ä½¿ç”¨çš„ç©ºé—´</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ du -h  --max-depth=1`</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>æ”¹å˜æ–‡ä»¶ï¼ˆå¤¹ï¼‰æ‹¥æœ‰è€…</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chown (-R) zxy filename</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>æ”¹å˜æ–‡ä»¶æƒé™</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod 755 filename</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>å‹ç¼©ä¸è§£å‹</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar å‹ç¼©ï¼Œ-p ä¿ç•™æƒé™ï¼Œ-z ä½¿ç”¨ gzip</span></span><br><span class="line">$ tar cvpfz /mnt/data/homeback.tgz /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># tar è§£å‹</span></span><br><span class="line">$ tar xvpfz /mnt/data/homeback.tgz -C /</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ df -h</span><br></pre></td></tr></table></figure><h1>vim</h1><table><thead><tr><th>å‘½ä»¤</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>gg</td><td>è·³è½¬åˆ°æ–‡ä»¶å¤´</td></tr><tr><td>Shift+g</td><td>è·³è½¬åˆ°æ–‡ä»¶æœ«å°¾</td></tr><tr><td>/å­—ç¬¦ä¸²</td><td>ä»å¼€å¤´æŸ¥æ‰¾ï¼Œnä¸‹ä¸€ä¸ªï¼ŒNä¸Šä¸€ä¸ª</td></tr><tr><td>?å­—ç¬¦ä¸²</td><td>ä»åº•éƒ¨æŸ¥æ‰¾</td></tr></tbody></table><h1>æœåŠ¡å™¨</h1><ol><li><strong>æ·»åŠ ç”¨æˆ·</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ adduser username</span><br><span class="line">$ passwd username</span><br><span class="line"><span class="comment"># èµ‹äºˆrootæƒé™</span></span><br><span class="line">$ vim /etc/sudoers</span><br></pre></td></tr></table></figure><ol start="2"><li><strong>å…å¯†ç™»é™†</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1</span></span><br><span class="line">$ ssh-copy-id -i ~/.ssh/id_rsa.pub zxy@10.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2</span></span><br><span class="line">$ ssh zxy@10.0.0.1 <span class="string">"cat &gt;&gt; ~/.ssh/authorized_keys"</span> &lt; ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>ä¼ è¾“æ–‡ä»¶</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æºæ–‡ä»¶ -&gt; ç›®çš„åœ°</span></span><br><span class="line">scp -r zxy@10.0.0.1:/home/zxy/filename  /Users/zxy/Desktop/</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>é…ç½®ç½‘å¡ipåœ°å€</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># (1) ä¿®æ”¹å¯¹åº”ç½‘å¡é…ç½®æ–‡ä»¶ï¼ˆcentosï¼‰</span></span><br><span class="line">$ sudo vim /etc/sysconfig/network-scripts/ifcfg-em1</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) é‡å¯ç”Ÿæ•ˆ</span></span><br><span class="line">$ sudo service network restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) æŸ¥çœ‹æ•ˆæœ</span></span><br><span class="line">$ ifconfig</span><br></pre></td></tr></table></figure><ol start="5"><li><strong>ä½¿ç”¨ nfs æœåŠ¡å™¨</strong></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è§£é‡Šï¼š</span></span><br><span class="line"><span class="comment"># /mnt/storage2/data                     ç”¨äºå…±äº«çš„ç›®å½•</span></span><br><span class="line"><span class="comment"># *                                      å®¢æˆ·ç«¯ï¼šæ‰€æœ‰ä¸»æœº</span></span><br><span class="line"><span class="comment"># rw                                     å¯è¯»å¯å†™</span></span><br><span class="line"><span class="comment"># sync                                   æ•°æ®åŒæ­¥ï¼Œæ•ˆç‡ä½ï¼Œä½†å¯ä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§</span></span><br><span class="line"><span class="comment"># no_root_squash                         è®©rootä¿æŒæƒé™ï¼Œä¹Ÿå°±æ˜¯è®©å®¢æˆ·ç«¯çš„rootç›¸å½“äºæœåŠ¡ç«¯çš„root</span></span><br><span class="line"><span class="comment"># all_squash,anonuid=1001,anongid=1001   å®¢æˆ·ç«¯å†™æ•°æ®æ—¶ï¼Œæ™®é€šç”¨æˆ·åå¼ºè½¬æˆæŒ‡å®šåå­—ï¼ˆ1001ï¼‰</span></span><br><span class="line"><span class="comment"># no_all_squash é»˜è®¤                      å®¢æˆ·ç«¯å†™æ•°æ®æ—¶ï¼Œä¿æŒç”¨æˆ·å</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) ä¿®æ”¹ exports </span></span><br><span class="line">$ sudo vim /etc/exports </span><br><span class="line"></span><br><span class="line"><span class="comment"># /mnt/storage2/data  è¯¥ç›®å½•ç»Ÿä¸€ç”¨æˆ· 1001ï¼ˆclusteré›†ç¾¤ä½¿ç”¨ï¼‰</span></span><br><span class="line">/mnt/storage2/data *(rw,sync,no_root_squash,all_squash,anonuid=1001,anongid=1001)</span><br><span class="line"><span class="comment"># /mnt/storage2/users è¯¥ç›®å½•ç”¨äºå…±äº«ï¼Œä¿æŒä¸ªäººç”¨æˆ·å</span></span><br><span class="line">/mnt/storage2/users *(rw,sync,no_root_squash)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) æœåŠ¡ç«¯ æŒ‚è½½ï¼ˆæ›´æ–°ï¼‰</span></span><br><span class="line">$ exportfs -arv</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) å®¢æˆ·ç«¯ æŒ‚è½½</span></span><br><span class="line">$ mount -t nfs storage-2:/mnt/storage2/data /home/cluster/Storage2</span><br><span class="line">$ mount -t nfs storage-2:/mnt/storage2/users /mnt/users</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) å®¢æˆ·ç«¯ å¸è½½</span></span><br><span class="line">$ umount /mnt/users</span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) æœåŠ¡ç«¯ å¸è½½</span></span><br><span class="line">$ exportfs -auv</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸€äº›ç”¨è¿‡çš„linuxå‘½ä»¤&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://yoursite.com/categories/Linux/"/>
    
    
      <category term="shell" scheme="http://yoursite.com/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>sparkæºç -shuffleä¹‹SortShuffleWriter</title>
    <link href="http://yoursite.com/2019/12/04/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BSortShuffleWriter/"/>
    <id>http://yoursite.com/2019/12/04/sparkæºç -shuffleä¹‹SortShuffleWriter/</id>
    <published>2019-12-04T06:36:32.000Z</published>
    <updated>2019-12-20T03:17:51.257Z</updated>
    
    <content type="html"><![CDATA[<p>spark ä¸‰å¤§ShuffleWriter ä¹‹ SortShuffleWriter</p><a id="more"></a><p>spark ç‰ˆæœ¬ 2.4.3</p><h1>ç‰¹ç‚¹</h1><ul><li><p>æœ€å¤§ç‰¹ç‚¹å°±æ˜¯<strong>æ”¯æŒ map-side aggregation</strong></p></li><li><p>æœ€åŸºç¡€çš„ <code>ShuffleWriter</code>ã€‚å½“å¦å¤–ä¸¤ç§ç”¨ä¸äº†æ—¶æ‰é€‰å®ƒï½</p></li></ul><h1>å¤§è‡´æµç¨‹</h1><p>é¦–å…ˆè®°ä½æœ‰3ç§æƒ…å†µï¼š<strong>å« aggregator å’Œ ordering</strong>ï¼›<strong>å« aggregator ä½†ä¸å« ordering</strong>ï¼› <strong>å‰ä¸¤ç§éƒ½ä¸å«</strong>ã€‚</p><p>ä¸ºå•¥æ²¡æœ‰åªå«orderingçš„æƒ…å†µå‘¢ï¼Ÿå› ä¸ºä¸å«aggregatorå°±ä¸åšæ’åºï¼Œæ°¸è¿œè®°ä½<strong>ShuffleWriteré˜¶æ®µçš„æ’åºåªæ˜¯ä¸ºäº†ä½¿èšåˆæ›´èˆ’æœ</strong>ï¼</p><ol><li><p><strong>é€‰æ‹© <code>sorter</code></strong>ï¼šæƒ…å†µ1å’Œ2 é€‰åŒä¸€ç§<code>sorter</code>ï¼Œæƒ…å†µ3é€‰å¦ä¸€ç§ã€‚æˆ‘æŠŠå®ƒä»¬ç§°ä¸º åˆ†æ”¯1 å’Œ åˆ†æ”¯2</p></li><li><p><strong>è¯»å–æ•°æ®</strong>ï¼šåˆ†æ”¯1æŠŠæ•°æ®è¯»è¿›<code>PartitionedAppendOnlyMap</code>ï¼ˆæŠŠåŒä¸€åˆ†åŒºkeyç›¸åŒçš„èšåˆï¼‰ï¼Œåˆ†æ”¯2æŠŠæ•°æ®è¯»è¿›<code>PartitionedPairBuffer</code>ï¼ˆç®€å•æ”¾å…¥ï¼‰</p></li><li><p><strong>æ•°æ®æ•°é‡è¾¾åˆ°é˜ˆå€¼å‘ç”Ÿspill</strong>ï¼šè¿™ä¸ªspillæ–‡ä»¶æ•´ä½“æ˜¯æŒ‰<strong>åˆ†åŒºé¡ºåº</strong>å †å çš„ã€‚ä¸åŒç‚¹æ˜¯åˆ†åŒºå†…éƒ¨æ•°æ®æƒ…å†µï¼šæƒ…å†µ1æŒ‰ ordering æ’åºï¼›æƒ…å†µ2æŒ‰ key çš„ hashå€¼ æ’åºï¼ˆè¿™ä¸ªæ’åºåªæ˜¯ä¸ºäº†æ–¹ä¾¿èšåˆï¼‰ï¼›æƒ…å†µ3 ä¸æ’åº</p></li><li><p><strong>åˆå¹¶spillæ–‡ä»¶å’Œå†…å­˜ä¸­æœªspillçš„æ–‡ä»¶ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</strong>ï¼šæƒ…å†µ1å…ˆå½’å¹¶æ’åºå†èšåˆï¼›æƒ…å†µ2åªèšåˆï¼›æƒ…å†µ3å•¥éƒ½ä¸å¹²</p></li><li><p><strong>æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶</strong></p></li><li><p><strong>å°è£…ä¿¡æ¯åˆ°<code>MapStatus</code>è¿”å›</strong></p></li></ol><p>æ€»çš„æ¥è¯´å°±æ˜¯ä¸€ä¸ª <strong>task</strong> ç”Ÿæˆä¸€ä¸ª<strong>ç”± spill æ–‡ä»¶åˆå¹¶å½¢æˆçš„ä¸”èšåˆäº†çš„å¤§æ–‡ä»¶</strong>å’Œä¸€ä¸ª<strong>ç´¢å¼•æ–‡ä»¶</strong>ã€‚</p><p>ç”±äºæƒ…å†µ2æ›´å¤æ‚ç‚¹ï¼Œä»¥æƒ…å†µ2ä¸ºç¤ºä¾‹ï¼š<br><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/shuffle/SortShuffleWriter.jpg" alt></p><h1>æºç </h1><h2 id="write-â€¦"><a class="header-anchor" href="#write-â€¦">Â¶</a>write(â€¦)</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">write</span></span>(records: <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">V</span>]]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// æµç¨‹1ï¼šæ ¹æ®æ˜¯å¦éœ€è¦ mapSideCombine é€‰æ‹©ä¸åŒçš„ sorter</span></span><br><span class="line">  sorter = <span class="keyword">if</span> (dep.mapSideCombine) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">ExternalSorter</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>](</span><br><span class="line">      context, dep.aggregator, <span class="type">Some</span>(dep.partitioner), dep.keyOrdering, dep.serializer)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// In this case we pass neither an aggregator nor an ordering to the sorter, because we don't</span></span><br><span class="line">    <span class="comment">// care whether the keys get sorted in each partition; that will be done on the reduce side</span></span><br><span class="line">    <span class="comment">// if the operation being run is sortByKey.</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ ordering = Noneï¼Œå®˜æ–¹è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œå¯¹å§</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">ExternalSorter</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">V</span>](</span><br><span class="line">      context, aggregator = <span class="type">None</span>, <span class="type">Some</span>(dep.partitioner), ordering = <span class="type">None</span>, dep.serializer)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æµç¨‹2-3ï¼šè¯»å–æ•°æ® ä¸ spill</span></span><br><span class="line">  sorter.insertAll(records)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  <span class="comment">// æ–‡ä»¶å "shuffle_" + shuffleId + "_" + mapId + "_" + reduceId + ".data"</span></span><br><span class="line">  <span class="keyword">val</span> output = shuffleBlockResolver.getDataFile(dep.shuffleId, mapId)</span><br><span class="line">  <span class="keyword">val</span> tmp = <span class="type">Utils</span>.tempFileWith(output)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æµç¨‹4: åˆå¹¶ spillæ–‡ä»¶ å’Œ å†…å­˜ä¸­æœªspillçš„æ–‡ä»¶ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</span></span><br><span class="line">    <span class="keyword">val</span> blockId = <span class="type">ShuffleBlockId</span>(dep.shuffleId, mapId, <span class="type">IndexShuffleBlockResolver</span>.<span class="type">NOOP_REDUCE_ID</span>)</span><br><span class="line">    <span class="keyword">val</span> partitionLengths = sorter.writePartitionedFile(blockId, tmp)</span><br><span class="line">    <span class="comment">// æµç¨‹5: æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶ã€‚è¿™ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå‚è€ƒ BypassMergeSortShuffleWriter ç¯‡</span></span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(dep.shuffleId, mapId, partitionLengths, tmp)</span><br><span class="line">    <span class="comment">// æµç¨‹6: å°è£…ä¿¡æ¯åˆ° MapStatus è¿”å›</span></span><br><span class="line">    mapStatus = <span class="type">MapStatus</span>(blockManager.shuffleServerId, partitionLengths)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmp.exists() &amp;&amp; !tmp.delete()) &#123;</span><br><span class="line">      logError(<span class="string">s"Error while deleting temp file <span class="subst">$&#123;tmp.getAbsolutePath&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="insertAll-â€¦"><a class="header-anchor" href="#insertAll-â€¦">Â¶</a>insertAll(â€¦)</h2><p>æµç¨‹2-3ï¼šè¯»å–æ•°æ® ä¸ spill</p><p>ä¸»è¦å…³æ³¨ <code>PartitionedAppendOnlyMap </code> å’Œ <code>PartitionedPairBuffer </code></p><ul><li><p>ç›¸åŒç‚¹ï¼šéƒ½å®ç°<code>WritablePartitionedPairCollection</code> traitã€‚å®ƒä»¬å†…éƒ¨éƒ½æ˜¯ç”¨ <code>Array</code> ï¼ˆkey0, value0, key1, value1, key2, value2â€¦ï¼‰å®ç° Map é€»è¾‘ã€‚<strong>key æ˜¯ ï¼ˆåˆ†åŒºIDï¼ŒåŸkeyï¼‰</strong></p></li><li><p>ä¸åŒç‚¹ï¼š<code>PartitionedAppendOnlyMap </code><strong>æ”¯æŒæ·»åŠ äºæ›´æ–°</strong> valueï¼šå®ƒä½¿ç”¨<code>map.changeValue((getPartition(kv._1), kv._1), update)</code> å®Œæˆæ•°æ®æ·»åŠ æˆ–è€…æ›´æ–°ï¼ˆèšåˆï¼‰ã€‚è€Œ<code>PartitionedPairBuffer </code><strong>ä»…æ”¯æŒæ·»åŠ </strong>ã€‚</p></li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertAll</span></span>(records: <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">V</span>]]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> stop combining if we find that the reduction factor isn't high</span></span><br><span class="line">  <span class="keyword">val</span> shouldCombine = aggregator.isDefined</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€‰æ‹©æ˜¯å¦ combine</span></span><br><span class="line">  <span class="keyword">if</span> (shouldCombine) &#123;</span><br><span class="line">    <span class="comment">// Combine values in-memory first using our AppendOnlyMap</span></span><br><span class="line">    <span class="keyword">val</span> mergeValue = aggregator.get.mergeValue</span><br><span class="line">    <span class="keyword">val</span> createCombiner = aggregator.get.createCombiner</span><br><span class="line">    <span class="keyword">var</span> kv: <span class="type">Product2</span>[<span class="type">K</span>, <span class="type">V</span>] = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// ä» aggregator ä¸­å–å‡º createCombiner å’Œ mergeValueï¼Œåˆ¶ä½œæˆupdateå‡½æ•°</span></span><br><span class="line">    <span class="keyword">val</span> update = (hadValue: <span class="type">Boolean</span>, oldValue: <span class="type">C</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (hadValue) mergeValue(oldValue, kv._2) <span class="keyword">else</span> createCombiner(kv._2)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (records.hasNext) &#123;</span><br><span class="line">      <span class="comment">// è®¡æ•° + 1</span></span><br><span class="line">      addElementsRead()</span><br><span class="line">      kv = records.next()</span><br><span class="line">      <span class="comment">// combine æ¨¡å¼ä½¿ç”¨ PartitionedAppendOnlyMap</span></span><br><span class="line">      map.changeValue((getPartition(kv._1), kv._1), update)</span><br><span class="line">      <span class="comment">// æµç¨‹3: spill</span></span><br><span class="line">      maybeSpillCollection(usingMap = <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Stick values into our buffer</span></span><br><span class="line">    <span class="keyword">while</span> (records.hasNext) &#123;</span><br><span class="line">      addElementsRead()</span><br><span class="line">      <span class="keyword">val</span> kv = records.next()</span><br><span class="line">      <span class="comment">// é combine æ¨¡å¼ä½¿ç”¨ PartitionedPairBuffer</span></span><br><span class="line">      buffer.insert(getPartition(kv._1), kv._1, kv._2.asInstanceOf[<span class="type">C</span>])</span><br><span class="line">      <span class="comment">// æµç¨‹3: spill</span></span><br><span class="line">      maybeSpillCollection(usingMap = <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="maybeSpill-â€¦"><a class="header-anchor" href="#maybeSpill-â€¦">Â¶</a>maybeSpill(â€¦)</h2><p>spill çš„æ¡ä»¶ï¼šå†…å­˜ç”³è¯·æ²¡æˆåŠŸ æˆ–è€… è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼<code>numElementsForceSpillThreshold</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">maybeSpill</span></span>(collection: <span class="type">C</span>, currentMemory: <span class="type">Long</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">  <span class="keyword">var</span> shouldSpill = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// å…ƒç´ ä¸ªæ•°æ˜¯32çš„æ•´æ•°å€ ä¸” å¤§äº myMemoryThreshold</span></span><br><span class="line">  <span class="keyword">if</span> (elementsRead % <span class="number">32</span> == <span class="number">0</span> &amp;&amp; currentMemory &gt;= myMemoryThreshold) &#123;</span><br><span class="line">    <span class="comment">// Claim up to double our current memory from the shuffle memory pool</span></span><br><span class="line">    <span class="keyword">val</span> amountToRequest = <span class="number">2</span> * currentMemory - myMemoryThreshold</span><br><span class="line">    <span class="comment">// ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="keyword">val</span> granted = acquireMemory(amountToRequest)</span><br><span class="line">    myMemoryThreshold += granted</span><br><span class="line">    <span class="comment">// If we were granted too little memory to grow further (either tryToAcquire returned 0,</span></span><br><span class="line">    <span class="comment">// or we already had more memory than myMemoryThreshold), spill the current collection</span></span><br><span class="line">    shouldSpill = currentMemory &gt;= myMemoryThreshold</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// spillæ¡ä»¶ï¼šä¸Šé¢çš„ç”³è¯·æ²¡æˆåŠŸ æˆ–è€…  è¾¾åˆ°é˜ˆå€¼</span></span><br><span class="line">  shouldSpill = shouldSpill || _elementsRead &gt; numElementsForceSpillThreshold</span><br><span class="line">  <span class="comment">// Actually spill</span></span><br><span class="line">  <span class="keyword">if</span> (shouldSpill) &#123;</span><br><span class="line">    _spillCount += <span class="number">1</span></span><br><span class="line">    logSpillage(currentMemory)</span><br><span class="line">    <span class="comment">// spill åœ¨è¿™é‡Œå‘ç”Ÿ</span></span><br><span class="line">    spill(collection)</span><br><span class="line">    _elementsRead = <span class="number">0</span></span><br><span class="line">    _memoryBytesSpilled += currentMemory</span><br><span class="line">    releaseMemory()</span><br><span class="line">  &#125;</span><br><span class="line">  shouldSpill</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="spill-â€¦"><a class="header-anchor" href="#spill-â€¦">Â¶</a>spill(â€¦)</h2><p>å…ˆæ’åºï¼Œåspillã€‚æ’åºæ–¹é¢ï¼Œç”±äºåˆ†æ”¯ä¸åŒï¼Œæœ‰<strong>ä¸¤ä¸ªæ’åºé€»è¾‘</strong>ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">protected</span>[<span class="keyword">this</span>] <span class="function"><span class="keyword">def</span> <span class="title">spill</span></span>(collection: <span class="type">WritablePartitionedPairCollection</span>[<span class="type">K</span>, <span class="type">C</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// æ’åº</span></span><br><span class="line">  <span class="keyword">val</span> inMemoryIterator = collection.destructiveSortedWritablePartitionedIterator(comparator)</span><br><span class="line">  <span class="comment">// spill</span></span><br><span class="line">  <span class="keyword">val</span> spillFile = spillMemoryIteratorToDisk(inMemoryIterator)</span><br><span class="line">  spills += spillFile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PartitionedAppendOnlyMap </code>çš„æ’åºé€»è¾‘ï¼š<strong>2é‡æ’åº</strong>ï¼Œå…ˆæŒ‰åˆ†åŒºIDæ’ï¼Œå†å¯¹åˆ†åŒºå†…çš„æ•°æ®æ’åºï¼ˆä¼˜å…ˆæŒ‰ ordering æ’åºï¼Œå¦åˆ™hashï¼‰</p><p>æ³¨æ„è¿™ä¸ªhashæ’åºï¼Œå­¦è¿‡javaä¸­ == å’Œ equals çš„åŒºåˆ«çš„å…„å¼Ÿåº”è¯¥çŸ¥é“ï¼Œhashcode ç›¸ç­‰ æ˜¯ ä¸¤ä¸ªå¯¹è±¡ equals çš„<strong>å¿…è¦æ¡ä»¶</strong>ã€‚è¿™é‡Œåªèƒ½ä¿è¯ hashcode ç›¸åŒçš„æ•°æ®åœ¨ä¸€èµ·ï¼Œåç»­èšåˆæ—¶ï¼Œ<strong>è¿˜éœ€ç»è¿‡æ¯”è¾ƒåæ‰èƒ½èšåˆ</strong>ï¼ˆå…ˆæ‰“ä¸ªé¢„é˜²é’ˆï¼Œåé¢æºç ä¼šè¯»åˆ°å®ƒï¼‰ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partitionKeyComparator</span></span>[<span class="type">K</span>](keyComparator: <span class="type">Comparator</span>[<span class="type">K</span>]): <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] = &#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(a: (<span class="type">Int</span>, <span class="type">K</span>), b: (<span class="type">Int</span>, <span class="type">K</span>)): <span class="type">Int</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> partitionDiff = a._1 - b._1</span><br><span class="line">      <span class="keyword">if</span> (partitionDiff != <span class="number">0</span>) &#123;</span><br><span class="line">        partitionDiff</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keyComparator.compare(a._2, b._2)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// keyComparatorï¼šæœ‰ ordering ç”¨ orderingï¼Œå¦åˆ™æŒ‰ hash æ’åºã€‚</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">val</span> keyComparator: <span class="type">Comparator</span>[<span class="type">K</span>] = ordering.getOrElse(<span class="keyword">new</span> <span class="type">Comparator</span>[<span class="type">K</span>] &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(a: <span class="type">K</span>, b: <span class="type">K</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> h1 = <span class="keyword">if</span> (a == <span class="literal">null</span>) <span class="number">0</span> <span class="keyword">else</span> a.hashCode()</span><br><span class="line">    <span class="keyword">val</span> h2 = <span class="keyword">if</span> (b == <span class="literal">null</span>) <span class="number">0</span> <span class="keyword">else</span> b.hashCode()</span><br><span class="line">    <span class="keyword">if</span> (h1 &lt; h2) <span class="number">-1</span> <span class="keyword">else</span> <span class="keyword">if</span> (h1 == h2) <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>PartitionedPairBuffer</code>çš„æ’åºé€»è¾‘ï¼šä»…<strong>æ¯”è¾ƒåˆ†åŒºID</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">partitionedDestructiveSortedIterator</span></span>(keyComparator: <span class="type">Option</span>[<span class="type">Comparator</span>[<span class="type">K</span>]])</span><br><span class="line">  : <span class="type">Iterator</span>[((<span class="type">Int</span>, <span class="type">K</span>), <span class="type">V</span>)] = &#123;</span><br><span class="line">  <span class="keyword">val</span> comparator = keyComparator.map(partitionKeyComparator).getOrElse(partitionComparator)</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Sorter</span>(<span class="keyword">new</span> <span class="type">KVArraySortDataFormat</span>[(<span class="type">Int</span>, <span class="type">K</span>), <span class="type">AnyRef</span>]).sort(data, <span class="number">0</span>, curSize, comparator)</span><br><span class="line">  iterator</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A comparator for (Int, K) pairs that orders them by only their partition ID.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partitionComparator</span></span>[<span class="type">K</span>]: <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] = <span class="keyword">new</span> <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(a: (<span class="type">Int</span>, <span class="type">K</span>), b: (<span class="type">Int</span>, <span class="type">K</span>)): <span class="type">Int</span> = &#123;</span><br><span class="line">    a._1 - b._1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="writePartitionedFile-â€¦"><a class="header-anchor" href="#writePartitionedFile-â€¦">Â¶</a>writePartitionedFile(â€¦)</h2><p>æµç¨‹4: åˆå¹¶spillæ–‡ä»¶å’Œå†…å­˜ä¸­æœªspillçš„æ–‡ä»¶ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writePartitionedFile</span></span>(</span><br><span class="line">    blockId: <span class="type">BlockId</span>,</span><br><span class="line">    outputFile: <span class="type">File</span>): <span class="type">Array</span>[<span class="type">Long</span>] = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Track location of each range in the output file</span></span><br><span class="line">  <span class="keyword">val</span> lengths = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Long</span>](numPartitions)</span><br><span class="line">  <span class="keyword">val</span> writer = blockManager.getDiskWriter(blockId, outputFile, serInstance, fileBufferSize,</span><br><span class="line">    context.taskMetrics().shuffleWriteMetrics)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¦–å…ˆçŸ¥é“ï¼šcollection.destructiveSortedWritablePartitionedIterator(comparator) ç”¨è¿™ç©æ„è·å–å†…å­˜ä¸­çš„æ•°æ®ï¼ˆæœªè¢«spillï¼‰ï¼Œåé¢å¤šæ¬¡ç”¨åˆ°å®ƒ</span></span><br><span class="line">  <span class="keyword">if</span> (spills.isEmpty) &#123;</span><br><span class="line">    <span class="comment">// Case where we only have in-memory data</span></span><br><span class="line">    <span class="comment">// åªæœ‰å†…å­˜æ–‡ä»¶ï¼Œåˆ·è¿›å†…å­˜å³å¯ï¼ˆå½“ç„¶æ’åºä»€ä¹ˆçš„è¿˜æ˜¯è¦çš„ï¼Œå’Œä¸Šä¸€æ­¥ä¸€æ ·çš„è§„åˆ™ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> collection = <span class="keyword">if</span> (aggregator.isDefined) map <span class="keyword">else</span> buffer</span><br><span class="line">    <span class="keyword">val</span> it = collection.destructiveSortedWritablePartitionedIterator(comparator)</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext) &#123;</span><br><span class="line">      <span class="keyword">val</span> partitionId = it.nextPartition()</span><br><span class="line">      <span class="keyword">while</span> (it.hasNext &amp;&amp; it.nextPartition() == partitionId) &#123;</span><br><span class="line">        it.writeNext(writer)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">val</span> segment = writer.commitAndGet()</span><br><span class="line">      <span class="comment">// è®°å½•åˆ†åŒºé•¿åº¦</span></span><br><span class="line">      lengths(partitionId) = segment.length</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå¹¶æ“ä½œåœ¨è¿™é‡Œï¼šthis.partitionedIteratorï¼Œå†…éƒ¨è°ƒç”¨ merge()</span></span><br><span class="line">    <span class="keyword">for</span> ((id, elements) &lt;- <span class="keyword">this</span>.partitionedIterator) &#123;</span><br><span class="line">      <span class="keyword">if</span> (elements.hasNext) &#123;</span><br><span class="line">        <span class="keyword">for</span> (elem &lt;- elements) &#123;</span><br><span class="line">          writer.write(elem._1, elem._2)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> segment = writer.commitAndGet()</span><br><span class="line">        lengths(id) = segment.length</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  writer.close()</span><br><span class="line">  context.taskMetrics().incMemoryBytesSpilled(memoryBytesSpilled)</span><br><span class="line">  context.taskMetrics().incDiskBytesSpilled(diskBytesSpilled)</span><br><span class="line">  context.taskMetrics().incPeakExecutionMemory(peakMemoryUsedBytes)</span><br><span class="line"></span><br><span class="line">  lengths</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="merge-â€¦"><a class="header-anchor" href="#merge-â€¦">Â¶</a>merge(â€¦)</h2><p>æŠŠ spillæ–‡ä»¶ å’Œ å†…å­˜æ–‡ä»¶ åŒåˆ†åŒºçš„æ•°æ®æ”¾åˆ°ä¸€èµ·è®¡ç®—ï¼ˆ3ç§è®¡ç®—æƒ…å†µï¼‰</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(spills: <span class="type">Seq</span>[<span class="type">SpilledFile</span>], inMemory: <span class="type">Iterator</span>[((<span class="type">Int</span>, <span class="type">K</span>), <span class="type">C</span>)])</span><br><span class="line">    : <span class="type">Iterator</span>[(<span class="type">Int</span>, <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]])] = &#123;</span><br><span class="line">  <span class="keyword">val</span> readers = spills.map(<span class="keyword">new</span> <span class="type">SpillReader</span>(_))</span><br><span class="line">  <span class="keyword">val</span> inMemBuffered = inMemory.buffered</span><br><span class="line">  (<span class="number">0</span> until numPartitions).iterator.map &#123; p =&gt;</span><br><span class="line">    <span class="comment">// å¾ˆæ˜æ˜¾è¿™å…„å¼Ÿå‡½æ•°å¼ç¼–ç¨‹å†™çš„å¾ˆ6</span></span><br><span class="line">    <span class="comment">// ä¸»è¦å°±æ˜¯æŠŠ spillæ–‡ä»¶ å’Œ å†…å­˜æ–‡ä»¶ åŒåˆ†åŒºçš„æ•°æ®æ”¾åˆ°ä¸€èµ·è®¡ç®—ï¼ˆ3ç§è®¡ç®—æƒ…å†µï¼‰ã€‚å…¶å®å’Œä»¥å‰çš„2é‡å¾ªç¯æ˜¯ä¸€ä¸ªæ„æ€</span></span><br><span class="line">    <span class="keyword">val</span> inMemIterator = <span class="keyword">new</span> <span class="type">IteratorForPartition</span>(p, inMemBuffered)</span><br><span class="line">    <span class="keyword">val</span> iterators = readers.map(_.readNextPartition()) ++ <span class="type">Seq</span>(inMemIterator)</span><br><span class="line">    <span class="keyword">if</span> (aggregator.isDefined) &#123;</span><br><span class="line">      <span class="comment">// Perform partial aggregation across partitions</span></span><br><span class="line">      <span class="comment">// èšåˆï¼šï¼ˆåˆ†æœ‰æ—  ordering ä¸¤ç§æƒ…å†µï¼‰</span></span><br><span class="line">      (p, mergeWithAggregation(</span><br><span class="line">        iterators, aggregator.get.mergeCombiners, keyComparator, ordering.isDefined))</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ordering.isDefined) &#123;</span><br><span class="line">      <span class="comment">// No aggregator given, but we have an ordering (e.g. used by reduce tasks in sortByKey);</span></span><br><span class="line">      <span class="comment">// sort the elements without trying to merge them</span></span><br><span class="line">      <span class="comment">// åªæ’åºï¼šå¯¹å®ƒä»¬è¿›è¡Œå½’å¹¶æ’åºã€‚</span></span><br><span class="line">      <span class="comment">// è¯´å®è¯ï¼Œæˆ‘ä¸è§‰å¾—å®ƒä¼šè¿›è¿™ä¸€åˆ†æ”¯ã€‚å› ä¸ºæˆ‘å¤šæ¬¡å¼ºè°ƒè¿‡æ²¡æœ‰ aggregator å°±å¿…å®šæ²¡æœ‰ ordering</span></span><br><span class="line">      (p, mergeSort(iterators, ordering.get))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å•¥éƒ½ä¸è¦ï¼Œç›´æ¥æŠŠåŒåˆ†åŒºæ–‡ä»¶ flatten</span></span><br><span class="line">      (p, iterators.iterator.flatten)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mergeWithAggregation-â€¦"><a class="header-anchor" href="#mergeWithAggregation-â€¦">Â¶</a>mergeWithAggregation(â€¦)</h2><p>èšåˆï¼šï¼ˆåˆ†æœ‰æ—  ordering ä¸¤ç§æƒ…å†µï¼‰</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">mergeWithAggregation</span></span>(</span><br><span class="line">    iterators: <span class="type">Seq</span>[<span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]],</span><br><span class="line">    mergeCombiners: (<span class="type">C</span>, <span class="type">C</span>) =&gt; <span class="type">C</span>,</span><br><span class="line">    comparator: <span class="type">Comparator</span>[<span class="type">K</span>],</span><br><span class="line">    totalOrder: <span class="type">Boolean</span>)</span><br><span class="line">    : <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (!totalOrder) &#123;</span><br><span class="line">    <span class="comment">// We only have a partial ordering, e.g. comparing the keys by hash code, which means that</span></span><br><span class="line">    <span class="comment">// multiple distinct keys might be treated as equal by the ordering. To deal with this, we</span></span><br><span class="line">    <span class="comment">// need to read all keys considered equal by the ordering at once and compare them.</span></span><br><span class="line">    <span class="comment">// æ—  ordering ï¼Œcomparator æ˜¯ hashæ¯”è¾ƒå™¨ã€‚hashå€¼ç›¸åŒçš„æ˜¯keyç›¸åŒçš„å¿…è¦æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">Iterator</span>[<span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]] &#123;</span><br><span class="line">      <span class="keyword">val</span> sorted = mergeSort(iterators, comparator).buffered</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Buffers reused across elements to decrease memory allocation</span></span><br><span class="line">      <span class="keyword">val</span> keys = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">K</span>]</span><br><span class="line">      <span class="keyword">val</span> combiners = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">C</span>]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">hasNext</span></span>: <span class="type">Boolean</span> = sorted.hasNext</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">next</span></span>(): <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] = &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NoSuchElementException</span></span><br><span class="line">        &#125;</span><br><span class="line">        keys.clear()</span><br><span class="line">        combiners.clear()</span><br><span class="line">        <span class="keyword">val</span> firstPair = sorted.next()</span><br><span class="line">        keys += firstPair._1</span><br><span class="line">        combiners += firstPair._2</span><br><span class="line">        <span class="keyword">val</span> key = firstPair._1</span><br><span class="line">        <span class="comment">// hashå€¼ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">while</span> (sorted.hasNext &amp;&amp; comparator.compare(sorted.head._1, key) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">val</span> pair = sorted.next()</span><br><span class="line">          <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">          <span class="keyword">var</span> foundKey = <span class="literal">false</span></span><br><span class="line">          <span class="keyword">while</span> (i &lt; keys.size &amp;&amp; !foundKey) &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„ == ã€‚ scala å°±æ˜¯ç”¨ == æ¯”è¾ƒå¯¹è±¡ç›¸ç­‰çš„ </span></span><br><span class="line">            <span class="keyword">if</span> (keys(i) == pair._1) &#123;</span><br><span class="line">              <span class="comment">// key ç›¸ç­‰ å°±åˆå¹¶</span></span><br><span class="line">              combiners(i) = mergeCombiners(combiners(i), pair._2)</span><br><span class="line">              foundKey = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!foundKey) &#123;</span><br><span class="line">            keys += pair._1</span><br><span class="line">            combiners += pair._2</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note that we return an iterator of elements since we could've had many keys marked</span></span><br><span class="line">        <span class="comment">// equal by the partial order; we flatten this below to get a flat iterator of (K, C).</span></span><br><span class="line">        keys.iterator.zip(combiners.iterator)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.flatMap(i =&gt; i)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// We have a total ordering, so the objects with the same key are sequential.</span></span><br><span class="line">    <span class="comment">// æœ‰ orderingï¼šå…ˆå½’å¹¶æ’åºï¼Œå†æŠŠæœ‰ç›¸åŒçš„keyçš„å…ƒç´ èšåˆå°±è¡Œäº†</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] &#123;</span><br><span class="line">      <span class="comment">// å½’å¹¶æ’åº</span></span><br><span class="line">      <span class="keyword">val</span> sorted = mergeSort(iterators, comparator).buffered</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">hasNext</span></span>: <span class="type">Boolean</span> = sorted.hasNext</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">next</span></span>(): <span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>] = &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NoSuchElementException</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> elem = sorted.next()</span><br><span class="line">        <span class="keyword">val</span> k = elem._1</span><br><span class="line">        <span class="keyword">var</span> c = elem._2</span><br><span class="line">        <span class="comment">// key ç›¸ç­‰ å°±åˆå¹¶</span></span><br><span class="line">        <span class="keyword">while</span> (sorted.hasNext &amp;&amp; sorted.head._1 == k) &#123;</span><br><span class="line">          <span class="keyword">val</span> pair = sorted.next()</span><br><span class="line">          c = mergeCombiners(c, pair._2)</span><br><span class="line">        &#125;</span><br><span class="line">        (k, c)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;spark ä¸‰å¤§ShuffleWriter ä¹‹ SortShuffleWriter&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkæºç -shuffleä¹‹UnsafeShuffleWriter</title>
    <link href="http://yoursite.com/2019/12/02/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BUnsafeShuffleWriter/"/>
    <id>http://yoursite.com/2019/12/02/sparkæºç -shuffleä¹‹UnsafeShuffleWriter/</id>
    <published>2019-12-02T01:25:06.000Z</published>
    <updated>2019-12-20T03:17:57.715Z</updated>
    
    <content type="html"><![CDATA[<p>spark ä¸‰å¤§ShuffleWriter ä¹‹ UnsafeShuffleWriter</p><a id="more"></a><p>spark ç‰ˆæœ¬ 2.4.3</p><h1>ç‰¹ç‚¹</h1><ul><li><p>å®ƒ<strong>åªé€‚ç”¨ä¸éœ€è¦ map-side aggregation</strong> çš„Shuffleæ“ä½œ</p></li><li><p>å®ƒä½¿ç”¨UnSafe APIæ“ä½œåºåˆ—åŒ–æ•°æ®ï¼Œè€Œä¸æ˜¯Javaå¯¹è±¡ï¼Œå‡å°‘äº†å†…å­˜å ç”¨åŠå› æ­¤å¯¼è‡´çš„GCè€—æ—¶(å‚è€ƒSpark å†…å­˜ç®¡ç†ä¹‹Tungsten)ï¼Œå› æ­¤ä½¿ç”¨å®ƒæ—¶éœ€è¦<strong>Serializeræ”¯æŒrelocation</strong>ã€‚</p></li><li><p><strong>reduceç«¯çš„åˆ†åŒºæ•°ç›®å°äºç­‰äº 2^24</strong> (å› ä¸ºæ’åºè¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨æ˜¯æ•°æ®æŒ‡é’ˆï¼Œå®ƒè®°å½•äº†æ•°æ®çš„åœ°å€å’Œåˆ†åŒºIDï¼Œå…¶ä¸­åˆ†åŒºIDå 24ä½)</p></li><li><p>æº¢å†™ &amp; åˆå¹¶æ—¶ä½¿ç”¨UnSafe APIç›´æ¥æ“ä½œåºåˆ—åŒ–æ•°æ®ï¼Œ<strong>åˆå¹¶æ—¶ä¸éœ€è¦ååºåˆ—åŒ–æ•°æ®</strong>ã€‚</p></li><li><p>æº¢å†™ &amp; åˆå¹¶æ—¶<strong>å¯ä»¥ä½¿ç”¨fastMergeæå‡æ•ˆç‡</strong>(è°ƒç”¨NIOçš„transferToæ–¹æ³•)</p></li></ul><h1>å¤§è‡´æµç¨‹</h1><ol><li><p>éå†æ•°æ®ï¼Œæ’å…¥åˆ°<code>ShuffleExternalSorter</code>ä¸­ã€‚è¯¥è¿‡ç¨‹å®Œæˆè®¸å¤šäº‹ï¼š<strong>å°†æ•°æ®è¯»å…¥å†…å­˜</strong> åŒæ—¶ <strong>å°†æ•°æ®æŒ‡é’ˆä¸æ–­å†™åˆ°æŒ‡é’ˆæ•°ç»„</strong>ä¸­ï¼Œå½“è¾¾åˆ°spillé˜ˆå€¼ï¼Œä½¿ç”¨<code>writeSortedFile()</code>æ’åºï¼ˆæ’åºæ’çš„æ˜¯æŒ‡é’ˆæ•°ç»„ï¼‰å¹¶spillåˆ°ç£ç›˜ã€‚</p></li><li><p><code>sorter.closeAndGetSpills()</code>ï¼šspill å†…å­˜ä¸­å‰©ä½™çš„æ–‡ä»¶ï¼Œè¿”å›æ‰€æœ‰ spill æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ˆé‡ç‚¹æ˜¯æ¯ä¸ªåˆ†åŒºçš„é•¿åº¦ï¼‰</p></li><li><p>åˆå¹¶æ‰€æœ‰ spill æ–‡ä»¶æˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼ˆæœ‰3ç§åˆå¹¶å·¥å…·é€‰æ‹©ï¼‰ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</p></li><li><p>æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶</p></li><li><p>å°è£…ä¿¡æ¯åˆ°<code>MapStatus</code>è¿”å›</p></li></ol><p>æ€»çš„æ¥è¯´å°±æ˜¯ä¸€ä¸ª <strong>task</strong> ç”Ÿæˆä¸€ä¸ª<strong>ç”± spill æ–‡ä»¶åˆå¹¶å½¢æˆçš„å¤§æ–‡ä»¶ï¼ˆè¿™ç©æ„åªæ˜¯æŒ‰åˆ†åŒºæ’å¥½ï¼Œå†…éƒ¨æ˜¯æ— åºçš„ï¼‰<strong>å’Œä¸€ä¸ª</strong>ç´¢å¼•æ–‡ä»¶</strong>ï¼ˆä¸Šé¢æµç¨‹æ˜¯ä¸»è¦æµç¨‹ï¼Œé‡å‘½åä»€ä¹ˆçš„å°±ä¸å†™äº†ï¼‰ã€‚<br><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/shuffle/UnsafeShuffleWriter.jpg" alt></p><h1>æºç </h1><h2 id="write-â€¦"><a class="header-anchor" href="#write-â€¦">Â¶</a>write(â€¦)</h2><p>è¿™ä¸ª<code>write(...)</code>æ–¹æ³•å°±æ¯”è¾ƒæ¸…çˆ½äº†ï¼Œå› ä¸ºæ­¥éª¤éƒ½å°åœ¨æ–¹æ³•é‡Œäº†</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public void write(scala.collection.<span class="type">Iterator</span>&lt;<span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt;&gt; records) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  boolean success = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (records.hasNext()) &#123;</span><br><span class="line">      <span class="comment">// å¯¹åº”æµç¨‹1</span></span><br><span class="line">      insertRecordIntoSorter(records.next());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‰©ä½™æµç¨‹</span></span><br><span class="line">    closeAndWriteOutput();</span><br><span class="line">    success = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sorter != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        sorter.cleanupResources();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">        <span class="comment">// Only throw this error if we won't be masking another</span></span><br><span class="line">        <span class="comment">// error.</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          logger.error(<span class="string">"In addition to a failure during writing, we failed during "</span> +</span><br><span class="line">                       <span class="string">"cleanup."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="insertRecordIntoSorter-â€¦"><a class="header-anchor" href="#insertRecordIntoSorter-â€¦">Â¶</a>insertRecordIntoSorter(â€¦)</h2><p>å…¶æ ¸å¿ƒæ–¹æ³•æ˜¯<code>sorter.insertRecord()</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">void insertRecordIntoSorter(<span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt; record) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert(sorter != <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">K</span> key = record._1();</span><br><span class="line">  <span class="keyword">final</span> int partitionId = partitioner.getPartition(key);</span><br><span class="line">  serBuffer.reset();</span><br><span class="line">  <span class="comment">// serOutputStream: ç”¨äºåºåˆ—åŒ–å¯¹è±¡çš„å†™å…¥çš„æµ</span></span><br><span class="line">  serOutputStream.writeKey(key, <span class="type">OBJECT_CLASS_TAG</span>);</span><br><span class="line">  serOutputStream.writeValue(record._2(), <span class="type">OBJECT_CLASS_TAG</span>);</span><br><span class="line">  serOutputStream.flush();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> int serializedRecordSize = serBuffer.size();</span><br><span class="line">  assert (serializedRecordSize &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éƒ½æ˜¯å®ƒå¹²çš„</span></span><br><span class="line">  sorter.insertRecord(</span><br><span class="line">    serBuffer.getBuf(), <span class="type">Platform</span>.<span class="type">BYTE_ARRAY_OFFSET</span>, serializedRecordSize, partitionId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sorter-insertRecord-â€¦"><a class="header-anchor" href="#sorter-insertRecord-â€¦">Â¶</a>sorter.insertRecord(â€¦)</h2><p><strong>å°†æ•°æ®è¯»å…¥å†…å­˜</strong> åŒæ—¶ <strong>å°†æ•°æ®æŒ‡é’ˆä¸æ–­å†™åˆ°æŒ‡é’ˆæ•°ç»„</strong>ä¸­ï¼Œ<strong>å½“è¾¾åˆ°spillé˜ˆå€¼ï¼Œå‘ç”Ÿ spill</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public void insertRecord(<span class="type">Object</span> recordBase, long recordOffset, int length, int partitionId)</span><br><span class="line">  <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for tests</span></span><br><span class="line">  assert(inMemSorter != <span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// å¦‚æœ Sorter å†…çš„æ•°æ®è¶…è¿‡é˜ˆå€¼ï¼Œå°±å‘ç”Ÿ spill</span></span><br><span class="line">  <span class="keyword">if</span> (inMemSorter.numRecords() &gt;= numElementsForSpillThreshold) &#123;</span><br><span class="line">    logger.info(<span class="string">"Spilling data because number of spilledRecords crossed the threshold "</span> +</span><br><span class="line">      numElementsForSpillThreshold);</span><br><span class="line">    spill();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥ inMemSorterä¸­ çš„æ•°ç»„æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°±æ‰©å®¹</span></span><br><span class="line">  growPointerArrayIfNecessary();</span><br><span class="line">  <span class="keyword">final</span> int uaoSize = <span class="type">UnsafeAlignedOffset</span>.getUaoSize();</span><br><span class="line">  <span class="comment">// Need 4 or 8 bytes to store the record length.</span></span><br><span class="line">  <span class="keyword">final</span> int required = length + uaoSize;</span><br><span class="line">  acquireNewPageIfNecessary(required);</span><br><span class="line"></span><br><span class="line">  assert(currentPage != <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Object</span> base = currentPage.getBaseObject();</span><br><span class="line">  <span class="keyword">final</span> long recordAddress = taskMemoryManager.encodePageNumberAndOffset(currentPage, pageCursor);</span><br><span class="line">  <span class="type">UnsafeAlignedOffset</span>.putSize(base, pageCursor, length);</span><br><span class="line">  pageCursor += uaoSize;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å°†æ•°æ®å†™å…¥ MemoryBlock ä¸­</span></span><br><span class="line">  <span class="type">Platform</span>.copyMemory(recordBase, recordOffset, base, pageCursor, length);</span><br><span class="line">  pageCursor += length;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å°†æ•°æ®æŒ‡é’ˆä¿¡æ¯å†™å…¥inMemSorterçš„æ•°ç»„ä¸­</span></span><br><span class="line">  inMemSorter.insertRecord(recordAddress, partitionId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="spill"><a class="header-anchor" href="#spill">Â¶</a>spill()</h2><p><code>spill()</code> çš„æ ¸å¿ƒæ˜¯<code> writeSortedFile(false)</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public long spill(long size, <span class="type">MemoryConsumer</span> trigger) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (trigger != <span class="keyword">this</span> || inMemSorter == <span class="literal">null</span> || inMemSorter.numRecords() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>L;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  logger.info(<span class="string">"Thread &#123;&#125; spilling sort data of &#123;&#125; to disk (&#123;&#125; &#123;&#125; so far)"</span>,</span><br><span class="line">    <span class="type">Thread</span>.currentThread().getId(),</span><br><span class="line">    <span class="type">Utils</span>.bytesToString(getMemoryUsage()),</span><br><span class="line">    spills.size(),</span><br><span class="line">    spills.size() &gt; <span class="number">1</span> ? <span class="string">" times"</span> : <span class="string">" time"</span>);</span><br><span class="line"></span><br><span class="line">  writeSortedFile(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">final</span> long spillSize = freeMemory();</span><br><span class="line">  <span class="comment">// spill å®Œæ•´ã€‚é‡ç½® inMemSorter</span></span><br><span class="line">  inMemSorter.reset();</span><br><span class="line">  <span class="comment">// Reset the in-memory sorter's pointer array only after freeing up the memory pages holding the</span></span><br><span class="line">  <span class="comment">// records. Otherwise, if the task is over allocated memory, then without freeing the memory</span></span><br><span class="line">  <span class="comment">// pages, we might not be able to get memory for the pointer array.</span></span><br><span class="line">  taskContext.taskMetrics().incMemoryBytesSpilled(spillSize);</span><br><span class="line">  <span class="keyword">return</span> spillSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="writeSortedFile"><a class="header-anchor" href="#writeSortedFile">Â¶</a>writeSortedFile()</h2><p>å¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œæ’åºï¼ˆæ’åºæ’çš„æ˜¯æŒ‡é’ˆæ•°ç»„ï¼‰å¹¶ å†™åˆ°ç£ç›˜</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void writeSortedFile(boolean isLastFile) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">ShuffleWriteMetrics</span> writeMetricsToUse;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isLastFile) &#123;</span><br><span class="line">    writeMetricsToUse = writeMetrics;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    writeMetricsToUse = <span class="keyword">new</span> <span class="type">ShuffleWriteMetrics</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This call performs the actual sort.</span></span><br><span class="line">  <span class="comment">// è¿­ä»£å™¨ï¼šåŒ…å«åˆ†åŒºæœ‰åºçš„æ•°æ®æŒ‡é’ˆï¼ˆæ’åºåœ¨è¿™é‡Œè¿›è¡Œï¼Œæœ‰ä¸¤ç§æ’åºæ‰‹æ®µï¼‰</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">ShuffleInMemorySorter</span>.<span class="type">ShuffleSorterIterator</span> sortedRecords =</span><br><span class="line">    inMemSorter.getSortedIterator();</span><br><span class="line">  <span class="keyword">final</span> byte[] writeBuffer = <span class="keyword">new</span> byte[diskWriteBufferSize];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–‡ä»¶åï¼štemp_shuffle_ + block_id</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">Tuple2</span>&lt;<span class="type">TempShuffleBlockId</span>, <span class="type">File</span>&gt; spilledFileInfo =</span><br><span class="line">    blockManager.diskBlockManager().createTempShuffleBlock();</span><br><span class="line">  <span class="keyword">final</span> <span class="type">File</span> file = spilledFileInfo._2();</span><br><span class="line">  <span class="keyword">final</span> <span class="type">TempShuffleBlockId</span> blockId = spilledFileInfo._1();</span><br><span class="line">  <span class="keyword">final</span> <span class="type">SpillInfo</span> spillInfo = <span class="keyword">new</span> <span class="type">SpillInfo</span>(numPartitions, file, blockId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">SerializerInstance</span> ser = <span class="type">DummySerializerInstance</span>.<span class="type">INSTANCE</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">DiskBlockObjectWriter</span> writer =</span><br><span class="line">    blockManager.getDiskWriter(blockId, file, ser, fileBufferSizeBytes, writeMetricsToUse);</span><br><span class="line"></span><br><span class="line">  int currentPartition = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">final</span> int uaoSize = <span class="type">UnsafeAlignedOffset</span>.getUaoSize();</span><br><span class="line">  <span class="keyword">while</span> (sortedRecords.hasNext()) &#123;</span><br><span class="line">    sortedRecords.loadNext();</span><br><span class="line">    <span class="keyword">final</span> int partition = sortedRecords.packedRecordPointer.getPartitionId();</span><br><span class="line">    assert (partition &gt;= currentPartition);</span><br><span class="line">    <span class="keyword">if</span> (partition != currentPartition) &#123;</span><br><span class="line">      <span class="comment">// Switch to the new partition</span></span><br><span class="line">      <span class="keyword">if</span> (currentPartition != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileSegment</span> fileSegment = writer.commitAndGet();</span><br><span class="line">        <span class="comment">// è®°å½•æ¯ä¸ªåˆ†åŒºçš„é•¿åº¦</span></span><br><span class="line">        spillInfo.partitionLengths[currentPartition] = fileSegment.length();</span><br><span class="line">      &#125;</span><br><span class="line">      currentPartition = partition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> long recordPointer = sortedRecords.packedRecordPointer.getRecordPointer();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> recordPage = taskMemoryManager.getPage(recordPointer);</span><br><span class="line">    <span class="keyword">final</span> long recordOffsetInPage = taskMemoryManager.getOffsetInPage(recordPointer);</span><br><span class="line">    int dataRemaining = <span class="type">UnsafeAlignedOffset</span>.getSize(recordPage, recordOffsetInPage);</span><br><span class="line">    long recordReadPosition = recordOffsetInPage + uaoSize; <span class="comment">// skip over record length</span></span><br><span class="line">    <span class="keyword">while</span> (dataRemaining &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> int toTransfer = <span class="type">Math</span>.min(diskWriteBufferSize, dataRemaining);</span><br><span class="line">      <span class="type">Platform</span>.copyMemory(</span><br><span class="line">        recordPage, recordReadPosition, writeBuffer, <span class="type">Platform</span>.<span class="type">BYTE_ARRAY_OFFSET</span>, toTransfer);</span><br><span class="line">      writer.write(writeBuffer, <span class="number">0</span>, toTransfer);</span><br><span class="line">      recordReadPosition += toTransfer;</span><br><span class="line">      dataRemaining -= toTransfer;</span><br><span class="line">    &#125;</span><br><span class="line">    writer.recordWritten();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">FileSegment</span> committedSegment = writer.commitAndGet();</span><br><span class="line">  writer.close();</span><br><span class="line">  <span class="keyword">if</span> (currentPartition != <span class="number">-1</span>) &#123;</span><br><span class="line">    spillInfo.partitionLengths[currentPartition] = committedSegment.length();</span><br><span class="line">    spills.add(spillInfo);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isLastFile) &#123;  <span class="comment">// i.e. this is a spill file</span></span><br><span class="line">    writeMetrics.incRecordsWritten(writeMetricsToUse.recordsWritten());</span><br><span class="line">    taskContext.taskMetrics().incDiskBytesSpilled(writeMetricsToUse.bytesWritten());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="closeAndWriteOutput"><a class="header-anchor" href="#closeAndWriteOutput">Â¶</a>closeAndWriteOutput();</h2><p>ç»ˆäºå®Œæˆäº†æµç¨‹1: <code>insertRecordIntoSorter</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">void closeAndWriteOutput() <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert(sorter != <span class="literal">null</span>);</span><br><span class="line">  updatePeakMemoryUsed();</span><br><span class="line">  serBuffer = <span class="literal">null</span>;</span><br><span class="line">  serOutputStream = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// æµç¨‹2: spill å†…å­˜ä¸­å‰©ä½™çš„æ–‡ä»¶ï¼Œè¿”å›æ‰€æœ‰ spill æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ˆé‡ç‚¹æ˜¯æ¯ä¸ªåˆ†åŒºçš„é•¿åº¦ï¼‰</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">SpillInfo</span>[] spills = sorter.closeAndGetSpills();</span><br><span class="line">  sorter = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">final</span> long[] partitionLengths;</span><br><span class="line">  <span class="comment">// æ–‡ä»¶åï¼š"shuffle_" + shuffleId + "_" + mapId + "_" + reduceId + ".data"</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">File</span> output = shuffleBlockResolver.getDataFile(shuffleId, mapId);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">File</span> tmp = <span class="type">Utils</span>.tempFileWith(output);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æµç¨‹3: åˆå¹¶ spill æ–‡ä»¶ï¼Œå¹¶è¿”å› spill æ–‡ä»¶çš„å¤§å°ï¼Œç”¨äºè®¡ç®—ç´¢å¼•æ–‡ä»¶</span></span><br><span class="line">      partitionLengths = mergeSpills(spills, tmp);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">SpillInfo</span> spill : spills) &#123;</span><br><span class="line">        <span class="keyword">if</span> (spill.file.exists() &amp;&amp; ! spill.file.delete()) &#123;</span><br><span class="line">          logger.error(<span class="string">"Error while deleting spill file &#123;&#125;"</span>, spill.file.getPath());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æµç¨‹4: ç”Ÿæˆç´¢å¼•æ–‡ä»¶ã€‚è¿™ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå‚è€ƒ BypassMergeSortShuffleWriter</span></span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(shuffleId, mapId, partitionLengths, tmp);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmp.exists() &amp;&amp; !tmp.delete()) &#123;</span><br><span class="line">      logger.error(<span class="string">"Error while deleting temp file &#123;&#125;"</span>, tmp.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  æµç¨‹<span class="number">5</span>: å°è£…ä¿¡æ¯åˆ°`<span class="type">MapStatus</span>`è¿”å›</span><br><span class="line">  mapStatus = <span class="type">MapStatus</span>$.<span class="type">MODULE</span>$.apply(blockManager.shuffleServerId(), partitionLengths);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mergeSpills-â€¦"><a class="header-anchor" href="#mergeSpills-â€¦">Â¶</a>mergeSpills(â€¦)</h3><p>åˆå¹¶ spill æ–‡ä»¶ï¼Œæœ‰3ç§åˆå¹¶æ‰‹æ®µï¼š</p><ul><li><p>å¿«åˆå¹¶ï¼š<strong>ä¸ä½¿ç”¨å‹ç¼©ï¼Œæˆ–è€…ç‰¹å®šçš„æ”¯æŒæ‹¼æ¥çš„å‹ç¼©æ ¼å¼</strong>ï¼šSnappyã€LZFã€LZ4ã€ZStd</p><ol><li><p>å½“ä½¿ç”¨nioçš„<code>transferTo</code>ä¼ è¾“ ä¸” ä¸éœ€è¦åŠ å¯†æ—¶ï¼Œä½¿ç”¨ <code>mergeSpillsWithTransferTo(spills, outputFile)</code></p></li><li><p>å¦åˆ™ä½¿ç”¨<code>mergeSpillsWithFileStream(spills, outputFile, null)</code></p></li></ol></li><li><p>æ…¢åˆå¹¶ï¼š</p><ol><li>ä½¿ç”¨<code>mergeSpillsWithFileStream(spills, outputFile, compressionCodec)</code></li></ol></li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> long[] mergeSpills(<span class="type">SpillInfo</span>[] spills, <span class="type">File</span> outputFile) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  <span class="comment">// å‹ç¼©ï¼Œä»¥åŠå‹ç¼©æ ¼å¼</span></span><br><span class="line">  <span class="keyword">final</span> boolean compressionEnabled = sparkConf.getBoolean(<span class="string">"spark.shuffle.compress"</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">CompressionCodec</span> compressionCodec = <span class="type">CompressionCodec</span>$.<span class="type">MODULE</span>$.createCodec(sparkConf);</span><br><span class="line">  <span class="keyword">final</span> boolean fastMergeEnabled =</span><br><span class="line">    sparkConf.getBoolean(<span class="string">"spark.shuffle.unsafe.fastMergeEnabled"</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// æ”¯æŒå¿«é€Ÿåˆå¹¶çš„æƒ…å†µï¼šä¸ä½¿ç”¨å‹ç¼©ï¼Œæˆ–è€…ç‰¹å®šçš„æ”¯æŒæ‹¼æ¥çš„å‹ç¼©æ ¼å¼ï¼šSnappyã€LZFã€LZ4ã€ZStd</span></span><br><span class="line">  <span class="keyword">final</span> boolean fastMergeIsSupported = !compressionEnabled ||</span><br><span class="line">    <span class="type">CompressionCodec</span>$.<span class="type">MODULE</span>$.supportsConcatenationOfSerializedStreams(compressionCodec);</span><br><span class="line">  <span class="comment">// æ˜¯å¦åŠ å¯†</span></span><br><span class="line">  <span class="keyword">final</span> boolean encryptionEnabled = blockManager.serializerManager().encryptionEnabled();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (spills.length == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">FileOutputStream</span>(outputFile).close(); <span class="comment">// Create an empty file</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> long[partitioner.numPartitions()];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (spills.length == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="type">Files</span>.move(spills[<span class="number">0</span>].file, outputFile);</span><br><span class="line">      <span class="keyword">return</span> spills[<span class="number">0</span>].partitionLengths;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> long[] partitionLengths;</span><br><span class="line">      <span class="keyword">if</span> (fastMergeEnabled &amp;&amp; fastMergeIsSupported) &#123;</span><br><span class="line">        <span class="comment">// å½“ä½¿ç”¨nioçš„transferToä¼ è¾“ ä¸” ä¸éœ€è¦åŠ å¯†æ—¶ï¼Œä½¿ç”¨ transferTo-based fast merge</span></span><br><span class="line">        <span class="keyword">if</span> (transferToEnabled &amp;&amp; !encryptionEnabled) &#123;</span><br><span class="line">          logger.debug(<span class="string">"Using transferTo-based fast merge"</span>);</span><br><span class="line">          partitionLengths = mergeSpillsWithTransferTo(spills, outputFile);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// å¦åˆ™ä½¿ç”¨ fileStream-based fast merge</span></span><br><span class="line">          logger.debug(<span class="string">"Using fileStream-based fast merge"</span>);</span><br><span class="line">          partitionLengths = mergeSpillsWithFileStream(spills, outputFile, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.debug(<span class="string">"Using slow merge"</span>);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ slow merge</span></span><br><span class="line">        partitionLengths = mergeSpillsWithFileStream(spills, outputFile, compressionCodec);</span><br><span class="line">      &#125;</span><br><span class="line">      writeMetrics.decBytesWritten(spills[spills.length - <span class="number">1</span>].file.length());</span><br><span class="line">      writeMetrics.incBytesWritten(outputFile.length());</span><br><span class="line">      <span class="keyword">return</span> partitionLengths;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (outputFile.exists() &amp;&amp; !outputFile.delete()) &#123;</span><br><span class="line">      logger.error(<span class="string">"Unable to delete output file &#123;&#125;"</span>, outputFile.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mergeSpillsWithTransferTo-â€¦"><a class="header-anchor" href="#mergeSpillsWithTransferTo-â€¦">Â¶</a>mergeSpillsWithTransferTo(â€¦)</h3><p>ç”±äºå†…éƒ¨æµç¨‹éƒ½å·®ä¸å¤šï¼Œå°±ä¸¾ä¸€ä¸ªä¸ºä¾‹ï¼Œæ ¸å¿ƒæ˜¯ä¸ª<strong>2é‡å¾ªç¯</strong>ï¼Œå°†æ‰€æœ‰spillæ–‡ä»¶ä¸­åŒä¸€åˆ†åŒºçš„æ•°æ®åˆå¹¶ï¼Œå¹¶æŒ‰åˆ†åŒºå·æ’åˆ—</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> long[] mergeSpillsWithTransferTo(<span class="type">SpillInfo</span>[] spills, <span class="type">File</span> outputFile) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert (spills.length &gt;= <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">final</span> int numPartitions = partitioner.numPartitions();</span><br><span class="line">  <span class="keyword">final</span> long[] partitionLengths = <span class="keyword">new</span> long[numPartitions];</span><br><span class="line">  <span class="keyword">final</span> <span class="type">FileChannel</span>[] spillInputChannels = <span class="keyword">new</span> <span class="type">FileChannel</span>[spills.length];</span><br><span class="line">  <span class="keyword">final</span> long[] spillInputChannelPositions = <span class="keyword">new</span> long[spills.length];</span><br><span class="line">  <span class="type">FileChannel</span> mergedFileOutputChannel = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  boolean threwException = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹æ¯ä¸ª spill æ–‡ä»¶äº§å‡ºè¾“å…¥æµ</span></span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; spills.length; i++) &#123;</span><br><span class="line">      spillInputChannels[i] = <span class="keyword">new</span> <span class="type">FileInputStream</span>(spills[i].file).getChannel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå¹¶æ–‡ä»¶ çš„è¾“å‡ºæµ</span></span><br><span class="line">    mergedFileOutputChannel = <span class="keyword">new</span> <span class="type">FileOutputStream</span>(outputFile, <span class="literal">true</span>).getChannel();</span><br><span class="line"></span><br><span class="line">    long bytesWrittenToMergedFile = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 2é‡å¾ªç¯ï¼Œç»“æœæ˜¯å°†æ‰€æœ‰spillæ–‡ä»¶ä¸­åŒä¸€åˆ†åŒºçš„æ•°æ®åˆå¹¶ï¼Œå¹¶æŒ‰åˆ†åŒºå·æ’åˆ—</span></span><br><span class="line">    <span class="keyword">for</span> (int partition = <span class="number">0</span>; partition &lt; numPartitions; partition++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; spills.length; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> long partitionLengthInSpill = spills[i].partitionLengths[partition];</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileChannel</span> spillInputChannel = spillInputChannels[i];</span><br><span class="line">        <span class="keyword">final</span> long writeStartTime = <span class="type">System</span>.nanoTime();</span><br><span class="line">        <span class="comment">// å°† spill é‡Œçš„ æŒ‡å®šåˆ†åŒºæ•°æ® å†™å…¥åˆå¹¶æ–‡ä»¶ä¸­</span></span><br><span class="line">        <span class="type">Utils</span>.copyFileStreamNIO(</span><br><span class="line">          spillInputChannel,             <span class="comment">// spill æ–‡ä»¶è¾“å…¥æµ</span></span><br><span class="line">          mergedFileOutputChannel,       <span class="comment">// åˆå¹¶æ–‡ä»¶è¾“å‡ºæµ</span></span><br><span class="line">          spillInputChannelPositions[i], <span class="comment">// spill ä¸­ è¯¥åˆ†åŒºèµ·å§‹ä½ç½®</span></span><br><span class="line">          partitionLengthInSpill);       <span class="comment">// spill ä¸­ è¯¥åˆ†åŒºé•¿åº¦</span></span><br><span class="line">        spillInputChannelPositions[i] += partitionLengthInSpill;</span><br><span class="line">        writeMetrics.incWriteTime(<span class="type">System</span>.nanoTime() - writeStartTime);</span><br><span class="line">        bytesWrittenToMergedFile += partitionLengthInSpill;</span><br><span class="line">        partitionLengths[partition] += partitionLengthInSpill; <span class="comment">// æ‰€æœ‰ spill ä¸­è¯¥åˆ†åŒºçš„æ€»é•¿åº¦</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mergedFileOutputChannel.position() != bytesWrittenToMergedFile) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(</span><br><span class="line">        <span class="string">"Current position "</span> + mergedFileOutputChannel.position() + <span class="string">" does not equal expected "</span> +</span><br><span class="line">          <span class="string">"position "</span> + bytesWrittenToMergedFile + <span class="string">" after transferTo. Please check your kernel"</span> +</span><br><span class="line">          <span class="string">" version to see if it is 2.6.32, as there is a kernel bug which will lead to "</span> +</span><br><span class="line">          <span class="string">"unexpected behavior when using transferTo. You can set spark.file.transferTo=false "</span> +</span><br><span class="line">          <span class="string">"to disable this NIO feature."</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    threwException = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; spills.length; i++) &#123;</span><br><span class="line">      assert(spillInputChannelPositions[i] == spills[i].file.length());</span><br><span class="line">      <span class="type">Closeables</span>.close(spillInputChannels[i], threwException);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Closeables</span>.close(mergedFileOutputChannel, threwException);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> partitionLengths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;spark ä¸‰å¤§ShuffleWriter ä¹‹ UnsafeShuffleWriter&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkæºç -shuffleä¹‹BypassMergeSortShuffleWriter</title>
    <link href="http://yoursite.com/2019/11/30/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BBypassMergeSortShuffleWriter/"/>
    <id>http://yoursite.com/2019/11/30/sparkæºç -shuffleä¹‹BypassMergeSortShuffleWriter/</id>
    <published>2019-11-30T10:54:59.000Z</published>
    <updated>2019-12-20T03:17:36.238Z</updated>
    
    <content type="html"><![CDATA[<p>spark ä¸‰å¤§ShuffleWriter ä¹‹ BypassMergeSortShuffleWriter</p><a id="more"></a><p>spark ç‰ˆæœ¬ 2.4.3</p><h1>ç‰¹ç‚¹</h1><ul><li><p>å®ƒ<strong>åªé€‚ç”¨ä¸éœ€è¦ map-side aggregation</strong>çš„Shuffleæ“ä½œï¼Œä¸”<strong>Reducerä»»åŠ¡æ•°é‡æ¯”è¾ƒå°‘</strong>ï¼ˆé»˜è®¤200ï¼‰</p></li><li><p>æ•°æ®æ˜¯ç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œæ•°æ®é‡è¾ƒå¤§çš„æ—¶å€™ï¼Œç½‘ç»œI/Oå’Œå†…å­˜è´Ÿæ‹…è¾ƒé‡</p></li><li><p>å†™åˆ†åŒºæ–‡ä»¶æ—¶å¼€äº†å¤šä¸ª<code>DiskBlockObjectWriter</code>ï¼Œå¯¹<strong>å†…å­˜æ¶ˆè€—æ¯”è¾ƒå¤§</strong></p></li></ul><h1>å¤§è‡´æµç¨‹</h1><ol><li><p>ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½åˆ›å»ºä¸€ä¸ª<code>DiskBlockObjectWriter</code></p></li><li><p>éå†æ•°æ®ï¼Œä½¿ç”¨<code>DiskBlockObjectWriter</code>çš„<code>write</code>æ–¹æ³•å°†æ•°æ®å†™å…¥åˆ°ä¸åŒåˆ†åŒºæ–‡ä»¶ä¸­</p></li><li><p>åˆ·å†™åˆ†åŒºæ–‡ä»¶åˆ°ç£ç›˜</p></li><li><p>åˆå¹¶åˆ†åŒºæ–‡ä»¶æˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶è¿”å›è®°å½•æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„é•¿åº¦çš„æ•°ç»„</p></li><li><p>æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶</p></li><li><p>å°è£…ä¿¡æ¯åˆ°<code>MapStatus</code>è¿”å›</p></li></ol><p>æ€»çš„æ¥è¯´å°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ª<strong>ç”±åˆ†åŒºæ–‡ä»¶åˆå¹¶å½¢æˆçš„å¤§æ–‡ä»¶</strong>å’Œä¸€ä¸ª<strong>ç´¢å¼•æ–‡ä»¶</strong>ï¼ˆä¸Šé¢æµç¨‹æ˜¯ä¸»è¦æµç¨‹ï¼Œé‡å‘½åä»€ä¹ˆçš„å°±ä¸å†™äº†ï¼‰ã€‚</p><p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/shuffle/BypassMergeSortShuffleWriter.jpg" alt></p><h1>æºç </h1><h2 id="write-â€¦"><a class="header-anchor" href="#write-â€¦">Â¶</a>write(â€¦)</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">public void write(<span class="type">Iterator</span>&lt;<span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt;&gt; records) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert (partitionWriters == <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">if</span> (!records.hasNext()) &#123;</span><br><span class="line">    partitionLengths = <span class="keyword">new</span> long[numPartitions];</span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(shuffleId, mapId, partitionLengths, <span class="literal">null</span>);</span><br><span class="line">    mapStatus = <span class="type">MapStatus</span>$.<span class="type">MODULE</span>$.apply(blockManager.shuffleServerId(), partitionLengths);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">SerializerInstance</span> serInstance = serializer.newInstance();</span><br><span class="line">  <span class="keyword">final</span> long openStartTime = <span class="type">System</span>.nanoTime();</span><br><span class="line">  <span class="comment">// partitionWriter æ•°ç»„ï¼šåˆ†åŒºå·å³æ˜¯æ•°ç»„åç§»é‡ã€‚å®ƒä»¬å°†æ•°æ®æŒ‰åˆ†åŒºå·åˆ†åˆ«å†™å…¥ä¸åŒçš„ä¸ªæ–‡ä»¶ï¼Œæœ‰å¤šå°‘ä¸ªåˆ†åŒºå°±å½¢æˆå¤šå°‘ä¸ªæ–‡ä»¶</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œçš„ numPartitions æ˜¯åˆ†åŒºåçš„æ•°é‡</span></span><br><span class="line">  partitionWriters = <span class="keyword">new</span> <span class="type">DiskBlockObjectWriter</span>[numPartitions];</span><br><span class="line">  partitionWriterSegments = <span class="keyword">new</span> <span class="type">FileSegment</span>[numPartitions];</span><br><span class="line">  <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; numPartitions; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Tuple2</span>&lt;<span class="type">TempShuffleBlockId</span>, <span class="type">File</span>&gt; tempShuffleBlockIdPlusFile =</span><br><span class="line">      blockManager.diskBlockManager().createTempShuffleBlock();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> file = tempShuffleBlockIdPlusFile._2();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">BlockId</span> blockId = tempShuffleBlockIdPlusFile._1();</span><br><span class="line">    partitionWriters[i] =</span><br><span class="line">      blockManager.getDiskWriter(blockId, file, serInstance, fileBufferSize, writeMetrics);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Creating the file to write to and creating a disk writer both involve interacting with</span></span><br><span class="line">  <span class="comment">// the disk, and can take a long time in aggregate when we open many files, so should be</span></span><br><span class="line">  <span class="comment">// included in the shuffle write time.</span></span><br><span class="line">  writeMetrics.incWriteTime(<span class="type">System</span>.nanoTime() - openStartTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (records.hasNext()) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt; record = records.next();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">K</span> key = record._1();</span><br><span class="line">    <span class="comment">// æŒ‰åˆ†åŒºå™¨çš„è§„åˆ™å†™å…¥æ•°æ®</span></span><br><span class="line">    partitionWriters[partitioner.getPartition(key)].write(key, record._2());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; numPartitions; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">DiskBlockObjectWriter</span> writer = partitionWriters[i];</span><br><span class="line">    <span class="comment">// åˆ·å†™æ•°æ®åˆ°ç£ç›˜</span></span><br><span class="line">    partitionWriterSegments[i] = writer.commitAndGet();</span><br><span class="line">    writer.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–‡ä»¶åï¼š"shuffle_" + shuffleId + "_" + mapId + "_" + reduceId + ".data"</span></span><br><span class="line">  <span class="type">File</span> output = shuffleBlockResolver.getDataFile(shuffleId, mapId);</span><br><span class="line">  <span class="type">File</span> tmp = <span class="type">Utils</span>.tempFileWith(output);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå¹¶ç”Ÿæˆçš„åˆ†åŒºæ–‡ä»¶ï¼Œå¹¶è¿”å›æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„å¤§å°ï¼Œç”¨äºè®¡ç®—åç§»é‡</span></span><br><span class="line">    partitionLengths = writePartitionedFile(tmp);</span><br><span class="line">    <span class="comment">// ç”Ÿæˆç´¢å¼•æ–‡ä»¶</span></span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(shuffleId, mapId, partitionLengths, tmp);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯ä»¥åˆ é™¤æ˜¯å› ä¸º writeIndexFileAndCommit ä¸­é‡å‘½åäº†å®ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (tmp.exists() &amp;&amp; !tmp.delete()) &#123;</span><br><span class="line">      logger.error(<span class="string">"Error while deleting temp file &#123;&#125;"</span>, tmp.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mapStatus = <span class="type">MapStatus</span>$.<span class="type">MODULE</span>$.apply(blockManager.shuffleServerId(), partitionLengths);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="writePartitionedFile-â€¦"><a class="header-anchor" href="#writePartitionedFile-â€¦">Â¶</a>writePartitionedFile(â€¦)</h2><p>åˆå¹¶ç”Ÿæˆçš„åˆ†åŒºæ–‡ä»¶ï¼Œå¹¶è¿”å›æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„å¤§å°ï¼Œç”¨äºè®¡ç®—åç§»é‡</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> long[] writePartitionedFile(<span class="type">File</span> outputFile) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  <span class="comment">// Track location of the partition starts in the output file</span></span><br><span class="line">  <span class="comment">// lengthsæ•°ç»„ï¼šè®°å½•æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„å¤§å°</span></span><br><span class="line">  <span class="keyword">final</span> long[] lengths = <span class="keyword">new</span> long[numPartitions];</span><br><span class="line">  <span class="keyword">if</span> (partitionWriters == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We were passed an empty iterator</span></span><br><span class="line">    <span class="keyword">return</span> lengths;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå¹¶æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">FileOutputStream</span> out = <span class="keyword">new</span> <span class="type">FileOutputStream</span>(outputFile, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">final</span> long writeStartTime = <span class="type">System</span>.nanoTime();</span><br><span class="line">  boolean threwException = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; numPartitions; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">File</span> file = partitionWriterSegments[i].file();</span><br><span class="line">      <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileInputStream</span> in = <span class="keyword">new</span> <span class="type">FileInputStream</span>(file);</span><br><span class="line">        boolean copyThrewException = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// æŠŠåˆ†åŒºæ–‡ä»¶ æ‹·è´åˆ° åˆå¹¶æ–‡ä»¶ ä¸­ï¼Œå­˜å…¥æ–‡ä»¶å¤§å°åˆ°lengthsæ•°ç»„ä¸­</span></span><br><span class="line">          lengths[i] = <span class="type">Utils</span>.copyStream(in, out, <span class="literal">false</span>, transferToEnabled);</span><br><span class="line">          copyThrewException = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="type">Closeables</span>.close(in, copyThrewException);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ é™¤åˆ†åŒºæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (!file.delete()) &#123;</span><br><span class="line">          logger.error(<span class="string">"Unable to delete file for partition &#123;&#125;"</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    threwException = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="type">Closeables</span>.close(out, threwException);</span><br><span class="line">    writeMetrics.incWriteTime(<span class="type">System</span>.nanoTime() - writeStartTime);</span><br><span class="line">  &#125;</span><br><span class="line">  partitionWriters = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> lengths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="writeIndexFileAndCommit-â€¦"><a class="header-anchor" href="#writeIndexFileAndCommit-â€¦">Â¶</a>writeIndexFileAndCommit(â€¦)</h2><p>ç”Ÿæˆç´¢å¼•æ–‡ä»¶</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writeIndexFileAndCommit</span></span>(</span><br><span class="line">    shuffleId: <span class="type">Int</span>,</span><br><span class="line">    mapId: <span class="type">Int</span>,</span><br><span class="line">    lengths: <span class="type">Array</span>[<span class="type">Long</span>],</span><br><span class="line">    dataTmp: <span class="type">File</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> indexFile = getIndexFile(shuffleId, mapId)</span><br><span class="line">  <span class="keyword">val</span> indexTmp = <span class="type">Utils</span>.tempFileWith(indexFile)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> dataFile = getDataFile(shuffleId, mapId)</span><br><span class="line">    <span class="comment">// There is only one IndexShuffleBlockResolver per executor, this synchronization make sure</span></span><br><span class="line">    <span class="comment">// the following check and rename are atomic.</span></span><br><span class="line">    synchronized &#123;</span><br><span class="line">      <span class="keyword">val</span> existingLengths = checkIndexAndDataFile(indexFile, dataFile, lengths.length)</span><br><span class="line">      <span class="keyword">if</span> (existingLengths != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Another attempt for the same task has already written our map outputs successfully,</span></span><br><span class="line">        <span class="comment">// so just use the existing partition lengths and delete our temporary map outputs.</span></span><br><span class="line">        <span class="type">System</span>.arraycopy(existingLengths, <span class="number">0</span>, lengths, <span class="number">0</span>, lengths.length)</span><br><span class="line">        <span class="keyword">if</span> (dataTmp != <span class="literal">null</span> &amp;&amp; dataTmp.exists()) &#123;</span><br><span class="line">          dataTmp.delete()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is the first successful attempt in writing the map outputs for this task,</span></span><br><span class="line">        <span class="comment">// so override any existing index and data files with the ones we wrote.</span></span><br><span class="line">        <span class="keyword">val</span> out = <span class="keyword">new</span> <span class="type">DataOutputStream</span>(<span class="keyword">new</span> <span class="type">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="type">FileOutputStream</span>(indexTmp)))</span><br><span class="line">        <span class="type">Utils</span>.tryWithSafeFinally &#123;</span><br><span class="line">          <span class="comment">// We take in lengths of each block, need to convert it to offsets.</span></span><br><span class="line">          <span class="comment">// ç´¢å¼•å…¶å®å°±æ˜¯æŒ‰ åˆ†åŒºæ–‡ä»¶å¤§å° å ä¸Šå»è€Œå·²</span></span><br><span class="line">          <span class="keyword">var</span> offset = <span class="number">0</span>L</span><br><span class="line">          out.writeLong(offset)</span><br><span class="line">          <span class="keyword">for</span> (length &lt;- lengths) &#123;</span><br><span class="line">            offset += length</span><br><span class="line">            out.writeLong(offset)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; &#123;</span><br><span class="line">          out.close()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (indexFile.exists()) &#123;</span><br><span class="line">          indexFile.delete()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataFile.exists()) &#123;</span><br><span class="line">          dataFile.delete()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡å‘½å indexTmp</span></span><br><span class="line">        <span class="keyword">if</span> (!indexTmp.renameTo(indexFile)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">"fail to rename file "</span> + indexTmp + <span class="string">" to "</span> + indexFile)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡å‘½å dataTmp</span></span><br><span class="line">        <span class="keyword">if</span> (dataTmp != <span class="literal">null</span> &amp;&amp; dataTmp.exists() &amp;&amp; !dataTmp.renameTo(dataFile)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">"fail to rename file "</span> + dataTmp + <span class="string">" to "</span> + dataFile)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (indexTmp.exists() &amp;&amp; !indexTmp.delete()) &#123;</span><br><span class="line">      logError(<span class="string">s"Failed to delete temporary index file at <span class="subst">$&#123;indexTmp.getAbsolutePath&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;spark ä¸‰å¤§ShuffleWriter ä¹‹ BypassMergeSortShuffleWriter&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkæºç -shuffleä¹‹ShuffleManager</title>
    <link href="http://yoursite.com/2019/11/29/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BShuffleManager/"/>
    <id>http://yoursite.com/2019/11/29/sparkæºç -shuffleä¹‹ShuffleManager/</id>
    <published>2019-11-29T06:45:04.000Z</published>
    <updated>2019-12-28T07:31:22.339Z</updated>
    
    <content type="html"><![CDATA[<p>spark shuffle å­¦ä¹ èµ·å§‹ç¯‡ï¼Œæ¶‰åŠæºç ä¸­shuffleçš„ç›¸å…³æ¦‚å¿µ åŠ  SortShuffleManager</p><a id="more"></a><p>spark ç‰ˆæœ¬ 2.4.3</p><h1>Spark é‡Œçš„ Shuffle</h1><p>shuffle ä¸»è¦åˆ†ä¸º:</p><ul><li><strong>ShuffleWrite</strong> é˜¶æ®µï¼šä¸Šä¸€ä¸ªstage çš„å°¾ä»»åŠ¡<code>ShuffleMapTask</code> æŠŠæ•°æ®å†™å…¥ç£ç›˜ï¼Œä¹Ÿå«<code>ShuffleMap</code></li><li><strong>ShuffleRead</strong> é˜¶æ®µï¼š ä¸‹ä¸€ä¸ªstage æ‹‰å–æ•°æ®ï¼Œä¹Ÿå«<code>ShuffleReduce</code></li></ul><p>æºç ä¸­çš„ä¸€äº›æ¦‚å¿µï¼š</p><ul><li><p>å¦‚æœæŠŠ spark æ•´ä¸ªæµç¨‹çœ‹æˆä¸€è¾†ç«è½¦ï¼Œé‚£ä¹ˆé™¤äº†æœ€åä¸€èŠ‚æ˜¯<code>ResultStage </code>ï¼Œå…¶å®ƒæ¯ä¸€èŠ‚è½¦å¢å°±æ˜¯ä¸€ä¸ª<code>ShuffleMapStage </code>ï¼Œè¿æ¥è½¦å¢çš„éƒ¨åˆ†å°±æ˜¯<code>shuffle</code>ã€‚</p></li><li><p>è½¦å¢å¤´è¿›è¡Œ <strong>read</strong>ï¼Œè½¦å¢å°¾è¿›è¡Œ <strong>write</strong>ã€‚å¾ˆå®¹æ˜“ç†è§£<code>ShuffleMapStage</code>éœ€è¦è¯»å‰ä¸€ä¸ªstageå†…å®¹ï¼Œä¹Ÿéœ€è¦æŠŠè¾“å‡ºå†™å…¥ä¸‹ä¸€ä¸ªstageï¼›è€Œ<code>ResultStage</code>åªéœ€è¦è¯»ã€‚è¿™äº›å¯ä»¥åœ¨æºç ä¸­å‘ç°ã€‚</p></li><li><p><code>ShuffleMapStage</code>å¯¹åº” <code>ShuffleMapTask</code>ï¼Œ<code>ResultStage</code> å¯¹åº” <code>ResultTask</code>ã€‚</p></li><li><p><strong>read</strong> å®è´¨æ˜¯<code>ShuffleReader</code>é‡Œçš„ <code>read()</code>æ–¹æ³•ï¼›<strong>write</strong> æ˜¯å®è´¨æ˜¯<code>ShuffleWriter</code>é‡Œçš„ <code>write()</code>æ–¹æ³•ã€‚</p></li><li><p><code>ShuffleReader</code> å’Œ <code>ShuffleWriter</code> è¿™ä¸¤å¤§ç»„ä»¶éƒ½ç”±<code>ShuffleManager</code>è¿›è¡Œé€‰æ‹©ã€‚</p></li></ul><p>å¥½äº†ï¼Œè„‘å­é‡Œæœ‰äº†è¿™äº›æ¦‚å¿µï¼Œå°±å¯ä»¥å¯¹è¿™3ä¸ªæ¨¡å—è¿›è¡Œä»”ç»†ç ”ç©¶äº†ã€‚</p><h1>SortShuffleManager</h1><p>ç”±äº Spark 2.0ä»¥åï¼Œ<code>ShuffleManager</code>åªæä¾›ä¸€ç§å®ç°ï¼š<code>SortShuffleManager</code>ï¼Œå› æ­¤åªæ·±å…¥ç ”ç©¶å®ƒã€‚</p><p>ä»¥ä¸‹æ˜¯<code>ShuffleMapTask</code>ä¸­çš„å†™æ“ä½œã€‚å¯ä»¥å‘ç° <code>shuffleManager</code> æ˜¯ <code>SparkEnv</code> ä¸­çš„å±æ€§ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä» SparkEnv ä¸­ å¾—åˆ° shuffleManager</span></span><br><span class="line"><span class="keyword">val</span> manager = <span class="type">SparkEnv</span>.get.shuffleManager</span><br><span class="line"><span class="comment">// ä» shuffleManager ä¸­å¾—åˆ° ShuffleWriter</span></span><br><span class="line">writer = manager.getWriter[<span class="type">Any</span>, <span class="type">Any</span>](dep.shuffleHandle, partitionId, context)</span><br><span class="line"><span class="comment">// æ‰§è¡Œ ShuffleWriter é‡Œçš„ write æ–¹æ³•</span></span><br><span class="line">writer.write(rdd.iterator(partition, context).asInstanceOf[<span class="type">Iterator</span>[_ &lt;: <span class="type">Product2</span>[<span class="type">Any</span>, <span class="type">Any</span>]]])</span><br><span class="line"><span class="comment">// æˆåŠŸå†™å…¥ï¼Œæ”¶å°¾å·¥ä½œ</span></span><br><span class="line">writer.stop(success = <span class="literal">true</span>).get</span><br></pre></td></tr></table></figure><p>è¿™é‡Œäº‹å…ˆé¢„å‘Šä¸‹ï¼Œæœ‰3ç§<code>ShuffleWriter</code>ï¼Œ1ç§<code>ShuffleReader</code>ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿæ³¨æ„ä¸Šé¢ï¼Œå®ƒå–å†³äº<code>dep.shuffleHandle</code>ï¼Œè€Œå®ƒæ¥è‡ª<code>shuffleManager</code>çš„<code>registerShuffle()</code>æ–¹æ³•ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> shuffleHandle: <span class="type">ShuffleHandle</span> = _rdd.context.env.shuffleManager.registerShuffle(</span><br><span class="line">  shuffleId, _rdd.partitions.length, <span class="keyword">this</span>)</span><br></pre></td></tr></table></figure><p>å¥½çš„ï¼Œè®©æˆ‘ä»¬è¿›å…¥<code>SortShuffleManager</code>ä¸­ä¸€æ¢ç©¶ç«Ÿã€‚</p><h2 id="registerShuffle-â€¦"><a class="header-anchor" href="#registerShuffle-â€¦">Â¶</a>registerShuffle(â€¦)</h2><p>å…¶å®å°±æ˜¯é€‰æ‹© <code>handle</code> çš„è¿‡ç¨‹</p><ol><li><p>å¦‚æœ <strong>ä¸éœ€è¦mapç«¯çš„èšåˆæ“ä½œ</strong> ä¸” <strong>shuffle åçš„åˆ†åŒºæ•°é‡å°äºç­‰äº200</strong>ï¼ˆ<code>spark.shuffle.sort.bypassMergeThreshold</code>ï¼‰ï¼Œå°±é€‰æ‹© <code>BypassMergeSortShuffleHandle</code>ã€‚å¦åˆ™è¿›å…¥ç¬¬äºŒæ­¥</p></li><li><p>å¦‚æœ <strong>åºåˆ—åŒ–å™¨æ”¯æŒé‡å®šä½</strong> ä¸” <strong>ä¸éœ€è¦mapç«¯èšåˆ</strong> ä¸” <strong>shuffle åçš„åˆ†åŒºæ•°ç›®å°äºç­‰äº2^24)</strong>ï¼Œå°±é€‰æ‹© <code>SerializedShuffleHandle</code>ã€‚å¦åˆ™è¿›å…¥ç¬¬ä¸‰æ­¥</p></li><li><p>é€‰æ‹© <code>BaseShuffleHandle</code></p></li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">registerShuffle</span></span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>](</span><br><span class="line">    shuffleId: <span class="type">Int</span>,</span><br><span class="line">    numMaps: <span class="type">Int</span>,</span><br><span class="line">    dependency: <span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>]): <span class="type">ShuffleHandle</span> = &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="type">SortShuffleWriter</span>.shouldBypassMergeSort(conf, dependency)) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">BypassMergeSortShuffleHandle</span>[<span class="type">K</span>, <span class="type">V</span>](</span><br><span class="line">      shuffleId, numMaps, dependency.asInstanceOf[<span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">V</span>]])</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">SortShuffleManager</span>.canUseSerializedShuffle(dependency)) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">SerializedShuffleHandle</span>[<span class="type">K</span>, <span class="type">V</span>](</span><br><span class="line">      shuffleId, numMaps, dependency.asInstanceOf[<span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">V</span>]])</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">BaseShuffleHandle</span>(shuffleId, numMaps, dependency)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="getWriter-â€¦"><a class="header-anchor" href="#getWriter-â€¦">Â¶</a>getWriter(â€¦)</h2><p>æ ¹æ®ä¸Šé¢å¾—åˆ°çš„<code>handle</code>ï¼Œè¿›è¡Œæ¨¡å¼åŒ¹é…é€‰æ‹©<code>ShuffleWriter</code>ï¼Œæœ‰3ç§ï¼š</p><p><code>BypassMergeSortHandle</code>  --&gt; <code>BypassMergeSortShuffleWriter</code></p><p><code>SerializedShuffleHandle</code> --&gt; <code>UnsafeShuffleWriter</code></p><p><code>other(BaseShuffleHandle)</code> --&gt; <code>SortShuffleWriter</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getWriter</span></span>[<span class="type">K</span>, <span class="type">V</span>](</span><br><span class="line">    handle: <span class="type">ShuffleHandle</span>,</span><br><span class="line">    mapId: <span class="type">Int</span>,</span><br><span class="line">    context: <span class="type">TaskContext</span>): <span class="type">ShuffleWriter</span>[<span class="type">K</span>, <span class="type">V</span>] = &#123;</span><br><span class="line">  numMapsForShuffle.putIfAbsent(</span><br><span class="line">    handle.shuffleId, handle.asInstanceOf[<span class="type">BaseShuffleHandle</span>[_, _, _]].numMaps)</span><br><span class="line">  <span class="keyword">val</span> env = <span class="type">SparkEnv</span>.get</span><br><span class="line">  handle <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> unsafeShuffleHandle: <span class="type">SerializedShuffleHandle</span>[<span class="type">K</span> <span class="meta">@unchecked</span>, <span class="type">V</span> <span class="meta">@unchecked</span>] =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">UnsafeShuffleWriter</span>(</span><br><span class="line">        env.blockManager,</span><br><span class="line">        shuffleBlockResolver.asInstanceOf[<span class="type">IndexShuffleBlockResolver</span>],</span><br><span class="line">        context.taskMemoryManager(),</span><br><span class="line">        unsafeShuffleHandle,</span><br><span class="line">        mapId,</span><br><span class="line">        context,</span><br><span class="line">        env.conf)</span><br><span class="line">    <span class="keyword">case</span> bypassMergeSortHandle: <span class="type">BypassMergeSortShuffleHandle</span>[<span class="type">K</span> <span class="meta">@unchecked</span>, <span class="type">V</span> <span class="meta">@unchecked</span>] =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">BypassMergeSortShuffleWriter</span>(</span><br><span class="line">        env.blockManager,</span><br><span class="line">        shuffleBlockResolver.asInstanceOf[<span class="type">IndexShuffleBlockResolver</span>],</span><br><span class="line">        bypassMergeSortHandle,</span><br><span class="line">        mapId,</span><br><span class="line">        context,</span><br><span class="line">        env.conf)</span><br><span class="line">    <span class="keyword">case</span> other: <span class="type">BaseShuffleHandle</span>[<span class="type">K</span> <span class="meta">@unchecked</span>, <span class="type">V</span> <span class="meta">@unchecked</span>, _] =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">SortShuffleWriter</span>(shuffleBlockResolver, other, mapId, context)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="getReader-â€¦"><a class="header-anchor" href="#getReader-â€¦">Â¶</a>getReader(â€¦)</h2><p>åªæœ‰ä¸€ç§<code>ShuffleReader</code>ï¼š<code>BlockStoreShuffleReader</code></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getReader</span></span>[<span class="type">K</span>, <span class="type">C</span>](</span><br><span class="line">    handle: <span class="type">ShuffleHandle</span>,</span><br><span class="line">    startPartition: <span class="type">Int</span>,</span><br><span class="line">    endPartition: <span class="type">Int</span>,</span><br><span class="line">    context: <span class="type">TaskContext</span>): <span class="type">ShuffleReader</span>[<span class="type">K</span>, <span class="type">C</span>] = &#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="type">BlockStoreShuffleReader</span>(</span><br><span class="line">    handle.asInstanceOf[<span class="type">BaseShuffleHandle</span>[<span class="type">K</span>, _, <span class="type">C</span>]], startPartition, endPartition, context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;spark shuffle å­¦ä¹ èµ·å§‹ç¯‡ï¼Œæ¶‰åŠæºç ä¸­shuffleçš„ç›¸å…³æ¦‚å¿µ åŠ  SortShuffleManager&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkæºç -Partitionerå­¦ä¹ </title>
    <link href="http://yoursite.com/2019/11/28/spark%E6%BA%90%E7%A0%81-Partitioner%E5%AD%A6%E4%B9%A0/"/>
    <id>http://yoursite.com/2019/11/28/sparkæºç -Partitionerå­¦ä¹ /</id>
    <published>2019-11-28T01:42:43.000Z</published>
    <updated>2019-12-20T03:17:30.074Z</updated>
    
    <content type="html"><![CDATA[<p>Partitionerï¼ˆåˆ†åŒºå™¨ï¼‰å­¦ä¹ </p><a id="more"></a><p>spark ç‰ˆæœ¬ 2.4.3</p><h1>Partitioner</h1><p>åˆ†åŒºå™¨ï¼ŒRDDäº”å¤§ç‰¹æ€§ä¹‹äº”ï¼ˆåªé’ˆå¯¹ï¼ˆk,vï¼‰ç±»å‹çš„RDDï¼‰ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ä½¿ç”¨ <code>getPartition(key: Any)</code>å¯¹æ¯æ¡æ•°æ®è¿›è¡Œåˆ†åŒº</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Partitioner</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">numPartitions</span></span>: <span class="type">Int</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getPartition</span></span>(key: <span class="type">Any</span>): <span class="type">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒæœ‰ä¸¤å¤§å®ç°ï¼Œ<code>HashPartitioner</code> å’Œ <code>RangePartitioner</code>ã€‚åˆ†åŒºæ˜¯ä¸ºäº†å¹¶è¡Œå¤„ç†ï¼Œæ‰€ä»¥è®©æ¯ä¸ªåˆ†åŒºçš„å¤§å°å·®ä¸å¤šæ˜¯é¦–è¦ç›®æ ‡ã€‚</p><h1>HashPartitioner</h1><p>è¿™ä¸ªæ˜¯æœ€ç®€å•çš„ï¼Œç›´æ¥é€šè¿‡ key çš„ hashCode å–æ¨¡åˆ†åŒºï¼Œèƒ½è®©æ•°æ®å¤§è‡´å‡åŒ€åœ°åˆ†å¸ƒåœ¨å„ä¸ªåˆ†åŒºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class HashPartitioner(partitions: Int) extends Partitioner &#123;</span><br><span class="line">  require(partitions &gt;= 0, s&quot;Number of partitions ($partitions) cannot be negative.&quot;)</span><br><span class="line"></span><br><span class="line">  def numPartitions: Int = partitions</span><br><span class="line"></span><br><span class="line">  // çœ‹è¿™é‡Œ</span><br><span class="line">  def getPartition(key: Any): Int = key match &#123;</span><br><span class="line">    case null =&gt; 0</span><br><span class="line">    case _ =&gt; Utils.nonNegativeMod(key.hashCode, numPartitions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override def equals(other: Any): Boolean = other match &#123;</span><br><span class="line">    case h: HashPartitioner =&gt;</span><br><span class="line">      h.numPartitions == numPartitions</span><br><span class="line">    case _ =&gt;</span><br><span class="line">      false</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override def hashCode: Int = numPartitions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>RangePartitioner</h1><p>æ—¢ç„¶æœ‰äº†hashåˆ†åŒºï¼Œä¸ºä»€ä¹ˆè¿˜è¦rangeåˆ†åŒºå‘¢ã€‚äº‹æƒ³éœ€è¦å…¨å±€æ’åºæ—¶ï¼Œå¦‚æœä½¿ç”¨hashåˆ†åŒºï¼Œæ’åºååªæ˜¯åˆ†åŒºæœ‰åºï¼Œç„¶åå†å¯¹åˆ†åŒºè¿›è¡Œå½’å¹¶æ’åºï¼Œè¿™æ ·å·¥ä½œé‡æ˜¯ä¸æ˜¯ç‰¹åˆ«å¤§ã€‚æ‰€ä»¥æ’åºæ—¶ä¸€èˆ¬ç”¨ <code>RangePartitioner</code> ï¼Œæ¯”å¦‚ <code>sortByKey</code>ã€‚å®ƒçš„æ•ˆæœè®©æ˜¯ä¸€ä¸ªåˆ†åŒºä¸­çš„å…ƒç´ è‚¯å®šéƒ½æ˜¯æ¯”å¦ä¸€ä¸ªåˆ†åŒºå†…çš„å…ƒç´ å°æˆ–è€…å¤§ã€‚è¿™æ ·åˆ†åŒºæ’åºåçš„æ•°æ®å°±æ˜¯å…¨å±€æœ‰åºçš„ã€‚å¹¶ä¸”å®ƒé€šè¿‡é‡‡æ ·æ“ä½œå¯ä»¥è®©æ•°æ®æ¯”è¾ƒå‡åŒ€åœ°åˆ†å¸ƒåˆ°å„ä¸ªåˆ†åŒºã€‚</p><p>å®ƒçš„å¤§è‡´æ­¥éª¤æ˜¯ï¼šå¯¹æ¯ä¸ªåˆ†åŒºè¿›è¡Œé‡‡æ ·ï¼ˆè“„æ°´æ± é‡‡æ ·ï¼‰ -&gt; åˆ¤æ–­æ¯ä¸ªåˆ†åŒºçš„é‡‡æ ·ç»“æœæ˜¯å¦åˆæ ¼ï¼Œå¦‚æœä¸åˆæ ¼å†æ¬¡é‡‡æ · -&gt; æŠŠé‡‡æ ·æ•°æ®æ’åºï¼Œæ¯æ¡é‡‡æ ·æ•°æ®éƒ½æœ‰æƒé‡ï¼ŒæŒ‰æƒé‡ï¼Œè®¡ç®—å‡ºåˆ†è§£è¾¹ç•Œæ•°ç»„<code>rangeBounds</code> -&gt; æŒ‰è¾¹ç•Œï¼ŒæŠŠæ•°æ®åˆ’åˆ†åˆ°ä¸åŒåˆ†åŒº<code>getPartition(key: Any)</code>ã€‚</p><h2 id="rangeBounds"><a class="header-anchor" href="#rangeBounds">Â¶</a>rangeBounds</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rangeBounds: <span class="type">Array</span>[<span class="type">K</span>] = &#123;</span><br><span class="line">  <span class="keyword">if</span> (partitions &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">Array</span>.empty</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// This is the sample size we need to have roughly balanced output partitions, capped at 1M.</span></span><br><span class="line">    <span class="comment">// Cast to double to avoid overflowing ints or longs</span></span><br><span class="line">    <span class="comment">// æ€»é‡‡æ ·ç‚¹çš„ä¸ªæ•°ï¼Œä¸è¶…è¿‡ 1e6ï¼Œæ³¨æ„ partitions æ˜¯åˆ†åŒºåçš„åˆ†åŒºä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">val</span> sampleSize = math.min(samplePointsPerPartitionHint.toDouble * partitions, <span class="number">1e6</span>)</span><br><span class="line">    <span class="comment">// Assume the input partitions are roughly balanced and over-sample a little bit.</span></span><br><span class="line">    <span class="comment">// æ¯ä¸ªåˆ†åŒºçš„é‡‡æ ·ç‚¹ä¸ªæ•°ï¼Œå¹¶ä¹˜äº†3è¿›è¡Œè¿‡é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">val</span> sampleSizePerPartition = math.ceil(<span class="number">3.0</span> * sampleSize / rdd.partitions.length).toInt</span><br><span class="line">    <span class="comment">// ä½¿ç”¨è“„æ°´æ± é‡‡æ ·æ³•ï¼ˆè§ä¸‹ï¼‰è¿›è¡Œé‡‡æ ·ï¼Œè¿”å›æ€»æ•°æ®ä¸ªæ•°ï¼Œå’Œæ¯ä¸ªåˆ†åŒºçš„é‡‡æ ·æƒ…å†µ(partitionId, è¯¥åˆ†åŒºæ•°æ®æ€»ä¸ªæ•°, sample)</span></span><br><span class="line">    <span class="keyword">val</span> (numItems, sketched) = <span class="type">RangePartitioner</span>.sketch(rdd.map(_._1), sampleSizePerPartition)</span><br><span class="line">    <span class="keyword">if</span> (numItems == <span class="number">0</span>L) &#123;</span><br><span class="line">      <span class="type">Array</span>.empty</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If a partition contains much more than the average number of items, we re-sample from it</span></span><br><span class="line">      <span class="comment">// to ensure that enough items are collected from that partition.</span></span><br><span class="line">      <span class="keyword">val</span> fraction = math.min(sampleSize / math.max(numItems, <span class="number">1</span>L), <span class="number">1.0</span>)</span><br><span class="line">      <span class="keyword">val</span> candidates = <span class="type">ArrayBuffer</span>.empty[(<span class="type">K</span>, <span class="type">Float</span>)]</span><br><span class="line">      <span class="keyword">val</span> imbalancedPartitions = mutable.<span class="type">Set</span>.empty[<span class="type">Int</span>]</span><br><span class="line">      sketched.foreach &#123; <span class="keyword">case</span> (idx, n, sample) =&gt;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸€ä¸ªåˆ†åŒºé‡‡æ ·è¿‡å¤šï¼Œå°±é‡æ–°é‡‡æ ·å®ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (fraction * n &gt; sampleSizePerPartition) &#123;</span><br><span class="line">          imbalancedPartitions += idx</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// The weight is 1 over the sampling probability.</span></span><br><span class="line">          <span class="comment">// æƒé‡ = è¯¥åˆ†åŒºæ•°æ®æ€»ä¸ªæ•° / é‡‡æ ·ç‚¹æ•°</span></span><br><span class="line">          <span class="keyword">val</span> weight = (n.toDouble / sample.length).toFloat</span><br><span class="line">          <span class="keyword">for</span> (key &lt;- sample) &#123;</span><br><span class="line">            candidates += ((key, weight))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (imbalancedPartitions.nonEmpty) &#123;</span><br><span class="line">        <span class="comment">// Re-sample imbalanced partitions with the desired sampling probability.</span></span><br><span class="line">        <span class="comment">// é‡æ–°é‡‡æ ·</span></span><br><span class="line">        <span class="keyword">val</span> imbalanced = <span class="keyword">new</span> <span class="type">PartitionPruningRDD</span>(rdd.map(_._1), imbalancedPartitions.contains)</span><br><span class="line">        <span class="keyword">val</span> seed = byteswap32(-rdd.id - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">val</span> reSampled = imbalanced.sample(withReplacement = <span class="literal">false</span>, fraction, seed).collect()</span><br><span class="line">        <span class="comment">// ä»¥é‡‡æ ·ç‡çš„å€’æ•°åšæƒé‡</span></span><br><span class="line">        <span class="keyword">val</span> weight = (<span class="number">1.0</span> / fraction).toFloat</span><br><span class="line">        candidates ++= reSampled.map(x =&gt; (x, weight))</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è¿”å›æ¯ä¸ªåˆ†åŒºè¾¹ç•Œæ•°æ®çš„æ•°ç»„ï¼ˆè§ä¸‹ï¼‰ï¼Œæ•°ç»„é•¿åº¦ä¸ºåˆ†åŒºä¸ªæ•° - 1 (å¾ˆå¥½ç†è§£ï¼Œåˆ‡4ä»½è¥¿ç“œï¼Œéœ€è¦3åˆ€)</span></span><br><span class="line">      <span class="type">RangePartitioner</span>.determineBounds(candidates, math.min(partitions, candidates.size))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir-Samplingï¼‰"><a class="header-anchor" href="#è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir-Samplingï¼‰">Â¶</a>è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir Samplingï¼‰</h2><ul><li>åœºæ™¯ï¼šæ•°æ®æµé•¿åº¦Nå¾ˆå¤§ä¸”ä¸å¯çŸ¥ï¼Œä¸èƒ½ä¸€æ¬¡æ€§å­˜å…¥å†…å­˜ï¼›ä¿è¯æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼›éšæœºé€‰å–kä¸ªæ•°ï¼Œæ¯ä¸ªæ•°è¢«é€‰ä¸­çš„æ¦‚ç‡ä¸º k/Nã€‚</li><li>æ­¥éª¤ï¼š<ol><li>å¦‚æœæ•°æ®æ€»é‡å°äºkï¼Œåˆ™ä¾æ¬¡æ”¾å…¥è“„æ°´æ± ã€‚æ± å­æ»¡äº†ï¼Œè¿›å…¥æ­¥éª¤2ã€‚</li><li>å½“éå†åˆ°ç¬¬iä¸ªæ•°æ®æ—¶ï¼Œåœ¨[0, i]èŒƒå›´å†…å–ä»¥éšæœºæ•°dï¼Œè‹¥dçš„è½åœ¨[0, k-1]èŒƒå›´å†…ï¼Œåˆ™ç”¨è¯¥æ•°æ®æ›¿æ¢è“„æ°´æ± ä¸­çš„ç¬¬dä¸ªæ•°æ®ã€‚</li><li>é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°éå†å®Œã€‚</li></ol></li></ul><p>æƒ³æ·±ç©¶åŸç†çš„çœ‹<a href="https://www.jianshu.com/p/7a9ea6ece2af" target="_blank" rel="noopener">è¿™ä¸ª</a>ï¼Œä¸‹é¢æ˜¯ spark ä¸­å¯¹è¯¥ç®—æ³•æ˜¯å®ç°ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sketch</span></span>[<span class="type">K</span> : <span class="type">ClassTag</span>](</span><br><span class="line">    rdd: <span class="type">RDD</span>[<span class="type">K</span>],</span><br><span class="line">    sampleSizePerPartition: <span class="type">Int</span>): (<span class="type">Long</span>, <span class="type">Array</span>[(<span class="type">Int</span>, <span class="type">Long</span>, <span class="type">Array</span>[<span class="type">K</span>])]) = &#123;</span><br><span class="line">  <span class="keyword">val</span> shift = rdd.id</span><br><span class="line">  <span class="comment">// val classTagK = classTag[K] // to avoid serializing the entire partitioner object</span></span><br><span class="line">  <span class="keyword">val</span> sketched = rdd.mapPartitionsWithIndex &#123; (idx, iter) =&gt;</span><br><span class="line">    <span class="keyword">val</span> seed = byteswap32(idx ^ (shift &lt;&lt; <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">val</span> (sample, n) = <span class="type">SamplingUtils</span>.reservoirSampleAndCount(</span><br><span class="line">      iter, sampleSizePerPartition, seed)</span><br><span class="line">    <span class="type">Iterator</span>((idx, n, sample))</span><br><span class="line">  &#125;.collect()</span><br><span class="line">  <span class="keyword">val</span> numItems = sketched.map(_._2).sum</span><br><span class="line">  (numItems, sketched)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒæ­¥éª¤æ˜¯é€šè¿‡ <code>SamplingUtils.reservoirSampleAndCount(xxx)</code> å¾—åˆ°é‡‡æ ·ç»“æœ</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reservoirSampleAndCount</span></span>[<span class="type">T</span>: <span class="type">ClassTag</span>](</span><br><span class="line">    input: <span class="type">Iterator</span>[<span class="type">T</span>],</span><br><span class="line">    k: <span class="type">Int</span>,</span><br><span class="line">    seed: <span class="type">Long</span> = <span class="type">Random</span>.nextLong())</span><br><span class="line">  : (<span class="type">Array</span>[<span class="type">T</span>], <span class="type">Long</span>) = &#123;</span><br><span class="line">  <span class="keyword">val</span> reservoir = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">T</span>](k) <span class="comment">// è£…é‡‡æ ·ç‚¹çš„è“„æ°´æ± </span></span><br><span class="line">  <span class="comment">// Put the first k elements in the reservoir.</span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt; k &amp;&amp; input.hasNext) &#123;</span><br><span class="line">    <span class="keyword">val</span> item = input.next()</span><br><span class="line">    reservoir(i) = item</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we have consumed all the elements, return them. Otherwise do the replacement.</span></span><br><span class="line">  <span class="keyword">if</span> (i &lt; k) &#123;</span><br><span class="line">    <span class="comment">// If input size &lt; k, trim the array to return only an array of input size.</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ•°æ®æ€»ä¸ªæ•°ä¸è¶³é‡‡æ ·ä¸ªæ•°ï¼Œé‚£å°±å…¨éƒ¨é‡‡æ ·äº†ï¼Œç„¶åè¿”å›</span></span><br><span class="line">    <span class="keyword">val</span> trimReservoir = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">T</span>](i)</span><br><span class="line">    <span class="type">System</span>.arraycopy(reservoir, <span class="number">0</span>, trimReservoir, <span class="number">0</span>, i)</span><br><span class="line">    (trimReservoir, i)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If input size &gt; k, continue the sampling process.</span></span><br><span class="line">    <span class="keyword">var</span> l = i.toLong</span><br><span class="line">    <span class="keyword">val</span> rand = <span class="keyword">new</span> <span class="type">XORShiftRandom</span>(seed)</span><br><span class="line">    <span class="comment">// å¯¹æ•´ä¸ª input éå†ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">while</span> (input.hasNext) &#123;</span><br><span class="line">      <span class="keyword">val</span> item = input.next()</span><br><span class="line">      l += <span class="number">1</span></span><br><span class="line">      <span class="comment">// There are k elements in the reservoir, and the l-th element has been</span></span><br><span class="line">      <span class="comment">// consumed. It should be chosen with probability k/l. The expression</span></span><br><span class="line">      <span class="comment">// below is a random long chosen uniformly from [0,l)</span></span><br><span class="line">      <span class="keyword">val</span> replacementIndex = (rand.nextDouble() * l).toLong <span class="comment">// å–[0,l)çš„éšæœºæ•°d</span></span><br><span class="line">      <span class="comment">// å¦‚æœ d åœ¨ k çš„èŒƒå›´å†…ï¼Œåˆ™ç”¨ item æ›¿æ¢æ± å­é‡Œçš„ç¬¬dä¸ªæ•°æ®ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (replacementIndex &lt; k) &#123;</span><br><span class="line">        reservoir(replacementIndex.toInt) = item</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    (reservoir, l)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŒ‰æƒé‡é€‰æ‹©è¾¹ç•Œ"><a class="header-anchor" href="#æŒ‰æƒé‡é€‰æ‹©è¾¹ç•Œ">Â¶</a>æŒ‰æƒé‡é€‰æ‹©è¾¹ç•Œ</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Determines the bounds for range partitioning from candidates with weights indicating how many</span></span><br><span class="line"><span class="comment">  * items each represents. Usually this is 1 over the probability used to sample this candidate.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param candidates unordered candidates with weights</span></span><br><span class="line"><span class="comment">  * @param partitions number of partitions</span></span><br><span class="line"><span class="comment">  * @return selected bounds</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">determineBounds</span></span>[<span class="type">K</span> : <span class="type">Ordering</span> : <span class="type">ClassTag</span>](</span><br><span class="line">     candidates: <span class="type">ArrayBuffer</span>[(<span class="type">K</span>, <span class="type">Float</span>)],</span><br><span class="line">     partitions: <span class="type">Int</span>): <span class="type">Array</span>[<span class="type">K</span>] = &#123;</span><br><span class="line">   <span class="keyword">val</span> ordering = implicitly[<span class="type">Ordering</span>[<span class="type">K</span>]]</span><br><span class="line">   <span class="keyword">val</span> ordered = candidates.sortBy(_._1) <span class="comment">// æŠŠé‡‡æ ·ç‚¹æ’å¥½åº</span></span><br><span class="line">   <span class="keyword">val</span> numCandidates = ordered.size</span><br><span class="line">   <span class="keyword">val</span> sumWeights = ordered.map(_._2.toDouble).sum</span><br><span class="line">   <span class="keyword">val</span> step = sumWeights / partitions</span><br><span class="line">   <span class="keyword">var</span> cumWeight = <span class="number">0.0</span></span><br><span class="line">   <span class="keyword">var</span> target = step</span><br><span class="line">   <span class="keyword">val</span> bounds = <span class="type">ArrayBuffer</span>.empty[<span class="type">K</span>]</span><br><span class="line">   <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">   <span class="keyword">var</span> j = <span class="number">0</span></span><br><span class="line">   <span class="keyword">var</span> previousBound = <span class="type">Option</span>.empty[<span class="type">K</span>]</span><br><span class="line">   <span class="keyword">while</span> ((i &lt; numCandidates) &amp;&amp; (j &lt; partitions - <span class="number">1</span>)) &#123;</span><br><span class="line">     <span class="keyword">val</span> (key, weight) = ordered(i)</span><br><span class="line">     cumWeight += weight</span><br><span class="line">     <span class="keyword">if</span> (cumWeight &gt;= target) &#123;</span><br><span class="line">       <span class="comment">// Skip duplicate values.</span></span><br><span class="line">       <span class="keyword">if</span> (previousBound.isEmpty || ordering.gt(key, previousBound.get)) &#123;</span><br><span class="line">         bounds += key</span><br><span class="line">         target += step</span><br><span class="line">         j += <span class="number">1</span></span><br><span class="line">         previousBound = <span class="type">Some</span>(key)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     i += <span class="number">1</span></span><br><span class="line">   &#125;</span><br><span class="line">   bounds.toArray</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h2 id="getPartition-key-Any"><a class="header-anchor" href="#getPartition-key-Any">Â¶</a>getPartition(key: Any)</h2><p>æœ‰äº†è¾¹ç•Œï¼Œ<code>getPartition(key: Any)</code>å°±å¾ˆå¥½è®¡ç®—äº†ï¼Œå…¶å®å°±æ˜¯ä¸ªåœ¨æœ‰åºåŒºé—´æ‰¾ä½ç½®çš„è¿‡ç¨‹ã€‚åˆ†åŒºå°‘å°±ä¸€ä¸ªä¸ªæ¯”è¿‡å»ï¼Œå¦‚æœåŒºé—´æ•°å¤§äº128ï¼Œå°±ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾è·å–åˆ†åŒºä½ç½®ã€‚</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPartition</span></span>(key: <span class="type">Any</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> k = key.asInstanceOf[<span class="type">K</span>]</span><br><span class="line">  <span class="keyword">var</span> partition = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (rangeBounds.length &lt;= <span class="number">128</span>) &#123;</span><br><span class="line">    <span class="comment">// If we have less than 128 partitions naive search</span></span><br><span class="line">    <span class="keyword">while</span> (partition &lt; rangeBounds.length &amp;&amp; ordering.gt(k, rangeBounds(partition))) &#123;</span><br><span class="line">      partition += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">    partition = binarySearch(rangeBounds, k)</span><br><span class="line">    <span class="comment">// binarySearch either returns the match location or -[insertion point]-1</span></span><br><span class="line">    <span class="keyword">if</span> (partition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      partition = -partition<span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (partition &gt; rangeBounds.length) &#123;</span><br><span class="line">      partition = rangeBounds.length</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ ¹æ®å‡åºè¿˜æ˜¯é™åºï¼Œè¿”å›ç›¸åº”çš„PartitionIdã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (ascending) &#123;</span><br><span class="line">    partition</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rangeBounds.length - partition</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Partitionerï¼ˆåˆ†åŒºå™¨ï¼‰å­¦ä¹ &lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>sparkæ‚è°ˆ-ä½¿ç”¨textFileè¯»å–HDFSçš„åˆ†åŒºè§„åˆ™</title>
    <link href="http://yoursite.com/2019/11/27/spark%E6%9D%82%E8%B0%88-%E4%BD%BF%E7%94%A8textFile%E8%AF%BB%E5%8F%96HDFS%E7%9A%84%E5%88%86%E5%8C%BA%E8%A7%84%E5%88%99/"/>
    <id>http://yoursite.com/2019/11/27/sparkæ‚è°ˆ-ä½¿ç”¨textFileè¯»å–HDFSçš„åˆ†åŒºè§„åˆ™/</id>
    <published>2019-11-27T06:43:54.000Z</published>
    <updated>2019-12-20T03:18:10.428Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨ textFile è¯»å–HDFSçš„æ•°æ®åˆ†åŒºè§„åˆ™</p><a id="more"></a><p>spark ç‰ˆæœ¬ 2.4.3</p><h1>è·Ÿç€æºç èµ°</h1><p>æµ‹è¯•æ–‡ä»¶ï¼šå¤§å° 516.06 MB ï¼Œ54ä¸ª blockï¼ŒblockSize å¤§å°æ˜¯128Mï¼Œä½†æ¯ä¸ª block é‡Œé¢çš„æ•°æ®åªæœ‰10M å·¦å³</p><p><strong>1. è¿›å…¥ <code>sc.textFile()</code></strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> textFile: <span class="type">RDD</span>[<span class="type">String</span>] = sc.textFile(<span class="string">"hdfs://xxxx"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// textFile() æœ‰ä¸ªé»˜è®¤å€¼ï¼šminPartitions</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">textFile</span></span>(</span><br><span class="line">    path: <span class="type">String</span>,</span><br><span class="line">    minPartitions: <span class="type">Int</span> = defaultMinPartitions)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å®ƒæ˜¯å– defaultParallelism å’Œ 2 çš„æœ€å°å€¼ </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">defaultMinPartitions</span></span>: <span class="type">Int</span> = math.min(defaultParallelism, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸ª defaultParallelism ä¸æŒ‡å®šå°±æ˜¯ totalCoresï¼Œæˆ‘è¿™é‡Œæ˜¯4</span></span><br><span class="line">scheduler.conf.getInt(<span class="string">"spark.default.parallelism"</span>, totalCores)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰€ä»¥ defaultMinPartitions æœ€ç»ˆä¸º2</span></span><br></pre></td></tr></table></figure><p><strong>2. åˆ›å»º <code>HadoopRDD</code></strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="type">HadoopRDD</span>(</span><br><span class="line">  <span class="keyword">this</span>,</span><br><span class="line">  confBroadcast,</span><br><span class="line">  <span class="type">Some</span>(setInputPathsFunc),</span><br><span class="line">  inputFormatClass,</span><br><span class="line">  keyClass,</span><br><span class="line">  valueClass,</span><br><span class="line">  minPartitions).setName(path)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3. æ¯ä¸ªRDD éƒ½æœ‰ä¸€ä¸ª <code>getPartitions</code> å‡½æ•°ï¼Œç”±å®ƒå¾—åˆ°åˆ†åŒºå·</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getPartitions</span></span>: <span class="type">Array</span>[<span class="type">Partition</span>] = &#123;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">val</span> allInputSplits = getInputFormat(jobConf).getSplits(jobConf, minPartitions)</span><br><span class="line">  ...</span><br><span class="line">   <span class="keyword">val</span> array = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Partition</span>](inputSplits.size)</span><br><span class="line">   <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until inputSplits.size) &#123;</span><br><span class="line">   array(i) = <span class="keyword">new</span> <span class="type">HadoopPartition</span>(id, i, inputSplits(i))</span><br><span class="line">   &#125;</span><br><span class="line">   array</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4. é‡‡ç”¨<code>FileInputFormat</code> é‡Œçš„ <code>getSplits()</code> åˆ’åˆ†åˆ†åŒºï¼Œå…ˆè®¡ç®— splitSize</strong></p><p><code>getPartitions</code> çš„ æ ¸å¿ƒæ˜¯ <code>getSplits()</code>ï¼Œä¸‹é¢æ˜¯è®¡ç®—åˆ†åŒºå…³é”®æ­¥éª¤</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ€»å¤§å°é™¤2ï¼Œä¸º258M</span></span><br><span class="line">long goalSize = totalSize / (long)(numSplits == <span class="number">0</span> ? <span class="number">1</span> : numSplits);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™æ˜¯äººä¸ºè®¾å®šçš„åˆ†åŒºæœ€å°å€¼ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£</span></span><br><span class="line">long minSize = <span class="type">Math</span>.max(job.getLong(<span class="string">"mapreduce.input.fileinputformat.split.minsize"</span>, <span class="number">1</span>L), <span class="keyword">this</span>.minSplitSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// HDFS æ–‡ä»¶çš„å—å¤§å°ï¼Œ128M</span></span><br><span class="line">long blockSize = file.getBlockSize();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®— splitSize</span></span><br><span class="line">long splitSize = <span class="keyword">this</span>.computeSplitSize(goalSize, minSize, blockSize);</span><br></pre></td></tr></table></figure><ul><li><p>å‡è®¾æ–‡ä»¶å¤§å°ä¸º 20Mï¼š <code>splitSize = maxï¼ˆ1ï¼Œmin(10,128)) = 10M</code></p></li><li><p>å‡è®¾æ–‡ä»¶å¤§å°ä¸º 516Mï¼š<code>splitSize  = max(1, min(258,128)) = 128M </code>ï¼ˆæœ¬æ–‡ï¼‰</p></li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> long computeSplitSize(long goalSize, long minSize, long blockSize) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Math</span>.max(minSize, <span class="type">Math</span>.min(goalSize, blockSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5. æœ€åï¼ŒæŒ‰ splitSize åˆ‡åˆ†åŒº</strong></p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥å‘ç°ä¸ºäº†é˜²æ­¢æœ€åä¸€ä¸ªåˆ†åŒºè¿‡å°çš„é—®é¢˜ï¼Œå¼•å…¥äº†æ•°å­— 1.1ï¼Œä¿è¯æœ€åä¸€ä¸ªåˆ†åŒºçš„å¤§å°å¤§äº splitSize  çš„ 10%</span></span><br><span class="line"><span class="keyword">for</span>(bytesRemaining = length; (double)bytesRemaining / (double)splitSize &gt; <span class="number">1.1</span>D; bytesRemaining -= splitSize) &#123;</span><br><span class="line">splitHosts = <span class="keyword">this</span>.getSplitHostsAndCachedHosts(blkLocations, length - bytesRemaining, splitSize, clusterMap);</span><br><span class="line">splits.add(<span class="keyword">this</span>.makeSplit(path, length - bytesRemaining, splitSize, splitHosts[<span class="number">0</span>], splitHosts[<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bytesRemaining != <span class="number">0</span>L) &#123;</span><br><span class="line">splitHosts = <span class="keyword">this</span>.getSplitHostsAndCachedHosts(blkLocations, length - bytesRemaining, bytesRemaining, clusterMap);</span><br><span class="line">splits.add(<span class="keyword">this</span>.makeSplit(path, length - bytesRemaining, bytesRemaining, splitHosts[<span class="number">0</span>], splitHosts[<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>6 åˆ†åŒºç»“æœ</strong></p><p>æ¯å—128Mï¼Œæœ€åä¸€å—ç•¥å¤§ï¼Œç¬¦åˆé¢„æœŸã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hdfs://xxxx:0+134217728</span><br><span class="line">hdfs://xxxx:134217728+134217728</span><br><span class="line">hdfs://xxxx:268435456+134217728</span><br><span class="line">hdfs://xxxx:402653184+138476793</span><br></pre></td></tr></table></figure><h1>å°ç»“</h1><ul><li><p>è¿™é‡Œæ¯”è¾ƒå¥‡è‘©çš„æ˜¯ minPartitions è¿™ä¸ªè®¾å®šï¼Œå®ƒæœ€å¤§åªèƒ½æ˜¯2ã€‚æˆ‘è§‰å¾—ä¹‹æ‰€ä»¥è¿™æ ·è®¾å®šï¼Œæ˜¯é˜²æ­¢æ–‡ä»¶åˆ‡çš„è¿‡å°ã€‚å‡è®¾æ•´ä¸ªæ–‡ä»¶å¤§å°åªæœ‰5Mï¼Œå…¬å¼ï¼š<code>Math.min(goalSize, blockSize)</code> blockSizeå‡å®š128Mï¼Œæ­¤æ—¶ splitSize ç”± minPartitions å†³å®šï¼ˆä¸è€ƒè™‘äººä¸ºè®¾å®šçš„é‚£ä¸ªminSizeï¼‰ã€‚é‚£ä¹ˆå®ƒæœ€å¤šåªèƒ½è¢«åˆ‡æˆ2ä»½ã€‚</p></li><li><p>å½“æ–‡ä»¶è¾ƒå¤§æ—¶ï¼ˆå¤§äºblockSizeä¸¤å€ï¼‰ï¼Œåªå’Œ blockSize æœ‰å…³ã€‚å°½ç®¡æˆ‘çš„æµ‹è¯•æ–‡ä»¶ä¸­æ¯ä¸ª block å®é™…å¤§å°åªæœ‰10Mï¼Œç„¶é¹…è¿™ä¸ªå¹¶æ²¡æœ‰ä»€ä¹ˆè½¯ç”¨ã€‚</p></li><li><p>è¿™æ˜¯å•æ–‡ä»¶æƒ…å†µï¼Œå¦‚æœæ˜¯è¯»ä¸€ä¸ªç›®å½•ä¸‹çš„å¤šæ–‡ä»¶ï¼Œé‚£å°±æ˜¯å•ç‹¬å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œåˆ‡åˆ†ã€‚ï¼ˆä»æºç å¯ä»¥å‘ç°ï¼Œå…¶ä¸­çš„ totalSize æ˜¯æ‰€æœ‰æ–‡ä»¶å¤§å°æ€»å’Œï¼‰ã€‚</p></li><li><p>å½“ç„¶è¿™åªæ˜¯åˆ†åŒºåˆ’åˆ†ï¼Œå®é™…è¯»å–æ•°æ®æ²¡è¿™ä¹ˆç®€å•ã€‚å‡å¦‚æˆ‘ä»¬æ˜¯ä¸€æ¡ä¸€æ¡è¯»ï¼Œé‚£ä¹ˆå¦‚æœè¯¥åˆ†åŒºæœ€åä¸€æ¡æ•°æ®æ²¡è¯»å®Œï¼Œå®ƒä¼šæ¥ç€å‘ä¸‹ä¸€å—ç»§ç»­è¯»ï¼Œå‚è€ƒ<a href="https://hadoopi.wordpress.com/2013/05/27/understand-recordreader-inputsplit/" target="_blank" rel="noopener">å®ƒ</a>ã€‚</p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½¿ç”¨ textFile è¯»å–HDFSçš„æ•°æ®åˆ†åŒºè§„åˆ™&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="spark" scheme="http://yoursite.com/tags/spark/"/>
    
  </entry>
  
  <entry>
    <title>CentOSæ ¹ç›®å½•æ‰©å®¹</title>
    <link href="http://yoursite.com/2019/11/23/CentOS%E6%A0%B9%E7%9B%AE%E5%BD%95%E6%89%A9%E5%AE%B9/"/>
    <id>http://yoursite.com/2019/11/23/CentOSæ ¹ç›®å½•æ‰©å®¹/</id>
    <published>2019-11-23T08:40:56.000Z</published>
    <updated>2019-11-23T09:13:42.301Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•å¯¹ /root ç›®å½•çš„æ‰©å®¹</p><a id="more"></a><h1>é—®é¢˜ï¼š<code>/root</code> çš„ç©ºé—´ç”¨æ»¡äº†</h1><p>æœ¬æ¥æ‰“ç®—ç›´æ¥åŠ¨æ€æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯æŒ‰é¸Ÿå“¥å†™çš„æ”¾å¤§LVå®¹é‡ï¼ŒæŠŠ <code>/home</code> çš„ç©ºé—´åˆ†ç‚¹ç»™ <code>/root</code> ã€‚ç»“æœå‘ç° xfs æ–‡ä»¶ç³»ç»Ÿåªæ”¯æŒåŠ¨æ€å¢åŠ ï¼Œä¸èƒ½å‡å°‘ã€‚å› æ­¤å’±åªèƒ½å¤‡ä»½é‡è£…äº†ã€‚</p><h1>è§£å†³ï¼š</h1><h2 id="1-æˆ‘çš„ç‰ˆæœ¬"><a class="header-anchor" href="#1-æˆ‘çš„ç‰ˆæœ¬">Â¶</a>1 æˆ‘çš„ç‰ˆæœ¬</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br></pre></td></tr></table></figure><h2 id="2-åˆ†åŒºæƒ…å†µ"><a class="header-anchor" href="#2-åˆ†åŒºæƒ…å†µ">Â¶</a>2 åˆ†åŒºæƒ…å†µ</h2><p>CentOS çš„ <code>/root</code> å’Œ <code>/home</code> ç›®å½•ä½¿ç”¨äº†LVMï¼ˆé€»è¾‘å·åˆ†åŒºï¼‰</p><p>æˆ‘å‡†å¤‡ç»™ <code>/root</code> åŠ 100Gï¼ŒæŠŠ <code>/home</code> æ”¹ä¸º700Gï¼Œé¢„ç•™ 50G</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ df -hl</span><br><span class="line">Filesystem           Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/cl-root   50G   46G  5.0G  91% /</span><br><span class="line">...</span><br><span class="line">/dev/mapper/cl-home  849G  220G  629G  26% /home</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬è¦è°ƒçš„å°±æ˜¯è¿™ä¸ªLV Size</span></span><br><span class="line">$ lvdisplay</span><br><span class="line">  ...</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/home</span><br><span class="line">  LV Name                home</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                &lt;849.07 GiB</span><br><span class="line">  Current LE             217361</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/root</span><br><span class="line">  LV Name                root</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                50.00 GiB</span><br><span class="line">  Current LE             12800</span><br></pre></td></tr></table></figure><h2 id="3-å¤‡ä»½-home"><a class="header-anchor" href="#3-å¤‡ä»½-home">Â¶</a>3 å¤‡ä»½ <code>/home</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tar å‹ç¼©ï¼Œ-p ä¿ç•™æƒé™ï¼Œ-z ä½¿ç”¨ gzip</span></span><br><span class="line">$ tar cvpfz /mnt/data/homeback.tgz /home</span><br></pre></td></tr></table></figure><h2 id="4-åˆ é™¤-home"><a class="header-anchor" href="#4-åˆ é™¤-home">Â¶</a>4 åˆ é™¤ <code>/home</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¹²æ‰/homeæ–‡ä»¶ç³»ç»Ÿçš„è¿›ç¨‹</span></span><br><span class="line">$ fuser -km /home/</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½/homeï¼Œå¦‚æœæ²¡ç”¨ï¼ŒåŠ  -l å¼ºåˆ¶å¸è½½</span></span><br><span class="line">$ umount /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ /home çš„lv</span></span><br><span class="line">$ lvremove /dev/mapper/cl-home</span><br></pre></td></tr></table></figure><h2 id="5-æ‰©å®¹-root"><a class="header-anchor" href="#5-æ‰©å®¹-root">Â¶</a>5 æ‰©å®¹ <code>/root</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æˆ‘è¿™é‡ŒåŠ  100G</span></span><br><span class="line">$ lvextend -L +100G /dev/mapper/cl-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ·æ–° /rootæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ xfs_growfs /dev/mapper/cl-root</span><br></pre></td></tr></table></figure><h2 id="6-æ¢å¤-home"><a class="header-anchor" href="#6-æ¢å¤-home">Â¶</a>6 æ¢å¤ <code>/home</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ† 700G ç»™å®ƒã€‚ï¼ˆé¢„ç•™ 50G çš„ ç©ºé—²ç©ºé—´ï¼‰</span></span><br><span class="line">$ lvcreate -L 700G -n /dev/mapper/cl-home</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ mkfs.xfs /dev/mapper/cl-home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½ /home</span></span><br><span class="line">$ mount /dev/mapper/cl-home /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶æ¢å¤</span></span><br><span class="line">$ tar xvpfz /mnt/data/homeback.tgz -C /</span><br></pre></td></tr></table></figure><h2 id="7-æ£€æŸ¥ç»“æœ"><a class="header-anchor" href="#7-æ£€æŸ¥ç»“æœ">Â¶</a>7 æ£€æŸ¥ç»“æœ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ df -hl</span><br><span class="line">Filesystem           Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/cl-root  150G   46G  105G  31% /</span><br><span class="line">...</span><br><span class="line">/dev/mapper/cl-home  700G  220G  480G  32% /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥VGï¼Œè¿˜æœ‰ 50G å‰©ä½™ï¼Œç¨³ç¨³çš„</span></span><br><span class="line">$ vgdisplay</span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               cl</span><br><span class="line">  Cur LV                3</span><br><span class="line">  ...</span><br><span class="line">  VG Size               &lt;930.51 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              238210</span><br><span class="line">  Alloc PE / Size       225648 / &lt;881.44 GiB</span><br><span class="line">  Free  PE / Size       12562 / 49.07 GiB</span><br><span class="line">  </span><br><span class="line"><span class="comment"># æ£€æŸ¥LVï¼Œå’Œé¢„æƒ³ä¸€æ ·</span></span><br><span class="line">$ lvdisplay</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/root</span><br><span class="line">  LV Name                root</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                150.00 GiB</span><br><span class="line">  Current LE             38400</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/home</span><br><span class="line">  LV Name                home</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                700.00 GiB</span><br><span class="line">  Current LE             179200</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è®°å½•å¯¹ /root ç›®å½•çš„æ‰©å®¹&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="http://yoursite.com/categories/Linux/"/>
    
    
      <category term="LVM" scheme="http://yoursite.com/tags/LVM/"/>
    
  </entry>
  
  <entry>
    <title>hbase-åŸºæœ¬åŸç†</title>
    <link href="http://yoursite.com/2019/09/29/hbase-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"/>
    <id>http://yoursite.com/2019/09/29/hbase-åŸºæœ¬åŸç†/</id>
    <published>2019-09-29T09:20:52.000Z</published>
    <updated>2019-10-08T02:10:35.843Z</updated>
    
    <content type="html"><![CDATA[<p>ç®€å•ä»‹ç»äº†hbaseçš„åŸºæœ¬åŸç†ï¼šæ•°æ®ç»“æ„ã€è¯»å†™æ“ä½œã€flushã€åˆå¹¶ä¸åˆ‡åˆ†</p><a id="more"></a><h1>æ•°æ®ç»“æ„</h1><h2 id="é€»è¾‘ç»“æ„"><a class="header-anchor" href="#é€»è¾‘ç»“æ„">Â¶</a>é€»è¾‘ç»“æ„</h2><p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/luoji.png" alt></p><p>ä¸€ä¸ª<strong>namespace</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>è¡¨</strong>ï¼Œå¦‚<code>zxylearn:student</code>ï¼Œä»£è¡¨<code>zxylearn</code>å‘½åç©ºé—´ä¸‹çš„<code>student</code>è¡¨ã€‚</p><p>ä¸€ä¸ª<strong>è¡¨</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>region</strong>ï¼Œå¦‚ä¸Šå›¾æœ‰3ä¸ªregionã€‚ä¸€ä¸ªregionä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚å¯ä»¥é¢„åˆ†åŒºï¼ˆæ¨èï¼‰æˆ–è€…å½“ä¸€ä¸ªregionè¿‡å¤§æ—¶ä¼šè‡ªåŠ¨è§¦å‘åˆ‡åˆ†ã€‚</p><p>ä¸€ä¸ª<strong>region</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>store</strong>ï¼ˆæŒ‰åˆ—æ—åˆ’åˆ†ï¼‰ï¼Œå¦‚ä¸Šå›¾æœ‰ä¸¤ä¸ªåˆ—æ—ã€‚ä¸€ä¸ªstoreä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹åæ˜¯åˆ—æ—åã€‚</p><p>ä¸€ä¸ª<strong>store</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>HFile</strong>ï¼Œflushä¸€æ¬¡äº§ç”Ÿä¸€ä¸ªï¼Œå¯ä»¥åˆå¹¶ï¼ˆåé¢ä¼šè®²ï¼‰</p><p><strong>HFile</strong>ä¸­å°±æ˜¯å…·ä½“æ•°æ®äº†ï¼Œé€»è¾‘ä¸Šæ˜¯ä¸€è¡Œè¡Œåºåˆ—åŒ–çš„æ•°æ®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># HDFSä¸­çš„ä¸€ä¸ªHFileçš„å®Œæ•´è·¯å¾„ï¼š</span><br><span class="line">/hbase/data/zxylearn/student/0fe474b3eb5fef1573d85acae8e5b787/info1/2dce02f62ea446f892a0b3cfc4e4db8a</span><br><span class="line"># namespace  zxylearn</span><br><span class="line"># è¡¨å        student</span><br><span class="line"># region     0fe474b3eb5fef1573d85acae8e5b787</span><br><span class="line"># åˆ—æ—å      info1</span><br><span class="line"># HFile      2dce02f62ea446f892a0b3cfc4e4db8a</span><br></pre></td></tr></table></figure><h2 id="ç‰©ç†ç»“æ„"><a class="header-anchor" href="#ç‰©ç†ç»“æ„">Â¶</a>ç‰©ç†ç»“æ„</h2><p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/wuli.png" alt></p><p>é€šè¿‡æŒ‡å®š <code>'namespaceï¼šè¡¨å'</code> å’Œ <code>'Row Key'</code>ï¼Œå¯æŸ¥æ‰¾åˆ°æ•°æ®çš„<code>åˆ—æ—</code>ã€<code>åˆ—å</code>ã€<code>timestamp</code>ã€<code>value</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hbase(main):018:0&gt; get &apos;zxylearn:student&apos;,&apos;1001&apos;</span><br><span class="line">COLUMN                  CELL</span><br><span class="line"> info1:name             timestamp=1569722805794, value=zhangsan</span><br></pre></td></tr></table></figure><h1>å†™æ•°æ®æµç¨‹</h1><p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/write.png" alt></p><ol><li>å®¢æˆ·ç«¯å‘ZKè¯·æ±‚è¿”å› å…ƒæ•°æ®è¡¨æ‰€åœ¨çš„RegionServeråœ°å€ã€‚ï¼ˆæˆ‘ä»¬å¯ä»¥åœ¨ZKå®¢æˆ·ç«¯ä¸­ç”¨<code>get /hbase/meta-region-server</code>çœ‹åˆ°å®ƒï¼‰</li><li>å®¢æˆ·ç«¯æ¥æ”¶åœ°å€ï¼Œå‘å®ƒè¯·æ±‚è¿”å› å¾…å†™æ•°æ®æ‰€åœ¨çš„RegionServeråœ°å€ã€‚ï¼ˆæˆ‘ä»¬å¯ä»¥åœ¨hbaseå®¢æˆ·ç«¯ç”¨<code>scan 'hbase:meta'</code>çœ‹åˆ°å®ƒï¼š<code>column=info:server, timestamp=1569658344714, value=localhost:16020</code>ï¼‰</li><li>å‘è¯¥åœ°å€è¯·æ±‚å†™æ•°æ®ã€‚</li><li>å…ˆå°†å†™æ“ä½œè®°å½•åˆ°æ“ä½œæ—¥å¿—ï¼ˆ<strong>WAL</strong>ï¼‰ä¸­ï¼Œæ¥ç€å°†æ•°æ®å†™å…¥<strong>å†…å­˜</strong>ä¸­ã€‚</li></ol><h1>Flush</h1><p>å¯ä»¥çœ‹å‡ºï¼Œå†™æ•°æ®æ˜¯å°†æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸­ã€‚å½“æ‰§è¡ŒFlushåˆ·å†™æ“ä½œæ—¶ï¼Œæ‰ä¼šå°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯HDFSä¸­ï¼Œå½¢æˆä¸€ä¸ªHFileã€‚</p><p><strong>Flushæ—¶æœº</strong></p><ul><li>å¤§å°è¶…è¿‡é™åˆ¶ï¼šå¦‚RegionServerçš„å…¨å±€å†…å­˜å¤§å°ï¼Œé»˜è®¤æ˜¯å †å¤§å°çš„40%æ—¶åˆ·å†™ï¼›å•ä¸ªregionå¤§å°ï¼Œé»˜è®¤128Mã€‚</li><li>æ—¶é—´ï¼šä»æœ€åä¸€æ¡æ•°æ®å†™å…¥åï¼Œ1hï¼ˆé»˜è®¤ï¼‰æ²¡æœ‰æ–°æ•°æ®ã€‚</li></ul><p><strong>Flushç»†èŠ‚</strong></p><ul><li><strong>flushä¼šåˆ é™¤è¿‡æœŸçš„æ•°æ®</strong>ã€‚å‡è®¾å»ºè¡¨æ—¶æ•°æ®ç‰ˆæœ¬æ•°è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆå†™å…¥ç£ç›˜çš„çš„æ•°æ®æœ€å¤šåªæœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼›å¦‚æœåˆ é™¤æ ‡è®°æ˜¯DeleteColumnï¼Œé‚£ä¹ˆä¼šåˆ é™¤æ¯”å®ƒä½ç‰ˆæœ¬çš„æ•°æ®ã€‚(<strong>åˆ é™¤æ ‡è®°æœ‰å¤šç§</strong>ï¼Œå¦‚ Deleteï¼šåªåˆ è‡ªå·±ï¼›DeleteColumnï¼šåˆ é™¤è‡ªå·±ä¸æ¯”è‡ªå·±ä½çš„)</li><li><strong>flushä¸ä¼šåˆ é™¤å¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</strong>ã€‚åŸå› ï¼šè®¾æƒ³ï¼Œæˆ‘ä»¬åŸæœ¬æƒ³åˆ é™¤ä¸€æ¡æ•°æ®ï¼Œç»™å®ƒæ‰“ä¸Šåˆ é™¤æ ‡è®°ã€‚å¦‚æœflushåˆ é™¤äº†ï¼Œå‡å¦‚ç£ç›˜ä¸­çš„å…¶å®ƒHFileä¸­æœ‰è¯¥æ•°æ®çš„æ—§ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå®ƒä»¬åœ¨<strong>åˆå¹¶æ“ä½œ</strong>ï¼ˆåé¢ä¼šè®²ï¼‰æ—¶å°±ä¸ä¼šè¢«åˆ é™¤äº†ã€‚</li></ul><p>åæ­£è®°ä½è¿™é‡Œä¼šå¹²æ‰ä¸è¦çš„æ•°æ®ï¼ˆç‰ˆæœ¬æ•°ä¸åˆ é™¤æ ‡è®°å†³å®šï¼‰ï¼Œä½†<strong>ä¸ä¼šå¹²æ‰å¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</strong>ã€‚</p><h1>è¯»æ•°æ®æµç¨‹</h1><p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/read.png" alt></p><ol><li>æ‰¾åˆ°æ•°æ®æ‰€åœ¨RSæœåŠ¡å™¨çš„æµç¨‹å’Œå†™æ•°æ®åŸºæœ¬ä¸€æ ·ã€‚</li><li>å‘è¯¥åœ°å€è¯·æ±‚è¯»æ•°æ®ã€‚</li><li>è¯»å–cacheï¼ˆç¼“å­˜ï¼‰å’ŒMemStoreï¼ˆå†…å­˜ï¼‰ï¼ŒæŸ¥æ‰¾è¯¥æ•°æ®ã€‚</li><li>å¦‚æœcacheä¸­æ²¡æœ‰ï¼Œå†å»StoreFileï¼ˆç£ç›˜ï¼‰ä¸­æ‰¾è¯¥æ•°æ®ã€‚</li><li>å–æ—¶é—´æˆ³æœ€æ–°çš„æ•°æ®è¿”å›ï¼Œå¹¶è®°å½•åˆ°cacheä¸­ã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆåœ¨å†…å­˜ä¸­æ‰¾åˆ°äº†ï¼Œè¿˜è¦å»ç£ç›˜ä¸­æ‰¾ï¼Ÿ</strong></p><p><strong>æ—¶é—´æˆ³çš„ç¼˜æ•…</strong>ï¼šæˆ‘ä»¬ç”¨æˆ·è‡ªç„¶æ˜¯æŸ¥æ‰¾æœ€æ–°çš„æ•°æ®ï¼Œå†…å­˜ä¸­çš„æ•°æ®çš„æ—¶é—´æˆ³ä¸èƒ½ä¿è¯ä¸€å®šæ¯”ç£ç›˜ä¸­çš„æ–°ï¼Œæ‰€æœ‰è¦æŠŠå®ƒä»¬éƒ½æ‰¾åˆ°ï¼Œç„¶åæ¯”è¾ƒè¿”å›æœ€æ–°çš„æ•°æ®ã€‚å› æ­¤ï¼Œè¿™å¯¼è‡´äº†<strong>hbaseè¯»æ•°æ®æ¯”å†™æ•°æ®è¿˜æ…¢</strong>ã€‚æ‰€ä»¥ï¼Œ<strong>ç”¨cacheç¼“å­˜æŸ¥åˆ°çš„æ•°æ®</strong>ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦æé«˜è¯»æ•°æ®çš„é€Ÿåº¦ã€‚</p><h1>compact(åˆå¹¶)ä¸split(åˆ‡åˆ†)</h1><h2 id="compact-åˆå¹¶"><a class="header-anchor" href="#compact-åˆå¹¶">Â¶</a>compact(åˆå¹¶)</h2><p>åˆå¹¶æ˜¯<strong>å°†è‹¥å¹²ä¸ªå°çš„HFileï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„HFile</strong>ã€‚åˆ†<strong>Minor Compaction</strong> å’Œ <strong>Major Compaction</strong>ã€‚</p><ul><li><p><strong>Minor Compaction</strong> <strong>ä¸ä¼š</strong>æ¸…ç†ä¸è¦çš„æ•°æ®å’Œå¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</p></li><li><p><strong>Major Compaction</strong> <strong>ä¼š</strong>æ¸…ç†ä¸è¦çš„æ•°æ®å’Œå¸¦æ ‡è®°åˆ é™¤çš„æ•°æ®ã€‚å½“HFileæ•°å¤§äºç­‰äº3æ—¶ï¼Œæ‰§è¡Œ<code>compact</code>æ—¶æ‰§è¡Œçš„æ˜¯å®ƒã€‚</p></li></ul><p><strong>æ¸…ç†ç»†èŠ‚</strong></p><p>ä¸flushä¸åŒï¼Œè¿™é‡Œçš„æ¸…ç†ä¸ä»…ä¼šæ¸…é™¤ä¸è¦çš„æ•°æ®ï¼Œè¿˜ä¼š<strong>æ¸…ç†å¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</strong>ï¼ˆå¹²æ‰å®ƒï¼Œå’Œæ¯”å®ƒæ—§çš„æ•°æ®ï¼‰ã€‚</p><h2 id="split-åˆ‡åˆ†"><a class="header-anchor" href="#split-åˆ‡åˆ†">Â¶</a>split(åˆ‡åˆ†)</h2><p><strong>åˆ‡åˆ†æ˜¯å°†å¤§çš„regionåˆ‡åˆ†æˆè‹¥å¹²ä¸ªå°çš„region</strong>ã€‚å¯ä»¥é¢„åˆ†åŒºï¼ˆæ¨èï¼‰æˆ–è€…å½“ä¸€ä¸ªregionè¿‡å¤§æ—¶ä¼šè‡ªåŠ¨è§¦å‘åˆ‡åˆ†ã€‚</p><p><strong>ä¸ºä»€ä¹ˆæ¨èåªç”¨ä¸€ä¸ªåˆ—æ—å‘¢ï¼Ÿ</strong></p><p><strong>å¤šä¸ªåˆ—æ—å¯èƒ½å¯¼è‡´å°æ–‡ä»¶è¿‡å¤šã€‚<strong>å‡è®¾ä¸€ä¸ªåˆ—æ—çš„æ•°æ®çš„å¾ˆå¯†é›†ï¼Œå¦ä¸€åˆ—æ—å¾ˆç¨€ç–ï¼Œé‚£ä¹ˆåœ¨è§¦å‘</strong>flushæˆ–è€…split</strong>æ—¶ï¼Œå¯†é›†çš„åˆ—æ—å½¢æˆçš„HFileæ–‡ä»¶è¶³å¤Ÿå¤§æ²¡é—®é¢˜ï¼Œä½†æ˜¯ç¨€ç–çš„ç”Ÿæˆçš„å°±æ˜¯å°æ–‡ä»¶äº†ï¼Œä¹…è€Œä¹…ä¹‹ä¼šå½¢æˆè¿‡å¤šå°æ–‡ä»¶ä½¿æ•ˆç‡é™ä½ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç®€å•ä»‹ç»äº†hbaseçš„åŸºæœ¬åŸç†ï¼šæ•°æ®ç»“æ„ã€è¯»å†™æ“ä½œã€flushã€åˆå¹¶ä¸åˆ‡åˆ†&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="hbase" scheme="http://yoursite.com/tags/hbase/"/>
    
  </entry>
  
  <entry>
    <title>hbase-å®‰è£…ä¸é…ç½®</title>
    <link href="http://yoursite.com/2019/09/28/hbase-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/"/>
    <id>http://yoursite.com/2019/09/28/hbase-å®‰è£…ä¸é…ç½®/</id>
    <published>2019-09-28T08:20:25.000Z</published>
    <updated>2019-09-29T09:23:27.889Z</updated>
    
    <content type="html"><![CDATA[<p>ä»‹ç»hbaseçš„å®‰è£…ä¸ç®€å•ä½¿ç”¨</p><a id="more"></a><h1>å‡†å¤‡</h1><p>æˆ‘çš„ç‰ˆæœ¬ï¼š</p><p><strong>hadoop 2.7.7</strong></p><p><strong>zookeeper 3.5.5</strong></p><p><strong>hbase 1.3.5</strong></p><p>å…ˆè£…å¥½ hadoop å’Œ zookeeper</p><h1>é…ç½® HBase</h1><h2 id="ä¿®æ”¹-hbase-env-sh"><a class="header-anchor" href="#ä¿®æ”¹-hbase-env-sh">Â¶</a>ä¿®æ”¹ <a href="http://hbase-env.sh" target="_blank" rel="noopener">hbase-env.sh</a></h2><p>ä¿®æ”¹<code>hbase-1.3.5/conf</code>ä¸‹çš„<code>hbase-env.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=$(/usr/libexec/java_home)</span><br><span class="line"><span class="comment"># ä½¿ç”¨è‡ªå·±å®‰è£…çš„ZK</span></span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">false</span></span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹-hbase-site-xml"><a class="header-anchor" href="#ä¿®æ”¹-hbase-site-xml">Â¶</a>ä¿®æ”¹ hbase-site.xml</h2><p>ä¿®æ”¹<code>hbase-1.3.5/conf</code>ä¸‹çš„<code>hbase-site.xml</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.rootdir&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;hdfs://localhost:9000/hbase&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">Â  Â      &lt;name&gt;hbase.master&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;master:60000&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;localhost:2181&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.zookeeper.property.dataDir&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;/usr/<span class="built_in">local</span>/apache-zookeeper-3.5.5-bin/zkData&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ -core-site-xml-å’Œ-hdfs-site-xml"><a class="header-anchor" href="#æ·»åŠ -core-site-xml-å’Œ-hdfs-site-xml">Â¶</a>æ·»åŠ  core-site.xml å’Œ hdfs-site.xml</h2><p>ç›´æ¥åœ¨<code>hbase-1.3.5/conf</code>ä¸‹åˆ›å»º<strong>è½¯è¿æ¥</strong>å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/hadoop-2.7.7/etc/hadoop/core-site.xml /usr/<span class="built_in">local</span>/hbase-1.3.5/conf/core-site.xml</span><br><span class="line"></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/hadoop-2.7.7/etc/hadoop/hdfs-site.xml /usr/<span class="built_in">local</span>/hbase-1.3.5/conf/hdfs-site.xml</span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹-regionservers"><a class="header-anchor" href="#ä¿®æ”¹-regionservers">Â¶</a>ä¿®æ”¹ regionservers</h2><p>åœ¨<code>/hbase-1.3.5/conf/regionservers</code> ä¸­æ·»åŠ <strong>é›†ç¾¤èŠ‚ç‚¹çš„åå­—</strong>ï¼Œç”¨äºç¾¤å¯ä¸ç¾¤å…³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost</span><br></pre></td></tr></table></figure><h1>ä½¿ç”¨</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆå¼€HDFSå’ŒZK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å•èŠ‚ç‚¹å¯åŠ¨ä¸å…³é—­</span></span><br><span class="line">bin/hbase-daemon.sh start master</span><br><span class="line">bin/hbase-daemon.sh start regionserver</span><br><span class="line">bin/hbase-daemon.sh stop master</span><br><span class="line">bin/hbase-daemon.sh stop regionserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¾¤å¯ä¸ç¾¤å…³</span></span><br><span class="line">bin/start-hbase.sh</span><br><span class="line">bin/stop-hbase.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯è§†åŒ–ç½‘é¡µ</span></span><br><span class="line">http://localhost:16010</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­£å¸¸å¯åŠ¨åçš„JPS</span></span><br><span class="line">977 ResourceManager</span><br><span class="line">865 NameNode</span><br><span class="line">4289 Jps</span><br><span class="line">4146 HRegionServer</span><br><span class="line">915 DataNode</span><br><span class="line">1028 NodeManager</span><br><span class="line">2360 QuorumPeerMain</span><br><span class="line">4062 HMaster</span><br></pre></td></tr></table></figure><h1>ç®€å•shellæ“ä½œ</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥shell</span></span><br><span class="line">bin/hbase shell</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘½åç©ºé—´çš„ç›¸å…³æ“ä½œ</span></span><br><span class="line">create_namespace <span class="string">'zxylearn'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¡¨çš„ç›¸å…³æ“ä½œ</span></span><br><span class="line"><span class="comment"># å»ºè¡¨</span></span><br><span class="line">create <span class="string">'zxylearn:student'</span>,<span class="string">'info1'</span>,<span class="string">'info2'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># çœ‹è¡¨</span></span><br><span class="line">describe <span class="string">'zxylearn:student'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ è¡¨</span></span><br><span class="line"><span class="built_in">disable</span> <span class="string">'zxylearn:student'</span></span><br><span class="line">drop <span class="string">'zxylearn:student'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®çš„ç›¸å…³æ“ä½œ</span></span><br><span class="line"><span class="comment"># å¢</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:name'</span>,<span class="string">'zhangsan'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:sex'</span>,<span class="string">'man'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1002'</span>,<span class="string">'info1:age'</span>,<span class="string">'22'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1002'</span>,<span class="string">'info2:addr'</span>,<span class="string">'wuhan'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1003'</span>,<span class="string">'info2:addr'</span>,<span class="string">'beijing'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥</span></span><br><span class="line">scan <span class="string">'zxylearn:student'</span>,&#123;STARTROW=&gt;<span class="string">'1001'</span>,STOPROW=&gt;<span class="string">'1003'</span>&#125;</span><br><span class="line">get <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span></span><br><span class="line">get <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:name'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¹</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:name'</span>,<span class="string">'zxy'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ </span></span><br><span class="line">delete <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:sex'</span></span><br><span class="line">deleteall <span class="string">'zxylearn:student'</span>, <span class="string">'1002'</span></span><br><span class="line">truncate <span class="string">'zxylearn:student'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»‹ç»hbaseçš„å®‰è£…ä¸ç®€å•ä½¿ç”¨&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="é…ç½®" scheme="http://yoursite.com/tags/%E9%85%8D%E7%BD%AE/"/>
    
      <category term="hbase" scheme="http://yoursite.com/tags/hbase/"/>
    
  </entry>
  
  <entry>
    <title>zookeeper-åŸºæœ¬åŸç†</title>
    <link href="http://yoursite.com/2019/09/24/zookeeper-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/"/>
    <id>http://yoursite.com/2019/09/24/zookeeper-åŸºæœ¬åŸç†/</id>
    <published>2019-09-24T08:24:14.000Z</published>
    <updated>2019-09-24T08:36:42.582Z</updated>
    
    <content type="html"><![CDATA[<p>ä»‹ç»äº†zookeeperçš„åŸºæœ¬åŸç†å’Œä½¿ç”¨</p><a id="more"></a><h1>ç®€ä»‹</h1><p>ZooKeeperæ˜¯ä¸ªåˆ†å¸ƒå¼çš„æœåŠ¡åè°ƒæ¡†æ¶ã€‚å…·ä½“ç”¨é€”å¦‚ï¼š<strong>ç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†</strong>ç­‰ã€‚å®ƒåŸºäº<strong>è§‚å¯Ÿè€…</strong>çš„è®¾è®¡æ¨¡å¼ï¼›zookeeper = æ–‡ä»¶ç³»ç»Ÿ + ç›‘å¬é€šçŸ¥æœºåˆ¶ã€‚</p><p>ç‰¹ç‚¹ï¼š</p><ol><li>æœ€ç»ˆä¸€è‡´æ€§ï¼šClientä¸è®ºè¿æ¥åˆ°å“ªä¸ªServerï¼Œå¾—åˆ°çš„æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ã€‚</li><li>åŸå­æ€§ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œå…¨éƒ¨æ‰§è¡Œæˆ–è€…å…¨éƒ¨ä¸æ‰§è¡Œã€‚</li><li>é¡ºåºæ€§ï¼šåŒä¸€ä¸ªclientçš„è¯·æ±‚é¡ºåºæ‰§è¡Œã€‚</li><li>åˆ†åŒºå®¹é”™æ€§ï¼šzookeeperæ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥åœ¨éƒ¨åˆ†èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œå¯ä»¥è‡ªå·±æ¢å¤ã€‚</li></ol><h1>æ•°æ®ç»“æ„</h1><p><strong>znode</strong>ï¼šzkæ˜¯å±‚çº§æ ‘çŠ¶ç»“æ„ï¼Œä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯znodeã€‚é»˜è®¤å¯å­˜<strong>1Mæ•°æ®</strong>ã€‚</p><ul><li>æ“ä½œèŠ‚ç‚¹æ—¶å¯è®¾ç½®<strong>watcher</strong>ã€‚å½“èŠ‚ç‚¹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘watcherå¯¹åº”çš„æ“ä½œï¼Œåªè§¦å‘ä¸€æ¬¡ã€‚</li><li><strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼šåˆ›å»ºåæ°¸ä¹…å­˜åœ¨ï¼Œé™¤éä¸»åŠ¨åˆ é™¤ï¼›<strong>ä¸´æ—¶èŠ‚ç‚¹</strong>ï¼šä¸´æ—¶åˆ›å»ºçš„ï¼Œä¼šè¯ç»“æŸèŠ‚ç‚¹è‡ªåŠ¨è¢«åˆ é™¤</li><li><strong>é¡ºåºèŠ‚ç‚¹</strong>ï¼šèŠ‚ç‚¹åç§°åé¢è‡ªåŠ¨å¢åŠ ä¸€ä¸ª10ä½æ•°å­—çš„åºåˆ—å·ï¼›<strong>éé¡ºåºèŠ‚ç‚¹</strong>ï¼šä¸åŠ åºåˆ—å·</li></ul><p>èŠ‚ç‚¹è¡ç”Ÿå‡ºåˆ†ç±»æ˜¯ä¸ºäº†è¿åˆéœ€æ±‚ã€‚ä¸´æ—¶èŠ‚ç‚¹å¯ä»¥è®°å½•æœåŠ¡å™¨æ˜¯å¦ä¸Šçº¿ï¼šå½“æœåŠ¡å™¨ä¸‹çº¿ï¼Œä¸´æ—¶èŠ‚ç‚¹çš„æ•°æ®æ¶ˆé™¤ã€‚é¡ºåºèŠ‚ç‚¹å¯ç”¨äºåŒä¸€æœåŠ¡å™¨å¤šæ¬¡ä¸Šä¸‹çº¿ï¼Œæ¯æ¬¡åå­—éƒ½ä¸åŒã€‚å¾ˆæ˜æ˜¾2ä¸ª2åˆ†ç±»ï¼Œä¸¤ä¸¤ç»„åˆæœ‰4ç§èŠ‚ç‚¹ã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªznodeçš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸€ä¸ªznodeçš„æ•°æ®ç»“æ„</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] <span class="built_in">stat</span> /zxy</span><br><span class="line">cZxid = 0x39                                <span class="comment"># èŠ‚ç‚¹åˆ›å»ºæ—¶çš„zxid</span></span><br><span class="line">ctime = Mon Sep 23 16:38:23 CST 2019        <span class="comment"># èŠ‚ç‚¹åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³</span></span><br><span class="line">mZxid = 0x3d                                <span class="comment"># èŠ‚ç‚¹ä¿®æ”¹æ—¶çš„zxid</span></span><br><span class="line">mtime = Mon Sep 23 16:38:44 CST 2019        <span class="comment"># èŠ‚ç‚¹ä¿®æ”¹æ—¶çš„æ—¶é—´æˆ³</span></span><br><span class="line">pZxid = 0x39                                <span class="comment"># æ”¹å˜å­èŠ‚ç‚¹æ—¶çš„zxid</span></span><br><span class="line">cversion = 0                                <span class="comment"># å­èŠ‚ç‚¹çš„ç‰ˆæœ¬å·</span></span><br><span class="line">dataVersion = 3                             <span class="comment"># æ•°æ®ç‰ˆæœ¬ï¼šåˆå§‹0ï¼Œæ”¹å˜ä¸€æ¬¡åŠ 1</span></span><br><span class="line">aclVersion = 0                              <span class="comment"># ACLç‰ˆæœ¬ï¼ˆæƒé™ï¼‰</span></span><br><span class="line">ephemeralOwner = 0x0                        <span class="comment"># æ•°æ®æ‹¥æœ‰è€…ï¼šæ°¸ä¹…èŠ‚ç‚¹æ˜¯0ï¼›ä¸´æ—¶èŠ‚ç‚¹æ˜¯åˆ›å»ºè€…çš„id</span></span><br><span class="line">dataLength = 13                             <span class="comment"># æ•°æ®é•¿åº¦</span></span><br><span class="line">numChildren = 0                             <span class="comment"># å­èŠ‚ç‚¹ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹èŠ‚ç‚¹çš„æ“ä½œæ— éæ˜¯å¢åˆ æ”¹æŸ¥ç­‰ï¼Œè¿™é‡Œå°±ä¸å†™äº†</span></span><br></pre></td></tr></table></figure><p>è¡¥å……ï¼š</p><p><strong>zxid</strong>ï¼ˆZooKeeper Transaction Idï¼‰ï¼šZooKeeperæ¯æ¬¡çŠ¶æ€å˜åŒ–å°†ä¼šäº§ç”Ÿä¸€ä¸ªå«zxidçš„æ—¶é—´æˆ³ã€‚</p><h1>åŸç†</h1><p>åŸºæœ¬æµç¨‹ï¼š</p><p>å®¢æˆ·ç«¯å‘è¯·æ±‚ï¼ˆå¯å¸¦watcherï¼‰ -&gt;  zk é€‰ä¸¾ä¸æ¢å¤ (æ²¡leaderæ—¶) -&gt; zk è¯»å†™æ•°æ® -&gt; è¿”å›æ•°æ®ï¼ˆå¯è§¦å‘watcherï¼‰</p><p>ä¸¤ç«¯ä¸»è¦æ˜¯<strong>ç›‘å¬å™¨çš„åŸç†</strong>ï¼Œä¸­é—´ä¸»è¦ç”¨åˆ°<strong>ZABåè®®</strong>ã€‚</p><h2 id="ç›‘å¬å™¨åŸç†"><a class="header-anchor" href="#ç›‘å¬å™¨åŸç†">Â¶</a>ç›‘å¬å™¨åŸç†</h2><p>watcher ç›¸å½“äºä¸€ä¸ªçš„ç‚¸å¼¹ï¼Œå®¢æˆ·ç«¯å‘è¯·æ±‚æ—¶ï¼šå¦‚<code>lsï¼Œgetï¼Œset</code>ç­‰ï¼Œå¯ä»¥ç»™èŠ‚ç‚¹ç»‘ä¸Šç‚¸å¼¹ã€‚</p><p>å¦‚æœè§¦å‘äº†çˆ†ç‚¸æ¡ä»¶ï¼š<code>ls</code>å°±æ˜¯è¯¥èŠ‚ç‚¹æœ‰å¢åŠ åˆ å‡å­èŠ‚ç‚¹ï¼›<code>get set</code>å°±æ˜¯è¯¥èŠ‚ç‚¹æ•°æ®æ”¹å˜ã€‚</p><p>ç‚¸å¼¹çˆ†ç‚¸ï¼ˆåªç‚¸ä¸€æ¬¡ï¼‰ä¹Ÿå°±æ˜¯æ‰§è¡Œé‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚</p><p>å¾ˆæ˜æ˜¾è¿™é‡Œç”¨æˆ·ç«¯è‡³å°‘éœ€è¦å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼šconnectçº¿ç¨‹è´Ÿè´£ç½‘ç»œè¿æ¥é€šä¿¡ï¼šç»‘ç‚¸å¼¹å¹¶æŠŠä»»åŠ¡å‘ç»™zkä¸åç»­æ•°æ®äº’ä¼ ï¼›listenerçº¿ç¨‹ç›‘å¬ç‚¸å¼¹çˆ†ç‚¸ä¿¡å·ã€‚</p><p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/zookeeper/zk.png" alt></p><h2 id="ZABåè®®"><a class="header-anchor" href="#ZABåè®®">Â¶</a>ZABåè®®</h2><p>Zabåè®®ï¼ˆZookeeper Atomic Broadcastï¼‰ï¼Œé€šè¿‡å®ƒæ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚<br>è¿™ä¸ªå†…å®¹å¾ˆå¤šï¼Œè¯¦ç»†çš„å¯ä»¥å‚è€ƒï¼š</p><p><a href="https://www.jianshu.com/p/2bceacd60b8a" target="_blank" rel="noopener">Zookeeperâ€”â€”ä¸€è‡´æ€§åè®®:Zabåè®®</a></p><p><a href="https://www.cnblogs.com/felixzh/p/5869212.html" target="_blank" rel="noopener">Zookeeperçš„åŠŸèƒ½ä»¥åŠå·¥ä½œåŸç†</a></p><p>ä¸»è¦åŠŸèƒ½ï¼šå´©æºƒæ¢å¤(é€‰ä¸¾ã€æ•°æ®æ¢å¤) çš„ åŸå­å¹¿æ’­ (æ•°æ®è¯»å†™)</p><h3 id="å´©æºƒæ¢å¤"><a class="header-anchor" href="#å´©æºƒæ¢å¤">Â¶</a>å´©æºƒæ¢å¤</h3><p>é›†ç¾¤ä¸­å¿…é¡»æœ‰ä¸€ä¸ªleaderï¼Œleaderå‡ºç°æ•…éšœæ—¶ï¼Œé‡‡ç”¨æŠ•ç¥¨é€‰ä¸¾æ–°leaderï¼Œå®ƒéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li>æ–°é€‰ä¸¾å‡ºæ¥çš„ Leader ä¸èƒ½åŒ…å«æœªæäº¤çš„ Proposal ã€‚</li><li>æ–°é€‰ä¸¾çš„ Leader èŠ‚ç‚¹ä¸­å«æœ‰æœ€å¤§çš„ zxid ã€‚</li><li>å¾—åˆ°è¶…è¿‡ä¸€åŠé€‰ç¥¨è€…ç§°ä¸º Leaderï¼Œå› æ­¤<strong>zké›†ç¾¤ä¸ªæ•°ä¸ºå¥‡æ•°</strong></li></ul><p>å¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ leader å’Œ follower ï¼Œè¿˜æœ‰observerï¼Œå®ƒä¸å‚ä¸é€‰ä¸¾ã€‚ä½œç”¨æ˜¯ï¼šå¯ä»¥å¢åŠ é›†ç¾¤æ•°é‡ï¼Œåˆå‡å°‘æŠ•ç¥¨é€‰ä¸¾æ—¶é—´ã€‚</p><p>é€‰å‡ºleaderåï¼Œè¿›è¡Œæ•°æ®æ¢å¤ä¹Ÿå°±æ˜¯åŒæ­¥ï¼Œè¿™ä¸ªæ²¡å•¥ï¼Œå°±æ˜¯è®©å®ƒä»¬å…¶å®ƒèŠ‚ç‚¹æ•°æ®éƒ½å’ŒleaderåŒæ­¥ï¼Œæ¯•ç«Ÿå’±è¦ç¡®ä¿<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚æ¢å¤å®Œæ¯•åï¼Œå°±å¯ä»¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚äº†ã€‚</p><h3 id="è¯»å†™æ•°æ®"><a class="header-anchor" href="#è¯»å†™æ•°æ®">Â¶</a>è¯»å†™æ•°æ®</h3><p><strong>ä¸€èˆ¬æµç¨‹ï¼š</strong></p><p><strong>è¯»è¯·æ±‚</strong>ï¼Œå°±æ˜¯ç›´æ¥ä»å½“å‰èŠ‚ç‚¹ä¸­è¯»å–æ•°æ®</p><p><strong>å†™è¯·æ±‚</strong></p><ol><li>å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªå†™æ“ä½œè¯·æ±‚ã€‚</li><li>Leader å°†å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬åŒ–ä¸ºäº‹åŠ¡ï¼ˆProposalï¼‰ï¼Œæ¯ä¸ª Proposal åˆ†é…ä¸€ä¸ªå…¨å±€çš„IDï¼Œå³zxidã€‚</li><li>Leader ä¸ºæ¯ä¸ª Follower åˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ï¼Œç„¶åå°†éœ€è¦å¹¿æ’­çš„ Proposal ä¾æ¬¡æ”¾åˆ°é˜Ÿåˆ—ä¸­å–ï¼Œå¹¶ä¸”æ ¹æ® FIFO ç­–ç•¥è¿›è¡Œæ¶ˆæ¯å‘é€ã€‚</li><li>Follower æ¥æ”¶åˆ° Proposal åï¼Œä¼šé¦–å…ˆå°†å…¶ä»¥äº‹åŠ¡æ—¥å¿—çš„æ–¹å¼å†™å…¥æœ¬åœ°ç£ç›˜ä¸­ï¼Œå†™å…¥æˆåŠŸåå‘ Leader åé¦ˆä¸€ä¸ª Ack å“åº”æ¶ˆæ¯ã€‚</li><li>Leader æ¥æ”¶åˆ°<strong>è¶…è¿‡åŠæ•°ä»¥ä¸Š</strong> Follower çš„ Ack å“åº”æ¶ˆæ¯åï¼Œå³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¯ä»¥å‘é€ commit æ¶ˆæ¯ã€‚</li><li>Leader å‘æ‰€æœ‰ Follower å¹¿æ’­ commit æ¶ˆæ¯ï¼ŒåŒæ—¶è‡ªèº«ä¹Ÿä¼šå®Œæˆäº‹åŠ¡æäº¤ã€‚Follower æ¥æ”¶åˆ° commit æ¶ˆæ¯åï¼Œä¼šå°†ä¸Šä¸€æ¡äº‹åŠ¡æäº¤ã€‚</li></ol><p><strong>æœ‰æ„æ€çš„ç‚¹</strong></p><ul><li><p>**å¦‚ä½•ä¿è¯æ¶ˆæ¯æœ‰åºï¼š**åœ¨æ•´ä¸ªæ¶ˆæ¯å¹¿æ’­ä¸­ï¼ŒLeaderä¼šå°†æ¯ä¸€ä¸ªäº‹åŠ¡è¯·æ±‚è½¬æ¢æˆå¯¹åº”çš„ proposal æ¥è¿›è¡Œå¹¿æ’­ï¼Œå¹¶ä¸”åœ¨å¹¿æ’­ äº‹åŠ¡Proposal ä¹‹å‰ï¼ŒLeaderæœåŠ¡å™¨ä¼šé¦–å…ˆä¸ºè¿™ä¸ªäº‹åŠ¡Proposalåˆ†é…ä¸€ä¸ªå…¨å±€å•é€’å¢çš„å”¯ä¸€IDï¼Œç§°ä¹‹ä¸ºäº‹åŠ¡IDï¼ˆå³zxidï¼‰ï¼Œç”±äºZabåè®®éœ€è¦ä¿è¯æ¯ä¸€ä¸ªæ¶ˆæ¯çš„ä¸¥æ ¼çš„é¡ºåºå…³ç³»ï¼Œå› æ­¤å¿…é¡»å°†æ¯ä¸€ä¸ªproposalæŒ‰ç…§å…¶zxidçš„å…ˆåé¡ºåºè¿›è¡Œæ’åºå’Œå¤„ç†ã€‚</p></li><li><p>**ç”¨é˜Ÿåˆ—æé«˜æ•ˆç‡ï¼š**Leader æœåŠ¡å™¨ä¸æ¯ä¸€ä¸ª Follower æœåŠ¡å™¨ä¹‹é—´éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå•ç‹¬çš„ FIFO æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œæ”¶å‘æ¶ˆæ¯ï¼Œä½¿ç”¨é˜Ÿåˆ—æ¶ˆæ¯å¯ä»¥åšåˆ°å¼‚æ­¥è§£è€¦ã€‚ Leader å’Œ Follower ä¹‹é—´åªéœ€è¦å¾€é˜Ÿåˆ—ä¸­å‘æ¶ˆæ¯å³å¯ã€‚å¦‚æœä½¿ç”¨å®Œå…¨åŒæ­¥çš„æ–¹å¼ä¼šå¼•èµ·é˜»å¡ï¼Œæ€§èƒ½è¦ä¸‹é™å¾ˆå¤šã€‚(æˆ‘æ„Ÿè§‰è¿™é‡Œåº”è¯¥ä¸æ˜¯FIFO æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåº”è¯¥æ˜¯æœ€å°é˜Ÿåˆ—å§)</p></li><li><p><strong>è®°ä½è¶…è¿‡åŠæ•°</strong></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»‹ç»äº†zookeeperçš„åŸºæœ¬åŸç†å’Œä½¿ç”¨&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="zookeeper" scheme="http://yoursite.com/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>hive-DML</title>
    <link href="http://yoursite.com/2019/09/19/hive-DML/"/>
    <id>http://yoursite.com/2019/09/19/hive-DML/</id>
    <published>2019-09-19T09:02:24.000Z</published>
    <updated>2019-09-21T03:54:42.372Z</updated>
    
    <content type="html"><![CDATA[<p>hiveä¸­ä¸€äº›DMLçš„æ“ä½œ</p><a id="more"></a><p>DMLï¼ˆæ•°æ®æ“çºµè¯­è¨€ï¼‰ä¸»è¦æŒ‡æ•°æ®çš„å¢åˆ æŸ¥æ”¹</p><h1>æ•°æ®å¯¼å…¥</h1><p>æœ‰5ç§å¯¼å…¥æ•°æ®çš„æ–¹æ³•ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ <strong>Load</strong> å’Œ <strong>Insert</strong></p><h2 id="Load"><a class="header-anchor" href="#Load">Â¶</a>Load</h2><p>ä»æ–‡ä»¶ç³»ç»Ÿä¸­å¯¼å…¥æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> [<span class="keyword">local</span>] inpath <span class="string">'/xxxxxx'</span> </span><br><span class="line">[overwrite] <span class="keyword">into</span> <span class="keyword">table</span> tablename [<span class="keyword">partition</span> (partcol1=val1,â€¦)];</span><br></pre></td></tr></table></figure><ul><li>local: æŒ‡æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¦åˆ™ä¸ºHDFS</li><li>overwrite: æŒ‡è¦†ç›–è¡¨ä¸­å·²æœ‰æ•°æ®ï¼Œå¦åˆ™è¡¨ç¤ºè¿½åŠ </li><li>partition: è¡¨ç¤ºä¸Šä¼ åˆ°æŒ‡å®šåˆ†åŒº</li></ul><h2 id="Insert"><a class="header-anchor" href="#Insert">Â¶</a>Insert</h2><p>é€šè¿‡æŸ¥è¯¢è¯­å¥å¯¼å…¥æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¦†ç›–</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> tablename [<span class="keyword">partition</span>(partcol1=val1,partclo2=val2)] select_statement;</span><br><span class="line"><span class="comment"># è¿½åŠ </span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> tablename [<span class="keyword">partition</span>(partcol1=val1,partclo2=val2)] select_statement;</span><br></pre></td></tr></table></figure><h2 id="As-Select"><a class="header-anchor" href="#As-Select">Â¶</a>As Select</h2><p>æŸ¥è¯¢è¯­å¥ä¸­åˆ›å»ºè¡¨å¹¶å¯¼å…¥æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> tablename</span><br><span class="line"><span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure><h2 id="Location"><a class="header-anchor" href="#Location">Â¶</a>Location</h2><p>åˆ›å»ºè¡¨æ—¶é€šè¿‡LocationæŒ‡å®šæ•°æ®çš„è·¯å¾„ï¼Œå†ç›´æ¥putæ•°æ®åˆ°hdfsä¸Š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive (default)&gt; dfs -put /xxxxx /user/hive/warehouse/tablename;</span><br></pre></td></tr></table></figure><h2 id="Import"><a class="header-anchor" href="#Import">Â¶</a>Import</h2><p>åªèƒ½å¯¼å…¥exportå¯¼å‡ºçš„æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import table tablename partition(month='201909') from '/user/hive/warehouse/export/student';</span><br></pre></td></tr></table></figure><h1>æ•°æ®å¯¼å‡º</h1><p>æœ€å¸¸ç”¨çš„æ˜¯ <strong>Insert</strong> å’Œ <strong>Hadoop</strong></p><h2 id="Insert-v2"><a class="header-anchor" href="#Insert-v2">Â¶</a>Insert</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ•°æ®å¯¼å…¥æœ¬åœ°ï¼ˆå¹¶æ ¼å¼åŒ–å¤„ç†ï¼‰ï¼Œä¸åŠ localå°±æ˜¯å¯¼å…¥HDFS</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> <span class="keyword">directory</span> <span class="string">'/xxxxx'</span></span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\t'</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tablename;</span><br></pre></td></tr></table></figure><h2 id="Hadoop"><a class="header-anchor" href="#Hadoop">Â¶</a>Hadoop</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hadoopå‘½ä»¤å¯¼å‡º</span></span><br><span class="line">hive &gt; dfs -get /user/hive/warehouse/student/month=201909/000000_0 /xxxxxxx;</span><br></pre></td></tr></table></figure><h2 id="Export"><a class="header-anchor" href="#Export">Â¶</a>Export</h2><p>è¿™ä¸ªå¯¼å‡ºçš„æ•°æ®é™¤äº†æ•°æ®è¿˜æœ‰å…ƒæ•°æ®ï¼Œå¯ç”¨Importå¯¼å…¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive &gt; <span class="built_in">export</span> table tablename to <span class="string">'/user/hive/warehouse/export/student'</span>;</span><br></pre></td></tr></table></figure><h1>æ•°æ®æ¸…é™¤</h1><p>åªèƒ½æ¸…é™¤å†…éƒ¨è¡¨çš„æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hive &gt; truncate table tablename;</span><br></pre></td></tr></table></figure><h1>æŸ¥è¯¢</h1><p>æŸ¥è¯¢çš„å…³é”®å­—è¾ƒå¤šï¼Œè¦çŸ¥é“å®ƒä»¬çš„<strong>é¡ºåº</strong>ï¼ˆé‡ç‚¹ï¼‰</p><p>å†™çš„é¡ºåºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ... <span class="keyword">from</span> ... <span class="keyword">join</span> <span class="keyword">on</span> ... <span class="keyword">where</span> ... <span class="keyword">group</span> <span class="keyword">by</span> ... <span class="keyword">having</span> ... <span class="keyword">order</span> <span class="keyword">by</span> ... <span class="keyword">limit</span> ...</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œé¡ºåºï¼šå¤§ä½“æ€è·¯æ˜¯ é™å®š(where)ï¼Œåˆ†ç»„ï¼Œé™å®šï¼ˆhavingï¼‰ï¼Œé€‰æ‹©ï¼Œæ’åº</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from -&gt; join on -&gt; where -&gt; group by -&gt; having -&gt; select -&gt; order by -&gt; limit</span><br></pre></td></tr></table></figure><h2 id="selectâ€¦whereâ€¦limit"><a class="header-anchor" href="#selectâ€¦whereâ€¦limit">Â¶</a>selectâ€¦whereâ€¦limit</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç®€å•æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">select</span> empno, ename <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) cnt <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">where</span> sal &gt;<span class="number">1000</span> <span class="keyword">limit</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure><h2 id="group-by-å’Œ-having"><a class="header-anchor" href="#group-by-å’Œ-having">Â¶</a>group by å’Œ having</h2><p>group by è¯­å¥é€šå¸¸ä¼šå’Œèšåˆå‡½æ•°ä¸€èµ·ä½¿ç”¨ï¼ŒæŒ‰ç…§ä¸€ä¸ªæˆ–è€…å¤šä¸ªåˆ—é˜Ÿç»“æœè¿›è¡Œåˆ†ç»„ï¼Œç„¶åå¯¹æ¯ä¸ªç»„æ‰§è¡Œèšåˆæ“ä½œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®—empè¡¨æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„</span></span><br><span class="line"><span class="keyword">select</span> t.deptno, <span class="keyword">avg</span>(t.sal) avg_sal <span class="keyword">from</span> emp t <span class="keyword">group</span> <span class="keyword">by</span> t.deptno;</span><br></pre></td></tr></table></figure><p>where ä½œç”¨åœ¨ åˆ†ç»„ï¼ˆgroup byï¼‰å’Œèšåˆï¼ˆsumç­‰ï¼‰è®¡ç®—ä¹‹å‰ï¼Œé€‰å–å“ªäº›è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨æŸ¥è¯¢å‰ç­›é€‰ï¼›having å¯¹åˆ†ç»„å<strong>è®¡ç®—çš„</strong>æ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚å®ƒ<strong>åªç”¨äº</strong>group byåˆ†ç»„ç»Ÿè®¡è¯­å¥ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ±‚æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡è–ªæ°´å¤§äº2000çš„éƒ¨é—¨</span></span><br><span class="line"><span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) avg_sal <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno <span class="keyword">having</span> avg_sal &gt; <span class="number">2000</span>;</span><br></pre></td></tr></table></figure><h2 id="join"><a class="header-anchor" href="#join">Â¶</a>join</h2><p>Hiveæ”¯æŒé€šå¸¸çš„SQL JOINè¯­å¥ï¼Œä½†æ˜¯<strong>åªæ”¯æŒç­‰å€¼è¿æ¥ï¼Œä¸æ”¯æŒéç­‰å€¼è¿æ¥</strong>ã€‚ ä¸” è¿æ¥è°“è¯ä¸­<strong>ä¸æ”¯æŒor</strong>ã€‚<br>è¿™ä¸ªéç­‰å€¼è¿æ¥å¯ä»¥ä»ä»¥å‰å­¦çš„<strong>reducejoin</strong>çš„æµç¨‹æ€ç´¢åŸå› ï¼Œreducejoinæ˜¯åœ¨shufferæ—¶å°†æ•°æ®æŒ‰å…³è”å€¼ç›¸ç­‰çš„ï¼ˆonçš„æ¡ä»¶ï¼‰åˆ†ä¸ºä¸€ç»„ï¼Œå†åœ¨reduceré˜¶æ®µè¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå¹¶å‘˜å·¥è¡¨å’Œéƒ¨é—¨è¡¨</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno = d.deptno;</span><br></pre></td></tr></table></figure><h2 id="æ’åº"><a class="header-anchor" href="#æ’åº">Â¶</a>æ’åº</h2><h3 id="å…¨å±€æ’åº-Order-By"><a class="header-anchor" href="#å…¨å±€æ’åº-Order-By">Â¶</a>å…¨å±€æ’åº Order By</h3><p>å…¨å±€æ’åºï¼Œåªä¸€ä¸ªReducerã€‚å…¨æ’å¾ˆæ˜æ˜¾æœ€åç”Ÿæˆä¸€ä¸ªæ€»çš„æ’åºæ–‡ä»¶ï¼Œ<strong>1ä¸ªreducer</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯æŒ‰å·¥èµ„é™åºæ’åˆ—</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><h3 id="æŒ‰reduceræ’åº-sort-by"><a class="header-anchor" href="#æŒ‰reduceræ’åº-sort-by">Â¶</a>æŒ‰reduceræ’åº sort by</h3><p>æ¯ä¸ªreducerç«¯éƒ½ä¼šåšæ’åºï¼Œå‡ºæ¥çš„æ•°æ®æ˜¯æœ‰åºçš„ã€‚å‡å¦‚æœ‰nä¸ªReducerï¼Œå°±ä¼šç”Ÿæˆnä¸ªæœ‰åºæ–‡ä»¶ã€‚å½“n=1æ—¶ï¼Œå®ƒå°±æ˜¯<code>Order By</code>ã€‚</p><p>æ‰©å±•ä¸€æ³¢ï¼ŒReducerä¸ªæ•°é»˜è®¤æŒ‰åŸå§‹æ•°æ®256Mä¸€ä¸ªï¼Œå½“ç„¶ä¹Ÿå¯æ‰‹åŠ¨è®¾ç½®å…¶ä¸ªæ•°ã€‚</p><h3 id="åˆ†åŒºæ’åº-Distribute-Byâ€¦Sort-By"><a class="header-anchor" href="#åˆ†åŒºæ’åº-Distribute-Byâ€¦Sort-By">Â¶</a>åˆ†åŒºæ’åº Distribute Byâ€¦Sort By</h3><p>å…ˆåˆ†åŒºï¼Œåæ’åºã€‚è¿™ä¸ªåˆ†åŒºç±»å‹mapreduceçš„åˆ†åŒºï¼Œå¤šå°‘ä¸ªåˆ†åŒºï¼Œå°±æœ‰å¤šå°‘ä¸ªreduceä»»åŠ¡ï¼Œåé¢å°±ç”Ÿæˆå¤šå°‘ä¸ªæ–‡ä»¶ã€‚è¯´ç™½äº†è¿™ä¸ªå’Œä¸Šé¢çš„åŒºåˆ«å°±æ˜¯å®ƒé€šè¿‡<code>Distribute By</code>æŒ‡å®šæ€ä¹ˆåˆ†åŒºï¼Œå³æŒ‡å®šæ€ä¹ˆåˆ†reducerã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®reduceä¸ªæ•°</span></span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=<span class="number">3</span>;</span><br><span class="line"><span class="comment"># å…ˆæŒ‰ç…§éƒ¨é—¨ç¼–å·åˆ†åŒºï¼Œå†æŒ‰ç…§å‘˜å·¥ç¼–å·é™åºæ’åº</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> <span class="keyword">directory</span> <span class="string">'/Users/zxy/IdeaProjects/bigdata-learning/hive-learning/data/output'</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">distribute</span> <span class="keyword">by</span> deptno <span class="keyword">sort</span> <span class="keyword">by</span> empno <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ¡¶-Cluster-By"><a class="header-anchor" href="#åˆ†æ¡¶-Cluster-By">Â¶</a>åˆ†æ¡¶ Cluster By</h3><p>å½“distribute by å’Œ sorts by <strong>å­—æ®µç›¸åŒ</strong>æ—¶ï¼Œå¯ä»¥ä½¿ç”¨cluster byæ–¹å¼ã€‚ä½†<strong>æ’åºåªèƒ½æ˜¯å‡åºæ’åº</strong>ã€‚</p><p>å¯ä»¥ä»å–åçœ‹å‡ºï¼Œæˆ‘æ²¡ç”¨åˆ†æ¡¶æ’åºã€‚ä½ å¯ä»¥ç†è§£ Cluster å°±æ˜¯æŠŠæ•°æ®åˆ†åŒºï¼Œç„¶åæ¯ä¸ªåˆ†åŒºç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å°±å¥½è§£é‡Šä¸ºå•¥åªèƒ½å‡åºæ’åºï¼Œæˆ‘ç†è§£å®ƒå‹æ ¹å°±ä¸éœ€è¦æ’åºï¼Œåªæ˜¯æŠŠæ•°æ®åˆ†åˆ°ä¸åŒåŒºå°±okã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥ä¸‹ä¸¤ç§å†™æ³•ç­‰ä»·</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp cluster <span class="keyword">by</span> deptno;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">distribute</span> <span class="keyword">by</span> deptno <span class="keyword">sort</span> <span class="keyword">by</span> deptno;</span><br></pre></td></tr></table></figure><p><strong>ç»†èŠ‚ä¸€ï¼šæ¥æ³¢å°ç»“ç†ä¸€ä¸‹  åˆ†åŒºè¡¨ åˆ†åŒºæ’åº åˆ†æ¡¶(å‰ä¸¤ä¸ªåˆ†åŒºæ„æ€æˆªç„¶ä¸åŒ)</strong></p><ul><li><code>partition(month='201909')</code> è¿™ä¸ªæ˜¯åˆ†åŒºè¡¨ï¼Œé’ˆå¯¹çš„æ˜¯æ•°æ®çš„å­˜å‚¨è·¯å¾„</li><li><code>Distribute By...Sort By</code> è¿™ä¸ªæ˜¯åˆ†åŒºæ’åºï¼Œå’Œ<strong>MRä¸­çš„åˆ†åŒº</strong>æ¦‚å¿µä¸€æ ·ï¼Œå¤šå°‘ä¸ªåˆ†åŒºï¼Œå°±æœ‰å¤šå°‘ä¸ªreduceä»»åŠ¡ï¼Œåé¢å°±ç”Ÿæˆå¤šå°‘ä¸ªæ–‡ä»¶ï¼Œåˆ†åŒºä¹‹åå¯¹åŒºé‡Œçš„æ•°æ®è¿›è¡Œæ’åºã€‚</li><li><code>Cluster By</code> åˆ†æ¡¶ï¼Œé’ˆå¯¹çš„æ˜¯æ•°æ®æ–‡ä»¶ï¼Œå°†å¤§çš„æ•°æ®é›†åˆ†åŒºã€‚</li></ul><p>æ‰€ä»¥å°† Cluster By ç†è§£ä¸ºåˆ†åŒºï¼Œ Distribute Byâ€¦Sort By ç†è§£ä¸ºåˆ†åŒºæ’åºï¼Œå²‚ä¸ç¾å“‰</p><p><strong>ç»†èŠ‚äºŒï¼šæ³¨æ„å¯¼å…¥æ•°æ®åˆ°åˆ†æ¡¶ä¸­ï¼Œè¦ç”¨insertï¼Œä¸” è®¾ç½®<code>hive.enforce.bucketing=true</code>å’Œ<code> hive.enforce.bucketing=true</code></strong></p><p><strong>ç»†èŠ‚ä¸‰ï¼šåˆ†æ¡¶æŠ½æ ·æŸ¥è¯¢</strong></p><p><code>select * from tablename tablesample(bucket x out of y on id);</code></p><p>x è¡¨ç¤ºä»å“ªä¸ªbucketå¼€å§‹æŠ½å–</p><p>y è¡¨ç¤ºæŠ½æ ·é—´éš”ï¼Œå…±æŠ½å– æ€»æ•°/y ä¸ªæ¡¶ï¼Œä¸”xçš„å€¼å¿…é¡»<strong>å°äºç­‰äº</strong>yçš„å€¼</p><p>ä¸¾ä¾‹ï¼šå¦‚æœ x = 1, y = 4 ï¼Œå…±16ä¸ªæ¡¶ï¼Œé‚£ä¹ˆå°†æŠ½å–16/4ä¸ªæ¡¶ï¼Œåˆ†åˆ«æ˜¯ 1ã€5ã€9ã€13</p><h2 id="è¡Œè½¬åˆ—ã€åˆ—è½¬è¡Œ"><a class="header-anchor" href="#è¡Œè½¬åˆ—ã€åˆ—è½¬è¡Œ">Â¶</a>è¡Œè½¬åˆ—ã€åˆ—è½¬è¡Œ</h2><p><strong>è¡Œè½¬åˆ—</strong>ï¼šå°†ä¸åŒè¡Œçš„èšåˆåˆ°ä¸€èµ·</p><p><code>collect_set(col)</code>ï¼šå‡½æ•°<strong>åªæ¥å—åŸºæœ¬æ•°æ®ç±»å‹</strong>ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å°†æŸå­—æ®µçš„å€¼è¿›è¡Œ<strong>å»é‡æ±‡æ€»</strong>(ä¸å»é‡ç”¨list)ï¼Œäº§ç”Ÿarrayç±»å‹å­—æ®µ</p><p>ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    base,</span><br><span class="line">    <span class="keyword">concat_ws</span>(<span class="string">"|"</span>, collect_set(<span class="keyword">name</span>)) <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    <span class="keyword">concat</span>(constellation, <span class="string">","</span>, blood_type) base</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    constellation) t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    base;</span><br></pre></td></tr></table></figure><p><strong>åˆ—è½¬è¡Œ</strong>ï¼šå°†åˆ—æ‹†åˆ†æˆå¤šè¡Œã€‚</p><p><code>explode(col)</code> å°†hiveä¸€åˆ—ä¸­å¤æ‚çš„arrayæˆ–è€…mapç»“æ„æ‹†åˆ†æˆå¤šè¡Œ</p><p><code>LATERAL VIEW udtf(expression) tableAlias AS columnAlias</code> ç”¨äºå’Œsplit, explodeç­‰UDTFä¸€èµ·ä½¿ç”¨ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸€åˆ—æ•°æ®æ‹†æˆå¤šè¡Œæ•°æ®ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥å¯¹æ‹†åˆ†åçš„æ•°æ®è¿›è¡Œèšåˆã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    movie,</span><br><span class="line">    category_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    movie_info <span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(<span class="keyword">category</span>) table_tmp <span class="keyword">as</span> category_name;</span><br></pre></td></tr></table></figure><h2 id="çª—å£å‡½æ•°"><a class="header-anchor" href="#çª—å£å‡½æ•°">Â¶</a>çª—å£å‡½æ•°</h2><p>åŸºæœ¬ç»“æ„ï¼šå‡½æ•° over(èŒƒå›´)  ã€‚ç”¨å‰é¢çš„å‡½æ•°å¤„ç†overä¸­çš„è§„å®šçš„æ•°æ®</p><p>é™¤äº†countã€sumç­‰ä¸€äº›å¸¸ç”¨å‡½æ•°ï¼Œè¿˜æœ‰<strong>åªèƒ½é…åˆoverä½¿ç”¨</strong>çš„å‡½æ•°ï¼š</p><ul><li><code>lag(col,n)</code>ï¼šå¾€å‰ç¬¬nè¡Œæ•°æ®</li><li><code>lead(col,n)</code>ï¼šå¾€åç¬¬nè¡Œæ•°æ®</li><li><code>ntile(n)</code>ï¼šç»™æ•°æ®ç¼–å·ï¼Œç¼–å·ä»1å¼€å§‹ï¼Œå¯¹äºæ¯ä¸€è¡Œï¼ŒNTILEè¿”å›æ­¤è¡Œæ‰€å±çš„ç»„çš„ç¼–å·ã€‚</li><li><code>rank()</code> æ’åºç›¸åŒæ—¶ä¼šé‡å¤ï¼Œæ€»æ•°ä¸ä¼šå˜ï¼Œå¦‚12225668</li><li><code>dense_rank()</code> æ’åºç›¸åŒæ—¶ä¼šé‡å¤ï¼Œæ€»æ•°ä¼šå‡å°‘ï¼Œå¦‚12223445</li><li><code>row_rank()</code> å•çº¯é¡ºåºè®¡ç®—ï¼Œå¦‚12345678</li></ul><p>overé‡Œé¢å¯ä»¥è§„å®šçª—å£èŒƒå›´ï¼š</p><ul><li><code>()</code>ï¼šå…¨éƒ¨æ•°æ®</li><li><code>(partition by xxx order by xxx)</code>ï¼šåˆ†åŒºæœ‰åº</li><li><code>(rows between xxxx and xxxx)</code>ï¼šæ‰‹åŠ¨æŒ‡å®šèŒƒå›´<ul><li><code>current row</code>ï¼šå½“å‰è¡Œ</li><li><code>n preceding</code>ï¼šå¾€å‰nè¡Œæ•°æ®</li><li><code>n following</code>ï¼šå¾€ånè¡Œæ•°æ®</li><li><code>unbounded preceding</code>ï¼š ä»èµ·ç‚¹å¼€å§‹</li><li><code>unbounded following</code>ï¼š åˆ°ç»ˆç‚¹ç»“æŸ</li></ul></li></ul><p>ä¸€äº›ä¾‹å­ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">business.namebusiness.orderdatebusiness.cost</span><br><span class="line">jack2017-01-0110</span><br><span class="line">tony2017-01-0215</span><br><span class="line">jack2017-02-0323</span><br><span class="line">tony2017-01-0429</span><br><span class="line">jack2017-01-0546</span><br><span class="line">jack2017-04-0642</span><br><span class="line">tony2017-01-0750</span><br><span class="line">jack2017-01-0855</span><br><span class="line">mart2017-04-0862</span><br><span class="line">mart2017-04-0968</span><br><span class="line">neil2017-05-1012</span><br><span class="line">mart2017-04-1175</span><br><span class="line">neil2017-06-1280</span><br><span class="line">mart2017-04-1394</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ1ï¼‰æŸ¥è¯¢åœ¨2017å¹´4æœˆä»½è´­ä¹°è¿‡çš„é¡¾å®¢åŠæ€»äººæ•°ï¼Œover()é’ˆå¯¹groupbyåçš„å…¨éƒ¨æ•°æ®</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">over</span> () </span><br><span class="line"><span class="keyword">from</span> business </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    <span class="keyword">substring</span>(orderdate,<span class="number">1</span>,<span class="number">7</span>) = <span class="string">'2017-04'</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">name</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ2ï¼‰æŸ¥è¯¢é¡¾å®¢çš„è´­ä¹°æ˜ç»† å¹¶ è®©costæŒ‰ç…§æ—¥æœŸè¿›è¡Œç´¯åŠ </span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">cost</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> orderdate) </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    business;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ3ï¼‰æŸ¥çœ‹é¡¾å®¢ä¸Šæ¬¡çš„è´­ä¹°æ—¶é—´ï¼Œåœ¨çª—å£ä¸­åˆ†åŒºæ’åº</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>, </span><br><span class="line">    lag(orderdate, <span class="number">1</span>, <span class="string">'1970-01-01'</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> orderdate)</span><br><span class="line"><span class="keyword">from</span> business;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ4ï¼‰æŸ¥è¯¢å‰20%æ—¶é—´çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ åˆ†ç»„å·</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>, </span><br><span class="line">    ntile(<span class="number">5</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate) sorted</span><br><span class="line"><span class="keyword">from</span> business; t1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿‡æ»¤å‡ºç»„å·ä¸º1çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>, </span><br><span class="line">    ntile(<span class="number">5</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate) sorted</span><br><span class="line"><span class="keyword">from</span> business) t1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    sorted = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ5ï¼‰è®¡ç®—æ¯ä¸ªäººæ¶ˆè´¹çš„æ’å</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>,</span><br><span class="line">    <span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">cost</span> <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    business;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;hiveä¸­ä¸€äº›DMLçš„æ“ä½œ&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="hive" scheme="http://yoursite.com/tags/hive/"/>
    
  </entry>
  
  <entry>
    <title>hive-DDL</title>
    <link href="http://yoursite.com/2019/09/17/hive-DDL/"/>
    <id>http://yoursite.com/2019/09/17/hive-DDL/</id>
    <published>2019-09-17T12:29:08.000Z</published>
    <updated>2019-09-21T03:54:54.275Z</updated>
    
    <content type="html"><![CDATA[<p>hiveä¸­ä¸€äº›DDLçš„æ“ä½œ</p><a id="more"></a><h1>DDL</h1><p>DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰ç”¨æ¥å¤„ç†æ•°æ®åº“ä¸­çš„å„ç§å¯¹è±¡ï¼Œå¦‚æ•°æ®åº“ã€è¡¨ç­‰</p><h2 id="æ•°æ®åº“-database"><a class="header-anchor" href="#æ•°æ®åº“-database">Â¶</a>æ•°æ®åº“(database)</h2><h3 id="å¢"><a class="header-anchor" href="#å¢">Â¶</a>å¢</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå®ƒåœ¨HDFSä¸Šçš„é»˜è®¤å­˜å‚¨è·¯å¾„æ˜¯/user/hive/warehouse/db_hive.db</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> db_hive;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º å¹¶ æŒ‡å®šæ•°æ®åº“åœ¨HDFSä¸Šå­˜æ”¾çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> db_hive2 location <span class="string">'/db_hive2.db'</span>;</span><br></pre></td></tr></table></figure><h3 id="æŸ¥"><a class="header-anchor" href="#æŸ¥">Â¶</a>æŸ¥</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¾ç¤ºæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºæ•°æ®åº“è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">desc database extended db_hive;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">use</span> db_hive;</span><br></pre></td></tr></table></figure><h3 id="æ”¹"><a class="header-anchor" href="#æ”¹">Â¶</a>æ”¹</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> db_hive <span class="keyword">set</span> dbproperties(<span class="string">'createtime'</span>=<span class="string">'20190917'</span>);</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šæ•°æ®åº“çš„å…¶ä»–å…ƒæ•°æ®ä¿¡æ¯éƒ½æ˜¯ä¸å¯æ›´æ”¹çš„ï¼ŒåŒ…æ‹¬æ•°æ®åº“åå’Œæ•°æ®åº“æ‰€åœ¨çš„ç›®å½•ä½ç½®ã€‚è¿™ä¸ªä¿®æ”¹åªæ˜¯ä¿®æ”¹<code>DBPROPERTIES</code>é‡Œçš„é”®å€¼å¯¹ã€‚</p><h3 id="åˆ "><a class="header-anchor" href="#åˆ ">Â¶</a>åˆ </h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">exists</span> db_hive;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶åˆ é™¤éç©ºæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> db_hive <span class="keyword">cascade</span>;</span><br></pre></td></tr></table></figure><h2 id="è¡¨-table"><a class="header-anchor" href="#è¡¨-table">Â¶</a>è¡¨(table)</h2><h3 id="å¢-v2"><a class="header-anchor" href="#å¢-v2">Â¶</a>å¢</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">EXTERNAL</span>] <span class="keyword">TABLE</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] table_name </span><br><span class="line">[(col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)] </span><br><span class="line">[<span class="keyword">COMMENT</span> table_comment] <span class="comment">-- æ³¨é‡Š</span></span><br><span class="line">[PARTITIONED <span class="keyword">BY</span> (col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)] <span class="comment">-- åˆ†åŒºè¡¨</span></span><br><span class="line">[CLUSTERED <span class="keyword">BY</span> (col_name, col_name, ...) <span class="comment">-- åˆ†æ¡¶è¡¨</span></span><br><span class="line">[SORTED <span class="keyword">BY</span> (col_name [<span class="keyword">ASC</span>|<span class="keyword">DESC</span>], ...)] <span class="keyword">INTO</span> num_buckets BUCKETS] <span class="comment">-- ä¸å¸¸ç”¨</span></span><br><span class="line">[<span class="keyword">ROW</span> <span class="keyword">FORMAT</span> row_format] <span class="comment">-- å®šä¹‰æ¯è¡Œçš„æ ¼å¼</span></span><br><span class="line">[<span class="keyword">STORED</span> <span class="keyword">AS</span> file_format] <span class="comment">-- æŒ‡å®šå­˜å‚¨æ–‡ä»¶ç±»å‹</span></span><br><span class="line">[LOCATION hdfs_path] <span class="comment">-- æŒ‡å®šè¡¨åœ¨HDFSä¸Šçš„å­˜å‚¨ä½ç½®</span></span><br></pre></td></tr></table></figure><p><strong>ä¸€äº›ç»†èŠ‚ï¼š</strong></p><ul><li><strong>å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨</strong></li></ul><p><code>CREATE EXTERNAL TABLE</code> ç”¨äºåˆ›å»ºå¤–éƒ¨è¡¨ï¼Œé»˜è®¤æ˜¯å†…éƒ¨è¡¨ï¼ˆç®¡ç†è¡¨ï¼‰ã€‚å®ƒä»¬çš„åŒºåˆ«æ˜¯ åˆ é™¤å¤–éƒ¨è¡¨å¹¶ä¸ä¼šåˆ é™¤HDFSä¸­çš„çš„æ•°æ®ï¼Œåªä¼šåˆ é™¤mysqlä¸­çš„å…ƒæ•°æ®ï¼›è€Œåˆ é™¤å†…éƒ¨è¡¨éƒ½ä¼šåˆ é™¤ã€‚</p><p>å¯ä»¥è¿™æ ·ç†è§£å¤–éƒ¨è¡¨ï¼šHDFSä¸Šçš„æ•°æ®æ˜¯å…¬æœ‰çš„ï¼ŒæŸä¸ªå®¢æˆ·ç«¯å»ºä¸€äº†ä¸ªhiveè¡¨å…³è”ä½¿ç”¨å®ƒï¼Œç”Ÿæˆå…ƒæ•°æ®ï¼Œå½“è¯¥å®¢æˆ·ä¸ç”¨æ—¶ï¼Œåªåˆ é™¤ä»–çš„å…ƒæ•°æ®å’Œhiveè¡¨å°±è¡Œï¼Œå…¬æœ‰æ•°æ®ä»ç„¶å­˜åœ¨ã€‚</p><ul><li><strong>åˆ†åŒºè¡¨</strong></li></ul><p>æ¯ä¸ªåˆ†åŒº å¯¹åº”ä¸€ä¸ªHDFSæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹é‡ŒåŒ…å«è¯¥åˆ†åŒºæ‰€æœ‰çš„æ•°æ®ã€‚åœ¨æŸ¥è¯¢æ—¶ï¼Œå¯é€šè¿‡ WHERE æŒ‡å®šæŸ¥è¯¢æ‰€éœ€è¦çš„åˆ†åŒºï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šæé«˜å¾ˆå¤šã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å»ºè¡¨ï¼š</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test1(<span class="keyword">id</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="keyword">string</span>)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">month</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’å…¥æ•°æ®åˆ°æŒ‡å®šåˆ†åŒºï¼š</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/xxxx'</span> <span class="keyword">into</span> <span class="keyword">table</span> test1 <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201909'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶ï¼Œä¼šæ•°æ®ä¼šä¿å­˜åœ¨ /user/hive/warehouse/test1/month=201909 ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æŒ‡å®šåˆ†åŒºçš„æ•°æ®ï¼ˆå¯ä»¥ç›´æ¥å°†åˆ†åŒºä½œä¸ºå­—æ®µç”¨ï¼‰</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test1 <span class="keyword">where</span> <span class="keyword">month</span>=<span class="string">'201909'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># äºŒçº§åˆ†åŒºè¡¨</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test2(<span class="keyword">id</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="keyword">string</span>)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">month</span> <span class="keyword">string</span>, <span class="keyword">day</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br></pre></td></tr></table></figure><ul><li><strong>å…ƒæ•°æ®å’ŒçœŸå®æ•°æ®</strong></li></ul><p>å…ƒæ•°æ®å­˜åœ¨mysqlä¸­ï¼ŒåŒ…å«æ•°æ®åº“ä¿¡æ¯ï¼šIDã€æè¿°ã€HDFSè·¯å¾„ã€æ•°æ®åº“åã€æ‰€æœ‰è€…ï¼›åˆ†åŒºä¿¡æ¯ï¼›å­—æ®µä¿¡æ¯ç­‰ç­‰ã€‚è€ŒçœŸå®æ•°æ®éƒ½å­˜åœ¨HDFSä¸­ã€‚</p><p><strong>å®ƒä»¬å¯ä»¥è‡ªç”±ç‹¬ç«‹å­˜åœ¨</strong>ï¼Œå¦‚å¤–éƒ¨è¡¨å¯ä»¥ç›´æ¥åˆ é™¤å…ƒæ•°æ®ã€‚å› æ­¤ï¼Œåˆ›å»ºæ•°æ®æ—¶ï¼Œå¦‚æœç›´æ¥æ”¾å…¥åˆ†åŒºä¸­ï¼Œç”±äºå…ƒæ•°æ®ä¸­æ²¡æœ‰åˆ†åŒºä¿¡æ¯ï¼Œæ— æ³•ç”¨whereæŸ¥åˆ°å®ƒï¼Œè™½ç„¶æ•°æ®å­˜åœ¨ã€‚å¯ä»¥é€šè¿‡è¡¥å……åˆ†åŒºä¿¡æ¯ æˆ–è€… æ‰§è¡Œä¿®å¤å‘½ä»¤ï¼Œè®©åˆ†åŒºè¡¨å’Œæ•°æ®äº§ç”Ÿå…³è”ã€‚</p><p>æˆ‘çš„ç†è§£ï¼šå…ˆæœ‰æ•°æ®ï¼Œåæœ‰hiveã€‚hiveè¦åšçš„äº‹å°±æ˜¯å…³è”åˆ°æ•°æ®ï¼ˆç”Ÿæˆå…ƒæ•°æ®ï¼‰ï¼Œç„¶åCRUDå®ƒã€‚</p><h3 id="æ”¹-v2"><a class="header-anchor" href="#æ”¹-v2">Â¶</a>æ”¹</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> table_name <span class="keyword">rename</span> <span class="keyword">to</span> new_table_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ åˆ—</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">add</span> <span class="keyword">columns</span>(newdesc <span class="keyword">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°åˆ—</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">change</span> <span class="keyword">column</span> <span class="keyword">id</span> <span class="keyword">desc</span> <span class="built_in">int</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢åˆ—</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">replace</span> <span class="keyword">columns</span>(<span class="keyword">name</span> <span class="keyword">string</span>, loc <span class="keyword">string</span>);</span><br></pre></td></tr></table></figure><h3 id="æŸ¥-v2"><a class="header-anchor" href="#æŸ¥-v2">Â¶</a>æŸ¥</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¾ç¤ºè¡¨</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºè¡¨ä¿¡æ¯</span></span><br><span class="line">desc tablename;</span><br></pre></td></tr></table></figure><h3 id="åˆ -v2"><a class="header-anchor" href="#åˆ -v2">Â¶</a>åˆ </h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> test1;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;hiveä¸­ä¸€äº›DDLçš„æ“ä½œ&lt;/p&gt;
    
    </summary>
    
      <category term="å¤§æ•°æ®" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="hive" scheme="http://yoursite.com/tags/hive/"/>
    
  </entry>
  
</feed>
