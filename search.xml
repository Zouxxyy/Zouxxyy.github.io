<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>æˆ‘çš„2019</title>
    <url>/2019/12/31/%E6%88%91%E7%9A%842019/</url>
    <content><![CDATA[<p>2019å°ç»“ï¼Œå¤šå›¾æ…ç‚¹</p>
<a id="more"></a>
<h1>github</h1>
<p>ä¸€åº¦æ‰§ç€commitï¼Œä¸€åº¦è§‰å¾—å¤ªæ°´ï¼Œä¸€åº¦åˆæ‰§ç€ï¼Œä¸€åº¦åˆâ€¦ <strong>å¸Œæœ›æ˜å¹´åŠ æ²¹ï¼Œäº‰å–è´¡çŒ®PR</strong></p>
<p><img src="https://i.loli.net/2019/12/31/UtnVwE4IDSa1cZe.png" alt></p>
<h1>Hexo</h1>
<p>2019å¹´ï¼Œåœ¨å°ç ´ç«™å†™(shui)äº†<strong>49ç¯‡æ–‡(shui)ç« (wen)</strong>ã€‚å­¦ä¹ ä¸Šï¼Œæ‰“60åˆ†å§ï¼Œå‹‰å¼ºåŠæ ¼ï¼Œæ˜å¹´è¦æ›´åŠ åŠªåŠ›ï¼</p>
<p><img src="https://i.loli.net/2019/12/31/ZuN1XwA7nH8ylsf.png" alt></p>
<h1>è¯»ä¹¦</h1>
<p>æ¬£èµæ¥è‡ªè±†ç“£çš„èœœæ±é»‘è‰²æ•£ç‚¹å›¾ï¼Œä¸€æ¬¡æ›´æ–°åå˜æˆäº†è¿™æ ·ï¼Œå®åœ¨æ— åŠ›åæ§½</p>
<p><img src="https://i.loli.net/2019/12/31/PLiUoA8uN4nfsBb.png" alt></p>
<p>å¾®ä¿¡è¯»ä¹¦çš„2019æˆç»©å•ï¼Œ<strong>å‹‰å¼ºè¶…è¿‡å¹³å‡æ°´å¹³?!</strong> ä»Šå¹´ç›¸æ¯”å»å¹´çƒ­æƒ…é™ä½äº†ä¸å°‘ï¼Œæ„Ÿè§‰å¾ˆéš¾é‡åˆ°è®©äººçœ¼å‰ä¸€äº®çš„ä¹¦äº†ã€‚</p>
<p>ä»Šå¹´çœ‹è¿‡æœ€å¥½çœ‹çš„3æœ¬æ˜¯ï¼š<strong>ã€Šå¹³å‡¡çš„ä¸–ç•Œã€‹ ã€Šéœä¹±æ—¶æœŸçš„çˆ±æƒ…ã€‹ ã€Šè¿½é£ç­çš„äººã€‹</strong>ã€‚ç»å…¸ä¸æ„§æ˜¯ç»å…¸ï½</p>
<p>å¤¸å¤¸<strong>è‰¯å¿ƒ</strong>çš„å¾®ä¿¡è¯»ä¹¦ï¼šå¼€å±€ä¸€æ¡ç‹—ï¼Œ<strong>æ— çº¿å¡å…¨é ç™½å«–</strong>ã€‚å€˜è‹¥æ”¶è´¹ï¼Œæˆ‘å¿…å¥‰é™ªã€‚</p>
<p><img src="https://i.loli.net/2019/12/31/IKZmn3JNlhv8BT7.jpg" alt></p>
<h1>billbill</h1>
<p>9æœˆå¼€å§‹ç©çš„ï¼ŒæŠ•äº†9ç¯‡ï¼Œè‡ªå¨±è‡ªä¹åŠ æœ‹å‹åœˆå½¢æˆå®Œç¾é—­ç¯ã€‚å¥ˆä½•ç”»(A)è´¨(V)ä¸å¿ç›´è§†ï¼ŒçœŸæƒ³æ”¾å¼ƒï¼Œå¸Œæœ›<strong>ç‹è€…çš„è‡ªåŠ¨å‰ªè¾‘ç”»è´¨èƒ½æå‡ç‚¹</strong>ï¼</p>
<p>ä¹Ÿå¤¸å¤¸Bç«™ï¼Œåœ¨Bç«™ä¸Šå­¦ä¹ äº†å¾ˆå¤šå…è´¹å­¦ä¹ èµ„æºï¼Œè€Œä¸”ç”¨æˆ·ä½“éªŒä¹ŸæŒºä¸é”™çš„ï¼Œæœç„¶ç¨‹(si)åº(fei)å‘˜(zai)æ‡‚äºŒæ¬¡å…ƒã€‚è‡³äºå¤§ä¼šå‘˜å˜›ï¼Œä¸‹æ¬¡ä¸€å®šï¼Œãƒ¾ï¾‰â‰§âˆ€â‰¦)o</p>
<p><img src="https://i.loli.net/2019/12/31/sZIMtDVLfSniEPd.png" alt></p>
<h1>éŸ³ä¹</h1>
<p>2020å¹´ï¼Œä¹Ÿè¦<strong>å°†éä¸»æµè´¯å½»åˆ°åº•</strong>ï¼å¹´åº¦å¬çš„æœ€å¤šç«Ÿç„¶æ˜¯åµ©å“¥çš„ï¼Œæ˜¯ä¸æ˜¯è®¡ç®—é”™äº†ï¼Ÿï¼Ÿ</p>
<p><img src="https://i.loli.net/2019/12/31/Oq9WUB1KQ3gMj7s.jpg" alt></p>
<h1>ç‹è€…è£è€€</h1>
<p>äººè€äº†ååº”è·Ÿä¸ä¸Šäº†ï¼Œæ··æ··ç‹è€…å°±è¡Œã€‚è¯è¯´ï¼Œæˆ‘çš„<strong>æç™½è£è€€å…¸è—åˆè·³ç¥¨äº†</strong>ï¼Œ<strong>éŸ©ä¿¡çš„é¼ å¹´ä¼ è¯´è¢«ä¼½ç½—æŠ¢äº†</strong>ã€‚ğŸ¶ ç­–åˆ’ï¼Œæˆ‘è¦è½¬æˆ˜éš”å£lolæ‰‹æ¸¸ï¼</p>
<p><img src="https://i.loli.net/2019/12/31/y9G4En6eDrL2vHh.jpg" alt></p>
<h1>2020 åŠ æ²¹ï¼</h1>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
  </entry>
  <entry>
    <title>åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ-Git</title>
    <url>/2019/12/31/%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F-Git/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦åŒ…æ‹¬Gitçš„ç”¨æ³•åŠ åº•å±‚</p>
<h1>ä½¿ç”¨</h1>
<h2 id="åˆå§‹åŒ–ç›¸å…³"><a class="header-anchor" href="#åˆå§‹åŒ–ç›¸å…³">Â¶</a>åˆå§‹åŒ–ç›¸å…³</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># --system æ“ä½œç³»ç»Ÿçº§åˆ«ï¼› --global ç”¨æˆ·çº§åˆ«ï¼› ä¸åŠ ï¼š é¡¹ç›®çº§åˆ« </span></span><br><span class="line">$ git config --global user.name <span class="string">"zouxxyy"</span></span><br><span class="line">$ git config --global user.email <span class="string">"xxxxxxxxxxxxxx"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é…ç½®</span></span><br><span class="line">$ git config --list</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºgitå¯¹è±¡ï¼Œä¼šç”Ÿæˆ .git ç›®å½•</span></span><br><span class="line">$ git init</span><br><span class="line">$ ls</span><br><span class="line">HEAD                 æŒ‡ç¤ºå½“å‰åˆ†æ”¯çš„æ–‡ä»¶</span><br><span class="line">config               é…ç½®æ–‡ä»¶</span><br><span class="line">hooks.  ï¼ˆç›®å½•ï¼‰      å­˜æ”¾é’©å­è„šæœ¬ï¼Œæ¯”å¦‚æäº¤ä»£ç å‰æˆ–è€…åçš„è‡ªåŠ¨æ‰§è¡Œæ“ä½œ</span><br><span class="line">objects ï¼ˆç›®å½•ï¼‰      å­˜æ”¾æ‰€æœ‰å†å²è®°å½•çš„</span><br><span class="line">branches             æŒ‡ç¤ºç›®å‰è¢«æ£€æµ‹å‡ºçš„åˆ†æ”¯</span><br><span class="line">description          ä»“åº“æè¿°æ€§ä¿¡æ¯çš„æ–‡ä»¶</span><br><span class="line">info    ï¼ˆç›®å½•ï¼‰      å­˜æ”¾å…¨å±€æ€§çš„æ’é™¤æ–‡ä»¶ã€‚æ¯”å¦‚ mac è¿›å»æŸ¥çœ‹å°±æœ‰.DS_Store</span><br><span class="line">refs    ï¼ˆç›®å½•ï¼‰      å­˜æ”¾åˆ†æ”¯ä¸tagsçš„æäº¤å¯¹è±¡çš„æŒ‡é’ˆ</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="æ–‡ä»¶ç›¸å…³"><a class="header-anchor" href="#æ–‡ä»¶ç›¸å…³">Â¶</a>æ–‡ä»¶ç›¸å…³</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ æ–°æ–‡ä»¶ï¼ˆç”±æœªè·Ÿè¸ªåˆ°è·Ÿè¸ªçŠ¶æ€ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æš‚å­˜çŠ¶æ€ï¼‰æˆ–è€…æ·»åŠ ä¿®æ”¹æ–‡ä»¶ï¼ˆç”±ä¿®æ”¹çŠ¶æ€åˆ°æš‚å­˜çŠ¶æ€ï¼‰ï¼ˆç²—ç•¥è¿™æ ·è¯´ï¼Œå…¶å®åº•å±‚åšäº†æ›´å¤šäº‹ï¼‰</span></span><br><span class="line">$ git add test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æäº¤æ–‡ä»¶ï¼ˆç”±æš‚å­˜çŠ¶æ€åˆ°æäº¤çŠ¶æ€ï¼‰ï¼›å¯åŠ å‚æ•° -a è·³è¿‡ add æ­¥éª¤ï¼ˆæœªè·Ÿè¸ªçš„ä¸èƒ½æäº¤ï¼‰</span></span><br><span class="line">$ git commit -m <span class="string">"commit message"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ–‡ä»¶çš„çŠ¶æ€</span></span><br><span class="line">$ git status</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœªè¢« add çš„ä¿®æ”¹</span></span><br><span class="line">$ git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å·² add ä½†æœªè¢« commit çš„ä¿®æ”¹</span></span><br><span class="line">$ git diff --staged</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ–‡ä»¶ ï¼ˆåŒæ—¶è®©æ–‡ä»¶ç”±è·Ÿè¸ªå˜æˆæœªè·Ÿè¸ªçŠ¶æ€ï¼‰ï¼ˆæ³¨æ„å®ƒ å’Œæ‰‹åŠ¨åˆ é™¤æ–‡ä»¶å†æ‰§è¡Œ git add æ•ˆæœä¸€æ ·ï¼‰</span></span><br><span class="line">$ git rm test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line">$ git mv test.txt new.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ commit logï¼›å¯åŠ  --oneline å‚æ•°ç®€å†™</span></span><br><span class="line">$ git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®Œæ•´ commit logï¼ˆåªè¦æ”¹åŠ¨äº†HEADï¼‰</span></span><br><span class="line">$ git reflog</span><br></pre></td></tr></table></figure>
<h2 id="åˆ†æ”¯ç›¸å…³"><a class="header-anchor" href="#åˆ†æ”¯ç›¸å…³">Â¶</a>åˆ†æ”¯ç›¸å…³</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºåˆ†æ”¯</span></span><br><span class="line">$ git branch branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ†æ”¯ (åˆ‡æ¢å‰ä¿è¯ status å¹²å‡€)</span></span><br><span class="line">$ git checkout branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå¹¶åˆ‡æ¢</span></span><br><span class="line">$ git checkout -b branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯ å¯åŠ å‚æ•° -v æŸ¥çœ‹å®ƒä»¬çš„æœ€åä¸€æ¬¡æäº¤</span></span><br><span class="line">$ git branch</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤åˆ†æ”¯ï¼ˆéœ€å…ˆåˆ‡åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ï¼‰å¯åŠ å‚æ•° -D å¼ºåˆ¶åˆ é™¤</span></span><br><span class="line">$ git branch -d branchname</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºåˆ†æ”¯ï¼Œå¹¶æŒ‡å‘æŒ‡å®šçš„æäº¤å¯¹è±¡ (æ—¶å…‰æœº)</span></span><br><span class="line">$ git branch branchname commitHash</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ†æ”¯åˆå¹¶ ï¼ˆåˆå¹¶å‰åˆ‡å›ä¸»åˆ†æ”¯ï¼Œå†åˆå¹¶éœ€è¦åˆå¹¶çš„åˆ†æ”¯ï¼‰</span></span><br><span class="line"><span class="comment"># åˆå¹¶å¯èƒ½ä¼šäº§ç”Ÿå†²çªï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹å†²çªçš„æ–‡ä»¶ï¼Œå†æäº¤</span></span><br><span class="line">$ git merge otherBranch</span><br></pre></td></tr></table></figure>
<h2 id="stashç›¸å…³"><a class="header-anchor" href="#stashç›¸å…³">Â¶</a>stashç›¸å…³</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æœ‰æ—¶æƒ³åˆ‡åˆ†æ”¯ï¼Œä½†åˆä¸æƒ³æäº¤ï¼Œå¯ä»¥ç”¨åˆ° stash åŠŸèƒ½ï¼Œæ˜¯ä¸€ç§æš‚å­˜çš„æ ˆã€‚è¿™ä¸ªæ ˆæ˜¯é’ˆå¯¹åˆ†æ”¯çš„ï½</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰åˆ†æ”¯çš„ stash</span></span><br><span class="line">$ git stash list</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æœªæäº¤çš„æ”¹åŠ¨ å…¥æ ˆï¼ˆæ¥ç€å¯ä»¥å®‰å…¨æ‰§è¡Œåˆ‡åˆ†æ”¯æ“ä½œï¼‰</span></span><br><span class="line">$ git stash</span><br><span class="line"></span><br><span class="line"><span class="comment"># ï¼ˆåˆ‡å›åˆ†æ”¯åï¼‰å¼¹å‡º æ”¹åŠ¨</span></span><br><span class="line">$ git pop</span><br><span class="line"></span><br><span class="line"><span class="comment"># åé¢ä¸¤ä¸ªä¸€èˆ¬ä¸ç”¨ï¼Œæˆ‘ä»¬æ ˆé‡Œåªæ”¾ä¸€ä¸ªå…ƒç´ ï¼Œgit stash å…¥æ ˆï¼Œgit pop å‡ºæ ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åªå–æŒ‡å®šæ”¹åŠ¨ï¼Œä¸åˆ é™¤</span></span><br><span class="line">$ git stash apply stashName</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æŒ‡å®šçš„æ ˆé‡Œçš„ä¸œè¥¿</span></span><br><span class="line">$ git stash drop stashName</span><br></pre></td></tr></table></figure>
<h2 id="å›é€€ç›¸å…³"><a class="header-anchor" href="#å›é€€ç›¸å…³">Â¶</a>å›é€€ç›¸å…³</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ’¤å›å·¥ä½œç›®å½•çš„ä¿®æ”¹ï¼ˆæœªadd -&gt; æœªä¿®æ”¹ï¼‰</span></span><br><span class="line">$ git checkout -- fileName</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›æš‚å­˜åŒºçš„ä¿®æ”¹ ï¼ˆæœªcommit -&gt; æœªaddï¼‰</span></span><br><span class="line">$ git reset [HEAD] fileName</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ç”¨äºä¿®æ”¹åˆšåˆšæäº¤çš„messageï¼ˆç›¸å½“äºåé€€ä¸€æ­¥ï¼Œå†é‡æ–°æäº¤ï¼‰</span></span><br><span class="line">$ git commit --amend</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„ä¸‹é¢3ä¸ªå‘½ä»¤éƒ½å¯ä»¥æ’¤å›åˆ°æŒ‡å®šæäº¤å¯¹è±¡ï¼ˆæŠŠ HEAD~ æ”¹ä¸ºæŒ‡å®šçš„ commitHash å³å¯ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›ä¸Šä¸€æ¬¡æäº¤ ï¼ˆcommit -&gt; æœªcommitï¼‰</span></span><br><span class="line">$ git reset --soft HEAD~</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›ä¸Šä¸€æ¬¡æäº¤åŒæ—¶æ’¤å›æš‚å­˜åŒºçš„ä¿®æ”¹ ï¼ˆcommit -&gt; æœªaddï¼‰</span></span><br><span class="line">$ git reset [--mix] HEAD~</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›ä¸Šä¸€æ¬¡æäº¤åŒæ—¶æ’¤å›æš‚å­˜åŒºçš„ä¿®æ”¹åŒæ—¶æ’¤å›å·¥ä½œç›®å½•çš„ä¿®æ”¹ ï¼ˆcommit -&gt; æœªä¿®æ”¹ï¼Œå±é™©ï¼ï¼‰</span></span><br><span class="line">$ git reset --hard HEAD~</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤å›å°‘ç”¨ reset --hardï¼Œæœ€å¥½ä½¿ç”¨ branch </span></span><br><span class="line">$ git branch recoverBranchName commitHash</span><br></pre></td></tr></table></figure>
<h2 id="æ ‡ç­¾ç›¸å…³"><a class="header-anchor" href="#æ ‡ç­¾ç›¸å…³">Â¶</a>æ ‡ç­¾ç›¸å…³</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰tag</span></span><br><span class="line">$ git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“tag</span></span><br><span class="line">$ git tag tagName commitHash</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æŒ‡å®štag</span></span><br><span class="line">$ git tag -d tagName</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡åˆ°æŒ‡å®štagï¼Œç„¶ååˆ›æ–°åˆ†æ”¯ï¼Œé˜²æ­¢å¤´éƒ¨åˆ†ç¦»</span></span><br><span class="line">$ git checkout tagName</span><br><span class="line">$ git checkout -b branchName</span><br></pre></td></tr></table></figure>
<h2 id="è¿œç¨‹ç›¸å…³"><a class="header-anchor" href="#è¿œç¨‹ç›¸å…³">Â¶</a>è¿œç¨‹ç›¸å…³</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å…¨éƒ¨è¿œç¨‹åˆ†æ”¯</span></span><br><span class="line">$ git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è¿œç¨‹åˆ†æ”¯åˆ«å(æ³¨æ„ï¼šorgin åªä¸ªåˆ«å)</span></span><br><span class="line">$ git remote add orgin https://xxxx.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…‹éš†è¿œç¨‹ä»“åº“åˆ°æœ¬åœ°ï¼ˆæ­¤æ—¶è‡ªåŠ¨åˆ›å»ºå…¨éƒ¨è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼ŒåŒæ—¶ç”Ÿæˆä¸€ä¸ªå…³è”è¿œç¨‹masterçš„æœ¬åœ°åˆ†æ”¯ï¼ˆæ³¨æ„ï¼‰ï¼‰</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://xxxx.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±æœ¬åœ°åˆ†æ”¯åˆ›å»ºè¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼Œå†æ¨åˆ°è¿œç¨‹åˆ†æ”¯ï¼Œä½†å¹¶ä¸å…³è”ï¼ˆæ³¨æ„ï¼‰</span></span><br><span class="line"><span class="comment"># æ¨èä»…å½“åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œå¹¶æƒ³æŠŠå®ƒæ¨åˆ°è¿œç¨‹æ—¶ï¼Œæ‰ä½¿ç”¨å®ƒï¼›å¹¶ä¸”æ¥ç€æ‰§è¡Œå…³è”æ“ä½œï¼Œä¹Ÿå°±ä¸‹ä¸€è¡Œï¼Œä¹‹åä»…ç”¨ git push å³å¯</span></span><br><span class="line">$ git push orgin branchName</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°åˆ†æ”¯ï¼ˆå·²åˆ›å»ºï¼‰å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</span></span><br><span class="line">$ git branch -u orgin/branchName</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–è¿œç¨‹åˆ†æ”¯ï¼ˆå…¨éƒ¨åˆ†æ”¯ï¼‰åˆ°è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ä¸­</span></span><br><span class="line"><span class="comment"># æ¨èä»…å½“è¿œç¨‹æœ‰äº†æ–°åˆ†æ”¯æ—¶ï¼Œæ‰ä½¿ç”¨å®ƒï¼ˆæ³¨æ„ï¼‰</span></span><br><span class="line">$ git fetch orgin</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæœ¬åœ°åˆ†æ”¯ï¼ŒåŒæ—¶å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</span></span><br><span class="line">$ git branch -b branchName orgin/branchName</span><br><span class="line">$ git branch --track orgin/branchName (æ•ˆæœä¸€æ ·ï¼Œå¿«æ·å†™æ³•)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å»è¿œç¨‹åˆ†æ”¯åˆ°è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯å’Œæœ¬åœ°åˆ†æ”¯ï¼ˆæœ¬åœ°åˆ†æ”¯å·²ç»å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼‰ï¼Œç›¸å½“äºæ‰§è¡Œ git fetch + git merge</span></span><br><span class="line">$ git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è¿œç¨‹åˆ†æ”¯</span></span><br><span class="line">$ git push orgin --delete branchName</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ²¡ç”¨è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯ï¼Œå¹¶åˆ é™¤</span></span><br><span class="line">$ git remote prune orgin --dry-run</span><br><span class="line">$ git remote orgin</span><br></pre></td></tr></table></figure>
<p>çœ‹èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œä½†åªè¦è®°ä½ä¸€ä¸ªé€»è¾‘é“¾å°±å¥½ï¼Œä¹Ÿå°±æ˜¯æŒ‰ä»¥ä¸‹3æ­¥èµ°ï¼š</p>
<ol>
<li>
<p><strong>å»ºç«‹è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</strong></p>
<ul>
<li><code>git clone https://xxxx.git</code></li>
<li><code>git push orgin branchName</code> æ¨<strong>æ–°åˆ†æ”¯</strong>åˆ°è¿œç¨‹</li>
<li><code>git fetch orgin</code> æ‹‰è¿œç¨‹çš„<strong>æ–°åˆ†æ”¯</strong></li>
</ul>
</li>
<li>
<p><strong>æœ¬åœ°åˆ†æ”¯å…³è”è¿œç¨‹è·Ÿè¸ªåˆ†æ”¯</strong></p>
<ul>
<li><code>git checkout branchName</code> åˆ›å»ºæœ¬åœ°æ–°åˆ†æ”¯ï¼ˆå’Œè¿œç¨‹åˆ†æ”¯åŒåï¼‰ å¹¶å…³è” (è¿˜æ˜¯å®ƒç®€å•)</li>
<li><code>git branch -u orgin/branchName</code> å½“å‰åˆ†æ”¯ å…³è”</li>
<li><code>git branch --track orgin/branchName</code> åˆ›å»ºæœ¬åœ°æ–°åˆ†æ”¯ å…³è”</li>
</ul>
</li>
<li>
<p><strong>æ„‰å¿«ä½¿ç”¨</strong></p>
<ul>
<li><code>git pull</code> æ‹‰åˆ°æœ¬åœ°</li>
<li><code>git push</code> æ¨åˆ°è¿œç¨‹ï¼ˆå…ˆ pullï¼Œè§£å†³å†²çªå† pushï¼‰</li>
</ul>
</li>
</ol>
<p>ä¸Šé¢æ˜¯è‡ªå·±å›¢é˜Ÿçš„é¡¹ç›®ï¼ˆ<strong>æœ‰æƒé™</strong>ï¼‰ï¼Œå½“æƒ³ä¸ºå¼€æºé¡¹ç›®åšè´¡çŒ®ï¼ˆ<strong>æ²¡æƒé™</strong>ï¼‰æ—¶ï¼Œä½¿ç”¨ <strong>pull request</strong>ï¼Œ å¤§è‡´æµç¨‹ï¼ˆç”¨åˆ°å†ç ”ç©¶ï¼‰ä¸ºï¼š</p>
<ol>
<li>
<p><strong>folk ä¸€ä»½</strong></p>
</li>
<li>
<p><strong>åœ¨ folk çš„åº“ä¸­ï¼Œä½œå‡ºæ”¹åŠ¨å¹¶æäº¤ï¼Œæ³¨æ„æäº¤å‰å…ˆæ‹‰è¿œç¨‹åº“ï¼Œä¿æŒæœ€æ–°ã€‚</strong></p>
</li>
<li>
<p><strong>è¿›ç½‘ç«™ï¼ˆå¦‚githubï¼‰ï¼Œç‚¹ pullRequest</strong></p>
</li>
</ol>
<h1>åº•å±‚</h1>
<p>git çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸€ç§åœ¨ <code>object</code> ç›®å½•ä¸­å­˜æ”¾çš„ k-v ç±»å‹çš„æ•°æ®ã€‚key æ˜¯ hashå€¼ (å‰ä¸¤ä½æ˜¯å­æ–‡ä»¶å¤¹åï¼Œåé¢æ˜¯æ–‡ä»¶å)ï¼Œvalue æ˜¯ æ•°æ®å†…å®¹ã€‚</p>
<p>æ•°æ®å†…å®¹ åˆ†ä¸º <strong>git å¯¹è±¡</strong>ï¼ˆ<code>blob</code>ï¼‰ã€<strong>æ ‘å¯¹è±¡</strong>ï¼ˆ<code>tree</code>ï¼‰ã€<strong>æäº¤å¯¹è±¡</strong>ï¼ˆ<code>commit</code>ï¼‰</p>
<h2 id="git-å¯¹è±¡"><a class="header-anchor" href="#git-å¯¹è±¡">Â¶</a>git å¯¹è±¡</h2>
<p><strong>ä»£è¡¨æ–‡ä»¶ï¼Œå®ƒæ˜¯çœŸæ­£å­˜æ•°æ®çš„</strong>ã€‚å®ƒæ˜¯ä¸€å¯¹ä¸€çš„ï¼ˆæ³¨æ„ï¼š<strong>ä¸€ä¸ªæ–‡ä»¶çš„å†å²æ–‡ä»¶éƒ½ç®—ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶</strong>ï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‘æ•°æ®åº“ä¸­å†™æ•°æ®ï¼Œå¹¶è¿”å›hashé”®å€¼ã€‚å­˜çš„æ˜¯ä¸€ä¸ªblobå¯¹è±¡</span></span><br><span class="line">$ git <span class="built_in">hash</span>-object -w test.txt</span><br><span class="line">915c628f360b2d8c3edbe1ac65cf575b69029b61</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®æ˜¯ç»è¿‡å‹ç¼©çš„ï¼Œå¯ä»¥ç”¨cat-fileæŸ¥çœ‹è¯¥æ•°æ®</span></span><br><span class="line"><span class="comment"># -p æ˜¾ç¤ºå†…å®¹ï¼› -t æŸ¥çœ‹ç±»å‹</span></span><br><span class="line">$ git cat-file -p 915c628f360b2d8c3edbe1ac65cf575b69029b61</span><br><span class="line">hello git</span><br></pre></td></tr></table></figure>
<h2 id="æ ‘å¯¹è±¡"><a class="header-anchor" href="#æ ‘å¯¹è±¡">Â¶</a>æ ‘å¯¹è±¡</h2>
<p><strong>ä»£è¡¨ç‰ˆæœ¬</strong>ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªæ ‘å¯¹è±¡æŒ‡å‘å¤šä¸ª git å¯¹è±¡ï¼Œå½¢æˆä¸€ä¸ªç‰ˆæœ¬ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æš‚å­˜åŒº å†™å…¥ test.txt çš„é¦–ä¸ªç‰ˆæœ¬ï¼ˆæŒ‡é’ˆä¿¡æ¯ï¼‰</span></span><br><span class="line"><span class="comment"># --add æ–‡ä»¶é¦–æ¬¡æ·»åŠ ï¼›--cacheinfo è¡¨ç¤ºæ·»åŠ çš„æ–‡ä»¶ä½äºgitæ•°æ®åº“ï¼›100644 æ–‡ä»¶ç±»å‹ï¼› test.txt æ–‡ä»¶å</span></span><br><span class="line">$ git update-index --add --cacheinfo 100644 915c628f360b2d8c3edbe1ac65cf575b69029b61 test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æš‚å­˜åŒº</span></span><br><span class="line">$ git ls-files -s</span><br><span class="line">100644 915c628f360b2d8c3edbe1ac65cf575b69029b61 0 test.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆæ ‘å¯¹è±¡ã€‚æš‚å­˜åŒºæœªæ¸…ç©º</span></span><br><span class="line">$ git write-tree	</span><br><span class="line">72203871fa4668ad777833634034dcd3426879db</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ ‘å¯¹è±¡å†…å®¹</span></span><br><span class="line">$ git cat-file -p 72203871fa4668ad777833634034dcd3426879db</span><br><span class="line">100644 blob 915c628f360b2d8c3edbe1ac65cf575b69029b61 test.txt</span><br></pre></td></tr></table></figure>
<h2 id="æäº¤å¯¹è±¡"><a class="header-anchor" href="#æäº¤å¯¹è±¡">Â¶</a>æäº¤å¯¹è±¡</h2>
<p><strong>ç›¸å½“äºå¯¹ç‰ˆæœ¬æ·»åŠ æè¿°ä¿¡æ¯</strong>ã€‚ä¸€ä¸ªæäº¤å¯¹è±¡å°è£…ä¸€ä¸ªæ ‘å¯¹è±¡ï¼Œè€Œä¸”å®ƒæ˜¯<strong>é“¾å¼</strong>çš„ï¼Œé‡Œé¢æŒ‡å‘ä¸Šä¸€ä¸ªæäº¤å¯¹è±¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆæäº¤å¯¹è±¡ï¼Œåæ¥æ ‘å¯¹è±¡hashå€¼</span></span><br><span class="line"><span class="comment"># è¿™é‡Œæ˜¯ç¬¬ä¸€æ¬¡æäº¤ã€‚ä»¥åå¯ä»¥åŠ  -p æŒ‡å®šçˆ¶æäº¤å¯¹è±¡</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'first commit'</span> | git commit-tree 72203871fa4668ad777833634034dcd3426879db</span><br><span class="line">5402d3560f35d66f7f1e4e4665dd63bf3d786495</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æäº¤å¯¹è±¡çš„å†…å®¹</span></span><br><span class="line">$ git cat-file -p 5402d3560f35d66f7f1e4e4665dd63bf3d786495</span><br><span class="line">tree 72203871fa4668ad777833634034dcd3426879db</span><br><span class="line">author zouxxyy &lt;xxxxxxxxx@qq.com&gt; 1575450654 +0800</span><br><span class="line">committer zouxxyy &lt;xxxxxxxxx@qq.com&gt; 1575450654 +0800</span><br><span class="line"></span><br><span class="line">first commit</span><br></pre></td></tr></table></figure>
<h2 id="æ–‡ä»¶ç›¸å…³-v2"><a class="header-anchor" href="#æ–‡ä»¶ç›¸å…³-v2">Â¶</a>æ–‡ä»¶ç›¸å…³</h2>
<ul>
<li>
<p><code>git add test.txt</code> ç›¸å½“äºå…ˆå°†æ–‡ä»¶åšæˆ<code>gitå¯¹è±¡</code>å­˜å…¥<code>object</code> ï¼Œå†å°†å®ƒï¼ˆæŒ‡é’ˆä¿¡æ¯ï¼‰æ”¾å…¥æš‚å­˜åŒºï¼Œç­‰å¾…æäº¤ã€‚è¯¥æ“ä½œæ˜¯<strong>ç»å¯¹å®‰å…¨</strong>çš„ï¼Œå› ä¸ºæ•°æ®å·²ç»å†™å…¥æ–‡ä»¶ä¸­ã€‚æ‰€ä»¥å¯ä»¥ç†è§£ä¸ºå•¥åªæœ‰ <code>git add</code>ï¼Œè€Œæ²¡æœ‰ä»€ä¹ˆ<code>git change</code>ä¹‹ç±»çš„ï¼Œå› ä¸ºä¿®æ”¹ä¹Ÿä¼šåŠ <code>gitå¯¹è±¡</code>ã€‚</p>
</li>
<li>
<p><code>git commit -m &quot;xx&quot;</code> ç”±æš‚å­˜åŒºç”Ÿæˆæ ‘å¯¹è±¡ï¼Œå†ç”Ÿæˆæäº¤å¯¹è±¡ã€‚<strong>æ³¨æ„æš‚å­˜åŒºçš„ä¸œè¥¿ä¸åˆ é™¤</strong></p>
</li>
<li>
<p><code>git rm test.txt</code> <strong>ç›¸å½“äºå°†è¯¥æ–‡ä»¶å¯¹åº”çš„ï¼ˆæŒ‡é’ˆä¿¡æ¯ï¼‰ä»æš‚å­˜åŒºä¸­åˆ é™¤ï¼ŒåŒæ—¶åˆ é™¤å·¥ä½œç›®å½•ä¸­çš„æ–‡ä»¶</strong></p>
</li>
</ul>
<h2 id="åˆ†æ”¯ç›¸å…³-v2"><a class="header-anchor" href="#åˆ†æ”¯ç›¸å…³-v2">Â¶</a>åˆ†æ”¯ç›¸å…³</h2>
<p><strong>åˆ†æ”¯åˆ‡æ¢ä¼šåˆ‡æ¢å·¥ä½œç›®å½•</strong>ï¼Œæ‰€ä»¥åˆ‡æ¢å‰ï¼Œå…ˆæŠŠå½“å‰åˆ†æ”¯è¯¥æäº¤çš„æäº¤äº†ï¼Œ<strong>ä¿è¯å·¥ä½œç›®å½•å¹²å‡€</strong>ã€‚</p>
<ul>
<li>
<p>2ä¸ªé‡è¦çš„ä¸œè¥¿ï¼š</p>
<ul>
<li><code>refs</code> å­˜æ”¾å„ä¸ªåˆ†æ”¯ï¼ˆå’Œtagsï¼‰çš„æäº¤å¯¹è±¡çš„æŒ‡é’ˆï¼ˆhashkeyï¼‰</li>
<li><code>HEAD</code> æŒ‡æ˜å½“å‰åˆ†æ”¯çš„æŒ‡é’ˆä½ç½®</li>
</ul>
</li>
<li>
<p><code>git branch branchname</code> ç›¸å½“äºåœ¨ <code>refs/heads</code> ç›®å½•ä¸­æ–°å»ºä»¥<strong>åˆ†æ”¯å</strong>å‘½åçš„å½“å‰åˆ†æ”¯çš„æäº¤å¯¹è±¡çš„æŒ‡é’ˆ</p>
</li>
<li>
<p><code>git checkout branchname</code> æ›´æ”¹<code>HEAD</code>æ–‡ä»¶ï¼›<strong>åˆ‡æ¢å·¥ä½œç›®å½•</strong>ï¼›<strong>å½±å“æš‚å­˜åŒº</strong></p>
</li>
<li>
<p><code>git commit -m &quot;commit message&quot;</code> æ›´æ–° <code>refs</code> ä¸­å¯¹åº”åˆ†æ”¯çš„æäº¤å¯¹è±¡</p>
</li>
</ul>
<h2 id="å›é€€ç›¸å…³-v2"><a class="header-anchor" href="#å›é€€ç›¸å…³-v2">Â¶</a>å›é€€ç›¸å…³</h2>
<p><code>git checkout branchName</code> å’Œ <code>git reset --hard commitHash</code> çš„åŒºåˆ« ï¼š</p>
<ul>
<li>
<p><code>checkout</code> åªæ”¹HEAD ï¼›<code>reset</code> HEAD å’Œ åˆ†æ”¯æŒ‡é’ˆçš„ä¸€èµ·æ”¹</p>
</li>
<li>
<p><code>checkout</code> å¯¹å·¥ä½œç›®å½•æ˜¯å®‰å…¨çš„ï¼›<code>reset --hard</code> ä¼š<strong>å®Œå…¨å¼ºåˆ¶è¦†ç›–å·¥ä½œç›®å½•</strong></p>
</li>
</ul>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
  </entry>
  <entry>
    <title>sparkæºç -shuffleä¹‹BlockStoreShuffleReader</title>
    <url>/2019/12/30/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BBlockStoreShuffleReader/</url>
    <content><![CDATA[<p>sparkçš„å”¯ä¸€ ShuffleReader ï¼šBlockStoreShuffleReader</p>
<a id="more"></a>
<p>spark ç‰ˆæœ¬ 2.4.3</p>
<h1>å¼•å…¥</h1>
<p><a href="https://zouxxyy.github.io/2019/11/29/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BShuffleManager/" target="_blank" rel="noopener">ä¹‹å‰</a>æè¿‡ï¼Œ<code>getShuffleWrite</code> åªåœ¨ <code>ShuffleMapTask</code> ä¸­å‡ºç°ã€‚</p>
<p>é‚£ä¹ˆ<code>getShuffleRead</code>å‘¢ï¼Ÿç”±äºä¸ç®¡å“ªä¸ª Task éƒ½éœ€è¦è¯»æ•°æ®ï¼Œäºæ˜¯å°±æŠŠè¯¥æ­¥éª¤å°è£…åœ¨RDDçš„<code>computer</code>æ–¹æ³•ä¸­ã€‚ä»¥ä¸‹æ˜¯<code>ShuffleRDD</code>ä¸­çš„<code>computer</code>æ–¹æ³•ã€‚é€šè¿‡è°ƒç”¨ <code>shuffleManager</code> çš„ <code>getReader</code> å°±è·å–äº†æœ¬æ–‡çš„ä¸»è§’<code>BlockStoreShuffleReader</code></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compute</span></span>(split: <span class="type">Partition</span>, context: <span class="type">TaskContext</span>): <span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">C</span>)] = &#123;</span><br><span class="line">  <span class="keyword">val</span> dep = dependencies.head.asInstanceOf[<span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>]]</span><br><span class="line">  <span class="comment">// æ˜¯ä¸æ˜¯è§‰å¾— split.index, split.index + 1 å¾ˆæ€ªï¼Œåé¢ä¼šå‘ç°è¿™æ˜¯æ€ä¹ˆå›äº‹</span></span><br><span class="line">  <span class="type">SparkEnv</span>.get.shuffleManager.getReader(dep.shuffleHandle, split.index, split.index + <span class="number">1</span>, context)</span><br><span class="line">    .read()</span><br><span class="line">    .asInstanceOf[<span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">C</span>)]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>å¤§è‡´æµç¨‹</h1>
<ol>
<li>
<p><strong>è·å–åˆå§‹è¿­ä»£å™¨<code>ShuffleBlockFetcherIterator</code></strong>ï¼ˆ<code>Iterator[(BlockId, InputStream)</code>ï¼‰</p>
</li>
<li>
<p><strong>ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ k,v è¿­ä»£å™¨</strong>ï¼ˆ<code>Iterator[(key, value)]</code>ï¼‰</p>
</li>
<li>
<p><strong>æ·»åŠ readMetricsï¼Œå†å°è£…æˆ<code>InterruptibleIterator</code></strong></p>
</li>
<li>
<p><strong>è¿›è¡Œèšåˆæ“ä½œ</strong>ã€‚åˆ†æœ‰æ— èšåˆï¼Œå½“æœ‰èšåˆæ—¶ï¼Œåˆåˆ†æ˜¯å¦æ‰§è¡Œè¿‡mapèšåˆ</p>
</li>
<li>
<p><strong>è¿›è¡Œæ’åºæ“ä½œ</strong>ã€‚åˆ†æœ‰æ— æ’åºã€‚</p>
</li>
</ol>
<p><code>BlockStoreShuffleReader </code> è¦å¹²çš„äº‹å…¶å®å¾ˆå®¹æ˜“ç†è§£ï¼Œå°±æ˜¯æŠŠ<strong>ä¸åŒ block ä¸­åŒä¸€åˆ†åŒºçš„record</strong>ï¼Œæ‹‰åˆ°æŒ‡å®šçš„ reducer ä¸­ï¼Œå†å¯¹å®ƒè¿›è¡Œ<strong>èšåˆå’Œæ’åº</strong>å³å¯ã€‚ä¸€ä¸ª reducer å¤„ç†ä¸€ä¸ªåˆ†åŒºã€‚</p>
<h1>æºç </h1>
<h2 id="è·å–åˆå§‹è¿­ä»£å™¨ShuffleBlockFetcherIterator"><a class="header-anchor" href="#è·å–åˆå§‹è¿­ä»£å™¨ShuffleBlockFetcherIterator">Â¶</a>è·å–åˆå§‹è¿­ä»£å™¨<code>ShuffleBlockFetcherIterator</code></h2>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–åˆå§‹è¿­ä»£å™¨ ShuffleBlockFetcherIterator</span></span><br><span class="line"><span class="keyword">val</span> wrappedStreams = <span class="keyword">new</span> <span class="type">ShuffleBlockFetcherIterator</span>(</span><br><span class="line">  context,</span><br><span class="line">  blockManager.shuffleClient, <span class="comment">// é»˜è®¤æ˜¯ NettyBlockTransferServiceï¼Œå¦‚æœä½¿ç”¨å¤–éƒ¨shuffleç³»ç»Ÿåˆ™ä½¿ç”¨ ExternalShuffleClient</span></span><br><span class="line">  blockManager,</span><br><span class="line">  <span class="comment">// é€šè¿‡å®ƒå¾—åˆ° 2å…ƒtuple : (BlockManagerId, Seq[(BlockId, BlockSize)])</span></span><br><span class="line">  mapOutputTracker.getMapSizesByExecutorId(handle.shuffleId, startPartition, endPartition),</span><br><span class="line">  serializerManager.wrapStream,</span><br><span class="line">  <span class="comment">// Note: we use getSizeAsMb when no suffix is provided for backwards compatibility</span></span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.getSizeAsMb(<span class="string">"spark.reducer.maxSizeInFlight"</span>, <span class="string">"48m"</span>) * <span class="number">1024</span> * <span class="number">1024</span>,</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.getInt(<span class="string">"spark.reducer.maxReqsInFlight"</span>, <span class="type">Int</span>.<span class="type">MaxValue</span>),</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.get(config.<span class="type">REDUCER_MAX_BLOCKS_IN_FLIGHT_PER_ADDRESS</span>),</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.get(config.<span class="type">MAX_REMOTE_BLOCK_SIZE_FETCH_TO_MEM</span>),</span><br><span class="line">  <span class="type">SparkEnv</span>.get.conf.getBoolean(<span class="string">"spark.shuffle.detectCorrupt"</span>, <span class="literal">true</span>))</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ <code>mapOutputTracker.getMapSizesByExecutorId</code> é‡Œçš„å…³é”®æ­¥éª¤</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convertMapStatuses</span></span>(</span><br><span class="line">    shuffleId: <span class="type">Int</span>,</span><br><span class="line">    startPartition: <span class="type">Int</span>,</span><br><span class="line">    endPartition: <span class="type">Int</span>,</span><br><span class="line">    statuses: <span class="type">Array</span>[<span class="type">MapStatus</span>]): <span class="type">Iterator</span>[(<span class="type">BlockManagerId</span>, <span class="type">Seq</span>[(<span class="type">BlockId</span>, <span class="type">Long</span>)])] = &#123;</span><br><span class="line">  assert (statuses != <span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">val</span> splitsByAddress = <span class="keyword">new</span> <span class="type">HashMap</span>[<span class="type">BlockManagerId</span>, <span class="type">ListBuffer</span>[(<span class="type">BlockId</span>, <span class="type">Long</span>)]]</span><br><span class="line">  <span class="comment">// mapTask çš„ä¸ªæ•°å†³å®šäº† Seq[(BlockId, BlockSize)] å†…å…ƒç´ çš„ä¸ªæ•°ï¼Œå¾ˆå¥½ç†è§£</span></span><br><span class="line">  <span class="keyword">for</span> ((status, mapId) &lt;- statuses.iterator.zipWithIndex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (status == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">val</span> errorMessage = <span class="string">s"Missing an output location for shuffle <span class="subst">$shuffleId</span>"</span></span><br><span class="line">      logError(errorMessage)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">MetadataFetchFailedException</span>(shuffleId, startPartition, errorMessage)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å·¦é—­å³å¼€ï¼Œå› æ­¤å‰é¢çš„ ï¼ˆsplit.index, split.index + 1ï¼‰ä¸­çš„ split.index + 1ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆè½¯ç”¨  </span></span><br><span class="line">      <span class="keyword">for</span> (part &lt;- startPartition until endPartition) &#123;</span><br><span class="line">        <span class="keyword">val</span> size = status.getSizeForBlock(part)</span><br><span class="line">        <span class="keyword">if</span> (size != <span class="number">0</span>) &#123;</span><br><span class="line">          splitsByAddress.getOrElseUpdate(status.location, <span class="type">ListBuffer</span>()) +=</span><br><span class="line">              ((<span class="type">ShuffleBlockId</span>(shuffleId, mapId, part), size))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  splitsByAddress.iterator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ShuffleBlockFetcherIterator  </code>è¿™ä¸ªè¿­ä»£å™¨çš„å…·ä½“å®ç°æ¯”è¾ƒå¤æ‚ï¼Œç®€å•ä»‹ç»ä¸‹ï¼š</p>
<ul>
<li>
<p>åˆ†æœ¬åœ°æ•°æ®å— å’Œ è¿œç¨‹æ•°æ®å—</p>
</li>
<li>
<p>æœ¬åœ°æ•°æ®å—ç›´æ¥è°ƒç”¨ <code>BlockManager.getBlockData</code></p>
</li>
<li>
<p>è¿œç¨‹æ•°æ®å—é‡‡ç”¨Nettyé€šè¿‡ç½‘ç»œè·å–</p>
</li>
</ul>
<p>ä¸‹é¢æ˜¯ <code>IndexShuffleBlockResolver</code> ä¸­çš„ <code>getBlockData</code>ã€‚æˆ‘ä»¬çš„ç´¢å¼•æ–‡ä»¶ï¼ˆindexFileï¼‰ç»ˆäºæ´¾ä¸Šç”¨åœº</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getBlockData</span></span>(blockId: <span class="type">ShuffleBlockId</span>): <span class="type">ManagedBuffer</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> indexFile = getIndexFile(blockId.shuffleId, blockId.mapId)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> channel = <span class="type">Files</span>.newByteChannel(indexFile.toPath)</span><br><span class="line">  <span class="comment">// æ ¹æ®reduceIdé€‰æ‹©ç´¢å¼•</span></span><br><span class="line">  channel.position(blockId.reduceId * <span class="number">8</span>L)</span><br><span class="line">  <span class="keyword">val</span> in = <span class="keyword">new</span> <span class="type">DataInputStream</span>(<span class="type">Channels</span>.newInputStream(channel))</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> offset = in.readLong()</span><br><span class="line">    <span class="keyword">val</span> nextOffset = in.readLong()</span><br><span class="line">    <span class="keyword">val</span> actualPosition = channel.position()</span><br><span class="line">    <span class="keyword">val</span> expectedPosition = blockId.reduceId * <span class="number">8</span>L + <span class="number">16</span></span><br><span class="line">    <span class="keyword">if</span> (actualPosition != expectedPosition) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">Exception</span>(<span class="string">s"SPARK-22982: Incorrect channel position after index file reads: "</span> +</span><br><span class="line">        <span class="string">s"expected <span class="subst">$expectedPosition</span> but actual position was <span class="subst">$actualPosition</span>."</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">FileSegmentManagedBuffer</span>(</span><br><span class="line">      transportConf,</span><br><span class="line">      getDataFile(blockId.shuffleId, blockId.mapId),</span><br><span class="line">      offset,</span><br><span class="line">      nextOffset - offset)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    in.close()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ-k-v-è¿­ä»£å™¨"><a class="header-anchor" href="#ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ-k-v-è¿­ä»£å™¨">Â¶</a>ååºåˆ—åŒ–å‡ºå®ä¾‹ï¼Œå¹¶ç”Ÿæˆ k,v è¿­ä»£å™¨</h2>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> serializerInstance = dep.serializer.newInstance()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a key/value iterator for each stream</span></span><br><span class="line"><span class="keyword">val</span> recordIter = wrappedStreams.flatMap &#123; <span class="keyword">case</span> (blockId, wrappedStream) =&gt;</span><br><span class="line">  serializerInstance.deserializeStream(wrappedStream).asKeyValueIterator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ·»åŠ readMetricsï¼Œå†å°è£…æˆInterruptibleIterator"><a class="header-anchor" href="#æ·»åŠ readMetricsï¼Œå†å°è£…æˆInterruptibleIterator">Â¶</a>æ·»åŠ readMetricsï¼Œå†å°è£…æˆ<code>InterruptibleIterator</code></h2>
<p>readMetrics é‡Œéƒ½æ˜¯äº›è®°å½•æ•°æ®ï¼Œç”¨äºç›‘æ§å±•ç¤º</p>
<p><code>InterruptibleIterator</code> å°è£…äº†ä»»åŠ¡ä¸­æ–­åŠŸèƒ½</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Update the context task metrics for each record read.</span></span><br><span class="line"><span class="keyword">val</span> readMetrics = context.taskMetrics.createTempShuffleReadMetrics()</span><br><span class="line"><span class="keyword">val</span> metricIter = <span class="type">CompletionIterator</span>[(<span class="type">Any</span>, <span class="type">Any</span>), <span class="type">Iterator</span>[(<span class="type">Any</span>, <span class="type">Any</span>)]](</span><br><span class="line">  recordIter.map &#123; record =&gt;</span><br><span class="line">    readMetrics.incRecordsRead(<span class="number">1</span>) <span class="comment">// sparkUI é‡Œçš„ record æ•°</span></span><br><span class="line">    record</span><br><span class="line">  &#125;,</span><br><span class="line">  context.taskMetrics().mergeShuffleReadMetrics())</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> interruptibleIter = <span class="keyword">new</span> <span class="type">InterruptibleIterator</span>[(<span class="type">Any</span>, <span class="type">Any</span>)](context, metricIter)</span><br></pre></td></tr></table></figure>
<h2 id="è¿›è¡Œèšåˆæ“ä½œ"><a class="header-anchor" href="#è¿›è¡Œèšåˆæ“ä½œ">Â¶</a>è¿›è¡Œèšåˆæ“ä½œ</h2>
<p>åˆ†æœ‰æ— èšåˆï¼Œå½“æœ‰èšåˆæ—¶ï¼Œåˆåˆ†æ˜¯å¦åœ¨ mapTask æ—¶æ‰§è¡Œè¿‡mapèšåˆ</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> aggregatedIter: <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] = <span class="keyword">if</span> (dep.aggregator.isDefined) &#123;</span><br><span class="line">  <span class="keyword">if</span> (dep.mapSideCombine) &#123;</span><br><span class="line">    <span class="comment">// We are reading values that are already combined</span></span><br><span class="line">    <span class="comment">// æœ‰ mapSideCombineï¼Œå°±æ˜¯èšåˆ(K, C)</span></span><br><span class="line">    <span class="keyword">val</span> combinedKeyValuesIterator = interruptibleIter.asInstanceOf[<span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">C</span>)]]</span><br><span class="line">    dep.aggregator.get.combineCombinersByKey(combinedKeyValuesIterator, context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ—  mapSideCombineï¼Œå°±æ˜¯èšåˆ(K, V)</span></span><br><span class="line">    <span class="keyword">val</span> keyValuesIterator = interruptibleIter.asInstanceOf[<span class="type">Iterator</span>[(<span class="type">K</span>, <span class="type">Nothing</span>)]]</span><br><span class="line">    dep.aggregator.get.combineValuesByKey(keyValuesIterator, context)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ä¸èšåˆ</span></span><br><span class="line">  interruptibleIter.asInstanceOf[<span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¿›è¡Œæ’åºæ“ä½œ"><a class="header-anchor" href="#è¿›è¡Œæ’åºæ“ä½œ">Â¶</a>è¿›è¡Œæ’åºæ“ä½œ</h2>
<p>åˆ†æ˜¯å¦éœ€è¦æ’åºã€‚å¦‚æœéœ€è¦ï¼Œå°±ä½¿ç”¨<code>ExternalSorter</code>åœ¨åˆ†åŒºå†…éƒ¨è¿›è¡Œæ’åº</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> resultIter = dep.keyOrdering <span class="keyword">match</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="type">Some</span>(keyOrd: <span class="type">Ordering</span>[<span class="type">K</span>]) =&gt;</span><br><span class="line">    <span class="comment">// Create an ExternalSorter to sort the data.</span></span><br><span class="line">    <span class="keyword">val</span> sorter =</span><br><span class="line">      <span class="keyword">new</span> <span class="type">ExternalSorter</span>[<span class="type">K</span>, <span class="type">C</span>, <span class="type">C</span>](context, ordering = <span class="type">Some</span>(keyOrd), serializer = dep.serializer)</span><br><span class="line">    sorter.insertAll(aggregatedIter)</span><br><span class="line">    context.taskMetrics().incMemoryBytesSpilled(sorter.memoryBytesSpilled)</span><br><span class="line">    context.taskMetrics().incDiskBytesSpilled(sorter.diskBytesSpilled)</span><br><span class="line">    context.taskMetrics().incPeakExecutionMemory(sorter.peakMemoryUsedBytes)</span><br><span class="line">    <span class="comment">// Use completion callback to stop sorter if task was finished/cancelled.</span></span><br><span class="line">    context.addTaskCompletionListener[<span class="type">Unit</span>](_ =&gt; &#123;</span><br><span class="line">      sorter.stop()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="type">CompletionIterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>], <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]](sorter.iterator, sorter.stop())</span><br><span class="line">  <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">    aggregatedIter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkæ‚è°ˆ-æŒ‡å®šæ–‡ä»¶åœ¨HDFSä¸­çš„å†™å…¥èŠ‚ç‚¹</title>
    <url>/2019/12/28/spark%E6%9D%82%E8%B0%88-%E6%8C%87%E5%AE%9A%E6%96%87%E4%BB%B6%E5%9C%A8HDFS%E4%B8%AD%E7%9A%84%E5%86%99%E5%85%A5%E8%8A%82%E7%82%B9/</url>
    <content><![CDATA[<p>é¡¹ç›®ä¸­éœ€è¦æŒ‡å®šæ–‡ä»¶å†™åˆ°HDFSçš„å…·ä½“å“ªä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡æŸ¥æ‰¾APIï¼Œæ‰¾åˆ°ä¸€ç§è§£å†³åŠæ³•ã€‚ä»¥ <code>TextOutputFormat</code> ä¸ºä¾‹æµ‹è¯•</p>
<a id="more"></a>
<h1>write</h1>
<p>è§‚å¯Ÿ <code>TextOutputFormat</code> é‡Œçš„ <code>write</code> æ–¹æ³•ï¼Œå®ƒä½¿ç”¨äº†<code>out.write</code>å°† record å†™å…¥ HDFSã€‚æ‰¾åˆ° <code>out</code> ï¼Œä¿®æ”¹å®ƒ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(K key, V value)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> nullKey = key == <span class="keyword">null</span> || key <span class="keyword">instanceof</span> NullWritable;</span><br><span class="line">  <span class="keyword">boolean</span> nullValue = value == <span class="keyword">null</span> || value <span class="keyword">instanceof</span> NullWritable;</span><br><span class="line">  <span class="keyword">if</span> (nullKey &amp;&amp; nullValue) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!nullKey) &#123;</span><br><span class="line">    writeObject(key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(nullKey || nullValue)) &#123;</span><br><span class="line">    out.write(keyValueSeparator);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!nullValue) &#123;</span><br><span class="line">    writeObject(value);</span><br><span class="line">  &#125;</span><br><span class="line">  out.write(newline);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>getRecordWriter</h1>
<p><code>out</code> æ˜¯ä¸€ä¸ª<code>DataOutputStream</code>ï¼Œå®ƒé€šè¿‡ <code>getRecordWriter</code>å¾—åˆ°çš„ã€‚</p>
<p>é»˜è®¤æ˜¯ç”± <code>FSDataOutputStream fileOut = fs.create(file, progress;</code> ç”Ÿæˆï¼Œä½†å®ƒæ— æ³•æŒ‡å®šèŠ‚ç‚¹ã€‚</p>
<p>ä½œå‡ºä¿®æ”¹ï¼š</p>
<p><strong>å…³é”®æ˜¯æŠŠå®ƒæ›¿æ¢æˆ <code>DistributedFileSystem</code> é‡Œçš„ <code>create</code> æ–¹æ³•ï¼Œå…¶ä¸­æœ‰ä¸ªå‚æ•°æ˜¯ <code>favoredNodes </code>ï¼Œé¡¾åæ€ä¹‰æ•°æ®å°†ä¼˜å…ˆå­˜åˆ°å®ƒæŒ‡å®šèŠ‚ç‚¹</strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getRecordWriter</span></span>(ignored: <span class="type">FileSystem</span>, job: <span class="type">JobConf</span>, name: <span class="type">String</span>, progress: <span class="type">Progressable</span>): <span class="type">RecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>] = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> keyValueSeparator = job.get(<span class="string">"mapreduce.output.textoutputformat.separator"</span>, <span class="string">"\t"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> file = <span class="type">FileOutputFormat</span>.getTaskOutputPath(job, name)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°† OutputStream è½¬æˆ DistributedFileSystem</span></span><br><span class="line">  <span class="keyword">val</span> fs = file.getFileSystem(job).asInstanceOf[<span class="type">DistributedFileSystem</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> favoredNodes = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">InetSocketAddress</span>](<span class="number">3</span>)</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// è¿™é‡Œè‡ªå·±æŒ‡å®š</span></span><br><span class="line">  favoredNodes(<span class="number">0</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.12"</span>, <span class="number">9866</span>) <span class="comment">// è¿™ä¸ªportæ˜¯è¯¥èŠ‚ç‚¹dataNodeçš„port</span></span><br><span class="line">  favoredNodes(<span class="number">1</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.13"</span>, <span class="number">9866</span>)</span><br><span class="line">  favoredNodes(<span class="number">2</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.17"</span>, <span class="number">9866</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> fileOut: <span class="type">FSDataOutputStream</span> = fs.create(file,</span><br><span class="line">    <span class="type">FsPermission</span>.getFileDefault.applyUMask(<span class="type">FsPermission</span>.getUMask(fs.getConf)),</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">    fs.getConf.getInt(<span class="type">IO_FILE_BUFFER_SIZE_KEY</span>, <span class="type">IO_FILE_BUFFER_SIZE_DEFAULT</span>),</span><br><span class="line">    fs.getDefaultReplication(file),</span><br><span class="line">    fs.getDefaultBlockSize(file),</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    favoredNodes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">new</span> <span class="type">TextOutputFormat</span>.<span class="type">LineRecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>](fileOut, keyValueSeparator)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>å®Œæ•´æµ‹è¯•ä»£ç </h1>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.spark.examples.zxyTest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.<span class="type">InetSocketAddress</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.<span class="type">CommonConfigurationKeysPublic</span>.&#123;<span class="type">IO_FILE_BUFFER_SIZE_DEFAULT</span>, <span class="type">IO_FILE_BUFFER_SIZE_KEY</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.permission.<span class="type">FsPermission</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.&#123;<span class="type">FSDataOutputStream</span>, <span class="type">FileSystem</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hdfs.<span class="type">DistributedFileSystem</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.&#123;<span class="type">IntWritable</span>, <span class="type">Text</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapred.&#123;<span class="type">FileOutputFormat</span>, <span class="type">JobConf</span>, <span class="type">RecordWriter</span>, <span class="type">TextOutputFormat</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.<span class="type">Progressable</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.<span class="type">SparkSession</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æµ‹è¯• æŒ‡å®š HDFS å­˜å‚¨èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">FavoredNodesTest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> spark = <span class="type">SparkSession</span></span><br><span class="line">      .builder</span><br><span class="line">      .appName(<span class="string">"FavoredNodesTest"</span>)</span><br><span class="line">      .master(<span class="string">"local[*]"</span>)</span><br><span class="line">      .config(<span class="string">"spark.driver.memory"</span>, <span class="string">"2g"</span>)</span><br><span class="line">      .getOrCreate()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> sc = spark.sparkContext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> rdd = sc.makeRDD(<span class="type">Array</span>((<span class="string">"A"</span>, <span class="number">1</span>), (<span class="string">"B"</span>, <span class="number">2</span>), (<span class="string">"C"</span>, <span class="number">3</span>), (<span class="string">"D"</span>, <span class="number">4</span>)), <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    rdd.saveAsHadoopFile(<span class="string">"hdfs://dell-r720/zxyTest/output"</span>,</span><br><span class="line">      classOf[<span class="type">Text</span>],</span><br><span class="line">      classOf[<span class="type">IntWritable</span>],</span><br><span class="line">      classOf[<span class="type">MyTextOutputFormat</span>[<span class="type">Text</span>, <span class="type">IntWritable</span>]])</span><br><span class="line"></span><br><span class="line">    println(<span class="string">"Result has been saved"</span>)</span><br><span class="line">    spark.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTextOutputFormat</span>[<span class="type">K</span>, <span class="type">V</span>] <span class="keyword">extends</span> <span class="title">TextOutputFormat</span>[<span class="type">K</span>, <span class="type">V</span>] </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getRecordWriter</span></span>(ignored: <span class="type">FileSystem</span>, job: <span class="type">JobConf</span>, name: <span class="type">String</span>, progress: <span class="type">Progressable</span>): <span class="type">RecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> keyValueSeparator = job.get(<span class="string">"mapreduce.output.textoutputformat.separator"</span>, <span class="string">"\t"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> file = <span class="type">FileOutputFormat</span>.getTaskOutputPath(job, name)</span><br><span class="line">    <span class="keyword">val</span> fs = file.getFileSystem(job).asInstanceOf[<span class="type">DistributedFileSystem</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3 å‰¯æœ¬ä½ç½®</span></span><br><span class="line">    <span class="keyword">val</span> favoredNodes = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">InetSocketAddress</span>](<span class="number">3</span>)</span><br><span class="line">    favoredNodes(<span class="number">0</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.12"</span>, <span class="number">9866</span>) <span class="comment">// 9866æ˜¯è¯¥èŠ‚ç‚¹dataNodeçš„port</span></span><br><span class="line">    favoredNodes(<span class="number">1</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.13"</span>, <span class="number">9866</span>)</span><br><span class="line">    favoredNodes(<span class="number">2</span>) = <span class="keyword">new</span> <span class="type">InetSocketAddress</span>(<span class="string">"10.0.0.17"</span>, <span class="number">9866</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> fileOut: <span class="type">FSDataOutputStream</span> = fs.create(file,</span><br><span class="line">      <span class="type">FsPermission</span>.getFileDefault.applyUMask(<span class="type">FsPermission</span>.getUMask(fs.getConf)),</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      fs.getConf.getInt(<span class="type">IO_FILE_BUFFER_SIZE_KEY</span>, <span class="type">IO_FILE_BUFFER_SIZE_DEFAULT</span>),</span><br><span class="line">      fs.getDefaultReplication(file),</span><br><span class="line">      fs.getDefaultBlockSize(file),</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      favoredNodes)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="type">TextOutputFormat</span>.<span class="type">LineRecordWriter</span>[<span class="type">K</span>, <span class="type">V</span>](fileOut, keyValueSeparator)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>HDFS</tag>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·-Ansible</title>
    <url>/2019/12/24/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7-Ansible/</url>
    <content><![CDATA[<p>Ansible æ˜¯ä¸€ä¸ªå¼€æºçš„åŸºäº OpenSSH çš„è‡ªåŠ¨åŒ–é…ç½®ç®¡ç†å·¥å…·ã€‚å¯ä»¥ç”¨å®ƒæ¥é…ç½®ç³»ç»Ÿã€éƒ¨ç½²è½¯ä»¶å’Œç¼–æ’æ›´é«˜çº§çš„ IT ä»»åŠ¡ï¼Œæ¯”å¦‚æŒç»­éƒ¨ç½²æˆ–é›¶åœæœºæ›´æ–°ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ Ansible åœ¨æˆç™¾ä¸Šåƒå°è®¡ç®—æœºä¸ŠåŒæ—¶æ‰§è¡ŒæŒ‡ä»¤(ä»»åŠ¡)ï¼Œè¿™æ˜¯<a href="https://ansible-tran.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<a id="more"></a>
<h1>é…ç½®ç»„</h1>
<p>Ansible å¯åŒæ—¶æ“ä½œå±äºä¸€ä¸ªç»„çš„å¤šå°ä¸»æœºï¼Œåœ¨ <code>/etc/ansible/hosts</code> ä¸­é…ç½®ç»„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /etc/ansible/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æ³•ï¼š[ç»„å] + hostnames</span></span><br><span class="line">[spark]</span><br><span class="line">dell-r730-[1:4]</span><br><span class="line"></span><br><span class="line">[hdfs]</span><br><span class="line">dell-r730-[1:4]</span><br><span class="line">dell-r730-7</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨æ—¶å¯åˆ†ä¸º <strong>ad-hoc</strong> å’Œ <strong>playbook</strong></p>
<h1>ad-hoc</h1>
<p>åœ¨å‘½ä»¤è¡Œæ•²å…¥çš„shellå‘½ä»¤ï¼Œå»æ‰§è¡Œäº›ç®€å•çš„ä»»åŠ¡ï¼š</p>
<p><code>ansible ç»„å -m æ¨¡å—å -a å…·ä½“æ“ä½œ [-u ç”¨æˆ·å] [--sudo] [-f 10]</code></p>
<ul>
<li><code>-m</code> æ¨¡å—å</li>
<li><code>-a</code> å…·ä½“æ“ä½œï¼Œ<strong>ä¸€èˆ¬æ˜¯k vç»“æ„</strong>ã€‚</li>
<li><code>-u</code> é»˜è®¤ä»¥å½“å‰ç”¨æˆ·çš„èº«ä»½æ‰§è¡Œå‘½ä»¤ï¼Œä¹Ÿå¯æ‰‹åŠ¨æŒ‡å®š</li>
<li><code>--sudo</code> é€šè¿‡ sudo å»æ‰§è¡Œå‘½ä»¤ï¼ˆ passwordless æ¨¡å¼ ï¼‰</li>
<li><code>-f</code> å¹¶å‘é‡</li>
</ul>
<p>ä¸‹é¢ä»‹ç»äº›å¸¸ç”¨æ¨¡å—</p>
<h2 id="commond-å’Œ-shell"><a class="header-anchor" href="#commond-å’Œ-shell">Â¶</a>commond å’Œ shell</h2>
<p><code>commond </code>æ˜¯é»˜è®¤çš„æ¨¡å—</p>
<p><code>commond</code> å’Œ <code>shell</code> éƒ½æ˜¯ç›´æ¥æ•²å‘½ä»¤çš„ã€‚<code>command</code> æ›´å®‰å…¨ï¼Œä½†<strong>ä¸æ”¯æŒ shell å˜é‡ï¼Œä¹Ÿä¸æ”¯æŒç®¡é“ç­‰ shell ç›¸å…³çš„ä¸œè¥¿</strong></p>
<p>shellä½¿ç”¨å˜é‡æ—¶ä¹Ÿå­˜åœ¨é™åˆ¶ï¼Œæ‰€ä»¥å°½é‡<strong>ä¸è¦æ•²å¤ªå¤æ‚çš„å‘½ä»¤</strong>ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ‰“å°å½“å‰æ—¶é—´</span></span><br><span class="line">$ ansible zxy -a <span class="string">"date"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç®€å•ç®¡é“å‘½ä»¤</span></span><br><span class="line">$ ansible zxy -m shell -a <span class="string">"cat /etc/hosts &gt; test.txt"</span></span><br></pre></td></tr></table></figure>
<h2 id="file-å’Œ-copy"><a class="header-anchor" href="#file-å’Œ-copy">Â¶</a>file å’Œ copy</h2>
<p><code>file</code> ç”¨äºåˆ›å»ºï¼ˆåˆ é™¤ï¼‰æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼Œä¹Ÿå¯æ›´æ”¹æ‰€æœ‰è€…æƒé™<br>
<code>copy</code> ç”¨ä¸å¤åˆ¶æ–‡ä»¶<br>
ï¼ˆæˆ‘è§‰å¾—æœ‰ç‚¹éº»çƒ¦ï¼Œæ²¡æœ‰commndæ¥çš„å¿«ç‚¹ï¼‰</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼Œæ›´æ–°æ—¶é—´æˆ³ï¼‰</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testfile state=touch"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œï¼‰</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testdir state=directory"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testdir state=absent"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ  owner å®šä¹‰æ‰€æœ‰è€…ï¼Œmode å®šä¹‰ æƒé™ï¼Œrecurse å¯¹ç›®å½•é€’å½’ã€‚</span></span><br><span class="line">$ ansible zxy -m file -a <span class="string">"path=/home/cluster/testdir state=directory owner=cluster mode=0777 recurse=true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># force=no ä¸å¼ºåˆ¶è¦†ç›–ï¼Œbackup=no ä¸å¤‡ä»½æ—§æ–‡ä»¶</span></span><br><span class="line">$ ansible zxy -m copy -a <span class="string">"src=/home/cluster/testfile dest=/home/cluster/testfile2 owner=cluster mode=0777"</span></span><br></pre></td></tr></table></figure>
<h2 id="synchronize"><a class="header-anchor" href="#synchronize">Â¶</a>synchronize</h2>
<p>æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åŒæ­¥ï¼Œæœ‰ pushï¼ˆé»˜è®¤ï¼‰å’Œ pull æ¨¡å¼ã€‚</p>
<p>é»˜è®¤å¯ç”¨äº†<code>archive</code>å‚æ•°ï¼Œè¯¥å‚æ•°é»˜è®¤å¼€å¯äº†recursive, links, perms, times, ownerï¼Œgroupå’Œ-Då‚æ•°ã€‚</p>
<p>å¯åŠ  <code>--exclude=xxx</code> å¿½ç•¥æŒ‡å®šæ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible zxy -m synchronize -a <span class="string">"src=/home/cluster/testfile dest=/home/cluster/testfile"</span></span><br></pre></td></tr></table></figure>
<h2 id="ping"><a class="header-anchor" href="#ping">Â¶</a>ping</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible zxy -m ping</span><br></pre></td></tr></table></figure>
<h1>playbook</h1>
<p>å°†ä¸€ç³»åˆ—æœ‰åºä»»åŠ¡ä¿å­˜æˆymlæ–‡ä»¶ï¼Œæ–¹ä¾¿å¤šæ¬¡ä½¿ç”¨å’Œæœ‰åºçš„æ‰§è¡ŒæŒ‡å®šçš„ä»»åŠ¡ã€‚</p>
<ul>
<li>æ‰§è¡Œ</li>
</ul>
<p><code>ansible-playbook playbook.yml</code></p>
<ul>
<li>æ ¼å¼</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">ç»„å</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line">    <span class="string">å˜é‡å:</span> <span class="string">å€¼</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">æè¿°ä»»åŠ¡ï¼ˆè‡ªå®šä¹‰ï¼‰</span></span><br><span class="line">    <span class="string">æ¨¡å—å:</span> <span class="string">å…·ä½“æ“ä½œ</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">xxxx</span></span><br><span class="line">    <span class="string">æ¨¡å—å:</span> <span class="string">xxxxx</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">é’©å­å(</span> <span class="string">task</span> <span class="string">ç»“æŸä¸”è¯¥</span> <span class="string">task</span> <span class="string">æœ‰æ„ä¹‰ï¼ˆæ”¹å˜äº†ä¸œè¥¿ï¼‰æ—¶è¢«è§¦å‘ï¼Œåªæ‰§è¡Œä¸€æ¬¡)</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">é’©å­å</span></span><br><span class="line">      <span class="string">æ¨¡å—å:</span> <span class="string">å…·ä½“æ“ä½œ</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ä¾‹å­</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webservers</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    http_port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    max_clients:</span> <span class="number">200</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">at</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">version</span></span><br><span class="line"><span class="attr">    yum:</span> <span class="string">pkg=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">write</span> <span class="string">the</span> <span class="string">apache</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/srv/httpd.j2</span> <span class="string">dest=/etc/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">ensure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>è¿ç»´</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤§æ•°æ®bugè®°å½•</title>
    <url>/2019/12/20/%E5%A4%A7%E6%95%B0%E6%8D%AEbug%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>è®°å½•é‡åˆ°çš„ç®€å•bug</p>
<a id="more"></a>
<h1>201911-201912</h1>
<h2 id="é›†ç¾¤æ—¶é—´ä¸åŒæ­¥"><a class="header-anchor" href="#é›†ç¾¤æ—¶é—´ä¸åŒæ­¥">Â¶</a>é›†ç¾¤æ—¶é—´ä¸åŒæ­¥</h2>
<p><strong>é”™è¯¯è¯¦æƒ…</strong></p>
<p>ä½¿ç”¨ spark æ—¶ï¼Œyarn å¯åŠ¨èŠ‚ç‚¹æ—¶æŠ¥é”™</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Application application_1576029485466_0001 failed 2 times due to Error launching </span><br><span class="line">appattempt_1576029485466_0001_000002. Got exception: org.apache.hadoop.yarn.exceptions.YarnException: </span><br><span class="line">Unauthorized request to start container.</span><br><span class="line">This token is expired. current time is 1576059076270 found 1576030868681</span><br></pre></td></tr></table></figure>
<p><strong>è§£å†³åŠæ³•</strong></p>
<p>è®©æ—¶é—´åŒæ­¥</p>
<h2 id="unable-to-create-new-native-thread"><a class="header-anchor" href="#unable-to-create-new-native-thread">Â¶</a>unable to create new native thread</h2>
<p><strong>é”™è¯¯è¯¦æƒ…</strong></p>
<p>ä½¿ç”¨ spark æ—¶ï¼Œç¨‹åºæŠ¥é”™</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2019-12-11 11:34:58,366 INFO scheduler.DAGScheduler: ResultStage 0 (collect at SparkSharder.java:430) failed in 80.679 s due to Job aborted due to stage failure: Task 5428 in stage 0.0 failed 4 times, most recent failure: Lost task 5428.3 in stage 0.0 (TID 5440, dell-r730-4, executor 3): java.io.IOException: DestHost:destPort dell-r720:8020 , LocalHost:localPort dell-r730-4/10.0.0.14:0. Failed on local exception: java.io.IOException: Couldn&apos;t set up IO streams: java.lang.OutOfMemoryError: unable to create new native thread</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">	at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)</span><br><span class="line">	at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</span><br><span class="line">	at java.lang.reflect.Constructor.newInstance(Constructor.java:423)</span><br><span class="line">	at org.apache.hadoop.net.NetUtils.wrapWithMessage(NetUtils.java:833)</span><br><span class="line">	at org.apache.hadoop.net.NetUtils.wrapException(NetUtils.java:808)</span><br><span class="line">	at org.apache.hadoop.ipc.Client.getRpcResponse(Client.java:1549)</span><br><span class="line">	at org.apache.hadoop.ipc.Client.call(Client.java:1491)</span><br><span class="line">	at org.apache.hadoop.ipc.Client.call(Client.java:1388)</span><br><span class="line">	at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:233)</span><br><span class="line">	at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:118)</span><br><span class="line">	at com.sun.proxy.$Proxy13.getFileInfo(Unknown Source)</span><br><span class="line">	at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.getFileInfo(ClientNamenodeProtocolTranslatorPB.java:907)</span><br><span class="line">	at sun.reflect.GeneratedMethodAccessor307.invoke(Unknown Source)</span><br></pre></td></tr></table></figure>
<p><strong>è§£å†³åŠæ³•</strong></p>
<p>åŸå› æ˜¯è¶…è¿‡äº†<code>unlimt -u</code>è®¾å®šçš„æœ€å¤§çº¿ç¨‹æ•°ï¼ŒæŠŠå®ƒå¢å¤§å³å¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ limits.conf</span></span><br><span class="line">$ vim /etc/security/limits.conf</span><br><span class="line">...</span><br><span class="line">*       soft    nofile  65536      <span class="comment"># æ–‡ä»¶æ‰“å¼€æ•°ï¼ˆä»¥å‰æ”¹çš„ï¼‰</span></span><br><span class="line">*       hard    nofile  65536</span><br><span class="line"></span><br><span class="line">*       hard    nproc     65536    <span class="comment"># çº¿ç¨‹æ•°ï¼ˆåŠ ä¸Šè¿™ä¸¤è¡Œï¼‰</span></span><br><span class="line">*       soft    nproc     65536</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰æ•ˆæœï¼Œåˆ™ç»§ç»­ä¿®æ”¹ 20-nproc.confï¼ˆå®ƒé™åˆ¶äº†çº¿ç¨‹æœ€å¤§å€¼ï¼‰</span></span><br><span class="line">$ vim /etc/security/limits.d/20-nproc.conf</span><br><span class="line"><span class="comment"># *       soft    nproc     65536  # ä¿®æ”¹å®ƒ</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>bug</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkè°ƒè¯•-å¸¸ç”¨ä»£ç </title>
    <url>/2019/12/20/spark%E8%B0%83%E8%AF%95-%E5%B8%B8%E7%94%A8%E4%BB%A3%E7%A0%81/</url>
    <content><![CDATA[<p>ä¸€äº›æˆ‘ç”¨åˆ°çš„è°ƒè¯•ä»£ç </p>
<a id="more"></a>
<h1>ç»Ÿè®¡æ¯ä¸ªåˆ†åŒºçš„recordä¸ªæ•°</h1>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Tuple2&lt;Integer, Integer&gt;&gt; numOfRecordPerPartition = javaRDD.mapPartitionsWithIndex(</span><br><span class="line">        ((Function2&lt;Integer, Iterator&lt;T&gt;, Iterator&lt;Tuple2&lt;Integer, Integer&gt;&gt;&gt;) (Index, iterator) -&gt; &#123;</span><br><span class="line">            List&lt;Tuple2&lt;Integer, Integer&gt;&gt; numOfRecord = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">int</span> totalElement = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                iterator.next();</span><br><span class="line">                totalElement++;</span><br><span class="line">            &#125;</span><br><span class="line">            numOfRecord.add(<span class="keyword">new</span> Tuple2&lt;&gt;(Index, totalElement));</span><br><span class="line">            <span class="keyword">return</span> numOfRecord.iterator();</span><br><span class="line">        &#125;), <span class="keyword">true</span>).collect();</span><br></pre></td></tr></table></figure>
<h1>æ”¶é›†æ¯ä¸ªåˆ†åŒºçš„ç¬¬ä¸€ä¸ªrecord</h1>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Tuple2&lt;Integer, T&gt;&gt; firstRecordPerPartition = javaRDD.mapPartitionsWithIndex(</span><br><span class="line">        ((Function2&lt;Integer, Iterator&lt;T&gt;, Iterator&lt;Tuple2&lt;Integer, T&gt;&gt;&gt;) (Index, iterator) -&gt; &#123;</span><br><span class="line">            List&lt;Tuple2&lt;Integer, T&gt;&gt; record = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">if</span> (iterator.hasNext())</span><br><span class="line">                record.add(<span class="keyword">new</span> Tuple2&lt;&gt;(Index, iterator.next()));</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                record.add(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> record.iterator();</span><br><span class="line">        &#125;), <span class="keyword">true</span>).collect();</span><br></pre></td></tr></table></figure>
<h1>æŸ¥çœ‹å½“å‰RDDçš„PreferredLocations</h1>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Partition[] partitions = javaRDD.rdd().getPartitions();</span><br><span class="line">List&lt;Seq&lt;String&gt;&gt; preferredLocationsList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Partition partition : partitions) &#123;</span><br><span class="line">    preferredLocationsList.add(javaRDD.rdd().getPreferredLocations(partition));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>linux-å¸¸ç”¨å‘½ä»¤</title>
    <url>/2019/12/20/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<p>ä¸€äº›ç”¨è¿‡çš„linuxå‘½ä»¤</p>
<a id="more"></a>
<h1>æ–‡ä»¶</h1>
<ol>
<li><strong>æŸ¥çœ‹ç›®å½•å†…å­ç›®å½•æ‰€ä½¿ç”¨çš„ç©ºé—´</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ du -h  --max-depth=1`</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>æ”¹å˜æ–‡ä»¶ï¼ˆå¤¹ï¼‰æ‹¥æœ‰è€…</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chown (-R) zxy filename</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>æ”¹å˜æ–‡ä»¶æƒé™</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chmod 755 filename</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><strong>å‹ç¼©ä¸è§£å‹</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar å‹ç¼©ï¼Œ-p ä¿ç•™æƒé™ï¼Œ-z ä½¿ç”¨ gzip</span></span><br><span class="line">$ tar cvpfz /mnt/data/homeback.tgz /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># tar è§£å‹</span></span><br><span class="line">$ tar xvpfz /mnt/data/homeback.tgz -C /</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><strong>æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ df -h</span><br></pre></td></tr></table></figure>
<h1>æœåŠ¡å™¨</h1>
<ol>
<li><strong>æ·»åŠ ç”¨æˆ·</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ adduser username</span><br><span class="line">$ passwd username</span><br><span class="line"><span class="comment"># èµ‹äºˆrootæƒé™</span></span><br><span class="line">$ vim /etc/sudoers</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>å…å¯†ç™»é™†</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼1</span></span><br><span class="line">$ ssh-copy-id -i ~/.ssh/id_rsa.pub zxy@10.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼2</span></span><br><span class="line">$ ssh zxy@10.0.0.1 <span class="string">"cat &gt;&gt; ~/.ssh/authorized_keys"</span> &lt; ~/.ssh/id_rsa.pub</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>ä¼ è¾“æ–‡ä»¶</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æºæ–‡ä»¶ -&gt; ç›®çš„åœ°</span></span><br><span class="line">scp -r zxy@10.0.0.1:/home/zxy/filename  /Users/zxy/Desktop/</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><strong>é…ç½®ç½‘å¡ipåœ°å€</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># (1) ä¿®æ”¹å¯¹åº”ç½‘å¡é…ç½®æ–‡ä»¶ï¼ˆcentosï¼‰</span></span><br><span class="line">$ sudo vim /etc/sysconfig/network-scripts/ifcfg-em1</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) é‡å¯ç”Ÿæ•ˆ</span></span><br><span class="line">$ sudo service network restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) æŸ¥çœ‹æ•ˆæœ</span></span><br><span class="line">$ ifconfig</span><br></pre></td></tr></table></figure>
<ol start="5">
<li><strong>ä½¿ç”¨ nfs æœåŠ¡å™¨</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è§£é‡Šï¼š</span></span><br><span class="line"><span class="comment"># /mnt/storage2/data                     ç”¨äºå…±äº«çš„ç›®å½•</span></span><br><span class="line"><span class="comment"># *                                      å®¢æˆ·ç«¯ï¼šæ‰€æœ‰ä¸»æœº</span></span><br><span class="line"><span class="comment"># rw                                     å¯è¯»å¯å†™</span></span><br><span class="line"><span class="comment"># sync                                   æ•°æ®åŒæ­¥ï¼Œæ•ˆç‡ä½ï¼Œä½†å¯ä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§</span></span><br><span class="line"><span class="comment"># no_root_squash                         è®©rootä¿æŒæƒé™ï¼Œä¹Ÿå°±æ˜¯è®©å®¢æˆ·ç«¯çš„rootç›¸å½“äºæœåŠ¡ç«¯çš„root</span></span><br><span class="line"><span class="comment"># all_squash,anonuid=1001,anongid=1001   å®¢æˆ·ç«¯å†™æ•°æ®æ—¶ï¼Œæ™®é€šç”¨æˆ·åå¼ºè½¬æˆæŒ‡å®šåå­—ï¼ˆ1001ï¼‰</span></span><br><span class="line"><span class="comment"># no_all_squash é»˜è®¤                      å®¢æˆ·ç«¯å†™æ•°æ®æ—¶ï¼Œä¿æŒç”¨æˆ·å</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># (1) ä¿®æ”¹ exports </span></span><br><span class="line">$ sudo vim /etc/exports </span><br><span class="line"></span><br><span class="line"><span class="comment"># /mnt/storage2/data  è¯¥ç›®å½•ç»Ÿä¸€ç”¨æˆ· 1001ï¼ˆclusteré›†ç¾¤ä½¿ç”¨ï¼‰</span></span><br><span class="line">/mnt/storage2/data *(rw,sync,no_root_squash,all_squash,anonuid=1001,anongid=1001)</span><br><span class="line"><span class="comment"># /mnt/storage2/users è¯¥ç›®å½•ç”¨äºå…±äº«ï¼Œä¿æŒä¸ªäººç”¨æˆ·å</span></span><br><span class="line">/mnt/storage2/users *(rw,sync,no_root_squash)</span><br><span class="line"></span><br><span class="line"><span class="comment"># (2) æœåŠ¡ç«¯ æŒ‚è½½ï¼ˆæ›´æ–°ï¼‰</span></span><br><span class="line">$ exportfs -arv</span><br><span class="line"></span><br><span class="line"><span class="comment"># (3) å®¢æˆ·ç«¯ æŒ‚è½½</span></span><br><span class="line">$ mount -t nfs storage-2:/mnt/storage2/data /home/cluster/Storage2</span><br><span class="line">$ mount -t nfs storage-2:/mnt/storage2/users /mnt/users</span><br><span class="line"></span><br><span class="line"><span class="comment"># (4) å®¢æˆ·ç«¯ å¸è½½</span></span><br><span class="line">$ umount /mnt/users</span><br><span class="line"></span><br><span class="line"><span class="comment"># (5) æœåŠ¡ç«¯ å¸è½½</span></span><br><span class="line">$ exportfs -auv</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkæºç -shuffleä¹‹SortShuffleWriter</title>
    <url>/2019/12/04/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BSortShuffleWriter/</url>
    <content><![CDATA[<p>spark ä¸‰å¤§ShuffleWriter ä¹‹ SortShuffleWriter</p>
<a id="more"></a>
<p>spark ç‰ˆæœ¬ 2.4.3</p>
<h1>ç‰¹ç‚¹</h1>
<ul>
<li>
<p>æœ€å¤§ç‰¹ç‚¹å°±æ˜¯<strong>æ”¯æŒ map-side aggregation</strong></p>
</li>
<li>
<p>æœ€åŸºç¡€çš„ <code>ShuffleWriter</code>ã€‚å½“å¦å¤–ä¸¤ç§ç”¨ä¸äº†æ—¶æ‰é€‰å®ƒï½</p>
</li>
</ul>
<h1>å¤§è‡´æµç¨‹</h1>
<p>é¦–å…ˆè®°ä½æœ‰3ç§æƒ…å†µï¼š<strong>å« aggregator å’Œ ordering</strong>ï¼›<strong>å« aggregator ä½†ä¸å« ordering</strong>ï¼› <strong>å‰ä¸¤ç§éƒ½ä¸å«</strong>ã€‚</p>
<p>ä¸ºå•¥æ²¡æœ‰åªå«orderingçš„æƒ…å†µå‘¢ï¼Ÿå› ä¸ºä¸å«aggregatorå°±ä¸åšæ’åºï¼Œæ°¸è¿œè®°ä½<strong>ShuffleWriteré˜¶æ®µçš„æ’åºåªæ˜¯ä¸ºäº†ä½¿èšåˆæ›´èˆ’æœ</strong>ï¼</p>
<ol>
<li>
<p><strong>é€‰æ‹© <code>sorter</code></strong>ï¼šæƒ…å†µ1å’Œ2 é€‰åŒä¸€ç§<code>sorter</code>ï¼Œæƒ…å†µ3é€‰å¦ä¸€ç§ã€‚æˆ‘æŠŠå®ƒä»¬ç§°ä¸º åˆ†æ”¯1 å’Œ åˆ†æ”¯2</p>
</li>
<li>
<p><strong>è¯»å–æ•°æ®</strong>ï¼šåˆ†æ”¯1æŠŠæ•°æ®è¯»è¿›<code>PartitionedAppendOnlyMap</code>ï¼ˆæŠŠåŒä¸€åˆ†åŒºkeyç›¸åŒçš„èšåˆï¼‰ï¼Œåˆ†æ”¯2æŠŠæ•°æ®è¯»è¿›<code>PartitionedPairBuffer</code>ï¼ˆç®€å•æ”¾å…¥ï¼‰</p>
</li>
<li>
<p><strong>æ•°æ®æ•°é‡è¾¾åˆ°é˜ˆå€¼å‘ç”Ÿspill</strong>ï¼šè¿™ä¸ªspillæ–‡ä»¶æ•´ä½“æ˜¯æŒ‰<strong>åˆ†åŒºé¡ºåº</strong>å †å çš„ã€‚ä¸åŒç‚¹æ˜¯åˆ†åŒºå†…éƒ¨æ•°æ®æƒ…å†µï¼šæƒ…å†µ1æŒ‰ ordering æ’åºï¼›æƒ…å†µ2æŒ‰ key çš„ hashå€¼ æ’åºï¼ˆè¿™ä¸ªæ’åºåªæ˜¯ä¸ºäº†æ–¹ä¾¿èšåˆï¼‰ï¼›æƒ…å†µ3 ä¸æ’åº</p>
</li>
<li>
<p><strong>åˆå¹¶spillæ–‡ä»¶å’Œå†…å­˜ä¸­æœªspillçš„æ–‡ä»¶ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</strong>ï¼šæƒ…å†µ1å…ˆå½’å¹¶æ’åºå†èšåˆï¼›æƒ…å†µ2åªèšåˆï¼›æƒ…å†µ3å•¥éƒ½ä¸å¹²</p>
</li>
<li>
<p><strong>æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶</strong></p>
</li>
<li>
<p><strong>å°è£…ä¿¡æ¯åˆ°<code>MapStatus</code>è¿”å›</strong></p>
</li>
</ol>
<p>æ€»çš„æ¥è¯´å°±æ˜¯ä¸€ä¸ª <strong>task</strong> ç”Ÿæˆä¸€ä¸ª<strong>ç”± spill æ–‡ä»¶åˆå¹¶å½¢æˆçš„ä¸”èšåˆäº†çš„å¤§æ–‡ä»¶</strong>å’Œä¸€ä¸ª<strong>ç´¢å¼•æ–‡ä»¶</strong>ã€‚</p>
<p>ç”±äºæƒ…å†µ2æ›´å¤æ‚ç‚¹ï¼Œä»¥æƒ…å†µ2ä¸ºç¤ºä¾‹ï¼š<br>
<img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/shuffle/SortShuffleWriter.jpg" alt></p>
<h1>æºç </h1>
<h2 id="write-â€¦"><a class="header-anchor" href="#write-â€¦">Â¶</a>write(â€¦)</h2>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">write</span></span>(records: <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">V</span>]]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// æµç¨‹1ï¼šæ ¹æ®æ˜¯å¦éœ€è¦ mapSideCombine é€‰æ‹©ä¸åŒçš„ sorter</span></span><br><span class="line">  sorter = <span class="keyword">if</span> (dep.mapSideCombine) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">ExternalSorter</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>](</span><br><span class="line">      context, dep.aggregator, <span class="type">Some</span>(dep.partitioner), dep.keyOrdering, dep.serializer)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// In this case we pass neither an aggregator nor an ordering to the sorter, because we don't</span></span><br><span class="line">    <span class="comment">// care whether the keys get sorted in each partition; that will be done on the reduce side</span></span><br><span class="line">    <span class="comment">// if the operation being run is sortByKey.</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ ordering = Noneï¼Œå®˜æ–¹è§£é‡Šçš„å¾ˆæ¸…æ¥šäº†ï¼Œå¯¹å§</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">ExternalSorter</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">V</span>](</span><br><span class="line">      context, aggregator = <span class="type">None</span>, <span class="type">Some</span>(dep.partitioner), ordering = <span class="type">None</span>, dep.serializer)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æµç¨‹2-3ï¼šè¯»å–æ•°æ® ä¸ spill</span></span><br><span class="line">  sorter.insertAll(records)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  <span class="comment">// æ–‡ä»¶å "shuffle_" + shuffleId + "_" + mapId + "_" + reduceId + ".data"</span></span><br><span class="line">  <span class="keyword">val</span> output = shuffleBlockResolver.getDataFile(dep.shuffleId, mapId)</span><br><span class="line">  <span class="keyword">val</span> tmp = <span class="type">Utils</span>.tempFileWith(output)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// æµç¨‹4: åˆå¹¶ spillæ–‡ä»¶ å’Œ å†…å­˜ä¸­æœªspillçš„æ–‡ä»¶ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</span></span><br><span class="line">    <span class="keyword">val</span> blockId = <span class="type">ShuffleBlockId</span>(dep.shuffleId, mapId, <span class="type">IndexShuffleBlockResolver</span>.<span class="type">NOOP_REDUCE_ID</span>)</span><br><span class="line">    <span class="keyword">val</span> partitionLengths = sorter.writePartitionedFile(blockId, tmp)</span><br><span class="line">    <span class="comment">// æµç¨‹5: æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶ã€‚è¿™ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå‚è€ƒ BypassMergeSortShuffleWriter ç¯‡</span></span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(dep.shuffleId, mapId, partitionLengths, tmp)</span><br><span class="line">    <span class="comment">// æµç¨‹6: å°è£…ä¿¡æ¯åˆ° MapStatus è¿”å›</span></span><br><span class="line">    mapStatus = <span class="type">MapStatus</span>(blockManager.shuffleServerId, partitionLengths)</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmp.exists() &amp;&amp; !tmp.delete()) &#123;</span><br><span class="line">      logError(<span class="string">s"Error while deleting temp file <span class="subst">$&#123;tmp.getAbsolutePath&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="insertAll-â€¦"><a class="header-anchor" href="#insertAll-â€¦">Â¶</a>insertAll(â€¦)</h2>
<p>æµç¨‹2-3ï¼šè¯»å–æ•°æ® ä¸ spill</p>
<p>ä¸»è¦å…³æ³¨ <code>PartitionedAppendOnlyMap </code> å’Œ <code>PartitionedPairBuffer </code></p>
<ul>
<li>
<p>ç›¸åŒç‚¹ï¼šéƒ½å®ç°<code>WritablePartitionedPairCollection</code> traitã€‚å®ƒä»¬å†…éƒ¨éƒ½æ˜¯ç”¨ <code>Array</code> ï¼ˆkey0, value0, key1, value1, key2, value2â€¦ï¼‰å®ç° Map é€»è¾‘ã€‚<strong>key æ˜¯ ï¼ˆåˆ†åŒºIDï¼ŒåŸkeyï¼‰</strong></p>
</li>
<li>
<p>ä¸åŒç‚¹ï¼š<code>PartitionedAppendOnlyMap </code><strong>æ”¯æŒæ·»åŠ äºæ›´æ–°</strong> valueï¼šå®ƒä½¿ç”¨<code>map.changeValue((getPartition(kv._1), kv._1), update)</code> å®Œæˆæ•°æ®æ·»åŠ æˆ–è€…æ›´æ–°ï¼ˆèšåˆï¼‰ã€‚è€Œ<code>PartitionedPairBuffer </code><strong>ä»…æ”¯æŒæ·»åŠ </strong>ã€‚</p>
</li>
</ul>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insertAll</span></span>(records: <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">V</span>]]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> stop combining if we find that the reduction factor isn't high</span></span><br><span class="line">  <span class="keyword">val</span> shouldCombine = aggregator.isDefined</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€‰æ‹©æ˜¯å¦ combine</span></span><br><span class="line">  <span class="keyword">if</span> (shouldCombine) &#123;</span><br><span class="line">    <span class="comment">// Combine values in-memory first using our AppendOnlyMap</span></span><br><span class="line">    <span class="keyword">val</span> mergeValue = aggregator.get.mergeValue</span><br><span class="line">    <span class="keyword">val</span> createCombiner = aggregator.get.createCombiner</span><br><span class="line">    <span class="keyword">var</span> kv: <span class="type">Product2</span>[<span class="type">K</span>, <span class="type">V</span>] = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// ä» aggregator ä¸­å–å‡º createCombiner å’Œ mergeValueï¼Œåˆ¶ä½œæˆupdateå‡½æ•°</span></span><br><span class="line">    <span class="keyword">val</span> update = (hadValue: <span class="type">Boolean</span>, oldValue: <span class="type">C</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (hadValue) mergeValue(oldValue, kv._2) <span class="keyword">else</span> createCombiner(kv._2)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (records.hasNext) &#123;</span><br><span class="line">      <span class="comment">// è®¡æ•° + 1</span></span><br><span class="line">      addElementsRead()</span><br><span class="line">      kv = records.next()</span><br><span class="line">      <span class="comment">// combine æ¨¡å¼ä½¿ç”¨ PartitionedAppendOnlyMap</span></span><br><span class="line">      map.changeValue((getPartition(kv._1), kv._1), update)</span><br><span class="line">      <span class="comment">// æµç¨‹3: spill</span></span><br><span class="line">      maybeSpillCollection(usingMap = <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Stick values into our buffer</span></span><br><span class="line">    <span class="keyword">while</span> (records.hasNext) &#123;</span><br><span class="line">      addElementsRead()</span><br><span class="line">      <span class="keyword">val</span> kv = records.next()</span><br><span class="line">      <span class="comment">// é combine æ¨¡å¼ä½¿ç”¨ PartitionedPairBuffer</span></span><br><span class="line">      buffer.insert(getPartition(kv._1), kv._1, kv._2.asInstanceOf[<span class="type">C</span>])</span><br><span class="line">      <span class="comment">// æµç¨‹3: spill</span></span><br><span class="line">      maybeSpillCollection(usingMap = <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="maybeSpill-â€¦"><a class="header-anchor" href="#maybeSpill-â€¦">Â¶</a>maybeSpill(â€¦)</h2>
<p>spill çš„æ¡ä»¶ï¼šå†…å­˜ç”³è¯·æ²¡æˆåŠŸ æˆ–è€… è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼<code>numElementsForceSpillThreshold</code></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">maybeSpill</span></span>(collection: <span class="type">C</span>, currentMemory: <span class="type">Long</span>): <span class="type">Boolean</span> = &#123;</span><br><span class="line">  <span class="keyword">var</span> shouldSpill = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// å…ƒç´ ä¸ªæ•°æ˜¯32çš„æ•´æ•°å€ ä¸” å¤§äº myMemoryThreshold</span></span><br><span class="line">  <span class="keyword">if</span> (elementsRead % <span class="number">32</span> == <span class="number">0</span> &amp;&amp; currentMemory &gt;= myMemoryThreshold) &#123;</span><br><span class="line">    <span class="comment">// Claim up to double our current memory from the shuffle memory pool</span></span><br><span class="line">    <span class="keyword">val</span> amountToRequest = <span class="number">2</span> * currentMemory - myMemoryThreshold</span><br><span class="line">    <span class="comment">// ç”³è¯·å†…å­˜</span></span><br><span class="line">    <span class="keyword">val</span> granted = acquireMemory(amountToRequest)</span><br><span class="line">    myMemoryThreshold += granted</span><br><span class="line">    <span class="comment">// If we were granted too little memory to grow further (either tryToAcquire returned 0,</span></span><br><span class="line">    <span class="comment">// or we already had more memory than myMemoryThreshold), spill the current collection</span></span><br><span class="line">    shouldSpill = currentMemory &gt;= myMemoryThreshold</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// spillæ¡ä»¶ï¼šä¸Šé¢çš„ç”³è¯·æ²¡æˆåŠŸ æˆ–è€…  è¾¾åˆ°é˜ˆå€¼</span></span><br><span class="line">  shouldSpill = shouldSpill || _elementsRead &gt; numElementsForceSpillThreshold</span><br><span class="line">  <span class="comment">// Actually spill</span></span><br><span class="line">  <span class="keyword">if</span> (shouldSpill) &#123;</span><br><span class="line">    _spillCount += <span class="number">1</span></span><br><span class="line">    logSpillage(currentMemory)</span><br><span class="line">    <span class="comment">// spill åœ¨è¿™é‡Œå‘ç”Ÿ</span></span><br><span class="line">    spill(collection)</span><br><span class="line">    _elementsRead = <span class="number">0</span></span><br><span class="line">    _memoryBytesSpilled += currentMemory</span><br><span class="line">    releaseMemory()</span><br><span class="line">  &#125;</span><br><span class="line">  shouldSpill</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spill-â€¦"><a class="header-anchor" href="#spill-â€¦">Â¶</a>spill(â€¦)</h2>
<p>å…ˆæ’åºï¼Œåspillã€‚æ’åºæ–¹é¢ï¼Œç”±äºåˆ†æ”¯ä¸åŒï¼Œæœ‰<strong>ä¸¤ä¸ªæ’åºé€»è¾‘</strong>ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">protected</span>[<span class="keyword">this</span>] <span class="function"><span class="keyword">def</span> <span class="title">spill</span></span>(collection: <span class="type">WritablePartitionedPairCollection</span>[<span class="type">K</span>, <span class="type">C</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="comment">// æ’åº</span></span><br><span class="line">  <span class="keyword">val</span> inMemoryIterator = collection.destructiveSortedWritablePartitionedIterator(comparator)</span><br><span class="line">  <span class="comment">// spill</span></span><br><span class="line">  <span class="keyword">val</span> spillFile = spillMemoryIteratorToDisk(inMemoryIterator)</span><br><span class="line">  spills += spillFile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>PartitionedAppendOnlyMap </code>çš„æ’åºé€»è¾‘ï¼š<strong>2é‡æ’åº</strong>ï¼Œå…ˆæŒ‰åˆ†åŒºIDæ’ï¼Œå†å¯¹åˆ†åŒºå†…çš„æ•°æ®æ’åºï¼ˆä¼˜å…ˆæŒ‰ ordering æ’åºï¼Œå¦åˆ™hashï¼‰</p>
<p>æ³¨æ„è¿™ä¸ªhashæ’åºï¼Œå­¦è¿‡javaä¸­ == å’Œ equals çš„åŒºåˆ«çš„å…„å¼Ÿåº”è¯¥çŸ¥é“ï¼Œhashcode ç›¸ç­‰ æ˜¯ ä¸¤ä¸ªå¯¹è±¡ equals çš„<strong>å¿…è¦æ¡ä»¶</strong>ã€‚è¿™é‡Œåªèƒ½ä¿è¯ hashcode ç›¸åŒçš„æ•°æ®åœ¨ä¸€èµ·ï¼Œåç»­èšåˆæ—¶ï¼Œ<strong>è¿˜éœ€ç»è¿‡æ¯”è¾ƒåæ‰èƒ½èšåˆ</strong>ï¼ˆå…ˆæ‰“ä¸ªé¢„é˜²é’ˆï¼Œåé¢æºç ä¼šè¯»åˆ°å®ƒï¼‰ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partitionKeyComparator</span></span>[<span class="type">K</span>](keyComparator: <span class="type">Comparator</span>[<span class="type">K</span>]): <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] = &#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(a: (<span class="type">Int</span>, <span class="type">K</span>), b: (<span class="type">Int</span>, <span class="type">K</span>)): <span class="type">Int</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> partitionDiff = a._1 - b._1</span><br><span class="line">      <span class="keyword">if</span> (partitionDiff != <span class="number">0</span>) &#123;</span><br><span class="line">        partitionDiff</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        keyComparator.compare(a._2, b._2)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// keyComparatorï¼šæœ‰ ordering ç”¨ orderingï¼Œå¦åˆ™æŒ‰ hash æ’åºã€‚</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">val</span> keyComparator: <span class="type">Comparator</span>[<span class="type">K</span>] = ordering.getOrElse(<span class="keyword">new</span> <span class="type">Comparator</span>[<span class="type">K</span>] &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(a: <span class="type">K</span>, b: <span class="type">K</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> h1 = <span class="keyword">if</span> (a == <span class="literal">null</span>) <span class="number">0</span> <span class="keyword">else</span> a.hashCode()</span><br><span class="line">    <span class="keyword">val</span> h2 = <span class="keyword">if</span> (b == <span class="literal">null</span>) <span class="number">0</span> <span class="keyword">else</span> b.hashCode()</span><br><span class="line">    <span class="keyword">if</span> (h1 &lt; h2) <span class="number">-1</span> <span class="keyword">else</span> <span class="keyword">if</span> (h1 == h2) <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>PartitionedPairBuffer</code>çš„æ’åºé€»è¾‘ï¼šä»…<strong>æ¯”è¾ƒåˆ†åŒºID</strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">partitionedDestructiveSortedIterator</span></span>(keyComparator: <span class="type">Option</span>[<span class="type">Comparator</span>[<span class="type">K</span>]])</span><br><span class="line">  : <span class="type">Iterator</span>[((<span class="type">Int</span>, <span class="type">K</span>), <span class="type">V</span>)] = &#123;</span><br><span class="line">  <span class="keyword">val</span> comparator = keyComparator.map(partitionKeyComparator).getOrElse(partitionComparator)</span><br><span class="line">  <span class="keyword">new</span> <span class="type">Sorter</span>(<span class="keyword">new</span> <span class="type">KVArraySortDataFormat</span>[(<span class="type">Int</span>, <span class="type">K</span>), <span class="type">AnyRef</span>]).sort(data, <span class="number">0</span>, curSize, comparator)</span><br><span class="line">  iterator</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A comparator for (Int, K) pairs that orders them by only their partition ID.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">partitionComparator</span></span>[<span class="type">K</span>]: <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] = <span class="keyword">new</span> <span class="type">Comparator</span>[(<span class="type">Int</span>, <span class="type">K</span>)] &#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">compare</span></span>(a: (<span class="type">Int</span>, <span class="type">K</span>), b: (<span class="type">Int</span>, <span class="type">K</span>)): <span class="type">Int</span> = &#123;</span><br><span class="line">    a._1 - b._1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="writePartitionedFile-â€¦"><a class="header-anchor" href="#writePartitionedFile-â€¦">Â¶</a>writePartitionedFile(â€¦)</h2>
<p>æµç¨‹4: åˆå¹¶spillæ–‡ä»¶å’Œå†…å­˜ä¸­æœªspillçš„æ–‡ä»¶ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writePartitionedFile</span></span>(</span><br><span class="line">    blockId: <span class="type">BlockId</span>,</span><br><span class="line">    outputFile: <span class="type">File</span>): <span class="type">Array</span>[<span class="type">Long</span>] = &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Track location of each range in the output file</span></span><br><span class="line">  <span class="keyword">val</span> lengths = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Long</span>](numPartitions)</span><br><span class="line">  <span class="keyword">val</span> writer = blockManager.getDiskWriter(blockId, outputFile, serInstance, fileBufferSize,</span><br><span class="line">    context.taskMetrics().shuffleWriteMetrics)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é¦–å…ˆçŸ¥é“ï¼šcollection.destructiveSortedWritablePartitionedIterator(comparator) ç”¨è¿™ç©æ„è·å–å†…å­˜ä¸­çš„æ•°æ®ï¼ˆæœªè¢«spillï¼‰ï¼Œåé¢å¤šæ¬¡ç”¨åˆ°å®ƒ</span></span><br><span class="line">  <span class="keyword">if</span> (spills.isEmpty) &#123;</span><br><span class="line">    <span class="comment">// Case where we only have in-memory data</span></span><br><span class="line">    <span class="comment">// åªæœ‰å†…å­˜æ–‡ä»¶ï¼Œåˆ·è¿›å†…å­˜å³å¯ï¼ˆå½“ç„¶æ’åºä»€ä¹ˆçš„è¿˜æ˜¯è¦çš„ï¼Œå’Œä¸Šä¸€æ­¥ä¸€æ ·çš„è§„åˆ™ï¼‰</span></span><br><span class="line">    <span class="keyword">val</span> collection = <span class="keyword">if</span> (aggregator.isDefined) map <span class="keyword">else</span> buffer</span><br><span class="line">    <span class="keyword">val</span> it = collection.destructiveSortedWritablePartitionedIterator(comparator)</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext) &#123;</span><br><span class="line">      <span class="keyword">val</span> partitionId = it.nextPartition()</span><br><span class="line">      <span class="keyword">while</span> (it.hasNext &amp;&amp; it.nextPartition() == partitionId) &#123;</span><br><span class="line">        it.writeNext(writer)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">val</span> segment = writer.commitAndGet()</span><br><span class="line">      <span class="comment">// è®°å½•åˆ†åŒºé•¿åº¦</span></span><br><span class="line">      lengths(partitionId) = segment.length</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå¹¶æ“ä½œåœ¨è¿™é‡Œï¼šthis.partitionedIteratorï¼Œå†…éƒ¨è°ƒç”¨ merge()</span></span><br><span class="line">    <span class="keyword">for</span> ((id, elements) &lt;- <span class="keyword">this</span>.partitionedIterator) &#123;</span><br><span class="line">      <span class="keyword">if</span> (elements.hasNext) &#123;</span><br><span class="line">        <span class="keyword">for</span> (elem &lt;- elements) &#123;</span><br><span class="line">          writer.write(elem._1, elem._2)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> segment = writer.commitAndGet()</span><br><span class="line">        lengths(id) = segment.length</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  writer.close()</span><br><span class="line">  context.taskMetrics().incMemoryBytesSpilled(memoryBytesSpilled)</span><br><span class="line">  context.taskMetrics().incDiskBytesSpilled(diskBytesSpilled)</span><br><span class="line">  context.taskMetrics().incPeakExecutionMemory(peakMemoryUsedBytes)</span><br><span class="line"></span><br><span class="line">  lengths</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="merge-â€¦"><a class="header-anchor" href="#merge-â€¦">Â¶</a>merge(â€¦)</h2>
<p>æŠŠ spillæ–‡ä»¶ å’Œ å†…å­˜æ–‡ä»¶ åŒåˆ†åŒºçš„æ•°æ®æ”¾åˆ°ä¸€èµ·è®¡ç®—ï¼ˆ3ç§è®¡ç®—æƒ…å†µï¼‰</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(spills: <span class="type">Seq</span>[<span class="type">SpilledFile</span>], inMemory: <span class="type">Iterator</span>[((<span class="type">Int</span>, <span class="type">K</span>), <span class="type">C</span>)])</span><br><span class="line">    : <span class="type">Iterator</span>[(<span class="type">Int</span>, <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]])] = &#123;</span><br><span class="line">  <span class="keyword">val</span> readers = spills.map(<span class="keyword">new</span> <span class="type">SpillReader</span>(_))</span><br><span class="line">  <span class="keyword">val</span> inMemBuffered = inMemory.buffered</span><br><span class="line">  (<span class="number">0</span> until numPartitions).iterator.map &#123; p =&gt;</span><br><span class="line">    <span class="comment">// å¾ˆæ˜æ˜¾è¿™å…„å¼Ÿå‡½æ•°å¼ç¼–ç¨‹å†™çš„å¾ˆ6</span></span><br><span class="line">    <span class="comment">// ä¸»è¦å°±æ˜¯æŠŠ spillæ–‡ä»¶ å’Œ å†…å­˜æ–‡ä»¶ åŒåˆ†åŒºçš„æ•°æ®æ”¾åˆ°ä¸€èµ·è®¡ç®—ï¼ˆ3ç§è®¡ç®—æƒ…å†µï¼‰ã€‚å…¶å®å’Œä»¥å‰çš„2é‡å¾ªç¯æ˜¯ä¸€ä¸ªæ„æ€</span></span><br><span class="line">    <span class="keyword">val</span> inMemIterator = <span class="keyword">new</span> <span class="type">IteratorForPartition</span>(p, inMemBuffered)</span><br><span class="line">    <span class="keyword">val</span> iterators = readers.map(_.readNextPartition()) ++ <span class="type">Seq</span>(inMemIterator)</span><br><span class="line">    <span class="keyword">if</span> (aggregator.isDefined) &#123;</span><br><span class="line">      <span class="comment">// Perform partial aggregation across partitions</span></span><br><span class="line">      <span class="comment">// èšåˆï¼šï¼ˆåˆ†æœ‰æ—  ordering ä¸¤ç§æƒ…å†µï¼‰</span></span><br><span class="line">      (p, mergeWithAggregation(</span><br><span class="line">        iterators, aggregator.get.mergeCombiners, keyComparator, ordering.isDefined))</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ordering.isDefined) &#123;</span><br><span class="line">      <span class="comment">// No aggregator given, but we have an ordering (e.g. used by reduce tasks in sortByKey);</span></span><br><span class="line">      <span class="comment">// sort the elements without trying to merge them</span></span><br><span class="line">      <span class="comment">// åªæ’åºï¼šå¯¹å®ƒä»¬è¿›è¡Œå½’å¹¶æ’åºã€‚</span></span><br><span class="line">      <span class="comment">// è¯´å®è¯ï¼Œæˆ‘ä¸è§‰å¾—å®ƒä¼šè¿›è¿™ä¸€åˆ†æ”¯ã€‚å› ä¸ºæˆ‘å¤šæ¬¡å¼ºè°ƒè¿‡æ²¡æœ‰ aggregator å°±å¿…å®šæ²¡æœ‰ ordering</span></span><br><span class="line">      (p, mergeSort(iterators, ordering.get))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å•¥éƒ½ä¸è¦ï¼Œç›´æ¥æŠŠåŒåˆ†åŒºæ–‡ä»¶ flatten</span></span><br><span class="line">      (p, iterators.iterator.flatten)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="mergeWithAggregation-â€¦"><a class="header-anchor" href="#mergeWithAggregation-â€¦">Â¶</a>mergeWithAggregation(â€¦)</h2>
<p>èšåˆï¼šï¼ˆåˆ†æœ‰æ—  ordering ä¸¤ç§æƒ…å†µï¼‰</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">mergeWithAggregation</span></span>(</span><br><span class="line">    iterators: <span class="type">Seq</span>[<span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]],</span><br><span class="line">    mergeCombiners: (<span class="type">C</span>, <span class="type">C</span>) =&gt; <span class="type">C</span>,</span><br><span class="line">    comparator: <span class="type">Comparator</span>[<span class="type">K</span>],</span><br><span class="line">    totalOrder: <span class="type">Boolean</span>)</span><br><span class="line">    : <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] =</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (!totalOrder) &#123;</span><br><span class="line">    <span class="comment">// We only have a partial ordering, e.g. comparing the keys by hash code, which means that</span></span><br><span class="line">    <span class="comment">// multiple distinct keys might be treated as equal by the ordering. To deal with this, we</span></span><br><span class="line">    <span class="comment">// need to read all keys considered equal by the ordering at once and compare them.</span></span><br><span class="line">    <span class="comment">// æ—  ordering ï¼Œcomparator æ˜¯ hashæ¯”è¾ƒå™¨ã€‚hashå€¼ç›¸åŒçš„æ˜¯keyç›¸åŒçš„å¿…è¦æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">Iterator</span>[<span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]]] &#123;</span><br><span class="line">      <span class="keyword">val</span> sorted = mergeSort(iterators, comparator).buffered</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Buffers reused across elements to decrease memory allocation</span></span><br><span class="line">      <span class="keyword">val</span> keys = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">K</span>]</span><br><span class="line">      <span class="keyword">val</span> combiners = <span class="keyword">new</span> <span class="type">ArrayBuffer</span>[<span class="type">C</span>]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">hasNext</span></span>: <span class="type">Boolean</span> = sorted.hasNext</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">next</span></span>(): <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] = &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NoSuchElementException</span></span><br><span class="line">        &#125;</span><br><span class="line">        keys.clear()</span><br><span class="line">        combiners.clear()</span><br><span class="line">        <span class="keyword">val</span> firstPair = sorted.next()</span><br><span class="line">        keys += firstPair._1</span><br><span class="line">        combiners += firstPair._2</span><br><span class="line">        <span class="keyword">val</span> key = firstPair._1</span><br><span class="line">        <span class="comment">// hashå€¼ç›¸ç­‰</span></span><br><span class="line">        <span class="keyword">while</span> (sorted.hasNext &amp;&amp; comparator.compare(sorted.head._1, key) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">val</span> pair = sorted.next()</span><br><span class="line">          <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">          <span class="keyword">var</span> foundKey = <span class="literal">false</span></span><br><span class="line">          <span class="keyword">while</span> (i &lt; keys.size &amp;&amp; !foundKey) &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„ == ã€‚ scala å°±æ˜¯ç”¨ == æ¯”è¾ƒå¯¹è±¡ç›¸ç­‰çš„ </span></span><br><span class="line">            <span class="keyword">if</span> (keys(i) == pair._1) &#123;</span><br><span class="line">              <span class="comment">// key ç›¸ç­‰ å°±åˆå¹¶</span></span><br><span class="line">              combiners(i) = mergeCombiners(combiners(i), pair._2)</span><br><span class="line">              foundKey = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!foundKey) &#123;</span><br><span class="line">            keys += pair._1</span><br><span class="line">            combiners += pair._2</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note that we return an iterator of elements since we could've had many keys marked</span></span><br><span class="line">        <span class="comment">// equal by the partial order; we flatten this below to get a flat iterator of (K, C).</span></span><br><span class="line">        keys.iterator.zip(combiners.iterator)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.flatMap(i =&gt; i)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// We have a total ordering, so the objects with the same key are sequential.</span></span><br><span class="line">    <span class="comment">// æœ‰ orderingï¼šå…ˆå½’å¹¶æ’åºï¼Œå†æŠŠæœ‰ç›¸åŒçš„keyçš„å…ƒç´ èšåˆå°±è¡Œäº†</span></span><br><span class="line">    <span class="keyword">new</span> <span class="type">Iterator</span>[<span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>]] &#123;</span><br><span class="line">      <span class="comment">// å½’å¹¶æ’åº</span></span><br><span class="line">      <span class="keyword">val</span> sorted = mergeSort(iterators, comparator).buffered</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">hasNext</span></span>: <span class="type">Boolean</span> = sorted.hasNext</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">next</span></span>(): <span class="type">Product2</span>[<span class="type">K</span>, <span class="type">C</span>] = &#123;</span><br><span class="line">        <span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NoSuchElementException</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> elem = sorted.next()</span><br><span class="line">        <span class="keyword">val</span> k = elem._1</span><br><span class="line">        <span class="keyword">var</span> c = elem._2</span><br><span class="line">        <span class="comment">// key ç›¸ç­‰ å°±åˆå¹¶</span></span><br><span class="line">        <span class="keyword">while</span> (sorted.hasNext &amp;&amp; sorted.head._1 == k) &#123;</span><br><span class="line">          <span class="keyword">val</span> pair = sorted.next()</span><br><span class="line">          c = mergeCombiners(c, pair._2)</span><br><span class="line">        &#125;</span><br><span class="line">        (k, c)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkæºç -shuffleä¹‹UnsafeShuffleWriter</title>
    <url>/2019/12/02/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BUnsafeShuffleWriter/</url>
    <content><![CDATA[<p>spark ä¸‰å¤§ShuffleWriter ä¹‹ UnsafeShuffleWriter</p>
<a id="more"></a>
<p>spark ç‰ˆæœ¬ 2.4.3</p>
<h1>ç‰¹ç‚¹</h1>
<ul>
<li>
<p>å®ƒ<strong>åªé€‚ç”¨ä¸éœ€è¦ map-side aggregation</strong> çš„Shuffleæ“ä½œ</p>
</li>
<li>
<p>å®ƒä½¿ç”¨UnSafe APIæ“ä½œåºåˆ—åŒ–æ•°æ®ï¼Œè€Œä¸æ˜¯Javaå¯¹è±¡ï¼Œå‡å°‘äº†å†…å­˜å ç”¨åŠå› æ­¤å¯¼è‡´çš„GCè€—æ—¶(å‚è€ƒSpark å†…å­˜ç®¡ç†ä¹‹Tungsten)ï¼Œå› æ­¤ä½¿ç”¨å®ƒæ—¶éœ€è¦<strong>Serializeræ”¯æŒrelocation</strong>ã€‚</p>
</li>
<li>
<p><strong>reduceç«¯çš„åˆ†åŒºæ•°ç›®å°äºç­‰äº 2^24</strong> (å› ä¸ºæ’åºè¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨æ˜¯æ•°æ®æŒ‡é’ˆï¼Œå®ƒè®°å½•äº†æ•°æ®çš„åœ°å€å’Œåˆ†åŒºIDï¼Œå…¶ä¸­åˆ†åŒºIDå 24ä½)</p>
</li>
<li>
<p>æº¢å†™ &amp; åˆå¹¶æ—¶ä½¿ç”¨UnSafe APIç›´æ¥æ“ä½œåºåˆ—åŒ–æ•°æ®ï¼Œ<strong>åˆå¹¶æ—¶ä¸éœ€è¦ååºåˆ—åŒ–æ•°æ®</strong>ã€‚</p>
</li>
<li>
<p>æº¢å†™ &amp; åˆå¹¶æ—¶<strong>å¯ä»¥ä½¿ç”¨fastMergeæå‡æ•ˆç‡</strong>(è°ƒç”¨NIOçš„transferToæ–¹æ³•)</p>
</li>
</ul>
<h1>å¤§è‡´æµç¨‹</h1>
<ol>
<li>
<p>éå†æ•°æ®ï¼Œæ’å…¥åˆ°<code>ShuffleExternalSorter</code>ä¸­ã€‚è¯¥è¿‡ç¨‹å®Œæˆè®¸å¤šäº‹ï¼š<strong>å°†æ•°æ®è¯»å…¥å†…å­˜</strong> åŒæ—¶ <strong>å°†æ•°æ®æŒ‡é’ˆä¸æ–­å†™åˆ°æŒ‡é’ˆæ•°ç»„</strong>ä¸­ï¼Œå½“è¾¾åˆ°spillé˜ˆå€¼ï¼Œä½¿ç”¨<code>writeSortedFile()</code>æ’åºï¼ˆæ’åºæ’çš„æ˜¯æŒ‡é’ˆæ•°ç»„ï¼‰å¹¶spillåˆ°ç£ç›˜ã€‚</p>
</li>
<li>
<p><code>sorter.closeAndGetSpills()</code>ï¼šspill å†…å­˜ä¸­å‰©ä½™çš„æ–‡ä»¶ï¼Œè¿”å›æ‰€æœ‰ spill æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ˆé‡ç‚¹æ˜¯æ¯ä¸ªåˆ†åŒºçš„é•¿åº¦ï¼‰</p>
</li>
<li>
<p>åˆå¹¶æ‰€æœ‰ spill æ–‡ä»¶æˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼ˆæœ‰3ç§åˆå¹¶å·¥å…·é€‰æ‹©ï¼‰ï¼Œå¹¶è¿”å›åˆ†åŒºé•¿åº¦æ•°ç»„</p>
</li>
<li>
<p>æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶</p>
</li>
<li>
<p>å°è£…ä¿¡æ¯åˆ°<code>MapStatus</code>è¿”å›</p>
</li>
</ol>
<p>æ€»çš„æ¥è¯´å°±æ˜¯ä¸€ä¸ª <strong>task</strong> ç”Ÿæˆä¸€ä¸ª<strong>ç”± spill æ–‡ä»¶åˆå¹¶å½¢æˆçš„å¤§æ–‡ä»¶ï¼ˆè¿™ç©æ„åªæ˜¯æŒ‰åˆ†åŒºæ’å¥½ï¼Œå†…éƒ¨æ˜¯æ— åºçš„ï¼‰<strong>å’Œä¸€ä¸ª</strong>ç´¢å¼•æ–‡ä»¶</strong>ï¼ˆä¸Šé¢æµç¨‹æ˜¯ä¸»è¦æµç¨‹ï¼Œé‡å‘½åä»€ä¹ˆçš„å°±ä¸å†™äº†ï¼‰ã€‚<br>
<img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/shuffle/UnsafeShuffleWriter.jpg" alt></p>
<h1>æºç </h1>
<h2 id="write-â€¦"><a class="header-anchor" href="#write-â€¦">Â¶</a>write(â€¦)</h2>
<p>è¿™ä¸ª<code>write(...)</code>æ–¹æ³•å°±æ¯”è¾ƒæ¸…çˆ½äº†ï¼Œå› ä¸ºæ­¥éª¤éƒ½å°åœ¨æ–¹æ³•é‡Œäº†</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">public void write(scala.collection.<span class="type">Iterator</span>&lt;<span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt;&gt; records) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  boolean success = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (records.hasNext()) &#123;</span><br><span class="line">      <span class="comment">// å¯¹åº”æµç¨‹1</span></span><br><span class="line">      insertRecordIntoSorter(records.next());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‰©ä½™æµç¨‹</span></span><br><span class="line">    closeAndWriteOutput();</span><br><span class="line">    success = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sorter != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        sorter.cleanupResources();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">        <span class="comment">// Only throw this error if we won't be masking another</span></span><br><span class="line">        <span class="comment">// error.</span></span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          logger.error(<span class="string">"In addition to a failure during writing, we failed during "</span> +</span><br><span class="line">                       <span class="string">"cleanup."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="insertRecordIntoSorter-â€¦"><a class="header-anchor" href="#insertRecordIntoSorter-â€¦">Â¶</a>insertRecordIntoSorter(â€¦)</h2>
<p>å…¶æ ¸å¿ƒæ–¹æ³•æ˜¯<code>sorter.insertRecord()</code></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">void insertRecordIntoSorter(<span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt; record) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert(sorter != <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">K</span> key = record._1();</span><br><span class="line">  <span class="keyword">final</span> int partitionId = partitioner.getPartition(key);</span><br><span class="line">  serBuffer.reset();</span><br><span class="line">  <span class="comment">// serOutputStream: ç”¨äºåºåˆ—åŒ–å¯¹è±¡çš„å†™å…¥çš„æµ</span></span><br><span class="line">  serOutputStream.writeKey(key, <span class="type">OBJECT_CLASS_TAG</span>);</span><br><span class="line">  serOutputStream.writeValue(record._2(), <span class="type">OBJECT_CLASS_TAG</span>);</span><br><span class="line">  serOutputStream.flush();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> int serializedRecordSize = serBuffer.size();</span><br><span class="line">  assert (serializedRecordSize &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éƒ½æ˜¯å®ƒå¹²çš„</span></span><br><span class="line">  sorter.insertRecord(</span><br><span class="line">    serBuffer.getBuf(), <span class="type">Platform</span>.<span class="type">BYTE_ARRAY_OFFSET</span>, serializedRecordSize, partitionId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="sorter-insertRecord-â€¦"><a class="header-anchor" href="#sorter-insertRecord-â€¦">Â¶</a>sorter.insertRecord(â€¦)</h2>
<p><strong>å°†æ•°æ®è¯»å…¥å†…å­˜</strong> åŒæ—¶ <strong>å°†æ•°æ®æŒ‡é’ˆä¸æ–­å†™åˆ°æŒ‡é’ˆæ•°ç»„</strong>ä¸­ï¼Œ<strong>å½“è¾¾åˆ°spillé˜ˆå€¼ï¼Œå‘ç”Ÿ spill</strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">public void insertRecord(<span class="type">Object</span> recordBase, long recordOffset, int length, int partitionId)</span><br><span class="line">  <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for tests</span></span><br><span class="line">  assert(inMemSorter != <span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// å¦‚æœ Sorter å†…çš„æ•°æ®è¶…è¿‡é˜ˆå€¼ï¼Œå°±å‘ç”Ÿ spill</span></span><br><span class="line">  <span class="keyword">if</span> (inMemSorter.numRecords() &gt;= numElementsForSpillThreshold) &#123;</span><br><span class="line">    logger.info(<span class="string">"Spilling data because number of spilledRecords crossed the threshold "</span> +</span><br><span class="line">      numElementsForSpillThreshold);</span><br><span class="line">    spill();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ£€æŸ¥ inMemSorterä¸­ çš„æ•°ç»„æ˜¯å¦æ»¡äº†ï¼Œå¦‚æœæ»¡äº†å°±æ‰©å®¹</span></span><br><span class="line">  growPointerArrayIfNecessary();</span><br><span class="line">  <span class="keyword">final</span> int uaoSize = <span class="type">UnsafeAlignedOffset</span>.getUaoSize();</span><br><span class="line">  <span class="comment">// Need 4 or 8 bytes to store the record length.</span></span><br><span class="line">  <span class="keyword">final</span> int required = length + uaoSize;</span><br><span class="line">  acquireNewPageIfNecessary(required);</span><br><span class="line"></span><br><span class="line">  assert(currentPage != <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">Object</span> base = currentPage.getBaseObject();</span><br><span class="line">  <span class="keyword">final</span> long recordAddress = taskMemoryManager.encodePageNumberAndOffset(currentPage, pageCursor);</span><br><span class="line">  <span class="type">UnsafeAlignedOffset</span>.putSize(base, pageCursor, length);</span><br><span class="line">  pageCursor += uaoSize;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å°†æ•°æ®å†™å…¥ MemoryBlock ä¸­</span></span><br><span class="line">  <span class="type">Platform</span>.copyMemory(recordBase, recordOffset, base, pageCursor, length);</span><br><span class="line">  pageCursor += length;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å°†æ•°æ®æŒ‡é’ˆä¿¡æ¯å†™å…¥inMemSorterçš„æ•°ç»„ä¸­</span></span><br><span class="line">  inMemSorter.insertRecord(recordAddress, partitionId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="spill"><a class="header-anchor" href="#spill">Â¶</a>spill()</h2>
<p><code>spill()</code> çš„æ ¸å¿ƒæ˜¯<code> writeSortedFile(false)</code></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">public long spill(long size, <span class="type">MemoryConsumer</span> trigger) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (trigger != <span class="keyword">this</span> || inMemSorter == <span class="literal">null</span> || inMemSorter.numRecords() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>L;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  logger.info(<span class="string">"Thread &#123;&#125; spilling sort data of &#123;&#125; to disk (&#123;&#125; &#123;&#125; so far)"</span>,</span><br><span class="line">    <span class="type">Thread</span>.currentThread().getId(),</span><br><span class="line">    <span class="type">Utils</span>.bytesToString(getMemoryUsage()),</span><br><span class="line">    spills.size(),</span><br><span class="line">    spills.size() &gt; <span class="number">1</span> ? <span class="string">" times"</span> : <span class="string">" time"</span>);</span><br><span class="line"></span><br><span class="line">  writeSortedFile(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">final</span> long spillSize = freeMemory();</span><br><span class="line">  <span class="comment">// spill å®Œæ•´ã€‚é‡ç½® inMemSorter</span></span><br><span class="line">  inMemSorter.reset();</span><br><span class="line">  <span class="comment">// Reset the in-memory sorter's pointer array only after freeing up the memory pages holding the</span></span><br><span class="line">  <span class="comment">// records. Otherwise, if the task is over allocated memory, then without freeing the memory</span></span><br><span class="line">  <span class="comment">// pages, we might not be able to get memory for the pointer array.</span></span><br><span class="line">  taskContext.taskMetrics().incMemoryBytesSpilled(spillSize);</span><br><span class="line">  <span class="keyword">return</span> spillSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="writeSortedFile"><a class="header-anchor" href="#writeSortedFile">Â¶</a>writeSortedFile()</h2>
<p>å¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œæ’åºï¼ˆæ’åºæ’çš„æ˜¯æŒ‡é’ˆæ•°ç»„ï¼‰å¹¶ å†™åˆ°ç£ç›˜</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> void writeSortedFile(boolean isLastFile) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">ShuffleWriteMetrics</span> writeMetricsToUse;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isLastFile) &#123;</span><br><span class="line">    writeMetricsToUse = writeMetrics;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    writeMetricsToUse = <span class="keyword">new</span> <span class="type">ShuffleWriteMetrics</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This call performs the actual sort.</span></span><br><span class="line">  <span class="comment">// è¿­ä»£å™¨ï¼šåŒ…å«åˆ†åŒºæœ‰åºçš„æ•°æ®æŒ‡é’ˆï¼ˆæ’åºåœ¨è¿™é‡Œè¿›è¡Œï¼Œæœ‰ä¸¤ç§æ’åºæ‰‹æ®µï¼‰</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">ShuffleInMemorySorter</span>.<span class="type">ShuffleSorterIterator</span> sortedRecords =</span><br><span class="line">    inMemSorter.getSortedIterator();</span><br><span class="line">  <span class="keyword">final</span> byte[] writeBuffer = <span class="keyword">new</span> byte[diskWriteBufferSize];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–‡ä»¶åï¼štemp_shuffle_ + block_id</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">Tuple2</span>&lt;<span class="type">TempShuffleBlockId</span>, <span class="type">File</span>&gt; spilledFileInfo =</span><br><span class="line">    blockManager.diskBlockManager().createTempShuffleBlock();</span><br><span class="line">  <span class="keyword">final</span> <span class="type">File</span> file = spilledFileInfo._2();</span><br><span class="line">  <span class="keyword">final</span> <span class="type">TempShuffleBlockId</span> blockId = spilledFileInfo._1();</span><br><span class="line">  <span class="keyword">final</span> <span class="type">SpillInfo</span> spillInfo = <span class="keyword">new</span> <span class="type">SpillInfo</span>(numPartitions, file, blockId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">SerializerInstance</span> ser = <span class="type">DummySerializerInstance</span>.<span class="type">INSTANCE</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">DiskBlockObjectWriter</span> writer =</span><br><span class="line">    blockManager.getDiskWriter(blockId, file, ser, fileBufferSizeBytes, writeMetricsToUse);</span><br><span class="line"></span><br><span class="line">  int currentPartition = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">final</span> int uaoSize = <span class="type">UnsafeAlignedOffset</span>.getUaoSize();</span><br><span class="line">  <span class="keyword">while</span> (sortedRecords.hasNext()) &#123;</span><br><span class="line">    sortedRecords.loadNext();</span><br><span class="line">    <span class="keyword">final</span> int partition = sortedRecords.packedRecordPointer.getPartitionId();</span><br><span class="line">    assert (partition &gt;= currentPartition);</span><br><span class="line">    <span class="keyword">if</span> (partition != currentPartition) &#123;</span><br><span class="line">      <span class="comment">// Switch to the new partition</span></span><br><span class="line">      <span class="keyword">if</span> (currentPartition != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileSegment</span> fileSegment = writer.commitAndGet();</span><br><span class="line">        <span class="comment">// è®°å½•æ¯ä¸ªåˆ†åŒºçš„é•¿åº¦</span></span><br><span class="line">        spillInfo.partitionLengths[currentPartition] = fileSegment.length();</span><br><span class="line">      &#125;</span><br><span class="line">      currentPartition = partition;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> long recordPointer = sortedRecords.packedRecordPointer.getRecordPointer();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> recordPage = taskMemoryManager.getPage(recordPointer);</span><br><span class="line">    <span class="keyword">final</span> long recordOffsetInPage = taskMemoryManager.getOffsetInPage(recordPointer);</span><br><span class="line">    int dataRemaining = <span class="type">UnsafeAlignedOffset</span>.getSize(recordPage, recordOffsetInPage);</span><br><span class="line">    long recordReadPosition = recordOffsetInPage + uaoSize; <span class="comment">// skip over record length</span></span><br><span class="line">    <span class="keyword">while</span> (dataRemaining &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> int toTransfer = <span class="type">Math</span>.min(diskWriteBufferSize, dataRemaining);</span><br><span class="line">      <span class="type">Platform</span>.copyMemory(</span><br><span class="line">        recordPage, recordReadPosition, writeBuffer, <span class="type">Platform</span>.<span class="type">BYTE_ARRAY_OFFSET</span>, toTransfer);</span><br><span class="line">      writer.write(writeBuffer, <span class="number">0</span>, toTransfer);</span><br><span class="line">      recordReadPosition += toTransfer;</span><br><span class="line">      dataRemaining -= toTransfer;</span><br><span class="line">    &#125;</span><br><span class="line">    writer.recordWritten();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">FileSegment</span> committedSegment = writer.commitAndGet();</span><br><span class="line">  writer.close();</span><br><span class="line">  <span class="keyword">if</span> (currentPartition != <span class="number">-1</span>) &#123;</span><br><span class="line">    spillInfo.partitionLengths[currentPartition] = committedSegment.length();</span><br><span class="line">    spills.add(spillInfo);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isLastFile) &#123;  <span class="comment">// i.e. this is a spill file</span></span><br><span class="line">    writeMetrics.incRecordsWritten(writeMetricsToUse.recordsWritten());</span><br><span class="line">    taskContext.taskMetrics().incDiskBytesSpilled(writeMetricsToUse.bytesWritten());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="closeAndWriteOutput"><a class="header-anchor" href="#closeAndWriteOutput">Â¶</a>closeAndWriteOutput();</h2>
<p>ç»ˆäºå®Œæˆäº†æµç¨‹1: <code>insertRecordIntoSorter</code></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">void closeAndWriteOutput() <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert(sorter != <span class="literal">null</span>);</span><br><span class="line">  updatePeakMemoryUsed();</span><br><span class="line">  serBuffer = <span class="literal">null</span>;</span><br><span class="line">  serOutputStream = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// æµç¨‹2: spill å†…å­˜ä¸­å‰©ä½™çš„æ–‡ä»¶ï¼Œè¿”å›æ‰€æœ‰ spill æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼ˆé‡ç‚¹æ˜¯æ¯ä¸ªåˆ†åŒºçš„é•¿åº¦ï¼‰</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">SpillInfo</span>[] spills = sorter.closeAndGetSpills();</span><br><span class="line">  sorter = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">final</span> long[] partitionLengths;</span><br><span class="line">  <span class="comment">// æ–‡ä»¶åï¼š"shuffle_" + shuffleId + "_" + mapId + "_" + reduceId + ".data"</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">File</span> output = shuffleBlockResolver.getDataFile(shuffleId, mapId);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">File</span> tmp = <span class="type">Utils</span>.tempFileWith(output);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æµç¨‹3: åˆå¹¶ spill æ–‡ä»¶ï¼Œå¹¶è¿”å› spill æ–‡ä»¶çš„å¤§å°ï¼Œç”¨äºè®¡ç®—ç´¢å¼•æ–‡ä»¶</span></span><br><span class="line">      partitionLengths = mergeSpills(spills, tmp);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">SpillInfo</span> spill : spills) &#123;</span><br><span class="line">        <span class="keyword">if</span> (spill.file.exists() &amp;&amp; ! spill.file.delete()) &#123;</span><br><span class="line">          logger.error(<span class="string">"Error while deleting spill file &#123;&#125;"</span>, spill.file.getPath());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æµç¨‹4: ç”Ÿæˆç´¢å¼•æ–‡ä»¶ã€‚è¿™ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå‚è€ƒ BypassMergeSortShuffleWriter</span></span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(shuffleId, mapId, partitionLengths, tmp);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tmp.exists() &amp;&amp; !tmp.delete()) &#123;</span><br><span class="line">      logger.error(<span class="string">"Error while deleting temp file &#123;&#125;"</span>, tmp.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  æµç¨‹<span class="number">5</span>: å°è£…ä¿¡æ¯åˆ°`<span class="type">MapStatus</span>`è¿”å›</span><br><span class="line">  mapStatus = <span class="type">MapStatus</span>$.<span class="type">MODULE</span>$.apply(blockManager.shuffleServerId(), partitionLengths);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mergeSpills-â€¦"><a class="header-anchor" href="#mergeSpills-â€¦">Â¶</a>mergeSpills(â€¦)</h3>
<p>åˆå¹¶ spill æ–‡ä»¶ï¼Œæœ‰3ç§åˆå¹¶æ‰‹æ®µï¼š</p>
<ul>
<li>
<p>å¿«åˆå¹¶ï¼š<strong>ä¸ä½¿ç”¨å‹ç¼©ï¼Œæˆ–è€…ç‰¹å®šçš„æ”¯æŒæ‹¼æ¥çš„å‹ç¼©æ ¼å¼</strong>ï¼šSnappyã€LZFã€LZ4ã€ZStd</p>
<ol>
<li>
<p>å½“ä½¿ç”¨nioçš„<code>transferTo</code>ä¼ è¾“ ä¸” ä¸éœ€è¦åŠ å¯†æ—¶ï¼Œä½¿ç”¨ <code>mergeSpillsWithTransferTo(spills, outputFile)</code></p>
</li>
<li>
<p>å¦åˆ™ä½¿ç”¨<code>mergeSpillsWithFileStream(spills, outputFile, null)</code></p>
</li>
</ol>
</li>
<li>
<p>æ…¢åˆå¹¶ï¼š</p>
<ol>
<li>ä½¿ç”¨<code>mergeSpillsWithFileStream(spills, outputFile, compressionCodec)</code></li>
</ol>
</li>
</ul>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> long[] mergeSpills(<span class="type">SpillInfo</span>[] spills, <span class="type">File</span> outputFile) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  <span class="comment">// å‹ç¼©ï¼Œä»¥åŠå‹ç¼©æ ¼å¼</span></span><br><span class="line">  <span class="keyword">final</span> boolean compressionEnabled = sparkConf.getBoolean(<span class="string">"spark.shuffle.compress"</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="type">CompressionCodec</span> compressionCodec = <span class="type">CompressionCodec</span>$.<span class="type">MODULE</span>$.createCodec(sparkConf);</span><br><span class="line">  <span class="keyword">final</span> boolean fastMergeEnabled =</span><br><span class="line">    sparkConf.getBoolean(<span class="string">"spark.shuffle.unsafe.fastMergeEnabled"</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// æ”¯æŒå¿«é€Ÿåˆå¹¶çš„æƒ…å†µï¼šä¸ä½¿ç”¨å‹ç¼©ï¼Œæˆ–è€…ç‰¹å®šçš„æ”¯æŒæ‹¼æ¥çš„å‹ç¼©æ ¼å¼ï¼šSnappyã€LZFã€LZ4ã€ZStd</span></span><br><span class="line">  <span class="keyword">final</span> boolean fastMergeIsSupported = !compressionEnabled ||</span><br><span class="line">    <span class="type">CompressionCodec</span>$.<span class="type">MODULE</span>$.supportsConcatenationOfSerializedStreams(compressionCodec);</span><br><span class="line">  <span class="comment">// æ˜¯å¦åŠ å¯†</span></span><br><span class="line">  <span class="keyword">final</span> boolean encryptionEnabled = blockManager.serializerManager().encryptionEnabled();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (spills.length == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">FileOutputStream</span>(outputFile).close(); <span class="comment">// Create an empty file</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> long[partitioner.numPartitions()];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (spills.length == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="type">Files</span>.move(spills[<span class="number">0</span>].file, outputFile);</span><br><span class="line">      <span class="keyword">return</span> spills[<span class="number">0</span>].partitionLengths;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> long[] partitionLengths;</span><br><span class="line">      <span class="keyword">if</span> (fastMergeEnabled &amp;&amp; fastMergeIsSupported) &#123;</span><br><span class="line">        <span class="comment">// å½“ä½¿ç”¨nioçš„transferToä¼ è¾“ ä¸” ä¸éœ€è¦åŠ å¯†æ—¶ï¼Œä½¿ç”¨ transferTo-based fast merge</span></span><br><span class="line">        <span class="keyword">if</span> (transferToEnabled &amp;&amp; !encryptionEnabled) &#123;</span><br><span class="line">          logger.debug(<span class="string">"Using transferTo-based fast merge"</span>);</span><br><span class="line">          partitionLengths = mergeSpillsWithTransferTo(spills, outputFile);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// å¦åˆ™ä½¿ç”¨ fileStream-based fast merge</span></span><br><span class="line">          logger.debug(<span class="string">"Using fileStream-based fast merge"</span>);</span><br><span class="line">          partitionLengths = mergeSpillsWithFileStream(spills, outputFile, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.debug(<span class="string">"Using slow merge"</span>);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ slow merge</span></span><br><span class="line">        partitionLengths = mergeSpillsWithFileStream(spills, outputFile, compressionCodec);</span><br><span class="line">      &#125;</span><br><span class="line">      writeMetrics.decBytesWritten(spills[spills.length - <span class="number">1</span>].file.length());</span><br><span class="line">      writeMetrics.incBytesWritten(outputFile.length());</span><br><span class="line">      <span class="keyword">return</span> partitionLengths;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="type">IOException</span> e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (outputFile.exists() &amp;&amp; !outputFile.delete()) &#123;</span><br><span class="line">      logger.error(<span class="string">"Unable to delete output file &#123;&#125;"</span>, outputFile.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mergeSpillsWithTransferTo-â€¦"><a class="header-anchor" href="#mergeSpillsWithTransferTo-â€¦">Â¶</a>mergeSpillsWithTransferTo(â€¦)</h3>
<p>ç”±äºå†…éƒ¨æµç¨‹éƒ½å·®ä¸å¤šï¼Œå°±ä¸¾ä¸€ä¸ªä¸ºä¾‹ï¼Œæ ¸å¿ƒæ˜¯ä¸ª<strong>2é‡å¾ªç¯</strong>ï¼Œå°†æ‰€æœ‰spillæ–‡ä»¶ä¸­åŒä¸€åˆ†åŒºçš„æ•°æ®åˆå¹¶ï¼Œå¹¶æŒ‰åˆ†åŒºå·æ’åˆ—</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> long[] mergeSpillsWithTransferTo(<span class="type">SpillInfo</span>[] spills, <span class="type">File</span> outputFile) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert (spills.length &gt;= <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">final</span> int numPartitions = partitioner.numPartitions();</span><br><span class="line">  <span class="keyword">final</span> long[] partitionLengths = <span class="keyword">new</span> long[numPartitions];</span><br><span class="line">  <span class="keyword">final</span> <span class="type">FileChannel</span>[] spillInputChannels = <span class="keyword">new</span> <span class="type">FileChannel</span>[spills.length];</span><br><span class="line">  <span class="keyword">final</span> long[] spillInputChannelPositions = <span class="keyword">new</span> long[spills.length];</span><br><span class="line">  <span class="type">FileChannel</span> mergedFileOutputChannel = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  boolean threwException = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¯¹æ¯ä¸ª spill æ–‡ä»¶äº§å‡ºè¾“å…¥æµ</span></span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; spills.length; i++) &#123;</span><br><span class="line">      spillInputChannels[i] = <span class="keyword">new</span> <span class="type">FileInputStream</span>(spills[i].file).getChannel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå¹¶æ–‡ä»¶ çš„è¾“å‡ºæµ</span></span><br><span class="line">    mergedFileOutputChannel = <span class="keyword">new</span> <span class="type">FileOutputStream</span>(outputFile, <span class="literal">true</span>).getChannel();</span><br><span class="line"></span><br><span class="line">    long bytesWrittenToMergedFile = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 2é‡å¾ªç¯ï¼Œç»“æœæ˜¯å°†æ‰€æœ‰spillæ–‡ä»¶ä¸­åŒä¸€åˆ†åŒºçš„æ•°æ®åˆå¹¶ï¼Œå¹¶æŒ‰åˆ†åŒºå·æ’åˆ—</span></span><br><span class="line">    <span class="keyword">for</span> (int partition = <span class="number">0</span>; partition &lt; numPartitions; partition++) &#123;</span><br><span class="line">      <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; spills.length; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> long partitionLengthInSpill = spills[i].partitionLengths[partition];</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileChannel</span> spillInputChannel = spillInputChannels[i];</span><br><span class="line">        <span class="keyword">final</span> long writeStartTime = <span class="type">System</span>.nanoTime();</span><br><span class="line">        <span class="comment">// å°† spill é‡Œçš„ æŒ‡å®šåˆ†åŒºæ•°æ® å†™å…¥åˆå¹¶æ–‡ä»¶ä¸­</span></span><br><span class="line">        <span class="type">Utils</span>.copyFileStreamNIO(</span><br><span class="line">          spillInputChannel,             <span class="comment">// spill æ–‡ä»¶è¾“å…¥æµ</span></span><br><span class="line">          mergedFileOutputChannel,       <span class="comment">// åˆå¹¶æ–‡ä»¶è¾“å‡ºæµ</span></span><br><span class="line">          spillInputChannelPositions[i], <span class="comment">// spill ä¸­ è¯¥åˆ†åŒºèµ·å§‹ä½ç½®</span></span><br><span class="line">          partitionLengthInSpill);       <span class="comment">// spill ä¸­ è¯¥åˆ†åŒºé•¿åº¦</span></span><br><span class="line">        spillInputChannelPositions[i] += partitionLengthInSpill;</span><br><span class="line">        writeMetrics.incWriteTime(<span class="type">System</span>.nanoTime() - writeStartTime);</span><br><span class="line">        bytesWrittenToMergedFile += partitionLengthInSpill;</span><br><span class="line">        partitionLengths[partition] += partitionLengthInSpill; <span class="comment">// æ‰€æœ‰ spill ä¸­è¯¥åˆ†åŒºçš„æ€»é•¿åº¦</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mergedFileOutputChannel.position() != bytesWrittenToMergedFile) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(</span><br><span class="line">        <span class="string">"Current position "</span> + mergedFileOutputChannel.position() + <span class="string">" does not equal expected "</span> +</span><br><span class="line">          <span class="string">"position "</span> + bytesWrittenToMergedFile + <span class="string">" after transferTo. Please check your kernel"</span> +</span><br><span class="line">          <span class="string">" version to see if it is 2.6.32, as there is a kernel bug which will lead to "</span> +</span><br><span class="line">          <span class="string">"unexpected behavior when using transferTo. You can set spark.file.transferTo=false "</span> +</span><br><span class="line">          <span class="string">"to disable this NIO feature."</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    threwException = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; spills.length; i++) &#123;</span><br><span class="line">      assert(spillInputChannelPositions[i] == spills[i].file.length());</span><br><span class="line">      <span class="type">Closeables</span>.close(spillInputChannels[i], threwException);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Closeables</span>.close(mergedFileOutputChannel, threwException);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> partitionLengths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkæºç -shuffleä¹‹BypassMergeSortShuffleWriter</title>
    <url>/2019/11/30/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BBypassMergeSortShuffleWriter/</url>
    <content><![CDATA[<p>spark ä¸‰å¤§ShuffleWriter ä¹‹ BypassMergeSortShuffleWriter</p>
<a id="more"></a>
<p>spark ç‰ˆæœ¬ 2.4.3</p>
<h1>ç‰¹ç‚¹</h1>
<ul>
<li>
<p>å®ƒ<strong>åªé€‚ç”¨ä¸éœ€è¦ map-side aggregation</strong>çš„Shuffleæ“ä½œï¼Œä¸”<strong>Reducerä»»åŠ¡æ•°é‡æ¯”è¾ƒå°‘</strong>ï¼ˆé»˜è®¤200ï¼‰</p>
</li>
<li>
<p>æ•°æ®æ˜¯ç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œæ•°æ®é‡è¾ƒå¤§çš„æ—¶å€™ï¼Œç½‘ç»œI/Oå’Œå†…å­˜è´Ÿæ‹…è¾ƒé‡</p>
</li>
<li>
<p>å†™åˆ†åŒºæ–‡ä»¶æ—¶å¼€äº†å¤šä¸ª<code>DiskBlockObjectWriter</code>ï¼Œå¯¹<strong>å†…å­˜æ¶ˆè€—æ¯”è¾ƒå¤§</strong></p>
</li>
</ul>
<h1>å¤§è‡´æµç¨‹</h1>
<ol>
<li>
<p>ä¸ºæ¯ä¸ªåˆ†åŒºéƒ½åˆ›å»ºä¸€ä¸ª<code>DiskBlockObjectWriter</code></p>
</li>
<li>
<p>éå†æ•°æ®ï¼Œä½¿ç”¨<code>DiskBlockObjectWriter</code>çš„<code>write</code>æ–¹æ³•å°†æ•°æ®å†™å…¥åˆ°ä¸åŒåˆ†åŒºæ–‡ä»¶ä¸­</p>
</li>
<li>
<p>åˆ·å†™åˆ†åŒºæ–‡ä»¶åˆ°ç£ç›˜</p>
</li>
<li>
<p>åˆå¹¶åˆ†åŒºæ–‡ä»¶æˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œå¹¶è¿”å›è®°å½•æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„é•¿åº¦çš„æ•°ç»„</p>
</li>
<li>
<p>æ ¹æ®åˆ†åŒºé•¿åº¦æ•°ç»„ç”Ÿæˆç´¢å¼•æ–‡ä»¶</p>
</li>
<li>
<p>å°è£…ä¿¡æ¯åˆ°<code>MapStatus</code>è¿”å›</p>
</li>
</ol>
<p>æ€»çš„æ¥è¯´å°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ª<strong>ç”±åˆ†åŒºæ–‡ä»¶åˆå¹¶å½¢æˆçš„å¤§æ–‡ä»¶</strong>å’Œä¸€ä¸ª<strong>ç´¢å¼•æ–‡ä»¶</strong>ï¼ˆä¸Šé¢æµç¨‹æ˜¯ä¸»è¦æµç¨‹ï¼Œé‡å‘½åä»€ä¹ˆçš„å°±ä¸å†™äº†ï¼‰ã€‚</p>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/shuffle/BypassMergeSortShuffleWriter.jpg" alt></p>
<h1>æºç </h1>
<h2 id="write-â€¦"><a class="header-anchor" href="#write-â€¦">Â¶</a>write(â€¦)</h2>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line">public void write(<span class="type">Iterator</span>&lt;<span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt;&gt; records) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  assert (partitionWriters == <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">if</span> (!records.hasNext()) &#123;</span><br><span class="line">    partitionLengths = <span class="keyword">new</span> long[numPartitions];</span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(shuffleId, mapId, partitionLengths, <span class="literal">null</span>);</span><br><span class="line">    mapStatus = <span class="type">MapStatus</span>$.<span class="type">MODULE</span>$.apply(blockManager.shuffleServerId(), partitionLengths);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">SerializerInstance</span> serInstance = serializer.newInstance();</span><br><span class="line">  <span class="keyword">final</span> long openStartTime = <span class="type">System</span>.nanoTime();</span><br><span class="line">  <span class="comment">// partitionWriter æ•°ç»„ï¼šåˆ†åŒºå·å³æ˜¯æ•°ç»„åç§»é‡ã€‚å®ƒä»¬å°†æ•°æ®æŒ‰åˆ†åŒºå·åˆ†åˆ«å†™å…¥ä¸åŒçš„ä¸ªæ–‡ä»¶ï¼Œæœ‰å¤šå°‘ä¸ªåˆ†åŒºå°±å½¢æˆå¤šå°‘ä¸ªæ–‡ä»¶</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œçš„ numPartitions æ˜¯åˆ†åŒºåçš„æ•°é‡</span></span><br><span class="line">  partitionWriters = <span class="keyword">new</span> <span class="type">DiskBlockObjectWriter</span>[numPartitions];</span><br><span class="line">  partitionWriterSegments = <span class="keyword">new</span> <span class="type">FileSegment</span>[numPartitions];</span><br><span class="line">  <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; numPartitions; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Tuple2</span>&lt;<span class="type">TempShuffleBlockId</span>, <span class="type">File</span>&gt; tempShuffleBlockIdPlusFile =</span><br><span class="line">      blockManager.diskBlockManager().createTempShuffleBlock();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">File</span> file = tempShuffleBlockIdPlusFile._2();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">BlockId</span> blockId = tempShuffleBlockIdPlusFile._1();</span><br><span class="line">    partitionWriters[i] =</span><br><span class="line">      blockManager.getDiskWriter(blockId, file, serInstance, fileBufferSize, writeMetrics);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Creating the file to write to and creating a disk writer both involve interacting with</span></span><br><span class="line">  <span class="comment">// the disk, and can take a long time in aggregate when we open many files, so should be</span></span><br><span class="line">  <span class="comment">// included in the shuffle write time.</span></span><br><span class="line">  writeMetrics.incWriteTime(<span class="type">System</span>.nanoTime() - openStartTime);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (records.hasNext()) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Product2</span>&lt;<span class="type">K</span>, <span class="type">V</span>&gt; record = records.next();</span><br><span class="line">    <span class="keyword">final</span> <span class="type">K</span> key = record._1();</span><br><span class="line">    <span class="comment">// æŒ‰åˆ†åŒºå™¨çš„è§„åˆ™å†™å…¥æ•°æ®</span></span><br><span class="line">    partitionWriters[partitioner.getPartition(key)].write(key, record._2());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; numPartitions; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">DiskBlockObjectWriter</span> writer = partitionWriters[i];</span><br><span class="line">    <span class="comment">// åˆ·å†™æ•°æ®åˆ°ç£ç›˜</span></span><br><span class="line">    partitionWriterSegments[i] = writer.commitAndGet();</span><br><span class="line">    writer.close();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ–‡ä»¶åï¼š"shuffle_" + shuffleId + "_" + mapId + "_" + reduceId + ".data"</span></span><br><span class="line">  <span class="type">File</span> output = shuffleBlockResolver.getDataFile(shuffleId, mapId);</span><br><span class="line">  <span class="type">File</span> tmp = <span class="type">Utils</span>.tempFileWith(output);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// åˆå¹¶ç”Ÿæˆçš„åˆ†åŒºæ–‡ä»¶ï¼Œå¹¶è¿”å›æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„å¤§å°ï¼Œç”¨äºè®¡ç®—åç§»é‡</span></span><br><span class="line">    partitionLengths = writePartitionedFile(tmp);</span><br><span class="line">    <span class="comment">// ç”Ÿæˆç´¢å¼•æ–‡ä»¶</span></span><br><span class="line">    shuffleBlockResolver.writeIndexFileAndCommit(shuffleId, mapId, partitionLengths, tmp);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¯ä»¥åˆ é™¤æ˜¯å› ä¸º writeIndexFileAndCommit ä¸­é‡å‘½åäº†å®ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (tmp.exists() &amp;&amp; !tmp.delete()) &#123;</span><br><span class="line">      logger.error(<span class="string">"Error while deleting temp file &#123;&#125;"</span>, tmp.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mapStatus = <span class="type">MapStatus</span>$.<span class="type">MODULE</span>$.apply(blockManager.shuffleServerId(), partitionLengths);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="writePartitionedFile-â€¦"><a class="header-anchor" href="#writePartitionedFile-â€¦">Â¶</a>writePartitionedFile(â€¦)</h2>
<p>åˆå¹¶ç”Ÿæˆçš„åˆ†åŒºæ–‡ä»¶ï¼Œå¹¶è¿”å›æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„å¤§å°ï¼Œç”¨äºè®¡ç®—åç§»é‡</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> long[] writePartitionedFile(<span class="type">File</span> outputFile) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">  <span class="comment">// Track location of the partition starts in the output file</span></span><br><span class="line">  <span class="comment">// lengthsæ•°ç»„ï¼šè®°å½•æ¯ä¸ªåˆ†åŒºæ–‡ä»¶çš„å¤§å°</span></span><br><span class="line">  <span class="keyword">final</span> long[] lengths = <span class="keyword">new</span> long[numPartitions];</span><br><span class="line">  <span class="keyword">if</span> (partitionWriters == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We were passed an empty iterator</span></span><br><span class="line">    <span class="keyword">return</span> lengths;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå¹¶æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">FileOutputStream</span> out = <span class="keyword">new</span> <span class="type">FileOutputStream</span>(outputFile, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">final</span> long writeStartTime = <span class="type">System</span>.nanoTime();</span><br><span class="line">  boolean threwException = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; numPartitions; i++) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">File</span> file = partitionWriterSegments[i].file();</span><br><span class="line">      <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">FileInputStream</span> in = <span class="keyword">new</span> <span class="type">FileInputStream</span>(file);</span><br><span class="line">        boolean copyThrewException = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// æŠŠåˆ†åŒºæ–‡ä»¶ æ‹·è´åˆ° åˆå¹¶æ–‡ä»¶ ä¸­ï¼Œå­˜å…¥æ–‡ä»¶å¤§å°åˆ°lengthsæ•°ç»„ä¸­</span></span><br><span class="line">          lengths[i] = <span class="type">Utils</span>.copyStream(in, out, <span class="literal">false</span>, transferToEnabled);</span><br><span class="line">          copyThrewException = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="type">Closeables</span>.close(in, copyThrewException);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ é™¤åˆ†åŒºæ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (!file.delete()) &#123;</span><br><span class="line">          logger.error(<span class="string">"Unable to delete file for partition &#123;&#125;"</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    threwException = <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="type">Closeables</span>.close(out, threwException);</span><br><span class="line">    writeMetrics.incWriteTime(<span class="type">System</span>.nanoTime() - writeStartTime);</span><br><span class="line">  &#125;</span><br><span class="line">  partitionWriters = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> lengths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="writeIndexFileAndCommit-â€¦"><a class="header-anchor" href="#writeIndexFileAndCommit-â€¦">Â¶</a>writeIndexFileAndCommit(â€¦)</h2>
<p>ç”Ÿæˆç´¢å¼•æ–‡ä»¶</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">writeIndexFileAndCommit</span></span>(</span><br><span class="line">    shuffleId: <span class="type">Int</span>,</span><br><span class="line">    mapId: <span class="type">Int</span>,</span><br><span class="line">    lengths: <span class="type">Array</span>[<span class="type">Long</span>],</span><br><span class="line">    dataTmp: <span class="type">File</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> indexFile = getIndexFile(shuffleId, mapId)</span><br><span class="line">  <span class="keyword">val</span> indexTmp = <span class="type">Utils</span>.tempFileWith(indexFile)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> dataFile = getDataFile(shuffleId, mapId)</span><br><span class="line">    <span class="comment">// There is only one IndexShuffleBlockResolver per executor, this synchronization make sure</span></span><br><span class="line">    <span class="comment">// the following check and rename are atomic.</span></span><br><span class="line">    synchronized &#123;</span><br><span class="line">      <span class="keyword">val</span> existingLengths = checkIndexAndDataFile(indexFile, dataFile, lengths.length)</span><br><span class="line">      <span class="keyword">if</span> (existingLengths != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Another attempt for the same task has already written our map outputs successfully,</span></span><br><span class="line">        <span class="comment">// so just use the existing partition lengths and delete our temporary map outputs.</span></span><br><span class="line">        <span class="type">System</span>.arraycopy(existingLengths, <span class="number">0</span>, lengths, <span class="number">0</span>, lengths.length)</span><br><span class="line">        <span class="keyword">if</span> (dataTmp != <span class="literal">null</span> &amp;&amp; dataTmp.exists()) &#123;</span><br><span class="line">          dataTmp.delete()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is the first successful attempt in writing the map outputs for this task,</span></span><br><span class="line">        <span class="comment">// so override any existing index and data files with the ones we wrote.</span></span><br><span class="line">        <span class="keyword">val</span> out = <span class="keyword">new</span> <span class="type">DataOutputStream</span>(<span class="keyword">new</span> <span class="type">BufferedOutputStream</span>(<span class="keyword">new</span> <span class="type">FileOutputStream</span>(indexTmp)))</span><br><span class="line">        <span class="type">Utils</span>.tryWithSafeFinally &#123;</span><br><span class="line">          <span class="comment">// We take in lengths of each block, need to convert it to offsets.</span></span><br><span class="line">          <span class="comment">// ç´¢å¼•å…¶å®å°±æ˜¯æŒ‰ åˆ†åŒºæ–‡ä»¶å¤§å° å ä¸Šå»è€Œå·²</span></span><br><span class="line">          <span class="keyword">var</span> offset = <span class="number">0</span>L</span><br><span class="line">          out.writeLong(offset)</span><br><span class="line">          <span class="keyword">for</span> (length &lt;- lengths) &#123;</span><br><span class="line">            offset += length</span><br><span class="line">            out.writeLong(offset)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; &#123;</span><br><span class="line">          out.close()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (indexFile.exists()) &#123;</span><br><span class="line">          indexFile.delete()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataFile.exists()) &#123;</span><br><span class="line">          dataFile.delete()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡å‘½å indexTmp</span></span><br><span class="line">        <span class="keyword">if</span> (!indexTmp.renameTo(indexFile)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">"fail to rename file "</span> + indexTmp + <span class="string">" to "</span> + indexFile)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡å‘½å dataTmp</span></span><br><span class="line">        <span class="keyword">if</span> (dataTmp != <span class="literal">null</span> &amp;&amp; dataTmp.exists() &amp;&amp; !dataTmp.renameTo(dataFile)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">"fail to rename file "</span> + dataTmp + <span class="string">" to "</span> + dataFile)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (indexTmp.exists() &amp;&amp; !indexTmp.delete()) &#123;</span><br><span class="line">      logError(<span class="string">s"Failed to delete temporary index file at <span class="subst">$&#123;indexTmp.getAbsolutePath&#125;</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkæºç -shuffleä¹‹ShuffleManager</title>
    <url>/2019/11/29/spark%E6%BA%90%E7%A0%81-shuffle%E4%B9%8BShuffleManager/</url>
    <content><![CDATA[<p>spark shuffle å­¦ä¹ èµ·å§‹ç¯‡ï¼Œæ¶‰åŠæºç ä¸­shuffleçš„ç›¸å…³æ¦‚å¿µ åŠ  SortShuffleManager</p>
<a id="more"></a>
<p>spark ç‰ˆæœ¬ 2.4.3</p>
<h1>Spark é‡Œçš„ Shuffle</h1>
<p>shuffle ä¸»è¦åˆ†ä¸º:</p>
<ul>
<li><strong>ShuffleWrite</strong> é˜¶æ®µï¼šä¸Šä¸€ä¸ªstage çš„å°¾ä»»åŠ¡<code>ShuffleMapTask</code> æŠŠæ•°æ®å†™å…¥ç£ç›˜ï¼Œä¹Ÿå«<code>ShuffleMap</code></li>
<li><strong>ShuffleRead</strong> é˜¶æ®µï¼š ä¸‹ä¸€ä¸ªstage æ‹‰å–æ•°æ®ï¼Œä¹Ÿå«<code>ShuffleReduce</code></li>
</ul>
<p>æºç ä¸­çš„ä¸€äº›æ¦‚å¿µï¼š</p>
<ul>
<li>
<p>å¦‚æœæŠŠ spark æ•´ä¸ªæµç¨‹çœ‹æˆä¸€è¾†ç«è½¦ï¼Œé‚£ä¹ˆé™¤äº†æœ€åä¸€èŠ‚æ˜¯<code>ResultStage </code>ï¼Œå…¶å®ƒæ¯ä¸€èŠ‚è½¦å¢å°±æ˜¯ä¸€ä¸ª<code>ShuffleMapStage </code>ï¼Œè¿æ¥è½¦å¢çš„éƒ¨åˆ†å°±æ˜¯<code>shuffle</code>ã€‚</p>
</li>
<li>
<p>è½¦å¢å¤´è¿›è¡Œ <strong>read</strong>ï¼Œè½¦å¢å°¾è¿›è¡Œ <strong>write</strong>ã€‚å¾ˆå®¹æ˜“ç†è§£<code>ShuffleMapStage</code>éœ€è¦è¯»å‰ä¸€ä¸ªstageå†…å®¹ï¼Œä¹Ÿéœ€è¦æŠŠè¾“å‡ºå†™å…¥ä¸‹ä¸€ä¸ªstageï¼›è€Œ<code>ResultStage</code>åªéœ€è¦è¯»ã€‚è¿™äº›å¯ä»¥åœ¨æºç ä¸­å‘ç°ã€‚</p>
</li>
<li>
<p><code>ShuffleMapStage</code>å¯¹åº” <code>ShuffleMapTask</code>ï¼Œ<code>ResultStage</code> å¯¹åº” <code>ResultTask</code>ã€‚</p>
</li>
<li>
<p><strong>read</strong> å®è´¨æ˜¯<code>ShuffleReader</code>é‡Œçš„ <code>read()</code>æ–¹æ³•ï¼›<strong>write</strong> æ˜¯å®è´¨æ˜¯<code>ShuffleWriter</code>é‡Œçš„ <code>write()</code>æ–¹æ³•ã€‚</p>
</li>
<li>
<p><code>ShuffleReader</code> å’Œ <code>ShuffleWriter</code> è¿™ä¸¤å¤§ç»„ä»¶éƒ½ç”±<code>ShuffleManager</code>è¿›è¡Œé€‰æ‹©ã€‚</p>
</li>
</ul>
<p>å¥½äº†ï¼Œè„‘å­é‡Œæœ‰äº†è¿™äº›æ¦‚å¿µï¼Œå°±å¯ä»¥å¯¹è¿™3ä¸ªæ¨¡å—è¿›è¡Œä»”ç»†ç ”ç©¶äº†ã€‚</p>
<h1>SortShuffleManager</h1>
<p>ç”±äº Spark 2.0ä»¥åï¼Œ<code>ShuffleManager</code>åªæä¾›ä¸€ç§å®ç°ï¼š<code>SortShuffleManager</code>ï¼Œå› æ­¤åªæ·±å…¥ç ”ç©¶å®ƒã€‚</p>
<p>ä»¥ä¸‹æ˜¯<code>ShuffleMapTask</code>ä¸­çš„å†™æ“ä½œã€‚å¯ä»¥å‘ç° <code>shuffleManager</code> æ˜¯ <code>SparkEnv</code> ä¸­çš„å±æ€§ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä» SparkEnv ä¸­ å¾—åˆ° shuffleManager</span></span><br><span class="line"><span class="keyword">val</span> manager = <span class="type">SparkEnv</span>.get.shuffleManager</span><br><span class="line"><span class="comment">// ä» shuffleManager ä¸­å¾—åˆ° ShuffleWriter</span></span><br><span class="line">writer = manager.getWriter[<span class="type">Any</span>, <span class="type">Any</span>](dep.shuffleHandle, partitionId, context)</span><br><span class="line"><span class="comment">// æ‰§è¡Œ ShuffleWriter é‡Œçš„ write æ–¹æ³•</span></span><br><span class="line">writer.write(rdd.iterator(partition, context).asInstanceOf[<span class="type">Iterator</span>[_ &lt;: <span class="type">Product2</span>[<span class="type">Any</span>, <span class="type">Any</span>]]])</span><br><span class="line"><span class="comment">// æˆåŠŸå†™å…¥ï¼Œæ”¶å°¾å·¥ä½œ</span></span><br><span class="line">writer.stop(success = <span class="literal">true</span>).get</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œäº‹å…ˆé¢„å‘Šä¸‹ï¼Œæœ‰3ç§<code>ShuffleWriter</code>ï¼Œ1ç§<code>ShuffleReader</code>ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•é€‰æ‹©å‘¢ï¼Ÿæ³¨æ„ä¸Šé¢ï¼Œå®ƒå–å†³äº<code>dep.shuffleHandle</code>ï¼Œè€Œå®ƒæ¥è‡ª<code>shuffleManager</code>çš„<code>registerShuffle()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> shuffleHandle: <span class="type">ShuffleHandle</span> = _rdd.context.env.shuffleManager.registerShuffle(</span><br><span class="line">  shuffleId, _rdd.partitions.length, <span class="keyword">this</span>)</span><br></pre></td></tr></table></figure>
<p>å¥½çš„ï¼Œè®©æˆ‘ä»¬è¿›å…¥<code>SortShuffleManager</code>ä¸­ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<h2 id="registerShuffle-â€¦"><a class="header-anchor" href="#registerShuffle-â€¦">Â¶</a>registerShuffle(â€¦)</h2>
<p>å…¶å®å°±æ˜¯é€‰æ‹© <code>handle</code> çš„è¿‡ç¨‹</p>
<ol>
<li>
<p>å¦‚æœ <strong>ä¸éœ€è¦mapç«¯çš„èšåˆæ“ä½œ</strong> ä¸” <strong>shuffle åçš„åˆ†åŒºæ•°é‡å°äºç­‰äº200</strong>ï¼ˆ<code>spark.shuffle.sort.bypassMergeThreshold</code>ï¼‰ï¼Œå°±é€‰æ‹© <code>BypassMergeSortShuffleHandle</code>ã€‚å¦åˆ™è¿›å…¥ç¬¬äºŒæ­¥</p>
</li>
<li>
<p>å¦‚æœ <strong>åºåˆ—åŒ–å™¨æ”¯æŒé‡å®šä½</strong> ä¸” <strong>ä¸éœ€è¦mapç«¯èšåˆ</strong> ä¸” <strong>shuffle åçš„åˆ†åŒºæ•°ç›®å°äºç­‰äº2^24)</strong>ï¼Œå°±é€‰æ‹© <code>SerializedShuffleHandle</code>ã€‚å¦åˆ™è¿›å…¥ç¬¬ä¸‰æ­¥</p>
</li>
<li>
<p>é€‰æ‹© <code>BaseShuffleHandle</code></p>
</li>
</ol>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">registerShuffle</span></span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>](</span><br><span class="line">    shuffleId: <span class="type">Int</span>,</span><br><span class="line">    numMaps: <span class="type">Int</span>,</span><br><span class="line">    dependency: <span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">C</span>]): <span class="type">ShuffleHandle</span> = &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="type">SortShuffleWriter</span>.shouldBypassMergeSort(conf, dependency)) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">BypassMergeSortShuffleHandle</span>[<span class="type">K</span>, <span class="type">V</span>](</span><br><span class="line">      shuffleId, numMaps, dependency.asInstanceOf[<span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">V</span>]])</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">SortShuffleManager</span>.canUseSerializedShuffle(dependency)) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">SerializedShuffleHandle</span>[<span class="type">K</span>, <span class="type">V</span>](</span><br><span class="line">      shuffleId, numMaps, dependency.asInstanceOf[<span class="type">ShuffleDependency</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">V</span>]])</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="type">BaseShuffleHandle</span>(shuffleId, numMaps, dependency)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="getWriter-â€¦"><a class="header-anchor" href="#getWriter-â€¦">Â¶</a>getWriter(â€¦)</h2>
<p>æ ¹æ®ä¸Šé¢å¾—åˆ°çš„<code>handle</code>ï¼Œè¿›è¡Œæ¨¡å¼åŒ¹é…é€‰æ‹©<code>ShuffleWriter</code>ï¼Œæœ‰3ç§ï¼š</p>
<p><code>BypassMergeSortHandle</code>  --&gt; <code>BypassMergeSortShuffleWriter</code></p>
<p><code>SerializedShuffleHandle</code> --&gt; <code>UnsafeShuffleWriter</code></p>
<p><code>other(BaseShuffleHandle)</code> --&gt; <code>SortShuffleWriter</code></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getWriter</span></span>[<span class="type">K</span>, <span class="type">V</span>](</span><br><span class="line">    handle: <span class="type">ShuffleHandle</span>,</span><br><span class="line">    mapId: <span class="type">Int</span>,</span><br><span class="line">    context: <span class="type">TaskContext</span>): <span class="type">ShuffleWriter</span>[<span class="type">K</span>, <span class="type">V</span>] = &#123;</span><br><span class="line">  numMapsForShuffle.putIfAbsent(</span><br><span class="line">    handle.shuffleId, handle.asInstanceOf[<span class="type">BaseShuffleHandle</span>[_, _, _]].numMaps)</span><br><span class="line">  <span class="keyword">val</span> env = <span class="type">SparkEnv</span>.get</span><br><span class="line">  handle <span class="keyword">match</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> unsafeShuffleHandle: <span class="type">SerializedShuffleHandle</span>[<span class="type">K</span> <span class="meta">@unchecked</span>, <span class="type">V</span> <span class="meta">@unchecked</span>] =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">UnsafeShuffleWriter</span>(</span><br><span class="line">        env.blockManager,</span><br><span class="line">        shuffleBlockResolver.asInstanceOf[<span class="type">IndexShuffleBlockResolver</span>],</span><br><span class="line">        context.taskMemoryManager(),</span><br><span class="line">        unsafeShuffleHandle,</span><br><span class="line">        mapId,</span><br><span class="line">        context,</span><br><span class="line">        env.conf)</span><br><span class="line">    <span class="keyword">case</span> bypassMergeSortHandle: <span class="type">BypassMergeSortShuffleHandle</span>[<span class="type">K</span> <span class="meta">@unchecked</span>, <span class="type">V</span> <span class="meta">@unchecked</span>] =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">BypassMergeSortShuffleWriter</span>(</span><br><span class="line">        env.blockManager,</span><br><span class="line">        shuffleBlockResolver.asInstanceOf[<span class="type">IndexShuffleBlockResolver</span>],</span><br><span class="line">        bypassMergeSortHandle,</span><br><span class="line">        mapId,</span><br><span class="line">        context,</span><br><span class="line">        env.conf)</span><br><span class="line">    <span class="keyword">case</span> other: <span class="type">BaseShuffleHandle</span>[<span class="type">K</span> <span class="meta">@unchecked</span>, <span class="type">V</span> <span class="meta">@unchecked</span>, _] =&gt;</span><br><span class="line">      <span class="keyword">new</span> <span class="type">SortShuffleWriter</span>(shuffleBlockResolver, other, mapId, context)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="getReader-â€¦"><a class="header-anchor" href="#getReader-â€¦">Â¶</a>getReader(â€¦)</h2>
<p>åªæœ‰ä¸€ç§<code>ShuffleReader</code>ï¼š<code>BlockStoreShuffleReader</code></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getReader</span></span>[<span class="type">K</span>, <span class="type">C</span>](</span><br><span class="line">    handle: <span class="type">ShuffleHandle</span>,</span><br><span class="line">    startPartition: <span class="type">Int</span>,</span><br><span class="line">    endPartition: <span class="type">Int</span>,</span><br><span class="line">    context: <span class="type">TaskContext</span>): <span class="type">ShuffleReader</span>[<span class="type">K</span>, <span class="type">C</span>] = &#123;</span><br><span class="line">  <span class="keyword">new</span> <span class="type">BlockStoreShuffleReader</span>(</span><br><span class="line">    handle.asInstanceOf[<span class="type">BaseShuffleHandle</span>[<span class="type">K</span>, _, <span class="type">C</span>]], startPartition, endPartition, context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkæºç -Partitionerå­¦ä¹ </title>
    <url>/2019/11/28/spark%E6%BA%90%E7%A0%81-Partitioner%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>Partitionerï¼ˆåˆ†åŒºå™¨ï¼‰å­¦ä¹ </p>
<a id="more"></a>
<p>spark ç‰ˆæœ¬ 2.4.3</p>
<h1>Partitioner</h1>
<p>åˆ†åŒºå™¨ï¼ŒRDDäº”å¤§ç‰¹æ€§ä¹‹äº”ï¼ˆåªé’ˆå¯¹ï¼ˆk,vï¼‰ç±»å‹çš„RDDï¼‰ã€‚å®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ä½¿ç”¨ <code>getPartition(key: Any)</code>å¯¹æ¯æ¡æ•°æ®è¿›è¡Œåˆ†åŒº</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Partitioner</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">numPartitions</span></span>: <span class="type">Int</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">getPartition</span></span>(key: <span class="type">Any</span>): <span class="type">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒæœ‰ä¸¤å¤§å®ç°ï¼Œ<code>HashPartitioner</code> å’Œ <code>RangePartitioner</code>ã€‚åˆ†åŒºæ˜¯ä¸ºäº†å¹¶è¡Œå¤„ç†ï¼Œæ‰€ä»¥è®©æ¯ä¸ªåˆ†åŒºçš„å¤§å°å·®ä¸å¤šæ˜¯é¦–è¦ç›®æ ‡ã€‚</p>
<h1>HashPartitioner</h1>
<p>è¿™ä¸ªæ˜¯æœ€ç®€å•çš„ï¼Œç›´æ¥é€šè¿‡ key çš„ hashCode å–æ¨¡åˆ†åŒºï¼Œèƒ½è®©æ•°æ®å¤§è‡´å‡åŒ€åœ°åˆ†å¸ƒåœ¨å„ä¸ªåˆ†åŒºã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class HashPartitioner(partitions: Int) extends Partitioner &#123;</span><br><span class="line">  require(partitions &gt;= 0, s&quot;Number of partitions ($partitions) cannot be negative.&quot;)</span><br><span class="line"></span><br><span class="line">  def numPartitions: Int = partitions</span><br><span class="line"></span><br><span class="line">  // çœ‹è¿™é‡Œ</span><br><span class="line">  def getPartition(key: Any): Int = key match &#123;</span><br><span class="line">    case null =&gt; 0</span><br><span class="line">    case _ =&gt; Utils.nonNegativeMod(key.hashCode, numPartitions)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override def equals(other: Any): Boolean = other match &#123;</span><br><span class="line">    case h: HashPartitioner =&gt;</span><br><span class="line">      h.numPartitions == numPartitions</span><br><span class="line">    case _ =&gt;</span><br><span class="line">      false</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override def hashCode: Int = numPartitions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1>RangePartitioner</h1>
<p>æ—¢ç„¶æœ‰äº†hashåˆ†åŒºï¼Œä¸ºä»€ä¹ˆè¿˜è¦rangeåˆ†åŒºå‘¢ã€‚äº‹æƒ³éœ€è¦å…¨å±€æ’åºæ—¶ï¼Œå¦‚æœä½¿ç”¨hashåˆ†åŒºï¼Œæ’åºååªæ˜¯åˆ†åŒºæœ‰åºï¼Œç„¶åå†å¯¹åˆ†åŒºè¿›è¡Œå½’å¹¶æ’åºï¼Œè¿™æ ·å·¥ä½œé‡æ˜¯ä¸æ˜¯ç‰¹åˆ«å¤§ã€‚æ‰€ä»¥æ’åºæ—¶ä¸€èˆ¬ç”¨ <code>RangePartitioner</code> ï¼Œæ¯”å¦‚ <code>sortByKey</code>ã€‚å®ƒçš„æ•ˆæœè®©æ˜¯ä¸€ä¸ªåˆ†åŒºä¸­çš„å…ƒç´ è‚¯å®šéƒ½æ˜¯æ¯”å¦ä¸€ä¸ªåˆ†åŒºå†…çš„å…ƒç´ å°æˆ–è€…å¤§ã€‚è¿™æ ·åˆ†åŒºæ’åºåçš„æ•°æ®å°±æ˜¯å…¨å±€æœ‰åºçš„ã€‚å¹¶ä¸”å®ƒé€šè¿‡é‡‡æ ·æ“ä½œå¯ä»¥è®©æ•°æ®æ¯”è¾ƒå‡åŒ€åœ°åˆ†å¸ƒåˆ°å„ä¸ªåˆ†åŒºã€‚</p>
<p>å®ƒçš„å¤§è‡´æ­¥éª¤æ˜¯ï¼šå¯¹æ¯ä¸ªåˆ†åŒºè¿›è¡Œé‡‡æ ·ï¼ˆè“„æ°´æ± é‡‡æ ·ï¼‰ -&gt; åˆ¤æ–­æ¯ä¸ªåˆ†åŒºçš„é‡‡æ ·ç»“æœæ˜¯å¦åˆæ ¼ï¼Œå¦‚æœä¸åˆæ ¼å†æ¬¡é‡‡æ · -&gt; æŠŠé‡‡æ ·æ•°æ®æ’åºï¼Œæ¯æ¡é‡‡æ ·æ•°æ®éƒ½æœ‰æƒé‡ï¼ŒæŒ‰æƒé‡ï¼Œè®¡ç®—å‡ºåˆ†è§£è¾¹ç•Œæ•°ç»„<code>rangeBounds</code> -&gt; æŒ‰è¾¹ç•Œï¼ŒæŠŠæ•°æ®åˆ’åˆ†åˆ°ä¸åŒåˆ†åŒº<code>getPartition(key: Any)</code>ã€‚</p>
<h2 id="rangeBounds"><a class="header-anchor" href="#rangeBounds">Â¶</a>rangeBounds</h2>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rangeBounds: <span class="type">Array</span>[<span class="type">K</span>] = &#123;</span><br><span class="line">  <span class="keyword">if</span> (partitions &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">Array</span>.empty</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// This is the sample size we need to have roughly balanced output partitions, capped at 1M.</span></span><br><span class="line">    <span class="comment">// Cast to double to avoid overflowing ints or longs</span></span><br><span class="line">    <span class="comment">// æ€»é‡‡æ ·ç‚¹çš„ä¸ªæ•°ï¼Œä¸è¶…è¿‡ 1e6ï¼Œæ³¨æ„ partitions æ˜¯åˆ†åŒºåçš„åˆ†åŒºä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">val</span> sampleSize = math.min(samplePointsPerPartitionHint.toDouble * partitions, <span class="number">1e6</span>)</span><br><span class="line">    <span class="comment">// Assume the input partitions are roughly balanced and over-sample a little bit.</span></span><br><span class="line">    <span class="comment">// æ¯ä¸ªåˆ†åŒºçš„é‡‡æ ·ç‚¹ä¸ªæ•°ï¼Œå¹¶ä¹˜äº†3è¿›è¡Œè¿‡é‡‡æ ·</span></span><br><span class="line">    <span class="keyword">val</span> sampleSizePerPartition = math.ceil(<span class="number">3.0</span> * sampleSize / rdd.partitions.length).toInt</span><br><span class="line">    <span class="comment">// ä½¿ç”¨è“„æ°´æ± é‡‡æ ·æ³•ï¼ˆè§ä¸‹ï¼‰è¿›è¡Œé‡‡æ ·ï¼Œè¿”å›æ€»æ•°æ®ä¸ªæ•°ï¼Œå’Œæ¯ä¸ªåˆ†åŒºçš„é‡‡æ ·æƒ…å†µ(partitionId, è¯¥åˆ†åŒºæ•°æ®æ€»ä¸ªæ•°, sample)</span></span><br><span class="line">    <span class="keyword">val</span> (numItems, sketched) = <span class="type">RangePartitioner</span>.sketch(rdd.map(_._1), sampleSizePerPartition)</span><br><span class="line">    <span class="keyword">if</span> (numItems == <span class="number">0</span>L) &#123;</span><br><span class="line">      <span class="type">Array</span>.empty</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If a partition contains much more than the average number of items, we re-sample from it</span></span><br><span class="line">      <span class="comment">// to ensure that enough items are collected from that partition.</span></span><br><span class="line">      <span class="keyword">val</span> fraction = math.min(sampleSize / math.max(numItems, <span class="number">1</span>L), <span class="number">1.0</span>)</span><br><span class="line">      <span class="keyword">val</span> candidates = <span class="type">ArrayBuffer</span>.empty[(<span class="type">K</span>, <span class="type">Float</span>)]</span><br><span class="line">      <span class="keyword">val</span> imbalancedPartitions = mutable.<span class="type">Set</span>.empty[<span class="type">Int</span>]</span><br><span class="line">      sketched.foreach &#123; <span class="keyword">case</span> (idx, n, sample) =&gt;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸€ä¸ªåˆ†åŒºé‡‡æ ·è¿‡å¤šï¼Œå°±é‡æ–°é‡‡æ ·å®ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (fraction * n &gt; sampleSizePerPartition) &#123;</span><br><span class="line">          imbalancedPartitions += idx</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// The weight is 1 over the sampling probability.</span></span><br><span class="line">          <span class="comment">// æƒé‡ = è¯¥åˆ†åŒºæ•°æ®æ€»ä¸ªæ•° / é‡‡æ ·ç‚¹æ•°</span></span><br><span class="line">          <span class="keyword">val</span> weight = (n.toDouble / sample.length).toFloat</span><br><span class="line">          <span class="keyword">for</span> (key &lt;- sample) &#123;</span><br><span class="line">            candidates += ((key, weight))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (imbalancedPartitions.nonEmpty) &#123;</span><br><span class="line">        <span class="comment">// Re-sample imbalanced partitions with the desired sampling probability.</span></span><br><span class="line">        <span class="comment">// é‡æ–°é‡‡æ ·</span></span><br><span class="line">        <span class="keyword">val</span> imbalanced = <span class="keyword">new</span> <span class="type">PartitionPruningRDD</span>(rdd.map(_._1), imbalancedPartitions.contains)</span><br><span class="line">        <span class="keyword">val</span> seed = byteswap32(-rdd.id - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">val</span> reSampled = imbalanced.sample(withReplacement = <span class="literal">false</span>, fraction, seed).collect()</span><br><span class="line">        <span class="comment">// ä»¥é‡‡æ ·ç‡çš„å€’æ•°åšæƒé‡</span></span><br><span class="line">        <span class="keyword">val</span> weight = (<span class="number">1.0</span> / fraction).toFloat</span><br><span class="line">        candidates ++= reSampled.map(x =&gt; (x, weight))</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// è¿”å›æ¯ä¸ªåˆ†åŒºè¾¹ç•Œæ•°æ®çš„æ•°ç»„ï¼ˆè§ä¸‹ï¼‰ï¼Œæ•°ç»„é•¿åº¦ä¸ºåˆ†åŒºä¸ªæ•° - 1 (å¾ˆå¥½ç†è§£ï¼Œåˆ‡4ä»½è¥¿ç“œï¼Œéœ€è¦3åˆ€)</span></span><br><span class="line">      <span class="type">RangePartitioner</span>.determineBounds(candidates, math.min(partitions, candidates.size))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir-Samplingï¼‰"><a class="header-anchor" href="#è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir-Samplingï¼‰">Â¶</a>è“„æ°´æ± é‡‡æ ·ç®—æ³•ï¼ˆReservoir Samplingï¼‰</h2>
<ul>
<li>åœºæ™¯ï¼šæ•°æ®æµé•¿åº¦Nå¾ˆå¤§ä¸”ä¸å¯çŸ¥ï¼Œä¸èƒ½ä¸€æ¬¡æ€§å­˜å…¥å†…å­˜ï¼›ä¿è¯æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼›éšæœºé€‰å–kä¸ªæ•°ï¼Œæ¯ä¸ªæ•°è¢«é€‰ä¸­çš„æ¦‚ç‡ä¸º k/Nã€‚</li>
<li>æ­¥éª¤ï¼š
<ol>
<li>å¦‚æœæ•°æ®æ€»é‡å°äºkï¼Œåˆ™ä¾æ¬¡æ”¾å…¥è“„æ°´æ± ã€‚æ± å­æ»¡äº†ï¼Œè¿›å…¥æ­¥éª¤2ã€‚</li>
<li>å½“éå†åˆ°ç¬¬iä¸ªæ•°æ®æ—¶ï¼Œåœ¨[0, i]èŒƒå›´å†…å–ä»¥éšæœºæ•°dï¼Œè‹¥dçš„è½åœ¨[0, k-1]èŒƒå›´å†…ï¼Œåˆ™ç”¨è¯¥æ•°æ®æ›¿æ¢è“„æ°´æ± ä¸­çš„ç¬¬dä¸ªæ•°æ®ã€‚</li>
<li>é‡å¤æ­¥éª¤2ï¼Œç›´åˆ°éå†å®Œã€‚</li>
</ol>
</li>
</ul>
<p>æƒ³æ·±ç©¶åŸç†çš„çœ‹<a href="https://www.jianshu.com/p/7a9ea6ece2af" target="_blank" rel="noopener">è¿™ä¸ª</a>ï¼Œä¸‹é¢æ˜¯ spark ä¸­å¯¹è¯¥ç®—æ³•æ˜¯å®ç°ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sketch</span></span>[<span class="type">K</span> : <span class="type">ClassTag</span>](</span><br><span class="line">    rdd: <span class="type">RDD</span>[<span class="type">K</span>],</span><br><span class="line">    sampleSizePerPartition: <span class="type">Int</span>): (<span class="type">Long</span>, <span class="type">Array</span>[(<span class="type">Int</span>, <span class="type">Long</span>, <span class="type">Array</span>[<span class="type">K</span>])]) = &#123;</span><br><span class="line">  <span class="keyword">val</span> shift = rdd.id</span><br><span class="line">  <span class="comment">// val classTagK = classTag[K] // to avoid serializing the entire partitioner object</span></span><br><span class="line">  <span class="keyword">val</span> sketched = rdd.mapPartitionsWithIndex &#123; (idx, iter) =&gt;</span><br><span class="line">    <span class="keyword">val</span> seed = byteswap32(idx ^ (shift &lt;&lt; <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">val</span> (sample, n) = <span class="type">SamplingUtils</span>.reservoirSampleAndCount(</span><br><span class="line">      iter, sampleSizePerPartition, seed)</span><br><span class="line">    <span class="type">Iterator</span>((idx, n, sample))</span><br><span class="line">  &#125;.collect()</span><br><span class="line">  <span class="keyword">val</span> numItems = sketched.map(_._2).sum</span><br><span class="line">  (numItems, sketched)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒæ­¥éª¤æ˜¯é€šè¿‡ <code>SamplingUtils.reservoirSampleAndCount(xxx)</code> å¾—åˆ°é‡‡æ ·ç»“æœ</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reservoirSampleAndCount</span></span>[<span class="type">T</span>: <span class="type">ClassTag</span>](</span><br><span class="line">    input: <span class="type">Iterator</span>[<span class="type">T</span>],</span><br><span class="line">    k: <span class="type">Int</span>,</span><br><span class="line">    seed: <span class="type">Long</span> = <span class="type">Random</span>.nextLong())</span><br><span class="line">  : (<span class="type">Array</span>[<span class="type">T</span>], <span class="type">Long</span>) = &#123;</span><br><span class="line">  <span class="keyword">val</span> reservoir = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">T</span>](k) <span class="comment">// è£…é‡‡æ ·ç‚¹çš„è“„æ°´æ± </span></span><br><span class="line">  <span class="comment">// Put the first k elements in the reservoir.</span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt; k &amp;&amp; input.hasNext) &#123;</span><br><span class="line">    <span class="keyword">val</span> item = input.next()</span><br><span class="line">    reservoir(i) = item</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we have consumed all the elements, return them. Otherwise do the replacement.</span></span><br><span class="line">  <span class="keyword">if</span> (i &lt; k) &#123;</span><br><span class="line">    <span class="comment">// If input size &lt; k, trim the array to return only an array of input size.</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ•°æ®æ€»ä¸ªæ•°ä¸è¶³é‡‡æ ·ä¸ªæ•°ï¼Œé‚£å°±å…¨éƒ¨é‡‡æ ·äº†ï¼Œç„¶åè¿”å›</span></span><br><span class="line">    <span class="keyword">val</span> trimReservoir = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">T</span>](i)</span><br><span class="line">    <span class="type">System</span>.arraycopy(reservoir, <span class="number">0</span>, trimReservoir, <span class="number">0</span>, i)</span><br><span class="line">    (trimReservoir, i)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If input size &gt; k, continue the sampling process.</span></span><br><span class="line">    <span class="keyword">var</span> l = i.toLong</span><br><span class="line">    <span class="keyword">val</span> rand = <span class="keyword">new</span> <span class="type">XORShiftRandom</span>(seed)</span><br><span class="line">    <span class="comment">// å¯¹æ•´ä¸ª input éå†ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">while</span> (input.hasNext) &#123;</span><br><span class="line">      <span class="keyword">val</span> item = input.next()</span><br><span class="line">      l += <span class="number">1</span></span><br><span class="line">      <span class="comment">// There are k elements in the reservoir, and the l-th element has been</span></span><br><span class="line">      <span class="comment">// consumed. It should be chosen with probability k/l. The expression</span></span><br><span class="line">      <span class="comment">// below is a random long chosen uniformly from [0,l)</span></span><br><span class="line">      <span class="keyword">val</span> replacementIndex = (rand.nextDouble() * l).toLong <span class="comment">// å–[0,l)çš„éšæœºæ•°d</span></span><br><span class="line">      <span class="comment">// å¦‚æœ d åœ¨ k çš„èŒƒå›´å†…ï¼Œåˆ™ç”¨ item æ›¿æ¢æ± å­é‡Œçš„ç¬¬dä¸ªæ•°æ®ã€‚</span></span><br><span class="line">      <span class="keyword">if</span> (replacementIndex &lt; k) &#123;</span><br><span class="line">        reservoir(replacementIndex.toInt) = item</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    (reservoir, l)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æŒ‰æƒé‡é€‰æ‹©è¾¹ç•Œ"><a class="header-anchor" href="#æŒ‰æƒé‡é€‰æ‹©è¾¹ç•Œ">Â¶</a>æŒ‰æƒé‡é€‰æ‹©è¾¹ç•Œ</h2>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Determines the bounds for range partitioning from candidates with weights indicating how many</span></span><br><span class="line"><span class="comment">  * items each represents. Usually this is 1 over the probability used to sample this candidate.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @param candidates unordered candidates with weights</span></span><br><span class="line"><span class="comment">  * @param partitions number of partitions</span></span><br><span class="line"><span class="comment">  * @return selected bounds</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">determineBounds</span></span>[<span class="type">K</span> : <span class="type">Ordering</span> : <span class="type">ClassTag</span>](</span><br><span class="line">     candidates: <span class="type">ArrayBuffer</span>[(<span class="type">K</span>, <span class="type">Float</span>)],</span><br><span class="line">     partitions: <span class="type">Int</span>): <span class="type">Array</span>[<span class="type">K</span>] = &#123;</span><br><span class="line">   <span class="keyword">val</span> ordering = implicitly[<span class="type">Ordering</span>[<span class="type">K</span>]]</span><br><span class="line">   <span class="keyword">val</span> ordered = candidates.sortBy(_._1) <span class="comment">// æŠŠé‡‡æ ·ç‚¹æ’å¥½åº</span></span><br><span class="line">   <span class="keyword">val</span> numCandidates = ordered.size</span><br><span class="line">   <span class="keyword">val</span> sumWeights = ordered.map(_._2.toDouble).sum</span><br><span class="line">   <span class="keyword">val</span> step = sumWeights / partitions</span><br><span class="line">   <span class="keyword">var</span> cumWeight = <span class="number">0.0</span></span><br><span class="line">   <span class="keyword">var</span> target = step</span><br><span class="line">   <span class="keyword">val</span> bounds = <span class="type">ArrayBuffer</span>.empty[<span class="type">K</span>]</span><br><span class="line">   <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">   <span class="keyword">var</span> j = <span class="number">0</span></span><br><span class="line">   <span class="keyword">var</span> previousBound = <span class="type">Option</span>.empty[<span class="type">K</span>]</span><br><span class="line">   <span class="keyword">while</span> ((i &lt; numCandidates) &amp;&amp; (j &lt; partitions - <span class="number">1</span>)) &#123;</span><br><span class="line">     <span class="keyword">val</span> (key, weight) = ordered(i)</span><br><span class="line">     cumWeight += weight</span><br><span class="line">     <span class="keyword">if</span> (cumWeight &gt;= target) &#123;</span><br><span class="line">       <span class="comment">// Skip duplicate values.</span></span><br><span class="line">       <span class="keyword">if</span> (previousBound.isEmpty || ordering.gt(key, previousBound.get)) &#123;</span><br><span class="line">         bounds += key</span><br><span class="line">         target += step</span><br><span class="line">         j += <span class="number">1</span></span><br><span class="line">         previousBound = <span class="type">Some</span>(key)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     i += <span class="number">1</span></span><br><span class="line">   &#125;</span><br><span class="line">   bounds.toArray</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="getPartition-key-Any"><a class="header-anchor" href="#getPartition-key-Any">Â¶</a>getPartition(key: Any)</h2>
<p>æœ‰äº†è¾¹ç•Œï¼Œ<code>getPartition(key: Any)</code>å°±å¾ˆå¥½è®¡ç®—äº†ï¼Œå…¶å®å°±æ˜¯ä¸ªåœ¨æœ‰åºåŒºé—´æ‰¾ä½ç½®çš„è¿‡ç¨‹ã€‚åˆ†åŒºå°‘å°±ä¸€ä¸ªä¸ªæ¯”è¿‡å»ï¼Œå¦‚æœåŒºé—´æ•°å¤§äº128ï¼Œå°±ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾è·å–åˆ†åŒºä½ç½®ã€‚</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPartition</span></span>(key: <span class="type">Any</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">  <span class="keyword">val</span> k = key.asInstanceOf[<span class="type">K</span>]</span><br><span class="line">  <span class="keyword">var</span> partition = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (rangeBounds.length &lt;= <span class="number">128</span>) &#123;</span><br><span class="line">    <span class="comment">// If we have less than 128 partitions naive search</span></span><br><span class="line">    <span class="keyword">while</span> (partition &lt; rangeBounds.length &amp;&amp; ordering.gt(k, rangeBounds(partition))) &#123;</span><br><span class="line">      partition += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">    partition = binarySearch(rangeBounds, k)</span><br><span class="line">    <span class="comment">// binarySearch either returns the match location or -[insertion point]-1</span></span><br><span class="line">    <span class="keyword">if</span> (partition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      partition = -partition<span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (partition &gt; rangeBounds.length) &#123;</span><br><span class="line">      partition = rangeBounds.length</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ ¹æ®å‡åºè¿˜æ˜¯é™åºï¼Œè¿”å›ç›¸åº”çš„PartitionIdã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (ascending) &#123;</span><br><span class="line">    partition</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rangeBounds.length - partition</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkæ‚è°ˆ-ä½¿ç”¨textFileè¯»å–HDFSçš„åˆ†åŒºè§„åˆ™</title>
    <url>/2019/11/27/spark%E6%9D%82%E8%B0%88-%E4%BD%BF%E7%94%A8textFile%E8%AF%BB%E5%8F%96HDFS%E7%9A%84%E5%88%86%E5%8C%BA%E8%A7%84%E5%88%99/</url>
    <content><![CDATA[<p>ä½¿ç”¨ textFile è¯»å–HDFSçš„æ•°æ®åˆ†åŒºè§„åˆ™</p>
<a id="more"></a>
<p>spark ç‰ˆæœ¬ 2.4.3</p>
<h1>è·Ÿç€æºç èµ°</h1>
<p>æµ‹è¯•æ–‡ä»¶ï¼šå¤§å° 516.06 MB ï¼Œ54ä¸ª blockï¼ŒblockSize å¤§å°æ˜¯128Mï¼Œä½†æ¯ä¸ª block é‡Œé¢çš„æ•°æ®åªæœ‰10M å·¦å³</p>
<p><strong>1. è¿›å…¥ <code>sc.textFile()</code></strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> textFile: <span class="type">RDD</span>[<span class="type">String</span>] = sc.textFile(<span class="string">"hdfs://xxxx"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// textFile() æœ‰ä¸ªé»˜è®¤å€¼ï¼šminPartitions</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">textFile</span></span>(</span><br><span class="line">    path: <span class="type">String</span>,</span><br><span class="line">    minPartitions: <span class="type">Int</span> = defaultMinPartitions)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å®ƒæ˜¯å– defaultParallelism å’Œ 2 çš„æœ€å°å€¼ </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">defaultMinPartitions</span></span>: <span class="type">Int</span> = math.min(defaultParallelism, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸ª defaultParallelism ä¸æŒ‡å®šå°±æ˜¯ totalCoresï¼Œæˆ‘è¿™é‡Œæ˜¯4</span></span><br><span class="line">scheduler.conf.getInt(<span class="string">"spark.default.parallelism"</span>, totalCores)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰€ä»¥ defaultMinPartitions æœ€ç»ˆä¸º2</span></span><br></pre></td></tr></table></figure>
<p><strong>2. åˆ›å»º <code>HadoopRDD</code></strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="type">HadoopRDD</span>(</span><br><span class="line">  <span class="keyword">this</span>,</span><br><span class="line">  confBroadcast,</span><br><span class="line">  <span class="type">Some</span>(setInputPathsFunc),</span><br><span class="line">  inputFormatClass,</span><br><span class="line">  keyClass,</span><br><span class="line">  valueClass,</span><br><span class="line">  minPartitions).setName(path)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3. æ¯ä¸ªRDD éƒ½æœ‰ä¸€ä¸ª <code>getPartitions</code> å‡½æ•°ï¼Œç”±å®ƒå¾—åˆ°åˆ†åŒºå·</strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getPartitions</span></span>: <span class="type">Array</span>[<span class="type">Partition</span>] = &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">  		<span class="keyword">val</span> allInputSplits = getInputFormat(jobConf).getSplits(jobConf, minPartitions)</span><br><span class="line">  	...</span><br><span class="line">   <span class="keyword">val</span> array = <span class="keyword">new</span> <span class="type">Array</span>[<span class="type">Partition</span>](inputSplits.size)</span><br><span class="line">   <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until inputSplits.size) &#123;</span><br><span class="line">   		array(i) = <span class="keyword">new</span> <span class="type">HadoopPartition</span>(id, i, inputSplits(i))</span><br><span class="line">   &#125;</span><br><span class="line">   array</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4. é‡‡ç”¨<code>FileInputFormat</code> é‡Œçš„ <code>getSplits()</code> åˆ’åˆ†åˆ†åŒºï¼Œå…ˆè®¡ç®— splitSize</strong></p>
<p><code>getPartitions</code> çš„ æ ¸å¿ƒæ˜¯ <code>getSplits()</code>ï¼Œä¸‹é¢æ˜¯è®¡ç®—åˆ†åŒºå…³é”®æ­¥éª¤</p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ€»å¤§å°é™¤2ï¼Œä¸º258M</span></span><br><span class="line">long goalSize = totalSize / (long)(numSplits == <span class="number">0</span> ? <span class="number">1</span> : numSplits);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™æ˜¯äººä¸ºè®¾å®šçš„åˆ†åŒºæœ€å°å€¼ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£</span></span><br><span class="line">long minSize = <span class="type">Math</span>.max(job.getLong(<span class="string">"mapreduce.input.fileinputformat.split.minsize"</span>, <span class="number">1</span>L), <span class="keyword">this</span>.minSplitSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// HDFS æ–‡ä»¶çš„å—å¤§å°ï¼Œ128M</span></span><br><span class="line">long blockSize = file.getBlockSize();</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®— splitSize</span></span><br><span class="line">long splitSize = <span class="keyword">this</span>.computeSplitSize(goalSize, minSize, blockSize);</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>å‡è®¾æ–‡ä»¶å¤§å°ä¸º 20Mï¼š <code>splitSize = maxï¼ˆ1ï¼Œmin(10,128)) = 10M</code></p>
</li>
<li>
<p>å‡è®¾æ–‡ä»¶å¤§å°ä¸º 516Mï¼š<code>splitSize  = max(1, min(258,128)) = 128M </code>ï¼ˆæœ¬æ–‡ï¼‰</p>
</li>
</ul>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> long computeSplitSize(long goalSize, long minSize, long blockSize) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Math</span>.max(minSize, <span class="type">Math</span>.min(goalSize, blockSize));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>5. æœ€åï¼ŒæŒ‰ splitSize åˆ‡åˆ†åŒº</strong></p>
<figure class="highlight scala"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥å‘ç°ä¸ºäº†é˜²æ­¢æœ€åä¸€ä¸ªåˆ†åŒºè¿‡å°çš„é—®é¢˜ï¼Œå¼•å…¥äº†æ•°å­— 1.1ï¼Œä¿è¯æœ€åä¸€ä¸ªåˆ†åŒºçš„å¤§å°å¤§äº splitSize  çš„ 10%</span></span><br><span class="line"><span class="keyword">for</span>(bytesRemaining = length; (double)bytesRemaining / (double)splitSize &gt; <span class="number">1.1</span>D; bytesRemaining -= splitSize) &#123;</span><br><span class="line">	splitHosts = <span class="keyword">this</span>.getSplitHostsAndCachedHosts(blkLocations, length - bytesRemaining, splitSize, clusterMap);</span><br><span class="line">	splits.add(<span class="keyword">this</span>.makeSplit(path, length - bytesRemaining, splitSize, splitHosts[<span class="number">0</span>], splitHosts[<span class="number">1</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (bytesRemaining != <span class="number">0</span>L) &#123;</span><br><span class="line">	splitHosts = <span class="keyword">this</span>.getSplitHostsAndCachedHosts(blkLocations, length - bytesRemaining, bytesRemaining, clusterMap);</span><br><span class="line">	splits.add(<span class="keyword">this</span>.makeSplit(path, length - bytesRemaining, bytesRemaining, splitHosts[<span class="number">0</span>], splitHosts[<span class="number">1</span>]));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>6 åˆ†åŒºç»“æœ</strong></p>
<p>æ¯å—128Mï¼Œæœ€åä¸€å—ç•¥å¤§ï¼Œç¬¦åˆé¢„æœŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hdfs://xxxx:0+134217728</span><br><span class="line">hdfs://xxxx:134217728+134217728</span><br><span class="line">hdfs://xxxx:268435456+134217728</span><br><span class="line">hdfs://xxxx:402653184+138476793</span><br></pre></td></tr></table></figure>
<h1>å°ç»“</h1>
<ul>
<li>
<p>è¿™é‡Œæ¯”è¾ƒå¥‡è‘©çš„æ˜¯ minPartitions è¿™ä¸ªè®¾å®šï¼Œå®ƒæœ€å¤§åªèƒ½æ˜¯2ã€‚æˆ‘è§‰å¾—ä¹‹æ‰€ä»¥è¿™æ ·è®¾å®šï¼Œæ˜¯é˜²æ­¢æ–‡ä»¶åˆ‡çš„è¿‡å°ã€‚å‡è®¾æ•´ä¸ªæ–‡ä»¶å¤§å°åªæœ‰5Mï¼Œå…¬å¼ï¼š<code>Math.min(goalSize, blockSize)</code> blockSizeå‡å®š128Mï¼Œæ­¤æ—¶ splitSize ç”± minPartitions å†³å®šï¼ˆä¸è€ƒè™‘äººä¸ºè®¾å®šçš„é‚£ä¸ªminSizeï¼‰ã€‚é‚£ä¹ˆå®ƒæœ€å¤šåªèƒ½è¢«åˆ‡æˆ2ä»½ã€‚</p>
</li>
<li>
<p>å½“æ–‡ä»¶è¾ƒå¤§æ—¶ï¼ˆå¤§äºblockSizeä¸¤å€ï¼‰ï¼Œåªå’Œ blockSize æœ‰å…³ã€‚å°½ç®¡æˆ‘çš„æµ‹è¯•æ–‡ä»¶ä¸­æ¯ä¸ª block å®é™…å¤§å°åªæœ‰10Mï¼Œç„¶é¹…è¿™ä¸ªå¹¶æ²¡æœ‰ä»€ä¹ˆè½¯ç”¨ã€‚</p>
</li>
<li>
<p>è¿™æ˜¯å•æ–‡ä»¶æƒ…å†µï¼Œå¦‚æœæ˜¯è¯»ä¸€ä¸ªç›®å½•ä¸‹çš„å¤šæ–‡ä»¶ï¼Œé‚£å°±æ˜¯å•ç‹¬å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œåˆ‡åˆ†ã€‚ï¼ˆä»æºç å¯ä»¥å‘ç°ï¼Œå…¶ä¸­çš„ totalSize æ˜¯æ‰€æœ‰æ–‡ä»¶å¤§å°æ€»å’Œï¼‰ã€‚</p>
</li>
<li>
<p>å½“ç„¶è¿™åªæ˜¯åˆ†åŒºåˆ’åˆ†ï¼Œå®é™…è¯»å–æ•°æ®æ²¡è¿™ä¹ˆç®€å•ã€‚å‡å¦‚æˆ‘ä»¬æ˜¯ä¸€æ¡ä¸€æ¡è¯»ï¼Œé‚£ä¹ˆå¦‚æœè¯¥åˆ†åŒºæœ€åä¸€æ¡æ•°æ®æ²¡è¯»å®Œï¼Œå®ƒä¼šæ¥ç€å‘ä¸‹ä¸€å—ç»§ç»­è¯»ï¼Œå‚è€ƒ<a href="https://hadoopi.wordpress.com/2013/05/27/understand-recordreader-inputsplit/" target="_blank" rel="noopener">å®ƒ</a>ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOSæ ¹ç›®å½•æ‰©å®¹</title>
    <url>/2019/11/23/CentOS%E6%A0%B9%E7%9B%AE%E5%BD%95%E6%89%A9%E5%AE%B9/</url>
    <content><![CDATA[<p>è®°å½•å¯¹ /root ç›®å½•çš„æ‰©å®¹</p>
<a id="more"></a>
<h1>é—®é¢˜ï¼š<code>/root</code> çš„ç©ºé—´ç”¨æ»¡äº†</h1>
<p>æœ¬æ¥æ‰“ç®—ç›´æ¥åŠ¨æ€æ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯æŒ‰é¸Ÿå“¥å†™çš„æ”¾å¤§LVå®¹é‡ï¼ŒæŠŠ <code>/home</code> çš„ç©ºé—´åˆ†ç‚¹ç»™ <code>/root</code> ã€‚ç»“æœå‘ç° xfs æ–‡ä»¶ç³»ç»Ÿåªæ”¯æŒåŠ¨æ€å¢åŠ ï¼Œä¸èƒ½å‡å°‘ã€‚å› æ­¤å’±åªèƒ½å¤‡ä»½é‡è£…äº†ã€‚</p>
<h1>è§£å†³ï¼š</h1>
<h2 id="1-æˆ‘çš„ç‰ˆæœ¬"><a class="header-anchor" href="#1-æˆ‘çš„ç‰ˆæœ¬">Â¶</a>1 æˆ‘çš„ç‰ˆæœ¬</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br></pre></td></tr></table></figure>
<h2 id="2-åˆ†åŒºæƒ…å†µ"><a class="header-anchor" href="#2-åˆ†åŒºæƒ…å†µ">Â¶</a>2 åˆ†åŒºæƒ…å†µ</h2>
<p>CentOS çš„ <code>/root</code> å’Œ <code>/home</code> ç›®å½•ä½¿ç”¨äº†LVMï¼ˆé€»è¾‘å·åˆ†åŒºï¼‰</p>
<p>æˆ‘å‡†å¤‡ç»™ <code>/root</code> åŠ 100Gï¼ŒæŠŠ <code>/home</code> æ”¹ä¸º700Gï¼Œé¢„ç•™ 50G</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ df -hl</span><br><span class="line">Filesystem           Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/cl-root   50G   46G  5.0G  91% /</span><br><span class="line">...</span><br><span class="line">/dev/mapper/cl-home  849G  220G  629G  26% /home</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬è¦è°ƒçš„å°±æ˜¯è¿™ä¸ªLV Size</span></span><br><span class="line">$ lvdisplay</span><br><span class="line">  ...</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/home</span><br><span class="line">  LV Name                home</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                &lt;849.07 GiB</span><br><span class="line">  Current LE             217361</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/root</span><br><span class="line">  LV Name                root</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                50.00 GiB</span><br><span class="line">  Current LE             12800</span><br></pre></td></tr></table></figure>
<h2 id="3-å¤‡ä»½-home"><a class="header-anchor" href="#3-å¤‡ä»½-home">Â¶</a>3 å¤‡ä»½ <code>/home</code></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tar å‹ç¼©ï¼Œ-p ä¿ç•™æƒé™ï¼Œ-z ä½¿ç”¨ gzip</span></span><br><span class="line">$ tar cvpfz /mnt/data/homeback.tgz /home</span><br></pre></td></tr></table></figure>
<h2 id="4-åˆ é™¤-home"><a class="header-anchor" href="#4-åˆ é™¤-home">Â¶</a>4 åˆ é™¤ <code>/home</code></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¹²æ‰/homeæ–‡ä»¶ç³»ç»Ÿçš„è¿›ç¨‹</span></span><br><span class="line">$ fuser -km /home/</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½/homeï¼Œå¦‚æœæ²¡ç”¨ï¼ŒåŠ  -l å¼ºåˆ¶å¸è½½</span></span><br><span class="line">$ umount /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤ /home çš„lv</span></span><br><span class="line">$ lvremove /dev/mapper/cl-home</span><br></pre></td></tr></table></figure>
<h2 id="5-æ‰©å®¹-root"><a class="header-anchor" href="#5-æ‰©å®¹-root">Â¶</a>5 æ‰©å®¹ <code>/root</code></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æˆ‘è¿™é‡ŒåŠ  100G</span></span><br><span class="line">$ lvextend -L +100G /dev/mapper/cl-root</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ·æ–° /rootæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ xfs_growfs /dev/mapper/cl-root</span><br></pre></td></tr></table></figure>
<h2 id="6-æ¢å¤-home"><a class="header-anchor" href="#6-æ¢å¤-home">Â¶</a>6 æ¢å¤ <code>/home</code></h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ† 700G ç»™å®ƒã€‚ï¼ˆé¢„ç•™ 50G çš„ ç©ºé—²ç©ºé—´ï¼‰</span></span><br><span class="line">$ lvcreate -L 700G -n /dev/mapper/cl-home</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">$ mkfs.xfs /dev/mapper/cl-home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½ /home</span></span><br><span class="line">$ mount /dev/mapper/cl-home /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶æ¢å¤</span></span><br><span class="line">$ tar xvpfz /mnt/data/homeback.tgz -C /</span><br></pre></td></tr></table></figure>
<h2 id="7-æ£€æŸ¥ç»“æœ"><a class="header-anchor" href="#7-æ£€æŸ¥ç»“æœ">Â¶</a>7 æ£€æŸ¥ç»“æœ</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ df -hl</span><br><span class="line">Filesystem           Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/cl-root  150G   46G  105G  31% /</span><br><span class="line">...</span><br><span class="line">/dev/mapper/cl-home  700G  220G  480G  32% /home</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥VGï¼Œè¿˜æœ‰ 50G å‰©ä½™ï¼Œç¨³ç¨³çš„</span></span><br><span class="line">$ vgdisplay</span><br><span class="line">  --- Volume group ---</span><br><span class="line">  VG Name               cl</span><br><span class="line">  Cur LV                3</span><br><span class="line">  ...</span><br><span class="line">  VG Size               &lt;930.51 GiB</span><br><span class="line">  PE Size               4.00 MiB</span><br><span class="line">  Total PE              238210</span><br><span class="line">  Alloc PE / Size       225648 / &lt;881.44 GiB</span><br><span class="line">  Free  PE / Size       12562 / 49.07 GiB</span><br><span class="line">  </span><br><span class="line"><span class="comment"># æ£€æŸ¥LVï¼Œå’Œé¢„æƒ³ä¸€æ ·</span></span><br><span class="line">$ lvdisplay</span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/root</span><br><span class="line">  LV Name                root</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                150.00 GiB</span><br><span class="line">  Current LE             38400</span><br><span class="line"></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/cl/home</span><br><span class="line">  LV Name                home</span><br><span class="line">  VG Name                cl</span><br><span class="line">  ...</span><br><span class="line">  LV Size                700.00 GiB</span><br><span class="line">  Current LE             179200</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>LVM</tag>
      </tags>
  </entry>
  <entry>
    <title>hbase-åŸºæœ¬åŸç†</title>
    <url>/2019/09/29/hbase-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>ç®€å•ä»‹ç»äº†hbaseçš„åŸºæœ¬åŸç†ï¼šæ•°æ®ç»“æ„ã€è¯»å†™æ“ä½œã€flushã€åˆå¹¶ä¸åˆ‡åˆ†</p>
<a id="more"></a>
<h1>æ•°æ®ç»“æ„</h1>
<h2 id="é€»è¾‘ç»“æ„"><a class="header-anchor" href="#é€»è¾‘ç»“æ„">Â¶</a>é€»è¾‘ç»“æ„</h2>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/luoji.png" alt></p>
<p>ä¸€ä¸ª<strong>namespace</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>è¡¨</strong>ï¼Œå¦‚<code>zxylearn:student</code>ï¼Œä»£è¡¨<code>zxylearn</code>å‘½åç©ºé—´ä¸‹çš„<code>student</code>è¡¨ã€‚</p>
<p>ä¸€ä¸ª<strong>è¡¨</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>region</strong>ï¼Œå¦‚ä¸Šå›¾æœ‰3ä¸ªregionã€‚ä¸€ä¸ªregionä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚å¯ä»¥é¢„åˆ†åŒºï¼ˆæ¨èï¼‰æˆ–è€…å½“ä¸€ä¸ªregionè¿‡å¤§æ—¶ä¼šè‡ªåŠ¨è§¦å‘åˆ‡åˆ†ã€‚</p>
<p>ä¸€ä¸ª<strong>region</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>store</strong>ï¼ˆæŒ‰åˆ—æ—åˆ’åˆ†ï¼‰ï¼Œå¦‚ä¸Šå›¾æœ‰ä¸¤ä¸ªåˆ—æ—ã€‚ä¸€ä¸ªstoreä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹åæ˜¯åˆ—æ—åã€‚</p>
<p>ä¸€ä¸ª<strong>store</strong>å¯ä»¥æœ‰å¤šä¸ª<strong>HFile</strong>ï¼Œflushä¸€æ¬¡äº§ç”Ÿä¸€ä¸ªï¼Œå¯ä»¥åˆå¹¶ï¼ˆåé¢ä¼šè®²ï¼‰</p>
<p><strong>HFile</strong>ä¸­å°±æ˜¯å…·ä½“æ•°æ®äº†ï¼Œé€»è¾‘ä¸Šæ˜¯ä¸€è¡Œè¡Œåºåˆ—åŒ–çš„æ•°æ®ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># HDFSä¸­çš„ä¸€ä¸ªHFileçš„å®Œæ•´è·¯å¾„ï¼š</span><br><span class="line">/hbase/data/zxylearn/student/0fe474b3eb5fef1573d85acae8e5b787/info1/2dce02f62ea446f892a0b3cfc4e4db8a</span><br><span class="line"># namespace  zxylearn</span><br><span class="line"># è¡¨å        student</span><br><span class="line"># region     0fe474b3eb5fef1573d85acae8e5b787</span><br><span class="line"># åˆ—æ—å      info1</span><br><span class="line"># HFile      2dce02f62ea446f892a0b3cfc4e4db8a</span><br></pre></td></tr></table></figure>
<h2 id="ç‰©ç†ç»“æ„"><a class="header-anchor" href="#ç‰©ç†ç»“æ„">Â¶</a>ç‰©ç†ç»“æ„</h2>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/wuli.png" alt></p>
<p>é€šè¿‡æŒ‡å®š <code>'namespaceï¼šè¡¨å'</code> å’Œ <code>'Row Key'</code>ï¼Œå¯æŸ¥æ‰¾åˆ°æ•°æ®çš„<code>åˆ—æ—</code>ã€<code>åˆ—å</code>ã€<code>timestamp</code>ã€<code>value</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hbase(main):018:0&gt; get &apos;zxylearn:student&apos;,&apos;1001&apos;</span><br><span class="line">COLUMN                  CELL</span><br><span class="line"> info1:name             timestamp=1569722805794, value=zhangsan</span><br></pre></td></tr></table></figure>
<h1>å†™æ•°æ®æµç¨‹</h1>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/write.png" alt></p>
<ol>
<li>å®¢æˆ·ç«¯å‘ZKè¯·æ±‚è¿”å› å…ƒæ•°æ®è¡¨æ‰€åœ¨çš„RegionServeråœ°å€ã€‚ï¼ˆæˆ‘ä»¬å¯ä»¥åœ¨ZKå®¢æˆ·ç«¯ä¸­ç”¨<code>get /hbase/meta-region-server</code>çœ‹åˆ°å®ƒï¼‰</li>
<li>å®¢æˆ·ç«¯æ¥æ”¶åœ°å€ï¼Œå‘å®ƒè¯·æ±‚è¿”å› å¾…å†™æ•°æ®æ‰€åœ¨çš„RegionServeråœ°å€ã€‚ï¼ˆæˆ‘ä»¬å¯ä»¥åœ¨hbaseå®¢æˆ·ç«¯ç”¨<code>scan 'hbase:meta'</code>çœ‹åˆ°å®ƒï¼š<code>column=info:server, timestamp=1569658344714, value=localhost:16020</code>ï¼‰</li>
<li>å‘è¯¥åœ°å€è¯·æ±‚å†™æ•°æ®ã€‚</li>
<li>å…ˆå°†å†™æ“ä½œè®°å½•åˆ°æ“ä½œæ—¥å¿—ï¼ˆ<strong>WAL</strong>ï¼‰ä¸­ï¼Œæ¥ç€å°†æ•°æ®å†™å…¥<strong>å†…å­˜</strong>ä¸­ã€‚</li>
</ol>
<h1>Flush</h1>
<p>å¯ä»¥çœ‹å‡ºï¼Œå†™æ•°æ®æ˜¯å°†æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸­ã€‚å½“æ‰§è¡ŒFlushåˆ·å†™æ“ä½œæ—¶ï¼Œæ‰ä¼šå°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯HDFSä¸­ï¼Œå½¢æˆä¸€ä¸ªHFileã€‚</p>
<p><strong>Flushæ—¶æœº</strong></p>
<ul>
<li>å¤§å°è¶…è¿‡é™åˆ¶ï¼šå¦‚RegionServerçš„å…¨å±€å†…å­˜å¤§å°ï¼Œé»˜è®¤æ˜¯å †å¤§å°çš„40%æ—¶åˆ·å†™ï¼›å•ä¸ªregionå¤§å°ï¼Œé»˜è®¤128Mã€‚</li>
<li>æ—¶é—´ï¼šä»æœ€åä¸€æ¡æ•°æ®å†™å…¥åï¼Œ1hï¼ˆé»˜è®¤ï¼‰æ²¡æœ‰æ–°æ•°æ®ã€‚</li>
</ul>
<p><strong>Flushç»†èŠ‚</strong></p>
<ul>
<li><strong>flushä¼šåˆ é™¤è¿‡æœŸçš„æ•°æ®</strong>ã€‚å‡è®¾å»ºè¡¨æ—¶æ•°æ®ç‰ˆæœ¬æ•°è®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆå†™å…¥ç£ç›˜çš„çš„æ•°æ®æœ€å¤šåªæœ‰ä¸€ä¸ªç‰ˆæœ¬ï¼›å¦‚æœåˆ é™¤æ ‡è®°æ˜¯DeleteColumnï¼Œé‚£ä¹ˆä¼šåˆ é™¤æ¯”å®ƒä½ç‰ˆæœ¬çš„æ•°æ®ã€‚(<strong>åˆ é™¤æ ‡è®°æœ‰å¤šç§</strong>ï¼Œå¦‚ Deleteï¼šåªåˆ è‡ªå·±ï¼›DeleteColumnï¼šåˆ é™¤è‡ªå·±ä¸æ¯”è‡ªå·±ä½çš„)</li>
<li><strong>flushä¸ä¼šåˆ é™¤å¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</strong>ã€‚åŸå› ï¼šè®¾æƒ³ï¼Œæˆ‘ä»¬åŸæœ¬æƒ³åˆ é™¤ä¸€æ¡æ•°æ®ï¼Œç»™å®ƒæ‰“ä¸Šåˆ é™¤æ ‡è®°ã€‚å¦‚æœflushåˆ é™¤äº†ï¼Œå‡å¦‚ç£ç›˜ä¸­çš„å…¶å®ƒHFileä¸­æœ‰è¯¥æ•°æ®çš„æ—§ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå®ƒä»¬åœ¨<strong>åˆå¹¶æ“ä½œ</strong>ï¼ˆåé¢ä¼šè®²ï¼‰æ—¶å°±ä¸ä¼šè¢«åˆ é™¤äº†ã€‚</li>
</ul>
<p>åæ­£è®°ä½è¿™é‡Œä¼šå¹²æ‰ä¸è¦çš„æ•°æ®ï¼ˆç‰ˆæœ¬æ•°ä¸åˆ é™¤æ ‡è®°å†³å®šï¼‰ï¼Œä½†<strong>ä¸ä¼šå¹²æ‰å¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</strong>ã€‚</p>
<h1>è¯»æ•°æ®æµç¨‹</h1>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/hbase/read.png" alt></p>
<ol>
<li>æ‰¾åˆ°æ•°æ®æ‰€åœ¨RSæœåŠ¡å™¨çš„æµç¨‹å’Œå†™æ•°æ®åŸºæœ¬ä¸€æ ·ã€‚</li>
<li>å‘è¯¥åœ°å€è¯·æ±‚è¯»æ•°æ®ã€‚</li>
<li>è¯»å–cacheï¼ˆç¼“å­˜ï¼‰å’ŒMemStoreï¼ˆå†…å­˜ï¼‰ï¼ŒæŸ¥æ‰¾è¯¥æ•°æ®ã€‚</li>
<li>å¦‚æœcacheä¸­æ²¡æœ‰ï¼Œå†å»StoreFileï¼ˆç£ç›˜ï¼‰ä¸­æ‰¾è¯¥æ•°æ®ã€‚</li>
<li>å–æ—¶é—´æˆ³æœ€æ–°çš„æ•°æ®è¿”å›ï¼Œå¹¶è®°å½•åˆ°cacheä¸­ã€‚</li>
</ol>
<p><strong>ä¸ºä»€ä¹ˆåœ¨å†…å­˜ä¸­æ‰¾åˆ°äº†ï¼Œè¿˜è¦å»ç£ç›˜ä¸­æ‰¾ï¼Ÿ</strong></p>
<p><strong>æ—¶é—´æˆ³çš„ç¼˜æ•…</strong>ï¼šæˆ‘ä»¬ç”¨æˆ·è‡ªç„¶æ˜¯æŸ¥æ‰¾æœ€æ–°çš„æ•°æ®ï¼Œå†…å­˜ä¸­çš„æ•°æ®çš„æ—¶é—´æˆ³ä¸èƒ½ä¿è¯ä¸€å®šæ¯”ç£ç›˜ä¸­çš„æ–°ï¼Œæ‰€æœ‰è¦æŠŠå®ƒä»¬éƒ½æ‰¾åˆ°ï¼Œç„¶åæ¯”è¾ƒè¿”å›æœ€æ–°çš„æ•°æ®ã€‚å› æ­¤ï¼Œè¿™å¯¼è‡´äº†<strong>hbaseè¯»æ•°æ®æ¯”å†™æ•°æ®è¿˜æ…¢</strong>ã€‚æ‰€ä»¥ï¼Œ<strong>ç”¨cacheç¼“å­˜æŸ¥åˆ°çš„æ•°æ®</strong>ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦æé«˜è¯»æ•°æ®çš„é€Ÿåº¦ã€‚</p>
<h1>compact(åˆå¹¶)ä¸split(åˆ‡åˆ†)</h1>
<h2 id="compact-åˆå¹¶"><a class="header-anchor" href="#compact-åˆå¹¶">Â¶</a>compact(åˆå¹¶)</h2>
<p>åˆå¹¶æ˜¯<strong>å°†è‹¥å¹²ä¸ªå°çš„HFileï¼Œåˆå¹¶æˆä¸€ä¸ªå¤§çš„HFile</strong>ã€‚åˆ†<strong>Minor Compaction</strong> å’Œ <strong>Major Compaction</strong>ã€‚</p>
<ul>
<li>
<p><strong>Minor Compaction</strong> <strong>ä¸ä¼š</strong>æ¸…ç†ä¸è¦çš„æ•°æ®å’Œå¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</p>
</li>
<li>
<p><strong>Major Compaction</strong> <strong>ä¼š</strong>æ¸…ç†ä¸è¦çš„æ•°æ®å’Œå¸¦æ ‡è®°åˆ é™¤çš„æ•°æ®ã€‚å½“HFileæ•°å¤§äºç­‰äº3æ—¶ï¼Œæ‰§è¡Œ<code>compact</code>æ—¶æ‰§è¡Œçš„æ˜¯å®ƒã€‚</p>
</li>
</ul>
<p><strong>æ¸…ç†ç»†èŠ‚</strong></p>
<p>ä¸flushä¸åŒï¼Œè¿™é‡Œçš„æ¸…ç†ä¸ä»…ä¼šæ¸…é™¤ä¸è¦çš„æ•°æ®ï¼Œè¿˜ä¼š<strong>æ¸…ç†å¸¦åˆ é™¤æ ‡è®°çš„æ•°æ®</strong>ï¼ˆå¹²æ‰å®ƒï¼Œå’Œæ¯”å®ƒæ—§çš„æ•°æ®ï¼‰ã€‚</p>
<h2 id="split-åˆ‡åˆ†"><a class="header-anchor" href="#split-åˆ‡åˆ†">Â¶</a>split(åˆ‡åˆ†)</h2>
<p><strong>åˆ‡åˆ†æ˜¯å°†å¤§çš„regionåˆ‡åˆ†æˆè‹¥å¹²ä¸ªå°çš„region</strong>ã€‚å¯ä»¥é¢„åˆ†åŒºï¼ˆæ¨èï¼‰æˆ–è€…å½“ä¸€ä¸ªregionè¿‡å¤§æ—¶ä¼šè‡ªåŠ¨è§¦å‘åˆ‡åˆ†ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆæ¨èåªç”¨ä¸€ä¸ªåˆ—æ—å‘¢ï¼Ÿ</strong></p>
<p><strong>å¤šä¸ªåˆ—æ—å¯èƒ½å¯¼è‡´å°æ–‡ä»¶è¿‡å¤šã€‚<strong>å‡è®¾ä¸€ä¸ªåˆ—æ—çš„æ•°æ®çš„å¾ˆå¯†é›†ï¼Œå¦ä¸€åˆ—æ—å¾ˆç¨€ç–ï¼Œé‚£ä¹ˆåœ¨è§¦å‘</strong>flushæˆ–è€…split</strong>æ—¶ï¼Œå¯†é›†çš„åˆ—æ—å½¢æˆçš„HFileæ–‡ä»¶è¶³å¤Ÿå¤§æ²¡é—®é¢˜ï¼Œä½†æ˜¯ç¨€ç–çš„ç”Ÿæˆçš„å°±æ˜¯å°æ–‡ä»¶äº†ï¼Œä¹…è€Œä¹…ä¹‹ä¼šå½¢æˆè¿‡å¤šå°æ–‡ä»¶ä½¿æ•ˆç‡é™ä½ã€‚</p>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>hbase</tag>
      </tags>
  </entry>
  <entry>
    <title>hbase-å®‰è£…ä¸é…ç½®</title>
    <url>/2019/09/28/hbase-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>ä»‹ç»hbaseçš„å®‰è£…ä¸ç®€å•ä½¿ç”¨</p>
<a id="more"></a>
<h1>å‡†å¤‡</h1>
<p>æˆ‘çš„ç‰ˆæœ¬ï¼š</p>
<p><strong>hadoop 2.7.7</strong></p>
<p><strong>zookeeper 3.5.5</strong></p>
<p><strong>hbase 1.3.5</strong></p>
<p>å…ˆè£…å¥½ hadoop å’Œ zookeeper</p>
<h1>é…ç½® HBase</h1>
<h2 id="ä¿®æ”¹-hbase-env-sh"><a class="header-anchor" href="#ä¿®æ”¹-hbase-env-sh">Â¶</a>ä¿®æ”¹ <a href="http://hbase-env.sh" target="_blank" rel="noopener">hbase-env.sh</a></h2>
<p>ä¿®æ”¹<code>hbase-1.3.5/conf</code>ä¸‹çš„<code>hbase-env.sh</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=$(/usr/libexec/java_home)</span><br><span class="line"><span class="comment"># ä½¿ç”¨è‡ªå·±å®‰è£…çš„ZK</span></span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h2 id="ä¿®æ”¹-hbase-site-xml"><a class="header-anchor" href="#ä¿®æ”¹-hbase-site-xml">Â¶</a>ä¿®æ”¹ hbase-site.xml</h2>
<p>ä¿®æ”¹<code>hbase-1.3.5/conf</code>ä¸‹çš„<code>hbase-site.xml</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.rootdir&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;hdfs://localhost:9000/hbase&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">Â  Â      &lt;name&gt;hbase.master&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;master:60000&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;localhost:2181&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">Â  Â  &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hbase.zookeeper.property.dataDir&lt;/name&gt;</span><br><span class="line">Â  Â  Â  Â  &lt;value&gt;/usr/<span class="built_in">local</span>/apache-zookeeper-3.5.5-bin/zkData&lt;/value&gt;</span><br><span class="line">Â  Â  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h2 id="æ·»åŠ -core-site-xml-å’Œ-hdfs-site-xml"><a class="header-anchor" href="#æ·»åŠ -core-site-xml-å’Œ-hdfs-site-xml">Â¶</a>æ·»åŠ  core-site.xml å’Œ hdfs-site.xml</h2>
<p>ç›´æ¥åœ¨<code>hbase-1.3.5/conf</code>ä¸‹åˆ›å»º<strong>è½¯è¿æ¥</strong>å³å¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/hadoop-2.7.7/etc/hadoop/core-site.xml /usr/<span class="built_in">local</span>/hbase-1.3.5/conf/core-site.xml</span><br><span class="line"></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/hadoop-2.7.7/etc/hadoop/hdfs-site.xml /usr/<span class="built_in">local</span>/hbase-1.3.5/conf/hdfs-site.xml</span><br></pre></td></tr></table></figure>
<h2 id="ä¿®æ”¹-regionservers"><a class="header-anchor" href="#ä¿®æ”¹-regionservers">Â¶</a>ä¿®æ”¹ regionservers</h2>
<p>åœ¨<code>/hbase-1.3.5/conf/regionservers</code> ä¸­æ·»åŠ <strong>é›†ç¾¤èŠ‚ç‚¹çš„åå­—</strong>ï¼Œç”¨äºç¾¤å¯ä¸ç¾¤å…³</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">localhost</span><br></pre></td></tr></table></figure>
<h1>ä½¿ç”¨</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å…ˆå¼€HDFSå’ŒZK</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å•èŠ‚ç‚¹å¯åŠ¨ä¸å…³é—­</span></span><br><span class="line">bin/hbase-daemon.sh start master</span><br><span class="line">bin/hbase-daemon.sh start regionserver</span><br><span class="line">bin/hbase-daemon.sh stop master</span><br><span class="line">bin/hbase-daemon.sh stop regionserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¾¤å¯ä¸ç¾¤å…³</span></span><br><span class="line">bin/start-hbase.sh</span><br><span class="line">bin/stop-hbase.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯è§†åŒ–ç½‘é¡µ</span></span><br><span class="line">http://localhost:16010</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­£å¸¸å¯åŠ¨åçš„JPS</span></span><br><span class="line">977 ResourceManager</span><br><span class="line">865 NameNode</span><br><span class="line">4289 Jps</span><br><span class="line">4146 HRegionServer</span><br><span class="line">915 DataNode</span><br><span class="line">1028 NodeManager</span><br><span class="line">2360 QuorumPeerMain</span><br><span class="line">4062 HMaster</span><br></pre></td></tr></table></figure>
<h1>ç®€å•shellæ“ä½œ</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¿›å…¥shell</span></span><br><span class="line">bin/hbase shell</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘½åç©ºé—´çš„ç›¸å…³æ“ä½œ</span></span><br><span class="line">create_namespace <span class="string">'zxylearn'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¡¨çš„ç›¸å…³æ“ä½œ</span></span><br><span class="line"><span class="comment"># å»ºè¡¨</span></span><br><span class="line">create <span class="string">'zxylearn:student'</span>,<span class="string">'info1'</span>,<span class="string">'info2'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># çœ‹è¡¨</span></span><br><span class="line">describe <span class="string">'zxylearn:student'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ è¡¨</span></span><br><span class="line"><span class="built_in">disable</span> <span class="string">'zxylearn:student'</span></span><br><span class="line">drop <span class="string">'zxylearn:student'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®çš„ç›¸å…³æ“ä½œ</span></span><br><span class="line"><span class="comment"># å¢</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:name'</span>,<span class="string">'zhangsan'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:sex'</span>,<span class="string">'man'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1002'</span>,<span class="string">'info1:age'</span>,<span class="string">'22'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1002'</span>,<span class="string">'info2:addr'</span>,<span class="string">'wuhan'</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1003'</span>,<span class="string">'info2:addr'</span>,<span class="string">'beijing'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥</span></span><br><span class="line">scan <span class="string">'zxylearn:student'</span>,&#123;STARTROW=&gt;<span class="string">'1001'</span>,STOPROW=&gt;<span class="string">'1003'</span>&#125;</span><br><span class="line">get <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span></span><br><span class="line">get <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:name'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¹</span></span><br><span class="line">put <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:name'</span>,<span class="string">'zxy'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ </span></span><br><span class="line">delete <span class="string">'zxylearn:student'</span>,<span class="string">'1001'</span>,<span class="string">'info1:sex'</span></span><br><span class="line">deleteall <span class="string">'zxylearn:student'</span>, <span class="string">'1002'</span></span><br><span class="line">truncate <span class="string">'zxylearn:student'</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>é…ç½®</tag>
        <tag>hbase</tag>
      </tags>
  </entry>
  <entry>
    <title>zookeeper-åŸºæœ¬åŸç†</title>
    <url>/2019/09/24/zookeeper-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>ä»‹ç»äº†zookeeperçš„åŸºæœ¬åŸç†å’Œä½¿ç”¨</p>
<a id="more"></a>
<h1>ç®€ä»‹</h1>
<p>ZooKeeperæ˜¯ä¸ªåˆ†å¸ƒå¼çš„æœåŠ¡åè°ƒæ¡†æ¶ã€‚å…·ä½“ç”¨é€”å¦‚ï¼š<strong>ç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†</strong>ç­‰ã€‚å®ƒåŸºäº<strong>è§‚å¯Ÿè€…</strong>çš„è®¾è®¡æ¨¡å¼ï¼›zookeeper = æ–‡ä»¶ç³»ç»Ÿ + ç›‘å¬é€šçŸ¥æœºåˆ¶ã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ol>
<li>æœ€ç»ˆä¸€è‡´æ€§ï¼šClientä¸è®ºè¿æ¥åˆ°å“ªä¸ªServerï¼Œå¾—åˆ°çš„æ•°æ®éƒ½æ˜¯ä¸€æ ·çš„ã€‚</li>
<li>åŸå­æ€§ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œå…¨éƒ¨æ‰§è¡Œæˆ–è€…å…¨éƒ¨ä¸æ‰§è¡Œã€‚</li>
<li>é¡ºåºæ€§ï¼šåŒä¸€ä¸ªclientçš„è¯·æ±‚é¡ºåºæ‰§è¡Œã€‚</li>
<li>åˆ†åŒºå®¹é”™æ€§ï¼šzookeeperæ˜¯åˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥åœ¨éƒ¨åˆ†èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼Œå¯ä»¥è‡ªå·±æ¢å¤ã€‚</li>
</ol>
<h1>æ•°æ®ç»“æ„</h1>
<p><strong>znode</strong>ï¼šzkæ˜¯å±‚çº§æ ‘çŠ¶ç»“æ„ï¼Œä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯znodeã€‚é»˜è®¤å¯å­˜<strong>1Mæ•°æ®</strong>ã€‚</p>
<ul>
<li>æ“ä½œèŠ‚ç‚¹æ—¶å¯è®¾ç½®<strong>watcher</strong>ã€‚å½“èŠ‚ç‚¹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘watcherå¯¹åº”çš„æ“ä½œï¼Œåªè§¦å‘ä¸€æ¬¡ã€‚</li>
<li><strong>æ°¸ä¹…èŠ‚ç‚¹</strong>ï¼šåˆ›å»ºåæ°¸ä¹…å­˜åœ¨ï¼Œé™¤éä¸»åŠ¨åˆ é™¤ï¼›<strong>ä¸´æ—¶èŠ‚ç‚¹</strong>ï¼šä¸´æ—¶åˆ›å»ºçš„ï¼Œä¼šè¯ç»“æŸèŠ‚ç‚¹è‡ªåŠ¨è¢«åˆ é™¤</li>
<li><strong>é¡ºåºèŠ‚ç‚¹</strong>ï¼šèŠ‚ç‚¹åç§°åé¢è‡ªåŠ¨å¢åŠ ä¸€ä¸ª10ä½æ•°å­—çš„åºåˆ—å·ï¼›<strong>éé¡ºåºèŠ‚ç‚¹</strong>ï¼šä¸åŠ åºåˆ—å·</li>
</ul>
<p>èŠ‚ç‚¹è¡ç”Ÿå‡ºåˆ†ç±»æ˜¯ä¸ºäº†è¿åˆéœ€æ±‚ã€‚ä¸´æ—¶èŠ‚ç‚¹å¯ä»¥è®°å½•æœåŠ¡å™¨æ˜¯å¦ä¸Šçº¿ï¼šå½“æœåŠ¡å™¨ä¸‹çº¿ï¼Œä¸´æ—¶èŠ‚ç‚¹çš„æ•°æ®æ¶ˆé™¤ã€‚é¡ºåºèŠ‚ç‚¹å¯ç”¨äºåŒä¸€æœåŠ¡å™¨å¤šæ¬¡ä¸Šä¸‹çº¿ï¼Œæ¯æ¬¡åå­—éƒ½ä¸åŒã€‚å¾ˆæ˜æ˜¾2ä¸ª2åˆ†ç±»ï¼Œä¸¤ä¸¤ç»„åˆæœ‰4ç§èŠ‚ç‚¹ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªznodeçš„æ•°æ®ç»“æ„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸€ä¸ªznodeçš„æ•°æ®ç»“æ„</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] <span class="built_in">stat</span> /zxy</span><br><span class="line">cZxid = 0x39                                <span class="comment"># èŠ‚ç‚¹åˆ›å»ºæ—¶çš„zxid</span></span><br><span class="line">ctime = Mon Sep 23 16:38:23 CST 2019        <span class="comment"># èŠ‚ç‚¹åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³</span></span><br><span class="line">mZxid = 0x3d                                <span class="comment"># èŠ‚ç‚¹ä¿®æ”¹æ—¶çš„zxid</span></span><br><span class="line">mtime = Mon Sep 23 16:38:44 CST 2019        <span class="comment"># èŠ‚ç‚¹ä¿®æ”¹æ—¶çš„æ—¶é—´æˆ³</span></span><br><span class="line">pZxid = 0x39                                <span class="comment"># æ”¹å˜å­èŠ‚ç‚¹æ—¶çš„zxid</span></span><br><span class="line">cversion = 0                                <span class="comment"># å­èŠ‚ç‚¹çš„ç‰ˆæœ¬å·</span></span><br><span class="line">dataVersion = 3                             <span class="comment"># æ•°æ®ç‰ˆæœ¬ï¼šåˆå§‹0ï¼Œæ”¹å˜ä¸€æ¬¡åŠ 1</span></span><br><span class="line">aclVersion = 0                              <span class="comment"># ACLç‰ˆæœ¬ï¼ˆæƒé™ï¼‰</span></span><br><span class="line">ephemeralOwner = 0x0                        <span class="comment"># æ•°æ®æ‹¥æœ‰è€…ï¼šæ°¸ä¹…èŠ‚ç‚¹æ˜¯0ï¼›ä¸´æ—¶èŠ‚ç‚¹æ˜¯åˆ›å»ºè€…çš„id</span></span><br><span class="line">dataLength = 13                             <span class="comment"># æ•°æ®é•¿åº¦</span></span><br><span class="line">numChildren = 0                             <span class="comment"># å­èŠ‚ç‚¹ä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹èŠ‚ç‚¹çš„æ“ä½œæ— éæ˜¯å¢åˆ æ”¹æŸ¥ç­‰ï¼Œè¿™é‡Œå°±ä¸å†™äº†</span></span><br></pre></td></tr></table></figure>
<p>è¡¥å……ï¼š</p>
<p><strong>zxid</strong>ï¼ˆZooKeeper Transaction Idï¼‰ï¼šZooKeeperæ¯æ¬¡çŠ¶æ€å˜åŒ–å°†ä¼šäº§ç”Ÿä¸€ä¸ªå«zxidçš„æ—¶é—´æˆ³ã€‚</p>
<h1>åŸç†</h1>
<p>åŸºæœ¬æµç¨‹ï¼š</p>
<p>å®¢æˆ·ç«¯å‘è¯·æ±‚ï¼ˆå¯å¸¦watcherï¼‰ -&gt;  zk é€‰ä¸¾ä¸æ¢å¤ (æ²¡leaderæ—¶) -&gt; zk è¯»å†™æ•°æ® -&gt; è¿”å›æ•°æ®ï¼ˆå¯è§¦å‘watcherï¼‰</p>
<p>ä¸¤ç«¯ä¸»è¦æ˜¯<strong>ç›‘å¬å™¨çš„åŸç†</strong>ï¼Œä¸­é—´ä¸»è¦ç”¨åˆ°<strong>ZABåè®®</strong>ã€‚</p>
<h2 id="ç›‘å¬å™¨åŸç†"><a class="header-anchor" href="#ç›‘å¬å™¨åŸç†">Â¶</a>ç›‘å¬å™¨åŸç†</h2>
<p>watcher ç›¸å½“äºä¸€ä¸ªçš„ç‚¸å¼¹ï¼Œå®¢æˆ·ç«¯å‘è¯·æ±‚æ—¶ï¼šå¦‚<code>lsï¼Œgetï¼Œset</code>ç­‰ï¼Œå¯ä»¥ç»™èŠ‚ç‚¹ç»‘ä¸Šç‚¸å¼¹ã€‚</p>
<p>å¦‚æœè§¦å‘äº†çˆ†ç‚¸æ¡ä»¶ï¼š<code>ls</code>å°±æ˜¯è¯¥èŠ‚ç‚¹æœ‰å¢åŠ åˆ å‡å­èŠ‚ç‚¹ï¼›<code>get set</code>å°±æ˜¯è¯¥èŠ‚ç‚¹æ•°æ®æ”¹å˜ã€‚</p>
<p>ç‚¸å¼¹çˆ†ç‚¸ï¼ˆåªç‚¸ä¸€æ¬¡ï¼‰ä¹Ÿå°±æ˜¯æ‰§è¡Œé‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚</p>
<p>å¾ˆæ˜æ˜¾è¿™é‡Œç”¨æˆ·ç«¯è‡³å°‘éœ€è¦å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹ï¼šconnectçº¿ç¨‹è´Ÿè´£ç½‘ç»œè¿æ¥é€šä¿¡ï¼šç»‘ç‚¸å¼¹å¹¶æŠŠä»»åŠ¡å‘ç»™zkä¸åç»­æ•°æ®äº’ä¼ ï¼›listenerçº¿ç¨‹ç›‘å¬ç‚¸å¼¹çˆ†ç‚¸ä¿¡å·ã€‚</p>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/zookeeper/zk.png" alt></p>
<h2 id="ZABåè®®"><a class="header-anchor" href="#ZABåè®®">Â¶</a>ZABåè®®</h2>
<p>Zabåè®®ï¼ˆZookeeper Atomic Broadcastï¼‰ï¼Œé€šè¿‡å®ƒæ¥ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚<br>
è¿™ä¸ªå†…å®¹å¾ˆå¤šï¼Œè¯¦ç»†çš„å¯ä»¥å‚è€ƒï¼š</p>
<p><a href="https://www.jianshu.com/p/2bceacd60b8a" target="_blank" rel="noopener">Zookeeperâ€”â€”ä¸€è‡´æ€§åè®®:Zabåè®®</a></p>
<p><a href="https://www.cnblogs.com/felixzh/p/5869212.html" target="_blank" rel="noopener">Zookeeperçš„åŠŸèƒ½ä»¥åŠå·¥ä½œåŸç†</a></p>
<p>ä¸»è¦åŠŸèƒ½ï¼šå´©æºƒæ¢å¤(é€‰ä¸¾ã€æ•°æ®æ¢å¤) çš„ åŸå­å¹¿æ’­ (æ•°æ®è¯»å†™)</p>
<h3 id="å´©æºƒæ¢å¤"><a class="header-anchor" href="#å´©æºƒæ¢å¤">Â¶</a>å´©æºƒæ¢å¤</h3>
<p>é›†ç¾¤ä¸­å¿…é¡»æœ‰ä¸€ä¸ªleaderï¼Œleaderå‡ºç°æ•…éšœæ—¶ï¼Œé‡‡ç”¨æŠ•ç¥¨é€‰ä¸¾æ–°leaderï¼Œå®ƒéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li>æ–°é€‰ä¸¾å‡ºæ¥çš„ Leader ä¸èƒ½åŒ…å«æœªæäº¤çš„ Proposal ã€‚</li>
<li>æ–°é€‰ä¸¾çš„ Leader èŠ‚ç‚¹ä¸­å«æœ‰æœ€å¤§çš„ zxid ã€‚</li>
<li>å¾—åˆ°è¶…è¿‡ä¸€åŠé€‰ç¥¨è€…ç§°ä¸º Leaderï¼Œå› æ­¤<strong>zké›†ç¾¤ä¸ªæ•°ä¸ºå¥‡æ•°</strong></li>
</ul>
<p>å¹¶ä¸æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ leader å’Œ follower ï¼Œè¿˜æœ‰observerï¼Œå®ƒä¸å‚ä¸é€‰ä¸¾ã€‚ä½œç”¨æ˜¯ï¼šå¯ä»¥å¢åŠ é›†ç¾¤æ•°é‡ï¼Œåˆå‡å°‘æŠ•ç¥¨é€‰ä¸¾æ—¶é—´ã€‚</p>
<p>é€‰å‡ºleaderåï¼Œè¿›è¡Œæ•°æ®æ¢å¤ä¹Ÿå°±æ˜¯åŒæ­¥ï¼Œè¿™ä¸ªæ²¡å•¥ï¼Œå°±æ˜¯è®©å®ƒä»¬å…¶å®ƒèŠ‚ç‚¹æ•°æ®éƒ½å’ŒleaderåŒæ­¥ï¼Œæ¯•ç«Ÿå’±è¦ç¡®ä¿<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚æ¢å¤å®Œæ¯•åï¼Œå°±å¯ä»¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚äº†ã€‚</p>
<h3 id="è¯»å†™æ•°æ®"><a class="header-anchor" href="#è¯»å†™æ•°æ®">Â¶</a>è¯»å†™æ•°æ®</h3>
<p><strong>ä¸€èˆ¬æµç¨‹ï¼š</strong></p>
<p><strong>è¯»è¯·æ±‚</strong>ï¼Œå°±æ˜¯ç›´æ¥ä»å½“å‰èŠ‚ç‚¹ä¸­è¯»å–æ•°æ®</p>
<p><strong>å†™è¯·æ±‚</strong></p>
<ol>
<li>å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªå†™æ“ä½œè¯·æ±‚ã€‚</li>
<li>Leader å°†å®¢æˆ·ç«¯çš„è¯·æ±‚è½¬åŒ–ä¸ºäº‹åŠ¡ï¼ˆProposalï¼‰ï¼Œæ¯ä¸ª Proposal åˆ†é…ä¸€ä¸ªå…¨å±€çš„IDï¼Œå³zxidã€‚</li>
<li>Leader ä¸ºæ¯ä¸ª Follower åˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ï¼Œç„¶åå°†éœ€è¦å¹¿æ’­çš„ Proposal ä¾æ¬¡æ”¾åˆ°é˜Ÿåˆ—ä¸­å–ï¼Œå¹¶ä¸”æ ¹æ® FIFO ç­–ç•¥è¿›è¡Œæ¶ˆæ¯å‘é€ã€‚</li>
<li>Follower æ¥æ”¶åˆ° Proposal åï¼Œä¼šé¦–å…ˆå°†å…¶ä»¥äº‹åŠ¡æ—¥å¿—çš„æ–¹å¼å†™å…¥æœ¬åœ°ç£ç›˜ä¸­ï¼Œå†™å…¥æˆåŠŸåå‘ Leader åé¦ˆä¸€ä¸ª Ack å“åº”æ¶ˆæ¯ã€‚</li>
<li>Leader æ¥æ”¶åˆ°<strong>è¶…è¿‡åŠæ•°ä»¥ä¸Š</strong> Follower çš„ Ack å“åº”æ¶ˆæ¯åï¼Œå³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸï¼Œå¯ä»¥å‘é€ commit æ¶ˆæ¯ã€‚</li>
<li>Leader å‘æ‰€æœ‰ Follower å¹¿æ’­ commit æ¶ˆæ¯ï¼ŒåŒæ—¶è‡ªèº«ä¹Ÿä¼šå®Œæˆäº‹åŠ¡æäº¤ã€‚Follower æ¥æ”¶åˆ° commit æ¶ˆæ¯åï¼Œä¼šå°†ä¸Šä¸€æ¡äº‹åŠ¡æäº¤ã€‚</li>
</ol>
<p><strong>æœ‰æ„æ€çš„ç‚¹</strong></p>
<ul>
<li>
<p>**å¦‚ä½•ä¿è¯æ¶ˆæ¯æœ‰åºï¼š**åœ¨æ•´ä¸ªæ¶ˆæ¯å¹¿æ’­ä¸­ï¼ŒLeaderä¼šå°†æ¯ä¸€ä¸ªäº‹åŠ¡è¯·æ±‚è½¬æ¢æˆå¯¹åº”çš„ proposal æ¥è¿›è¡Œå¹¿æ’­ï¼Œå¹¶ä¸”åœ¨å¹¿æ’­ äº‹åŠ¡Proposal ä¹‹å‰ï¼ŒLeaderæœåŠ¡å™¨ä¼šé¦–å…ˆä¸ºè¿™ä¸ªäº‹åŠ¡Proposalåˆ†é…ä¸€ä¸ªå…¨å±€å•é€’å¢çš„å”¯ä¸€IDï¼Œç§°ä¹‹ä¸ºäº‹åŠ¡IDï¼ˆå³zxidï¼‰ï¼Œç”±äºZabåè®®éœ€è¦ä¿è¯æ¯ä¸€ä¸ªæ¶ˆæ¯çš„ä¸¥æ ¼çš„é¡ºåºå…³ç³»ï¼Œå› æ­¤å¿…é¡»å°†æ¯ä¸€ä¸ªproposalæŒ‰ç…§å…¶zxidçš„å…ˆåé¡ºåºè¿›è¡Œæ’åºå’Œå¤„ç†ã€‚</p>
</li>
<li>
<p>**ç”¨é˜Ÿåˆ—æé«˜æ•ˆç‡ï¼š**Leader æœåŠ¡å™¨ä¸æ¯ä¸€ä¸ª Follower æœåŠ¡å™¨ä¹‹é—´éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå•ç‹¬çš„ FIFO æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œæ”¶å‘æ¶ˆæ¯ï¼Œä½¿ç”¨é˜Ÿåˆ—æ¶ˆæ¯å¯ä»¥åšåˆ°å¼‚æ­¥è§£è€¦ã€‚ Leader å’Œ Follower ä¹‹é—´åªéœ€è¦å¾€é˜Ÿåˆ—ä¸­å‘æ¶ˆæ¯å³å¯ã€‚å¦‚æœä½¿ç”¨å®Œå…¨åŒæ­¥çš„æ–¹å¼ä¼šå¼•èµ·é˜»å¡ï¼Œæ€§èƒ½è¦ä¸‹é™å¾ˆå¤šã€‚(æˆ‘æ„Ÿè§‰è¿™é‡Œåº”è¯¥ä¸æ˜¯FIFO æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåº”è¯¥æ˜¯æœ€å°é˜Ÿåˆ—å§)</p>
</li>
<li>
<p><strong>è®°ä½è¶…è¿‡åŠæ•°</strong></p>
</li>
</ul>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>hive-DML</title>
    <url>/2019/09/19/hive-DML/</url>
    <content><![CDATA[<p>hiveä¸­ä¸€äº›DMLçš„æ“ä½œ</p>
<a id="more"></a>
<p>DMLï¼ˆæ•°æ®æ“çºµè¯­è¨€ï¼‰ä¸»è¦æŒ‡æ•°æ®çš„å¢åˆ æŸ¥æ”¹</p>
<h1>æ•°æ®å¯¼å…¥</h1>
<p>æœ‰5ç§å¯¼å…¥æ•°æ®çš„æ–¹æ³•ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ <strong>Load</strong> å’Œ <strong>Insert</strong></p>
<h2 id="Load"><a class="header-anchor" href="#Load">Â¶</a>Load</h2>
<p>ä»æ–‡ä»¶ç³»ç»Ÿä¸­å¯¼å…¥æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> [<span class="keyword">local</span>] inpath <span class="string">'/xxxxxx'</span> </span><br><span class="line">[overwrite] <span class="keyword">into</span> <span class="keyword">table</span> tablename [<span class="keyword">partition</span> (partcol1=val1,â€¦)];</span><br></pre></td></tr></table></figure>
<ul>
<li>local: æŒ‡æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œå¦åˆ™ä¸ºHDFS</li>
<li>overwrite: æŒ‡è¦†ç›–è¡¨ä¸­å·²æœ‰æ•°æ®ï¼Œå¦åˆ™è¡¨ç¤ºè¿½åŠ </li>
<li>partition: è¡¨ç¤ºä¸Šä¼ åˆ°æŒ‡å®šåˆ†åŒº</li>
</ul>
<h2 id="Insert"><a class="header-anchor" href="#Insert">Â¶</a>Insert</h2>
<p>é€šè¿‡æŸ¥è¯¢è¯­å¥å¯¼å…¥æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è¦†ç›–</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">table</span> tablename [<span class="keyword">partition</span>(partcol1=val1,partclo2=val2)] select_statement;</span><br><span class="line"><span class="comment"># è¿½åŠ </span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> tablename [<span class="keyword">partition</span>(partcol1=val1,partclo2=val2)] select_statement;</span><br></pre></td></tr></table></figure>
<h2 id="As-Select"><a class="header-anchor" href="#As-Select">Â¶</a>As Select</h2>
<p>æŸ¥è¯¢è¯­å¥ä¸­åˆ›å»ºè¡¨å¹¶å¯¼å…¥æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> tablename</span><br><span class="line"><span class="keyword">as</span> <span class="keyword">select</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">from</span> student;</span><br></pre></td></tr></table></figure>
<h2 id="Location"><a class="header-anchor" href="#Location">Â¶</a>Location</h2>
<p>åˆ›å»ºè¡¨æ—¶é€šè¿‡LocationæŒ‡å®šæ•°æ®çš„è·¯å¾„ï¼Œå†ç›´æ¥putæ•°æ®åˆ°hdfsä¸Š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hive (default)&gt; dfs -put /xxxxx /user/hive/warehouse/tablename;</span><br></pre></td></tr></table></figure>
<h2 id="Import"><a class="header-anchor" href="#Import">Â¶</a>Import</h2>
<p>åªèƒ½å¯¼å…¥exportå¯¼å‡ºçš„æ•°æ®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">import table tablename partition(month='201909') from '/user/hive/warehouse/export/student';</span><br></pre></td></tr></table></figure>
<h1>æ•°æ®å¯¼å‡º</h1>
<p>æœ€å¸¸ç”¨çš„æ˜¯ <strong>Insert</strong> å’Œ <strong>Hadoop</strong></p>
<h2 id="Insert-v2"><a class="header-anchor" href="#Insert-v2">Â¶</a>Insert</h2>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å°†æ•°æ®å¯¼å…¥æœ¬åœ°ï¼ˆå¹¶æ ¼å¼åŒ–å¤„ç†ï¼‰ï¼Œä¸åŠ localå°±æ˜¯å¯¼å…¥HDFS</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> <span class="keyword">directory</span> <span class="string">'/xxxxx'</span></span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span> <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\t'</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tablename;</span><br></pre></td></tr></table></figure>
<h2 id="Hadoop"><a class="header-anchor" href="#Hadoop">Â¶</a>Hadoop</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># hadoopå‘½ä»¤å¯¼å‡º</span></span><br><span class="line">hive &gt; dfs -get /user/hive/warehouse/student/month=201909/000000_0 /xxxxxxx;</span><br></pre></td></tr></table></figure>
<h2 id="Export"><a class="header-anchor" href="#Export">Â¶</a>Export</h2>
<p>è¿™ä¸ªå¯¼å‡ºçš„æ•°æ®é™¤äº†æ•°æ®è¿˜æœ‰å…ƒæ•°æ®ï¼Œå¯ç”¨Importå¯¼å…¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hive &gt; <span class="built_in">export</span> table tablename to <span class="string">'/user/hive/warehouse/export/student'</span>;</span><br></pre></td></tr></table></figure>
<h1>æ•°æ®æ¸…é™¤</h1>
<p>åªèƒ½æ¸…é™¤å†…éƒ¨è¡¨çš„æ•°æ®</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hive &gt; truncate table tablename;</span><br></pre></td></tr></table></figure>
<h1>æŸ¥è¯¢</h1>
<p>æŸ¥è¯¢çš„å…³é”®å­—è¾ƒå¤šï¼Œè¦çŸ¥é“å®ƒä»¬çš„<strong>é¡ºåº</strong>ï¼ˆé‡ç‚¹ï¼‰</p>
<p>å†™çš„é¡ºåºï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ... <span class="keyword">from</span> ... <span class="keyword">join</span> <span class="keyword">on</span> ... <span class="keyword">where</span> ... <span class="keyword">group</span> <span class="keyword">by</span> ... <span class="keyword">having</span> ... <span class="keyword">order</span> <span class="keyword">by</span> ... <span class="keyword">limit</span> ...</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œé¡ºåºï¼šå¤§ä½“æ€è·¯æ˜¯ é™å®š(where)ï¼Œåˆ†ç»„ï¼Œé™å®šï¼ˆhavingï¼‰ï¼Œé€‰æ‹©ï¼Œæ’åº</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">from -&gt; join on -&gt; where -&gt; group by -&gt; having -&gt; select -&gt; order by -&gt; limit</span><br></pre></td></tr></table></figure>
<h2 id="selectâ€¦whereâ€¦limit"><a class="header-anchor" href="#selectâ€¦whereâ€¦limit">Â¶</a>selectâ€¦whereâ€¦limit</h2>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç®€å•æŸ¥è¯¢</span></span><br><span class="line"><span class="keyword">select</span> empno, ename <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) cnt <span class="keyword">from</span> emp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">where</span> sal &gt;<span class="number">1000</span> <span class="keyword">limit</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<h2 id="group-by-å’Œ-having"><a class="header-anchor" href="#group-by-å’Œ-having">Â¶</a>group by å’Œ having</h2>
<p>group by è¯­å¥é€šå¸¸ä¼šå’Œèšåˆå‡½æ•°ä¸€èµ·ä½¿ç”¨ï¼ŒæŒ‰ç…§ä¸€ä¸ªæˆ–è€…å¤šä¸ªåˆ—é˜Ÿç»“æœè¿›è¡Œåˆ†ç»„ï¼Œç„¶åå¯¹æ¯ä¸ªç»„æ‰§è¡Œèšåˆæ“ä½œ</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¡ç®—empè¡¨æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„</span></span><br><span class="line"><span class="keyword">select</span> t.deptno, <span class="keyword">avg</span>(t.sal) avg_sal <span class="keyword">from</span> emp t <span class="keyword">group</span> <span class="keyword">by</span> t.deptno;</span><br></pre></td></tr></table></figure>
<p>where ä½œç”¨åœ¨ åˆ†ç»„ï¼ˆgroup byï¼‰å’Œèšåˆï¼ˆsumç­‰ï¼‰è®¡ç®—ä¹‹å‰ï¼Œé€‰å–å“ªäº›è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨æŸ¥è¯¢å‰ç­›é€‰ï¼›having å¯¹åˆ†ç»„å<strong>è®¡ç®—çš„</strong>æ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚å®ƒ<strong>åªç”¨äº</strong>group byåˆ†ç»„ç»Ÿè®¡è¯­å¥ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ±‚æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡è–ªæ°´å¤§äº2000çš„éƒ¨é—¨</span></span><br><span class="line"><span class="keyword">select</span> deptno, <span class="keyword">avg</span>(sal) avg_sal <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> deptno <span class="keyword">having</span> avg_sal &gt; <span class="number">2000</span>;</span><br></pre></td></tr></table></figure>
<h2 id="join"><a class="header-anchor" href="#join">Â¶</a>join</h2>
<p>Hiveæ”¯æŒé€šå¸¸çš„SQL JOINè¯­å¥ï¼Œä½†æ˜¯<strong>åªæ”¯æŒç­‰å€¼è¿æ¥ï¼Œä¸æ”¯æŒéç­‰å€¼è¿æ¥</strong>ã€‚ ä¸” è¿æ¥è°“è¯ä¸­<strong>ä¸æ”¯æŒor</strong>ã€‚<br>
è¿™ä¸ªéç­‰å€¼è¿æ¥å¯ä»¥ä»ä»¥å‰å­¦çš„<strong>reducejoin</strong>çš„æµç¨‹æ€ç´¢åŸå› ï¼Œreducejoinæ˜¯åœ¨shufferæ—¶å°†æ•°æ®æŒ‰å…³è”å€¼ç›¸ç­‰çš„ï¼ˆonçš„æ¡ä»¶ï¼‰åˆ†ä¸ºä¸€ç»„ï¼Œå†åœ¨reduceré˜¶æ®µè¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆå¹¶å‘˜å·¥è¡¨å’Œéƒ¨é—¨è¡¨</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp e <span class="keyword">join</span> dept d <span class="keyword">on</span> e.deptno = d.deptno;</span><br></pre></td></tr></table></figure>
<h2 id="æ’åº"><a class="header-anchor" href="#æ’åº">Â¶</a>æ’åº</h2>
<h3 id="å…¨å±€æ’åº-Order-By"><a class="header-anchor" href="#å…¨å±€æ’åº-Order-By">Â¶</a>å…¨å±€æ’åº Order By</h3>
<p>å…¨å±€æ’åºï¼Œåªä¸€ä¸ªReducerã€‚å…¨æ’å¾ˆæ˜æ˜¾æœ€åç”Ÿæˆä¸€ä¸ªæ€»çš„æ’åºæ–‡ä»¶ï¼Œ<strong>1ä¸ªreducer</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯æŒ‰å·¥èµ„é™åºæ’åˆ—</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">order</span> <span class="keyword">by</span> sal <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="æŒ‰reduceræ’åº-sort-by"><a class="header-anchor" href="#æŒ‰reduceræ’åº-sort-by">Â¶</a>æŒ‰reduceræ’åº sort by</h3>
<p>æ¯ä¸ªreducerç«¯éƒ½ä¼šåšæ’åºï¼Œå‡ºæ¥çš„æ•°æ®æ˜¯æœ‰åºçš„ã€‚å‡å¦‚æœ‰nä¸ªReducerï¼Œå°±ä¼šç”Ÿæˆnä¸ªæœ‰åºæ–‡ä»¶ã€‚å½“n=1æ—¶ï¼Œå®ƒå°±æ˜¯<code>Order By</code>ã€‚</p>
<p>æ‰©å±•ä¸€æ³¢ï¼ŒReducerä¸ªæ•°é»˜è®¤æŒ‰åŸå§‹æ•°æ®256Mä¸€ä¸ªï¼Œå½“ç„¶ä¹Ÿå¯æ‰‹åŠ¨è®¾ç½®å…¶ä¸ªæ•°ã€‚</p>
<h3 id="åˆ†åŒºæ’åº-Distribute-Byâ€¦Sort-By"><a class="header-anchor" href="#åˆ†åŒºæ’åº-Distribute-Byâ€¦Sort-By">Â¶</a>åˆ†åŒºæ’åº Distribute Byâ€¦Sort By</h3>
<p>å…ˆåˆ†åŒºï¼Œåæ’åºã€‚è¿™ä¸ªåˆ†åŒºç±»å‹mapreduceçš„åˆ†åŒºï¼Œå¤šå°‘ä¸ªåˆ†åŒºï¼Œå°±æœ‰å¤šå°‘ä¸ªreduceä»»åŠ¡ï¼Œåé¢å°±ç”Ÿæˆå¤šå°‘ä¸ªæ–‡ä»¶ã€‚è¯´ç™½äº†è¿™ä¸ªå’Œä¸Šé¢çš„åŒºåˆ«å°±æ˜¯å®ƒé€šè¿‡<code>Distribute By</code>æŒ‡å®šæ€ä¹ˆåˆ†åŒºï¼Œå³æŒ‡å®šæ€ä¹ˆåˆ†reducerã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®reduceä¸ªæ•°</span></span><br><span class="line"><span class="keyword">set</span> mapreduce.job.reduces=<span class="number">3</span>;</span><br><span class="line"><span class="comment"># å…ˆæŒ‰ç…§éƒ¨é—¨ç¼–å·åˆ†åŒºï¼Œå†æŒ‰ç…§å‘˜å·¥ç¼–å·é™åºæ’åº</span></span><br><span class="line"><span class="keyword">insert</span> overwrite <span class="keyword">local</span> <span class="keyword">directory</span> <span class="string">'/Users/zxy/IdeaProjects/bigdata-learning/hive-learning/data/output'</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">distribute</span> <span class="keyword">by</span> deptno <span class="keyword">sort</span> <span class="keyword">by</span> empno <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ†æ¡¶-Cluster-By"><a class="header-anchor" href="#åˆ†æ¡¶-Cluster-By">Â¶</a>åˆ†æ¡¶ Cluster By</h3>
<p>å½“distribute by å’Œ sorts by <strong>å­—æ®µç›¸åŒ</strong>æ—¶ï¼Œå¯ä»¥ä½¿ç”¨cluster byæ–¹å¼ã€‚ä½†<strong>æ’åºåªèƒ½æ˜¯å‡åºæ’åº</strong>ã€‚</p>
<p>å¯ä»¥ä»å–åçœ‹å‡ºï¼Œæˆ‘æ²¡ç”¨åˆ†æ¡¶æ’åºã€‚ä½ å¯ä»¥ç†è§£ Cluster å°±æ˜¯æŠŠæ•°æ®åˆ†åŒºï¼Œç„¶åæ¯ä¸ªåˆ†åŒºç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å°±å¥½è§£é‡Šä¸ºå•¥åªèƒ½å‡åºæ’åºï¼Œæˆ‘ç†è§£å®ƒå‹æ ¹å°±ä¸éœ€è¦æ’åºï¼Œåªæ˜¯æŠŠæ•°æ®åˆ†åˆ°ä¸åŒåŒºå°±okã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥ä¸‹ä¸¤ç§å†™æ³•ç­‰ä»·</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp cluster <span class="keyword">by</span> deptno;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">distribute</span> <span class="keyword">by</span> deptno <span class="keyword">sort</span> <span class="keyword">by</span> deptno;</span><br></pre></td></tr></table></figure>
<p><strong>ç»†èŠ‚ä¸€ï¼šæ¥æ³¢å°ç»“ç†ä¸€ä¸‹  åˆ†åŒºè¡¨ åˆ†åŒºæ’åº åˆ†æ¡¶(å‰ä¸¤ä¸ªåˆ†åŒºæ„æ€æˆªç„¶ä¸åŒ)</strong></p>
<ul>
<li><code>partition(month='201909')</code> è¿™ä¸ªæ˜¯åˆ†åŒºè¡¨ï¼Œé’ˆå¯¹çš„æ˜¯æ•°æ®çš„å­˜å‚¨è·¯å¾„</li>
<li><code>Distribute By...Sort By</code> è¿™ä¸ªæ˜¯åˆ†åŒºæ’åºï¼Œå’Œ<strong>MRä¸­çš„åˆ†åŒº</strong>æ¦‚å¿µä¸€æ ·ï¼Œå¤šå°‘ä¸ªåˆ†åŒºï¼Œå°±æœ‰å¤šå°‘ä¸ªreduceä»»åŠ¡ï¼Œåé¢å°±ç”Ÿæˆå¤šå°‘ä¸ªæ–‡ä»¶ï¼Œåˆ†åŒºä¹‹åå¯¹åŒºé‡Œçš„æ•°æ®è¿›è¡Œæ’åºã€‚</li>
<li><code>Cluster By</code> åˆ†æ¡¶ï¼Œé’ˆå¯¹çš„æ˜¯æ•°æ®æ–‡ä»¶ï¼Œå°†å¤§çš„æ•°æ®é›†åˆ†åŒºã€‚</li>
</ul>
<p>æ‰€ä»¥å°† Cluster By ç†è§£ä¸ºåˆ†åŒºï¼Œ Distribute Byâ€¦Sort By ç†è§£ä¸ºåˆ†åŒºæ’åºï¼Œå²‚ä¸ç¾å“‰</p>
<p><strong>ç»†èŠ‚äºŒï¼šæ³¨æ„å¯¼å…¥æ•°æ®åˆ°åˆ†æ¡¶ä¸­ï¼Œè¦ç”¨insertï¼Œä¸” è®¾ç½®<code>hive.enforce.bucketing=true</code>å’Œ<code> hive.enforce.bucketing=true</code></strong></p>
<p><strong>ç»†èŠ‚ä¸‰ï¼šåˆ†æ¡¶æŠ½æ ·æŸ¥è¯¢</strong></p>
<p><code>select * from tablename tablesample(bucket x out of y on id);</code></p>
<p>x è¡¨ç¤ºä»å“ªä¸ªbucketå¼€å§‹æŠ½å–</p>
<p>y è¡¨ç¤ºæŠ½æ ·é—´éš”ï¼Œå…±æŠ½å– æ€»æ•°/y ä¸ªæ¡¶ï¼Œä¸”xçš„å€¼å¿…é¡»<strong>å°äºç­‰äº</strong>yçš„å€¼</p>
<p>ä¸¾ä¾‹ï¼šå¦‚æœ x = 1, y = 4 ï¼Œå…±16ä¸ªæ¡¶ï¼Œé‚£ä¹ˆå°†æŠ½å–16/4ä¸ªæ¡¶ï¼Œåˆ†åˆ«æ˜¯ 1ã€5ã€9ã€13</p>
<h2 id="è¡Œè½¬åˆ—ã€åˆ—è½¬è¡Œ"><a class="header-anchor" href="#è¡Œè½¬åˆ—ã€åˆ—è½¬è¡Œ">Â¶</a>è¡Œè½¬åˆ—ã€åˆ—è½¬è¡Œ</h2>
<p><strong>è¡Œè½¬åˆ—</strong>ï¼šå°†ä¸åŒè¡Œçš„èšåˆåˆ°ä¸€èµ·</p>
<p><code>collect_set(col)</code>ï¼šå‡½æ•°<strong>åªæ¥å—åŸºæœ¬æ•°æ®ç±»å‹</strong>ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å°†æŸå­—æ®µçš„å€¼è¿›è¡Œ<strong>å»é‡æ±‡æ€»</strong>(ä¸å»é‡ç”¨list)ï¼Œäº§ç”Ÿarrayç±»å‹å­—æ®µ</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    base,</span><br><span class="line">    <span class="keyword">concat_ws</span>(<span class="string">"|"</span>, collect_set(<span class="keyword">name</span>)) <span class="keyword">name</span></span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(<span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    <span class="keyword">concat</span>(constellation, <span class="string">","</span>, blood_type) base</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    constellation) t1</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">    base;</span><br></pre></td></tr></table></figure>
<p><strong>åˆ—è½¬è¡Œ</strong>ï¼šå°†åˆ—æ‹†åˆ†æˆå¤šè¡Œã€‚</p>
<p><code>explode(col)</code> å°†hiveä¸€åˆ—ä¸­å¤æ‚çš„arrayæˆ–è€…mapç»“æ„æ‹†åˆ†æˆå¤šè¡Œ</p>
<p><code>LATERAL VIEW udtf(expression) tableAlias AS columnAlias</code> ç”¨äºå’Œsplit, explodeç­‰UDTFä¸€èµ·ä½¿ç”¨ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸€åˆ—æ•°æ®æ‹†æˆå¤šè¡Œæ•°æ®ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥å¯¹æ‹†åˆ†åçš„æ•°æ®è¿›è¡Œèšåˆã€‚</p>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    movie,</span><br><span class="line">    category_name</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    movie_info <span class="keyword">lateral</span> <span class="keyword">view</span> <span class="keyword">explode</span>(<span class="keyword">category</span>) table_tmp <span class="keyword">as</span> category_name;</span><br></pre></td></tr></table></figure>
<h2 id="çª—å£å‡½æ•°"><a class="header-anchor" href="#çª—å£å‡½æ•°">Â¶</a>çª—å£å‡½æ•°</h2>
<p>åŸºæœ¬ç»“æ„ï¼šå‡½æ•° over(èŒƒå›´)  ã€‚ç”¨å‰é¢çš„å‡½æ•°å¤„ç†overä¸­çš„è§„å®šçš„æ•°æ®</p>
<p>é™¤äº†countã€sumç­‰ä¸€äº›å¸¸ç”¨å‡½æ•°ï¼Œè¿˜æœ‰<strong>åªèƒ½é…åˆoverä½¿ç”¨</strong>çš„å‡½æ•°ï¼š</p>
<ul>
<li><code>lag(col,n)</code>ï¼šå¾€å‰ç¬¬nè¡Œæ•°æ®</li>
<li><code>lead(col,n)</code>ï¼šå¾€åç¬¬nè¡Œæ•°æ®</li>
<li><code>ntile(n)</code>ï¼šç»™æ•°æ®ç¼–å·ï¼Œç¼–å·ä»1å¼€å§‹ï¼Œå¯¹äºæ¯ä¸€è¡Œï¼ŒNTILEè¿”å›æ­¤è¡Œæ‰€å±çš„ç»„çš„ç¼–å·ã€‚</li>
<li><code>rank()</code> æ’åºç›¸åŒæ—¶ä¼šé‡å¤ï¼Œæ€»æ•°ä¸ä¼šå˜ï¼Œå¦‚12225668</li>
<li><code>dense_rank()</code> æ’åºç›¸åŒæ—¶ä¼šé‡å¤ï¼Œæ€»æ•°ä¼šå‡å°‘ï¼Œå¦‚12223445</li>
<li><code>row_rank()</code> å•çº¯é¡ºåºè®¡ç®—ï¼Œå¦‚12345678</li>
</ul>
<p>overé‡Œé¢å¯ä»¥è§„å®šçª—å£èŒƒå›´ï¼š</p>
<ul>
<li><code>()</code>ï¼šå…¨éƒ¨æ•°æ®</li>
<li><code>(partition by xxx order by xxx)</code>ï¼šåˆ†åŒºæœ‰åº</li>
<li><code>(rows between xxxx and xxxx)</code>ï¼šæ‰‹åŠ¨æŒ‡å®šèŒƒå›´
<ul>
<li><code>current row</code>ï¼šå½“å‰è¡Œ</li>
<li><code>n preceding</code>ï¼šå¾€å‰nè¡Œæ•°æ®</li>
<li><code>n following</code>ï¼šå¾€ånè¡Œæ•°æ®</li>
<li><code>unbounded preceding</code>ï¼š ä»èµ·ç‚¹å¼€å§‹</li>
<li><code>unbounded following</code>ï¼š åˆ°ç»ˆç‚¹ç»“æŸ</li>
</ul>
</li>
</ul>
<p>ä¸€äº›ä¾‹å­ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">business.name	business.orderdate	business.cost</span><br><span class="line">jack	2017-01-01	10</span><br><span class="line">tony	2017-01-02	15</span><br><span class="line">jack	2017-02-03	23</span><br><span class="line">tony	2017-01-04	29</span><br><span class="line">jack	2017-01-05	46</span><br><span class="line">jack	2017-04-06	42</span><br><span class="line">tony	2017-01-07	50</span><br><span class="line">jack	2017-01-08	55</span><br><span class="line">mart	2017-04-08	62</span><br><span class="line">mart	2017-04-09	68</span><br><span class="line">neil	2017-05-10	12</span><br><span class="line">mart	2017-04-11	75</span><br><span class="line">neil	2017-06-12	80</span><br><span class="line">mart	2017-04-13	94</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ1ï¼‰æŸ¥è¯¢åœ¨2017å¹´4æœˆä»½è´­ä¹°è¿‡çš„é¡¾å®¢åŠæ€»äººæ•°ï¼Œover()é’ˆå¯¹groupbyåçš„å…¨éƒ¨æ•°æ®</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">over</span> () </span><br><span class="line"><span class="keyword">from</span> business </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    <span class="keyword">substring</span>(orderdate,<span class="number">1</span>,<span class="number">7</span>) = <span class="string">'2017-04'</span> </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    <span class="keyword">name</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ2ï¼‰æŸ¥è¯¢é¡¾å®¢çš„è´­ä¹°æ˜ç»† å¹¶ è®©costæŒ‰ç…§æ—¥æœŸè¿›è¡Œç´¯åŠ </span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">cost</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> orderdate) </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    business;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ3ï¼‰æŸ¥çœ‹é¡¾å®¢ä¸Šæ¬¡çš„è´­ä¹°æ—¶é—´ï¼Œåœ¨çª—å£ä¸­åˆ†åŒºæ’åº</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>, </span><br><span class="line">    lag(orderdate, <span class="number">1</span>, <span class="string">'1970-01-01'</span>) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> orderdate)</span><br><span class="line"><span class="keyword">from</span> business;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ4ï¼‰æŸ¥è¯¢å‰20%æ—¶é—´çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ åˆ†ç»„å·</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>, </span><br><span class="line">    ntile(<span class="number">5</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate) sorted</span><br><span class="line"><span class="keyword">from</span> business; t1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿‡æ»¤å‡ºç»„å·ä¸º1çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span></span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(<span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>, </span><br><span class="line">    ntile(<span class="number">5</span>) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> orderdate) sorted</span><br><span class="line"><span class="keyword">from</span> business) t1</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">    sorted = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#ï¼ˆ5ï¼‰è®¡ç®—æ¯ä¸ªäººæ¶ˆè´¹çš„æ’å</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    orderdate,</span><br><span class="line">    <span class="keyword">cost</span>,</span><br><span class="line">    <span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">cost</span> <span class="keyword">desc</span>)</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    business;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>hive</tag>
      </tags>
  </entry>
  <entry>
    <title>hive-DDL</title>
    <url>/2019/09/17/hive-DDL/</url>
    <content><![CDATA[<p>hiveä¸­ä¸€äº›DDLçš„æ“ä½œ</p>
<a id="more"></a>
<h1>DDL</h1>
<p>DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰ç”¨æ¥å¤„ç†æ•°æ®åº“ä¸­çš„å„ç§å¯¹è±¡ï¼Œå¦‚æ•°æ®åº“ã€è¡¨ç­‰</p>
<h2 id="æ•°æ®åº“-database"><a class="header-anchor" href="#æ•°æ®åº“-database">Â¶</a>æ•°æ®åº“(database)</h2>
<h3 id="å¢"><a class="header-anchor" href="#å¢">Â¶</a>å¢</h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå®ƒåœ¨HDFSä¸Šçš„é»˜è®¤å­˜å‚¨è·¯å¾„æ˜¯/user/hive/warehouse/db_hive.db</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> db_hive;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º å¹¶ æŒ‡å®šæ•°æ®åº“åœ¨HDFSä¸Šå­˜æ”¾çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> db_hive2 location <span class="string">'/db_hive2.db'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥"><a class="header-anchor" href="#æŸ¥">Â¶</a>æŸ¥</h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ˜¾ç¤ºæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">databases</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºæ•°æ®åº“è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">desc database extended db_hive;</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">use</span> db_hive;</span><br></pre></td></tr></table></figure>
<h3 id="æ”¹"><a class="header-anchor" href="#æ”¹">Â¶</a>æ”¹</h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹æ•°æ®åº“</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> db_hive <span class="keyword">set</span> dbproperties(<span class="string">'createtime'</span>=<span class="string">'20190917'</span>);</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šæ•°æ®åº“çš„å…¶ä»–å…ƒæ•°æ®ä¿¡æ¯éƒ½æ˜¯ä¸å¯æ›´æ”¹çš„ï¼ŒåŒ…æ‹¬æ•°æ®åº“åå’Œæ•°æ®åº“æ‰€åœ¨çš„ç›®å½•ä½ç½®ã€‚è¿™ä¸ªä¿®æ”¹åªæ˜¯ä¿®æ”¹<code>DBPROPERTIES</code>é‡Œçš„é”®å€¼å¯¹ã€‚</p>
<h3 id="åˆ "><a class="header-anchor" href="#åˆ ">Â¶</a>åˆ </h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">exists</span> db_hive;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶åˆ é™¤éç©ºæ•°æ®åº“</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">database</span> db_hive <span class="keyword">cascade</span>;</span><br></pre></td></tr></table></figure>
<h2 id="è¡¨-table"><a class="header-anchor" href="#è¡¨-table">Â¶</a>è¡¨(table)</h2>
<h3 id="å¢-v2"><a class="header-anchor" href="#å¢-v2">Â¶</a>å¢</h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">EXTERNAL</span>] <span class="keyword">TABLE</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] table_name </span><br><span class="line">[(col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)] </span><br><span class="line">[<span class="keyword">COMMENT</span> table_comment] <span class="comment">-- æ³¨é‡Š</span></span><br><span class="line">[PARTITIONED <span class="keyword">BY</span> (col_name data_type [<span class="keyword">COMMENT</span> col_comment], ...)] <span class="comment">-- åˆ†åŒºè¡¨</span></span><br><span class="line">[CLUSTERED <span class="keyword">BY</span> (col_name, col_name, ...) <span class="comment">-- åˆ†æ¡¶è¡¨</span></span><br><span class="line">[SORTED <span class="keyword">BY</span> (col_name [<span class="keyword">ASC</span>|<span class="keyword">DESC</span>], ...)] <span class="keyword">INTO</span> num_buckets BUCKETS] <span class="comment">-- ä¸å¸¸ç”¨</span></span><br><span class="line">[<span class="keyword">ROW</span> <span class="keyword">FORMAT</span> row_format] <span class="comment">-- å®šä¹‰æ¯è¡Œçš„æ ¼å¼</span></span><br><span class="line">[<span class="keyword">STORED</span> <span class="keyword">AS</span> file_format] <span class="comment">-- æŒ‡å®šå­˜å‚¨æ–‡ä»¶ç±»å‹</span></span><br><span class="line">[LOCATION hdfs_path] <span class="comment">-- æŒ‡å®šè¡¨åœ¨HDFSä¸Šçš„å­˜å‚¨ä½ç½®</span></span><br></pre></td></tr></table></figure>
<p><strong>ä¸€äº›ç»†èŠ‚ï¼š</strong></p>
<ul>
<li><strong>å†…éƒ¨è¡¨ä¸å¤–éƒ¨è¡¨</strong></li>
</ul>
<p><code>CREATE EXTERNAL TABLE</code> ç”¨äºåˆ›å»ºå¤–éƒ¨è¡¨ï¼Œé»˜è®¤æ˜¯å†…éƒ¨è¡¨ï¼ˆç®¡ç†è¡¨ï¼‰ã€‚å®ƒä»¬çš„åŒºåˆ«æ˜¯ åˆ é™¤å¤–éƒ¨è¡¨å¹¶ä¸ä¼šåˆ é™¤HDFSä¸­çš„çš„æ•°æ®ï¼Œåªä¼šåˆ é™¤mysqlä¸­çš„å…ƒæ•°æ®ï¼›è€Œåˆ é™¤å†…éƒ¨è¡¨éƒ½ä¼šåˆ é™¤ã€‚</p>
<p>å¯ä»¥è¿™æ ·ç†è§£å¤–éƒ¨è¡¨ï¼šHDFSä¸Šçš„æ•°æ®æ˜¯å…¬æœ‰çš„ï¼ŒæŸä¸ªå®¢æˆ·ç«¯å»ºä¸€äº†ä¸ªhiveè¡¨å…³è”ä½¿ç”¨å®ƒï¼Œç”Ÿæˆå…ƒæ•°æ®ï¼Œå½“è¯¥å®¢æˆ·ä¸ç”¨æ—¶ï¼Œåªåˆ é™¤ä»–çš„å…ƒæ•°æ®å’Œhiveè¡¨å°±è¡Œï¼Œå…¬æœ‰æ•°æ®ä»ç„¶å­˜åœ¨ã€‚</p>
<ul>
<li><strong>åˆ†åŒºè¡¨</strong></li>
</ul>
<p>æ¯ä¸ªåˆ†åŒº å¯¹åº”ä¸€ä¸ªHDFSæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹é‡ŒåŒ…å«è¯¥åˆ†åŒºæ‰€æœ‰çš„æ•°æ®ã€‚åœ¨æŸ¥è¯¢æ—¶ï¼Œå¯é€šè¿‡ WHERE æŒ‡å®šæŸ¥è¯¢æ‰€éœ€è¦çš„åˆ†åŒºï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šæé«˜å¾ˆå¤šã€‚</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å»ºè¡¨ï¼š</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test1(<span class="keyword">id</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="keyword">string</span>)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">month</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’å…¥æ•°æ®åˆ°æŒ‡å®šåˆ†åŒºï¼š</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/xxxx'</span> <span class="keyword">into</span> <span class="keyword">table</span> test1 <span class="keyword">partition</span>(<span class="keyword">month</span>=<span class="string">'201909'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶ï¼Œä¼šæ•°æ®ä¼šä¿å­˜åœ¨ /user/hive/warehouse/test1/month=201909 ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æŒ‡å®šåˆ†åŒºçš„æ•°æ®ï¼ˆå¯ä»¥ç›´æ¥å°†åˆ†åŒºä½œä¸ºå­—æ®µç”¨ï¼‰</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test1 <span class="keyword">where</span> <span class="keyword">month</span>=<span class="string">'201909'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># äºŒçº§åˆ†åŒºè¡¨</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test2(<span class="keyword">id</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="keyword">string</span>)</span><br><span class="line">partitioned <span class="keyword">by</span> (<span class="keyword">month</span> <span class="keyword">string</span>, <span class="keyword">day</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>å…ƒæ•°æ®å’ŒçœŸå®æ•°æ®</strong></li>
</ul>
<p>å…ƒæ•°æ®å­˜åœ¨mysqlä¸­ï¼ŒåŒ…å«æ•°æ®åº“ä¿¡æ¯ï¼šIDã€æè¿°ã€HDFSè·¯å¾„ã€æ•°æ®åº“åã€æ‰€æœ‰è€…ï¼›åˆ†åŒºä¿¡æ¯ï¼›å­—æ®µä¿¡æ¯ç­‰ç­‰ã€‚è€ŒçœŸå®æ•°æ®éƒ½å­˜åœ¨HDFSä¸­ã€‚</p>
<p><strong>å®ƒä»¬å¯ä»¥è‡ªç”±ç‹¬ç«‹å­˜åœ¨</strong>ï¼Œå¦‚å¤–éƒ¨è¡¨å¯ä»¥ç›´æ¥åˆ é™¤å…ƒæ•°æ®ã€‚å› æ­¤ï¼Œåˆ›å»ºæ•°æ®æ—¶ï¼Œå¦‚æœç›´æ¥æ”¾å…¥åˆ†åŒºä¸­ï¼Œç”±äºå…ƒæ•°æ®ä¸­æ²¡æœ‰åˆ†åŒºä¿¡æ¯ï¼Œæ— æ³•ç”¨whereæŸ¥åˆ°å®ƒï¼Œè™½ç„¶æ•°æ®å­˜åœ¨ã€‚å¯ä»¥é€šè¿‡è¡¥å……åˆ†åŒºä¿¡æ¯ æˆ–è€… æ‰§è¡Œä¿®å¤å‘½ä»¤ï¼Œè®©åˆ†åŒºè¡¨å’Œæ•°æ®äº§ç”Ÿå…³è”ã€‚</p>
<p>æˆ‘çš„ç†è§£ï¼šå…ˆæœ‰æ•°æ®ï¼Œåæœ‰hiveã€‚hiveè¦åšçš„äº‹å°±æ˜¯å…³è”åˆ°æ•°æ®ï¼ˆç”Ÿæˆå…ƒæ•°æ®ï¼‰ï¼Œç„¶åCRUDå®ƒã€‚</p>
<h3 id="æ”¹-v2"><a class="header-anchor" href="#æ”¹-v2">Â¶</a>æ”¹</h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> table_name <span class="keyword">rename</span> <span class="keyword">to</span> new_table_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ åˆ—</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">add</span> <span class="keyword">columns</span>(newdesc <span class="keyword">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–°åˆ—</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">change</span> <span class="keyword">column</span> <span class="keyword">id</span> <span class="keyword">desc</span> <span class="built_in">int</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢åˆ—</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> test1 <span class="keyword">replace</span> <span class="keyword">columns</span>(<span class="keyword">name</span> <span class="keyword">string</span>, loc <span class="keyword">string</span>);</span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥-v2"><a class="header-anchor" href="#æŸ¥-v2">Â¶</a>æŸ¥</h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ˜¾ç¤ºè¡¨</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºè¡¨ä¿¡æ¯</span></span><br><span class="line">desc tablename;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ -v2"><a class="header-anchor" href="#åˆ -v2">Â¶</a>åˆ </h3>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> test1;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>hive</tag>
      </tags>
  </entry>
  <entry>
    <title>éšç¬”-ä¸­ç§‹å…¥å­¦æœ‰æ„Ÿ</title>
    <url>/2019/09/16/%E9%9A%8F%E7%AC%94-20190916%E5%85%A5%E5%AD%A6/</url>
    <content><![CDATA[<p>å¾ˆæ—©æƒ³å†™ï¼Œå´è¿Ÿè¿ŸæœªåŠ¨ç¬”ã€‚ä»Šæœ‰å…´ç•™ä»¥çºªå¿µã€‚</p>
<a id="more"></a>
<p><strong>ç»ˆäºæ­£å¼æˆä¸ºäº†ç ”ç©¶ç”Ÿå¤§å†›çš„ä¸€å‘˜ï½</strong></p>
<p>å»å¹´æ˜¯ä¸­ç§‹èŠ‚ç»“æŸè¿›å®éªŒå®¤çš„ï¼Œä»Šå¤©äº¦æ˜¯å†œå†å…«æœˆåå…­ï¼ŒæŒ‰å†œå†ç®—åˆšå¥½ä¸€å¹´äº†å‘€ã€‚</p>
<p>è¿™æ®µæ—¶é—´ï¼Œå­¦äº†å¾ˆå¤šï¼Œæ‚ä¸ƒæ‚å…«çš„ã€‚å­¦è¿‡äººå·¥æ™ºèƒ½ï¼Œè¯•è¿‡åå°å¼€å‘ï¼Œå¦‚ä»Šåˆè½¬æˆ˜å¤§æ•°æ®ã€‚hhï¼Œå¯ä»¥è¯´å°±å·®å‰ç«¯äº†ï¼ˆæ²¡ç³»ç»Ÿå­¦ï¼Œä½†å†™åå°å¤šå°‘ä¼šç‚¹ï¼‰ã€‚ã€‚è¯­è¨€æ–¹é¢æœ‰ï¼šc++ ï¼ŒJavaï¼Œpython ï¼Œscalaã€‚ã€‚å¯æ˜¯ï¼Œæˆ‘è§‰å¾—éƒ½åªæ˜¯ä¼šç‚¹çš®æ¯›è€Œå·²ã€‚</p>
<p><strong>ä½†æ˜¯ï¼Œæˆ‘å¹¶ä¸è§‰å¾—æ˜¯ç™½å­¦äº†ã€‚</strong></p>
<p>å°±æ‹¿ç°åœ¨å¤§çƒ­çš„æ·±åº¦å­¦ä¹ ï¼Œæˆ‘ä¹Ÿå­¦äº†å¯èƒ½å¤§åŠå¹´ï¼ˆç®—ä¸Šå¤§ä¸‰ä¸‹ï¼‰ã€‚åªæœ‰ä½“éªŒè¿‡ï¼Œæ‰çŸ¥é“æ·±åº¦å­¦ä¹ æ²¡æœ‰é‚£ä¹ˆç„ä¹ï¼›åªæœ‰ä½“éªŒè¿‡ï¼Œå°†æ¥æ‰å¯èƒ½ä¸ä¼šè¯´å½“åˆå°±åº”è¯¥å­¦å¤§çƒ­çš„æ·±åº¦å­¦ä¹ äº†ã€‚æ¯•ç«Ÿï¼Œå¢™å¤–çš„æƒ³è¿›å»ï¼Œå¢™é‡Œé¢çš„æƒ³å‡ºæ¥å˜›ã€‚è¿˜è®°å¾—ï¼Œå½“åˆç¬¬ä¸€æ¬¡çœ‹å´æ©è¾¾çš„è§†é¢‘æ—¶ï¼Œé‚£æ„Ÿè§‰çœŸåƒï¼Œå‘ç°äº†æ–°å¤§é™†ä¸€æ ·ã€‚å¯æ˜¯æ¸æ¸ä¹Ÿè§‰å¾—æœ‰ç‚¹åŒå€¦ã€‚é‚£æ—¶ï¼Œæˆ‘ä¹Ÿå–œæ¬¢åœ¨ leedcode åˆ·ç‚¹ç®—æ³•é¢˜ï¼Œå¯¹æ¯”æˆ‘å‘ç°ï¼Œæ¯”èµ·è°ƒå‚ï¼Œæˆ‘å¯èƒ½æ›´å–œæ¬¢ç¼–ç¨‹ã€‚æ¯”èµ·ä¸ç¡®å®šçš„å‡†ç¡®ç‡ï¼Œä¸€è¡Œè¡Œä»£ç  è®©æˆ‘æ›´æœ‰æˆå°±æ„Ÿäº›ï½</p>
<p>åå°å¼€å‘ çš„å­¦ä¹ è®©æˆ‘å¯¹ç½‘ç«™çš„æ•´ä¸ªæµç¨‹æœ‰äº†è®¤è¯†ã€‚ä»æœ‰æ•°æ®åº“çš„è®¾è®¡ï¼Œåˆ°å’Œå‰ç«¯çš„äº¤äº’è®¾è®¡åå°æ¥å£ï¼Œå†åˆ°ç½‘ç«™éƒ¨ç½²ï¼Œä¹Ÿç®—æ•´äº†ä¸€ä¸ªèƒ½ç”¨çš„ä¸œè¥¿å‡ºæ¥ã€‚ç”±äºï¼Œåå°æ›´å¤šæ˜¯æ•°æ®äº¤äº’ï¼Œå®ƒå’Œå¤§æ•°æ®ä¹Ÿæ˜¯æœ‰å¾ˆå¤šè”ç³»ä¹‹å¤„çš„ï¼Œè€Œä¸”ä¸»è¦éƒ½æ˜¯åŸºäºJavaçš„ã€‚hhï¼ŒJavaæ˜¯å¾ˆå¼ºå¤§å˜›ã€‚</p>
<p>ä¸€å¹´çš„æ—¶å…‰ï¼Œæˆ‘å‘ç°å¾ˆå¤šæŠ€æœ¯éƒ½æ˜¯èåˆåœ¨ä¸€èµ·çš„ï¼Œåå°å’Œå¤§æ•°æ®éƒ½å’Œæ•°æ®æ‰“äº¤é“ï¼Œé›†ç¾¤çš„ä½¿ç”¨å¯ä»¥è®©äººå·¥æ™ºèƒ½çš„è®¡ç®—åŠ›æ›´ä¸Šä¸€å±‚æ¥¼ã€‚å¤§æ•°æ®æ›´å¤šçš„æ˜¯åˆ†å¸ƒå¼æ˜¯æ€æƒ³ï¼Œåå°æ›´ä¸“æ”»å…·ä½“ä¸šåŠ¡éœ€æ±‚ã€‚å¾ˆå¤šåå°äººå‘˜å¯ä»¥è¿‡åº¦åˆ°å¤§æ•°æ®ï¼Œè¯æ˜è”ç³»ä¹‹æ·±ã€‚åŒæ—¶äººå·¥æ™ºèƒ½çš„åˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒçš„æ­å»ºï¼Œä»¥åæœªå°ä¸æ˜¯ä¸€ä¸ªçƒ­é—¨éœ€æ±‚å‘¢ã€‚</p>
<p><strong>æ—¶å…‰å¦‚ç™½é©¹è¿‡éš™ã€‚å­¦çš„å¹¿ï¼Œä¸å¦‚ä¸“ç²¾ä¸€é—¨ã€‚</strong></p>
<p>å¦‚æœè¯´ä¹‹å‰çš„å­¦ä¹ ï¼Œè®©æˆ‘åœ¨å‡ ä¸ªå¤§çƒ­é¢†åŸŸéƒ½ä½“éªŒäº†ä¸€ç•ªï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯ï¼Œåœ¨è‡ªå·±æœ€å–œæ¬¢çš„ä¸€ä¸ªé¢†åŸŸï¼Œä¸“ç ”ä¸‹å»ã€‚</p>
<p><strong>å…ˆå®šäº›å°ç›®æ ‡</strong></p>
<p>åœ¨ç¬¬ä¸€ä¸ªå­¦æœŸçš„å‰åŠä¸ªå­¦æœŸï¼ŒæŠŠå¤§æ•°æ®çš„å®ç”¨çƒ­é—¨æ¡†æ¶éƒ½è¿‡ä¸€éï¼Œæœ‰ä¸ªç³»ç»Ÿæ€§çš„è®¤è¯†ã€‚ååŠä¸ªå­¦æœŸï¼Œçœ‹çœ‹æ˜¯è¿›é˜¶ä¸‹javaï¼Œè¿˜æ˜¯é’»ç ”ä¸‹sparkã€‚åœ¨ç¬¬äºŒä¸ªå­¦æœŸï¼Œå·©å›ºå¤§æ•°æ®çš„å‡ ä¸ªæœ€é‡è¦çš„æ¡†æ¶ï¼Œå¤šç ”ç©¶javaä»¥åŠæ•°æ®åº“ã€‚è¯­è¨€è¿˜æ˜¯è¦å­¦çš„ç²¾ç‚¹å¥½ï¼Œå­¦é•¿è¯´çš„å¥½ï¼Œå°±ç®—ä½ å•¥éƒ½ä¸ä¼šï¼Œjavaç©çš„å‡ºç¥å…¥åŒ–ï¼Œç…§æ ·æŠ¢ç€è¦ã€‚è‡³äºç ”äºŒï¼Œåˆ°æ—¶å†è¯´å§ï½</p>
<p><strong>ç»“å°¾äº†ï¼Œæ‰“æ³¢é¸¡è¡€</strong></p>
<p>ã€Šé˜¿ç”˜æ­£ä¼ ã€‹é‡Œæœ‰ä¸ªè®©æˆ‘æ„Ÿè§¦å¾ˆæ·±çš„æƒ…èŠ‚ã€‚é˜¿ç”˜ä¸çŸ¥é“è¯¥å¹²ä»€ä¹ˆï¼Œå¼€å§‹äº†ä¸€æ®µè·‘æ­¥ç”Ÿæ¶¯ã€‚åœ¨è¿™ä¸‰å¹´é‡Œï¼Œä»–åšçš„ä»…ä»…åªæ˜¯ä¸åœçš„å¾€å‰è·‘å‘€è·‘ï¼Œè·‘å‘€è·‘ã€‚ä½†æ˜¯ä»–çš„è¿½éšè€…ä»ä¸€ä¸ªå˜ä¸¤ä¸ªï¼Œä¸¤ä¸ªå˜ä¸‰ä¸ªï¼Œåé¢è¶Šæ¥è¶Šå¤šï¼Œè¶Šæ¥è¶Šå¤šï¼ŒæŠ¥é“è€…ä¹Ÿè¶Šæ¥è¶Šå¤šã€‚ä½ å¯èƒ½ä¼šè¯´ï¼Œè¿™å°±æ˜¯æ¼”ç”µå½±å§ï¼Ÿä¸ï¼æˆ‘è§‰å¾—å°±ç®—å‘ç”Ÿåœ¨ç°å®ï¼Œæˆ‘ç›¸ä¿¡ç»“æœåŒæ ·ä¼šå¦‚æ­¤ï¼</p>
<p>**å¯ä»¥è¯´æœ€å®¹æ˜“çš„äº‹æ˜¯åšæŒï¼Œæœ€éš¾çš„ä¹Ÿæ˜¯åšæŒã€‚**ä¸ç®¡ä½ å­¦çš„æ˜¯ä»€ä¹ˆï¼Œåªè¦ä½ è‚¯ä¸€ç›´åšæŒä¸‹å»ï¼Œå³ä½¿åªæ˜¯ç®€å•çš„æ¯å¤©è·‘ï¼Œä½ ä¹Ÿç»å¯¹ä¼šæˆåŠŸçš„ï¼</p>
<p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1568649098110&amp;di=9c138a4f9097ca8373cfeba8edf1bdab&amp;imgtype=0&amp;src=http%3A%2F%2Fpic.rmb.bdstatic.com%2Fe61012997dcaf9d2ca611c60bfa03db7.jpg" alt></p>
]]></content>
      <categories>
        <category>éšç¬”</category>
      </categories>
      <tags>
        <tag>éšç¬”</tag>
      </tags>
  </entry>
  <entry>
    <title>hive-å®‰è£…ä¸é…ç½®</title>
    <url>/2019/09/16/hive-%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>ä»‹ç»hiveçš„å®‰è£…ï¼Œä½¿ç”¨ mysql åš hive çš„å…ƒæ•°æ®åº“</p>
<a id="more"></a>
<h1>å‡†å¤‡</h1>
<p>æˆ‘çš„ç‰ˆæœ¬ï¼š</p>
<p><strong>hadoop 2.7.7</strong></p>
<p><strong>hive 2.3.6</strong></p>
<p><strong>mysql 8.0.16</strong></p>
<p>å…ˆè£…å¥½mysqlï¼ˆåšhiveçš„å…ƒæ•°æ®åº“ï¼‰ å’Œ hadoop</p>
<h1>é…ç½® Hive</h1>
<h2 id="ä¿®æ”¹-hive-env-sh"><a class="header-anchor" href="#ä¿®æ”¹-hive-env-sh">Â¶</a>ä¿®æ”¹ <a href="http://hive-env.sh" target="_blank" rel="noopener">hive-env.sh</a></h2>
<p>ä¿®æ”¹<code>apache-hive-2.3.6-bin/conf</code>ä¸‹çš„<code>hive-env.sh</code>ï¼ŒåŠ ä¸Šhadoopè·¯å¾„</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HADOOP_HOME=/usr/local/hadoop-2.7.7</span><br><span class="line">export HIVE_CONF_DIR=/usr/local/apache-hive-2.3.6-bin/conf</span><br></pre></td></tr></table></figure>
<h2 id="åˆ›å»º-hive-site-xml"><a class="header-anchor" href="#åˆ›å»º-hive-site-xml">Â¶</a>åˆ›å»º hive-site.xml</h2>
<p>åœ¨<code>apache-hive-2.3.6-bin/conf</code>ä¸‹åˆ›å»º<code>hive-site.xml</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">   &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;jdbc:mysql://localhost:3306/metastore?useSSL=false&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;metadata is stored in a MySQL server&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;com.mysql.cj.jdbc.Driver&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;MySQL JDBC driver class&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;root&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;user name for connecting to mysql server&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;ä½ çš„å¯†ç &lt;/value&gt;</span><br><span class="line">    &lt;description&gt;password for connecting to mysql server&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<h2 id="æ·»åŠ -javaè¿æ¥-mysql-çš„jaråŒ…"><a class="header-anchor" href="#æ·»åŠ -javaè¿æ¥-mysql-çš„jaråŒ…">Â¶</a>æ·»åŠ  javaè¿æ¥ mysql çš„jaråŒ…</h2>
<p>åœ¨<code>apache-hive-2.3.6-bin/lib</code>ä¸‹æ·»åŠ  <a href="https://mvnrepository.com/artifact/mysql/mysql-connector-java" target="_blank" rel="noopener">java è¿æ¥ mysql çš„jaråŒ…</a>ï¼ˆè¦å¯¹åº”mysqlç‰ˆæœ¬ï¼‰ã€‚</p>
<p>æˆ‘çš„æ˜¯<code>mysql-connector-java-8.0.15.jar</code></p>
<h1>é…ç½® mysql</h1>
<h2 id="é…ç½®è¿œç¨‹ç™»å½•æƒé™-è¿™ä¸ªæˆ‘æ²¡é…ï¼Œè®°ç€å¤‡ç”¨"><a class="header-anchor" href="#é…ç½®è¿œç¨‹ç™»å½•æƒé™-è¿™ä¸ªæˆ‘æ²¡é…ï¼Œè®°ç€å¤‡ç”¨">Â¶</a>é…ç½®è¿œç¨‹ç™»å½•æƒé™(è¿™ä¸ªæˆ‘æ²¡é…ï¼Œè®°ç€å¤‡ç”¨)</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># åˆ‡æ¢æˆmysqlåº“</span><br><span class="line">use mysql; </span><br><span class="line"># æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span><br><span class="line">select User,Host,authentication_string from user; </span><br><span class="line"># è®¾ç½®è¿œç¨‹ç™»å½•æƒé™</span><br><span class="line">grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;xxxxxxxx&apos; with grant option; </span><br><span class="line"># åˆ·æ–°é…ç½®ä¿¡æ¯</span><br><span class="line">flush privileges;</span><br><span class="line"># é€€å‡º</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<h2 id="å»º-metastore-è¡¨"><a class="header-anchor" href="#å»º-metastore-è¡¨">Â¶</a>å»º metastore è¡¨</h2>
<p>è¡¨çš„åå­—ä¸ä¹‹å‰<code>hive-site.xml</code>ä¸­é…ç½®çš„ç›®å½•åä¸€æ ·</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;value&gt;jdbc:mysql://localhost:3306/metastore?useSSL=false&lt;/value&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create database metastore</span><br></pre></td></tr></table></figure>
<h1>å¼€å§‹ä½¿ç”¨</h1>
<h2 id="åˆå§‹åŒ–mysqlå…ƒæ•°æ®åº“ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶ï¼‰"><a class="header-anchor" href="#åˆå§‹åŒ–mysqlå…ƒæ•°æ®åº“ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶ï¼‰">Â¶</a>åˆå§‹åŒ–mysqlå…ƒæ•°æ®åº“ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶ï¼‰</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bin/schematool -dbType mysql -initSchema</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨hive"><a class="header-anchor" href="#ä½¿ç”¨hive">Â¶</a>ä½¿ç”¨hive</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">âœ  apache-hive-2.3.6-bin bin/hive</span><br><span class="line">Logging initialized using configuration in file:/usr/local/apache-hive-2.3.6-bin/conf/hive-log4j2.properties Async: true</span><br><span class="line">Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.</span><br><span class="line">hive &gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>é…ç½®</tag>
        <tag>hive</tag>
      </tags>
  </entry>
  <entry>
    <title>flume-åŸºæœ¬åŸç†</title>
    <url>/2019/09/12/flume-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<p>ä»‹ç»äº†flumeçš„åŸºæœ¬åŸç†å’Œä½¿ç”¨</p>
<a id="more"></a>
<h1>ç®€ä»‹</h1>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/flume/agent.png" alt></p>
<p>Flumeæ˜¯ä¸€ç§<strong>åˆ†å¸ƒå¼</strong>ï¼Œ<strong>å¯é ä¸”å¯ç”¨</strong>çš„æœåŠ¡ï¼Œç”¨äº<strong>æœ‰æ•ˆåœ°æ”¶é›†ï¼Œèšåˆå’Œä¼ è¾“å¤§é‡æ—¥å¿—æ•°æ®</strong>ï¼Œæ˜¯åŸºäº<strong>æµå¼</strong>çš„ç®€å•çµæ´»çš„æ¶æ„ã€‚</p>
<p>å®ƒå…·æœ‰å¯é çš„<strong>å¯é æ€§æœºåˆ¶</strong>å’Œè®¸å¤š<strong>æ•…éšœè½¬ç§»å’Œæ¢å¤æœºåˆ¶</strong>ï¼Œå…·æœ‰å¼ºå¤§çš„å®¹é”™æ€§ã€‚</p>
<p>å®ƒä½¿ç”¨ç®€å•çš„<strong>å¯æ‰©å±•</strong>æ•°æ®æ¨¡å‹ï¼Œå…è®¸åœ¨çº¿åˆ†æåº”ç”¨ç¨‹åºã€‚</p>
<h1>æµç¨‹å›¾</h1>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/flume/flume.png" alt></p>
<h1>å…­å¤§ç»„ä»¶</h1>
<p>3å¤§åŸºæœ¬ç»„ä»¶ï¼Œ3ä¸ªè¾…åŠ©ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶éƒ½æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ã€‚</p>
<h2 id="Source"><a class="header-anchor" href="#Source">Â¶</a>Source</h2>
<p>ç”¨äºæ•°æ®çš„æ”¶é›†ã€‚å°†æ•°æ®æ•è·åå¯ä»¥å…ˆè¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œç„¶åå°†æ•°æ®å°è£…åˆ°äº‹ä»¶ï¼ˆeventï¼‰ é‡Œï¼ˆå¦‚eventçš„bodyï¼‰ï¼Œæœ€åå°†äº‹ä»¶æ¨å…¥Channelä¸­ã€‚</p>
<p><strong>å¸¸è§çš„source</strong>:</p>
<p><strong>Avro Source</strong>ã€<strong>Exce Source</strong>ã€<strong>Spooling Directory Source</strong>ã€<strong>NetCat Source</strong>ã€Syslog Sourceã€Syslog TCP Sourceã€Syslog UDP Sourceã€HTTP Sourceã€<strong>HDFS Source</strong> ç­‰ç­‰ã€‚</p>
<h2 id="Channel"><a class="header-anchor" href="#Channel">Â¶</a>Channel</h2>
<p>ç”¨äºè¿æ¥Sourceå’ŒSinkçš„ç»„ä»¶ï¼Œæ˜¯æ•°æ®çš„ç¼“å†²åŒºã€‚å®ƒå¯ä»¥å°†äº‹ä»¶æš‚å­˜åˆ°å†…å­˜ä¸­ä¹Ÿå¯ä»¥æŒä¹…åŒ–åˆ°æœ¬åœ°ç£ç›˜ä¸Šï¼Œ ç›´åˆ°Sinkå¤„ç†å®Œè¯¥äº‹ä»¶ã€‚</p>
<p><strong>å¸¸è§çš„channel</strong>:</p>
<p><strong>Memory Channel</strong>ã€<strong>File Channel</strong>ã€<strong>Kafka Channel</strong>ç­‰ç­‰ã€‚</p>
<h2 id="Sink"><a class="header-anchor" href="#Sink">Â¶</a>Sink</h2>
<p>ä»channelä¸­å–å‡ºæ•°æ®ï¼Œå†å°†æ•°æ®å­˜å…¥ç›¸åº”çš„å­˜å‚¨æ–‡ä»¶ç³»ç»Ÿï¼Œæ•°æ®åº“ï¼Œæˆ–è€…æäº¤åˆ°è¿œç¨‹æœåŠ¡å™¨ã€‚</p>
<p><strong>å¸¸è§çš„sink</strong>:</p>
<p><strong>HDFS sink</strong>ã€<strong>Logger sink</strong>ã€<strong>Avro sink</strong>ã€<strong>File Roll sink</strong>ã€Null sinkã€HBase sink ç­‰ç­‰ã€‚</p>
<h2 id="Interceptor"><a class="header-anchor" href="#Interceptor">Â¶</a>Interceptor</h2>
<p>å¯¹Sourceæ”¶é›†çš„æ•°æ®ï¼Œè¿›è¡Œ<strong>åˆ†ç±»</strong>æˆ–è€…<strong>æ‹¦æˆª</strong>ã€‚å¯ä»¥å°†å¤šä¸ªInterceptorè¿æ¥å½¢æˆæ‹¦æˆªå™¨é“¾ã€‚</p>
<p><strong>ç”¨æ³•</strong></p>
<ul>
<li>
<p>åˆ†ç±»ï¼šè‡ªå®šä¹‰åˆ†ç±»é€»è¾‘ï¼Œå°†åˆ†ç±»å±æ€§(k,vç±»å‹)ï¼ŒåŠ å…¥eventçš„headersä¸­ï¼Œç„¶åä½¿ç”¨<strong>MultiplexingChannelSelector</strong>é€‰æ‹©å™¨ é€‰æ‹©æ”¾å…¥å“ªä¸ªchannelä¸­ã€‚</p>
</li>
<li>
<p>æ‹¦æˆªï¼šè‡ªå®šä¹‰ä¸¢å¼ƒé€»è¾‘ï¼Œå°†ä¸è¦çš„eventè®¾ä¸º<strong>null</strong>å³å¯ã€‚</p>
</li>
</ul>
<h2 id="ChannelSelector"><a class="header-anchor" href="#ChannelSelector">Â¶</a>ChannelSelector</h2>
<p>å°†eventæ”¾å…¥æŒ‡å®šçš„channelä¸­ã€‚</p>
<p><strong>2ç§ChannelSelector</strong>:</p>
<ul>
<li>
<p><strong>ReplicatingChannelSelector</strong>ï¼ˆé»˜è®¤ï¼‰ ï¼šå°†äº‹ä»¶æ”¾å…¥æ‰€æœ‰channelä¸­ã€‚ï¼ˆç”¨äºå¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯å¤‡ä»½ï¼‰</p>
</li>
<li>
<p><strong>MultiplexingChannelSelector</strong> ï¼šç»“åˆ<strong>Interceptor</strong>ä½¿ç”¨ã€‚æ ¹æ®headerï¼Œå°†eventæ”¾åˆ°æŒ‡å®šçš„channelä¸­ã€‚</p>
</li>
</ul>
<h2 id="sinkgroupsä¸­çš„SinkProcessor"><a class="header-anchor" href="#sinkgroupsä¸­çš„SinkProcessor">Â¶</a>sinkgroupsä¸­çš„SinkProcessor</h2>
<p>æŒ‰ç…§æŒ‡å®šç®—æ³•å°†eventåˆ†é…åˆ°sinkç»„çš„sinkä¸­ã€‚éœ€è¦å…ˆæŒ‡å®šä¸€ä¸ªsinkç»„ï¼Œå†é€‰æ‹©SinkProcessorï¼Œå®ƒä¼šæ ¹æ®é…ç½®çš„åˆ†é…æ–¹å¼è‡ªåŠ¨å°†eventåˆ†åˆ°ç»„é‡Œçš„sinkä¸­ã€‚æ³¨æ„é»˜è®¤çš„SinkProcessorä¸­ï¼Œæ²¡æœ‰sinkç»„çš„æ¦‚å¿µï¼Œä¸éœ€è¦é…ç½®ï¼Œä¹Ÿå°±æ˜¯ä¸€å¯¹ä¸€ã€‚</p>
<p><strong>2ç§SinkProcessor</strong>:</p>
<ul>
<li>
<p><strong>LoadBalanceSinkProcessor</strong> ï¼šè´Ÿè½½å‡è¡¡ã€‚å¯é€‰æ‹©åˆ†é…æ–¹å¼ï¼šå¦‚éšæœºåˆ†é…ã€è½®è¯¢åˆ†é…ç­‰ç­‰</p>
</li>
<li>
<p><strong>FailoverSinkProcessor</strong> ï¼šä¼˜å…ˆçº§åˆ†é…ï¼ˆå¤šç”¨äºæ•…éšœè½¬ç§»ï¼‰ã€‚æŒ‡å®šsinkçš„ä¼˜å…ˆçº§ï¼ŒæŒ‰ä¼˜å…ˆçº§åˆ†é…ã€‚</p>
</li>
</ul>
<h1>ä¸¤ä¸ªTransaction</h1>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/flume/transaction.png" alt></p>
<h2 id="Put-Transaction"><a class="header-anchor" href="#Put-Transaction">Â¶</a>Put Transaction</h2>
<p>å®ƒå®ç° source å°† event å‘é€è‡³ channelï¼Œå¸¦æœ‰å®¹é”™æœºåˆ¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹é˜¶æ®µï¼š</p>
<ul>
<li><strong>doPut</strong>: å°†æ‰¹æ•°æ®å†™å…¥ä¸´æ—¶ç¼“å†²åŒºputList</li>
<li><strong>doCommit</strong>: æ£€æŸ¥channelå†…å­˜é˜Ÿåˆ—æ˜¯å¦è¶³å¤Ÿåˆå¹¶ã€‚</li>
<li><strong>doRollback</strong>: channelå†…å­˜é˜Ÿåˆ—ç©ºé—´ä¸è¶³ï¼Œå›æ»šæ•°æ®</li>
</ul>
<h2 id="Take-Transaction"><a class="header-anchor" href="#Take-Transaction">Â¶</a>Take Transaction</h2>
<p>å®ƒå®ç° sink å°† event ä» channel ä¸­æå–å‡ºæ¥ï¼Œå¸¦æœ‰å®¹é”™æœºåˆ¶ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹é˜¶æ®µï¼š</p>
<ul>
<li><strong>doTake</strong>: å°†æ•°æ®æå–åˆ°ä¸´æ—¶ç¼“å†²åŒºtakeList</li>
<li><strong>doCommit</strong>: æ•°æ®å‘é€æˆåŠŸçš„å‰æä¸‹ï¼Œæ¸…é™¤ä¸´æ—¶ç¼“å†²åŒºtakeList</li>
<li><strong>doRollback</strong>: æ•°æ®å‘é€è¿‡ç¨‹ä¸­å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œrollbackå°†ä¸´æ—¶ç¼“å†²åŒºtakeListä¸­çš„æ•°æ®å½’è¿˜ç»™channelå†…å­˜é˜Ÿåˆ—ã€‚</li>
</ul>
<h1>ä¸€äº›æ¡ˆä¾‹</h1>
<ul>
<li><strong>æ—¥å¿—å¤åˆ¶ï¼ˆå¤‡ä»½ï¼‰</strong></li>
</ul>
<p>å•sourceï¼Œå¤šchannelï¼Œå¤šsink</p>
<p>ä½¿ç”¨ ReplicatingChannelSelectorï¼Œå°†æ¯ä¸ªeventåˆ†åˆ°å¤šä¸ªchannelå†ä¼ åˆ°sinkä¸­ï¼Œå®ç°å¤åˆ¶ï¼ˆå¤‡ä»½ï¼‰ã€‚</p>
<ul>
<li><strong>æ—¥å¿—åˆ†ç±»</strong></li>
</ul>
<p>å•sourceï¼Œå¤šchannelï¼Œå¤šsinkï¼Œ é…ç½®æ‹¦æˆªå™¨</p>
<p>ä½¿ç”¨ MultiplexingChannelSelectorï¼Œæ ¹æ®æ‹¦æˆªå™¨å°†æ¯ä¸ªeventï¼Œåˆ†åˆ°æŒ‡å®šçš„channelä¸­å†ä¼ åˆ°sinkä¸­ï¼Œå®ç°åˆ†ç±»ã€‚</p>
<ul>
<li><strong>è´Ÿè½½å‡è¡¡</strong></li>
</ul>
<p>å•sourceï¼Œå•channelï¼Œå¤šsinkï¼ˆç»„æˆä¸€ä¸ªsinkç»„ï¼‰</p>
<p>ä½¿ç”¨LoadBalanceSinkProcessorï¼Œé€‰æ‹©åˆ†é…æ–¹å¼ï¼šå¦‚éšæœºåˆ†é…ã€è½®è¯¢åˆ†é…ï¼Œå°†eventé€’ç»™ç›¸åº”sinkã€‚</p>
<ul>
<li><strong>æ•…éšœè½¬ç§»</strong></li>
</ul>
<p>å•sourceï¼Œå•channelï¼Œå¤šsinkï¼ˆç»„æˆä¸€ä¸ªsinkç»„ï¼‰</p>
<p>ä½¿ç”¨FailoverSinkProcessorï¼Œç»™sinkç»„é‡Œçš„sinkæŒ‡å®šä¼˜å…ˆçº§ï¼Œåªæœ‰ä¼˜å…ˆçº§æœ€é«˜çš„ä¼šæ¥æ”¶ï¼Œå½“å®ƒæŒ‚äº†ï¼Œæ¬¡ä¼˜å…ˆçº§çš„æ‰ä¼šæ¥æ”¶ã€‚</p>
<ul>
<li><strong>æ—¥å¿—èšåˆ</strong></li>
</ul>
<p>å¤šsourceï¼Œå•channelï¼Œå•sink</p>
<p>ç›´æ¥å°†å¤šä¸ªæºçš„æ•°æ®ï¼Œç”¨ä¸€ä¸ªchannelæ¥æ”¶ã€‚</p>
<ul>
<li><strong>å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¡†æ¶Gangliaå¯¹flumeå®ç°ç›‘æ§</strong></li>
</ul>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>flume</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkåŸºç¡€-DataFrameå’ŒDataSet</title>
    <url>/2019/09/09/spark%E5%9F%BA%E7%A1%80-DataFrame%E5%92%8CDataSet/</url>
    <content><![CDATA[<p>ä»‹ç»äº†åœ¨sparkä¸­DataFrameå’ŒDataSetï¼Œä»¥åŠå®ƒä»¬ä¹‹é—´çš„ç›¸äº’è½¬æ¢ã€‚</p>
<a id="more"></a>
<h1>æ¦‚å¿µåˆ†æ</h1>
<p><strong>DataFrame</strong></p>
<p>ç±»ä¼¼ä¼ ç»Ÿæ•°æ®åº“çš„äºŒç»´è¡¨æ ¼ï¼Œé™¤äº†æ•°æ®ä»¥å¤–ï¼Œè¿˜è®°å½•æ•°æ®çš„ç»“æ„ä¿¡æ¯ï¼Œå³schemaã€‚ä¹Ÿå°±æ˜¯æ™®é€šRDDæ·»åŠ ç»“æ„åŒ–ä¿¡æ¯å¾—åˆ°ã€‚</p>
<p><strong>DataSet</strong></p>
<p>å¼ºç±»å‹çš„ï¼Œå­˜å‚¨çš„æ˜¯å¯¹è±¡ã€‚ç”±<code>DataFrame</code>æ·»åŠ ç±»å±æ€§å¾—åˆ°ã€‚</p>
<p>ç›¸åŒç‚¹</p>
<ul>
<li>
<p>éƒ½æ˜¯åŸºäºRDDçš„ï¼Œæ‰€ä»¥éƒ½æœ‰RDDçš„ç‰¹æ€§ï¼Œå¦‚æ‡’åŠ è½½ï¼Œåˆ†å¸ƒå¼ï¼Œä¸å¯ä¿®æ”¹ï¼Œåˆ†åŒºç­‰ç­‰ã€‚ä½†æ‰§è¡Œsqlæ€§èƒ½æ¯”RDDé«˜ï¼Œå› ä¸ºsparkè‡ªåŠ¨ä¼šä½¿ç”¨ä¼˜åŒ–ç­–ç•¥æ‰§è¡Œã€‚è¯´ç™½äº†ä½ æ‰‹æ’¸çš„å¹²ä¸è¿‡å¼€å‘è€…å†™çš„ã€‚</p>
</li>
<li>
<p>å‡æ”¯æŒsparksqlçš„æ“ä½œï¼Œè¿˜èƒ½æ³¨å†Œä¸´æ—¶è¡¨ï¼Œè¿›è¡Œsqlè¯­å¥æ“ä½œ</p>
</li>
<li>
<p><code>DataFrame</code>å’Œ<code>Dataset</code>å‡å¯ä½¿ç”¨æ¨¡å¼åŒ¹é…è·å–å„ä¸ªå­—æ®µçš„å€¼å’Œç±»å‹</p>
</li>
<li>
<p><code>DataFrame</code>ä¹Ÿå«<code>Dataset[Row]</code>ï¼Œæ¯ä¸€è¡Œçš„ç±»å‹æ˜¯Row</p>
</li>
</ul>
<p>ä¸åŒç‚¹</p>
<p>å› ä¸º<code>DataFrame</code>ä¹Ÿå«<code>Dataset[Row]</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬ç†è§£äº†<strong>Row</strong>å’Œ<strong>æ™®é€šå¯¹è±¡</strong>çš„åŒºåˆ«å°±å¥½åŠäº†</p>
<ul>
<li>
<p><strong>Row</strong>çš„æ•°æ®ç»“æ„ç±»ä¼¼ä¸€ä¸ªæ•°ç»„ï¼Œåªæœ‰é¡ºåºï¼Œåˆ‡è®°ã€‚<strong>æ™®é€šå¯¹è±¡</strong>çš„æ•°æ®ç»“æ„ä¹Ÿå°±æ˜¯å¯¹è±¡ã€‚</p>
</li>
<li>
<p>å› æ­¤ï¼Œè®¿é—®<strong>Row</strong>åªèƒ½é€šè¿‡å¦‚ï¼š<code>getInt(i: Int)</code>è§£ææ•°æ® æˆ–è€… é€šè¿‡æ¨¡å¼åŒ¹é…å¾—åˆ°æ•°æ®ï¼›è€Œ<strong>æ™®é€šå¯¹è±¡</strong>å¯ä»¥é€šè¿‡ <code>.</code>å· ç›´æ¥è®¿é—®å¯¹è±¡ä¸­æˆå‘˜å˜é‡ã€‚</p>
</li>
<li>
<p>åŒç†ï¼Œ<strong>Row</strong>ä¸­æ•°æ®æ²¡ç±»å‹ï¼Œæ²¡åŠæ³•åœ¨ç¼–è¯‘çš„æ—¶å€™æ£€æŸ¥æ˜¯å¦æœ‰ç±»å‹é”™è¯¯ï¼ˆå¼±ç±»å‹çš„æ¦‚å¿µï¼‰ï¼›ç›¸å<strong>æ™®é€šå¯¹è±¡</strong>å¯ä»¥ï¼ˆå¼ºç±»å‹ï¼‰ã€‚</p>
</li>
</ul>
<h1>RDDã€DataFrameå’ŒDataSetè½¬æ¢</h1>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/dataframe2dataset.png" alt></p>
<p><strong>æ³¨æ„</strong></p>
<ul>
<li>
<p>åŸå§‹RDDç±»å‹æ˜¯ <code>RDD[(Int, String)]</code></p>
</li>
<li>
<p>DataFrame -&gt; RDD æ—¶ï¼Œå˜æˆäº†<code>RDD[Row]</code></p>
</li>
<li>
<p>DataSet -&gt; RDDæ—¶ï¼Œå˜æˆäº†<code>RDD[User]</code></p>
</li>
</ul>
<h1>ä½¿ç”¨</h1>
<h2 id="SQLé£æ ¼ï¼ˆä¸»è¦ï¼‰"><a class="header-anchor" href="#SQLé£æ ¼ï¼ˆä¸»è¦ï¼‰">Â¶</a>SQLé£æ ¼ï¼ˆä¸»è¦ï¼‰</h2>
<ul>
<li>åˆ›å»ºä¸€ä¸ªDataFrame</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">val df: DataFrame = spark.read.json(<span class="string">"people.json"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯¹DataFrameåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨(ä¸´æ—¶è¡¨æ˜¯SessionèŒƒå›´å†…æœ‰æ•ˆï¼Œä¹Ÿå¯ä»¥åˆ›å»ºå…¨å±€çš„)</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">df.createOrReplaceTempView(<span class="string">"people"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡SQLè¯­å¥å®ç°å¯¹è¡¨çš„æ“ä½œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spark.sql(<span class="string">"SELECT * FROM people"</span>).show()</span><br></pre></td></tr></table></figure>
<h2 id="DSLé£æ ¼ï¼ˆæ¬¡è¦ï¼‰"><a class="header-anchor" href="#DSLé£æ ¼ï¼ˆæ¬¡è¦ï¼‰">Â¶</a>DSLé£æ ¼ï¼ˆæ¬¡è¦ï¼‰</h2>
<ul>
<li>åˆ›å»ºä¸€ä¸ªDataFrame</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">val df: DataFrame = spark.read.json(<span class="string">"people.json"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨DataFrameçš„api</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">df.select(<span class="string">"name"</span>).show()</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">df.select($<span class="string">"name"</span>, $<span class="string">"age"</span> + <span class="number">1</span>).show()</span><br></pre></td></tr></table></figure>
<h1>å°ç»“</h1>
<p><code>DataFrame</code>å’Œ<code>Dataset</code>éƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬æ‰§è¡Œsqlçš„ï¼Œå› æ­¤å½“æˆ‘ä»¬æŠŠæ•°æ®è½¬åŒ–æˆå®ƒä»¬ä¹‹åï¼Œå†™å¥½sqlé€»è¾‘ï¼Œå‰©ä¸‹çš„å°±äº¤ç»™å’±ä»¬sparkå§ï¼</p>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
        <tag>sparksql</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkåŸºç¡€-çª„ã€å®½ä¾èµ–å’Œä»»åŠ¡åˆ’åˆ†</title>
    <url>/2019/09/09/spark%E5%9F%BA%E7%A1%80-%E7%AA%84%E3%80%81%E5%AE%BD%E4%BE%9D%E8%B5%96%E5%92%8C%E4%BB%BB%E5%8A%A1%E5%88%92%E5%88%86/</url>
    <content><![CDATA[<p>ä»‹ç»äº†åœ¨sparkä¸­çª„ã€å®½ä¾èµ–çš„åˆ’åˆ†ä»¥åŠä»»åŠ¡åˆ’åˆ†</p>
<a id="more"></a>
<h1>çª„ä¾èµ–å’Œå®½ä¾èµ–</h1>
<h2 id="çª„ä¾èµ–"><a class="header-anchor" href="#çª„ä¾èµ–">Â¶</a>çª„ä¾èµ–</h2>
<ul>
<li>æ¯ä¸€ä¸ªçˆ¶RDDçš„Partitionæœ€å¤šè¢«å­RDDçš„ä¸€ä¸ªPartitionä½¿ç”¨</li>
<li>ç‹¬ç”Ÿå­å¥³ï¼šä¸€ä¸ªçˆ¹RDDåªæœ‰ä¸€ä¸ªå­</li>
</ul>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/dependence/Narrow-dependence.png" alt></p>
<h2 id="å®½ä¾èµ–"><a class="header-anchor" href="#å®½ä¾èµ–">Â¶</a>å®½ä¾èµ–</h2>
<ul>
<li>æ¯ä¸€ä¸ªçˆ¶RDDçš„Partitionè¢«å­RDDçš„å¤šä¸ªPartitionä½¿ç”¨ï¼Œä¼´éšshuffle</li>
<li>è¶…ç”Ÿï¼šä¸€ä¸ªçˆ¹RDDæœ‰å¤šä¸ªå­</li>
</ul>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/dependence/Wide.jpg" alt></p>
<h2 id="ä¸ªäººç†è§£"><a class="header-anchor" href="#ä¸ªäººç†è§£">Â¶</a>ä¸ªäººç†è§£</h2>
<p>ç”±äºè¿˜æ²¡å­¦shuffleï¼Œæ‰€ä»¥ä»å®è§‚ç®€å•æ€è€ƒã€‚å­¦ä¸€ä¸ªä¸œè¥¿ä¸èƒ½æ­»è®°ç¡¬èƒŒï¼Œæœ€å¥½çš„ç†è§£å°±æ˜¯ï¼šé—®é—®è‡ªå·±<strong>ä¸ºå•¥è¦åˆ†çª„ä¾èµ–å’Œå®½ä¾èµ–ï¼Ÿ</strong></p>
<p>å…ˆåˆ†æä¾‹å­ï¼š</p>
<ul>
<li>ä¾‹1ï¼šç”¨mapæ—¶ï¼Œä¸€ä¸ªåˆ†åŒºé‡Œçš„æ•°æ®ç»è¿‡å‡½æ•°ï¼Œå½¢æˆæ–°çš„æ•°æ®ï¼Œå¤§å®¶ä½ æä½ çš„æˆ‘ææˆ‘çš„ï¼Œäº’ä¸å¹²æ‰°ã€‚</li>
<li>ä¾‹2ï¼šç”¨åˆå¹¶æ“ä½œæ—¶ï¼Œå¤šä¸ªåˆ†åŒºåˆåˆ°ä¸€ä¸ªåˆ†åŒºï¼ŒåŒæ ·ï¼Œå„èµ°å„çš„ï¼Œé¡¶èµ°è·‘ä¹‹å‰è®¡ç®—ä¸‹æ–°åç§»é‡ï¼ˆè¿™ä¸ªåç§»åˆ«äººæ²¡è·‘å®Œæˆ‘ä¹ŸçŸ¥é“ï¼‰ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯äº’ä¸å¹²æ‰°</li>
<li>ä¾‹3ï¼šç”¨groupbykeyæ—¶ï¼Œè¿™ä¸‹å¯ä¸æ˜¯äº’ä¸å¹²æ‰°äº†ï¼Œå› ä¸ºéœ€è¦æ¯”è¾ƒæ´—ç‰Œï¼Œä½ å¾—ç­‰ä½ çš„ä¼™ä¼´ï¼ˆå¦ä¸€ä¸ªåˆ†åŒºï¼‰ç®—å®Œäº†ï¼Œæ‰èƒ½æ‰§è¡Œgroupbykeyã€‚</li>
</ul>
<p>å› æ­¤æˆ‘è§‰å¾—è¿™å°±æ˜¯æ‰€è°“çš„å®½ä¾èµ–ï¼š<strong>åˆ«çš„åˆ†åŒºæ²¡è·‘å®Œï¼Œä¸èƒ½æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œéœ€è¦ç­‰å¾…</strong>ã€‚åªæœ‰å½“å¤§å®¶éƒ½å‡†å¤‡å¥½äº†ï¼Œæ‰å¯ä»¥ä¸€èµ·è¿›è¡Œæ´—ç‰Œã€‚ç”±äºåˆ†åŒºé‡Œçš„æ•°æ®é¡ºåºä¹‹å‰æ˜¯ä¹±çš„ï¼Œæ‰€ä»¥shuffleæ—¶ä¸€èˆ¬éƒ½ä¼šæ‹†å¼€ï¼Œç„¶åé€åˆ°ä¸åŒçš„å­åˆ†åŒºã€‚è¿™å°±é€ æˆäº†ç»“æœâ€”â€”è¶…ç”Ÿã€‚è¯´å®è¯ï¼Œå¦‚æœä½ ä»ç»“æœå‡ºå‘å»æ€è€ƒï¼Œæ˜¯ä¸å¥½åŒºåˆ†ä¾‹2ä¾‹3çš„ã€‚</p>
<p>æ¥ç€ï¼Œåˆ’åˆ†çª„ä¾èµ–ï¼ˆ<strong>åˆ«çš„åˆ†åŒºæ²¡è·‘å®Œï¼Œå¯ä»¥æ‰§è¡Œä¸‹ä¸€æ­¥</strong>ï¼‰å’Œå®½ä¾èµ–ï¼ˆ<strong>åˆ«çš„åˆ†åŒºæ²¡è·‘å®Œï¼Œä¸å¯ä»¥æ‰§è¡Œä¸‹ä¸€æ­¥</strong>ï¼‰çš„åŸå› æ˜¾è€Œæ˜“è§ã€‚æˆ‘ä»¬å¯ä»¥æŠŠçª„ä¾èµ–çš„æ­¥éª¤åˆ’åˆ†åˆ°ä¸€èµ·ï¼Œå®ƒå¯ä»¥ä¸€è·¯æ‰§è¡Œï¼Œä¸éœ€è¦ç­‰å¾…ï¼Œç›´åˆ°å®½ä¾èµ–æ­¥éª¤å¡ä½ï¼ˆå¿…é¡»ç­‰å…¶å®ƒåˆ†åŒºæ‰§è¡Œå®Œï¼‰ã€‚è¿™ä¸ªä»çª„ä¾èµ–ä¸€è·¯æ‰§è¡Œåˆ°å®½ä¾èµ–çš„è¿‡ç¨‹ï¼Œå¯ä»¥åœ¨é€»è¾‘ä¸Šåˆ’åˆ†æˆä¸€ä¸ª<strong>stage</strong>ã€‚è¿™ä¹Ÿå°±æ˜¯å¸¸è¯´çš„<strong>å®½ä¾èµ–æ˜¯åˆ’åˆ†Stageçš„ä¾æ®</strong>ã€‚</p>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/dependence/stage.jpg" alt></p>
<h1>ä»»åŠ¡åˆ’åˆ†</h1>
<p>RDDä»»åŠ¡çš„åˆ‡åˆ†ï¼Œåˆ†ä¸ºï¼šApplicationã€Jobã€Stageå’ŒTaskï¼Œè€Œä¸”æ¯ä¸€å±‚éƒ½æ˜¯<strong>1å¯¹n</strong>çš„å…³ç³»</p>
<h2 id="4ä¸ªåè¯"><a class="header-anchor" href="#4ä¸ªåè¯">Â¶</a>4ä¸ªåè¯</h2>
<ul>
<li><strong>Application</strong>ï¼šåˆå§‹åŒ–ä¸€ä¸ªSparkContextå³ç”Ÿæˆä¸€ä¸ªApplication</li>
<li><strong>Job</strong>ï¼šä¸€ä¸ªActionç®—å­å°±ä¼šç”Ÿæˆä¸€ä¸ªJob</li>
<li><strong>Stage</strong>ï¼šæ ¹æ®RDDä¹‹é—´çš„ä¾èµ–å…³ç³»çš„ä¸åŒå°†Jobåˆ’åˆ†æˆä¸åŒçš„Stageï¼Œé‡åˆ°ä¸€ä¸ªå®½ä¾èµ–åˆ™åˆ’åˆ†ä¸€ä¸ªStageã€‚</li>
<li><strong>Task</strong>ï¼šStageæ˜¯ä¸€ä¸ªTaskSetï¼Œå°†Stageåˆ’åˆ†çš„ç»“æœå‘é€åˆ°ä¸åŒçš„Executoræ‰§è¡Œå³ä¸ºä¸€ä¸ªTaskã€‚</li>
</ul>
<h2 id="ä¸ªäººç†è§£-v2"><a class="header-anchor" href="#ä¸ªäººç†è§£-v2">Â¶</a>ä¸ªäººç†è§£</h2>
<p>åŒæ ·æ€è€ƒä¸ºå•¥è¦åˆ’åˆ†è¿™ä¹ˆå¤šä¸œè¥¿ï¼Ÿ</p>
<ul>
<li><strong>Application</strong></li>
</ul>
<p>ä¸€ä¸ªsparkä¸æ­¢è·‘ä¸€ä¸ªç¨‹åºå§ï¼Œæ‰€ä»¥ä¸€ä¸ªç¨‹åºä¸€ä¸ª Applicationç†æ‰€å½“ç„¶ï¼Œè¿›è€Œç”Ÿæˆä¸€ä¸ªAppMasterç®¡ç†å®ƒã€‚</p>
<ul>
<li><strong>Job</strong></li>
</ul>
<p>ä¸€ä¸ªç¨‹åºæœ‰è®¸å¤šè½¬æ¢ç®—å­å’Œè¡ŒåŠ¨ç®—å­ã€‚åªæœ‰æ‰§è¡Œåˆ°<strong>è¡ŒåŠ¨æ“ä½œæ‰çœŸæ­£æ”¹å˜æ•°æ®</strong>ï¼Œæ‰€ä»¥æŠŠæˆªæ­¢åˆ°è¡ŒåŠ¨ç®—å­çš„ç®—å­åˆ’ä¸€ä¸ªjobåˆæƒ…åˆç†å§ã€‚è€Œä¸”æˆ‘ä»¬ä»æºç ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œä¸€ä¸ªè¡ŒåŠ¨æ“ä½œï¼Œå°±ä¼šæ‰§è¡Œ<code>sc.runJob(...)</code></p>
<ul>
<li><strong>Stage</strong></li>
</ul>
<p>åœ¨ä¸€ä¸ªJobä¸­ï¼Œæœ‰çš„å¯ä¸€è·¯æ‰§è¡Œåˆ°å®½ä¾èµ–çš„ï¼Œä¸éœ€è¦ç­‰å¾…ï¼ŒæŒ‰è¿™ä¸ªåˆ’åˆ†ä¸ºä¸€ä¸ªStageã€‚è¿™ä¸ªä¸ç†è§£çš„å†çœ‹çœ‹ä¸Šé¢çš„åˆ†æã€‚</p>
<ul>
<li><strong>Task</strong></li>
</ul>
<p>åœ¨ä¸€ä¸ªStageä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿæœ€åä¸€ç»„åˆ†åŒºï¼Œä¹Ÿå°±æ˜¯shufferå‰çš„ï¼Œç”±äºåˆ°è¿™é‡Œéƒ½æ˜¯å¯ä»¥ä¸€è·¯æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æŒ‰æœ€åä¸€ç»„åˆ†åŒºçš„ä¸ªæ•°ï¼Œä¸€ä¸ªåˆ†åŒºåˆ’ä¸€ä¸ªTaskã€‚æ­¤æ—¶éƒ½åˆ’åˆ°åˆ†åŒºäº†ï¼Œè‡ªç„¶ä¸ç”¨åˆ’åˆ†äº†ã€‚</p>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>sparkåŸºç¡€-Yarnæµç¨‹è§£æ</title>
    <url>/2019/09/02/spark%E5%9F%BA%E7%A1%80-Yarn%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>ä»‹ç»äº†åœ¨sparkä¸­Yarnçš„å·¥ä½œæµç¨‹å’Œä¸€äº›æ€»ç»“</p>
<a id="more"></a>
<h1>æµç¨‹</h1>
<p><img src="https://zouxxyy.s3-us-west-2.amazonaws.com/blog/spark/spark-yarn.png" alt="YARN-Clusteræµç¨‹å›¾" title="YARN-Clusteræµç¨‹å›¾"></p>
<p>ä¸»è¦æµç¨‹å’Œ<a href="https://zouxxyy.github.io/2019/08/31/hadoop-Yarn%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/#more" target="_blank" rel="noopener">Yarnçš„æµç¨‹</a>ä¸€æ ·ï¼Œä¸åŒçš„å°±æ˜¯ç´«è‰²éƒ¨åˆ†ã€‚è¿™é‡Œé‡‡ç”¨çš„æ˜¯sparkçš„<strong>yarn-cluster</strong>æ¨¡å¼ï¼Œdriveråœ¨APPMasterä¸­ã€‚</p>
<h1>ç»†èŠ‚</h1>
<h2 id="è§£è€¦æ€æƒ³"><a class="header-anchor" href="#è§£è€¦æ€æƒ³">Â¶</a>è§£è€¦æ€æƒ³</h2>
<ul>
<li>
<p>ResourceManagerç®¡ç†èµ„æºè°ƒåº¦ï¼Œä¸NodeManagerç›´æ¥è”ç³»ï¼›Driverè´Ÿè´£æ‰§è¡Œè®¡ç®—ï¼Œä¸Executorä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸ªTaskç›´æ¥è”ç³»ã€‚</p>
</li>
<li>
<p><strong>è®¡ç®—å’Œèµ„æºè°ƒåº¦è§£è€¦</strong>ï¼šResourceManagerå’ŒDriveré ä¸­é—´ä»¶AppMasterè”ç³»èµ·æ¥ï¼›Executorå’ŒNodeManageré ä¸­é—´ä»¶Containerè”ç³»èµ·æ¥</p>
</li>
<li>
<p>æ­¤æ—¶è®¡ç®—æ¡†æ¶æ˜¯<strong>å¯æ’æ‹”</strong>çš„ï¼Œå¦‚ï¼šsparkè®¡ç®—æ¡†æ¶ï¼ˆç´«è‰²éƒ¨åˆ†ï¼‰ä»£æ›¿mapreduceã€‚</p>
</li>
</ul>
<h2 id="Clientå’ŒClusteræ¨¡å¼"><a class="header-anchor" href="#Clientå’ŒClusteræ¨¡å¼">Â¶</a>Clientå’ŒClusteræ¨¡å¼</h2>
<p>sparkä¸Šyarnæœ‰ä¸¤ç§ç®¡ç†æ¨¡å¼ï¼Œ<strong>YARN-Client</strong>å’Œ<strong>YARN-Cluster</strong>ã€‚</p>
<p>ä¸»è¦åŒºåˆ«æ˜¯ï¼šSparkContextåˆå§‹åŒ–ä½ç½®ä¸åŒï¼Œä¹Ÿå°±æ˜¯äº†Driveræ‰€åœ¨ä½ç½®çš„ä¸åŒã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">client</th>
<th style="text-align:center">master</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">driveråœ¨Clientä¸Š</td>
<td style="text-align:center">driveråœ¨AppMasterä¸Š</td>
</tr>
<tr>
<td style="text-align:center">æ—¥å¿—å¯ä»¥ç›´æ¥åœ¨Clientä¸Šçœ‹åˆ°</td>
<td style="text-align:center">æ—¥å¿—åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Š</td>
</tr>
<tr>
<td style="text-align:center">Clientè¿æ¥ä¸èƒ½æ–­å¼€</td>
<td style="text-align:center">Clientè¿æ¥å¯ä»¥æ–­å¼€</td>
</tr>
<tr>
<td style="text-align:center">é€‚åˆäº¤äº’å’Œè°ƒè¯•</td>
<td style="text-align:center">é€‚åˆç”Ÿäº§ç¯å¢ƒ</td>
</tr>
</tbody>
</table>
<h1>å…¶å®ƒç®¡ç†æ¨¡å¼</h1>
<h2 id="localæ¨¡å¼"><a class="header-anchor" href="#localæ¨¡å¼">Â¶</a>localæ¨¡å¼</h2>
<p>å•æœºæ¨¡å¼ <code>--master local[*] </code></p>
<h2 id="Standaloneæ¨¡å¼"><a class="header-anchor" href="#Standaloneæ¨¡å¼">Â¶</a>Standaloneæ¨¡å¼</h2>
<p>ä¸ç”¨Yarnï¼Œç”¨Sparkè‡ªå¸¦çš„Standaloneèµ„æºç®¡ç†å™¨ï¼Œå®ƒæŠŠèŠ‚ç‚¹åˆ†æˆ<strong>Master</strong>å’Œ<strong>Worker</strong>ã€‚ç±»ä¼¼RMå’ŒNMï¼Œä½†å®ƒæ²¡æœ‰AppMasterã€‚ä¹Ÿåˆ†ä¸ºClientæ¨¡å¼å’Œclusteræ¨¡å¼ã€‚</p>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>yarn</tag>
        <tag>spark</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop-Yarnæµç¨‹è§£æ</title>
    <url>/2019/08/31/hadoop-Yarn%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>ä»‹ç»äº†Yarnçš„å·¥ä½œæµç¨‹å’Œä¸€äº›æ€»ç»“</p>
<a id="more"></a>
<h1>Yarnè¿è¡Œæœºåˆ¶æµç¨‹å›¾</h1>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/Yarn.png?raw=true" alt="Yarnè¿è¡Œæœºåˆ¶æµç¨‹å›¾" title="Yarnè¿è¡Œæœºåˆ¶æµç¨‹å›¾"></p>
<h1>å…·ä½“æ­¥éª¤</h1>
<p>ï¼ˆ1ï¼‰ä½œä¸šæäº¤</p>
<ol start="0">
<li>Clientè°ƒç”¨<code>job.waitForCompletion</code>æ–¹æ³•ï¼Œå‘æ•´ä¸ªé›†ç¾¤æäº¤MapReduceä½œä¸šã€‚</li>
<li>Clientå‘RMç”³è¯·ä¸€ä¸ªä½œä¸šidã€‚</li>
<li>RMç»™Clientè¿”å›è¯¥jobèµ„æºçš„æäº¤è·¯å¾„(<code>hdfs://.../.staging/</code>)å’Œä½œä¸š<code>application_id</code>ã€‚</li>
<li>Clientåœ¨è¯¥è·¯å¾„æäº¤jaråŒ…ã€åˆ‡ç‰‡ä¿¡æ¯å’Œé…ç½®æ–‡ä»¶ã€‚</li>
<li>Clientæäº¤å®Œèµ„æºåï¼Œå‘RMç”³è¯·è¿è¡ŒMrAppMasterã€‚</li>
</ol>
<p>ï¼ˆ2ï¼‰ä½œä¸šåˆå§‹åŒ–</p>
<ol start="5">
<li>å½“RMæ”¶åˆ°Clientçš„è¯·æ±‚åï¼Œå°†è¯¥jobæ·»åŠ åˆ°èµ„æºè°ƒåº¦å™¨ä¸­ï¼Œå°†jobåˆå§‹åŒ–æˆtaskã€‚</li>
<li>æŸä¸€ä¸ªç©ºé—²çš„NMé¢†å–åˆ°è¯¥Jobã€‚</li>
<li>åœ¨è¯¥NMä¸­åˆ›å»ºContainerï¼Œå¹¶äº§ç”ŸMRAppmaster(ä¸€ä¸ªjobåˆ›å»ºä¸€ä¸ª)ï¼Œå®ƒç®¡ç†è¯¥jobã€‚</li>
<li>ä¸‹è½½ä¹‹å‰Clientæäº¤çš„èµ„æºåˆ°æœ¬åœ°ã€‚</li>
</ol>
<p>ï¼ˆ3ï¼‰ä»»åŠ¡åˆ†é…</p>
<ol start="9">
<li>MRAppMasterå‘RMç”³è¯·è¿è¡Œå¤šä¸ªMapTaskä»»åŠ¡èµ„æºã€‚</li>
<li>RMå°†è¿è¡ŒMapTaskä»»åŠ¡åˆ†é…ç»™å¦å¤–ä¸¤ä¸ªNodeManagerï¼Œå¦å¤–ä¸¤ä¸ªNodeManageråˆ†åˆ«é¢†å–ä»»åŠ¡å¹¶åˆ›å»ºå®¹å™¨ã€‚</li>
</ol>
<p>ï¼ˆ4ï¼‰ä»»åŠ¡æ‰§è¡Œ</p>
<ol start="11">
<li>MRå‘ä¸¤ä¸ªæ¥æ”¶åˆ°ä»»åŠ¡çš„NodeManagerå‘é€ç¨‹åºå¯åŠ¨è„šæœ¬ï¼Œè¿™ä¸¤ä¸ªNodeManageråˆ†åˆ«å¯åŠ¨MapTaskï¼ŒMapTaskå¯¹æ•°æ®åˆ†åŒºæ’åºã€‚</li>
<li>MrAppMasterç­‰å¾…æ‰€æœ‰MapTaskè¿è¡Œå®Œæ¯•åï¼Œå‘RMç”³è¯·å®¹å™¨ï¼Œè¿è¡ŒReduceTaskã€‚</li>
<li>ReduceTaskå‘MapTaskè·å–ç›¸åº”åˆ†åŒºçš„æ•°æ®ã€‚</li>
<li>ç¨‹åºè¿è¡Œå®Œæ¯•åï¼ŒMRä¼šå‘RMç”³è¯·æ³¨é”€è‡ªå·±ã€‚</li>
</ol>
<h1>ä¸€äº›ç»†èŠ‚</h1>
<h2 id="4å¤§ç»„ä»¶"><a class="header-anchor" href="#4å¤§ç»„ä»¶">Â¶</a>4å¤§ç»„ä»¶</h2>
<ul>
<li><strong>ResourceManager</strong>ï¼šæ€»çš„è€å¤§ï¼šå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç›‘æ§NodeManagerï¼Œå¯åŠ¨æˆ–ç›‘æ§ApplicationMasterï¼Œèµ„æºçš„åˆ†é…ä¸è°ƒåº¦</li>
<li><strong>NodeManager</strong>ï¼šå•ä¸ªèŠ‚ç‚¹çš„è€å¤§ï¼šç®¡ç†å•ä¸ªèŠ‚ç‚¹çš„èµ„æºï¼Œå¤„ç†æ¥è‡ªResourceManagerã€ApplicationMasterçš„å‘½ä»¤</li>
<li><strong>ApplicationMaster</strong>ï¼šå•ä¸ªjobçš„è€å¤§ï¼šè´Ÿè´£æ•°æ®åˆ‡åˆ†ï¼Œä¸ºåº”ç”¨ç¨‹åºç”³è¯·èµ„æºå¹¶åˆ†é…å†…éƒ¨çš„ä»»åŠ¡ï¼Œä»»åŠ¡çš„ç›‘æ§ä¸å®¹é”™</li>
<li><strong>Container</strong>ï¼šèµ„æºæŠ½è±¡ï¼šå¦‚å†…å­˜ã€cpuã€ç£ç›˜ã€ç½‘ç»œç­‰</li>
</ul>
<h2 id="3ç§èµ„æºè°ƒåº¦å™¨"><a class="header-anchor" href="#3ç§èµ„æºè°ƒåº¦å™¨">Â¶</a>3ç§èµ„æºè°ƒåº¦å™¨</h2>
<ul>
<li><strong>FIFO</strong>ï¼šå…ˆè¿›å…ˆå‡º</li>
<li><strong>Capacity Scheduler</strong>ï¼šå¤šFIFOé˜Ÿåˆ—ï¼Œä¼šå¯¹åŒä¸€ç”¨æˆ·æäº¤èµ„æºè¿›è¡Œé™å®šï¼Œä¼šæŠŠä»»åŠ¡åˆ†é…ç»™æ›´é—²çš„é˜Ÿåˆ—ã€‚</li>
<li><strong>Fair Scheduler</strong>ï¼šå¤šé˜Ÿåˆ—ï¼ŒæŒ‰ç¼ºé¢æ’åºï¼Œç¼ºé¢å¤§è€…ä¼˜å…ˆæ‰§è¡Œ</li>
</ul>
<h2 id="ä»»åŠ¡æ¨æµ‹æ‰§è¡Œæœºåˆ¶"><a class="header-anchor" href="#ä»»åŠ¡æ¨æµ‹æ‰§è¡Œæœºåˆ¶">Â¶</a>ä»»åŠ¡æ¨æµ‹æ‰§è¡Œæœºåˆ¶</h2>
<ul>
<li>é—®é¢˜ï¼šç³»ç»Ÿä¸­æœ‰99%çš„Mapä»»åŠ¡éƒ½å®Œæˆäº†ï¼Œåªæœ‰å°‘æ•°å‡ ä¸ªMapè€æ˜¯è¿›åº¦å¾ˆæ…¢ï¼Œå®Œä¸æˆã€‚</li>
<li>åŠæ³•ï¼šä¸ºæ‹–åè…¿ä»»åŠ¡å¯åŠ¨ä¸€ä¸ªå¤‡ä»½ä»»åŠ¡ï¼ŒåŒæ—¶è¿è¡Œã€‚è°å…ˆè¿è¡Œå®Œï¼Œåˆ™é‡‡ç”¨è°çš„ç»“æœã€‚</li>
<li>å‰æï¼šæ¯ä¸ªTaskåªèƒ½æœ‰ä¸€ä¸ªå¤‡ä»½ä»»åŠ¡ï¼Œå½“å‰Jobå·²å®Œæˆçš„Taskå¿…é¡»ä¸å°äº0.05ï¼ˆ5%ï¼‰ã€‚</li>
<li>ä¸é€‚ç”¨ï¼šä»»åŠ¡é—´å­˜åœ¨ä¸¥é‡çš„è´Ÿè½½å€¾æ–œï¼›ç‰¹æ®Šä»»åŠ¡ï¼Œæ¯”å¦‚ä»»åŠ¡å‘æ•°æ®åº“ä¸­å†™æ•°æ®ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>yarn</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop-HDFSæµç¨‹è§£æ</title>
    <url>/2019/08/31/hadoop-HDFS%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>ä»‹ç»äº†HDFSè¯»å†™æ•°æ®ã€NameNodeå’ŒSecondaryNameNodeã€DataNodeå’ŒNameNodeçš„äº¤äº’</p>
<a id="more"></a>
<h1>HDFSå†™æ•°æ®</h1>
<h2 id="æµç¨‹å›¾"><a class="header-anchor" href="#æµç¨‹å›¾">Â¶</a>æµç¨‹å›¾</h2>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/readHDFS.png?raw=true" alt="HDFSå†™æ•°æ®" title="HDFSå†™æ•°æ®"></p>
<h2 id="å…·ä½“æ­¥éª¤"><a class="header-anchor" href="#å…·ä½“æ­¥éª¤">Â¶</a>å…·ä½“æ­¥éª¤</h2>
<ol>
<li>å®¢æˆ·ç«¯è°ƒç”¨DSæ¨¡å—å‘NameNodeè¯·æ±‚ä¸Šä¼ æ–‡ä»¶ã€‚</li>
<li>NameNodeä¼šæ£€æŸ¥ç›®æ ‡æ–‡ä»¶å’Œçˆ¶ç›®å½•æ˜¯å¦å·²å­˜åœ¨ï¼Œå†è¿”å›æ˜¯å¦å¯ä»¥ä¸Šä¼ </li>
<li>å‡è®¾æ–‡ä»¶ä¸º200Mï¼Œå®¢æˆ·ç«¯è¯·æ±‚ä¸Šä¼ ç¬¬ä¸€ä¸ª Block ï¼Œå¸Œæœ›å¾—åˆ°DataNodeæœåŠ¡å™¨ä½ç½®ã€‚</li>
<li>NameNodeè¿”å›3ä¸ªDataNodeèŠ‚ç‚¹ï¼Œåˆ†åˆ«ä¸ºdn1ã€dn2ã€dn3ï¼Œç”¨å®ƒä»¬å­˜å‚¨æ•°æ®ã€‚</li>
<li>å®¢æˆ·ç«¯é€šè¿‡FSDataOutputStreamæ¨¡å—è¯·æ±‚dn1å»ºç«‹ä¸Šä¼ æ•°æ®é€šé“ï¼Œdn1æ”¶åˆ°è¯·æ±‚ä¼šç»§ç»­è¯·æ±‚dn2ï¼Œç„¶ådn2è¯·æ±‚dn3ï¼Œç›´åˆ°å°†è¿™ä¸ªé€šä¿¡ç®¡é“å»ºç«‹å®Œæˆã€‚</li>
<li>dn3ã€dn2ã€dn1é€çº§åº”ç­”å®¢æˆ·ç«¯ã€‚</li>
<li>å®¢æˆ·ç«¯å¼€å§‹å¾€dn1ä¸Šä¼ ç¬¬ä¸€ä¸ªBlockï¼ˆå…ˆä»ç£ç›˜è¯»å–æ•°æ®æ”¾åˆ°ä¸€ä¸ªæœ¬åœ°å†…å­˜ç¼“å­˜ï¼‰ï¼Œä»¥Packetä¸ºå•ä½ï¼Œdn1æ”¶åˆ°ä¸€ä¸ªPacketå°±ä¼šä¼ ç»™dn2ï¼Œdn2ä¼ ç»™dn3ï¼›dn1æ¯ä¼ ä¸€ä¸ªpacketä¼šæ”¾å…¥ä¸€ä¸ªåº”ç­”é˜Ÿåˆ—ç­‰å¾…åº”ç­”ã€‚ï¼ˆç±»ä¼¼é˜Ÿåˆ—ï¼Œä»¥Packetä¸ºå•ä½ï¼‰</li>
<li>å½“ä¸€ä¸ªBlockï¼ˆ0-128Mï¼‰ä¼ è¾“å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚NameNodeä¸Šä¼ ç¬¬äºŒä¸ªBlockçš„æœåŠ¡å™¨ã€‚ï¼ˆé‡å¤æ‰§è¡Œ3-7æ­¥ï¼‰ã€‚</li>
<li>å‘NameNodeæ±‡æŠ¥ä¸Šä¼ å®Œæ¯•ã€‚</li>
</ol>
<h2 id="æ³¨æ„äº‹é¡¹"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹">Â¶</a>æ³¨æ„äº‹é¡¹</h2>
<ul>
<li>DataNodeä½ç½®é€‰æ‹©ï¼Œä»¥é»˜è®¤3å‰¯æœ¬ä¸ºä¾‹ï¼šç¬¬ä¸€ä¸ªå‰¯æœ¬æ˜¯æœ€è¿‘çš„ä¸€èˆ¬æ˜¯å®ƒè‡ªå·±ï¼›ç¬¬äºŒä¸ªå‰¯æœ¬é€‰æ‹©åŒä¸€æœºæ¶ï¼ˆåŒä¸€è·¯ç”±ï¼‰çš„ä¸åŒèŠ‚ç‚¹ï¼›ç¬¬ä¸‰ä¸ªå‰¯æœ¬æ˜¯å¦ä¸€æœºæ¶çš„éšæœºèŠ‚ç‚¹ã€‚</li>
<li>æ•°æ®ä¼ é€’ä»¥åŒ…ä¸ºå•ä½ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°ä¸€ä¸ªåŒ…ï¼Œå°±æŠŠåŒ…ä¼ é€’ç»™ä¸‹ä¸€ä¸ªDataNodeã€‚å¹¶ä¸æ˜¯ç­‰æ•°æ®ä¼ å®Œï¼Œå†ä¼ é€’ã€‚</li>
</ul>
<h1>HDFSè¯»æ•°æ®</h1>
<h2 id="æµç¨‹å›¾-v2"><a class="header-anchor" href="#æµç¨‹å›¾-v2">Â¶</a>æµç¨‹å›¾</h2>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/writeHDFS.png?raw=true" alt="HDFSè¯»æ•°æ®" title="HDFSè¯»æ•°æ®"></p>
<h2 id="å…·ä½“æ­¥éª¤-v2"><a class="header-anchor" href="#å…·ä½“æ­¥éª¤-v2">Â¶</a>å…·ä½“æ­¥éª¤</h2>
<ol>
<li>å®¢æˆ·ç«¯è°ƒç”¨DSæ¨¡å—å‘NameNodeè¯·æ±‚ä¸‹è½½æ–‡ä»¶ã€‚</li>
<li>NameNodeä¼šæ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå†é€šè¿‡æŸ¥è¯¢å…ƒæ•°æ®ï¼Œè¿”å›æ–‡ä»¶å—æ‰€åœ¨çš„DataNodeåœ°å€ã€‚</li>
<li>å®¢æˆ·ç«¯é€šè¿‡FSDataInputStreamæ¨¡å—å‘dn1ï¼ˆå°±è¿‘æŒ‘é€‰ï¼‰è¯·æ±‚è¯»å– Block1ã€‚</li>
<li>DataNodeå¼€å§‹ä¼ è¾“æ•°æ®ç»™å®¢æˆ·ç«¯ï¼ˆä»ç£ç›˜é‡Œé¢è¯»å–æ•°æ®è¾“å…¥æµï¼Œä»¥Packetä¸ºå•ä½æ¥åšæ ¡éªŒï¼‰ã€‚å®¢æˆ·ç«¯ä»¥Packetä¸ºå•ä½æ¥æ”¶ï¼Œå…ˆåœ¨æœ¬åœ°ç¼“å­˜ï¼Œç„¶åå†™å…¥ç›®æ ‡æ–‡ä»¶ã€‚</li>
<li>å½“ä¸€ä¸ªBlockï¼ˆ0-128Mï¼‰ä¼ è¾“å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚ä¸‹è½½Block2ã€‚ï¼ˆé‡å¤æ‰§è¡Œ2-4æ­¥ï¼‰ã€‚</li>
<li>å‘NameNodeæ±‡æŠ¥ä¸‹è½½å®Œæ¯•ã€‚</li>
</ol>
<h2 id="æ³¨æ„äº‹é¡¹-v2"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹-v2">Â¶</a>æ³¨æ„äº‹é¡¹</h2>
<ul>
<li>å¦‚æœå—çš„ç¬¬ä¸€ä¸ªå‰¯æœ¬è¯·æ±‚å¤±è´¥ï¼Œä¼šå‘ç¬¬äºŒä¸ªå‰¯æœ¬è¯·æ±‚ï¼Œä¾æ¬¡ç±»æ¨ã€‚</li>
</ul>
<h1>NameNodeå’ŒSecondaryNameNode</h1>
<h2 id="æµç¨‹å›¾-v3"><a class="header-anchor" href="#æµç¨‹å›¾-v3">Â¶</a>æµç¨‹å›¾</h2>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/NNand2NN.png?raw=true" alt="NameNodeå’ŒSecondaryNameNode" title="NameNodeå’ŒSecondaryNameNode"></p>
<h2 id="å…·ä½“æ­¥éª¤-v3"><a class="header-anchor" href="#å…·ä½“æ­¥éª¤-v3">Â¶</a>å…·ä½“æ­¥éª¤</h2>
<p>ç¬¬ä¸€é˜¶æ®µï¼šNameNode</p>
<ol>
<li>ç¬¬ä¸€æ¬¡å¯åŠ¨NameNodeï¼ˆæ ¼å¼åŒ–ï¼‰åï¼Œä¼šåˆ›å»ºFsimageï¼ˆé•œåƒæ–‡ä»¶ï¼‰å’ŒEditsï¼ˆç¼–è¾‘æ—¥å¿—ï¼‰æ–‡ä»¶ã€‚ä»¥åå¯åŠ¨ï¼Œä¼šç›´æ¥åŠ è½½é•œåƒæ–‡ä»¶å’Œç¼–è¾‘æ—¥å¿—åˆ°å†…å­˜ï¼Œæ­¤æ—¶ä¼šè¿›è¡Œåˆå¹¶æ“ä½œã€‚</li>
<li>å‡è®¾æ­¤æ—¶å®¢æˆ·ç«¯æå‡ºäº†å¢åˆ æ”¹çš„è¯·æ±‚ã€‚</li>
<li>NameNodeè®°å½•ä¹‹å‰çš„ç¼–è¾‘æ—¥å¿—ï¼ˆedits_nï¼‰ï¼Œæ›´æ–°æ–°æ—¥å¿—åˆ°æ»šåŠ¨æ—¥å¿—ï¼ˆedits_inprogress_nï¼‰ä¸­ã€‚</li>
<li>æ—¥å¿—è®°å½•å®Œæ¯•åï¼ŒNameNodeåœ¨å†…å­˜ä¸­å¯¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹ã€‚</li>
</ol>
<p>ç¬¬äºŒé˜¶æ®µï¼šSecondaryNameNode</p>
<ol>
<li>Secondary NameNodeå‘NameNodeè¯¢é—®æ˜¯å¦éœ€è¦CheckPointã€‚</li>
<li>å¦‚æœéœ€è¦ï¼ŒSecondary NameNodeè¯·æ±‚æ‰§è¡ŒCheckPointã€‚</li>
<li>NameNodeæ»šåŠ¨æ—¥å¿—ã€‚</li>
<li>å°†æ»šåŠ¨å‰çš„ç¼–è¾‘æ—¥å¿—ï¼ˆedits_001ï¼‰å’Œé•œåƒæ–‡ä»¶(fsimage)æ‹·è´åˆ°Secondary NameNodeã€‚</li>
<li>Secondary NameNodeåŠ è½½ç¼–è¾‘æ—¥å¿—å’Œé•œåƒæ–‡ä»¶åˆ°å†…å­˜ï¼Œå¹¶åˆå¹¶ã€‚</li>
<li>åˆå¹¶åï¼Œç”Ÿæˆæ–°çš„é•œåƒæ–‡ä»¶fsimage.chkpointã€‚</li>
<li>æ‹·è´fsimage.chkpointåˆ°NameNodeã€‚</li>
<li>NameNodeå°†fsimage.chkpointé‡æ–°å‘½åæˆfsimageã€‚</li>
</ol>
<h2 id="æ³¨æ„äº‹é¡¹-v3"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹-v3">Â¶</a>æ³¨æ„äº‹é¡¹</h2>
<ul>
<li>Fsimage å’Œ Editsæ–‡ä»¶ï¼Ÿ</li>
</ul>
<p>fsimageæ˜¯NameNodeå†…å­˜ä¸­å…ƒæ•°æ®åºåˆ—åŒ–åå½¢æˆçš„æ–‡ä»¶ã€‚Editsä¸­è®°å½•å®¢æˆ·ç«¯æ›´æ–°å…ƒæ•°æ®ä¿¡æ¯çš„æ¯ä¸€æ­¥æ“ä½œã€‚æ¯æ¬¡æ‰§è¡Œå¢åˆ æ”¹æ—¶ï¼Œå…ˆæ”¹æ—¥å¿—å†æ”¹æ–‡ä»¶ã€‚å¥½å¤„æ˜¯ï¼šå¦‚æœä¿è¯ä¸­é€”ggï¼Œå¯ä»¥ä¿è¯æ“ä½œä¸ä¸¢å¤±ï¼Œä¾¿äºå¤åŸã€‚</p>
<ul>
<li>ä¸ºå•¥è¦Secondary NameNodeï¼Ÿ</li>
</ul>
<p>é¦–å…ˆè¦çŸ¥é“åªæœ‰NameNodeé‡å¯æ—¶ï¼Œedit.logæ‰ä¼šåˆå¹¶åˆ°fsimageæ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥è¿è¡Œæ—¶é—´ä¹…äº†å°±ä¼šæœ‰3ä¸ªé—®é¢˜ï¼šedis.logæ–‡ä»¶ä¼šå˜çš„å¾ˆå¤§ï¼›NameNodeä¸‹æ¬¡é‡å¯ä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼›fsimageæ–‡ä»¶æ–‡ä»¶å¾ˆæ—§ï¼Œå¦‚æœä¸­é€”æŒ‚æ‰å°±å¾ˆç¿æ™ºã€‚</p>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒSecondaryNameNodeè¯ç”Ÿï¼Œæ¯éš”ä¸€å®šæ—¶é—´è¾…åŠ©åˆå¹¶NameNodeçš„edit.logåˆ°fsimageæ–‡ä»¶ä¸­ã€‚ä»ä¸Šè¿°æµç¨‹å›¾å°±å¯ä»¥å‘ç°ï¼Œå®ƒåšçš„å°±æ˜¯è¿™ä¸ªã€‚</p>
<ul>
<li>ä»€ä¹ˆæ—¶å€™æ‰§è¡ŒCheckPointï¼Ÿ</li>
</ul>
<p>ï¼ˆ1ï¼‰ ç”¨æˆ·å®šæ—¶ ï¼ˆ2ï¼‰edit.log æ»¡äº†</p>
<ul>
<li>Secondary NameNodeæ˜¯çƒ­å¤‡ä»½å—ï¼Ÿ</li>
</ul>
<p>ä¸æ˜¯ï¼Œå¯ä»¥å‘ç°Secondary NameNodeåˆå¹¶çš„æ˜¯æ»šåŠ¨å‰çš„edisï¼Œå®ƒæ€»æ˜¯æ¯”NameNodeçš„ç¼–è¾‘æ—¥å¿—å°‘ä¸€ç‚¹ã€‚</p>
<h1>DataNodeå’ŒNameNode</h1>
<h2 id="æµç¨‹å›¾-v4"><a class="header-anchor" href="#æµç¨‹å›¾-v4">Â¶</a>æµç¨‹å›¾</h2>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/DataNode.png?raw=true" alt="NameNodeå’ŒDataNode" title="NameNodeå’ŒDataNode"></p>
<h2 id="å…·ä½“æ­¥éª¤-v4"><a class="header-anchor" href="#å…·ä½“æ­¥éª¤-v4">Â¶</a>å…·ä½“æ­¥éª¤</h2>
<ol>
<li>DataNodeå¯åŠ¨åå‘NameNodeæ³¨å†Œã€‚</li>
<li>NameNodeå‘ŠçŸ¥æ³¨å†ŒæˆåŠŸã€‚</li>
<li>DataNodeå‘¨æœŸæ€§ï¼ˆ1å°æ—¶ï¼‰çš„å‘NameNodeä¸ŠæŠ¥æ‰€æœ‰çš„å—ä¿¡æ¯ã€‚</li>
<li>DataNodeæ¯3ç§’å‘é€ä¸€æ¬¡å¿ƒè·³ï¼Œå¿ƒè·³è¿”å›ç»“æœå¸¦æœ‰NameNodeç»™è¯¥DataNodeçš„å‘½ä»¤å¦‚å¤åˆ¶å—æ•°æ®åˆ°å¦ä¸€å°æœºå™¨ï¼Œæˆ–åˆ é™¤æŸä¸ªæ•°æ®å—ã€‚</li>
<li>è¶…è¿‡10åˆ†é’Ÿæ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ä¸å¯ç”¨ã€‚</li>
</ol>
<h2 id="æ³¨æ„äº‹é¡¹-v4"><a class="header-anchor" href="#æ³¨æ„äº‹é¡¹-v4">Â¶</a>æ³¨æ„äº‹é¡¹</h2>
<ul>
<li>ä¸€ä¸ªæ•°æ®å—åœ¨DataNodeä¸Šä»¥æ–‡ä»¶å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯æ•°æ®æœ¬èº«ï¼Œä¸€ä¸ªæ˜¯å…ƒæ•°æ®åŒ…æ‹¬æ•°æ®å—çš„é•¿åº¦ã€æ ¡éªŒå’Œ ä»¥åŠæ—¶é—´æˆ³ã€‚</li>
<li>èŠ‚ç‚¹å¢åŠ ï¼šæ–°èŠ‚ç‚¹é…ç½®å¥½åï¼Œè‡ªåŠ¨å‘NameNodeæ³¨å†Œçš„ã€‚</li>
<li>èŠ‚ç‚¹é€€å½¹ï¼šNameNodeå¯ä»¥é€šè¿‡ç™½åå•æŒ‡å®šéœ€è¦çš„èŠ‚ç‚¹ï¼›é€šè¿‡é»‘åå•æŒ‡å®šä¸è¦çš„èŠ‚ç‚¹ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>HDFS</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop-MapReduceæµç¨‹è§£æ</title>
    <url>/2019/08/30/hadoop-MapReduce%E6%B5%81%E7%A8%8B%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<p>ä»‹ç»äº†MapReduceçš„è¯¦ç»†æµç¨‹å’Œä¸€äº›æ€»ç»“</p>
<a id="more"></a>
<h1>æµç¨‹å›¾</h1>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/MapTask.png?raw=true" alt="MapTaskæµç¨‹å›¾" title="MapTaskæµç¨‹å›¾"></p>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/ReduceTask.png?raw=true" alt="ReduceTaskæµç¨‹å›¾" title="ReduceTaskæµç¨‹å›¾"></p>
<p><img src="https://github.com/Zouxxyy/bigdata-learning/blob/master/hadoop-learning/data/image/Shuffer.png?raw=true" alt="Shufferæµç¨‹å›¾" title="Shufferæµç¨‹å›¾"></p>
<h1>å…·ä½“æ­¥éª¤</h1>
<p>é€»è¾‘ä¸Šå¯ä»¥è¿™æ ·åˆ’åˆ†ï¼š1-10æ˜¯MapTask ï¼›11-16æ˜¯ReduceTaskï¼›7-14æ˜¯shuffer</p>
<h3 id="1-å¾…å¤„ç†æ–‡æœ¬"><a class="header-anchor" href="#1-å¾…å¤„ç†æ–‡æœ¬">Â¶</a><strong>1. å¾…å¤„ç†æ–‡æœ¬</strong></h3>
<p>è¿™é‡Œå‡è®¾æ˜¯<code>/user/input</code>ç›®å½•ä¸‹çš„<code>ss.txt</code>	æ–‡ä»¶ï¼Œå¤§å°ä¸º<strong>200M</strong>ã€‚</p>
<h3 id="2-å®¢æˆ·ç«¯submitï¼ˆï¼‰"><a class="header-anchor" href="#2-å®¢æˆ·ç«¯submitï¼ˆï¼‰">Â¶</a><strong>2. å®¢æˆ·ç«¯submitï¼ˆï¼‰</strong></h3>
<p>å‘ç”Ÿåœ¨clientç«¯ï¼Œä¸»è¦è·å–3ä¸ªä¿¡æ¯ï¼š</p>
<p>ï¼ˆ1ï¼‰<strong>Job.split</strong> ï¼šæ‰¾åˆ°æ–‡ä»¶ss.txtï¼Œæ ¹æ®åˆ‡ç‰‡ç®—æ³•ï¼Œå¾—åˆ°åˆ‡ç‰‡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆèµ·å§‹ä½ç½®ï¼Œé•¿åº¦ä»¥åŠæ‰€åœ¨èŠ‚ç‚¹ç­‰ï¼‰å¦‚æŠŠss.txtåˆ†æˆä¸¤ç‰‡ 0-128M å’Œ 128M-200M</p>
<p>ï¼ˆ2ï¼‰<strong>Job.xml</strong>ï¼šä»»åŠ¡çš„é…ç½®ä¿¡æ¯</p>
<p>ï¼ˆ3ï¼‰<strong>wc.jar</strong>ï¼šä»»åŠ¡çš„jaråŒ…</p>
<p>ï¼ˆå¯ä»¥åœ¨<code>/tmp/hadoop-zxy/mapred/staging/zxy1248702679/.staging/</code>ä¸‹æ‰¾åˆ°å®ƒä»¬ï¼‰</p>
<h3 id="3-æäº¤ä¿¡æ¯"><a class="header-anchor" href="#3-æäº¤ä¿¡æ¯">Â¶</a><strong>3. æäº¤ä¿¡æ¯</strong></h3>
<p>å°†åˆšåˆšè·å–çš„ä»»åŠ¡è§„åˆ’ä¿¡æ¯ï¼Œæäº¤åˆ°èµ„æºç®¡ç†å™¨ä¸Šï¼Œæˆ‘ä»¬è¿™é‡Œç”¨Yarnã€‚</p>
<h3 id="4-RMè®¡ç®—MapTaskæ•°é‡"><a class="header-anchor" href="#4-RMè®¡ç®—MapTaskæ•°é‡">Â¶</a><strong>4. RMè®¡ç®—MapTaskæ•°é‡</strong></h3>
<p>æ¥ç€å‘Yarnçš„RMç”³è¯·èµ„æºï¼ŒRMæ ¹æ®ä»»åŠ¡è§„åˆ’ä¿¡æ¯ç”¨æˆ·Jobåˆ†æˆTaskï¼Œå¹¶æŠŠä»»åŠ¡ä¸‹å‘ç»™èŠ‚ç‚¹ã€‚è¿™é‡Œæˆ‘ä»¬æ•°æ®åˆ†æˆäº†2ç‰‡ï¼Œæ ¹æ®é»˜è®¤è§„åˆ™ï¼Œä¼šæœ‰2ä¸ªMapTaskå„è‡ªå¤„ç†ä¸€ç‰‡æ•°æ®ã€‚</p>
<h3 id="5-æ ¹æ®é‡‡ç”¨çš„InputFormatè¯»å–æ•°æ®"><a class="header-anchor" href="#5-æ ¹æ®é‡‡ç”¨çš„InputFormatè¯»å–æ•°æ®">Â¶</a><strong>5. æ ¹æ®é‡‡ç”¨çš„InputFormatè¯»å–æ•°æ®</strong></h3>
<p>è¿™é‡Œé‡‡ç”¨é»˜è®¤çš„TextInputFormatç±»ï¼ŒæŒ‰è¡Œè¯»å–æ¯æ¡è®°å½•ã€‚keyæ˜¯è¡Œåç§»é‡ï¼Œvalueæ˜¯è¯¥è¡Œçš„å†…å®¹ã€‚</p>
<h3 id="6-æ‰§è¡ŒMapperçš„map"><a class="header-anchor" href="#6-æ‰§è¡ŒMapperçš„map">Â¶</a><strong>6. æ‰§è¡ŒMapperçš„map()</strong></h3>
<p>æ ¹æ®ç”¨æˆ·çš„ä»£ç æ‰§è¡Œmapé€»è¾‘ï¼ŒæŠŠç»“æœå†™å…¥Contextä¸­ã€‚</p>
<h3 id="7-å‘ç¯å½¢ç¼“å­˜åŒºå†™å…¥æ•°æ®"><a class="header-anchor" href="#7-å‘ç¯å½¢ç¼“å­˜åŒºå†™å…¥æ•°æ®">Â¶</a><strong>7. å‘ç¯å½¢ç¼“å­˜åŒºå†™å…¥æ•°æ®</strong></h3>
<p>ç¯å½¢ç¼“å­˜åŒºå–ä¸€ç‚¹ï¼šä¸€è¾¹å†™ç´¢å¼•ï¼Œä¸€è¾¹å†™çœŸå®æ•°æ®ã€‚è¾¾åˆ°80%æ—¶å‘ç”Ÿæº¢å†™</p>
<h3 id="8-åˆ†åŒºã€æ’åº"><a class="header-anchor" href="#8-åˆ†åŒºã€æ’åº">Â¶</a><strong>8. åˆ†åŒºã€æ’åº</strong></h3>
<p>ä¸€ç§2æ¬¡æ’åºï¼Œå…ˆæŒ‰åŒºå·æ’ï¼Œå†å¯¹keyæ’åºï¼ˆå¿«æ’ï¼‰ã€‚å¾—åˆ°ä¸€ç»„æŒ‰åŒºæ’å¥½åºçš„æ•°æ®ã€‚æ³¨æ„ï¼šè¿™æ­¥æ˜¯åœ¨ç¯å½¢ç¼“å­˜åŒºå°±å¯ä»¥æ‰§è¡Œçš„ï¼Œä¸”æ’åºæ’çš„æ˜¯ç´¢å¼•ï¼ŒçœŸå®æ•°æ®ä¸ç”¨åŠ¨ã€‚ä¸”æ­¤æ—¶å¯ä»¥ä½¿ç”¨ç¬¬ä¸€æ¬¡Combineråˆå¹¶æ“ä½œã€‚</p>
<h3 id="9-æº¢å‡ºå†™å…¥æ–‡ä»¶"><a class="header-anchor" href="#9-æº¢å‡ºå†™å…¥æ–‡ä»¶">Â¶</a><strong>9. æº¢å‡ºå†™å…¥æ–‡ä»¶</strong></h3>
<p>ç¯å½¢ç¼“å­˜åŒºè¾¾åˆ°80%æ—¶ï¼Œæº¢å†™åˆ°ç£ç›˜ä¸Šã€‚æ³¨æ„å†™ç£ç›˜å‰å·²ç»å®Œæˆäº†åˆ†åŒºã€æ’åºã€åˆå¹¶ã€å‹ç¼©ç­‰æ“ä½œã€‚æ­¤æ—¶ç”Ÿæˆç¬¬ä¸€ç»„æº¢å†™æ–‡ä»¶<code>spillN.out</code> ä¸å…ƒæ•°æ®<code>spillN.out.index</code>ã€‚</p>
<h3 id="10-MapTaskçš„å½’å¹¶æ’åº"><a class="header-anchor" href="#10-MapTaskçš„å½’å¹¶æ’åº">Â¶</a><strong>10. MapTaskçš„å½’å¹¶æ’åº</strong></h3>
<p>å°†å¤šç»„æº¢å†™æ–‡ä»¶ï¼Œä»¥åˆ†åŒºä¸ºå•ä½è¿›è¡Œå½’å¹¶æ’åºï¼Œå†™å…¥ç£ç›˜å½¢æˆå¤§æ–‡ä»¶<code>output/file.out</code>ï¼Œä¸ç´¢å¼•æ–‡ä»¶<code>output/file.out.index</code>ã€‚æ­¤æ—¶ä¸€ä¸ªMapTaskä»»åŠ¡å®Œæˆï¼Œå¾—åˆ°ä¸€ä¸ªåˆ†åŒºæœ‰åºçš„æ•°æ®ã€‚æ³¨æ„ï¼šåœ¨å½’å¹¶æ’åºæ—¶å¯ä»¥ä½¿ç”¨ç¬¬äºŒæ¬¡Combineråˆå¹¶æ“ä½œã€‚</p>
<h3 id="11-å¯åŠ¨ReduceTask"><a class="header-anchor" href="#11-å¯åŠ¨ReduceTask">Â¶</a><strong>11. å¯åŠ¨ReduceTask</strong></h3>
<p>å‡è®¾åˆ†åŒºæ•°ä¸º2ï¼Œæ­¤æ—¶å¯åŠ¨2ä¸ªReduceTaskï¼Œä¸€ä¸ªReduceTaskå¤„ç†ä¸€ä¸ªåŒºçš„æ•°æ®ã€‚</p>
<h3 id="12-copyæ•°æ®"><a class="header-anchor" href="#12-copyæ•°æ®">Â¶</a><strong>12. copyæ•°æ®</strong></h3>
<p>ReduceTaskä»å„ä¸ªMapTaskä¸Šæ‹·è´å®ƒè¦å¤„ç†çš„åŒºçš„æ•°æ®ï¼Œå¦‚æœå…¶å¤§å°è¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼Œåˆ™å†™åˆ°ç£ç›˜ä¸Šï¼Œå¦åˆ™ç›´æ¥æ”¾åˆ°å†…å­˜ä¸­ã€‚</p>
<h3 id="13-ReduceTaskçš„å½’å¹¶æ’åº"><a class="header-anchor" href="#13-ReduceTaskçš„å½’å¹¶æ’åº">Â¶</a><strong>13. ReduceTaskçš„å½’å¹¶æ’åº</strong></h3>
<p>æŠŠåŒåŒºçš„æ•°æ®å¤åˆ¶åˆ°åŒä¸€ä¸ªReduceTaskåï¼Œå¯¹å®ƒä»¬è¿›è¡Œå½’å¹¶æ’åº</p>
<h3 id="14-åˆ†ç»„"><a class="header-anchor" href="#14-åˆ†ç»„">Â¶</a><strong>14. åˆ†ç»„</strong></h3>
<p>é»˜è®¤æŠŠkeyç›¸åŒçš„æ•°æ®åˆ†åˆ°ä¸€ç»„ã€‚ç”¨æˆ·å¯ä»¥ç»§æ‰¿WritableComparatorï¼Œè‡ªå®šä¹‰åˆ†ç»„è§„åˆ™ã€‚</p>
<h3 id="15-æ‰§è¡ŒReducerçš„Reduce"><a class="header-anchor" href="#15-æ‰§è¡ŒReducerçš„Reduce">Â¶</a><strong>15. æ‰§è¡ŒReducerçš„Reduce()</strong></h3>
<p>æ ¹æ®ç”¨æˆ·çš„ä»£ç æ‰§è¡Œreduceé€»è¾‘ï¼ŒæŠŠç»“æœå†™å…¥Contextä¸­ã€‚æ³¨æ„ï¼šä¸€æ¬¡è¯»ä¸€ç»„ï¼Œvalueæ˜¯è¿­ä»£å™¨å¯¹è±¡ï¼ŒåŒ…å«ä¸€ä¸ªç»„çš„å…¨éƒ¨æ•°æ®ã€‚</p>
<h3 id="16-æ ¹æ®é‡‡ç”¨çš„OutputFormatè¯»å–æ•°æ®"><a class="header-anchor" href="#16-æ ¹æ®é‡‡ç”¨çš„OutputFormatè¯»å–æ•°æ®">Â¶</a><strong>16. æ ¹æ®é‡‡ç”¨çš„OutputFormatè¯»å–æ•°æ®</strong></h3>
<p>è¿™é‡Œé‡‡ç”¨é»˜è®¤çš„TextOutputFormatç±»ï¼ŒæŒ‰è¡Œå†™å…¥keyå’Œvalueï¼Œkeyå’Œvalueç”¨tabåˆ†å¼€ã€‚</p>
<h1>ä¸€äº›æ€»ç»“</h1>
<h3 id="1ä¸ªé€»è¾‘"><a class="header-anchor" href="#1ä¸ªé€»è¾‘">Â¶</a><strong>1ä¸ªé€»è¾‘</strong></h3>
<p><strong>å…ˆåˆ†åŒº -&gt; å†æ’åº -&gt; å†åˆ†ç»„</strong></p>
<p>åˆ†åŒºï¼šç”¨æˆ·å®šä¹‰åˆ†åŒºæ•°åï¼Œé»˜è®¤æŒ‰hashåˆ†åŒºã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥ç»§æ‰¿<code>Partitioner</code>ï¼Œè‡ªå®šä¹‰åˆ†åŒºè§„åˆ™ã€‚ReduceTaskçš„ä¸ªæ•°ä¸€èˆ¬ç­‰äºåˆ†åŒºæ•°ã€‚</p>
<p>æ’åºï¼šé»˜è®¤å¯¹keyæ’åºï¼Œkeyå¿…é¡»å®ç°<code>WritableComparable</code>æ¥å£ã€‚ç”¨æˆ·å¯ä»¥é‡å†™<code>WritableComparable</code>æ¥å£çš„<code>compareTo()</code>æ–¹æ³•ï¼Œå®šä¹‰è‡ªå·±çš„æ’åºè§„åˆ™ã€‚</p>
<p>åˆ†ç»„ï¼šé»˜è®¤æŠŠkeyç›¸åŒçš„æ•°æ®åˆ†åˆ°ä¸€ç»„ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥ç»§æ‰¿WritableComparatorï¼Œè‡ªå®šä¹‰åˆ†ç»„è§„åˆ™ã€‚ç”¨äºreduceé˜¶æ®µï¼Œä¸€æ¬¡è¯»å–ä¸€ç»„.</p>
<h3 id="2æ¬¡åˆå¹¶"><a class="header-anchor" href="#2æ¬¡åˆå¹¶">Â¶</a><strong>2æ¬¡åˆå¹¶</strong></h3>
<p>Combinerçš„çˆ¶ç±»å°±æ˜¯Reducerï¼Œå®ƒå¯ä»¥é€šè¿‡å¯¹Mapé˜¶æ®µçš„å±€éƒ¨ç»“æœè¿›è¡Œæ±‡æ€»ï¼Œå‡å°‘è¾“å‡ºã€‚</p>
<p>æ—¶æœºï¼š 2æ¬¡ï¼Œ<strong>åˆ†åŒºæ’åºåã€MapTaskçš„å½’å¹¶æ’åºæ—¶</strong>ã€‚</p>
<p>æ¡ä»¶ï¼šä¸èƒ½å½±å“ä¸šåŠ¡é€»è¾‘ ä¸” è¾“å…¥è¾“å‡ºçš„èŒƒå‹ä¸€è‡´</p>
<h3 id="3æ¬¡æ’åº"><a class="header-anchor" href="#3æ¬¡æ’åº">Â¶</a><strong>3æ¬¡æ’åº</strong></h3>
<p>MapTaskï¼š</p>
<p><strong>åˆ†åŒºæ’åº</strong>ï¼šåœ¨ç¼“è¡Œç¼“å†²åŒºè¿›è¡Œï¼Œæ˜¯ä¸€ç§2æ¬¡æ’åºã€‚å…ˆæŒ‰åˆ†åŒºå·æ’åºï¼Œå†å¯¹keyæ’åºï¼ˆå¿«æ’ï¼‰ã€‚</p>
<p><strong>å½’å¹¶æ’åº</strong>ï¼šå¯¹æ¯ç»„æº¢å†™çš„æ•°æ®ï¼Œè¿›è¡Œçš„æŒ‰åŒºï¼Œå½’å¹¶æ’åºã€‚</p>
<p>ReduceTaskï¼š</p>
<p><strong>å½’å¹¶æ’åº</strong>ï¼šå¯¹ä»MapTaskæ‹·è´çš„åŒåŒºæ•°æ®ï¼Œè¿›è¡Œçš„å½’å¹¶æ’åºã€‚</p>
<h3 id="åˆ†ç‰‡å’Œåˆ†åŒº"><a class="header-anchor" href="#åˆ†ç‰‡å’Œåˆ†åŒº">Â¶</a><strong>åˆ†ç‰‡å’Œåˆ†åŒº</strong></h3>
<p>åˆ†ç‰‡ï¼š<strong>åˆ†ç‰‡æ•°å†³å®šMapTaskçš„ä¸ªæ•°</strong>ã€‚åœ¨å®¢æˆ·ç«¯å³å®Œæˆï¼Œä¸¾FileInputFormatåˆ‡ç‰‡æœºåˆ¶ä¸ºä¾‹ï¼šç®€å•çš„æŒ‰æ–‡ä»¶é•¿åº¦è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡å¤§å°ç­‰äºå—å¤§å°ï¼ˆé»˜è®¤128Mï¼‰ï¼Œåˆ‡ç‰‡æ—¶æ˜¯å¯¹æ–‡ä»¶å•ç‹¬åˆ‡ç‰‡ã€‚</p>
<p>åˆ†åŒºï¼š<strong>åˆ†åŒºæ•°å†³å®šReduceTaskçš„ä¸ªæ•°</strong>ã€‚</p>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>mapreduce</tag>
      </tags>
  </entry>
  <entry>
    <title>hadoop-å•èŠ‚ç‚¹ä¼ªåˆ†å¸ƒå¼æ­å»º</title>
    <url>/2019/08/24/hadoop-%E5%8D%95%E8%8A%82%E7%82%B9%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p>åœ¨macä¸Šæ­å»ºhadoopä¼ªåˆ†å¸ƒå¼</p>
<a id="more"></a>
<p>æ“ä½œç³»ç»Ÿï¼š macOS Mojave 10.14.5</p>
<p>JDK : 1.8</p>
<p>hadoop: 2.7.7</p>
<h2 id="1-Javaå’ŒHadoopå®‰è£…"><a class="header-anchor" href="#1-Javaå’ŒHadoopå®‰è£…">Â¶</a>1. Javaå’ŒHadoopå®‰è£…</h2>
<p>ä¸‹è½½å’Œå®‰è£…ç›¸ä¿¡éƒ½æ²¡é—®é¢˜</p>
<p>æ³¨æ„çš„å°±æ˜¯ï¼š</p>
<ul>
<li>ç¯å¢ƒå˜é‡è®¾ç½®å¥½ï¼Œæˆ‘æ˜¯macæ‰€ä»¥javahomeæ˜¯$(/usr/libexec/java_home);æˆ‘æ˜¯zshæ‰€ä»¥ä¿®æ”¹.zshrcï¼Œä¿®æ”¹å®Œåˆ«å¿˜äº†sourceã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#JAVA_HOME</span><br><span class="line">export JAVA_HOME=$(/usr/libexec/java_home)</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">#HADOOP_HOME</span><br><span class="line">export HADOOP_HOME=/usr/local/hadoop-2.7.7</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”±äºæˆ‘å°†hadoopæ”¾åœ¨<code>/usr/local/</code>ç›®å½•ä¸‹ï¼Œæ‰€ä»¥éœ€è¦æ›´æ”¹hadoopæ–‡ä»¶å¤¹æƒé™</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo chown -R zxy:admin /usr/local/hadoop-2.7.7</span><br></pre></td></tr></table></figure>
<h2 id="2-é…ç½®SSH"><a class="header-anchor" href="#2-é…ç½®SSH">Â¶</a>2. é…ç½®SSH</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -P <span class="string">""</span></span><br><span class="line">cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">ssh localhost</span><br></pre></td></tr></table></figure>
<h2 id="3-ä¼ªåˆ†å¸ƒå¼é…ç½®"><a class="header-anchor" href="#3-ä¼ªåˆ†å¸ƒå¼é…ç½®">Â¶</a>3. ä¼ªåˆ†å¸ƒå¼é…ç½®</h2>
<h3 id="core-site-xml"><a class="header-anchor" href="#core-site-xml">Â¶</a>core-site.xml</h3>
<p>ä¿®æ”¹ <code>/usr/local/hadoop-2.7.7/etc/hadoop/core-site.xml</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hdfs://localhost:9000&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;/usr/local/hadoop-2.7.7/data/tmp&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>fs.defaultFS</strong>  HDFS çš„NameNodeåœ°å€</p>
</li>
<li>
<p><strong>hadoop.tmp.dir</strong>  hadoop ä¸´æ—¶æ–‡ä»¶åœ°å€ï¼Œè‡ªå·±æŒ‡å®š</p>
</li>
</ul>
<h3 id="hdfs-site-xml"><a class="header-anchor" href="#hdfs-site-xml">Â¶</a>hdfs-site.xml</h3>
<p>ä¿®æ”¹ <code>/usr/local/hadoop-2.7.7/etc/hadoop/hdfs-site.xml</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">        &lt;property&gt;</span><br><span class="line">            &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">            &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>dfs.replication</strong>  HDFSæ–‡ä»¶å­˜å‚¨çš„å‰¯æœ¬ä¸ªæ•°ï¼Œé»˜è®¤3ã€‚å› ä¸ºæˆ‘ä»¬è¿™åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è®¾ç½®1.ï¼ˆå•ä¸€èŠ‚ç‚¹è‡³å¤šå­˜ä¸€ä»½èŠ‚ç‚¹ï¼‰</li>
</ul>
<h3 id="yarn-site-xml"><a class="header-anchor" href="#yarn-site-xml">Â¶</a>yarn-site.xml</h3>
<p>ä¿®æ”¹ <code>/usr/local/hadoop-2.7.7/etc/hadoop/yarn-site.xml</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;localhost&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;mapreduce_shuffle&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!-- å¼€å¯èšåˆæ—¥å¿— --&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.log-aggregation-enable&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.log.server.url&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;http://localhost:19888/jobhistory/logs&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>arn.log-aggregation-enable</strong> å¼€å¯æ—¥å¿—èšåˆ</li>
<li><strong>yarn.resourcemanager.hostname</strong>  yarnçš„ResourceManageråœ°å€</li>
</ul>
<h3 id="mapred-site-xml"><a class="header-anchor" href="#mapred-site-xml">Â¶</a>mapred-site.xml</h3>
<p>ä¿®æ”¹ <code>/usr/local/hadoop-2.7.7/etc/hadoop/mapred-site.xml</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;localhost:10020&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;localhost:19888&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><a href="http://mapreduce.framework.name" target="_blank" rel="noopener">mapreduce.framework.name</a></strong>  é‡‡ç”¨yarnç®¡ç†MR</li>
<li><strong>mapreduce.jobhistory.address</strong>  å†å²æœåŠ¡å™¨ç«¯å£åœ°å€</li>
<li><strong>mapreduce.jobhistory.webapp.address</strong>  å†å²æœåŠ¡å™¨webç«¯åœ°å€</li>
</ul>
<h3 id="æ£€æŸ¥JAVA-HOME"><a class="header-anchor" href="#æ£€æŸ¥JAVA-HOME">Â¶</a>æ£€æŸ¥JAVA_HOME</h3>
<p><a href="http://hadoop-env.sh" target="_blank" rel="noopener">hadoop-env.sh</a>ã€<a href="http://mapred-env.sh" target="_blank" rel="noopener">mapred-env.sh</a>ã€<a href="http://yarn-env.sh" target="_blank" rel="noopener">yarn-env.sh</a>ï¼Œåœ¨è¿™ä¸‰ä¸ªæ–‡ä»¶æ£€æŸ¥æ˜¯å¦æ·»åŠ JAVA_HOMEè·¯å¾„ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export JAVA_HOME=$JAVA_HOME</span><br></pre></td></tr></table></figure>
<h2 id="4-ä½¿ç”¨"><a class="header-anchor" href="#4-ä½¿ç”¨">Â¶</a>4. ä½¿ç”¨</h2>
<ul>
<li>å¼€HDFS</li>
</ul>
<p>ç¬¬ä¸€æ¬¡ä½¿ç”¨è¦æ ¼å¼åŒ–(ä»…é™ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œä»¥åè¦æ ¼å¼åŒ–éœ€åˆ é™¤logã€dataç›®å½•ä¸‹çš„æ–‡ä»¶)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hadoop namenode -format</span><br></pre></td></tr></table></figure>
<p>å¼€å¯namenodeã€datanode</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hadoop-daemon.sh start namenode</span><br><span class="line">hadoop-daemon.sh start datanode</span><br></pre></td></tr></table></figure>
<ul>
<li>å¼€yarn</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yarn-daemon.sh start resourcemanager</span><br><span class="line">yarn-daemon.sh start nodemanager</span><br></pre></td></tr></table></figure>
<ul>
<li>å¼€historyserver</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mr-jobhistory-daemon.sh start historyserver</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯ä»¥ç”¨jpsæŸ¥çœ‹æ•ˆæœ</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jps</span><br><span class="line">35953 JobHistoryServer</span><br><span class="line">32930</span><br><span class="line">35682 NodeManager</span><br><span class="line">35990 Jps</span><br><span class="line">35559 DataNode</span><br><span class="line">35624 ResourceManager</span><br><span class="line">35502 NameNode</span><br></pre></td></tr></table></figure>
<ul>
<li>æµ‹è¯•</li>
</ul>
<p>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹zxytestï¼Œé‡Œé¢éšä¾¿æ”¾ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸Šä¼ åˆ°hdfsæµ‹è¯•wordcount</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hdfs dfs -put zxytest /</span><br><span class="line">hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.7.jar wordcount /zxytest /zxyout</span><br></pre></td></tr></table></figure>
<ul>
<li>å…³é—­</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mr-jobhistory-daemon.sh stop historyserver</span><br><span class="line">yarn-daemon.sh stop resourcemanager</span><br><span class="line">yarn-daemon.sh stop nodemanager</span><br><span class="line">hadoop-daemon.sh stop namenode</span><br><span class="line">hadoop-daemon.sh stop datanode</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯è§†åŒ–åœ°å€</li>
</ul>
<p>æ‰€æœ‰ä»»åŠ¡: <a href="http://localhost:8088/" target="_blank" rel="noopener">http://localhost:8088/</a></p>
<p>DataNode: <a href="http://localhost:50070/" target="_blank" rel="noopener">http://localhost:50070/</a></p>
<p>å†å²æœåŠ¡å™¨: <a href="http://localhost:19888/" target="_blank" rel="noopener">http://localhost:19888/</a></p>
]]></content>
      <categories>
        <category>å¤§æ•°æ®</category>
      </categories>
      <tags>
        <tag>hadoop</tag>
        <tag>é…ç½®</tag>
      </tags>
  </entry>
  <entry>
    <title>3ç§Linuxå‘½ä»¤åå°æ‰§è¡Œæ–¹æ³•ï¼š&amp;ã€nohupã€tmux</title>
    <url>/2019/06/26/3%E7%A7%8DLinux%E5%91%BD%E4%BB%A4%E5%90%8E%E5%8F%B0%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95%EF%BC%9A-%E3%80%81nohup%E3%80%81tmux/</url>
    <content><![CDATA[<p>è®©å‘½ä»¤åœ¨åå°è·‘èµ·æ¥ï¼</p>
<a id="more"></a>
<h1>&amp;</h1>
<p>ç”¨æ³•ï¼š<code>æŒ‡ä»¤ &amp;</code></p>
<p>è¯´æ˜ï¼š å°†æŒ‡ä»¤æ”¾å…¥åå°æ‰§è¡Œï¼Œä¼šå°†è¾“å‡ºæ‰“å°åˆ°å‰å°ï¼Œ<strong>å½“æ‰§è¡Œè¯¥æŒ‡ä»¤çš„ç»ˆç«¯ggæ—¶ï¼Œå®ƒä¹Ÿgg</strong></p>
<p>ç»ˆæ­¢æ–¹æ³•ï¼š</p>
<ul>
<li><code>jobs</code> æŸ¥çœ‹å®ƒ -&gt; <code>fg %num</code> å–å‡ºå®ƒ -&gt; <code>Ctrl+c</code>ç»ˆæ­¢å®ƒ</li>
<li>ç›´æ¥é€€å‡ºç»ˆç«¯</li>
</ul>
<h1>nohup</h1>
<p>ç”¨æ³•ï¼š<code>nohup æŒ‡ä»¤ &amp;</code></p>
<p>è¯´æ˜ï¼š å°†æŒ‡ä»¤æ”¾å…¥åå°æ‰§è¡Œï¼Œä¸ä¼šå°†è¾“å‡ºæ‰“å°åˆ°å‰å°ï¼Œ<strong>å½“æ‰§è¡Œè¯¥æŒ‡ä»¤çš„ç»ˆç«¯ggæ—¶ï¼Œå®ƒä¸gg</strong></p>
<p>ç»ˆæ­¢æ–¹æ³•ï¼š</p>
<ul>
<li>æœªé€€å‡ºç»ˆç«¯æ—¶ï¼š<code>jobs</code> æŸ¥çœ‹å®ƒ -&gt; <code>fg %num</code> å–å‡ºå®ƒ -&gt; <code>Ctrl+c</code>ç»ˆæ­¢å®ƒ</li>
<li>é€€å‡ºç»ˆç«¯æ—¶ï¼šåœ¨æ–°ç»ˆç«¯è¿æ¥ä¸­ï¼Œæ‰¾åˆ°PIDå·ï¼Œkillå®ƒ</li>
</ul>
<h1>tmux</h1>
<p>ç®€ä»‹ï¼š</p>
<p>tmuxå¯ä»¥åœ¨åå°æ–°å»ºä¸€ä¸ªç»ˆç«¯ï¼Œå¹¶ä¸”ç”¨æˆ·é€€å‡ºååˆ›å»ºçš„ç»ˆç«¯ä»ç„¶å­˜åœ¨</p>
<p>ç”¨æ³•ï¼š</p>
<ul>
<li>åˆ›å»ºsession</li>
</ul>
<p><code>tmux new -s $session_name</code></p>
<ul>
<li>åˆ—å‡ºsession</li>
</ul>
<p><code>tmux ls</code></p>
<ul>
<li>ä¸´æ—¶é€€å‡ºsession</li>
</ul>
<p><code>Ctrl+b d</code></p>
<ul>
<li>è¿›å…¥å·²å­˜åœ¨çš„session</li>
</ul>
<p><code>tmux a -t $session_name</code></p>
<ul>
<li>åˆ é™¤æŒ‡å®šsession</li>
</ul>
<p><code>tmux kill-session -t $session_name</code></p>
<h1>æ€»ç»“</h1>
<ul>
<li>
<p>&amp;  ç®€å•ï¼Œå®‰å…¨ï¼Œé€€å‡ºç»ˆç«¯ï¼Œç¨‹åºè‡ªåŠ¨ç»“æŸ</p>
</li>
<li>
<p>nohup é€€å‡ºç»ˆç«¯åï¼Œå¿…é¡»é€šè¿‡pidå·æ€ç¨‹åº</p>
</li>
<li>
<p>tmux è°ç”¨è°çŸ¥é“ï¼Œä¸€èˆ¬æƒ…å†µï¼Œæ—¶é—´é•¿çš„ç¨‹åºï¼Œæˆ‘éƒ½ç”¨å®ƒ</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>shell</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨jupyter notebookæ‰“å¼€æœåŠ¡å™¨ï¼ˆå‘Šåˆ«é»‘æ¡†æ¡†)</title>
    <url>/2019/04/11/%E7%94%A8jupyter-notebook%E6%89%93%E5%BC%80%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88%E5%91%8A%E5%88%AB%E9%BB%91%E6%A1%86%E6%A1%86/</url>
    <content><![CDATA[<p>å‡ æ­¥å®ŒæˆæœåŠ¡å™¨å†…jupyter notebookçš„ä½¿ç”¨</p>
<a id="more"></a>
<h1>ä¸ºå•¥è¦è¿™æ ·</h1>
<p>å¯ä»¥è¿œç¨‹ç”¨æµè§ˆå™¨çœ‹æœåŠ¡å™¨çš„æ–‡ä»¶ç›®å½•ï¼Œä»¥åŠå„ç§jupyterçš„å¥½å¤„ï¼šç›´æ¥æ”¹ä»£ç ï¼Œè°ƒè¯•ï¼Œå®ƒå†…åµŒçš„è¯»å›¾ä¹Ÿæ˜¯ç‰¹åˆ«èˆ’æœã€‚</p>
<h1>æœåŠ¡å™¨å®‰è£…jupyter notebook</h1>
<p>æˆ‘æ˜¯ç»™æœåŠ¡å™¨è£…äº†<a href="https://zouxxyy.github.io/2019/04/10/linux%E4%B8%8B%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%AE%89%E8%A3%85anaconda3-pytorch-fastai/#more" target="_blank" rel="noopener">anaconda</a>ï¼Œç„¶åå°±è‡ªå¸¦äº†jupyter notebookã€‚</p>
<h1>é…ç½®jupyter notebook</h1>
<ol>
<li>ç™»é™†æœåŠ¡å™¨</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh username@address_of_remote</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>ç”Ÿæˆé…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ jupyter notebook --generate-config</span><br></pre></td></tr></table></figure>
<p>è¯¥æŒ‡ä»¤ä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªï¼š<code>~/.jupyter/jupyter_notebook_config.py </code></p>
<ol start="3">
<li>ç”Ÿæˆå¯†ç </li>
</ol>
<p>æ‰“å¼€pythonï¼Œåˆ›å»ºå¯†ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> notebook.auth <span class="keyword">import</span> passwd</span><br><span class="line">passwd()</span><br><span class="line">Enter password:</span><br><span class="line">Verify password:</span><br><span class="line"><span class="string">'sha1:xxxxxxxxxxxxxxxxxxxxxxx'</span></span><br></pre></td></tr></table></figure>
<p>æŠŠå¯†ç <code>'sha1:xxxxxxxxxxxxxxxxxxxxxxx'</code>å¤åˆ¶ä¸‹æ¥</p>
<ol start="4">
<li>ä¿®æ”¹é…ç½®æ–‡ä»¶</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim ~/.jupyter/jupyter_notebook_config.py</span><br></pre></td></tr></table></figure>
<p>åŠ ä¸Šä¸‹é¢è¿™å‡ è¡Œ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">c.NotebookApp.allow_remote_access = <span class="literal">True</span></span><br><span class="line">c.NotebookApp.ip = <span class="string">'*'</span></span><br><span class="line">c.NotebookApp.password = <span class="string">u'sha1:xxxxxxxxxxxxxxxxxxxx'</span> <span class="comment">#ä½ çš„å¯†ç </span></span><br><span class="line">c.NotebookApp.open_browser = <span class="literal">False</span></span><br><span class="line">c.NotebookApp.port = <span class="number">8888</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>å¯åŠ¨jupyter</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ jupyter notebook</span><br></pre></td></tr></table></figure>
<h1>è¿œç¨‹è®¿é—®</h1>
<ul>
<li>
<p>æ–¹æ³•ä¸€ï¼š</p>
<p>æœ¬åœ°æµè§ˆå™¨è®¿é—®<code>http://address_of_remote:8888</code> ï¼ˆæ­¤æ–¹æ³•å¯èƒ½ç”±äºé˜²ç«å¢™é—®é¢˜å‡ºç°å¤±è´¥ï¼‰</p>
</li>
<li>
<p>æ–¹æ³•äºŒï¼š</p>
<ol>
<li>åœ¨æœ¬åœ°ç»ˆç«¯ä¸­è¾“å…¥:</li>
</ol>
<p><code>ssh username@address_of_remote -L127.0.0.1:1234:127.0.0.1:8888 </code></p>
<ol start="2">
<li>æœ¬åœ°æµè§ˆå™¨è®¿é—®<code>http://localhost:1234</code></li>
</ol>
</li>
</ul>
<p>çœ‹çœ‹æ•ˆæœï¼Œè™šæµ®äº†ã€‚ç›¸é€¢æ¨æ™šï¼Œé€ åŒ–å¼„äººå•Šï½</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/4/11/16a0a4fa59021e90?w=1293&amp;h=200&amp;f=png&amp;s=25969" alt></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>jupyter</tag>
      </tags>
  </entry>
  <entry>
    <title>linuxä¸‹å‘½ä»¤è¡Œå®‰è£…anaconda3+pytorch+fastai</title>
    <url>/2019/04/10/linux%E4%B8%8B%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%AE%89%E8%A3%85anaconda3-pytorch-fastai/</url>
    <content><![CDATA[<p>å‡ æ­¥å®Œæˆ anaconda3+pytorch+fastai çš„å®‰è£…</p>
<a id="more"></a>
<h1>ä¸ºå•¥ç”¨anaconda</h1>
<p>anaconda ç¡®å®å¾ˆå¥½ç”¨ï¼Œåˆ‡æ¢pythonç‰ˆæœ¬ä¹Ÿæ–¹ä¾¿ã€‚è€Œä¸”å¦‚æœæœåŠ¡å™¨ç”¨çš„äººå¤šï¼Œç”¨anacondaæä¸ªè‡ªå·±çš„ç¯å¢ƒå¾ˆèˆ’æœã€‚</p>
<h1>anaconda3å®‰è£…</h1>
<ol>
<li><strong><a href="https://www.anaconda.com/distribution/" target="_blank" rel="noopener">å®˜ç½‘</a>é€‰æ‹©è¦ä¸‹è½½çš„ç‰ˆæœ¬</strong>ã€‚æˆ‘ç”¨çš„æ˜¯python3.7åšbaseï¼ˆå¦‚æœåé¢æƒ³ç”¨python2.7ç›´æ¥åŠ ä¸ªç¯å¢ƒå°±è¡Œï¼‰</li>
</ol>
<p><img src="https://user-gold-cdn.xitu.io/2019/4/10/16a0537dfe227c8d?w=1122&amp;h=485&amp;f=png&amp;s=62781" alt></p>
<p>æŠŠä¸‹è½½åœ°å€æ‹·è´ä¸‹æ¥ï¼Œç”¨<code>wget</code>ä¸‹è½½</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://repo.anaconda.com/archive/Anaconda3-2019.03-Linux-x86_64.sh</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>å®‰è£…</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash Anaconda3-2019.03-Linux-x86_64.sh</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªè¿‡ç¨‹éœ€è¦</p>
<ol>
<li>
<p>æŒ‰å›è½¦é˜…è¯»licenseï¼Œå¹¶åŒæ„</p>
</li>
<li>
<p>é€‰æ‹©å®‰è£…åœ°å€ï¼Œæˆ‘å°±æ˜¯æŒ‰é»˜è®¤çš„<code>/home/zxy/anaconda3</code></p>
</li>
<li>
<p>æ˜¯å¦ conda init ï¼Œè¿™æ­¥åŒæ„äº†ä¼šè‡ªåŠ¨åœ¨<code>/home/zxy/.bashrc</code>æ”¹ä½ çš„ç¯å¢ƒå˜é‡ã€‚</p>
</li>
<li>
<p><strong>æ¿€æ´»ç¯å¢ƒå˜é‡çš„ä¿®æ”¹</strong></p>
</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>æ¿€æ´»ä¸‹ä¿®æ”¹ï¼Œå°±å®‰è£…å®Œæ¯•äº†ï¼Œç„¶åå¯ä»¥rmæ‰å®‰è£…åŒ…ã€‚</p>
<ol start="4">
<li><strong>ä¸€äº›ç»†èŠ‚</strong></li>
</ol>
<p>åŒæ„äº†<code>conda init</code>åï¼Œä¼š<strong>è‡ªåŠ¨</strong>åœ¨<code>/home/zxy/.bashrc</code>åŠ ä¸‹é¢è¿™äº›ä¸œè¥¿ã€‚å¯ä»¥ç”¨<code>cat ~/.bashrc</code>è‡ªå·±çœ‹çœ‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span></span><br><span class="line"><span class="comment"># !! Contents within this block are managed by 'conda init' !!</span></span><br><span class="line">__conda_setup=<span class="string">"<span class="variable">$('/home/zxy/anaconda3/bin/conda' 'shell.bash' 'hook' 2&gt; /dev/null)</span>"</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="string">"<span class="variable">$__conda_setup</span>"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">"/home/zxy/anaconda3/etc/profile.d/conda.sh"</span> ]; <span class="keyword">then</span></span><br><span class="line">        . <span class="string">"/home/zxy/anaconda3/etc/profile.d/conda.sh"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">export</span> PATH=<span class="string">"/home/zxy/anaconda3/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> __conda_setup</span><br><span class="line"><span class="comment"># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span></span><br></pre></td></tr></table></figure>
<p>æœ‰äº†å®ƒå‘¢ï¼Œæˆ‘ä»¬ç›´æ¥<code>python</code>æµ‹è¯•çœ‹çœ‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(base) [zxy@gpu-server5 ~]$ python</span><br><span class="line">Python 3.7.3 (default, Mar 27 2019, 22:11:17) </span><br><span class="line">[GCC 7.3.0] :: Anaconda, Inc. on linux</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br></pre></td></tr></table></figure>
<p>OK! å¯ä»¥ç”¨äº†ï¼</p>
<h1>pytorchå®‰è£…</h1>
<p><strong><a href="https://pytorch.org/" target="_blank" rel="noopener">å®˜ç½‘</a>é€‰æ‹©ä¸‹è½½çš„ç‰ˆæœ¬</strong>ã€‚è¿™é‡Œè¦æ ¹æ®è‡ªå·±çš„cudaç‰ˆæœ¬é€‰æ‹©</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/4/10/16a0535a5d05c267?w=825&amp;h=316&amp;f=png&amp;s=40869" alt></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">conda install pytorch torchvision cudatoolkit=9.0 -c pytorch</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæœ‰äº†<code>anaconda</code>ï¼Œå®‰è£…<code>pytorch</code>ä¸€å¥è¯å®Œäº‹ã€‚</p>
<p>(psï¼šå›½å†…å…„å¼Ÿï¼Œå¯ä»¥å…ˆæ·»åŠ <a href="https://mirror.tuna.tsinghua.edu.cn/help/anaconda/" target="_blank" rel="noopener">æ¸…åé•œåƒ</a>ï¼Œå†æŠŠåé¢çš„-c pytorchå»æ‰ã€‚é€Ÿåº¦é£èµ·ï½)</p>
<h1>fastaiå®‰è£…</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">conda install -c fastai fastai</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>anaconda</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(8)-è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“</title>
    <url>/2019/03/29/JVM-8-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AD%97%E8%8A%82%E7%A0%81%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ç¬¬å…«ç« çš„ç¬”è®°</p>
<a id="more"></a>
<h1>è¿è¡Œæ—¶æ ˆå¸§ç»“æ„</h1>
<p>åœ¨æ´»åŠ¨çº¿ç¨‹ä¸­ï¼Œåªæœ‰æ ˆé¡¶çš„æ ˆæ—¶æœ‰æ•ˆçš„ï¼Œç§°ä¸º<strong>å½“å‰æ ˆå¸§</strong>ï¼Œä¸è¿™ä¸ªæ ˆå¸§ç›¸å…³è”çš„æ–¹æ³•ç§°ä¸º<strong>å½“å‰æ–¹æ³•</strong>ã€‚ä¸‹é¢å¯¹æ ˆå¸§çš„4ä¸ªä¸»è¦éƒ¨åˆ†è¿›è¡Œåˆ†æã€‚</p>
<h2 id="å±€éƒ¨å˜é‡è¡¨"><a class="header-anchor" href="#å±€éƒ¨å˜é‡è¡¨">Â¶</a>å±€éƒ¨å˜é‡è¡¨</h2>
<p>å­˜æ”¾æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡</p>
<p>ä¸€äº›ç»†èŠ‚ï¼š</p>
<ul>
<li>æœ€å°å­˜å‚¨å•å…ƒ(Slot)ï¼Œä¸€ä¸ªSlotå¯ä»¥å­˜32ä½ä»¥å†…çš„æ•°æ®ç±»å‹ã€‚</li>
<li><code>booleanã€byteã€charã€shortã€intã€floatã€referenceã€returnAddress</code>å ä¸€ä¸ªSlotï¼›<code>longã€double</code>å ä¸¤ä¸ªSlotï¼Œæ˜¯éåŸå­çš„ï¼Œä½†å®ƒæ˜¯<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ï¼Œå› ä¸ºå®ƒæ˜¯æ ˆä¸­çš„ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚</li>
<li>å¯¹äºå®ä¾‹æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªSlotæ˜¯ä¼ é€’æ‰€å±å¯¹è±¡å®ä¾‹çš„å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„   <code>this</code>ã€‚</li>
<li>æ³¨æ„å±€éƒ¨å˜é‡<strong>æ²¡æœ‰åˆå§‹å€¼</strong>å“¦ã€‚</li>
<li>å½“ä¸€ä¸ªå˜é‡çš„pcå¯„å­˜å™¨çš„å€¼å¤§äºSlotçš„ä½œç”¨åŸŸæ—¶ï¼ŒSlotæ˜¯å¯ä»¥<strong>å¤ç”¨</strong>çš„ã€‚</li>
</ul>
<h2 id="æ“ä½œæ•°æ ˆ"><a class="header-anchor" href="#æ“ä½œæ•°æ ˆ">Â¶</a>æ“ä½œæ•°æ ˆ</h2>
<ul>
<li>è™šæ‹Ÿæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“æ˜¯â€œ<strong>åŸºäºæ ˆçš„æ‰§è¡Œå¼•æ“</strong>â€ï¼Œè¿™ä¸ªæ ˆå°±æ˜¯æ“ä½œæ•°æ ˆã€‚</li>
<li>å¯¹æ¯”<strong>åŸºäºå¯„å­˜å™¨</strong>çš„æ‰§è¡Œå¼•æ“</li>
</ul>
<p>ä¼˜ç‚¹ï¼šå¯ç§»æ¤æ€§ã€ä»£ç æ›´åŠ ç´§å‡‘ã€ç¼–è¯‘å™¨å®ç°æ›´ç´§å‡‘ã€‚ç¡®å®šå°±æ˜¯é€Ÿåº¦æ›´æ…¢ã€‚</p>
<ul>
<li>ä¸‹é¢æ ˆå¸§çš„éƒ¨åˆ†æ“ä½œæ•°æ ˆä¸ä¸Šé¢çš„æ ˆå¸§çš„éƒ¨åˆ†å±€éƒ¨å˜é‡æ˜¯é‡å çš„ã€‚</li>
</ul>
<h2 id="åŠ¨æ€è¿æ¥"><a class="header-anchor" href="#åŠ¨æ€è¿æ¥">Â¶</a>åŠ¨æ€è¿æ¥</h2>
<p>æŒ‡å‘è¿è¡Œæ—¶å¸¸é‡æ± ä¸­è¯¥æ ˆå¸§æ‰€å±æ–¹æ³•çš„å¼•ç”¨ï¼Œè¿™ä¸ªå¼•ç”¨çš„ä¸ºäº†æ”¯æŒæ–¹æ³•è°ƒç”¨è¿‡ç¨‹çš„åŠ¨æ€è¿æ¥ã€‚å…·ä½“å†…å®¹åœ¨ä¸‹é¢çš„æ–¹æ³•è°ƒç”¨ä¸­è§£é‡Šã€‚</p>
<h2 id="æ–¹æ³•è¿”å›åœ°å€"><a class="header-anchor" href="#æ–¹æ³•è¿”å›åœ°å€">Â¶</a>æ–¹æ³•è¿”å›åœ°å€</h2>
<p>æ–¹æ³•é€€å‡ºï¼ˆä¹Ÿå°±æ˜¯<strong>å½“å‰æ ˆå¸§å‡ºæ ˆ</strong>ï¼‰çš„ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li><code>return</code>æ­£å¸¸é€€å‡º</li>
<li>å¼‚å¸¸é€€å‡ºï¼Œæ ¹æ®å¼‚å¸¸è¡¨å¾—è¿”å›å‡ºå£</li>
</ul>
<h1>æ–¹æ³•è°ƒç”¨</h1>
<p>æ–¹æ³•è°ƒç”¨ä¸ç­‰åŒäºæ–¹æ³•çš„æ‰§è¡Œï¼Œæ–¹æ³•è°ƒç”¨é˜¶æ®µå”¯ä¸€çš„ä»»åŠ¡å°±æ˜¯ç¡®å®šè¢«è°ƒç”¨æ–¹æ³•çš„ç‰ˆæœ¬ã€‚è¯´ç™½äº†å°±æ˜¯æ‰¾æ–¹æ³•ï¼Œæ–¹æ³•å”¯ä¸€å°±ç›´æ¥ç¡®å®šï¼ˆ<strong>è§£æ</strong>ï¼‰ã€‚æ–¹æ³•ä¸å”¯ä¸€ï¼š<strong>é‡è½½ï¼ˆé™æ€åˆ†é…ï¼‰ã€é‡å†™ï¼ˆåŠ¨æ€åˆ†é…ï¼‰</strong></p>
<h2 id="è§£æè°ƒç”¨"><a class="header-anchor" href="#è§£æè°ƒç”¨">Â¶</a>è§£æè°ƒç”¨</h2>
<ul>
<li>
<p>è°ƒç”¨ç›®æ ‡åœ¨ç¨‹åºä»£ç å†™å¥½ã€ç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘æ—¶å°±ç¡®å®šå¥½çš„ã€‚è¿™ç±»æ–¹æ³•æ—¶è°ƒç”¨ç§°ä¸ºè§£æã€‚æ˜¯é™æ€çš„ã€‚</p>
</li>
<li>
<p><strong>éè™šæ–¹æ³•</strong>ï¼šé™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³•ã€finalæ–¹æ³•ã€‚å®ƒä»¬éƒ½æ˜¯é‡‡ç”¨è§£æè°ƒç”¨ã€‚åä¹‹å…¶å®ƒå°±æ˜¯è™šæ–¹æ³•ã€‚</p>
</li>
</ul>
<h2 id="åˆ†æ´¾è°ƒç”¨"><a class="header-anchor" href="#åˆ†æ´¾è°ƒç”¨">Â¶</a>åˆ†æ´¾è°ƒç”¨</h2>
<p><code>Human man = new Man();</code></p>
<p><code>Human</code>æ˜¯é™æ€ç±»å‹ï¼ˆå¤–è§‚ç±»å‹ï¼‰ï¼Œ<code>Man</code>æ˜¯å®é™…ç±»å‹</p>
<h3 id="é™æ€åˆ†æ´¾"><a class="header-anchor" href="#é™æ€åˆ†æ´¾">Â¶</a>é™æ€åˆ†æ´¾</h3>
<p>ä¾èµ–é™æ€ç±»å‹æ¥å®šä½æ–¹æ³•æ‰§è¡Œçš„ç‰ˆæœ¬çš„åˆ†é…åŠ¨ä½œç§°ä¸ºé™æ€åˆ†é…ã€‚æœ€å…¸å‹çš„åº”ç”¨æ˜¯æ–¹æ³•é‡è½½ã€‚</p>
<ul>
<li>ç¼–è¯‘å™¨åœ¨<strong>é‡è½½</strong>æ—¶æ˜¯æ ¹æ®å‚æ•°çš„<strong>é™æ€ç±»å‹</strong>ä½œä¸ºä¾æ®çš„ã€‚</li>
<li>ç”±äºå­—é¢é‡æ²¡æœ‰æ˜¾å¼çš„é™æ€ç±»å‹ï¼Œå®ƒé‡è½½æ—¶å¯èƒ½ä¼šæœ‰å¤šç§é€‰æ‹©ï¼Œåªæ˜¯é€‰ä¸€ä¸ªæ›´å¥½çš„ç‰ˆæœ¬ã€‚</li>
<li>é™æ€åˆ†é…å’Œè§£æä¸æ˜¯äº’æ–¥çš„ï¼Œä¾‹å¦‚é™æ€æ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥é‡è½½çš„ã€‚</li>
<li>æ³¨æ„ï¼šé™æ€åˆ†é…æ›´ä¸¥æ ¼ï¼Œ<strong>ä¸€å®šæ˜¯è¦ç”¨é™æ€ç±»å‹åšå‚æ•°</strong>ã€‚</li>
</ul>
<h3 id="åŠ¨æ€åˆ†æ´¾"><a class="header-anchor" href="#åŠ¨æ€åˆ†æ´¾">Â¶</a>åŠ¨æ€åˆ†æ´¾</h3>
<p>ä¾èµ–å®é™…ç±»å‹æ¥å®šä½æ–¹æ³•æ‰§è¡Œçš„ç‰ˆæœ¬çš„åˆ†é…åŠ¨ä½œç§°ä¸ºåŠ¨æ€åˆ†é…ã€‚æœ€å…¸å‹çš„åº”ç”¨æ˜¯æ–¹æ³•é‡å†™ã€‚</p>
<ul>
<li>è™šæ‹Ÿå™¨åœ¨<strong>é‡å†™</strong>æ—¶æ˜¯å¯¹è±¡çš„<strong>å®é™…ç±»å‹</strong>ä½œä¸ºä¾æ®çš„ã€‚</li>
<li>æ³¨æ„ï¼šåŠ¨æ€åˆ†é…æ›´å®½æ¾ï¼Œå¦‚æœå®é™…ç±»å‹ä¸­æ²¡æœ‰å¯¹åº”çš„æ–¹æ³•ï¼Œå°±ä¼šå‘ä¸Šæ‰¾çˆ¶ç±»é‡Œçš„ç›¸åŒæ–¹æ³•æ¥è°ƒç”¨ã€‚</li>
</ul>
<p>ä¸€ä¸ªæµ‹è¯•ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MixTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span></span>&#123; &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">extends</span> <span class="title">Human</span></span>&#123;&#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Woman</span> <span class="keyword">extends</span> <span class="title">Human</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">choice</span><span class="params">(Human arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"father choose human"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">choice</span><span class="params">(Man arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"father choose man"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">choice</span><span class="params">(Woman arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"father choose woman"</span>); <span class="comment">// å’ŒåŒä¸€ç±»é‡Œçš„åŒåæ–¹æ³•æ˜¯é‡è½½å…³ç³»</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">choice</span><span class="params">(Human arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"son choose human"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">choice</span><span class="params">(Man arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"son choose man"</span>); <span class="comment">// å’Œçˆ¶ç±»çš„åŒååŒå‚æ•°æ–¹æ³•æ˜¯é‡å†™å…³ç³»</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">choice</span><span class="params">(Woman arg)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"son choose woman"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Human woman = <span class="keyword">new</span> Woman();</span><br><span class="line">        Man man = <span class="keyword">new</span> Man();</span><br><span class="line">        Father father = <span class="keyword">new</span> Father();</span><br><span class="line">        Father son = <span class="keyword">new</span> Son();</span><br><span class="line">        father.choice(woman); <span class="comment">// é‡å†™ï¼šå¯¹è±¡ç±»å‹é€‰Father(å®é™…ç±»å‹) é‡è½½ï¼šå‚æ•°ç±»å‹é€‰ Humanï¼ˆé™æ€ç±»å‹ï¼‰</span></span><br><span class="line">        son.choice(man); <span class="comment">// é‡å†™ï¼šå¯¹è±¡ç±»å‹é€‰Son(å®é™…ç±»å‹) é‡è½½ï¼šå‚æ•°ç±»å‹é€‰ Manï¼ˆé™æ€ç±»å‹ï¼‰</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç¨‹åºè¾“å‡ºï¼š</span></span><br><span class="line"><span class="comment">father choose human</span></span><br><span class="line"><span class="comment">son choose man</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(7)-è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶</title>
    <url>/2019/03/29/JVM-7-%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ç¬¬ä¸ƒç« çš„ç¬”è®°</p>
<a id="more"></a>
<h1>ç±»åŠ è½½çš„æ—¶æœº</h1>
<p>ç±»åŠ è½½åè¦åˆå§‹åŒ–ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡åˆ¤æ–­å•¥æ—¶å€™è¦<strong>åˆå§‹åŒ–</strong>ï¼Œå¾—å‡ºç±»åŠ è½½çš„æ—¶æœºã€‚</p>
<h2 id="æœ‰ä¸”åªæœ‰5ç§æƒ…å†µéœ€è¦å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–"><a class="header-anchor" href="#æœ‰ä¸”åªæœ‰5ç§æƒ…å†µéœ€è¦å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–">Â¶</a><strong>æœ‰ä¸”åªæœ‰5ç§æƒ…å†µ</strong>éœ€è¦å¯¹ç±»è¿›è¡Œåˆå§‹åŒ–</h2>
<ol>
<li><code>new</code>å®ä¾‹åŒ–å¯¹è±¡ã€è¯»å–æˆ–è®¾ç½®é™æ€å­—æ®µï¼ˆè¢«<strong>finalä¿®é¥°æ”¾å…¥å¸¸é‡æ± </strong>æ—¶é™¤å¤–ï¼‰ã€è°ƒç”¨ç±»çš„é™æ€æ–¹æ³• ï¼ˆä¸”ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼‰ã€‚</li>
<li>ä½¿ç”¨<code>java.lang.reflect</code>åŒ…çš„æ–¹æ³•å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨ï¼Œä¸”ç±»æ²¡æœ‰åˆå§‹åŒ–</li>
<li>åˆå§‹åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå¦‚æœçˆ¶ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–</li>
<li>å«mainæ–¹æ³•çš„ç±»ä¼šä¼˜å…ˆåˆå§‹åŒ–</li>
<li>å½“ä½¿ç”¨JDK1.7çš„åŠ¨æ€è¯­è¨€æ”¯æŒæ—¶ï¼Œå¦‚æœä¸€ä¸ª<code>java.lang.invoke.MethodHandle</code>å®ä¾‹æœ€åçš„è§£æç»“æœ<code>REF_getStaticã€REF_pubStaticã€REF_invokeStatic</code>çš„æ–¹æ³•å¥æŸ„ï¼Œå¹¶ä¸”è¿™ä¸ªå¥æŸ„å¯¹åº”çš„ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œä¼šè§¦å‘å…¶åˆå§‹åŒ–ã€‚ï¼ˆé»‘äººé—®å·ã€‚ã€‚ï¼‰</li>
</ol>
<h2 id="è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­"><a class="header-anchor" href="#è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­">Â¶</a>è¢«åŠ¨å¼•ç”¨çš„ä¾‹å­</h2>
<ul>
<li>ç”¨å­ç±»å¼•ç”¨çˆ¶ç±»çš„é™æ€å­—æ®µ<code>SubClass.value</code>(valueåœ¨çˆ¶ç±»ä¸­)ï¼Œåªä¼šåˆå§‹åŒ–çˆ¶ç±»ã€‚</li>
<li>é€šè¿‡æ•°ç»„æ¥å®šä¹‰å¼•ç”¨ç±»ï¼Œä¸ä¼šè§¦å‘æ¬¡ç±»çš„åˆå§‹åŒ–</li>
<li><code>final</code>ä¿®é¥°çš„é™æ€å¸¸é‡ä¼šå­˜å…¥å¸¸é‡æ± ï¼Œå¼•ç”¨å®ƒä¸ä¼šè§¦å‘åˆå§‹åŒ–(å¯ä»¥ä¸ä¸Šé¢çš„ç¬¬ä¸€ç§æƒ…å†µæ¯”è¾ƒ)</li>
</ul>
<h2 id="ä¸æ¥å£åˆå§‹åŒ–çš„æ¯”è¾ƒ"><a class="header-anchor" href="#ä¸æ¥å£åˆå§‹åŒ–çš„æ¯”è¾ƒ">Â¶</a>ä¸æ¥å£åˆå§‹åŒ–çš„æ¯”è¾ƒ</h2>
<ul>
<li>æ¥å£ä¸èƒ½ä½¿ç”¨static{}è¯­å¥å—ï¼Œä½†æœ‰<code>&lt;clinit&gt;()</code>ç±»æ„é€ å™¨</li>
<li>ä¸ç¬¬ä¸‰æ¡ä¸åŒï¼šåˆå§‹åŒ–ä¸€ä¸ªæ¥å£æ—¶ï¼Œå¦‚æœçˆ¶ç±»æ¥å£æ²¡æœ‰åˆå§‹åŒ–ï¼Œçˆ¶ç±»æ¥å£ä¸ä¼šåˆå§‹åŒ–ã€‚</li>
</ul>
<h1>ç±»åŠ è½½çš„è¿‡ç¨‹</h1>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/28/169c226c3ad50652?w=1339&amp;h=609&amp;f=png&amp;s=39162" alt></p>
<h2 id="åŠ è½½"><a class="header-anchor" href="#åŠ è½½">Â¶</a>åŠ è½½</h2>
<p>åœ¨åŠ è½½æœŸé—´è™šæ‹Ÿæœºå®Œæˆä»¥ä¸‹ä¸‰ä»¶äº‹ï¼š</p>
<ul>
<li>é€šè¿‡ç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ</li>
<li>é€šè¿‡è¿™ä¸ªäºŒè¿›åˆ¶æµä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®</li>
<li>åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„<code>java.lang.Class</code>å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ï¼ˆHotSpotè™šæ‹Ÿæœºä¸­Classå¯¹è±¡æ˜¯ åœ¨æ–¹æ³•åŒºä¸­ï¼‰</li>
</ul>
<h2 id="éªŒè¯"><a class="header-anchor" href="#éªŒè¯">Â¶</a>éªŒè¯</h2>
<ul>
<li>æ–‡ä»¶æ ¼å¼éªŒè¯</li>
<li>å…ƒæ•°æ®éªŒè¯</li>
<li>å­—èŠ‚ç éªŒè¯</li>
<li>ç¬¦å·å¼•ç”¨éªŒè¯</li>
</ul>
<h2 id="å‡†å¤‡"><a class="header-anchor" href="#å‡†å¤‡">Â¶</a>å‡†å¤‡</h2>
<p>ä¸ºç±»çš„å˜é‡ï¼ˆ<strong>staticä¿®é¥°</strong>ï¼‰åˆ†é…å†…å­˜å¹¶è®¾ç½®å˜é‡çš„åˆå§‹å€¼ã€‚è¿™äº›å˜é‡æ‰€ç”¨çš„å†…å­˜éƒ½åœ¨æ–¹æ³•åŒºä¸­åˆ†é…ã€‚</p>
<p>æ³¨æ„ï¼šè¿™é‡Œçš„åˆå§‹å€¼æ˜¯å…¶<strong>é»˜è®¤å€¼</strong>ã€‚å¦‚æœæ˜¯<code>static final</code>ä¿®é¥°ï¼Œå°±åˆå§‹åŒ–ä¸ºæŒ‡å®šå€¼ï¼Œå­˜åœ¨å¸¸é‡åŒºã€‚</p>
<h2 id="è§£æ"><a class="header-anchor" href="#è§£æ">Â¶</a>è§£æ</h2>
<p>å°†è™šæ‹Ÿæœºä¸­çš„<strong>ç¬¦å·å¼•ç”¨</strong>æ›¿æ¢ä¸º<strong>ç›´æ¥å¼•ç”¨</strong></p>
<p>ä¸»è¦çš„è§£æåŠ¨ä½œ</p>
<ul>
<li>ç±»æˆ–è€…æ¥å£çš„è§£æ</li>
<li>å­—æ®µè§£æ</li>
<li>ç±»æ–¹æ³•çš„è§£æ</li>
<li>æ¥å£æ–¹æ³•çš„è§£æ</li>
</ul>
<h2 id="åˆå§‹åŒ–"><a class="header-anchor" href="#åˆå§‹åŒ–">Â¶</a>åˆå§‹åŒ–</h2>
<p>æ‰§è¡Œ<code>&lt;clinit&gt;()</code>æ–¹æ³•çš„è¿‡ç¨‹ã€‚å’Œ<code>&lt;init&gt;()</code>æ¯”è¾ƒä¸‹ï¼š</p>
<ul>
<li><code>&lt;clinit&gt;()</code>ï¼šç±»çš„åˆå§‹åŒ–ï¼Œç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—åˆå¹¶ä¸€èµ·ã€‚</li>
<li><code>&lt;init&gt;()</code>ï¼šç±»çš„å®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ˜¯ç±»çš„æ„é€ æ–¹æ³•ã€‚åˆå§‹åŒ–å®ä¾‹ç”¨çš„ã€‚</li>
</ul>
<p>ä¸€äº›ç»†èŠ‚ï¼š</p>
<ul>
<li>å®šä¹‰åœ¨é™æ€è¯­å¥å—åé¢çš„å˜é‡ï¼Œé™æ€è¯­å¥å—å¯ä»¥èµ‹å€¼ä½†ä¸èƒ½è®¿é—®ã€‚å¦‚æœè®¿é—®ä¼šæŠ¥é”™â€œ<strong>éæ³•å‰å‘å¼•ç”¨</strong>â€ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class Clinit &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        i = 0;</span><br><span class="line">        // System.out.println(i); // éæ³•å‰å‘å¼•ç”¨</span><br><span class="line">    &#125;</span><br><span class="line">    static int i = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¼˜å…ˆæ‰§è¡Œçˆ¶ç±»çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•</li>
<li>æ¥å£çš„çˆ¶ç±»<code>&lt;clinit&gt;()</code>æ–¹æ³•ä¸éœ€è¦å…ˆæ‰§è¡Œï¼Œå¹¶ä¸”æ¥å£çš„å®ç°ç±»åœ¨åˆå§‹åŒ–æ—¶ä¹Ÿä¸ä¼šæ‰§è¡Œæ¥å£çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•ã€‚</li>
<li>å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¼šæ‰§è¡Œç±»çš„<code>&lt;clinit&gt;()</code>æ–¹æ³•ã€‚</li>
</ul>
<h1>ç±»åŠ è½½å™¨</h1>
<p>ç±»åŠ è½½å™¨å¹²çš„äº‹ï¼šé€šè¿‡ç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚åªæœ‰è¢«åŒä¸€ä¸ªç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»æ‰æœ‰å¯èƒ½ç›¸ç­‰ã€‚</p>
<p>ä¼˜åŠ¿ï¼š<strong>ç±»å±‚æ¬¡åˆ’åˆ†</strong>ã€OSGiã€çƒ­éƒ¨ç½²ã€<strong>ä»£ç åŠ å¯†</strong> ç­‰ç­‰ã€‚</p>
<p>ç±»åŠ è½½å™¨åˆ†ç±»</p>
<ul>
<li>å¯åŠ¨ç±»åŠ è½½å™¨ï¼šc++å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºç­‰ä¸€éƒ¨åˆ†ï¼ŒåŠ è½½<code>&lt;JAVA_HOME&gt;/lib</code>ç›®å½•ä¸‹çš„ç±»</li>
<li>æ‰©å±•ç±»åŠ è½½å™¨ï¼šåŠ è½½<code>&lt;JAVA_HOME&gt;/lib/ext</code>ç›®å½•ä¸‹çš„ç±»</li>
<li>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼šåŠ è½½ç”¨æˆ·è·¯å¾„ä¸ŠæŒ‡å®šçš„ç±»åº“</li>
<li>è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨</li>
</ul>
<h2 id="åŒäº²å§”æ´¾æ¨¡å‹"><a class="header-anchor" href="#åŒäº²å§”æ´¾æ¨¡å‹">Â¶</a>åŒäº²å§”æ´¾æ¨¡å‹</h2>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/28/169c226f3fdffe17?w=468&amp;h=359&amp;f=png&amp;s=122552" alt></p>
<ul>
<li>è¦æ±‚ï¼šé™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚</li>
<li>è¿‡ç¨‹ï¼šå°±æ˜¯æŠŠåŠ è½½çš„æ´»<strong>æ¨æ‹–</strong>ç»™çˆ¶ç±»åŠ è½½å™¨ï¼Œä¸€ç›´æ¨åˆ°æœ€é¡¶å±‚ã€‚ç„¶åè®©æœ€é¡¶å±‚åŠ è½½å™¨åŠ è½½ï¼Œå¦‚æœå®ƒå¹²ä¸äº†ï¼Œå†é€’ç»™å­ï¼Œç›´åˆ°æ¨ç»™å‘èµ·è€…ï¼Œå¦‚æœå®ƒä¹Ÿå¹²ä¸äº†ï¼Œå°±å‘å‡º <code>ClassNotFoundException</code>å¼‚å¸¸ã€‚</li>
<li>ä¼˜ç‚¹ï¼šä½¿ç±»æœ‰ç±»å±‚æ¬¡æ€§ã€‚å¦‚åœ¨åŒäº²å§”æ´¾æ¨¡å‹ä¸‹ï¼ŒObjectç±»æ˜¯ç”±æœ€é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œæ‰€ä»¥å®ƒåœ¨æ¯ç§åŠ è½½å™¨ä¸­éƒ½æ˜¯åŒä¸€ä¸ªç±»ï¼Œä½¿Objectè¿™ä¸€æœ€åŸºç¡€çš„ç±»çš„æ€§èƒ½å¾—ä»¥ä¿è¯ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(4)-è™šæ‹Ÿæœºæ€§èƒ½ç›‘æ§ä¸æ•…éšœå¤„ç†å·¥å…·</title>
    <url>/2019/03/25/JVM-4-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ç¬¬å››ç« çš„ç¬”è®°</p>
<a id="more"></a>
<p>æˆ‘çš„JDKå·¥å…·åœ°å€</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">zxysMac:~ elwg$ <span class="built_in">cd</span> /Library/Java/JavaVirtualMachines/jdk1.8.0_161.jdk/Contents/Home/bin</span><br><span class="line">zxysMac:bin elwg$ ls</span><br><span class="line">appletviewer	javah		jjs		jvisualvm	schemagen</span><br><span class="line">extcheck	javap		jmap		keytool		serialver</span><br><span class="line">idlj		javapackager	jmc		native2ascii	servertool</span><br><span class="line">jar		jcmd		jps		orbd		tnameserv</span><br><span class="line">jarsigner	jconsole	jrunscript	pack200		unpack200</span><br><span class="line">java		jdb		jsadebugd	policytool	wsgen</span><br><span class="line">javac		jdeps		jstack		rmic		wsimport</span><br><span class="line">javadoc		jhat		jstat		rmid		xjc</span><br><span class="line">javafxpackager	jinfo		jstatd		rmiregistry</span><br></pre></td></tr></table></figure>
<h1>JDKçš„å‘½ä»¤è¡Œå·¥å…·</h1>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>å…¨å</th>
<th>ä¸»è¦åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
<td>jps</td>
<td>JVM Process Status</td>
<td>æ˜¾ç¤ºæŒ‡å®šç³»ç»Ÿçš„æ‰€æœ‰çš„è™šæ‹Ÿæœºè¿›ç¨‹</td>
</tr>
<tr>
<td>jstat</td>
<td>JVM Statistics Monitoring Tool</td>
<td>ç”¨äºæ”¶é›†è™šæ‹Ÿæœºå„æ–¹é¢çš„è¿è¡Œæ•°æ®</td>
</tr>
<tr>
<td>jinfo</td>
<td>Configuration Info for Java</td>
<td>æ˜¾ç¤ºè™šæ‹Ÿæœºé…ç½®ä¿¡æ¯</td>
</tr>
<tr>
<td>jmap</td>
<td>Memory Map for Java</td>
<td>ç”Ÿæˆè™šæ‹Ÿæœºçš„å†…å­˜è½¬å‚¨å¿«ç…§ï¼ˆheapdumpæ–‡ä»¶ï¼‰</td>
</tr>
<tr>
<td>jhat</td>
<td>JVM Heap Dump Browser</td>
<td>ç”¨äºåˆ†æheapdumpæ–‡ä»¶</td>
</tr>
<tr>
<td>jstack</td>
<td>Stack Trace for Java</td>
<td>æ˜¾ç¤ºè™šæ‹Ÿæœºçš„çº¿ç¨‹å¿«ç…§</td>
</tr>
</tbody>
</table>
<h2 id="jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·"><a class="header-anchor" href="#jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·">Â¶</a>jpsï¼šè™šæ‹Ÿæœºè¿›ç¨‹çŠ¶å†µå·¥å…·</h2>
<ul>
<li>
<p>åŠŸèƒ½ï¼šå¯ä»¥åˆ—å‡ºè¿è¡Œçš„è™šæ‹Ÿæœºè¿›ç¨‹ã€çœ‹åˆ°è™šæ‹Ÿæœºæ‰§è¡Œçš„ä¸»ç±»ã€æœ¬åœ°è™šæ‹Ÿæœºå”¯ä¸€ID</p>
</li>
<li>
<p>å‘½ä»¤æ ¼å¼ï¼š<br>
<code>jps [ option ] [ hostid ]</code></p>
</li>
<li>
<p>ä¸»è¦é€‰é¡¹ï¼š</p>
</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/23/169a9a09b0013234?w=918&amp;h=205&amp;f=png&amp;s=96305" alt></p>
<ul>
<li>ä¾‹å­ï¼šæˆ‘åœ¨IDEAä¸­è¿è¡Œåˆ—ä¸€ä¸ªjavaæ–‡ä»¶ï¼Œæµ‹è¯•å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(base) zxysMac:~ elwg$ jps -l</span><br><span class="line">16387 org.jetbrains.idea.maven.server.RemoteMavenServer</span><br><span class="line">44422 sun.tools.jps.Jps</span><br><span class="line">44392 com.zouxxyy.jvm.chap4.JpsTest</span><br><span class="line">31368 org.jetbrains.kotlin.daemon.KotlinCompileDaemon</span><br><span class="line">16217</span><br><span class="line">44393 org.jetbrains.jps.cmdline.Launcher</span><br></pre></td></tr></table></figure>
<h2 id="jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·"><a class="header-anchor" href="#jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·">Â¶</a>jstatï¼šè™šæ‹Ÿæœºç»Ÿè®¡ä¿¡æ¯ç›‘è§†å·¥å…·</h2>
<ul>
<li>åŠŸèƒ½ï¼šå¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„ç±»è£…è½½ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JITç¼–è¯‘ç­‰è¿è¡Œæ•°æ®</li>
<li>å‘½ä»¤æ ¼å¼ï¼š<code>jstat [ option vmid [interval[s|ms] [count]] ]</code></li>
<li>ä¸»è¦é€‰é¡¹ï¼š</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/23/169a9aa3cfd87699?w=923&amp;h=459&amp;f=png&amp;s=275718" alt></p>
<h2 id="jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·"><a class="header-anchor" href="#jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·">Â¶</a>jinfoï¼šJavaé…ç½®ä¿¡æ¯å·¥å…·</h2>
<ul>
<li>
<p>åŠŸèƒ½ï¼šå®æ—¶æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºå„é¡¹å‚æ•°</p>
</li>
<li>
<p>å‘½ä»¤æ ¼å¼ï¼š<code>jinfo [ option ] pid</code></p>
</li>
<li>
<p>ä¾‹å­ï¼šçœ‹æœ‰æ²¡æœ‰ç”¨SerialGC</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(base) zxysMac:~ elwg$ jinfo -flag UseSerialGC 46521</span><br><span class="line">-XX:-UseSerialGC</span><br></pre></td></tr></table></figure>
<h2 id="jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·"><a class="header-anchor" href="#jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·">Â¶</a>jmapï¼šJavaå†…å­˜æ˜ åƒå·¥å…·</h2>
<ul>
<li>åŠŸèƒ½ï¼šç”Ÿæˆè™šæ‹Ÿæœºå †å­˜è½¬å‚¨å¿«ç…§ï¼ˆheapdumpæ–‡ä»¶ï¼‰</li>
<li>å‘½ä»¤æ ¼å¼ï¼š<code>jmap [ option] vmid</code></li>
<li>ä¸»è¦é€‰é¡¹ï¼š</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/23/169a9b5409980aff?w=933&amp;h=403&amp;f=png&amp;s=202391" alt></p>
<h2 id="jhatï¼šè™šæ‹Ÿæœºå †å¿«ç…§åˆ†æå·¥å…·"><a class="header-anchor" href="#jhatï¼šè™šæ‹Ÿæœºå †å¿«ç…§åˆ†æå·¥å…·">Â¶</a>jhatï¼šè™šæ‹Ÿæœºå †å¿«ç…§åˆ†æå·¥å…·</h2>
<p>ä¸jmapé…åˆä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯åˆ†æå †å­˜è½¬å‚¨å¿«ç…§ï¼ˆheapdumpæ–‡ä»¶ï¼‰ã€‚</p>
<h2 id="jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·"><a class="header-anchor" href="#jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·">Â¶</a>jstackï¼šJavaå †æ ˆè·Ÿè¸ªå·¥å…·</h2>
<ul>
<li>åŠŸèƒ½ï¼šç”¨äºç”Ÿæˆè™šæ‹Ÿæœºçš„çº¿ç¨‹å¿«ç…§</li>
<li>å‘½ä»¤æ ¼å¼ï¼š<code>jstack [ option ] vmid</code></li>
<li>ä¸»è¦é€‰é¡¹ï¼š</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/23/169a9b95790bdcd5?w=920&amp;h=188&amp;f=png&amp;s=81541" alt></p>
<h1>JDKçš„å¯è§†åŒ–å·¥å…·</h1>
<h2 id="JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°"><a class="header-anchor" href="#JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°">Â¶</a>JConsoleï¼šJavaç›‘è§†ä¸ç®¡ç†æ§åˆ¶å°</h2>
<p><strong>å†…å­˜ç›‘æ§ï¼Œç›¸å½“äºå¯è§†åŒ–çš„<code>jstat</code>å‘½ä»¤</strong></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/25/169b291ef7f36929?w=858&amp;h=628&amp;f=png&amp;s=106536" alt><br>
<strong>çº¿ç¨‹ç›‘æ§ï¼Œç›¸å½“äºå¯è§†åŒ–çš„<code>jstack</code>å‘½ä»¤</strong>ï¼Œä»¥ä¸‹ä¸¾å‡ ä¸ªç®€å•çš„ä¾‹å­</p>
<ul>
<li>ç›‘å¬ç”¨æˆ·é”®ç›˜è¾“å…¥</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/25/169b2a74ba142acd?w=811&amp;h=134&amp;f=png&amp;s=29000" alt></p>
<ul>
<li>ç›‘å¬wait()</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/25/169b2a7c8556a816?w=819&amp;h=206&amp;f=png&amp;s=45681" alt></p>
<ul>
<li>ç›‘å¬æ­»é”</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/25/169b2bdcdb14d52d?w=844&amp;h=306&amp;f=png&amp;s=35573" alt></p>
<h2 id="VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·"><a class="header-anchor" href="#VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·">Â¶</a>VisualVMï¼šå¤šåˆä¸€æ•…éšœå¤„ç†å·¥å…·</h2>
<p>ä¹¦ä¸Šè¯´å®ƒå¾ˆå¼ºå¤§ï¼Œæˆ‘è¿˜æ²¡ä¸‹è½½æˆåŠŸã€‚å®ƒå‡ ä¹é›†æˆé‡Œä¸Šé¢çš„æ‰€æœ‰åŠŸèƒ½å•Šã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/25/169b2e570ebb1cc5?w=1239&amp;h=665&amp;f=png&amp;s=126621" alt></p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(3)-åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥</title>
    <url>/2019/03/25/JVM-3-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E4%B8%8E%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ç¬¬ä¸‰ç« çš„ç¬”è®°</p>
<a id="more"></a>
<h1>å¦‚ä½•åˆ¤æ–­å¯¹è±¡ä¸ºåƒåœ¾å¯¹è±¡</h1>
<h2 id="å¼•ç”¨è®¡æ•°æ³•"><a class="header-anchor" href="#å¼•ç”¨è®¡æ•°æ³•">Â¶</a>å¼•ç”¨è®¡æ•°æ³•</h2>
<p>ç»™å¯¹è±¡æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸ªå¯¹è±¡å¼•ç”¨å®ƒæ—¶ï¼Œè®¡æ•°å™¨åŠ 1ï¼›å¼•ç”¨å¤±æ•ˆæ—¶è®¡æ•°å™¨å‡1ï¼›ä¸º0æ—¶å¯¹è±¡ä¸å¯èƒ½è¢«å†å¼•ç”¨ã€‚</p>
<p>æ²¡æœ‰ä½¿ç”¨çš„åŸå› ï¼šå¾ˆéš¾è§£å†³<strong>å¯¹è±¡ä¹‹é—´ç›¸äº’å¾ªç¯å¼•ç”¨</strong>çš„é—®é¢˜</p>
<h2 id="å¯è¾¾æ€§åˆ†æç®—æ³•"><a class="header-anchor" href="#å¯è¾¾æ€§åˆ†æç®—æ³•">Â¶</a>å¯è¾¾æ€§åˆ†æç®—æ³•</h2>
<p>çœ‹ä½œä¸ºGC Rootsçš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œå’Œ<strong>å®ƒè¿é€šçš„æ˜¯å¯ç”¨çš„ï¼Œåä¹‹ä¸å¯ç”¨</strong>ã€‚</p>
<p>å¦‚ä¸‹æƒ…å†µçš„å¯¹è±¡å¯ä»¥ä½œä¸ºGC Rootsï¼š</p>
<ul>
<li>è™šæ‹Ÿæœºæ ˆ(æ ˆæ¡¢ä¸­çš„æœ¬åœ°å˜é‡è¡¨)ã€æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆNativeæ–¹æ³•ï¼‰ä¸­çš„å¼•ç”¨çš„å¯¹è±¡</li>
<li>æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡</li>
<li>æ–¹æ³•åŒºä¸­çš„å¸¸é‡å¼•ç”¨çš„å¯¹è±¡</li>
</ul>
<p>å½“å¯¹è±¡ä¸å¯è¾¾æ—¶ï¼Œä¼šæ‰§è¡Œ<code>fianlize()</code>ï¼Œä½†è¯¥æ–¹æ³•è‡ªä¼šè¢«è‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡ï¼Œæœ‰ç‚¹åƒc++çš„ææ„å‡½æ•°ï¼Œä¹¦ä¸Šè¯´æœ€å¥½åˆ«ç”¨ã€‚</p>
<h2 id="å¼•ç”¨çš„åˆ†ç±»"><a class="header-anchor" href="#å¼•ç”¨çš„åˆ†ç±»">Â¶</a>å¼•ç”¨çš„åˆ†ç±»</h2>
<ul>
<li>å¼ºå¼•ç”¨ï¼š<code>Objece obj = new Object()</code>ï¼Œæ°¸è¿œä¸ä¼šè¢«åƒåœ¾æœé›†å›æ”¶</li>
<li>è½¯å¼•ç”¨ï¼š<code>SoftReference</code>ç±»å®ç°ï¼Œå¯ä»¥å­˜æ´»ç¬¬ä¸€æ¬¡å›æ”¶ï¼Œä½†ç¬¬äºŒæ¬¡å°±GG</li>
<li>å¼±å¼•ç”¨ï¼š<code>WeakReference</code>ç±»å®ç°ï¼Œç¬¬ä¸€æ¬¡å°±GG</li>
<li>è™šå¼•ç”¨ï¼š<code>PhantomReference</code>ç±»å®ç°ï¼Œ<strong>ä¸èƒ½é€šè¿‡å®ƒå–å¾—å®ä¾‹</strong>ï¼Œå”¯ä¸€ä½œç”¨å°±æ˜¯å½“è¯¥å¯¹è±¡è¢«å›æ”¶æ—¶ä¼šæ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚</li>
</ul>
<h1>å¦‚ä½•å›æ”¶</h1>
<h2 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a class="header-anchor" href="#åƒåœ¾æ”¶é›†ç®—æ³•">Â¶</a>åƒåœ¾æ”¶é›†ç®—æ³•</h2>
<ul>
<li>æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼šï¼ˆè€å¹´ä»£ï¼‰å…ˆæ ‡è®°ï¼Œå†æ¸…é™¤ã€‚ç¼ºç‚¹ï¼šæ•ˆç‡ä½ï¼Œå†…å­˜ç¢ç‰‡åŒ–</li>
<li>å¤åˆ¶ç®—æ³•ï¼šï¼ˆæ–°ç”Ÿä»£ï¼‰HotSpotè™šæ‹ŸæœºæŠŠå†…å­˜åˆ†ä¸ºEdenå’Œ2å—SurvivoråŒºï¼ŒæŠŠåœ¨Edenå’ŒSurvivorä¸­ å­˜æ´»çš„å¯¹è±¡ å¤åˆ¶åˆ°ç©ºé—²çš„ä¸€å—Survivorä¸­ã€‚ä¸å¤Ÿæ—¶å¯ä»¥å‘è€å¹´ä»£æ‹…ä¿ã€‚</li>
<li>æ ‡è®°-æ•´ç†ç®—æ³•ï¼šï¼ˆè€å¹´ä»£ï¼‰æ ‡è®° -&gt; ç§»åŠ¨åˆ°ä¸€èµ· -&gt; æ¸…ç†</li>
<li>åˆ†ä»£æ”¶é›†ç®—æ³•ï¼šæŠŠå†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚æ ¹æ®å¹´ä»£é€‰åˆ™åˆé€‚çš„ç®—æ³•ã€‚</li>
</ul>
<h2 id="åƒåœ¾æ”¶é›†å™¨"><a class="header-anchor" href="#åƒåœ¾æ”¶é›†å™¨">Â¶</a>åƒåœ¾æ”¶é›†å™¨</h2>
<table>
<thead>
<tr>
<th>æ–°ç”Ÿä»£</th>
<th>è€å¹´ä»£</th>
<th>ç‰¹æ®Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>Serialï¼ˆå•çº¿ç¨‹ï¼‰</td>
<td>Serial Oldï¼ˆå•çº¿ç¨‹ï¼ŒCMSå¤‡èƒï¼‰</td>
<td>G1ï¼ˆRegionä¼˜å…ˆçº§å›æ”¶ï¼‰</td>
</tr>
<tr>
<td>ParNewï¼ˆå¤šçº¿ç¨‹ï¼‰</td>
<td>CMSï¼ˆå¹¶å‘ï¼‰</td>
<td></td>
</tr>
<tr>
<td>Parallel Scavengeï¼ˆå…³æ³¨ååé‡ï¼‰</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>å¹¶è¡Œï¼ˆParallelï¼‰ï¼šå¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶ç”¨æˆ·çº¿ç¨‹ä»å¤„äºç­‰å¾…çŠ¶æ€ã€‚</li>
<li>å¹¶å‘ï¼ˆConcurrentï¼‰ï¼šç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚</li>
</ul>
<h1>å¦‚ä½•åˆ†é…</h1>
<p>ä»¥HosSpotæ”¶é›†å™¨çš„åˆ†é…å’Œå›æ”¶ç­–ç•¥ä¸ºä¾‹</p>
<ul>
<li>ä¼˜å…ˆåˆ†é…åœ¨Eden</li>
<li><strong>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</strong></li>
<li>é•¿æœŸå­˜æ´»çš„å¯¹è±¡è¿›å…¥è€å¹´ä»£</li>
<li>åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤å®š</li>
<li>ç©ºé—´åˆ†é…æ‹…ä¿</li>
</ul>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>IntelliJ IDEA å®ç”¨å¿«æ·é”®</title>
    <url>/2019/03/22/IntelliJ-IDEA-%E5%AE%9E%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/</url>
    <content><![CDATA[<p>IntelliJ IDEA çš„å°æŠ€å·§ ï¼ˆ mac ç‰ˆï¼‰</p>
<a id="more"></a>
<h1>ç ä»£ç </h1>
<ol>
<li><strong>ç¼©å†™åŠŸèƒ½</strong></li>
</ol>
<p>ä¸€èˆ¬å–é¦–å­—æ¯å³å¯</p>
<p>å¦‚ <code>public static void main(String[] args){}</code>å¯ä»¥ç”¨ <code>psvm</code>å‡ºæ¥</p>
<ol start="2">
<li><strong>åŠ  surroundï¼Œå¦‚ ifã€catch</strong></li>
</ol>
<p>é€‰ä¸­ç›®æ ‡ä»£ç æ®µ <code>command + option + t</code> å†é€‰æ‹© surround ç±»å‹</p>
<ol start="3">
<li><strong>æ ¼å¼åŒ–ä»£ç </strong></li>
</ol>
<p>é€‰ä¸­ç›®æ ‡ä»£ç æ®µ <code>command + option + l</code></p>
<ol start="3">
<li><strong>åˆ é™¤ä¸€è¡Œ</strong></li>
</ol>
<p><code>command + d</code></p>
<h1>è°ƒè¯•</h1>
<ol>
<li><strong>è·³è½¬åˆ°ä¸Šï¼ˆä¸‹ï¼‰ä¸€æ¬¡ä½ç½®</strong></li>
</ol>
<p>ä¸Šä¸€æ¬¡ <code>command + option + â† </code></p>
<p>ä¸‹ä¸€æ¬¡ <code>command + option + â†’ </code></p>
<ol start="2">
<li><strong>æŸ¥çœ‹ç±»ç»§æ‰¿å…³ç³»</strong></li>
</ol>
<p>é€‰ä¸­ç±»å <code>control + h</code></p>
<ol start="3">
<li><strong>æŸ¥çœ‹ç±»æˆ–è€…æ–¹æ³•çš„è°ƒç”¨æƒ…å†µ</strong></li>
</ol>
<p>é€‰ä¸­ç±»æˆ–è€…æ–¹æ³•å <code>control + option + h</code></p>
<p>æˆ–è€… <code>command + å·¦é”®</code></p>
<ol start="4">
<li><strong>å…¨å±€æŸ¥æ‰¾æ–‡ä»¶</strong></li>
</ol>
<p><code>shift + shift</code></p>
<ol start="5">
<li><strong>å…¨å±€æŸ¥æ‰¾å†…å®¹</strong></li>
</ol>
<p><code>command + shift + f</code></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>IDEA</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM(2)-Javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºå¼‚å¸¸</title>
    <url>/2019/03/22/JVM-2-Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E4%B8%8E%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA%E5%BC%82%E5%B8%B8/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬äºŒç‰ˆï¼‰ã€‹ç¬¬äºŒç« çš„ç¬”è®°</p>
<a id="more"></a>
<h1>è¿è¡Œæ—¶æ•°æ®åŒºåŸŸ</h1>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/21/1699e42932e70b62?w=652&amp;h=625&amp;f=png&amp;s=45434" alt><br>
æˆ‘ä»¬è¿™èŠ‚å…³æ³¨ä¸­é—´ç°è‰²éƒ¨åˆ†ï¼Œæ³¨æ„ç»¿è‰²éƒ¨åˆ†<strong>çº¿ç¨‹å…±äº«</strong>ï¼Œé»„è‰²éƒ¨åˆ†<strong>çº¿ç¨‹ç§æœ‰</strong></p>
<h2 id="ç¨‹åºè®¡æ•°å™¨"><a class="header-anchor" href="#ç¨‹åºè®¡æ•°å™¨">Â¶</a>ç¨‹åºè®¡æ•°å™¨</h2>
<p>ä¸€å—è¾ƒå°çš„å†…å­˜ï¼Œæ˜¯<strong>å½“å‰çº¿ç¨‹</strong>ï¼ˆçº¿ç¨‹ç§æœ‰ï¼‰æ‰§è¡Œçš„å­—èŠ‚ç çš„<strong>è¡Œå·æŒ‡ç¤ºå™¨</strong>ã€‚</p>
<ul>
<li>å¦‚æœæ‰§è¡Œçš„æ˜¯Javaæ–¹æ³•ï¼Œè®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼›å¦‚æœæ˜¯Nativeï¼ˆæœ¬åœ°æ–¹æ³•ï¼‰ï¼Œè®¡æ•°å™¨å€¼ä¸ºç©º(Undefined)</li>
<li>å”¯ä¸€æ²¡æœ‰<code>OutOfMemoryError</code>çš„åŒºåŸŸ</li>
</ul>
<h2 id="Javaè™šæ‹Ÿæœºæ ˆ"><a class="header-anchor" href="#Javaè™šæ‹Ÿæœºæ ˆ">Â¶</a>Javaè™šæ‹Ÿæœºæ ˆ</h2>
<p>è™šæ‹Ÿæœºæ ˆæ˜¯æè¿°Javaæ–¹æ³•æ‰§è¡Œçš„å†…å­˜æ¨¡å‹</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/21/1699f1c41f3b3ba5?w=551&amp;h=419&amp;f=png&amp;s=23533" alt><br>
æ¯ä¸ªæ–¹æ³•è°ƒç”¨è‡³å®Œæˆï¼Œå¯¹åº”ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚</p>
<p>å±€éƒ¨å˜é‡è¡¨ï¼š</p>
<ul>
<li>å­˜æ”¾<strong>åŸºæœ¬æ•°æ®ç±»å‹</strong>ã€<strong>å¯¹è±¡å¼•ç”¨</strong>ã€<strong>returnAddress</strong></li>
<li>å±€éƒ¨å˜é‡è¡¨æ‰€éœ€çš„å†…å­˜ç©ºé—´åœ¨<strong>ç¼–è¯‘æœŸ</strong>å®Œæˆï¼Œè¯¥ç©ºé—´æ˜¯ç¡®å®šçš„ï¼Œæ–¹æ³•è¿è¡ŒæœŸé—´<strong>ä¸æ”¹å˜</strong>ã€‚</li>
</ul>
<p>ä¸¤ç§å¼‚å¸¸ï¼š</p>
<ul>
<li><code>StackOverflowError</code>: è¯·æ±‚çš„æ ˆæ·±åº¦è¶…è¿‡å…è®¸èŒƒå›´</li>
<li><code>OutOfMemoryError</code>: éœ€è¦çš„å†…å­˜è¶…è¿‡å…è®¸èŒƒå›´</li>
</ul>
<h2 id="æœ¬åœ°æ–¹æ³•æ ˆ"><a class="header-anchor" href="#æœ¬åœ°æ–¹æ³•æ ˆ">Â¶</a>æœ¬åœ°æ–¹æ³•æ ˆ</h2>
<p>æœ¬åœ°æ–¹æ³•æ ˆæ˜¯æè¿°<strong>æœ¬åœ°æ–¹æ³•</strong>æ‰§è¡Œçš„å†…å­˜æ¨¡å‹ã€‚å®ƒå’ŒJavaè™šæ‹Ÿæœºæ ˆå¾ˆç±»ä¼¼ï¼ŒåŒºåˆ«å°±æ˜¯å®ƒæ˜¯ä¸ºæœ¬åœ°æ–¹æ³•æœåŠ¡çš„ã€‚</p>
<h2 id="Javaå †"><a class="header-anchor" href="#Javaå †">Â¶</a>Javaå †</h2>
<p>å­˜æ”¾å¯¹è±¡ç¤ºä¾‹ï¼Œä¹Ÿç§°ä½œï¼ˆGCå †ï¼‰ï¼Œæ˜¯åƒåœ¾å›æ”¶å™¨ç®¡ç†çš„ä¸»è¦åŒºåŸŸã€‚</p>
<ul>
<li>ç»†åˆ† æ–°ç”Ÿä»£ã€è€ç”Ÿä»£ï¼›Edenç©ºé—´ã€From Survivorç©ºé—´ã€To Survivorç©ºé—´ç­‰</li>
<li>çº¿ç¨‹å…±äº«çš„å †é‡Œå¯èƒ½åˆ’åˆ†å‡ºç§æœ‰çš„åˆ†é…ç¼“å†²åŒºï¼ˆTLABï¼‰ã€‚</li>
</ul>
<h2 id="æ–¹æ³•åŒº"><a class="header-anchor" href="#æ–¹æ³•åŒº">Â¶</a>æ–¹æ³•åŒº</h2>
<p>å­˜å‚¨<strong>å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯</strong>ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚</p>
<p><strong>è¿è¡Œæ—¶å¸¸é‡æ± </strong> ï¼š<br>
å­˜æ”¾ç¼–è¯‘å™¨ç”Ÿæˆçš„å„ç§å­—é¢å¸¸é‡å’Œç¬¦å·å¼•ç”¨ã€‚</p>
<p>ä¾‹å­ï¼šStringç±»åœ¨å¸¸é‡æ± çš„æ•°æ®ç»“æ„ç±»ä¼¼äºHashSet,æ˜¯å”¯ä¸€çš„ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/21/169a02588d5caac4?w=612&amp;h=354&amp;f=png&amp;s=27965" alt></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String s1 = <span class="string">"abc"</span>;</span><br><span class="line">String s2 = <span class="string">"abc"</span>; <span class="comment">// å­˜æ”¾åœ¨æ–¹æ³•åŒºçš„å¸¸é‡æ± ï¼ˆå­—èŠ‚ç å¸¸é‡ï¼‰å”¯ä¸€</span></span><br><span class="line"></span><br><span class="line">System.out.println(s1 == s2); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">String s3 = <span class="keyword">new</span> String(<span class="string">"abc"</span>); <span class="comment">// ç”¨äº†newï¼Œæ‰€ä»¥åœ¨å †ä¸­åˆ›å»º</span></span><br><span class="line"></span><br><span class="line">System.out.println(s1 == s3); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">System.out.println(s1 == s3.intern()); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„å“¦jdk1.8 Stringå¸¸é‡æ± æ¬åˆ°äº†å †ä¸­ã€‚å¦‚æœæƒ³å¯¹<code>intern()</code>äº†è§£æ›´å¤šï¼Œå¯ä»¥çœ‹æˆ‘çš„è¿™ç¯‡<a href="https://zouxxyy.github.io/2019/03/22/JDK1-8-String%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%AF%A6%E8%A7%A3/#more" target="_blank" rel="noopener">åšå®¢</a>ã€‚</p>
<h1>HotSpotå¯¹è±¡æ­ç§˜</h1>
<h2 id="å¯¹è±¡åˆ›å»º"><a class="header-anchor" href="#å¯¹è±¡åˆ›å»º">Â¶</a>å¯¹è±¡åˆ›å»º</h2>
<p>å¯¹è±¡åˆ›å»ºç®€å•æè¿°ï¼š</p>
<p>new -&gt; æ ¹æ®å¸¸é‡æ± ä¸­ç¬¦å·çœ‹æ˜¯å¦éœ€è¦åŠ è½½ -&gt; ç±»åŠ è½½ -&gt; åˆ†é…å†…å­˜ -&gt; åˆå§‹åŒ– -&gt;æ„é€ æ–¹æ³•</p>
<p>ç»™å¯¹è±¡åˆ†é…å†…å­˜çš„ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>æŒ‡é’ˆç¢°æ’</li>
<li>ç©ºé—²åˆ—è¡¨</li>
</ul>
<p>è§£å†³åˆ›å»ºå¯¹è±¡æ—¶çº¿ç¨‹å®‰å…¨é—®é¢˜ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>åˆ†é…å†…å­˜åŠ¨ä½œè¿›è¡ŒåŒæ­¥å¤„ç†</li>
<li>TLABï¼ˆå…±äº«å †ä¸­æŒ‰çº¿ç¨‹åˆ’åˆ†çš„çº¿ç¨‹ç§æœ‰éƒ¨åˆ†ï¼‰ä¸Šåˆ†é…ï¼Œå®ƒåˆ†é…å®Œï¼Œå†åŒæ­¥é”å®š</li>
</ul>
<h2 id="å¯¹è±¡çš„å†…å­˜å¸ƒå±€"><a class="header-anchor" href="#å¯¹è±¡çš„å†…å­˜å¸ƒå±€">Â¶</a>å¯¹è±¡çš„å†…å­˜å¸ƒå±€</h2>
<p>3å—åŒºåŸŸï¼š</p>
<ul>
<li>
<p>å¯¹è±¡å¤´</p>
<ul>
<li>è‡ªèº«è¿è¡Œæ—¶çš„æ•°æ®ï¼ˆMarkWordï¼‰ï¼šHashCodeã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰é”ã€åå‘çº¿ç¨‹IDã€åå‘æ—¶é—´æˆ³ç­‰</li>
<li>ç±»å‹æŒ‡é’ˆï¼šå¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºå¯ä»¥æ ¹æ®å®ƒæ¥ç¡®å®šè¯¥å¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚</li>
</ul>
<p>æ³¨æ„å¦‚æœå¯¹è±¡æ˜¯æ•°ç»„ï¼Œé‚£ä¹ˆå¯¹è±¡å¤´ä¸­è¿˜æœ‰ä¸€å—ç”¨äºè®°å½•æ•°ç»„é•¿åº¦çš„æ•°æ®ã€‚</p>
</li>
<li>
<p>å®ä¾‹æ•°æ®</p>
</li>
<li>
<p>å¯¹é½å¡«å…… ï¼šå½“å®ä¾‹éƒ¨åˆ†æ²¡å¯¹é½æ—¶ï¼Œé€šè¿‡å¯¹é½å¡«å……æ¥è¡¥å…¨</p>
</li>
</ul>
<h2 id="å¯¹è±¡çš„è®¿é—®å®šä½"><a class="header-anchor" href="#å¯¹è±¡çš„è®¿é—®å®šä½">Â¶</a>å¯¹è±¡çš„è®¿é—®å®šä½</h2>
<ul>
<li>å¥æŸ„è®¿é—®ï¼ˆ2çº§æŒ‡é’ˆï¼‰</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/21/169a038a164fdc67?w=604&amp;h=404&amp;f=png&amp;s=33178" alt><br>
å¯ä»¥çœ‹å‡ºæ¥è¦åˆ°å®ä¾‹æ•°æ®å¿…é¡»å†ç»è¿‡ä¸€ä¸ªæŒ‡é’ˆï¼Œè¿™ä¹ˆåšåˆ°å¥½å¤„æ˜¯ï¼Œå½“å¯¹è±¡ç§»åŠ¨æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¹å˜å±€æŸ„æ± é‡Œçš„æŒ‡é’ˆï¼Œä¸éœ€è¦æ”¹å˜referenceï¼›ç¼ºç‚¹æ˜¯é€Ÿåº¦æ…¢ã€‚</p>
<ul>
<li>ç›´æ¥æŒ‡é’ˆ</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/21/169a038c26fd8733?w=602&amp;h=408&amp;f=png&amp;s=28283" alt><br>
ç›´æ¥æŒ‡é’ˆé¡¾åæ€ä¹‰ç›´æ¥æŒ‡å‘å®ä¾‹æ•°æ®ï¼Œå¥½å¤„æ˜¯é€Ÿåº¦å¿«ï¼›ç¼ºç‚¹å°±æ˜¯å¯¹è±¡ç§»åŠ¨è¦æ”¹referenceã€‚</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>JDK1.8 Stringå¸¸é‡æ± è¯¦è§£</title>
    <url>/2019/03/22/JDK1-8-String%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ JDK1.8 Stringå¸¸é‡æ± è¯¦è§£ï¼Œå¸¦å›¾å“¦</p>
<a id="more"></a>
<p><strong>jdk 1.8</strong></p>
<h1>å…ˆæŠ›ç»“è®º</h1>
<h2 id="1-åªåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¸¸é‡"><a class="header-anchor" href="#1-åªåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¸¸é‡">Â¶</a>1.åªåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¸¸é‡</h2>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/22/169a32568b4c1f09?w=531&amp;h=366&amp;f=png&amp;s=15995" alt></p>
<h2 id="2-åªåœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡"><a class="header-anchor" href="#2-åªåœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡">Â¶</a>2.åªåœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡</h2>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/22/169a32d01c0c56b4?w=577&amp;h=389&amp;f=png&amp;s=19131" alt></p>
<h2 id="3-åœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¸¸é‡"><a class="header-anchor" href="#3-åœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¸¸é‡">Â¶</a>3.åœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¸¸é‡</h2>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/22/169a32fd14b320a8?w=553&amp;h=362&amp;f=png&amp;s=18505" alt></p>
<h2 id="4-åœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¼•ç”¨"><a class="header-anchor" href="#4-åœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¼•ç”¨">Â¶</a>4.åœ¨å †ä¸Šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨å¸¸é‡æ± ä¸Šåˆ›å»ºå¼•ç”¨</h2>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/22/169a331a8ed3ecb4?w=561&amp;h=362&amp;f=png&amp;s=20883" alt></p>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>
<p>å¸¸é‡æ± æœ‰ä¸¤ç§æƒ…å†µï¼šå¼•ç”¨ï¼ˆæŒ‡é’ˆï¼‰ æˆ– å¸¸é‡ã€‚<strong>å¦‚æœè¯¥ä½ç½®å·²ç»æ˜¯å¼•ç”¨æˆ–å¸¸é‡äº†ï¼Œä¹‹åçš„æ“ä½œéƒ½ä¸ä¼šæ”¹å˜é‡Œé¢çš„æƒ…å†µï¼ï¼ï¼</strong></p>
</li>
<li>
<p>è°ƒç”¨<code>intern()</code>ï¼ˆjdk1.8ï¼‰: <strong>å¦‚æœå¸¸é‡æ± é‡Œæ˜¯ç©ºçš„ï¼Œå°±åˆ›å»ºå¼•ç”¨ï¼ˆæŒ‡å‘å †ï¼Œå‚è€ƒç»“è®º4ï¼‰ï¼›éç©ºï¼Œä¸æ“ä½œã€‚è¿”å›å€¼éƒ½æ˜¯å¸¸é‡æ± é‡Œçš„å†…å®¹ã€‚</strong></p>
</li>
<li>
<p>å †ä¸­å¯ä»¥æœ‰ä»»æ„ä¸ªç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œå¸¸é‡æ± åªèƒ½æœ‰ä¸€ä¸ªï¼ˆå¼•ç”¨ æˆ– å¸¸é‡ï¼‰ã€‚</p>
</li>
<li>
<p>&quot; &quot; å’Œintern() å…¶å®å¾ˆåƒã€‚åŒºåˆ«å°±æ˜¯åœ¨å¸¸é‡æ± ä¸ºç©ºæ—¶ï¼Œâ€œ â€æ˜¯æŠŠå€¼åŠ è¿›å»ï¼Œintern()æ˜¯æŠŠå¼•ç”¨åŠ è¿›å»ã€‚</p>
</li>
</ul>
<h1>æ ¹æ®ç»“è®ºè§£å†³ä¾‹å­</h1>
<h2 id="ä¾‹ä¸€"><a class="header-anchor" href="#ä¾‹ä¸€">Â¶</a>ä¾‹ä¸€</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String s1 = <span class="keyword">new</span> String(<span class="string">"zxy"</span>);    <span class="comment">// ç»“è®º3</span></span><br><span class="line">s1.intern(); <span class="comment">// å¸¸é‡æ± éç©ºï¼Œè¿”å›å€¼æ˜¯å¸¸é‡æ± é‡Œçš„å†…å®¹</span></span><br><span class="line">String s2 = <span class="string">"zxy"</span>; <span class="comment">// å¸¸é‡æ± éç©ºï¼Œè¿”å›å€¼æ˜¯å¸¸é‡æ± é‡Œçš„å†…å®¹</span></span><br><span class="line">System.out.println(s1 == s2); <span class="comment">//false</span></span><br><span class="line">System.out.println(s1.intern() == s2); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/22/169a351b50cc98d6?w=569&amp;h=355&amp;f=png&amp;s=18514" alt></p>
<h2 id="ä¾‹äºŒ"><a class="header-anchor" href="#ä¾‹äºŒ">Â¶</a>ä¾‹äºŒ</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String s1 = <span class="string">"zxy"</span>; <span class="comment">// åŠ åˆ°å¸¸é‡æ± </span></span><br><span class="line">String s2 = <span class="keyword">new</span> String(<span class="string">"zxy"</span>); <span class="comment">// åŠ åˆ°å †ï¼Œå¸¸é‡æ± æœ‰ä¸œè¥¿æ‰€ä»¥å•¥ä¹Ÿä¸å¹²</span></span><br><span class="line">System.out.println(s1 == s2); <span class="comment">// false</span></span><br><span class="line">System.out.println(s1 == s2.intern()); <span class="comment">// true å¸¸é‡æ± éç©ºï¼Œinternè¿”å›å¸¸é‡æ± é‡Œçš„å†…å®¹</span></span><br></pre></td></tr></table></figure>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/22/169a35d23404be5b?w=468&amp;h=373&amp;f=png&amp;s=16487" alt></p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>javaå¤šçº¿ç¨‹ç¼–ç¨‹chap5-7</title>
    <url>/2019/03/14/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8Bchap5-7/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šjavaå¤šçº¿ç¨‹ç¼–ç¨‹æ ¸å¿ƒæŠ€æœ¯ã€‹ç¬¬äº”ã€å…­ã€ä¸ƒç« çš„å­¦ä¹ ç¬”è®°ã€‚</p>
<a id="more"></a>
<h1>å®šæ—¶å™¨ Timer</h1>
<p>Timerç±»ä¸»è¦è´Ÿè´£è®¡åˆ’ä»»åŠ¡çš„åŠŸèƒ½</p>
<p>ä¸€äº›æ–¹æ³•ï¼š</p>
<ul>
<li><code>schedule(TimerTask task, Date time)</code> åœ¨æŒ‡å®šçš„æ—¥æœŸæ‰§è¡ŒæŸä¸€æ¬¡ä»»åŠ¡ã€‚</li>
<li><code>schedule(TimerTask task, long delay)</code>	ä»¥æ‰§è¡Œæ­¤æ–¹æ³•çš„å½“å‰æ—¶é—´ä¸ºå‚è€ƒæ—¶é—´ï¼Œåœ¨æ­¤æ—¶é—´åŸºç¡€ä¸Šå»¶è¿ŸæŒ‡å®šçš„æ¯«ç§’æ•°åæ‰§è¡Œä¸€æ¬¡TimerTaskä»»åŠ¡</li>
<li><code>schedule(TimerTask task, long delay, long period)</code>	ä»¥æ‰§è¡Œæ­¤æ–¹æ³•çš„å½“å‰æ—¶é—´ä¸ºå‚è€ƒæ—¶é—´ï¼Œåœ¨æ­¤æ—¶é—´åŸºç¡€ä¸Šå»¶è¿ŸæŒ‡å®šçš„æ¯«ç§’æ•°ï¼Œå†ä»¥æŸä¸€é—´éš”æ—¶é—´æ— é™æ¬¡æ•°åœ°æ‰§è¡ŒæŸä¸€TimerTaskä»»åŠ¡</li>
<li><code>scheduleAtFixedRate(TimerTask task, Date firstTime, long period)</code>	åœ¨æŒ‡å®šçš„æ—¥æœŸä¹‹åï¼ŒæŒ‰æŒ‡å®šçš„é—´éš”å‘¨æœŸï¼Œæ— é™å¾ªç¯çš„æ‰§è¡ŒæŸä¸€ä»»åŠ¡</li>
</ul>
<p><code>schedule</code>å’Œ<code>scheduleAtFixedRate</code>çš„å¼‚åŒï¼š</p>
<p>åŒï¼š</p>
<ul>
<li>å¤šæ¬¡è°ƒç”¨<code>schedule</code>æˆ–<code>scheduleAtFixedRate</code>æ‰§è¡Œå¤šä¸ªä»»åŠ¡çš„è¯ï¼Œåˆ™éƒ½æ˜¯ä»¥é˜Ÿåˆ—çš„æ–¹å¼ä¸€ä¸ªä¸€ä¸ªçš„è¢«é¡ºåºæ‰§è¡Œã€‚æ‰€ä»¥ä¸ç”¨è€ƒè™‘éçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ã€‚</li>
<li>å¦‚æœä»»åŠ¡å»¶æ—¶äº†ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´éƒ½æ˜¯ä¸Šä¸€æ¬¡ä»»åŠ¡ç»“æŸçš„æ—¶é—´ï¼ˆéƒ½å¸¦<code>period</code>å‚æ•°æ—¶ï¼‰</li>
</ul>
<p>å¼‚ï¼š</p>
<ul>
<li>ä¸å»¶æ—¶æ—¶ï¼Œ<code>schedule</code>ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ˜¯ä¸Šä¸€æ¬¡ä»»åŠ¡å¼€å§‹åŠ ä¸Š<code>period</code>çš„æ—¶é—´ï¼Œ<code>scheduleAtFixedRate</code>ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ˜¯ä¸Šä¸€æ¬¡ä»»åŠ¡ç»“æŸçš„æ—¶é—´ã€‚</li>
</ul>
<h1>å•ä¾‹æ¨¡å¼ä¸å¤šçº¿ç¨‹</h1>
<p>å•ä¾‹æ¨¡å¼æ˜¯23ä¸ªè®¾è®¡æ¨¡å¼ä¸­çš„ä¸€ç§ï¼Œæœ¬ç« å°†å®ƒä¸å¤šçº¿ç¨‹ç»“åˆè€ƒè™‘</p>
<ul>
<li>ç«‹å³åŠ è½½/â€œé¥¿æ±‰æ¨¡å¼â€ï¼šè°ƒç”¨æ–¹æ³•å‰ï¼Œå®ä¾‹å·²ç»è¢«åˆ›å»ºäº†ã€‚</li>
<li>å»¶è¿ŸåŠ è½½/â€œæ‡’æ±‰æ¨¡å¼â€ï¼šè°ƒç”¨get()æ–¹æ³•æ—¶å®ä¾‹æ‰è¢«åˆ›å»ºã€‚æœ€å¸¸è§çš„å®ç°åŠæ³•æ˜¯åœ¨get()æ–¹æ³•ä¸­è¿›è¡Œnewå®ä¾‹åŒ–ã€‚å¯æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä¼šå‡ºé—®é¢˜ï¼Œå³åˆ›å»ºå¤šä¸ªå®ä¾‹ã€‚</li>
</ul>
<p>è§£å†³æ–¹æ¡ˆ</p>
<ul>
<li>å£°æ˜synchronizedå…³é”®å­—ï¼Œä½†è¿è¡Œæ•ˆç‡éå¸¸ä½</li>
<li>åŒæ­¥ä»£ç å—ï¼Œä½†æ•ˆç‡ä¹Ÿéå¸¸ä½</li>
<li>é’ˆå¯¹æŸäº›é‡è¦ä»£ç å•ç‹¬çš„åŒæ­¥ï¼Œæ•ˆç‡æå‡ï¼Œä½†æ˜¯ä¼šåˆ›å»ºå¤šä¸ªå®ä¾‹</li>
<li>ä½¿ç”¨DCLåŒæ£€æŸ¥é”</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> MyObject myObject = <span class="keyword">new</span> MyObject();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MyObject</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MyObject <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (myObject != <span class="keyword">null</span>) &#123;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (MyObject.class) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (myObject == <span class="keyword">null</span>) myObject = <span class="keyword">new</span> MyObject();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> myObject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨é™æ€å†…ç½®ç±»</li>
<li>ä½¿ç”¨staticä»£ç å—</li>
<li>ä½¿ç”¨enumæšä¸¾æ•°æ®ç±»å‹</li>
</ul>
<h1>æ‹¾é—å¢è¡¥</h1>
<p>çº¿ç¨‹çŠ¶æ€ï¼š<br>
<img src="https://user-gold-cdn.xitu.io/2019/3/14/16979f1bac8b4b94?w=843&amp;h=634&amp;f=png&amp;s=182243" alt="æ–¹æ³•ä¸çº¿ç¨‹çŠ¶æ€çš„è½¬æ¢å›¾" title="æ–¹æ³•ä¸çº¿ç¨‹çŠ¶æ€çš„è½¬æ¢å›¾"><br>
çº¿ç¨‹ç»„ï¼š</p>
<ul>
<li>çº¿ç¨‹ç»„ä¸­å¯ä»¥æœ‰çº¿ç¨‹å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æœ‰çº¿ç¨‹ç»„ï¼Œç»„ä¸­è¿˜å¯ä»¥æœ‰çº¿ç¨‹ã€‚ä½œç”¨æ˜¯å¯æ‰¹é‡ç®¡ç†çº¿ç¨‹æˆ–çº¿ç¨‹ç»„å¯¹è±¡ï¼Œæœ‰æ•ˆåœ°å¯¹çº¿ç¨‹æˆ–çº¿ç¨‹ç»„å¯¹è±¡è¿›è¡Œç»„ç»‡ã€‚</li>
<li>å®ä¾‹åŒ–ä¸€ä¸ªçº¿ç¨‹ç»„æ—¶å¦‚æœä¸æŒ‡å®šæ‰€å±çš„çº¿ç¨‹ç»„ï¼Œå®ƒä¼šè‡ªåŠ¨å½’å±åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡æ‰€å±çš„çº¿ç¨‹ç»„ä¸­ã€‚</li>
</ul>
<p>çº¿ç¨‹ä¸­å‡ºç°å¼‚å¸¸çš„å¤„ç†ï¼š</p>
<ul>
<li><code>setUncaughtExceptionHandler()</code>ç»™æŒ‡å®šçº¿ç¨‹å¯¹çº¿è®¾ç½®å¼‚å¸¸å¤„ç†å™¨</li>
<li><code>setDefaultUncaughtExceptionHandler()</code>å¯¹æŒ‡å®šçº¿ç¨‹ç±»çš„æ‰€æœ‰çº¿ç¨‹å¯¹è±¡è®¾ç½®å¼‚å¸¸å¤„ç†å™¨</li>
</ul>
<br>
<br>
<p><font size="6"><center><strong>å®Œç»“æ’’èŠ±ï¼</strong></center></font></p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>javaå¤šçº¿ç¨‹ç¼–ç¨‹chap3-4</title>
    <url>/2019/03/13/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8Bchap3-4/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šjavaå¤šçº¿ç¨‹ç¼–ç¨‹æ ¸å¿ƒæŠ€æœ¯ã€‹ç¬¬ä¸‰ã€å››ç« çš„å­¦ä¹ ç¬”è®°ã€‚</p>
<a id="more"></a>
<h1>çº¿ç¨‹é—´é€šä¿¡</h1>
<h2 id="ç­‰å¾…-é€šçŸ¥æœºåˆ¶"><a class="header-anchor" href="#ç­‰å¾…-é€šçŸ¥æœºåˆ¶">Â¶</a>ç­‰å¾…/é€šçŸ¥æœºåˆ¶</h2>
<p><code>wait()</code>å’Œ<code>notify()</code>: <code>wait</code>ä½¿çº¿ç¨‹åœæ­¢è¿è¡Œï¼Œ<code>notify</code>ä½¿åœæ­¢çš„çº¿ç¨‹ç»§ç»­è¿è¡Œã€‚</p>
<p>æ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li><code>wait()</code>è‡ªåŠ¨é”æ”¾å¯¹è±¡é”ï¼›<code>notify()</code>ä¸é‡Šæ”¾ï¼›å®ƒä»¬å¿…é¡»å­˜åœ¨ä¸åŒæ­¥å—ä¸­ã€‚</li>
<li>wait åçº¿ç¨‹ä¼šè¿›å…¥ç­‰å¾…æ± ï¼Œéœ€è¦ç”±åŒä¸€å¯¹è±¡çš„ notify æ–¹æ³•å”¤é†’ã€‚</li>
<li>å½“çº¿ç¨‹å¤„äºwaitçŠ¶æ€æ—¶ï¼Œè°ƒç”¨<code>interrup()</code>æ–¹æ³•ä¼šå‡ºç°å¼‚å¸¸ã€‚</li>
<li>notify()éšæœºå”¤é†’çº¿ç¨‹ï¼Œ<code>notifyAll()</code>å”¤é†’å…¨éƒ¨waitçº¿ç¨‹.</li>
<li><code>wait(n)</code>ï¼Œä½¿çº¿ç¨‹ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœæ²¡è¢«å”¤é†’ï¼Œè¶…è¿‡æ—¶é—´è‡ªåŠ¨å”¤é†’ã€‚</li>
</ul>
<p>å¯ä»¥ç”¨<code>wait()</code>å’Œ<code>notify()</code>å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…</p>
<ul>
<li>å‡æ­»ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½å‘ˆWAITINGçŠ¶æ€ã€‚</li>
<li>åŸå› ï¼šnotifyå”¤é†’çš„æ˜¯å¼‚ç±»ï¼Œå¦‚â€œç”Ÿäº§è€…â€å”¤é†’â€œç”Ÿäº§è€…â€ã€‚</li>
<li>è§£å†³ï¼šå°†<code>notify()</code>æ”¹ä¸º<code>notifyAll()</code></li>
</ul>
<p>é€šè¿‡ç®¡é“è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ï¼šä¸€ä¸ªçº¿ç¨‹å‘é€æ•°æ®åˆ°è¾“å‡ºç®¡é“ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹ä»è¾“å…¥ç®¡é“ä¸­è¯»æ•°æ®ã€‚</p>
<ul>
<li>å­—èŠ‚æµï¼š<code>PipedInputStream</code>å’Œ<code>PipedOutputStream</code></li>
<li>å­—ç¬¦æµï¼š<code>PipedReader</code>å’Œ<code>PipedWriter</code></li>
</ul>
<h2 id="æ–¹æ³•joinçš„ä½¿ç”¨"><a class="header-anchor" href="#æ–¹æ³•joinçš„ä½¿ç”¨">Â¶</a>æ–¹æ³•joinçš„ä½¿ç”¨</h2>
<p><code>join()</code>ï¼šä½¿å½“å‰çº¿ç¨‹å µå¡ï¼Œç­‰å¾…çº¿ç¨‹å¯¹è±¡é”€æ¯åï¼Œå†æ‰§è¡Œå½“å‰çº¿ç¨‹åé¢çš„ä»£ç ã€‚</p>
<ul>
<li><code>join()</code>ä¸<code>interrupt()</code>æ–¹æ³•å¦‚æœå½¼æ­¤é‡åˆ°ï¼Œåˆ™ä¼šå‡ºç°å¼‚å¸¸ã€‚</li>
<li><code>join(long)</code>å¯è®¾å®šç­‰å¾…çš„æ—¶é—´ã€‚æ³¨æ„ï¼š<code>join(long)</code>å†…éƒ¨ä½¿ç”¨<code>wait(long)</code>å®ç°ï¼Œæ‰€ä»¥<code>join(long)</code>ä¼š<strong>é‡Šæ”¾é”</strong>ï¼›è€Œ<code>Thread.sleep(long)</code><strong>ä¸ä¼šé‡Šæ”¾é”</strong>ã€‚</li>
</ul>
<h2 id="ThreadLocalçš„ä½¿ç”¨"><a class="header-anchor" href="#ThreadLocalçš„ä½¿ç”¨">Â¶</a>ThreadLocalçš„ä½¿ç”¨</h2>
<ul>
<li><code>ThreadLocal</code>ç±»ï¼šè®©æ¯ä¸ªçº¿ç¨‹å¯ä»¥ç»‘å®šè‡ªå·±çš„å€¼</li>
<li>è§£å†³<code>get()</code>è¿”å›nullçš„é—®é¢˜ï¼šè¦†ç›–	<code>initialValue()</code>æ–¹æ³•ä½¿å˜é‡å…·æœ‰åˆå§‹å€¼ã€‚</li>
<li><code>InheritableThreadLocal</code>ç±»å¯åœ¨å­çº¿ç¨‹ä¸­å–å¾—çˆ¶çº¿ç¨‹ç»§æ‰¿ä¸‹æ¥çš„å€¼ã€‚</li>
<li>è¿˜å¯ä»¥å¯¹å­çº¿ç¨‹ç»§æ‰¿ä¸‹æ¥çš„å€¼è¿›è¡Œä¿®æ”¹ã€‚</li>
</ul>
<h1>Lockçš„ä½¿ç”¨</h1>
<h2 id="ä½¿ç”¨ReentrantLockç±»"><a class="header-anchor" href="#ä½¿ç”¨ReentrantLockç±»">Â¶</a>ä½¿ç”¨ReentrantLockç±»</h2>
<p>åŸºæœ¬ç”¨æ³•ï¼š</p>
<ul>
<li>åŒæ­¥ï¼š <code>lock()</code> è®©çº¿ç¨‹æŒæœ‰äº†â€œå¯¹è±¡ç›‘è§†å™¨â€ï¼Œå’Œsynchronizedä¸€æ ·ï¼Œçº¿ç¨‹ä¹‹é—´è¿˜æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚</li>
<li>ç­‰å¾…/é€šçŸ¥ï¼š <code>condition.await()</code> ç­‰å¾…ï¼›<code>condition.siganl()</code>é€šçŸ¥ã€‚æ³¨æ„è°ƒç”¨<code>condition.await()</code>å‰é¡»å…ˆè°ƒç”¨<code>lock.lock()</code>ã€‚å®ƒæ¯”waitæ›´çµæ´»ï¼Œå› ä¸ºå®ƒå¯ä»¥ç”¨ä¸åŒçš„<code>condition</code>å¯¹è±¡å®ç°é€šçŸ¥éƒ¨åˆ†çº¿ç¨‹ã€‚</li>
</ul>
<p>å…¬å¹³é”å’Œéå…¬å¹³é”</p>
<ul>
<li>å…¬å¹³é”ï¼š <code>new ReentranLock(true)</code> è·å–é”æ˜¯å…ˆè¿›å…ˆå¾—çš„</li>
<li>éå…¬å¹³é”ï¼š <code>new ReentranLock(false)</code> è·å–é”æ˜¯éšæœºçš„</li>
</ul>
<p>ä¸€äº›æ–¹æ³•ï¼š</p>
<ul>
<li><code>int getHoldCount()</code>	æŸ¥è¯¢å½“å‰çº¿ç¨‹ä¿æŒæ­¤é”å®šçš„ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨lock()æ–¹æ³•çš„æ¬¡æ•°ã€‚</li>
<li><code>int getQueueLength()</code>	è¿”å›æ­£åœ¨ç­‰å¾…è·å–æ­¤é”å®šçš„çº¿ç¨‹ä¼°è®¡æ•°</li>
<li><code>int getWaitQueueLength(Condition condition)</code>	è¿”å›ç­‰å¾…ä¸æ­¤é”å®šç›¸å…³çš„ç»™å®šæ¡ä»¶Conditonçš„çº¿ç¨‹ä¼°è®¡æ•°</li>
<li><code>boolean hasQueueThread(Thread thread)</code>	æŸ¥è¯¢æŒ‡å®šçš„çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç­‰å¾…è·å–æ­¤é”å®š</li>
<li><code>boolean hasQueueThreads()</code>	æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–æ­¤é”å®š</li>
<li><code>boolean hasWaiters(Condition)</code>		æŸ¥è¯¢æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…ä¸æ­¤é”å®šæœ‰å…³çš„conditionæ¡ä»¶</li>
<li><code>boolean isFair()</code>	åˆ¤æ–­æ˜¯ä¸æ˜¯å…¬å¹³é”</li>
<li><code>boolean isHeldByCurrentThread()</code>		æŸ¥è¯¢å½“å‰çº¿ç¨‹æ˜¯å¦ä¿æŒæ­¤é”å®š</li>
<li><code>boolean isLocked()</code>	æŸ¥è¯¢æ­¤é”å®šæ˜¯å¦ç”±ä»»æ„çº¿ç¨‹ä¿æŒ</li>
<li><code>void lockInterruptibly()</code>	å¦‚æœå½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œåˆ™è·å–é”å®šï¼Œå¦‚æœå·²ç»è¢«ä¸­æ–­åˆ™å‡ºç°å¼‚å¸¸</li>
<li><code>boolean tryLock()</code>	ä»…åœ¨è°ƒç”¨æ—¶é”å®šæœªè¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿æŒçš„æƒ…å†µä¸‹ï¼Œæ‰è·å–è¯¥é”å®š</li>
<li><code>boolean tryLock(long timeout,TimeUnit unit)</code>	å¦‚æœé”å®šåœ¨ç»™å®šç­‰å¾…æ—¶é—´å†…æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿æŒï¼Œä¸”å½“å‰çº¿ç¨‹æœªè¢«ä¸­æ–­ï¼Œåˆ™è·å–è¯¥é”å®š</li>
<li><code>void awaitUninterruptibly()</code>	awaitçŠ¶æ€æ—¶è°ƒç”¨thread.interrupt()ä¸ä¼šæŠ¥é”™</li>
</ul>
<h2 id="ä½¿ç”¨ReentrantReadWriteLockç±»"><a class="header-anchor" href="#ä½¿ç”¨ReentrantReadWriteLockç±»">Â¶</a>ä½¿ç”¨ReentrantReadWriteLockç±»</h2>
<p><code>ReentrantLock</code>ç±»å®Œå…¨äº’æ–¥ï¼Œå³åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯æ‰§è¡Œlockåé¢çš„ä»»åŠ¡ã€‚</p>
<p><code>ReentrantReadWriteLock</code>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>è¯»è¯»å…±äº«</li>
<li>å†™å†™äº’æ–¥</li>
<li>å†™è¯»äº’æ–¥</li>
<li>è¯»å†™äº’æ–¥</li>
</ul>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>javaå¤šçº¿ç¨‹ç¼–ç¨‹chap1-2</title>
    <url>/2019/03/11/java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8Bchap1-2/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯ã€Šjavaå¤šçº¿ç¨‹ç¼–ç¨‹æ ¸å¿ƒæŠ€æœ¯ã€‹ç¬¬ä¸€ã€äºŒç« çš„å­¦ä¹ ç¬”è®°ã€‚</p>
<a id="more"></a>
<h1>ç¬¬ä¸€ç« ï¼šJavaå¤šçº¿ç¨‹æŠ€èƒ½</h1>
<h2 id="ä½¿ç”¨å¤šçº¿ç¨‹"><a class="header-anchor" href="#ä½¿ç”¨å¤šçº¿ç¨‹">Â¶</a>ä½¿ç”¨å¤šçº¿ç¨‹</h2>
<ul>
<li>å®ç°å¤šçº¿ç¨‹æœ‰ä¸¤ç§æ–¹å¼ï¼šç»§æ‰¿<code>Thread</code>ç±»ã€å®ç°<code>Runnable</code>æ¥å£</li>
<li><code>Thread.java</code>ä¸­çš„<code>start()</code>æ–¹æ³•æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œ<code>thread.run</code>æ˜¯åŒæ­¥ï¼›è€Œä¸”<code>start()</code>æ–¹æ³•çš„é¡ºåºä¸ä»£è¡¨çº¿ç¨‹å¯åŠ¨çš„é¡ºåºï¼Œå®ƒæ˜¯éšæœºçš„ã€‚</li>
<li>åœ¨æ–¹æ³•å‰åŠ <code>synchronized</code>å¯ä»¥è®©çº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>
<h2 id="ä¸€äº›æ–¹æ³•"><a class="header-anchor" href="#ä¸€äº›æ–¹æ³•">Â¶</a>ä¸€äº›æ–¹æ³•</h2>
<ul>
<li><code>currentThread()</code> è¿”å›ä»£ç æ®µæ­£åœ¨è¢«å“ªä¸ªçº¿ç¨‹è°ƒç”¨</li>
<li><code>isAlive()</code> åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€</li>
<li><code>sleep()</code> è®©çº¿ç¨‹ä¼‘çœ </li>
<li><code>getID()</code> è·å¾—çº¿ç¨‹çš„å”¯ä¸€æ ‡å¿—</li>
<li><code>yield()</code> è®©å½“å‰çº¿ç¨‹æ”¾å¼ƒcpuèµ„æºï¼Œä½†æ—¶é—´ä¸ç¡®å®š</li>
</ul>
<h2 id="åœæ­¢çº¿ç¨‹"><a class="header-anchor" href="#åœæ­¢çº¿ç¨‹">Â¶</a>åœæ­¢çº¿ç¨‹</h2>
<p>æ–¹å¼ï¼š</p>
<ul>
<li>ä½¿ç”¨é€€å‡ºæ ‡è¯†ï¼Œä½¿çº¿ç¨‹æ­£å¸¸é€€å‡ºï¼Œä¹Ÿå°±æ˜¯å½“runæ–¹æ³•å®Œæˆåçº¿ç¨‹é€€å‡º</li>
<li>ä½¿ç”¨interruptæ–¹æ³•ä¸­æ–­çº¿ç¨‹</li>
</ul>
<p>ç¬¬äºŒç§æ–¹å¼è¦æ³¨æ„ï¼š</p>
<ul>
<li><code>interrupt()</code> å®ä¾‹æ–¹æ³•ï¼Œè®©çº¿ç¨‹ä¸­æ–­ï¼Œå†ç”¨å¼‚å¸¸æ³•æ£€æµ‹ä¸­æ–­ä½¿ç¨‹åºåœæ­¢</li>
<li><code>interrupted()</code>æ˜¯é™æ€æ–¹æ³•ï¼Œæµ‹è¯•å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œæ‰§è¡Œåå…·æœ‰å°†çŠ¶æ€æ ‡å¿—æ¸…é™¤ä¸ºfalseçš„åŠŸèƒ½ã€‚</li>
<li><code>isInterrupted()</code>æ˜¯å®ä¾‹æ–¹æ³•ï¼Œæµ‹è¯•Threadå¯¹è±¡æ˜¯å¦å·²ç»æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œä½†ä¸æ¸…é™¤çŠ¶æ€æ ‡å¿—ã€‚</li>
<li>å¦‚æœåœ¨sleepçŠ¶æ€ä¸‹åœæ­¢æŸä¸€çº¿ç¨‹ï¼Œä¼šè¿›å…¥catchè¯­å¥ï¼ˆä¸éœ€è¦åˆ¤æ–­æ˜¯å¦ä¸­æ–­ï¼‰ï¼Œå¹¶ä¸”æ¸…é™¤åœæ­¢çŠ¶æ€ï¼Œä½¿å®ƒå˜ä¸ºfalse.</li>
</ul>
<h2 id="çº¿ç¨‹çš„ä¼˜å…ˆçº§"><a class="header-anchor" href="#çº¿ç¨‹çš„ä¼˜å…ˆçº§">Â¶</a>çº¿ç¨‹çš„ä¼˜å…ˆçº§</h2>
<p><code>getPriority()</code>æŸ¥çœ‹ä¼˜å…ˆçº§ï¼Œ<code>setPriority()</code>è®¾ç½®ä¼˜å…ˆçº§ï¼Œæœ‰1ï½10çº§<br>
çº¿ç¨‹ä¼˜å…ˆçº§çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç»§æ‰¿æ€§: å¦‚è¿‡çº¿ç¨‹Aå¯åŠ¨çº¿ç¨‹Bï¼Œåˆ™Bå’ŒAä¼˜å…ˆçº§ä¸€æ ·</li>
<li>è§„åˆ™æ€§: CPUå°½é‡å€¾å‘äºæŠŠèµ„æºä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹</li>
<li>éšæœºæ€§: ä¼˜å…ˆçº§ä¸ç­‰åŒäºæ‰§è¡Œé¡ºåºï¼Œä¼˜å…ˆçº§è¾ƒé«˜çš„ä¸ä¸€å®šå…ˆæ‰§è¡Œå®Œ</li>
</ul>
<h2 id="å®ˆæŠ¤çº¿ç¨‹"><a class="header-anchor" href="#å®ˆæŠ¤çº¿ç¨‹">Â¶</a>å®ˆæŠ¤çº¿ç¨‹</h2>
<p>Javaçš„çº¿ç¨‹åˆ†ä¸ºä¸¤ç§ï¼šUser Thread(ç”¨æˆ·çº¿ç¨‹)ã€Daemon Thread(å®ˆæŠ¤çº¿ç¨‹)ã€‚</p>
<p>å½“æœ€åä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹ç»“æŸæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹éšç€JVMä¸€åŒç»“æŸå·¥ä½œã€‚Daemonä½œç”¨æ˜¯ä¸ºå…¶ä»–çº¿ç¨‹æä¾›ä¾¿åˆ©æœåŠ¡ï¼Œå®ˆæŠ¤çº¿ç¨‹æœ€å…¸å‹çš„åº”ç”¨å°±æ˜¯GC(åƒåœ¾å›æ”¶å™¨)ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå¾ˆç§°èŒçš„å®ˆæŠ¤è€…ã€‚</p>
<h1>ç¬¬äºŒç« ï¼šå¯¹è±¡åŠå˜é‡çš„å¹¶å‘è®¿é—®</h1>
<h2 id="synchronizedåŒæ­¥æ–¹æ³•"><a class="header-anchor" href="#synchronizedåŒæ­¥æ–¹æ³•">Â¶</a>synchronizedåŒæ­¥æ–¹æ³•</h2>
<ul>
<li>æ–¹æ³•å†…çš„å˜é‡ä¸ºçº¿ç¨‹å®‰å…¨ï¼Œè€Œå®ä¾‹å˜é‡éçº¿ç¨‹å®‰å…¨ã€‚</li>
<li>ä¸åŒçº¿ç¨‹è°ƒç”¨<strong>åŒä¸€å¯¹è±¡</strong>é‡Œçš„<strong>synchronized</strong>æ–¹æ³•æ—¶ï¼Œæ˜¯åŒæ­¥çš„(æ’é˜Ÿè¿›è¡Œ)ã€‚ä¹Ÿå°±æ˜¯å¿…é¡»ç­‰çº¿ç¨‹æ‰§è¡Œå®Œ<code>synchronized</code>æ–¹æ³•æ—¶ï¼Œä¸‹ä¸€çº¿ç¨‹æ‰èƒ½æ‰§è¡Œ<code>synchronized</code>æ–¹æ³•ã€‚</li>
<li>å¯é‡å…¥é”: ä¸€ä¸ªçº¿ç¨‹å¾—åˆ°å¯¹è±¡é”åï¼Œå†æ¬¡è¯·æ±‚æ­¤å¯¹è±¡é”æ—¶æ˜¯å¯ä»¥å¾—åˆ°è¯¥å¯¹è±¡çš„é”çš„ã€‚å­ç±»ä¹Ÿå¯ä»¥è°ƒç”¨çˆ¶ç±»çš„åŒæ­¥æ–¹æ³•ã€‚</li>
<li>å‡ºç°å¼‚å¸¸ï¼Œé”è‡ªåŠ¨é‡Šæ”¾</li>
<li>å­ç±»æ–¹æ³•ä¸ä¼šç»§æ‰¿<code>synchronized</code>å…³é”®å­—ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨å­ç±»æ–¹æ³•ä¸­åŠ ä¸Šã€‚</li>
</ul>
<h2 id="synchronizedåŒæ­¥è¯­å¥å—"><a class="header-anchor" href="#synchronizedåŒæ­¥è¯­å¥å—">Â¶</a>synchronizedåŒæ­¥è¯­å¥å—</h2>
<ul>
<li>å¤šä¸ªçº¿ç¨‹å¤„ç†åŒä¸€ä¸ªå¯¹è±¡çš„<code>synchronized(this)</code>åŒæ­¥è¯­å¥å—æ—¶ï¼Œåªèƒ½æ’é˜Ÿæ‰§è¡Œ</li>
<li>åŒä¸€ä¸ªå¯¹è±¡çš„<code>synchronized(this)</code>å’Œ<code>synchronized</code>åŒæ­¥æ–¹æ³•ä¹‹é—´ä¹Ÿæ˜¯åŒæ­¥çš„ã€‚å³<strong>åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯æ‰§è¡Œsynchronizedä»£ç å—æˆ–æ–¹æ³•ä¸­çš„ä»£ç </strong></li>
<li><code>synchronized(éthiså¯¹è±¡x)</code>ï¼Œæ˜¯å°†xå¯¹è±¡ä½œä¸ºâ€œå¯¹è±¡ç›‘è§†å™¨â€
<ul>
<li>å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ<code>synchronized(x){}</code>åŒæ­¥ä»£ç å—æ—¶å‘ˆåŒæ­¥æ•ˆæœ</li>
<li>å½“å…¶ä»–çº¿ç¨‹æ‰§è¡Œxå¯¹è±¡ä¸­<code>synchronizd</code>åŒæ­¥æ–¹æ³•æ—¶å‘ˆåŒæ­¥æ•ˆæœ</li>
<li>å½“å…¶ä»–çº¿ç¨‹æ‰§è¡Œxå¯¹è±¡æ–¹æ³•é‡Œçš„<code>synchronized(this)</code>ä»£ç å—æ—¶å‘ˆåŒæ­¥æ•ˆæœ</li>
</ul>
</li>
<li>é™æ€åŒæ­¥	<code>synchronized</code>æ–¹æ³•ä¸<code>synchronized(class)</code>ä»£ç å—æ˜¯å¯¹Classç±»è¿›è¡ŒæŒé”ã€‚</li>
<li>å½“çº¿ç¨‹åœ¨ç­‰å¸¦æ ¹æœ¬ä¸å¯èƒ½è¢«é‡Šæ”¾çš„é”æ˜¯ï¼Œå°±ä¼šå‡ºç°æ­»é”ã€‚</li>
<li>å¦‚æœåŒæ—¶æŒæœ‰ç›¸åŒçš„é”å¯¹è±¡ï¼Œçº¿ç¨‹ä¹‹é—´å°±æ˜¯åŒæ­¥çš„ã€‚æ³¨æ„å¯¹è±¡çš„å±æ€§æ”¹å˜ï¼Œè¿è¡Œç»“æœè¿˜æ˜¯åŒæ­¥çš„ã€‚</li>
</ul>
<h2 id="volatileå…³é”®å­—"><a class="header-anchor" href="#volatileå…³é”®å­—">Â¶</a>volatileå…³é”®å­—</h2>
<p><code>volatile</code>: å¼ºåˆ¶çš„ä»å…¬å…±å†…å­˜è¿›è¡Œå–å€¼,è€Œä¸æ˜¯ä»çº¿ç¨‹ç§æœ‰æ•°æ®æ ˆä¸­å–å¾—å˜é‡çš„å€¼ã€‚å¯ä»¥ä½¿å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹é—´å¯è§ï¼Œä½†ç¼ºç‚¹æ˜¯ä¸æ”¯æŒåŸå­æ€§ã€‚</p>
<p><code>synchronized</code>å’Œ<code>volatile</code>æ¯”è¾ƒ:</p>
<ul>
<li>å…³é”®å­—volatileæ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡çº§å®ç°ï¼Œæ‰€ä»¥volatileæ€§èƒ½æ¯”synchronizedå¥½ï¼Œå¹¶ä¸”volatileåªèƒ½ä¿®é¥°å˜é‡ï¼Œè€Œsynchronizedå¯ä¿®é¥°æ–¹æ³•å’Œä»£ç å—ã€‚</li>
<li>å¤šçº¿ç¨‹è®¿é—®volatileä¸ä¼šå‘ç”Ÿé˜»å¡ï¼Œè€Œsynchronizedä¼šå‡ºç°é˜»å¡</li>
<li>volatileèƒ½ä¿è¯æ•°æ®å¯è§æ€§ï¼Œä¸ä¿è¯åŸå­æ€§;synchronizedå¯ä»¥ä¿è¯åŸå­æ€§ï¼Œä¹Ÿå¯ä»¥é—´æ¥ä¿è¯å¯è§æ€§ï¼Œå› ä¸ºsynchronizedä¼šå°†ç§æœ‰å†…å­˜å’Œå…¬å…±å†…å­˜ä¸­çš„æ•°æ®åšåŒæ­¥ã€‚</li>
<li>volatileè§£å†³çš„æ˜¯å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹é—´çš„å¯è§æ€§ï¼Œsynchronizedè§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼ˆäº’æ–¥åŠ å¯è§ï¼‰ã€‚</li>
</ul>
<p>åŸå­ç±»:</p>
<p>å¦‚<code>AtomicBoolean</code>ï¼Œ<code>AtomicInteger</code>ï¼Œ<code>AtomicLong</code>ç­‰ã€‚ä¸€ä¸ªåŸå­ç±»å‹å°±æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå¯ç”¨çš„ç±»å‹ï¼Œå¯åœ¨æ²¡æœ‰é”çš„æƒ…å†µä¸‹åšåˆ°çº¿ç¨‹å®‰å…¨ã€‚ä½†åŸå­ç±»çš„æ–¹æ³•é—´çš„è°ƒç”¨å´ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦ç”¨åŒæ­¥ã€‚</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>corejavaåŸºç¡€çŸ¥è¯†(6)-è§†å›¾</title>
    <url>/2019/03/07/corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-6-%E8%A7%86%E5%9B%BE/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ java è§†å›¾çš„æ€»ç»“ã€‚</p>
<a id="more"></a>
<h1>é›†åˆåŒ…è£…å™¨è§†å›¾</h1>
<p><code>Array</code>åŒ…è£…æˆ<code>List</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Card[] cardArray = <span class="keyword">new</span> Card[<span class="number">52</span>];</span><br><span class="line">List&lt;Card&gt; cardList = Arrays.asList(cardArray);</span><br></pre></td></tr></table></figure>
<p><code>Arrays</code>ç±»çš„é™æ€æ–¹æ³• <code>asList</code> å°†è¿”å›ä¸€ä¸ªåŒ…è£…äº† <code>List</code> çš„åŒ…è£…å™¨ã€‚ æ³¨æ„è¿”å›çš„æ˜¯<strong>è§†å›¾å¯¹è±¡</strong>ï¼Œå®ƒåªèƒ½ä½¿ç”¨<code>get</code> ï¼Œ<code>set</code>æ–¹æ³•ã€‚</p>
<p><code>Map</code>åŒ…è£…æˆ<code>Set</code>:</p>
<ul>
<li><code>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet()</code>è¿”å›<code>Map.Entry</code>å¯¹è±¡çš„ä¸€ä¸ªé›†è§†å›¾ã€‚</li>
<li><code>Set&lt;K&gt; keySet()</code> è¿”å›æ˜ å°„ä¸­æ‰€æœ‰é”®çš„ä¸€ä¸ªé›†è§†å›¾ã€‚</li>
<li><code>Col1ection&lt;V&gt; values()</code> è¿”å›æ˜ å°„ä¸­æ‰€æœ‰å€¼çš„ä¸€ä¸ªé›†åˆè§†å›¾ã€‚</li>
</ul>
<p>å¯ä»¥ä»é›†è§†å›¾ä¸­åˆ é™¤å…ƒç´ ï¼Œæ˜ å°„ä¸­å¯¹åº”çš„é”®å’Œå€¼ä¹Ÿä¼šè¢«åˆ é™¤ï¼Œ ä¸è¿‡ä¸èƒ½å¢åŠ ä»»ä½•å…ƒç´ ã€‚</p>
<h1>å­èŒƒå›´è§†å›¾</h1>
<p>å¯ä»¥ä¸ºé›†åˆå»ºç«‹å­èŒƒå›´è§†å›¾</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List group2 =staff.subList(<span class="number">10</span>, <span class="number">20</span>); <span class="comment">// åˆ—è¡¨çš„å­èŒƒå›´</span></span><br><span class="line"></span><br><span class="line"><span class="function">SortedSet&lt;E&gt; <span class="title">subSet</span><span class="params">(E from, E to)</span></span>; <span class="comment">//æœ‰åºé›†æ ¹æ®æ’åºé¡ºåºå»ºç«‹å­è§†å›¾</span></span><br><span class="line"><span class="function">SortedSet&lt;E&gt; <span class="title">headSet</span><span class="params">(E to)</span></span>;</span><br><span class="line"><span class="function">SortedSet&lt;E&gt; <span class="title">tailSet</span><span class="params">(E from)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">SortedMap&lt;K, V&gt; <span class="title">subMap</span><span class="params">(K from, K to)</span></span>; <span class="comment">//å’Œæœ‰åºé›†åŒç†</span></span><br><span class="line"><span class="function">SortedMap&lt;K, V&gt; <span class="title">headMap</span><span class="params">(K to)</span></span>;</span><br><span class="line"><span class="function">SortedMap&lt;K, V&gt; <span class="title">tailMap</span><span class="params">(K from)</span></span>;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>èŒƒå›´æ˜¯å·¦é—­å³å¼€</li>
<li>å¯ä»¥å°†ä»»ä½•æ“ä½œåº”ç”¨äºå­èŒƒå›´ï¼Œ å¹¶ä¸”èƒ½å¤Ÿè‡ªåŠ¨åœ°åæ˜ åˆ°åŸèŒƒå›´ã€‚</li>
<li>å¯¹é¡ºåºé›†åˆå¯¹å­é›†åˆæ·»åŠ å…ƒç´ æ—¶ï¼Œæ–°å…ƒç´ å¿…é¡»åœ¨å­èŒƒå›´å†…</li>
</ul>
<h1>ä¸å¯ä¿®æ”¹çš„è§†å›¾</h1>
<p>é¡¾åæ€ä¹‰ç”Ÿæˆä¸å¯ä¿®æ”¹çš„è§†å›¾ï¼Œå¦‚æœå‘ç°è¯•å›¾å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼Œå°±æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚å½“ç„¶åŸå¯¹è±¡è‚¯å®šè¿˜æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚</p>
<p>ä¾‹å¦‚ï¼šç”Ÿæˆä¸€ä¸ªä¸å¯ä¿®æ”¹çš„Mapè§†å›¾:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">TreeMap&lt;String, Integer&gt; scores = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">...</span><br><span class="line">Map&lt;String, Integer&gt; umMap = Collections.synchronizedSortedMap(scores);</span><br></pre></td></tr></table></figure>
<h1>åŒæ­¥è§†å›¾</h1>
<p>ç±»åº“çš„è®¾è®¡è€…ä½¿ç”¨è§†å›¾æœºåˆ¶æ¥ç¡®ä¿å¸¸è§„é›†åˆçš„çº¿ç¨‹å®‰å…¨ï¼Œè€Œä¸æ˜¯å®ç°çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ã€‚</p>
<p>ä¾‹å¦‚ï¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„Map:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, Employeeã€‰map = Collections.synchronizedMap(<span class="keyword">new</span> HashMap&lt;String, Employee&gt;());</span><br></pre></td></tr></table></figure>
<h1>å—æŸ¥è§†å›¾</h1>
<p>å—æŸ¥è§†å›¾å¯ä»¥æŸ¥å‡º å°†é”™è¯¯ç±»å‹çš„å…ƒç´ æ··äººæ³›å‹é›†åˆ è¿™ç§æƒ…å†µã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; safestrings = Collections.checkedList(stringsï¼ŒString,<span class="class"><span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>å½“åŠ å…¥é”™è¯¯ç±»å‹æ—¶ï¼Œä¼šå¾—åˆ°é”™è¯¯æŠ¥å‘Šã€‚</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>corejavaåŸºç¡€çŸ¥è¯†(5)-é›†åˆ</title>
    <url>/2019/03/07/corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-5-%E9%9B%86%E5%90%88/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ java é›†åˆçš„æ€»ç»“ã€‚ä¹¦çš„æ€è·¯æ˜¯å°†æ¥å£ä¸å®ç°åˆ†å¼€è®²ï¼›ç„¶åä»çˆ¶è®²èµ·ï¼Œå†è®²å­å¯¹çˆ¶çš„æå‡ã€‚æˆ‘è§‰å¾—è¿™ç§æ–¹å¼å¾ˆå¥½ç†è§£åŠ è®°å¿†ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿæ˜¯è¿™æ ·æ•´ç†çš„ã€‚</p>
<a id="more"></a>
<h1>é›†åˆæ¡†æ¶</h1>
<p>ä¸»è¦æ€è·¯æ˜¯è®©<strong>æ¥å£ä¸å®ç°åˆ†ç¦»</strong></p>
<p>é›†åˆæ¡†æ¶çš„æ¥å£ï¼šä¸¤ä¸ªåŸºæœ¬æ¥å£ <code>Collection</code> å’Œ <code>Map</code></p>
<p><img src="corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-5-%E9%9B%86%E5%90%88/interface.png" alt="é›†åˆæ¡†æ¶çš„æ¥å£" title="é›†åˆæ¡†æ¶çš„æ¥å£"></p>
<p>é›†åˆæ¡†æ¶çš„ç±»ï¼š</p>
<p><img src="corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-5-%E9%9B%86%E5%90%88/me.png" alt="é›†åˆæ¡†æ¶çš„ç±»" title="é›†åˆç±»çš„è§£é‡Š"></p>
<p><img src="corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-5-%E9%9B%86%E5%90%88/shixian.png" alt="é›†åˆæ¡†æ¶çš„ç±»" title="é›†åˆæ¡†æ¶çš„ç±»"></p>
<h1>æ¥å£</h1>
<h2 id="ä¸¤ä¸ªåŸºæœ¬æ¥å£ï¼šCollection-å’Œ-Map"><a class="header-anchor" href="#ä¸¤ä¸ªåŸºæœ¬æ¥å£ï¼šCollection-å’Œ-Map">Â¶</a>ä¸¤ä¸ªåŸºæœ¬æ¥å£ï¼š<code>Collection</code> å’Œ <code>Map</code></h2>
<h3 id="Collection"><a class="header-anchor" href="#Collection">Â¶</a>Collection</h3>
<p>ä»¥ä¸‹æ˜¯<code>Collection</code>æ¥å£å†…çš„ä¸€äº›æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">interface</span> <span class="title">class</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">Collection</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> java.util.<span class="function">Iterator <span class="title">iterator</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(java.util.Collection)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">containsAll</span><span class="params">(java.util.Collection)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">removeAll</span><span class="params">(java.util.Collection)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">retainAll</span><span class="params">(java.util.Collection)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeIf</span><span class="params">(java.util.function.Predicate)</span></span>;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ <strong>å¤§å°ï¼ŒåŠ ï¼Œåˆ ï¼Œæ˜¯å¦å«æŸä¸ªå…ƒç´ ï¼Œæ˜¯å¦ç©º ç­‰ç­‰</strong>ï¼Œè¿™äº›é›†åˆæœ€åŸºç¡€çš„åŠŸèƒ½</p>
<p><code>Collection</code>ä¸­æœ‰<code>Iterator</code>æ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">interface</span> <span class="title">class</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">Iterator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> java.lang.<span class="function">Object <span class="title">next</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachRemaining</span><span class="params">(java.util.function.Consumer)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Map"><a class="header-anchor" href="#Map">Â¶</a>Map</h3>
<p>ä»¥ä¸‹æ˜¯<code>Map</code>æ¥å£å†…çš„ä¸€äº›æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">interface</span> <span class="title">class</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">Map</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(java.lang.Object, java.lang.Object)</span></span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> java.lang.<span class="function">Object <span class="title">get</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> java.lang.<span class="function">Object <span class="title">put</span><span class="params">(java.lang.Object, java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(java.lang.Object, java.lang.Object, java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replaceAll</span><span class="params">(java.util.function.BiFunction)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(java.util.Map)</span></span>;</span><br><span class="line">  <span class="keyword">public</span> java.lang.<span class="function">Object <span class="title">putIfAbsent</span><span class="params">(java.lang.Object, java.lang.Object)</span></span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> java.util.<span class="function">Set <span class="title">keySet</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(java.lang.Object)</span></span>;</span><br><span class="line">  <span class="keyword">public</span> java.lang.<span class="function">Object <span class="title">getOrDefault</span><span class="params">(java.lang.Object, java.lang.Object)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(java.util.function.BiConsumer)</span></span>;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºæ¥å°±æ˜¯ <strong>å¤§å°ï¼ŒåŠ æ˜ å°„ï¼Œåˆ æ˜ å°„ï¼Œç”¨é”®æŸ¥å€¼ï¼Œæ˜¯å¦ç©º</strong> ç­‰ç­‰ï¼Œè¿™äº›æ˜ å°„æœ€åŸºç¡€çš„åŠŸèƒ½ã€‚è¿˜æœ‰äº›è§†å›¾çš„éƒ¨åˆ†ï¼Œä¸‹ç¯‡æ–‡ç« å…·ä½“è®²</p>
<h2 id="Collectionçš„å­æ¥å£"><a class="header-anchor" href="#Collectionçš„å­æ¥å£">Â¶</a>Collectionçš„å­æ¥å£</h2>
<h3 id="List"><a class="header-anchor" href="#List">Â¶</a>List</h3>
<p>æœ‰åºé›†åˆï¼Œæ–°åŠ æ”¯æŒéšæœºè®¿é—®åŠŸèƒ½ï¼š</p>
<ul>
<li>add(n, å…ƒç´ )</li>
<li>remove(n)</li>
<li>get(n)</li>
<li>set(n, å…ƒç´ )</li>
</ul>
<h3 id="Set"><a class="header-anchor" href="#Set">Â¶</a>Set</h3>
<ol>
<li>å…ƒç´ ä¸é‡å¤ï¼Œæ‰€ä»¥è¦é€‚å½“çš„å®šä¹‰<code>equals</code>æ–¹æ³•ï¼›</li>
<li>å­æ¥å£<code>SortedSet</code>ï¼Œæ•…åæ€ä¹‰æ˜¯æ’å¥½åºçš„ï¼Œæ‰€ä»¥è¦é€‚å½“çš„å®šä¹‰æ¯”è¾ƒå™¨</li>
<li><code>SortedSet</code>çš„å­æ¥å£<code>NavigableSet</code>ä¸­è®¾è®¡äº†ä¸€äº›æœç´ ï¼Œéå†çš„æ–¹æ³•</li>
</ol>
<h3 id="Queue"><a class="header-anchor" href="#Queue">Â¶</a>Queue</h3>
<ol>
<li>å…¥é˜Ÿå°¾ï¼Œå‡ºå¯¹å¤´</li>
<li>å­æ¥å£<code>Qeque</code>åŒç«¯é˜Ÿåˆ—ï¼Œä¸¤å¤´éƒ½å¯ä»¥å‡ºå…¥</li>
</ol>
<h2 id="Mapçš„å­æ¥å£"><a class="header-anchor" href="#Mapçš„å­æ¥å£">Â¶</a>Mapçš„å­æ¥å£</h2>
<p>å…¶å®å’Œ<code>Set</code>å·®ä¸å¤š</p>
<ol>
<li>å­æ¥å£<code>SortedMap</code>ï¼Œæ•…åæ€ä¹‰æ˜¯æ’å¥½åºçš„ï¼Œæ‰€ä»¥è¦é€‚å½“çš„å®šä¹‰æ¯”è¾ƒå™¨</li>
<li><code>SortedMap</code>çš„å­æ¥å£<code>NavigableMap</code>ä¸­è®¾è®¡äº†ä¸€äº›æœç´ ï¼Œéå†çš„æ–¹æ³•</li>
</ol>
<h1>å¯¹æ¥å£çš„å®ç°</h1>
<h2 id="List-v2"><a class="header-anchor" href="#List-v2">Â¶</a>List</h2>
<h3 id="LinkedList-é“¾è¡¨"><a class="header-anchor" href="#LinkedList-é“¾è¡¨">Â¶</a>LinkedList(é“¾è¡¨)</h3>
<p>javaä¸­çš„é“¾è¡¨éƒ½æ˜¯åŒå‘çš„ï¼ˆæœ‰å‰é©±åé©±ï¼‰ã€‚é‡ç‚¹è®²ä¸‹å®ƒçš„è¿­ä»£å™¨<code>ListIterator</code></p>
<ul>
<li>åˆå§‹ä½ç½®ï¼š |ABCD</li>
<li><code>iter.next</code>:  A|BCD</li>
<li><code>iter.previous</code>: |ABCD</li>
<li><code>iter.add</code> : æŠŠå…ƒç´ åŠ åˆ°å…‰æ ‡<code>|</code>ä¹‹å‰ï¼Œæ³¨æ„æ˜¯ä¹‹å‰</li>
<li><code>iter.remove</code>å¿…é¡»åœ¨<code>it.next</code>æˆ–<code>it.previous</code>ä½¿ç”¨ä¹‹åä½¿ç”¨ï¼ŒæŠŠå…‰æ ‡<strong>ç»è¿‡</strong>çš„å…ƒç´ åˆ é™¤</li>
</ul>
<p>é“¾è¡¨ä½¿ç”¨æ³¨æ„ï¼š</p>
<ul>
<li>ä½¿ç”¨é“¾è¡¨æ˜¯å¯ä»¥å‡å°‘åœ¨åˆ—è¡¨ä¸­é—´æ’å…¥åˆ é™¤å…ƒç´ æ‰€ä»˜å‡ºçš„ä»£ä»·ã€‚</li>
<li>é¿å…ä½¿ç”¨ä»¥æ•´æ•°ç´¢å¼•é“¾è¡¨ä¸­çš„ä½ç½®ï¼Œè¿™æ ·æ•ˆç‡å¾ˆä½</li>
</ul>
<h3 id="ArrayList-æ•°ç»„åˆ—è¡¨"><a class="header-anchor" href="#ArrayList-æ•°ç»„åˆ—è¡¨">Â¶</a>ArrayList(æ•°ç»„åˆ—è¡¨)</h3>
<p><code>ArrayList</code>ï¼š åŠ¨æ€æ³›å‹æ•°ç»„åˆ—è¡¨ï¼Œå¯ä»¥è‡ªåŠ¨è°ƒèŠ‚æ•°ç»„å®¹é‡ã€‚å½“éœ€è¦éšæœºè®¿é—®æ—¶ä½¿ç”¨å®ƒæ•ˆç‡æ›´é«˜ï¼Œä¸ç”¨é“¾è¡¨ã€‚<br>
è®²ä¸‹<code>capacity</code>å’Œ<code>size</code>çš„åŒºåˆ«ï¼š</p>
<ul>
<li><code>new ArrayList&lt;&gt;(100)</code>	100 æ˜¯<code>capacity</code>ï¼Œæ˜¯åˆå§‹å®¹é‡ï¼Œå¦‚æœå®é™…sizeè¶…è¿‡å®ƒï¼Œå®¹é‡ä¼šè‡ªåŠ¨å¢åŠ </li>
<li><code>array.size()</code>è¿”å›çš„æ˜¯æ•°ç»„åˆ—è¡¨å†…å…ƒç´ å®é™…çš„ä¸ªæ•°ã€‚</li>
</ul>
<p>p.s. è¿™å’Œc++çš„ <code>vector</code> å¾ˆåƒ</p>
<h2 id="Set-v2"><a class="header-anchor" href="#Set-v2">Â¶</a>Set</h2>
<h3 id="HashSet-æ•£åˆ—é›†"><a class="header-anchor" href="#HashSet-æ•£åˆ—é›†">Â¶</a>HashSet(æ•£åˆ—é›†)</h3>
<p><img src="corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-5-%E9%9B%86%E5%90%88/hash.png" alt="æ•£åˆ—è¡¨" title="æ•£åˆ—è¡¨"></p>
<ul>
<li><code>HashSet</code>: åŸºäºæ•£åˆ—è¡¨çš„Setï¼Œå†…éƒ¨ç”¨é“¾è¡¨æ•°ç»„å®ç°ã€‚åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®šå®¹é‡å’Œè£…å¡«å› å­ã€‚</li>
<li>ç”±äºHashSetè®¿é—®æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥å½“ä¸éœ€è¦å…³å¿ƒé›†åˆä¸­çš„é¡ºåºæ—¶æ‰ä½¿ç”¨å®ƒã€‚</li>
<li>å­ç±»<code>LinkedHashSet</code>ï¼Œé‡Œé¢çš„å…ƒç´ ä¹‹é—´æ˜¯åŒå‘é“¾è¡¨ï¼Œè¿­ä»£å™¨æ˜¯æŒ‰<strong>æ’å…¥é¡ºåº</strong>è¿›è¡Œè®¿é—®çš„ã€‚</li>
</ul>
<h3 id="TreeSet-æ ‘é›†"><a class="header-anchor" href="#TreeSet-æ ‘é›†">Â¶</a>TreeSet(æ ‘é›†)</h3>
<p>-<code>TreeSet</code>: å®ç°<code>SortedSet</code>æ¥å£ï¼Œå†…éƒ¨åŸºäº<strong>çº¢é»‘æ ‘</strong>ã€‚ç”±äºæ˜¯æœ‰é¡ºåºçš„ï¼Œæ‰€ä»¥ç”¨æˆ·ä¸€èˆ¬è¦è‡ªå®šä¹‰æ¯”è¾ƒå™¨ã€‚è¿­ä»£å™¨æ˜¯æŒ‰<strong>æ’åºé¡ºåº</strong>è¿›è¡Œè®¿é—®çš„ã€‚</p>
<ul>
<li>å½“ä¸éœ€è¦é¡ºåºæ—¶ï¼Œç”¨<code>HashSet</code>ï¼Œå› ä¸ºå®ƒæ›´å¿«ã€‚</li>
<li>å¯ä»¥å®ç°å‡çº§ç‰ˆ<code>NavigableSet</code>æ¥å£ï¼Œhigher(v),lower(v),pollFirst(),pollLast(),åå‘è¿­ä»£ ç­‰ç­‰ã€‚</li>
</ul>
<h2 id="Queue-v2"><a class="header-anchor" href="#Queue-v2">Â¶</a>Queue</h2>
<p>ä¸€èˆ¬ç”¨å®ƒçš„å‡çº§ç‰ˆ<code>Deque</code>ï¼Œè€Œ<code>Deque</code>å¯ä»¥ç”±<code>ArrayDeque</code>å’Œ<code>LinkedList</code>å®ç°ã€‚ä¸‹é¢ä¸»è¦ä»‹ç»<code>PriorityQueue</code></p>
<h3 id="PriorityQueue-ä¼˜å…ˆçº§é˜Ÿåˆ—"><a class="header-anchor" href="#PriorityQueue-ä¼˜å…ˆçº§é˜Ÿåˆ—">Â¶</a>PriorityQueue(ä¼˜å…ˆçº§é˜Ÿåˆ—)</h3>
<ul>
<li><code>PriorityQueue</code>ï¼šä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå†…éƒ¨åŸºäº<strong>å †</strong>ï¼ˆheapï¼‰ã€‚</li>
<li>æŒ‰ä»»æ„é¡ºåºæ’å…¥ï¼Œå´æ€»æ˜¯æŒ‰æ’åºé¡ºåºè¾“å‡º<strong>æœ€å°å€¼</strong>ã€‚</li>
<li><code>PriorityQueue&lt;Type&gt; pq = new PriorityQueue();</code>ï¼Œä»å·¦è¾¹å¯ä»¥çœ‹å‡ºè¿™è´§æ˜¯ç±»ã€‚</li>
</ul>
<h2 id="Map-v2"><a class="header-anchor" href="#Map-v2">Â¶</a>Map</h2>
<h3 id="HashMap"><a class="header-anchor" href="#HashMap">Â¶</a>HashMap</h3>
<ul>
<li>é¡¾åæ€ä¹‰å’Œ<code>HashSet</code>å·®ä¸å¤šï¼Œåªä¸è¿‡æ˜¯å¯¹å»ºè¿›è¡Œæ•£åˆ—ã€‚</li>
<li>å­ç±»<code>LinkedHashMap</code>ï¼Œæ³¨æ„é“¾è¡¨æ•£å°„æ˜ å°„ï¼Œè¿­ä»£å™¨æ˜¯æŒ‰<strong>è®¿é—®é¡ºåº</strong>è¿›è¡Œè®¿é—®çš„ã€‚æ¯æ¬¡è°ƒç”¨ get æˆ– put, å—åˆ°å½±å“çš„æ¡ç›®å°†ä»å½“å‰çš„ä½ç½®åˆ é™¤ï¼Œå¹¶æ”¾åˆ°æ¡ç›®é“¾è¡¨çš„å°¾éƒ¨ã€‚</li>
</ul>
<h3 id="TreeMap"><a class="header-anchor" href="#TreeMap">Â¶</a>TreeMap</h3>
<ul>
<li>é¡¾åæ€ä¹‰å’Œ<code>HashMap</code>å·®ä¸å¤šï¼Œåªä¸è¿‡æ˜¯å¯¹å»ºè¿›è¡Œ<strong>çº¢é»‘æ ‘</strong>æ’åºã€‚</li>
<li>åŒæ · å½“ä¸éœ€è¦é¡ºåºæ—¶ï¼Œç”¨<code>HashMap</code>ï¼Œå› ä¸ºå®ƒæ›´å¿«.</li>
</ul>
<p>ä¸€äº›æŠ€å·§ï¼š</p>
<ul>
<li>éå†Mapï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">scores.forEach((k, v) -&gt; <span class="comment">// è®¿é—® k, v çš„æœ€å¿«æ–¹æ³•</span></span><br><span class="line">        System.out.println(<span class="string">"key="</span> + k + <span class="string">", value"</span> + v));</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”¨ Map è®¡æ•°ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">scores.put(<span class="string">"Jack"</span>, scores.getOrDefault(<span class="string">"Jack"</span>, <span class="number">0</span>) + <span class="number">1</span>); <span class="comment">// æ–¹æ³•1</span></span><br><span class="line">scores.merge(<span class="string">"Jack"</span>, <span class="number">1</span>, Integer::sum); <span class="comment">// æ–¹æ³•2</span></span><br></pre></td></tr></table></figure>
<h3 id="WeekHashMap"><a class="header-anchor" href="#WeekHashMap">Â¶</a>WeekHashMap</h3>
<p>å¼±æ•£åˆ—æ˜ å°„ï¼šå½“å¯¹é”®çš„å”¯ä¸€å¼•ç”¨æ¥è‡ªæ•£åˆ—æ¡ç›®æ—¶ï¼Œè¿™ä¸€æ•°æ®ç»“æ„å°†ä¸åƒåœ¾å›æ”¶å™¨ååŒå·¥ä½œä¸€èµ·åˆ é™¤é”® / å€¼å¯¹ã€‚ä¹Ÿå°±æ˜¯å½“æŸä¸ªå€¼æ²¡ç”¨äº†å®ƒä¼šè¢«è‡ªåŠ¨å›æ”¶ã€‚</p>
<h3 id="IdentityHashMap"><a class="header-anchor" href="#IdentityHashMap">Â¶</a>IdentityHashMap</h3>
<ul>
<li><code>IdentityHashMap</code> ä¸­ é”®çš„æ•£åˆ—å€¼ ä¸æ˜¯ç”¨ hashCode å‡½æ•°è®¡ç®—çš„ï¼Œè€Œæ˜¯ç”¨ <code>System.identityHashCode</code> æ–¹æ³•è®¡ç®—çš„ï¼ˆ<code>Object.hashCode</code>æ–¹æ³•æ ¹æ®å¯¹è±¡çš„å†…å­˜åœ°å€æ¥è®¡ç®—æ•£åˆ—ç æ—¶æ‰€ä½¿ç”¨çš„æ–¹å¼ï¼‰ã€‚</li>
<li>æ‰€ä»¥ï¼Œåœ¨å¯¹ä¸¤ä¸ªå¯¹è±¡è¿›è¡Œæ¯”è¾ƒæ—¶ï¼ŒIdentityHashMap ä½¿ç”¨ == , è€Œä¸ä½¿ç”¨equalã€‚ä¹Ÿå°±æ˜¯ä¸åŒçš„é”®å¯¹è±¡ï¼Œå³ä½¿å†…å®¹ç›¸åŒï¼Œä¹Ÿè¢«è§†ä¸ºæ˜¯ä¸åŒçš„å¯¹è±¡ã€‚</li>
<li>åœ¨å®ç°å¯¹è±¡éå†ç®—æ³• (å¦‚å¯¹è±¡ä¸²è¡ŒåŒ–)æ—¶ï¼Œå¯ä»¥å®ƒç”¨æ¥è·Ÿè¸ªæ¯ä¸ªå¯¹è±¡çš„éå†çŠ¶å†µã€‚</li>
</ul>
<h1>é—ç•™çš„é›†åˆ</h1>
<p>çœ‹çœ‹å°±å¥½ï¼Œé‡åˆ°æ—¶å†æŸ¥ä¹¦</p>
<p><img src="corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-5-%E9%9B%86%E5%90%88/yiliu.png" alt="é—ç•™é›†åˆ" title="é—ç•™é›†åˆ"></p>
<p>æœ¬æ–‡ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/Zouxxyy/java-learning/tree/master/corejava-learning/src/com/zouxxyy/corejava/chap9" title="github" target="_blank" rel="noopener">github</a></p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>corejavaåŸºç¡€çŸ¥è¯†(4)-é€šé…ç¬¦</title>
    <url>/2019/03/05/corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86(4)-%E9%80%9A%E9%85%8D%E7%AC%A6/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ java é€šé…ç¬¦çš„æ€»ç»“</p>
<a id="more"></a>
<h1>é€šé…ç¬¦</h1>
<h2 id="æ³›å‹çš„å±€é™æ€§ä¸æ¼æ´"><a class="header-anchor" href="#æ³›å‹çš„å±€é™æ€§ä¸æ¼æ´">Â¶</a>æ³›å‹çš„å±€é™æ€§ä¸æ¼æ´</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Pair&lt;Employee&gt; employeePair= <span class="keyword">new</span> Pair&lt;&gt;(<span class="keyword">new</span> Employee(<span class="string">"å‘˜å·¥1"</span>), <span class="keyword">new</span> Employee(<span class="string">"å‘˜å·¥2"</span>));</span><br><span class="line">Pair&lt;Manager&gt; managerPair= <span class="keyword">new</span> Pair&lt;&gt;(<span class="keyword">new</span> Manager(<span class="string">"ç»ç†1"</span>, <span class="number">100</span>), <span class="keyword">new</span> Manager(<span class="string">"ç»ç†2"</span>, <span class="number">200</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æµ‹è¯•1</span></span><br><span class="line"><span class="comment">//employeePair = managerPair; //é”™è¯¯ï¼Œ `Pair&lt;S&gt;`å’Œ`Pair&lt;T&gt;`æ²¡æœ‰ä»€ä¹ˆè”ç³»ã€‚</span></span><br><span class="line"><span class="comment">//managerPair = employeePair // é”™è¯¯ï¼Œ `Pair&lt;S&gt;`å’Œ`Pair&lt;T&gt;`æ²¡æœ‰ä»€ä¹ˆè”ç³»ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æµ‹è¯•2</span></span><br><span class="line">Pair pair = employeePair; <span class="comment">// æ³›å‹ä¸åŸå§‹å†…å®¹å…¼å®¹ï¼Œä½†æ˜¯ï¼Œçœ‹ä¸‹é¢</span></span><br><span class="line"><span class="comment">//pair.getFirs t().getName(); // error, æ˜¯Employeeç±»ï¼Œä½†æ˜¯ä¸èƒ½è°ƒç”¨æ–¹æ³•!</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æµ‹è¯•3</span></span><br><span class="line">employeePair.setFirst(<span class="keyword">new</span> Manager(<span class="string">"ç»ç†3"</span>, <span class="number">300</span>)); <span class="comment">// employeePairé‡Œç»ç†ç«Ÿç„¶å’Œå‘˜å·¥ç»„æˆä¸€å¯¹ï¼</span></span><br><span class="line">System.out.println(employeePair.getFirst().getName()); <span class="comment">// ç»ç†3</span></span><br><span class="line">System.out.println(employeePair.getSecond().getName()); <span class="comment">// å‘˜å·¥2</span></span><br><span class="line"><span class="comment">// System.out.println(((employeePair.getFirst())).getSalary()); // error</span></span><br><span class="line">System.out.println(((Manager)(employeePair.getFirst())).getSalary()); <span class="comment">// 300.0 ï¼Œæ·»åŠ ç±»å¼ºåˆ¶ç±»å‹è½¬æ¢åå¯ä»¥è°ƒç”¨ï¼Œè¿™ä¸æ™®é€šç±»ç»§æ‰¿è§„åˆ™ä¸€æ ·</span></span><br></pre></td></tr></table></figure>
<p>å®Œæ•´ä»£ç ï¼š<a href="https://github.com/Zouxxyy/java-learning/blob/master/corejava-learning/src/com/zouxxyy/corejava/chap8/inherit/testInherit.java" title="github" target="_blank" rel="noopener">ç»§æ‰¿ç¤ºä¾‹</a></p>
<ol>
<li>æ— è®º S å’Œ T æœ‰ä»€ä¹ˆå…³ç³»ï¼Œ<code>Pair&lt;S&gt;</code>å’Œ<code>Pair&lt;T&gt;</code>æ²¡æœ‰ä»€ä¹ˆè”ç³»ã€‚</li>
<li>æ³›å‹ä¸åŸå§‹å†…å®¹å…¼å®¹ï¼Œä½†æ˜¯åŸå§‹å†…å®¹é‡Œçš„ç±»å‹å‚æ•°è¿™ä¸ªå¯¹è±¡æ— æ³•è°ƒç”¨æ–¹æ³•</li>
<li>æ³›å‹é‡Œçš„ç±»å‹å‚æ•°å¯ä»¥ç»§æ‰¿ï¼Œå’Œç±»çš„ç»§æ‰¿è§„åˆ™ä¸€æ ·</li>
</ol>
<h2 id="extends-Objectï¼ˆä¸Šè¾¹ç•Œé™å®šé€šé…ç¬¦ï¼‰"><a class="header-anchor" href="#extends-Objectï¼ˆä¸Šè¾¹ç•Œé™å®šé€šé…ç¬¦ï¼‰">Â¶</a>?  extends Objectï¼ˆä¸Šè¾¹ç•Œé™å®šé€šé…ç¬¦ï¼‰</h2>
<p>å¯ä»¥çœ‹å‡ºæ¥åŸå§‹æ³›å‹é‡ä¸Šç»§æ‰¿æ—¶ä¼šæœ‰äº›æ¼æ´ï¼Œæ¯”å¦‚ä¼šå‡ºç°ç»ç†å‘˜å·¥åœ¨åŒä¸€<code>Pair</code>çš„æƒ…å†µã€‚äºæ˜¯Javaä¸“å®¶å¼•å…¥äº†ç±»å‹é€šé…ç¬¦ <code>?</code></p>
<p>æˆ‘ä»¬æŠŠåˆšåˆšçš„ç¬¬ä¸€è¡Œæ”¹ä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Pair&lt;? extends Employee&gt; employeePair= <span class="keyword">new</span> Pair&lt;&gt;(<span class="keyword">new</span> Employee(<span class="string">"å‘˜å·¥1"</span>), <span class="keyword">new</span> Employee(<span class="string">"å‘˜å·¥2"</span>));</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå¦‚æœå†å‘é‡Œé¢æ·»åŠ <code>	Manager</code>æ—¶å°±ä¼šå‘ç”Ÿé”™è¯¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">employeePair.setFirst(<span class="keyword">new</span> Manager(<span class="string">"ç»ç†3"</span>, <span class="number">300</span>)); <span class="comment">// é”™è¯¯</span></span><br><span class="line">employeePair.setFirst(<span class="keyword">new</span> Employee(<span class="string">"å‘˜å·¥"</span>)); <span class="comment">// é”™è¯¯ï¼Œç”šè‡³æ·»åŠ å‘˜å·¥éƒ½ä¸è¡Œ</span></span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è®¿é—®å¯ä»¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Employee employee = employeePair.getFirst(); <span class="comment">// æ­£ç¡®</span></span><br></pre></td></tr></table></figure>
<h3 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h3>
<p>é¦–å…ˆæ°¸è¿œè®°ä½<strong>åªèƒ½è¶…ç±»æ¥æ”¶å­ç±»ï¼ï¼ï¼åè¿‡æ¥ä¸è¡Œï¼ï¼ï¼</strong>ï¼ˆè¿™ä¸ªå¯ä»¥è§£é‡Šä¸‹é¢çš„ä¸€åˆ‡ï¼‰</p>
<p><strong>ç±»å‹æ“¦é™¤</strong> å <code>Pair&lt;? extends Employee&gt;</code> çš„æ–¹æ³•æœ‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">? <span class="function">extends Employee <span class="title">getFirst</span><span class="params">()</span> </span>&#123;...&#125; <span class="comment">// è®¿é—®å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(? extends Employee)</span> </span>&#123;...&#125; <span class="comment">// æ›´æ”¹å™¨</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è®¿é—®å™¨çš„è¿”å›å€¼æ˜¯<code>? extends Employee</code> ï¼Œå¯ä»¥ç”¨å­ç±»<code>Employee</code>æ¥æ”¶</li>
<li>æ›´æ”¹å™¨çš„æ¥æ”¶å€¼æ˜¯<code>? extends Employee</code> ï¼Œæç«¯æƒ…å†µæ˜¯<code>Employee</code>çš„<code>æœ€ä¸‹é¢çš„å­ç±»</code>ï¼Œè€Œ<code>æœ€ä¸‹é¢çš„å­ç±»</code>åªèƒ½æ¥æ”¶æ›´ä¸‹é¢çš„å­ç±»ï¼ˆæ— ï¼‰ï¼Œå› æ­¤ <strong>æ‹’ç»æ¥æ”¶ä»»ä½•ç‰¹å®šçš„ç±»å‹ï¼</strong></li>
</ul>
<h3 id="å°ç»“"><a class="header-anchor" href="#å°ç»“">Â¶</a>å°ç»“</h3>
<p>ç®€å•è¯´å°±æ˜¯ï¼š<br>
å¯ä»¥ <code>Employee</code> &lt;-- <code>? extends Employee</code> ï¼Œä½†æ˜¯åè¿‡æ¥ä¸è¡Œï¼</p>
<p>æ‰€ä»¥è¿™å°±æ˜¯å¤§å®¶è¯´çš„ä½¿ç”¨<code>? extends Object</code> å¯ä»¥ <strong>å®‰å…¨çš„è®¿é—®æ³›å‹å¯¹è±¡</strong>ã€‚æˆ‘çš„ç†è§£æ ¸å¿ƒæ˜¯ï¼šå¦‚æœ<code>T</code>ä½œä¸º<strong>è¿”å›å€¼</strong>ï¼Œç”¨<code>? extends Object</code>æ›´å®‰å…¨ã€‚</p>
<h2 id="super-Objectï¼ˆä¸‹è¾¹ç•Œé™å®šé€šé…ç¬¦ï¼‰"><a class="header-anchor" href="#super-Objectï¼ˆä¸‹è¾¹ç•Œé™å®šé€šé…ç¬¦ï¼‰">Â¶</a>?  super Objectï¼ˆä¸‹è¾¹ç•Œé™å®šé€šé…ç¬¦ï¼‰</h2>
<p>è¿™ä¸ªå’Œä¸Šé¢æ­£å¥½ç›¸åï¼Œæ›´æ”¹å™¨èƒ½ç”¨ï¼Œè®¿é—®å™¨ä¸èƒ½ç”¨ã€‚</p>
<h3 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">? <span class="function"><span class="keyword">super</span> Employee <span class="title">getFirst</span><span class="params">()</span> </span>&#123;...&#125; <span class="comment">// è®¿é—®å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(? <span class="keyword">super</span> Employee)</span> </span>&#123;...&#125; <span class="comment">// æ›´æ”¹å™¨</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è®¿é—®å™¨çš„è¿”å›å€¼æ˜¯<code>? super Employee</code> ï¼Œæç«¯æƒ…å†µæ˜¯<code>Object</code>ï¼Œåªèƒ½ç”¨<code>Object</code>æ¥æ”¶</li>
<li>æ›´æ”¹å™¨çš„æ¥æ”¶å€¼æ˜¯<code>? super Employee</code> ï¼Œå¯ä»¥æ¥æ”¶<code>Employee å’Œ å®ƒçš„å­ç±»</code></li>
</ul>
<h3 id="å°ç»“-v2"><a class="header-anchor" href="#å°ç»“-v2">Â¶</a>å°ç»“</h3>
<p>ç®€å•è¯´å°±æ˜¯ï¼š<br>
å¯ä»¥ <code>? super Employee</code> &lt;-- <code>Employee</code> ï¼Œä½†æ˜¯åè¿‡æ¥ä¸è¡Œï¼</p>
<p>æ‰€ä»¥è¿™å°±æ˜¯å¤§å®¶è¯´çš„ä½¿ç”¨<code>? super Object</code> å¯ä»¥ <strong>å®‰å…¨çš„æ›´æ”¹æ³›å‹å¯¹è±¡</strong>ã€‚æˆ‘çš„ç†è§£æ ¸å¿ƒæ˜¯ï¼šå¦‚æœ<code>T</code>ä½œä¸º<strong>æ–¹æ³•å‚æ•°</strong>ï¼Œç”¨<code>? super Object</code>æ›´å®‰å…¨ã€‚</p>
<h3 id="å…±åŒç‰¹ç‚¹"><a class="header-anchor" href="#å…±åŒç‰¹ç‚¹">Â¶</a>å…±åŒç‰¹ç‚¹</h3>
<p>å³è¾¹çš„å€¼ä¼ ç»™å·¦è¾¹æ¥æ”¶ï¼š</p>
<p><code>? super Employee</code> &lt;-- <code>Employee</code> &lt;-- <code>? extends Employee</code></p>
<p>æ˜¯ä¸æ˜¯å®Œå…¨ç¬¦åˆ <strong>åªèƒ½è¶…ç±»æ¥æ”¶å­ç±»</strong>ï¼ŒçŸ¥é“åŸç†è®°èµ·æ¥å°±ç®€å•ã€‚</p>
<h3 id="ä¾‹å­"><a class="header-anchor" href="#ä¾‹å­">Â¶</a>ä¾‹å­</h3>
<p>ä¸¾ä¹¦ä¸Šçš„ä¸€ä¸ªä¾‹å­ä½œä¸ºç»ƒä¹ ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; <span class="function">T <span class="title">min</span><span class="params">(T[] a)</span> <span class="comment">//è®¡ç®—T[]çš„æœ€å°å€¼</span></span></span><br></pre></td></tr></table></figure>
<p>ç†è§£ï¼š</p>
<ul>
<li><code>T extends...</code> å¥½ç†è§£ï¼Œå°±æ˜¯<code>T</code>è¦å®ç°åé¢çš„æ¥å£ã€‚</li>
<li>å®ç°<code>Comparable&lt;? super T&gt;</code> æ¥å£é‡Œçš„æ–¹æ³•<code>int compareTo(? super T)</code>ï¼›æ­¤æ—¶<code>ç±»å‹</code>ä½œä¸º æ–¹æ³•å‚æ•°ï¼Œæ‰€ä»¥ç”¨<code>? super</code>æ›´å®‰å…¨ã€‚</li>
</ul>
<h2 id="ï¼Ÿï¼ˆæ— é™å®šé€šé…ç¬¦ï¼‰"><a class="header-anchor" href="#ï¼Ÿï¼ˆæ— é™å®šé€šé…ç¬¦ï¼‰">Â¶</a>ï¼Ÿï¼ˆæ— é™å®šé€šé…ç¬¦ï¼‰</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">? getFirst() &#123;...&#125; <span class="comment">// è®¿é—®å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(?)</span> </span>&#123;...&#125; <span class="comment">// æ›´æ”¹å™¨</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è®¿é—®å™¨åªèƒ½ç”¨<code>Object</code>æ¥æ”¶</li>
<li>æ›´æ”¹å™¨ä¸èƒ½ç”¨</li>
</ul>
<p>å¯ä»¥ç”¨ä»»æ„<code>Object</code>å¯¹è±¡è°ƒç”¨åŸå§‹ <code>Pair</code>ç±»çš„<code>setObject</code>æ–¹æ³•ï¼Œè¯´ç™½äº†å°±æ˜¯ä»€ä¹ˆç±»å‹éƒ½èƒ½<br>
ä½œä¸ºæ³›å‹æ–¹æ³•çš„æ–¹æ³•å‚æ•°ï¼Œä½†å°±æ˜¯ä¸èƒ½æœ‰è¿”å›å€¼ã€‚</p>
<h2 id="é€šé…ç¬¦æ•è·"><a class="header-anchor" href="#é€šé…ç¬¦æ•è·">Â¶</a>é€šé…ç¬¦æ•è·</h2>
<p>ç”±äºé€šé…ç¬¦ä¸èƒ½ä½œä¸ºç±»å‹å˜é‡ï¼Œæ‰€ä»¥å¿…è¦æ—¶å¯ä»¥ç”¨ä¸€ä¸ªè¾…åŠ©çš„æ³›å‹æ–¹æ³•ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šè¾…åŠ©æ³›å‹æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">swapHelper</span><span class="params">(Pair&lt;T&gt; p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    T t = p.getFirst();</span><br><span class="line">    p.setFirst(p.getSecond());</span><br><span class="line">    p.setSecond(t);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒæ­¥ï¼šé€šé…ç¬¦æ•è·</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(Pair&lt;?&gt; p)</span></span>&#123; swapHelper(p); &#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç¤ºä¾‹"><a class="header-anchor" href="#ç¤ºä¾‹">Â¶</a>ç¤ºä¾‹</h2>
<p>å®Œæ•´ä»£ç ï¼š<a href="https://github.com/Zouxxyy/java-learning/blob/master/corejava-learning/src/com/zouxxyy/corejava/chap8/pair3/PairTest3.java" title="github" target="_blank" rel="noopener">é€šé…ç¬¦ç¤ºä¾‹</a></p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>corejavaåŸºç¡€çŸ¥è¯†(3)-æ³›å‹</title>
    <url>/2019/03/05/corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86(3)-%E6%B3%9B%E5%9E%8B/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ java æ³›å‹çš„æ€»ç»“</p>
<a id="more"></a>
<h1>æ³›å‹</h1>
<h2 id="æ³›å‹ç±»ä¸æ–¹æ³•çš„ä¸€èˆ¬æ ¼å¼"><a class="header-anchor" href="#æ³›å‹ç±»ä¸æ–¹æ³•çš„ä¸€èˆ¬æ ¼å¼">Â¶</a>æ³›å‹ç±»ä¸æ–¹æ³•çš„ä¸€èˆ¬æ ¼å¼</h2>
<p>æ³›å‹ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T first; </span><br><span class="line">    <span class="keyword">private</span> T second;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">()</span> </span>&#123; first = <span class="keyword">null</span> ; second = <span class="keyword">null</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(T first, T second)</span> </span>&#123; <span class="keyword">this</span>.first = first; <span class="keyword">this</span>.second = second; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getFirst</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> first; &#125; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getSecond</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> second; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(T newValue)</span> </span>&#123; first = newValue; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecond</span><span class="params">(T newValue)</span> </span>&#123; second = newValue; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³›å‹æ–¹æ³•:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArrayAlg</span></span></span><br><span class="line"><span class="class"></span>&#123; </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getMiddle</span><span class="params">(T... a)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> a[a.length / <span class="number">2</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•æ˜¯åœ¨æ™®é€šç±»å®šä¹‰çš„æ³›å‹æ–¹æ³•ï¼Œè°ƒç”¨æ—¶ï¼š</p>
<p><code>String middle = ArrayAlg.&lt;String&gt;getMiddle(&quot;]ohnM, &quot;Q.n, &quot;Public&quot;);</code></p>
<p>æœ¯è¯­ï¼š</p>
<ul>
<li><code>ArrayList&lt;E&gt;</code> â€“ æ³›å‹ç±»å‹</li>
<li><code>ArrayList</code> â€“ åŸå§‹ç±»å‹</li>
<li><code>E</code> â€“ ç±»å‹å‚æ•°(å˜é‡)</li>
<li><code>&lt;&gt;</code> â€“ è¯»ä½œâ€typeofâ€</li>
<li><code>ArrayList&lt;Integer&gt;</code> â€“ å‚æ•°åŒ–çš„ç±»å‹</li>
<li><code>Integer</code> â€“ å®é™…ç±»å‹å‚æ•°</li>
</ul>
<h2 id="ç±»å‹å˜é‡çš„é™å®š"><a class="header-anchor" href="#ç±»å‹å˜é‡çš„é™å®š">Â¶</a>ç±»å‹å˜é‡çš„é™å®š</h2>
<p>æˆ‘ä»¬å¯ä»¥å¯¹ç±»å‹å˜é‡åŠ ä»¥çº¦æŸï¼Œæ¯•ç«Ÿæˆ‘ä»¬å¾ˆéš¾é€‚ç”¨æ¯ç§æ³›å‹ã€‚å¯ä»¥é€šè¿‡å¯¹ç±»å‹å˜é‡ T è®¾ç½®é™å®š(bound) å®ç°è¿™ä¸€ç‚¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><code>&lt;T extends BoundingType&gt;</code></p>
<p>BoundingType å¯ä»¥æ˜¯</p>
<ul>
<li><strong>ç±»</strong>ï¼šT æ˜¯å®ƒçš„å­ç±»å‹(subtype)</li>
<li><strong>æ¥å£</strong>ï¼š T æ˜¯å®ç°äº†è¯¥æ¥å£çš„ç±»</li>
</ul>
<p>å¯ä»¥æœ‰å¤šä¸ªæ¥å£ï¼Œå½“ç„¶è‡³å¤šæœ‰ä¸€ä¸ªç±»ï¼Œç”¨ â€œ&amp;â€ åˆ†éš”ã€‚</p>
<p><strong>ps: ç”±äºç±»å‹æ“¦é™¤æœºåˆ¶ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œåº”è¯¥å°†æ ‡ç­¾(tagging) æ¥å£ (å³æ²¡æœ‰æ–¹æ³•çš„æ¥å£)æ”¾åœ¨è¾¹ç•Œåˆ—è¡¨çš„æœ«å°¾ã€‚</strong></p>
<h2 id="æ³›å‹è½¬åŒ–çš„å†…éƒ¨"><a class="header-anchor" href="#æ³›å‹è½¬åŒ–çš„å†…éƒ¨">Â¶</a>æ³›å‹è½¬åŒ–çš„å†…éƒ¨</h2>
<ul>
<li>è™šæ‹Ÿæœºä¸­æ²¡æœ‰æ³›å‹ï¼Œ åªæœ‰æ™®é€šçš„ç±»å’Œæ–¹æ³•ï¼›æ‰€æœ‰çš„ç±»å‹å‚æ•°éƒ½ç”¨å®ƒä»¬çš„é™å®šç±»å‹æ›¿æ¢ã€‚</li>
<li>ç¼–è¯‘å™¨åœ¨è°ƒç”¨æ³›å‹æ–¹æ³•æ—¶ä¼šè‡ªåŠ¨æ’å…¥å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚</li>
<li>æ¡¥æ–¹æ³•è¢«åˆæˆæ¥ä¿æŒå¤šæ€ã€‚</li>
</ul>
<h2 id="çº¦æŸä¸å±€é™æ€§"><a class="header-anchor" href="#çº¦æŸä¸å±€é™æ€§">Â¶</a>çº¦æŸä¸å±€é™æ€§</h2>
<ul>
<li><strong>ä¸èƒ½ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–ç±»å‹å‚æ•°</strong></li>
</ul>
<p>å³æ²¡æœ‰<code>Pair&lt;double&gt;</code>ï¼Œåªæœ‰<code>Pair&lt;Double&gt;</code>ã€‚åŸå› æ˜¯ç±»å‹æ“¦å‡ºåï¼ŒObjectä¸èƒ½å­˜å‚¨doubleå€¼ï¼Œæ¯•ç«Ÿå®ƒä¸æ˜¯å¯¹è±¡</p>
<ul>
<li><strong>è¿è¡Œæ—¶ç±»å‹æŸ¥è¯¢åªé€‚ç”¨äºåŸå§‹ç±»å‹</strong></li>
</ul>
<p>æ‰€æœ‰çš„ç±»å‹æŸ¥è¯¢åªäº§ç”ŸåŸå§‹ç±»å‹ï¼Œä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Pair&lt;String&gt; stringPair = ...;</span><br><span class="line">Pair&lt;Employee&gt; employeePair = ...;</span><br><span class="line"><span class="keyword">if</span>(stringPir.getClass() == employeePair.getClass()) <span class="comment">// they are equal</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ä¸èƒ½åˆ›å»ºå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„</strong></li>
</ul>
<p><code>Pair&lt;String&gt;[] table</code>æ˜¯é”™çš„ï¼›</p>
<p>åªèƒ½ä½¿ç”¨AllayListï¼š <code>ArrayList&lt;Pair&lt;String&gt;&gt; table</code></p>
<ul>
<li><strong>Varargsè­¦å‘Š</strong></li>
</ul>
<p>å‘å‚æ•°ä¸ªæ•°å¯å˜çš„æ–¹æ³•ä¼ é€’ä¸€ä¸ªæ³›å‹ç±»å‹çš„å®ä¾‹æ—¶ï¼Œä¸ºäº†è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼ŒJava è™šæ‹Ÿæœºå¿…é¡»å»ºç«‹ä¸€ä¸ªå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„ï¼Œå¯æ˜¯è¿™è¿åäº†å‰ä¸€ä¸ªè§„åˆ™ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ @SafeVarargs ç›´æ¥æ ‡æ³¨è¯¥æ–¹æ³•ï¼Œè¿™æ ·å°±èƒ½æ­£å¸¸è¿è¡Œã€‚</p>
<ul>
<li><strong>ä¸èƒ½å®ä¾‹åŒ–ç±»å‹å˜é‡</strong></li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<p><code>public Pair() { first = new T(); second = new T(); } // Error</code></p>
<ul>
<li>
<p><strong>ä¸èƒ½æ„é€ æ³›å‹æ•°ç»„</strong></p>
</li>
<li>
<p><strong>æ³›å‹ç±»çš„é™æ€ä¸Šä¸‹æ–‡ä¸­ç±»å‹å˜é‡æ— æ•ˆ</strong></p>
</li>
</ul>
<p>ä¹Ÿå°±æ˜¯ä¸èƒ½åœ¨é™æ€åŸŸæˆ–æ–¹æ³•ä¸­å¼•ç”¨ç±»å‹å˜é‡ã€‚</p>
<ul>
<li><strong>ä¸èƒ½æŠ›å‡ºæˆ–æ•è·æ³›å‹ç±»çš„å®ä¾‹</strong></li>
<li><strong>å¯ä»¥æ¶ˆé™¤å¯¹å—æŸ¥å¼‚å¸¸çš„æ£€æŸ¥</strong></li>
</ul>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>corejavaåŸºç¡€çŸ¥è¯†(2)-æ¥å£å’Œlambdaè¡¨è¾¾å¼</title>
    <url>/2019/03/05/corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86(2)-%E6%8E%A5%E5%8F%A3%E5%92%8Clambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<p>æœ¬æ–‡æ˜¯å¯¹ java æ¥å£å’Œlambdaè¡¨è¾¾å¼çš„æ€»ç»“</p>
<a id="more"></a>
<h1>æ¥å£</h1>
<h2 id="æ¥å£æ¦‚å¿µ"><a class="header-anchor" href="#æ¥å£æ¦‚å¿µ">Â¶</a>æ¥å£æ¦‚å¿µ</h2>
<p>æ¥å£æ˜¯å¯¹ç±»çš„ä¸€ç»„éœ€æ±‚çš„æè¿°ï¼Œç±»éµä»ç‰¹å®šçš„æè¿°ï¼Œå®ç°è¿™é¡¹æœåŠ¡ã€‚<br>
ä¾‹å¦‚ï¼š<br>
è¿™æ˜¯Camprableæ¥å£</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span>&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(T other)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨ç±»ä¸­å®ç°è¿™ä¸€æ¥å£:</p>
<ol>
<li>å°†ç±»å£°æ˜ä¸ºå®ç°ç»™å®šçš„æ¥å£</li>
<li>å¯¹æ¥å£ä¸­<strong>æ‰€æœ‰</strong>æ–¹æ³•è¿›è¡Œå®šä¹‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Employee</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Employee other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Double.compare(salary, other.salary);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¥å£ç‰¹æ€§"><a class="header-anchor" href="#æ¥å£ç‰¹æ€§">Â¶</a>æ¥å£ç‰¹æ€§</h2>
<ul>
<li>æ¥å£ä¸æ˜¯ç±»ï¼Œä¸èƒ½ç”¨newå®ä¾‹åŒ–ä¸€ä¸ªæ¥å£ï¼Œå¯æ˜¯èƒ½å£°æ˜æ¥å£å˜é‡ï¼Œç„¶åå†å¼•ç”¨å®ç°äº†è¯¥æ¥å£çš„ç±»å¯¹è±¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Compararble x;</span><br><span class="line">x = <span class="keyword">new</span> Employee(...); <span class="comment">//ok</span></span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼š</p>
<p>å¯èƒ½ä¼šé—®è¿™æ ·çš„æ¥å£å˜é‡æœ‰å•¥ç”¨å‘¢ï¼Ÿï¼Ÿä¸¾ä¸ªå®šæ—¶å™¨çš„ä¾‹å­ï¼ŒTimerå‡½æ•° éœ€è¦æ¥æ”¶ ä¸€ä¸ªæ“ä½œå‡½æ•° ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¼ å‡½æ•°è¿›å»ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠæ¥å£å˜é‡ï¼ˆå¼•ç”¨å®ç°äº†è¯¥æ¥å£çš„ç±»ï¼‰ä¼ è¿›å»ã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥å‘ç°æ¥å£é‡Œçš„æ–¹æ³•<strong>ä¸æ˜¯é™æ€æ–¹æ³•</strong>ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å…ˆæ–°å»ºå¯¹è±¡ã€‚</p>
<p>å½“ç„¶ javase8 ä¸­å¯ä»¥ç”¨ <strong>lambdaè¡¨è¾¾å¼</strong> ä¼ å‡½æ•°ï¼Œè§ä¸‹æ–‡ lambda è¡¨è¾¾å¼</p>
<ul>
<li>æ£€æŸ¥æŸå¯¹è±¡æ˜¯å¦å®ç°æŸæ¥å£</li>
</ul>
<p><code>if(anObject instanceof Comparable) {...}</code></p>
<ul>
<li>æ¥å£ä¹Ÿå¯ä»¥æ‰©å±•</li>
</ul>
<p><code>public interface Powered extends Moveable</code></p>
<ul>
<li>æ¥å£ä¸­ä¸å«å®ä¾‹åŸŸï¼Œå´å¯ä»¥åŒ…å«å¸¸é‡ï¼ˆpublice static final)</li>
<li>å¯ä»¥ä¸ºæ¥å£æä¾›é»˜è®¤å®ç°</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Comparable</span>&lt;&lt;<span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(T other)</span></span>&#123;<span class="keyword">return</span> <span class="number">0</span>&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>ä¸€ä¸ªç±»å¯ä»¥æœ‰å¤šä¸ªæ¥å£</p>
</li>
<li>
<p><strong>ç»§æ‰¿æ—¶å®¹æ˜“å‡ºç°çš„é—®é¢˜ï¼š</strong></p>
</li>
</ul>
<p>ä¾‹å¦‚å­ç±»ç»§æ‰¿compareToæ–¹æ³•æ—¶ï¼Œå¿…é¡»è¦æœ‰<strong>å­ç±»ä¸è¶…ç±»è¿›è¡Œæ¯”è¾ƒ</strong>çš„æ€æƒ³ï¼Œå°±åƒç¬¬äº”ç« equalsæ–¹æ³•ä¸€æ ·ï¼Œä¸ç„¶ä¼šæœ‰<strong>ClassCastException</strong>é”™è¯¯ã€‚</p>
<ul>
<li>åªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå¹¶ç”¨lambdaè¡¨è¾¾å¼æ›¿ä»£ï¼Œè¿™ç§æ¥å£å«<strong>å‡½æ•°å¼æ¥å£</strong>ï¼›ä¸å«ä»»ä½•æ–¹æ³•çš„æ¥å£å«<strong>æ ‡è®°æ¥å£</strong>ï¼Œå¦‚ Cloneableã€‚</li>
</ul>
<h2 id="è§£å†³æ¥å£å†²çª"><a class="header-anchor" href="#è§£å†³æ¥å£å†²çª">Â¶</a>è§£å†³æ¥å£å†²çª</h2>
<p>åŒåï¼Œä¸”å‚æ•°ç±»å‹ç›¸åŒä¸‹ï¼š</p>
<p>1ï¼‰è¶…ç±»ä¼˜å…ˆ</p>
<p>2ï¼‰æ¥å£å†²çªï¼šåªè¦å…¶ä¸­ä¸€ä¸ªæ¥å£æä¾›äº†é»˜è®¤æ–¹æ³•ï¼Œå°±ä¼šæŠ¥é”™ï¼›å¦‚æœéƒ½ä¸æä¾›ï¼Œå°±æ˜¯æŠ½è±¡ç±»ã€‚</p>
<p>ps. ç±»ä¼˜å…ˆçš„æœºåˆ¶ç¡®ä¿äº†ä¸java SE 7 çš„å…¼å®¹ï¼Œå› ä¸ºé‚£æ—¶æ²¡æœ‰é»˜è®¤æ–¹æ³•ã€‚</p>
<h1>lambdaè¡¨è¾¾å¼</h1>
<h2 id="ä¸ºä»€ä¹ˆå¼•å…¥lambdaè¡¨è¾¾å¼å‘¢ï¼Ÿ"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆå¼•å…¥lambdaè¡¨è¾¾å¼å‘¢ï¼Ÿ">Â¶</a>ä¸ºä»€ä¹ˆå¼•å…¥lambdaè¡¨è¾¾å¼å‘¢ï¼Ÿ</h2>
<p><code>Arrays.sort(strings, new LengthComparator());</code></p>
<p>è¿™æ®µä»£ç ç”¨å®šåˆ¶çš„æ¯”è¾ƒå™¨å®Œæˆå­—ç¬¦ä¸²æ’åºï¼Œå¯ä»¥çœ‹å‡ºå®ƒä¼ å…¥äº†ä¸€ä¸ªå¯¹è±¡ï¼ˆæ¥å£ï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡å®ç°äº†Camparableæ¥å£ï¼Œå¯¹è±¡é‡Œé¢æœ‰compareæ–¹æ³•ã€‚æˆ‘ä»¬ä¸»è¦ç›®çš„å°±æ˜¯æƒ³ä¼ é€’è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯Javaä¹‹å‰åªèƒ½é€šè¿‡æ„é€ å¯¹è±¡ï¼Œæ¥ä¼ é€’è¯¥æ–¹æ³•ã€‚äºæ˜¯lambdaè¡¨è¾¾å¼æ­£å¼å¼•å…¥ï¼</p>
<h2 id="lambdaè¡¨è¾¾å¼è¯­æ³•"><a class="header-anchor" href="#lambdaè¡¨è¾¾å¼è¯­æ³•">Â¶</a>lambdaè¡¨è¾¾å¼è¯­æ³•</h2>
<p>ä¾‹å­ï¼š</p>
<p><code>(String first, String second) -&gt; {...}</code></p>
<p>æŠŠå®ƒæ›¿æ¢åˆ°ä¹‹å‰åˆ°ä»£ç ä¸­ï¼š</p>
<p><code>Array.sort(strings, (fisrt, second)-&gt;first.length() - second.length());</code></p>
<p>ä¸€äº›ç»†èŠ‚ï¼š</p>
<ul>
<li>å¦‚æœå¯ä»¥æ¨å¯¼å‡ºå‚æ•°ç±»å‹ï¼Œé‚£ä¹ˆç±»å‹å¯ä»¥ä¸å†™ï¼›è€Œä¸”å¦‚æœåªæœ‰è¿™ä¸€ä¸ªå‚æ•°ï¼Œå°æ‹¬å·ä¹Ÿå¯ä»¥ä¸å†™ã€‚</li>
<li>å¦‚æœæŸäº›åˆ†æ”¯è¿”å›ä¸€ä¸ªå€¼ï¼Œè€Œå¦ä¸€äº›åˆ†æ”¯ä¸è¿”å›å€¼ï¼Œè¿™æ˜¯ä¸åˆæ³•çš„ã€‚<br>
<code>(int) -&gt; {if(x &gt;= 0) return 1;} //ä¸åˆæ³•</code></li>
<li>å¯¹äºåªæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªlambdaï¼Œå°±åƒä¾‹å­ï¼›è¿™ç§æ¥å£ç§°ä¸ºå‡½æ•°å¼æ¥å£ã€‚å¸¸çš„ç”¨å‡½æ•°å¼æ¥å£æœ‰ï¼šPredicate, Consumer, Function, Supplier ç­‰ç­‰ã€‚</li>
</ul>
<h2 id="æ–¹æ³•å¼•ç”¨ä¸lambda"><a class="header-anchor" href="#æ–¹æ³•å¼•ç”¨ä¸lambda">Â¶</a>æ–¹æ³•å¼•ç”¨ä¸lambda</h2>
<p>å‡å¦‚æƒ³ä¼ é€’çš„ lambda å·²ç»æœ‰äº†ç°æˆçš„æ–¹æ³•ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨æ–¹æ³•å¼•ç”¨æ¥ä»£æ›¿lambdaã€‚<br>
ä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>
<p>é™æ€æ–¹æ³•</p>
<ul>
<li>Lambda: <code>(args) -&gt; ClassName.staticMethod(args)</code></li>
<li>æ–¹æ³•å¼•ç”¨ï¼š<code>ClassName::staticMethod</code></li>
</ul>
</li>
<li>
<p>ç°æœ‰å¯¹è±¡çš„å®ä¾‹æ–¹æ³•</p>
<ul>
<li>Lambda: <code>(args) -&gt; expr.instanceMethod(args)</code></li>
<li>æ–¹æ³•å¼•ç”¨ï¼š<code>expr::intanceMethod</code></li>
</ul>
</li>
<li>
<p>æŸç±»çš„å®ä¾‹æ–¹æ³•</p>
<ul>
<li>Lambda: <code>(arg0, rest) -&gt; arg0.instanceMethod(rest)</code></li>
<li>æ–¹æ³•å¼•ç”¨ï¼š<code>ClassName::instanceMethod //arg0 æ˜¯ ClassName ç±»å‹çš„</code></li>
</ul>
</li>
</ol>
<h2 id="å˜é‡ä½œç”¨åŸŸ"><a class="header-anchor" href="#å˜é‡ä½œç”¨åŸŸ">Â¶</a>å˜é‡ä½œç”¨åŸŸ</h2>
<p>lambda è¡¨è¾¾å¼å¯ä»¥è®¿é—®å¤–å›´æ–¹æ³•æˆ–ç±»ä¸­çš„å˜é‡ï¼Œä½†éœ€æ³¨æ„ï¼š</p>
<ul>
<li>è¯¥å˜é‡å¿…é¡»æ˜¯æœ€ç»ˆå˜é‡ï¼Œä¸å¯ä»¥é‡æ–°èµ‹å€¼ï¼›å¦‚String</li>
<li>åœ¨ lambda è¡¨è¾¾å¼ä¸­å£°æ˜ä¸ä¸€ä¸ªå±€éƒ¨å˜é‡åŒåçš„å‚æ•°æˆ–å±€éƒ¨å˜é‡æ˜¯ä¸åˆæ³•çš„ã€‚</li>
<li>åœ¨ä¸€ä¸ª lambda è¡¨è¾¾å¼ä¸­ä½¿ç”¨ this å…³é”®å­—æ—¶ï¼Œ æ˜¯æŒ‡åˆ›å»ºè¿™ä¸ª lambda è¡¨è¾¾å¼çš„æ–¹æ³•çš„ this å‚æ•°ã€‚ ç®€å•è¯´å°±æ˜¯æ²¡å˜åŒ–ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>corejavaåŸºç¡€çŸ¥è¯†(1)-ç»§æ‰¿</title>
    <url>/2019/03/05/corejava%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86(1)-%E7%BB%A7%E6%89%BF/</url>
    <content><![CDATA[<a id="more"></a>
<p>å ä½</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹è¯­è¨€</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>hello hexo</title>
    <url>/2019/02/26/hello-hexo/</url>
    <content><![CDATA[<p><img src="hello-hexo/me.png" alt="å°é¢"></p>
<a id="more"></a>
<h1>ç”Ÿæˆæ–‡ç« </h1>
<ol>
<li>ä½¿ç”¨å‘½ä»¤ç”Ÿæˆåˆå§‹æ–‡ç« ï¼Œæ–‡ä»¶åä¹‹é—´æœ‰ç©ºæ ¼çš„è¯ä¼šè‡ªåŠ¨åŠ -ä¸­æ¨ªçº¿</li>
</ol>
<p><code>hexo n &quot;hello hexo&quot;  #åŒå¼•å·ä¸­å¡«å†™è¦ç”Ÿæˆçš„æ–‡ç« å</code></p>
<ol start="2">
<li>åœ¨hexo/source/_postsä¸­ç¼–è¾‘ç”Ÿæˆå‡ºæ¥çš„hello-hexo.mdæ–‡ä»¶</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: hello hexo</span><br><span class="line">date: 2019-02-26 11:20:55</span><br><span class="line">tags:</span><br><span class="line">- hello</span><br><span class="line">categories: </span><br><span class="line">- hello hexo</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>æœ¬åœ°é¢„è§ˆæ–‡ç« å†…å®¹ï¼Œç™»å½•localhost:4000æŸ¥çœ‹æ•ˆæœ</li>
</ol>
<p><code>hexo s</code></p>
<ol start="4">
<li>å†…å®¹å‘å¸ƒåˆ°publicæ–‡ä»¶å¤¹æ•°ä¸­ï¼Œç„¶åæ‰‹åŠ¨å¤åˆ¶åŒæ­¥GitHub</li>
</ol>
<p><code>hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</code></p>
<hr>
<h1>Markdownè¯­æ³•</h1>
<h2 id="ä¸€ã€æ ‡é¢˜"><a class="header-anchor" href="#ä¸€ã€æ ‡é¢˜">Â¶</a>ä¸€ã€æ ‡é¢˜</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">### è¿™æ˜¯ä¸‰çº§æ ‡é¢˜</span><br><span class="line">#### è¿™æ˜¯å››çº§æ ‡é¢˜</span><br></pre></td></tr></table></figure>
<h3 id="è¿™æ˜¯ä¸‰çº§æ ‡é¢˜"><a class="header-anchor" href="#è¿™æ˜¯ä¸‰çº§æ ‡é¢˜">Â¶</a>è¿™æ˜¯ä¸‰çº§æ ‡é¢˜</h3>
<h4 id="è¿™æ˜¯å››çº§æ ‡é¢˜"><a class="header-anchor" href="#è¿™æ˜¯å››çº§æ ‡é¢˜">Â¶</a>è¿™æ˜¯å››çº§æ ‡é¢˜</h4>
<h2 id="äºŒã€å­—ä½“"><a class="header-anchor" href="#äºŒã€å­—ä½“">Â¶</a>äºŒã€å­—ä½“</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">**è¿™æ˜¯åŠ ç²—çš„æ–‡å­—**</span><br><span class="line">*è¿™æ˜¯å€¾æ–œçš„æ–‡å­—*</span><br><span class="line">***è¿™æ˜¯æ–œä½“åŠ ç²—çš„æ–‡å­—***</span><br><span class="line">~~è¿™æ˜¯åŠ åˆ é™¤çº¿çš„æ–‡å­—~~</span><br></pre></td></tr></table></figure>
<p><strong>è¿™æ˜¯åŠ ç²—çš„æ–‡å­—</strong></p>
<p><em>è¿™æ˜¯å€¾æ–œçš„æ–‡å­—</em></p>
<p><em><strong>è¿™æ˜¯æ–œä½“åŠ ç²—çš„æ–‡å­—</strong></em></p>
<p><s>è¿™æ˜¯åŠ åˆ é™¤çº¿çš„æ–‡å­—</s></p>
<h2 id="ä¸‰ã€å¼•ç”¨"><a class="header-anchor" href="#ä¸‰ã€å¼•ç”¨">Â¶</a>ä¸‰ã€å¼•ç”¨</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;è¿™æ˜¯å¼•ç”¨çš„å†…å®¹</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™æ˜¯å¼•ç”¨çš„å†…å®¹</p>
</blockquote>
<h2 id="å››ã€å›¾ç‰‡"><a class="header-anchor" href="#å››ã€å›¾ç‰‡">Â¶</a>å››ã€å›¾ç‰‡</h2>
<p><strong>è¯­æ³•ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![å›¾ç‰‡æ–‡å­—](å›¾ç‰‡åœ°å€ &quot;å›¾ç‰‡æ ‡é¢˜&quot;)</span><br><span class="line"></span><br><span class="line">å›¾ç‰‡æ ‡é¢˜å°±æ˜¯æ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸‹é¢çš„æ–‡å­—</span><br><span class="line">å›¾ç‰‡æ–‡å­—å¯åŠ å¯ä¸åŠ </span><br></pre></td></tr></table></figure>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![test](hello-hexo/test.jpg &quot;å›¾ç‰‡&quot;)</span><br></pre></td></tr></table></figure>
<p><strong>æ•ˆæœï¼š</strong></p>
<p><img src="hello-hexo/test.jpg" alt="test" title="å›¾ç‰‡"></p>
<h2 id="äº”ã€è¶…é“¾æ¥"><a class="header-anchor" href="#äº”ã€è¶…é“¾æ¥">Â¶</a>äº”ã€è¶…é“¾æ¥</h2>
<p><strong>è¯­æ³•ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[è¶…é“¾æ¥å](è¶…é“¾æ¥åœ°å€ &quot;è¶…é“¾æ¥title&quot;)</span><br><span class="line">titleå¯åŠ å¯ä¸åŠ </span><br></pre></td></tr></table></figure>
<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[ç™¾åº¦](http://baidu.com)</span><br></pre></td></tr></table></figure>
<p><strong>æ•ˆæœï¼š</strong></p>
<p><a href="http://baidu.com" target="_blank" rel="noopener">ç™¾åº¦</a></p>
<h2 id="å…­ã€åˆ—è¡¨"><a class="header-anchor" href="#å…­ã€åˆ—è¡¨">Â¶</a>å…­ã€åˆ—è¡¨</h2>
<p><strong>- æ— åºåˆ—è¡¨</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- åˆ—è¡¨å†…å®¹</span><br><span class="line">+ åˆ—è¡¨å†…å®¹</span><br><span class="line">* åˆ—è¡¨å†…å®¹</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ—è¡¨å†…å®¹</li>
</ul>
<ul>
<li>åˆ—è¡¨å†…å®¹</li>
</ul>
<ul>
<li>åˆ—è¡¨å†…å®¹</li>
</ul>
<p><strong>- æœ‰åºåˆ—è¡¨</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.åˆ—è¡¨å†…å®¹</span><br><span class="line">2.åˆ—è¡¨å†…å®¹</span><br><span class="line">3.åˆ—è¡¨å†…å®¹</span><br></pre></td></tr></table></figure>
<ol>
<li>åˆ—è¡¨å†…å®¹</li>
<li>åˆ—è¡¨å†…å®¹</li>
<li>åˆ—è¡¨å†…å®¹</li>
</ol>
<p><strong>- åˆ—è¡¨åµŒå¥—</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. ä¸€çº§åˆ—è¡¨</span><br><span class="line">   1. äºŒçº§åˆ—è¡¨</span><br><span class="line">2. ä¸€çº§åˆ—è¡¨</span><br><span class="line">	2. äºŒçº§åˆ—è¡¨</span><br></pre></td></tr></table></figure>
<ol>
<li>ä¸€çº§åˆ—è¡¨
<ol>
<li>äºŒçº§åˆ—è¡¨</li>
</ol>
</li>
<li>ä¸€çº§åˆ—è¡¨
<ol start="2">
<li>äºŒçº§åˆ—è¡¨</li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
  </entry>
</search>
